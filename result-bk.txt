ä»¥ä¸‹æ˜¯Utoolsæ’ä»¶çš„å¼€å‘æ–‡æ¡£
# æ’ä»¶åº”ç”¨ç›®å½•ç»“æ„

æ­¤éƒ¨åˆ†ä¼šå¸®åŠ©ä½ äº†è§£ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ’ä»¶åº”ç”¨çš„æ–‡ä»¶ç›®å½•ç»“æ„ã€‚

æ’ä»¶åº”ç”¨è‡³å°‘è¦æœ‰ä¸€ä¸ª `plugin.json` ä½œä¸ºå…¥å£ï¼Œå¹¶é…ç½® `logo` å­—æ®µä»¥åŠ `main` æˆ–è€… `preload` å­—æ®µã€‚

ä¸€ä¸ªç›¸å¯¹å®Œæ•´å¯æ‰“åŒ…æˆæ’ä»¶åº”ç”¨çš„ç›®å½•å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š

```shell
/{plugin}
|-- plugin.json
|-- preload.js
|-- index.html
|-- index.js
|-- index.css
|-- logo.png
```

## æºç ç¼–è¯‘

uTools ä»…è¯†åˆ« `html + css + javascript`, é€šå¸¸æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯èƒ½ä¼šä½¿ç”¨å„ç§çš„å·¥å…·æ¥è¾…åŠ©å¼€å‘ï¼Œæ¯”å¦‚ `vite`ã€`webpack` ç­‰ç­‰ï¼Œä¹Ÿå¯èƒ½ä¼šå¼•å…¥å„ç§å‰ç«¯æ¡†æ¶ï¼Œæ¯”å¦‚ `vue`ã€`react`ã€`svelte` ç­‰ç­‰ï¼Œè€Œè¿™äº›ä»£ç å¹¶ä¸æ˜¯ç›´æ¥å¯ä»¥è¢« uTools è¯†åˆ«çš„ï¼Œå½“æˆ‘ä»¬æ‰“åŒ…æ’ä»¶åº”ç”¨å‰åº”è¯¥å…ˆå°†æ¡†æ¶ä»£ç ç¼–è¯‘æˆæ™®é€šçš„ html ã€cssã€js æ–‡ä»¶ã€‚é€šå¸¸æ˜¯å°†æºç ç¼–è¯‘è¾“å‡ºåˆ° dist æ–‡ä»¶å¤¹ï¼Œç„¶å**å°† dist æ–‡ä»¶å¤¹æ‰“åŒ…æˆæ’ä»¶åº”ç”¨**ï¼Œåˆ‡å‹¿å°†æ•´ä¸ªé¡¹ç›®çš„æ ¹ç›®å½•æ‰“åŒ…æˆæ’ä»¶åº”ç”¨ã€‚

## ç¬¬ä¸‰æ–¹ä¾èµ–

å½“ä½ ä½¿ç”¨ç¬¬ä¸‰æ–¹ä¾èµ–æ—¶ï¼Œæ ¹æ®é¡¹ç›®æƒ…å†µè¿›è¡ŒåŒºåˆ†ï¼š

å½“ä½ ä½¿ç”¨å‰ç«¯ä¾èµ–æ—¶ï¼Œåªéœ€è¦åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹å®‰è£…å³å¯ï¼Œå¯¹å‰ç«¯é¡¹ç›®è¿›è¡Œæ­£å¸¸çš„ç¼–è¯‘ï¼Œè¾“å‡ºåˆ° dist æ–‡ä»¶å¤¹ã€‚

å½“ä½ ä½¿ç”¨ nodejs çš„ç¬¬ä¸‰æ–¹ä¾èµ–æ—¶ï¼Œåº”å½“ä¿è¯ä½ çš„æ¨¡å—å­˜åœ¨äº `preload.js` åŒçº§ç›®å½•ï¼Œå¹¶ä¸”ä¸è¦å¯¹å®ƒä»¬è¿›è¡Œç¼–è¯‘æ“ä½œï¼Œä¿è¯æäº¤æ’ä»¶åº”ç”¨æ—¶çš„ç›®å½•ç»“æ„ä¸å˜ï¼Œå¹¶ä¸”æºç æ¸…æ™°å¯è¯»ã€‚


# plugin.json é…ç½®

`plugin.json` æ–‡ä»¶æ˜¯æ’ä»¶åº”ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œå®ƒæ˜¯æœ€é‡è¦çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œç”¨æ¥å®šä¹‰è¿™ä¸ªæ’ä»¶åº”ç”¨å°†å¦‚ä½•ä¸ uTools é›†æˆã€‚
æ¯å½“ä½ åˆ›å»ºä¸€ä¸ªæ’ä»¶åº”ç”¨æ—¶ï¼Œéƒ½éœ€è¦ä»åˆ›å»ºä¸€ä¸ª `plugin.json` æ–‡ä»¶å¼€å§‹ã€‚

## é…ç½®æ–‡ä»¶æ ¼å¼

plugin.json æ–‡ä»¶æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ JSON æ–‡ä»¶ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "main": "index.html",
  "logo": "logo.png",
  "preload": "preload.js",
  "features": [
    {
      "code": "hello",
      "explain": "hello world",
      "cmds": ["hello", "ä½ å¥½"]
    }
  ]
}
```

## åŸºç¡€å­—æ®µè¯´æ˜

### `main`

> ç±»å‹ï¼š`string`
>
> å¿…å¡«ï¼š`main` ä¸ `preload` è‡³å°‘å­˜åœ¨ä¸€ä¸ª

å¿…é¡»æ˜¯ä¸€ä¸ªç›¸å¯¹äº `plugin.json`çš„ç›¸å¯¹è·¯å¾„ï¼Œä¸”åªèƒ½æ˜¯ä¸€ä¸ª `.html` æ–‡ä»¶ã€‚

### `logo`

> ç±»å‹ï¼š`string`
>
> å¿…å¡«ï¼šæ˜¯

æ’ä»¶åº”ç”¨ Logoï¼Œå¿…é¡»ä¸º `png` æˆ– `jpg` æ–‡ä»¶

### `preload`

> ç±»å‹ï¼š`string`
>
> å¿…å¡«ï¼š`main` ä¸ `preload` è‡³å°‘å­˜åœ¨ä¸€ä¸ª

é¢„åŠ è½½ js æ–‡ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå…³é”®æ–‡ä»¶ï¼Œä½ å¯ä»¥åœ¨æ­¤æ–‡ä»¶å†…è°ƒç”¨ nodejsã€ electron æä¾›çš„ apiã€‚æŸ¥çœ‹æ›´å¤šå…³äº [preload.js](./preload-js/preload-js.md)

## å¼€å‘æ¨¡å¼å­—æ®µè¯´æ˜

### `development`

> ç±»å‹ï¼š`object`
>
> å¿…å¡«ï¼šå¦

å¼€å‘æ¨¡å¼ä¸‹çš„é…ç½®ï¼Œå¯¹è±¡çš„åŒåå­—æ®µä¼šä¼šè¦†ç›–åŸºç¡€é…ç½®å­—æ®µã€‚

### `development.main`

> ç±»å‹ï¼š`string`
>
> å¿…å¡«ï¼šå¦

å¼€å‘æ¨¡å¼ä¸‹ï¼Œæ’ä»¶åº”ç”¨çš„å…¥å£æ–‡ä»¶ï¼Œä¸åŸºç¡€é…ç½®å­—æ®µ `main` å­—æ®µç›¸åŒï¼Œä½†æ˜¯æ­¤å¤„å¯ä»¥é…ç½®ä¸ºä¸€ä¸ª `http` åè®®çš„åœ°å€ï¼ˆä¸æ¨èï¼‰ã€‚

::: warning æ³¨æ„
æ”¯æŒ `http` åè®®çš„åœ°å€ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…é…åˆå‰ç«¯æ¡†æ¶æˆ–è€…å„ç§æ„å»ºå·¥å…·çš„ä½¿ç”¨ï¼Œè¯·å‹¿å°†åŸºç¡€å­—æ®µ `main` å­—æ®µé…ç½®ä¸º `http` åè®®çš„åœ°å€ã€‚
:::

## æ’ä»¶åº”ç”¨è®¾ç½®å­—æ®µè¯´æ˜

### `pluginSetting`

> ç±»å‹ï¼š`object`
>
> å¿…å¡«ï¼šå¦

æ’ä»¶åº”ç”¨è®¾ç½®ï¼Œå¯ä»¥é…ç½®ä¸€äº›æ’ä»¶åœ¨åŸºåº§ä¸­çš„é»˜è®¤è¡Œä¸ºæˆ–è€…æ ·å¼ã€‚

### `pluginSetting.single`

> ç±»å‹ï¼š`boolean`
>
> å¿…å¡«ï¼šå¦
>
> é»˜è®¤å€¼ï¼š`true`

æ˜¯å¦å•ä¾‹ï¼Œé»˜è®¤ä¸º `true`ï¼Œè¡¨ç¤ºæ’ä»¶åœ¨åŸºåº§ä¸­åªèƒ½å­˜åœ¨ä¸€ä¸ªåº”ç”¨å®ä¾‹ã€‚

### `pluginSetting.height`

> ç±»å‹ï¼š`number`
>
> å¿…å¡«ï¼šå¦
>
> æœ€å°å€¼ï¼š`1`

æ’ä»¶åº”ç”¨åˆå§‹é«˜åº¦ã€‚å¯ä»¥é€šè¿‡ [`utools.setExpendHeight`](../api-reference/utools/window.md#utools-setexpendheight) åŠ¨æ€ä¿®æ”¹ã€‚

## æ’ä»¶åº”ç”¨åŠŸèƒ½å­—æ®µè¯´æ˜

### `features`

> ç±»å‹ï¼š`Array<object>`
>
> å¿…å¡«ï¼šæ˜¯
>
> æœ€å°é•¿åº¦ï¼š`1`

features å®šä¹‰æ’ä»¶åº”ç”¨çš„æŒ‡ä»¤é›†åˆï¼Œä¸€ä¸ªæ’ä»¶åº”ç”¨å¯å®šä¹‰å¤šä¸ªåŠŸèƒ½ï¼Œä¸€ä¸ªåŠŸèƒ½å¯é…ç½®å¤šæ¡æŒ‡ä»¤ã€‚

features çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª feature å¯¹è±¡ï¼Œå¯¹è±¡ä¸­åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

### `feature.code`

> ç±»å‹ï¼š`string`
>
> å¿…å¡«ï¼šæ˜¯

åŠŸèƒ½ç¼–ç ï¼Œæ­¤å­—æ®µçš„å€¼å¿…é¡»å”¯ä¸€ã€‚è¿›å…¥æ’ä»¶åº”ç”¨ä¼šå°†è¯¥ç¼–ç å¸¦å…¥ï¼Œæ ¹æ®ä¸åŒç¼–ç å®ç°åŠŸèƒ½åŒºåˆ†æ‰§è¡Œ

### `feature.explain`

> ç±»å‹ï¼š`string`
>
> å¿…å¡«ï¼šå¦

åŠŸèƒ½æè¿°

### `feature.icon`

> ç±»å‹ï¼š`string`
>
> å¿…å¡«ï¼šå¦

åŠŸèƒ½å›¾æ ‡

æ”¯æŒ pngã€jpgã€svg æ ¼å¼ã€‚

### `feature.platform`

> ç±»å‹ï¼š`Array<string>|string`
>
> å¿…å¡«ï¼šå¦

æŒ‡å®šåŠŸèƒ½å¯ç”¨å¹³å°ï¼Œå¯è®¾ç½®çš„å€¼æ˜¯ ["win32","darwin","linux"] åˆ†åˆ«å¯¹åº” Windowsã€macOSã€Linux å¹³å°

### `feature.mainPush`

> ç±»å‹ï¼š`boolean`
>
> å¿…å¡«ï¼šå¦

æ˜¯å¦å‘æœç´¢æ¡†æ¨é€å†…å®¹ã€‚

### `feature.mainHide`

> ç±»å‹ï¼š`boolean`
>
> å¿…å¡«ï¼šå¦

è‹¥é…ç½®ä¸º`true`ï¼Œæ‰“å¼€æ­¤åŠŸèƒ½ä¸ä¸»åŠ¨æ˜¾ç¤ºæœç´¢æ¡†ã€‚

### `feature.cmds`

> ç±»å‹ï¼š`Array<string|object>`
>
> å¿…å¡«ï¼šæ˜¯
>
> æœ€å°é•¿åº¦ï¼š`1`

é…ç½®è¯¥åŠŸèƒ½çš„æŒ‡ä»¤é›†åˆï¼ŒæŒ‡ä»¤åˆ†ã€ŒåŠŸèƒ½æŒ‡ä»¤ã€å’Œã€ŒåŒ¹é…æŒ‡ä»¤ã€


## åŠŸèƒ½æŒ‡ä»¤

æœç´¢æ¡†å¯ç›´æ¥æœç´¢å’Œæ‰“å¼€çš„æŒ‡ä»¤

::: code-group

```json [plugin.json]
{
  "features": [
    {
      "code": "text",
      "cmds": ["æµ‹è¯•", "ä½ å¥½"]
    }
  ]
}
```

:::

::: warning
- æŒ‡ä»¤é…ç½®ä¸ºä¸­æ–‡æ—¶ï¼Œ**æ— éœ€å†é…ç½®**å®ƒçš„æ‹¼éŸ³å’Œé¦–å­—æ¯ä½œä¸ºæŒ‡ä»¤ï¼ŒuTools æ”¯æŒæ‹¼éŸ³å’Œé¦–å­—æ¯æœç´¢ã€‚
- å¿…é¡»é…ç½®è‡³å°‘ä¸€ä¸ªã€ŒåŠŸèƒ½æŒ‡ä»¤ã€ï¼Œä¸ç„¶ç”¨æˆ·å°†**æ— æ³•å®‰è£…**æ’ä»¶åº”ç”¨
:::

## åŒ¹é…æŒ‡ä»¤

æœç´¢æ¡†è¾“å…¥ä»»æ„æ–‡æœ¬æˆ–ç²˜è´´å›¾ç‰‡ã€æ–‡ä»¶(å¤¹)åŒ¹é…å‡ºå¯å¤„ç†å®ƒçš„æŒ‡ä»¤

### `regex`

æ­£åˆ™åŒ¹é…ç‰¹å®šæ–‡æœ¬

::: code-group

```json [plugin.json]
{
  "features": [
    {
      "code": "regex",
      "cmds": [
        {
          // ç±»å‹æ ‡è®°ï¼ˆå¿…é¡»ï¼‰
          "type": "regex",
          // æŒ‡ä»¤åç§°ï¼ˆå¿…é¡»ï¼‰
          "label": "æ‰“å¼€ç½‘å€",
          // æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸²
          // æ³¨æ„: æ­£åˆ™è¡¨è¾¾å¼å­˜å¦‚æœåœ¨æ–œæ  "\" éœ€è¦å¤šåŠ ä¸€ä¸ªï¼Œ"\\"
          // æ³¨æ„ï¼šâ€œä»»æ„åŒ¹é…çš„æ­£åˆ™â€ ä¼šè¢« uTools å¿½è§†ï¼Œä¾‹å¦‚ï¼š/.*/ ã€/(.)+/ã€/[\s\S]*/ ...
          "match": "/xxx/i",
          // æœ€å°‘å­—ç¬¦æ•° (å¯é€‰)
          "minLength": 1,
          // æœ€å¤šå­—ç¬¦æ•° (å¯é€‰)
          "maxLength": 1
        }
      ]
    }
  ]
}
```

:::

### `over`

åŒ¹é…ä»»æ„æ–‡æœ¬

::: code-group

```json [plugin.json]
{
  "features": [
    {
      "code": "over",
      "cmds": [
        {
          // ç±»å‹æ ‡è®°ï¼ˆå¿…é¡»ï¼‰
          "type": "over",
          // æŒ‡ä»¤åç§°ï¼ˆå¿…é¡»ï¼‰
          "label": "ç™¾åº¦ä¸€ä¸‹",
          // æ’é™¤çš„æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸² (ä»»æ„æ–‡æœ¬ä¸­æ’é™¤çš„éƒ¨åˆ†) (å¯é€‰)
          "exclude": "/xxx/",
          // æœ€å°‘å­—ç¬¦æ•° (å¯é€‰)
          "minLength": 1,
          // æœ€å¤šå­—ç¬¦æ•° (é»˜è®¤æœ€å¤šä¸º 10000) (å¯é€‰)
          "maxLength": 500
        }
      ]
    }
  ]
}
```

:::

### `img`

åŒ¹é…å›¾åƒ

::: code-group

```json [plugin.json]
{
  "features": [
    {
      "code": "img",
      "cmds": [
        {
          // ç±»å‹æ ‡è®°ï¼ˆå¿…é¡»ï¼‰
          "type": "img",
          // æŒ‡ä»¤åç§°ï¼ˆå¿…é¡»ï¼‰
          "label": "å›¾åƒä¿å­˜ä¸ºæ–‡ä»¶"
        }
      ]
    }
  ]
}
```

:::

### `files`

åŒ¹é…æ–‡ä»¶(å¤¹)

::: code-group

```json [plugin.json]
{
  "features": [
    {
      "code": "files",
      "cmds": [
        {
          // ç±»å‹æ ‡è®°ï¼ˆå¿…é¡»ï¼‰
          "type": "files",
          // æŒ‡ä»¤åç§°ï¼ˆå¿…é¡»ï¼‰
          "label": "æ–‡ä»¶é‡å‘½å",
          // æ–‡ä»¶ç±»å‹ - "file"ã€"directory" (å¯é€‰)
          "fileType": "file",
          // åŒ¹é…æ–‡ä»¶(å¤¹)åç§°çš„æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸² (å¯é€‰)
          "match": "/xxx/",
          // æœ€å°‘æ–‡ä»¶æ•° (å¯é€‰)
          "minLength": 1,
          // æœ€å¤šæ–‡ä»¶æ•° (å¯é€‰)
          "maxLength": 1
        }
      ]
    }
  ]
}
```

:::

### `window`

åŒ¹é…å½“å‰æ´»åŠ¨çš„ç³»ç»Ÿçª—å£

::: code-group

```json [plugin.json]
{
  "features": [
    {
      "code": "window",
      "cmds": [
        {
          // ç±»å‹æ ‡è®°ï¼ˆå¿…é¡»ï¼‰
          "type": "window",
          // æŒ‡ä»¤åç§°ï¼ˆå¿…é¡»ï¼‰
          "label": "çª—å£ç½®é¡¶",
          // çª—å£åŒ¹é…è§„åˆ™
          "match": {
            // åº”ç”¨åç§°ï¼ˆå¿…é¡»ï¼‰
            "app": ["xxx.app", "xxx.exe"],
            // åŒ¹é…çª—å£æ ‡é¢˜çš„æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸² (å¯é€‰)
            "title": "/xxxx/",
            // çª—å£ç±» (Windows ä¸“æœ‰) (å¯é€‰)
            "class": ["xxx"]
          }
        }
      ]
    }
  ]
}
```

:::


::: warning
æ­£åˆ™è¡¨è¾¾å¼å­˜å¦‚æœåœ¨æ–œæ  "\" éœ€è¦å¤šåŠ ä¸€ä¸ªï¼Œ"\\"
:::


## é…ç½®ç¤ºä¾‹

### æ­£åˆ™åŒ¹é…

- [utools-match-text-example](https://github.com/uTools-Labs/utools-tutorials/tree/main/utools-match-text-example)

### å›¾åƒåŒ¹é…

- [utools-match-img-example](https://github.com/uTools-Labs/utools-tutorials/tree/main/utools-match-img-example)

### æ–‡ä»¶åŒ¹é…

- [utools-match-files-example](https://github.com/uTools-Labs/utools-tutorials/tree/main/utools-match-files-example)

### çª—å£åŒ¹é…

- [utools-match-window-example](https://github.com/uTools-Labs/utools-tutorials/tree/main/utools-match-window-example)


# è®¤è¯† `preload`

å½“ä½ åœ¨ `plugin.json` æ–‡ä»¶é…ç½®äº† `preload` å­—æ®µï¼ŒæŒ‡å®šçš„ js æ–‡ä»¶å°†è¢«é¢„åŠ è½½ï¼Œè¯¥ js æ–‡ä»¶å¯ä»¥è°ƒç”¨ Node.js API çš„æœ¬åœ°åŸç”Ÿèƒ½åŠ›å’Œ Electron æ¸²æŸ“è¿›ç¨‹ APIã€‚

## ä¸ºä»€ä¹ˆéœ€è¦ `preload`

åœ¨ä¼ ç»Ÿçš„ web å¼€å‘ä¸­ï¼Œä¸ºäº†ä¿æŒç”¨æˆ·è¿è¡Œç¯å¢ƒçš„å®‰å…¨ï¼ŒJavaScript è¢«åšäº†å¾ˆå¼ºçš„æ²™ç®±é™åˆ¶ï¼Œæ¯”å¦‚ä¸èƒ½è®¿é—®æœ¬åœ°æ–‡ä»¶ï¼Œä¸èƒ½è®¿é—®è·¨åŸŸç½‘ç»œèµ„æºï¼Œä¸èƒ½è®¿é—®æœ¬åœ°å­˜å‚¨ç­‰ã€‚

uTools åŸºäº Electron æ„å»ºï¼Œé€šè¿‡ preload æœºåˆ¶ï¼Œåœ¨æ¸²æŸ“çº¿ç¨‹ä¸­ï¼Œé‡Šæ”¾äº†æ²™ç®±é™åˆ¶ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥é€šè¿‡è°ƒç”¨ Node.js çš„ API æ¥è®¿é—®æœ¬åœ°æ–‡ä»¶ã€è·¨åŸŸç½‘ç»œèµ„æºã€æœ¬åœ°å­˜å‚¨ç­‰ã€‚

## `preload` çš„å®šä¹‰

`preload` æ˜¯å®Œå…¨ç‹¬ç«‹äºå‰ç«¯é¡¹ç›®çš„ä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶ï¼Œå®ƒåº”å½“ä¸ `plugin.json` ä½äºåŒä¸€ç›®å½•æˆ–å…¶å­ç›®å½•ä¸‹ï¼Œä¿è¯å¯ä»¥åœ¨æ‰“åŒ…æ’ä»¶åº”ç”¨æ—¶å¯ä»¥è¢«ä¸€èµ·æ‰“åŒ…ã€‚

`preload` js æ–‡ä»¶éµå¾ª `CommonJS` è§„èŒƒï¼Œå› æ­¤ä½ å¯ä»¥ä½¿ç”¨ `require` æ¥å¼•å…¥ Node.js æ¨¡å—ï¼Œæ­¤éƒ¨åˆ†å¯ä»¥å‚è€ƒ [Node.js æ–‡æ¡£](https://nodejs.org/api/modules.html)ã€‚


## å‰ç«¯ä½¿ç”¨ `preload`

åªéœ€ç»™ `window` å¯¹è±¡è‡ªå®šä¹‰ä¸€ä¸ªå±æ€§ï¼Œå‰ç«¯å°±å¯ç›´æ¥è®¿é—®è¯¥å±æ€§ã€‚

::: code-group

```js [preload.js]
const fs = require("fs");

window.customApis = {
  readFile: (path) => {
    return fs.readFileSync(path, "utf8");
  },
};
```

```jsx [App.jsx] {5-7}
import { useEffect, useState } from "react";
export default function App() {
  const [file, setFile] = useState("");
  useEffect(() => {
    window.customApis.readFile("/path/to/README.md").then((data) => {
      setFile(data);
    }
  }, []);

  return (
    <div>
      <pre>{file}</pre>
    <div>
  )
}
```

:::

## `preload` js è§„èŒƒ

ç”±äº `preload` js æ–‡ä»¶å¯ä½¿ç”¨æœ¬åœ°åŸç”Ÿèƒ½åŠ›ï¼Œä¸ºäº†é˜²æ­¢å¼€å‘è€…æ»¥ç”¨å„ç§è¯»å†™æ–‡ä»¶ã€ç½‘ç»œç­‰èƒ½åŠ›ï¼ŒuTools è§„å®šï¼š

- `preload` js æ–‡ä»¶ä»£ç ä¸èƒ½è¿›è¡Œæ‰“åŒ…/å‹ç¼©/æ··æ·†ç­‰æ“ä½œï¼Œè¦ä¿è¯æ¯ä¸€è¡Œä»£ç æ¸…æ™°å¯è¯»ã€‚
- å¼•å…¥çš„ç¬¬ä¸‰æ–¹æ¨¡å—ä¹Ÿå¿…é¡»æ¸…æ™°å¯è¯»ï¼Œåœ¨æäº¤æ—¶å°†æºç ä¸€åŒæäº¤ï¼ŒåŒæ ·ä¸å…è®¸å‹ç¼©/æ··æ·†ã€‚



# ä½¿ç”¨ Node.js

`preload` js æ–‡ä»¶éµå¾ª `CommonJS` è§„èŒƒï¼Œé€šè¿‡ `require` å¼•å…¥ Node.js (16.x ç‰ˆæœ¬) æ¨¡å—

å¯ä»¥å¼•å…¥ Node.js æ‰€æœ‰åŸç”Ÿæ¨¡å—ï¼Œå¼€å‘è€…è‡ªå·±ç¼–å†™çš„ Node.js æ¨¡å—ä»¥åŠç¬¬ä¸‰æ–¹ Node.js æ¨¡å—ã€‚

## å¼•å…¥ Node.js åŸç”Ÿæ¨¡å—

::: code-group

```js [preload.js]
const fs = require("node:fs");
const path = require("node:path");
const os = require("node:os");
const { execSync } = require("node:child_process");

window.services = {
  readFile: (filename) => {
    return fs.readFileSync(filename, { encoding: "utf-8" });
  },
  getFolder: (filepath) => {
    return path.dirname(filepath);
  },
  getOSInfo: () => {
    return { arch: os.arch(), cpus: os.cpus(), release: os.release() };
  },
  execCommand: (command) => {
    execSync(command);
  },
};
```

:::

## å¼•å…¥è‡ªå·±ç¼–å†™çš„æ¨¡å—

::: code-group

```js [preload.js]
const writeText = require("./libs/writeText.js");

window.services = {
  writeText,
};
```

```js [libs/writeText.js]
const fs = require("fs");
const path = require("path");

module.exports = function writeText(text, filePath) {
  const dir = path.dirname(filePath);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
    fs.writeFileSync(filePath, text);
    return true;
  }
  return false;
};
```

:::

## å¼•å…¥ç¬¬ä¸‰æ–¹æ¨¡å—

### é€šè¿‡ `npm` å®‰è£…

åœ¨ `preload.js` åŒçº§ç›®å½•ä¸‹ï¼Œä¿è¯å­˜åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ `package.json`ï¼Œå¹¶ä¸”è®¾ç½® `type` ä¸º `commons`ã€‚

```json [package.json]
{
  "type": "commonjs"
  "dependencies": {}
}
```

åœ¨ `preload.js` åŒçº§ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ `npm install` å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œä¿è¯ `node_modules` ç›®å½•å­˜åœ¨ã€‚

ä»¥ä¸‹æ˜¯é€šè¿‡ `npm` å¼•å…¥ `colord` çš„ç¤ºä¾‹:

```bash
npm install colord
```

::: code-group

```js [preload.js] {1,6,10}
const { getFormat, colord } = require("colord");

window.services = {
  colord: {
    darken(text) {
      const fmt = getFormat(text);
      if (!fmt) {
        return [null, "è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„é¢œè‰²å€¼ï¼Œæ¯”å¦‚ #000 æˆ– rgb(0,0,0)"];
      } else {
        const darkColor = colord(text).darken(0.1);
        return [darkColor, null];
      }
    },
  },
};
```

:::

### é€šè¿‡æºç å¼•å…¥

åœ¨ `preload.js` åŒçº§ç›®å½•ä¸‹ï¼Œä¸‹è½½æºç ï¼Œå¹¶ä½¿ç”¨ `require` å¼•å…¥ã€‚

æ¯”å¦‚ä» `github` ä¸‹è½½ `nodemailer`ï¼š

```bash
git clone https://github.com/nodemailer/nodemailer.git
```

::: code-group

```js [preload.js] {1,6-30}
const nodemailer = require("./nodemailer");
const _setImmediate = setImmediate;
process.once("loaded", function () {
  global.setImmediate = _setImmediate;
});
const sendMail = () => {
  let transporter = require("./nodemailer").createTransport({
    host: "smtp.qq.com",
    port: 465,
    secure: true,
    auth: {
      user: "aaa@qq.com",
      pass: "xxx",
    },
  });
  let mailOptions = {
    from: "aaa@qq.com",
    to: "bbb@gmail.com",
    subject: "Sending Email using Node.js",
    text: "That was easy!",
  };

  transporter.sendMail(mailOptions, function (error, info) {
    if (error) {
      console.log(error);
    } else {
      console.log("Email sent: " + info.response);
    }
  });
};
window.services = {
  sendMail: () => {
    return sendMail();
  },
};
```

:::

## å¼•å…¥ Electron æ¸²æŸ“è¿›ç¨‹ API

::: code-group

```js [preload.js]
const { clipboard, nativeImage } = require("electron");

window.services = {
  copyImage: (imageFilePath) => {
    clipboard.writeImage(nativeImage.createFromPath(imageFilePath))
  },
};
```
:::


# äº‹ä»¶

ä½ å¯ä»¥æ ¹æ®éœ€è¦ï¼Œäº‹å…ˆä¼ é€’ä¸€äº›å›è°ƒå‡½æ•°ç»™è¿™äº›äº‹ä»¶ï¼ŒuTools ä¼šåœ¨å¯¹åº”äº‹ä»¶è¢«è§¦å‘æ—¶è°ƒç”¨å®ƒä»¬ã€‚

## `utools.onPluginEnter(callback)`

è¿›å…¥æ’ä»¶åº”ç”¨æ—¶ï¼ŒuTools å°†ä¼šä¸»åŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚

### ç±»å‹å®šä¹‰

```ts
function onPluginEnter(callback: (action: PluginEnterAction) => void): void;
```

- `callback` è¿›å…¥æ’ä»¶åº”ç”¨è§¦å‘çš„å›è°ƒå‡½æ•°

::: details `PluginEnterAction` ç±»å‹å®šä¹‰ {#plugin-enter-action}

```ts
interface PluginEnterAction {
  code: string;
  type: "text" | "img" | "file" | "regex" | "over" | "window";
  payload: string | MatchFile[] | MatchWindow;
  from: "main" | "panel" | "hotkey" | "reirect";
  option?: {
    mainPush: boolean;
  };
}
```

#### å­—æ®µè¯´æ˜

- `code`
  - plugin.json é…ç½®çš„ feature.code
- `type`
  - plugin.json é…ç½®çš„ feature.cmd.type
- `payload`
  - feature.cmd.type å¯¹åº”åŒ¹é…çš„æ•°æ®
- `option`
  - feature.mainPush è®¾ç½®ä¸º ture ï¼Œä¸”å½“ç”¨æˆ·é€‰æ‹© onMainPush è¿”å›çš„é€‰é¡¹è¿›å…¥æ—¶
- `from`
  - æ ¹æ®ä¸åŒè§¦å‘æ¥æºæä¾›ï¼š
  >
  - `main`: ä¸»é¢æ¿
  - `panel`: è¶…çº§é¢æ¿
  - `hotkey`: å¿«æ·é”®
  - `reirect`: é‡å®šå‘

:::

::: details `MatchFile` ç±»å‹å®šä¹‰

```ts
interface MatchFile {
  isFile: boolean;
  isDirectory: boolean;
  name: string;
  path: string;
}
```

:::

::: details `MatchWindow` ç±»å‹å®šä¹‰

```ts
interface MatchWindow {
  id: number;
  class: string;
  title: string;
  x: number;
  y: number;
  width: number;
  height: number;
  appPath: string;
  pid: number;
  app: string;
}
```

:::

### ç¤ºä¾‹ä»£ç 

```js
utools.onPluginEnter(({ code, type, payload, option, from }) => {
  console.log("ç”¨æˆ·è¿›å…¥æ’ä»¶åº”ç”¨", code, type, payload);
  console.log("ç”¨æˆ·inrushæ’ä»¶çš„æ–¹å¼ï¼š", from);
});
```

## `utools.onPluginOut(callback)`

æ’ä»¶åº”ç”¨é€€å‡ºæ—¶è§¦å‘

### ç±»å‹å®šä¹‰

```ts
function onPluginOut(callback: (isKill: boolean) => void): void;
```

- `callback` é€€å‡ºæ’ä»¶åº”ç”¨æ—¶è§¦å‘çš„å›è°ƒå‡½æ•°
  - `isKill` ä¸º `true` æ—¶ï¼Œè¡¨ç¤ºæ’ä»¶åº”ç”¨ç»“æŸè¿è¡Œ(è¿›ç¨‹ç»“æŸ)

### ç¤ºä¾‹ä»£ç 

```js
utools.onPluginOut((isKill) => {
  if (isKill) {
    console.log("ç”¨æˆ·ç»“æŸè¿è¡Œæ’ä»¶åº”ç”¨");
  } else {
    console.log("æ’ä»¶åº”ç”¨è¢«éšè—åå°");
  }
});
```

## `utools.onMainPush(callback, onSelect)`

æ¨é€å†…å®¹åˆ°æœç´¢æ¡†ï¼Œå¹¶è®¾ç½®ä»æ¨é€çš„å†…å®¹é€‰é¡¹ä¸­æ‰“å¼€æ’ä»¶åº”ç”¨çš„å›è°ƒ

::: warning æ³¨æ„
å‘æœç´¢æ¡†æ¨é€æ¶ˆæ¯(éœ€è¦è®¾ç½® feature.mainPush è®¾ç½®ä¸º true)ï¼Œè¯¦æƒ…è¯·å‚è€ƒ [plugin.json#feature.mainPush](../../information/plugin-json.md#features-mainpush)
:::

### ç±»å‹å®šä¹‰

```ts
function onMainPush(
  callback: (action: MainPushAction) => MainPushResult[],
  onSelect: (action: PluginEnterAction) => boolean | undefined
): void;
```
- `callback` è§¦å‘å‘æœç´¢æ¡†æ¨é€å†…å®¹
  - MainPushAction è§¦å‘çš„å‚æ•°
  >
  - MainPushResult è¿”å›çš„å†…å®¹
- `onSelect` ç”¨æˆ·é€‰æ‹©æ¨é€çš„å†…å®¹æ—¶è§¦å‘ï¼Œè¿”å› `true` è¡¨ç¤ºè¿›å…¥æ’ä»¶åº”ç”¨å¹¶æ˜¾ç¤ºï¼Œä¸è¿”å›åˆ™é™é»˜æ‰§è¡Œè¯¥å‡½æ•°
  - PluginEnterAction å‚è€ƒ [`onPluginEnter#PluginEnterAction`](#plugin-enter-action)

::: details `MainPushAction` ç±»å‹å®šä¹‰

```ts
interface MainPushAction {
  code: string;
  type: "text" | "img" | "file" | "regex" | "over" | "window";
  payload: string | MatchFile[] | MatchWindow;
}
```

#### å­—æ®µè¯´æ˜

- `code`
  - plugin.json é…ç½®çš„ feature.code
- `type`
  - plugin.json é…ç½®çš„ feature.cmd.type
- `payload`
  - feature.cmd.type å¯¹åº”åŒ¹é…çš„æ•°æ®ï¼Œ`MatchFile` å’Œ `MatchWindow` ç±»å‹å‚è€ƒ [onPluginEnter](#utools-onpluginenter)

:::

::: details `MainPushResult` ç±»å‹å®šä¹‰

```ts
interface MainPushResult {
  icon: string;
  title: string;
  text: string;
}
```

#### å­—æ®µè¯´æ˜

- `icon`
  - æ¨é€æ¶ˆæ¯çš„å›¾æ ‡
- `title`
  - æ¨é€æ¶ˆæ¯çš„æ ‡é¢˜
- `text`
  - æ¨é€æ¶ˆæ¯çš„å†…å®¹

:::

### ç¤ºä¾‹ä»£ç 

```js
function callback({ code, type, payload }) {
  return [
    {
      icon: "icon.png",
      text: "é€‰é¡¹1",
      title: "help text",
    },
    {
      text: "é€‰é¡¹2",
      anyField: "xxxx",
    },
  ];
}
function selectCallback({ code, type, payload, option }) {
  if (option.xxx) {
    // è¿”å› true è¡¨ç¤ºéœ€è¦è¿›å…¥æ’ä»¶åº”ç”¨å¤„ç†
    return true;
  }
  // ä¸è¿›å…¥æ’ä»¶åº”ç”¨ "æ‰§è¡Œç²˜è´´æ–‡æœ¬"
  utools.hideMainWindowPasteText(option.text);
}
utools.onMainPush(callback, selectCallback);
```

## `utools.onPluginDetach(callback)`

ç”¨æˆ·å¯¹æ’ä»¶åº”ç”¨è¿›è¡Œåˆ†ç¦»æ“ä½œæ—¶è§¦å‘

### ç±»å‹å®šä¹‰

```ts
function onPluginDetach(callback: () => void): void;
```

- `callback` æ’ä»¶åº”ç”¨åˆ†ç¦»ä¸ºç‹¬ç«‹çª—å£æ—¶è§¦å‘çš„å›è°ƒå‡½æ•°

### ç¤ºä¾‹ä»£ç 

```js
utools.onPluginDetach(() => {
  console.log("æ’ä»¶åº”ç”¨åˆ†ç¦»ä¸ºç‹¬ç«‹çª—å£");
});
```

## `utools.onDbPull(callback)`

å½“æ­¤æ’ä»¶åº”ç”¨çš„æ•°æ®åœ¨å…¶ä»–è®¾å¤‡ä¸Šè¢«æ›´æ”¹ååŒæ­¥åˆ°æ­¤è®¾å¤‡æ—¶è§¦å‘

### ç±»å‹å®šä¹‰

```ts
function onDbPull(callback: (docs: DbDoc[]) => void): void;
```

- `callback` å½“æ’ä»¶åº”ç”¨åœ¨è¿è¡Œä¸­ï¼Œä»äº‘ç«¯åŒæ­¥è¯¥æ’ä»¶åº”ç”¨æ•°æ®æ—¶è§¦å‘çš„å›è°ƒå‡½æ•°
  - `docs` åŒæ­¥çš„æ•°æ®ï¼Œç±»å‹å‚è€ƒ [DbDoc](../db/local-db.md#def-dbdoc)

### ç¤ºä¾‹ä»£ç 

```js
utools.onDbPull((docs) => {
  console.log(docs);
});
```


# çª—å£

ç”¨æ¥å®ç°ä¸€äº›è·Ÿ uTools çª—å£ç›¸å…³çš„åŠŸèƒ½

## `utools.hideMainWindow(isRestorePreWindow)`

æ‰§è¡Œè¯¥æ–¹æ³•å°†ä¼šéšè— uTools ä¸»çª—å£ï¼ŒåŒ…æ‹¬æ­¤æ—¶æ­£åœ¨ä¸»çª—å£è¿è¡Œçš„æ’ä»¶åº”ç”¨ï¼Œåˆ†ç¦»çš„æ’ä»¶åº”ç”¨ä¸ä¼šè¢«éšè—ã€‚

### ç±»å‹å®šä¹‰

```ts
function hideMainWindow(isRestorePreWindow?: boolean): boolean;
```

- `isRestorePreWindow`è¡¨ç¤ºæ˜¯å¦ç„¦ç‚¹å›å½’åˆ°å‰é¢çš„æ´»åŠ¨çª—å£ï¼Œé»˜è®¤ true

### ç¤ºä¾‹ä»£ç 

```js
utools.hideMainWindow();
```

## `utools.showMainWindow()`

æ‰§è¡Œè¯¥æ–¹æ³•å°†ä¼šæ˜¾ç¤º uTools ä¸»çª—å£ï¼ŒåŒ…æ‹¬æ­¤æ—¶æ­£åœ¨ä¸»çª—å£è¿è¡Œçš„æ’ä»¶åº”ç”¨ã€‚

### ç±»å‹å®šä¹‰

```ts
function showMainWindow(): boolean;
```

### ç¤ºä¾‹ä»£ç 

```js
utools.showMainWindow();
```

## `utools.setExpendHeight(height)`

è®¾ç½®æ’ä»¶åº”ç”¨åœ¨ä¸»çª—å£ä¸­çš„é«˜åº¦ï¼Œå•ä½ä¸ºåƒç´ ã€‚

### ç±»å‹å®šä¹‰

```ts
function setExpendHeight(height: number): boolean;
```

- `height` æ’ä»¶åº”ç”¨é«˜åº¦

### ç¤ºä¾‹ä»£ç 

```js
utools.setExpendHeight(300);
```

## `utools.setSubInput(onChange[, placeholder[, isFocus]])`

è®¾ç½®å­è¾“å…¥æ¡†ï¼Œè¿›å…¥æ’ä»¶åº”ç”¨åï¼ŒåŸæœ¬ uTools çš„æœç´¢æ¡ä¸»è¾“å…¥æ¡†å°†ä¼šå˜æˆå­è¾“å…¥æ¡†ï¼Œå­è¾“å…¥æ¡†å¯ä»¥ä¸ºæ’ä»¶åº”ç”¨æ‰€ä½¿ç”¨ã€‚

### ç±»å‹å®šä¹‰

```ts
function setSubInput(onChange: (details: { text: string }) => void, placeholder?: string, isFocus?: boolean): boolean;
```

- `onChange`: è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶çš„å›è°ƒå‡½æ•°
- `placeholder`: è¾“å…¥æ¡†å ä½ç¬¦
- `isFocus`: æ˜¯å¦è‡ªåŠ¨èšç„¦ï¼Œé»˜è®¤ä¸º `true`

### ç¤ºä¾‹ä»£ç 

```js
utools.setSubInput(({ text }) => {
  console.log(text);
}, "æœç´¢");
```

#### æ•ˆæœæˆªå›¾

![è®¾ç½®å­è¾“å…¥æ¡†](https://res.u-tools.cn/website/subInput.png "è®¾ç½®å­è¾“å…¥æ¡†")

## `utools.removeSubInput()`

ç§»é™¤å­è¾“å…¥æ¡†ã€‚

### ç±»å‹å®šä¹‰

```ts
function removeSubInput(): boolean;
```

### ç¤ºä¾‹ä»£ç 

```js
utools.removeSubInput();
```

## `utools.setSubInputValue(text)`

ç›´æ¥å¯¹å­è¾“å…¥æ¡†çš„å€¼è¿›è¡Œè®¾ç½®ã€‚

### ç±»å‹å®šä¹‰

```ts
function setSubInputValue(text: string): boolean;
```

- `text` å­è¾“å…¥æ¡†èµ‹å€¼çš„æ–‡æœ¬

### ç¤ºä¾‹ä»£ç 

```js
utools.setSubInputValue("hello world");
```

## `utools.subInputFocus()`

èšç„¦å­è¾“å…¥æ¡†ã€‚

### ç±»å‹å®šä¹‰

```ts
function subInputFocus(): boolean;
```

### ç¤ºä¾‹ä»£ç 

```js
utools.subInputFocus();
```

## `utools.subInputBlur()`

å­è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹ï¼Œæ’ä»¶åº”ç”¨è·å¾—ç„¦ç‚¹

### ç±»å‹å®šä¹‰

```ts
function subInputBlur(): boolean;
```

### ç¤ºä¾‹ä»£ç 

```js
utools.subInputBlur();
```

## `utools.subInputSelect()`

å­è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹å¹¶é€‰ä¸­å­è¾“å…¥æ¡†çš„å†…å®¹

### ç±»å‹å®šä¹‰

```ts
function subInputSelect(): boolean;
```

### ç¤ºä¾‹ä»£ç 

```js
utools.subInputSelect();
```

## `utools.outPlugin([isKill])`

é€€å‡ºæ’ä»¶åº”ç”¨ï¼Œé»˜è®¤å°†æ’ä»¶åº”ç”¨éšè—åå°ã€‚

### ç±»å‹å®šä¹‰

```ts
function outPlugin(isKill?: boolean): boolean;
```

- `isKill` ä¸º `true` æ—¶ï¼Œå°†ç»“æŸè¿è¡Œæ’ä»¶åº”ç”¨(æ€æ­»è¿›ç¨‹)

### ç¤ºä¾‹ä»£ç 

```js
utools.outPlugin();
```

## `utools.redirect(label[, payload])`

è·³è½¬åˆ°å¦ä¸€ä¸ªæ’ä»¶åº”ç”¨ï¼Œå¹¶å¯ä»¥æºå¸¦åŒ¹é…æŒ‡ä»¤çš„å†…å®¹ï¼Œå¦‚æœæ’ä»¶åº”ç”¨ä¸å­˜åœ¨ï¼Œåˆ™è·³è½¬åˆ°æ’ä»¶åº”ç”¨å¸‚åœºè¿›è¡Œä¸‹è½½ã€‚

### ç±»å‹å®šä¹‰

```ts
function redirect(label: string | [string, string], payload?: any): boolean;
```

- `label` ä¸º `string` æ—¶å‚æ•°ä¸ºæŒ‡ä»¤åç§°ã€‚è‹¥ä¼ é€’æ•°ç»„ï¼Œåˆ™ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºæ’ä»¶åº”ç”¨åç§°ï¼Œç¬¬äºŒä¸ªå…ƒç´ ä¸ºæŒ‡ä»¤åç§°
  > - åªä¼ é€’æŒ‡ä»¤åç§°ï¼Œåº•åº§ä¼šæŸ¥æ‰¾æ‰€æœ‰æ‹¥æœ‰è¯¥æŒ‡ä»¤çš„æ’ä»¶åº”ç”¨ï¼Œå¦‚æœåªæŸ¥æ‰¾åˆ°ä¸€ä¸ªæ’ä»¶åº”ç”¨åˆ™ç›´æ¥æ‰“å¼€ï¼Œå¤šä¸ªåˆ™è®©ç”¨æˆ·é€‰æ‹©æ‰“å¼€ï¼Œæœªæ‰¾åˆ°å°†è·³è½¬è‡³æ’ä»¶åº”ç”¨å¸‚åœºå¹¶æœç´¢è¯¥æŒ‡ä»¤åç§°
  > - ä¼ é€’æ•°ç»„ï¼Œå³åŒ…å«æ’ä»¶åº”ç”¨åç§°å’ŒæŒ‡ä»¤åç§°ï¼Œåº•åº§å°†å®šä½åˆ°è¯¥æ’ä»¶åº”ç”¨å¹¶æ‰“å¼€å¯¹åº”æŒ‡ä»¤ï¼Œè‹¥æ’ä»¶åº”ç”¨æœªä¸‹è½½ï¼Œå°†è·³è½¬è‡³æ’ä»¶åº”ç”¨å¸‚åœºä¸‹è½½å†æ‰“å¼€ã€‚
- `payload` è·³è½¬ã€ŒåŠŸèƒ½æŒ‡ä»¤ã€è¯¥å‚æ•°è®¾ä¸ºç©ºã€‚è‹¥è·³è½¬ã€ŒåŒ¹é…æŒ‡ä»¤ã€åˆ™è¯¥å‚æ•°å¿…é¡»ä¸ºæŒ‡ä»¤å¯åŒ¹é…çš„å†…å®¹

### ç¤ºä¾‹ä»£ç 

```js
// è·³è½¬åˆ°æ’ä»¶åº”ç”¨ã€Œèšåˆç¿»è¯‘ã€å¹¶ç¿»è¯‘å†…å®¹
utools.redirect(["èšåˆç¿»è¯‘", "ç¿»è¯‘"], "hello world");

// æ‰¾åˆ° â€œç¿»è¯‘â€ æŒ‡ä»¤ï¼Œå¹¶è‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”æ’ä»¶åº”ç”¨
utools.redirect("ç¿»è¯‘", "hello world");

// è·³è½¬åˆ°æ’ä»¶åº”ç”¨ã€ŒOCR æ–‡å­—è¯†åˆ«ã€å¹¶è¯†åˆ«å›¾ç‰‡ä¸­æ–‡å­—
utools.redirect(["OCR æ–‡å­—è¯†åˆ«", "OCR æ–‡å­—è¯†åˆ«"], {
  type: "img",
  data: "data:image/png;base64,", // base64
});

// è·³è½¬åˆ°æ’ä»¶åº”ç”¨ã€ŒJSON ç¼–è¾‘å™¨ã€æŸ¥çœ‹ Json æ–‡ä»¶
utools.redirect(["JSON ç¼–è¾‘å™¨", "Json"], {
  type: "files",
  data: "/path/to/test.json", // æ”¯æŒæ•°ç»„
});
```

## `utools.showOpenDialog(options)`

å¼¹å‡ºæ–‡ä»¶é€‰æ‹©æ¡†

### ç±»å‹å®šä¹‰

```ts
function showOpenDialog(options: OpenDialogOptions): string[] | undefined;
```

- `OpenDialogOptions` ä¸[Electron `showOpenDialogSync#options`](https://www.electronjs.org/docs/api/dialog#dialogshowopendialogsyncbrowserwindow-options) ä¸€è‡´
- è¿”å›æ–‡ä»¶è·¯å¾„æ•°ç»„ã€‚ç”¨æˆ·å–æ¶ˆåˆ™è¿”å›ç©º

### ç¤ºä¾‹ä»£ç 

```js
const files = utools.showOpenDialog({
  filters: [{ name: "plugin.json", extensions: ["json"] }],
  properties: ["openFile"],
});

console.log(files);
```

## `utools.showSaveDialog(options)`

å¼¹å‡ºæ–‡ä»¶ä¿å­˜æ¡†

### ç±»å‹å®šä¹‰

```ts
function showSaveDialog(options: SaveDialogOptions): string | undefined;
```

- `SaveDialogOptions` ä¸[Electron `showSaveDialogSync#options`](https://www.electronjs.org/docs/api/dialog#dialogshowsavedialogsyncbrowserwindow-options) ä¸€è‡´
- è¿”å›é€‰æ‹©çš„æ–‡ä»¶å¤¹è·¯å¾„ã€‚ç”¨æˆ·å–æ¶ˆåˆ™è¿”å›ç©º

### ç¤ºä¾‹ä»£ç 

```js
const savePath = utools.showSaveDialog({
  title: "ä¿å­˜ä½ç½®",
  defaultPath: utools.getPath("downloads"),
  buttonLabel: "ä¿å­˜",
});
console.log(savePath);
```

## `utools.findInPage(text[, options])`

åœ¨å½“å‰é¡µé¢ä¸­æŸ¥æ‰¾æ–‡æœ¬

### ç±»å‹å®šä¹‰

```ts
function findInPage(text: string, options?: FindInPageOptions): void;
```

- `text` æŸ¥æ‰¾çš„æ–‡æœ¬
- `FindInPageOptions` ä¸[Electron `webContents.findInPage#options`](https://www.electronjs.org/docs/api/web-contents#contentsfindinpagetext-options) ä¸€è‡´

### ç¤ºä¾‹ä»£ç 

```js
utools.findInPage("hello world");
```

## `utools.stopFindInPage(action)`

åœæ­¢æŸ¥æ‰¾ï¼Œä¸`findInPage` é…åˆä½¿ç”¨

### ç±»å‹å®šä¹‰

```ts
function stopFindInPage(
  action: "clearSelection" | "keepSelection" | "activateSelection"
): void;
```

- `action`: `clearSelection` æ¸…é™¤é€‰ä¸­æ–‡æœ¬ï¼Œ`keepSelection` ä¿ç•™é€‰ä¸­æ–‡æœ¬ï¼Œ`activateSelection` æ¿€æ´»é€‰ä¸­æ–‡æœ¬ï¼Œé»˜è®¤å€¼ä¸º `clearSelection`

### ç¤ºä¾‹ä»£ç 

```js
utools.stopFindInPage("clearSelection");
```

## `utools.startDrag(filePath)`

ä»æ’ä»¶ä¸­æ‹–æ‹½æ–‡ä»¶åˆ°å…¶ä»–çª—å£ï¼Œæ‹–æ‹½äº§ç”Ÿä¸€ç³»åˆ—åŸç”Ÿæ–‡ä»¶

### ç±»å‹å®šä¹‰

```ts
function startDrag(filePath: string | string[]): void;
```

- `filePath` æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶è·¯å¾„æ•°ç»„

### ç¤ºä¾‹ä»£ç 

```js
utools.startDrag("/path/to/abc.txt");
utools.startDrag(["/path/to/1.txt", "/path/to/2.txt"]);
```

## `utools.createBrowserWindow(url[, options][, callback])`

åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çª—å£

### ç±»å‹å®šä¹‰

```ts
function createBrowserWindow(url: string, options: BrowserWindowConstructorOptions, callback?: Function): BrowserWindow;
```

- `url` ç›¸å¯¹è·¯å¾„çš„ html æ–‡ä»¶
- `options` å‚æ•°å‚è€ƒ Electron çš„ [BrowserWindowConstructorOptions](https://electronjs.org/docs/api/browser-window#new-browserwindowoptions)ã€‚**æ³¨æ„ï¼špreload é…ç½®ä¹Ÿæ˜¯ç›¸å¯¹è·¯å¾„**ã€‚
- `callback` åœ¨é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨
- è¿”å›çš„ `BrowserWindow` ç”± uTools å®šåˆ¶ï¼Œå¤§éƒ¨åˆ†çš„å‡½æ•°å’Œå±æ€§éƒ½æ˜¯ç»§æ‰¿ Electron çš„ [BrowserWindow](https://electronjs.org/docs/api/browser-window)ã€‚**æ³¨æ„ï¼šä¸åŒ…å« BrowserWindow å’Œ webContents çš„å®ä¾‹äº‹ä»¶**ã€‚

### ç¤ºä¾‹ä»£ç 

::: code-group

```js [çˆ¶çª—å£]
const ubWindow = utools.createBrowserWindow(
  "test.html",
  {
    show: false,
    title: "æµ‹è¯•çª—å£",
    webPreferences: {
      preload: "preload.js",
    },
  },
  () => {
    // æ˜¾ç¤º
    ubWindow.show();
    // ç½®é¡¶
    ubWindow.setAlwaysOnTop(true);
    // çª—å£å…¨å±
    ubWindow.setFullScreen(true);
    // å‘å­çª—å£å‘é€æ¶ˆæ¯
    ubWindow.webContents.send("ping", "test");
    // æ‰§è¡Œè„šæœ¬
    ubWindow.webContents.executeJavaScript('fetch("https://jsonplaceholder.typicode.com/users/1").then(resp => resp.json())').then((result) => {
      console.log(result); // Will be the JSON object from the fetch call
    });
  }
);
console.log(ubWindow);
```

```js [å­çª—å£]
// åœ¨æ–°å»ºçª—å£çš„ preload.js ä¸­æ¥æ”¶çˆ¶çª—å£ä¼ é€’è¿‡æ¥çš„æ•°æ®
const { ipcRenderer } = require("electron");
ipcRenderer.on("ping", (event, data) => {
  console.log(data);
});
utools.sendToParent("pong", "hello world"); // ç‰ˆæœ¬ï¼š>= 6.1.0
```

:::

## `utools.sendToParent(channel[, ...args])`

å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£

### ç±»å‹å®šä¹‰

```ts
function sendToParent(channel: string, ...args: any[]): void; // ç‰ˆæœ¬ï¼š>=6.1.0
```

- `channel` æ¶ˆæ¯é€šé“åç§°

### ç¤ºä¾‹ä»£ç 

```js
// é€šè¿‡ utools.createBrowserWindow åˆ›å»ºçš„çª—å£è°ƒç”¨
utools.sendToParent("pong", "hello", 123); // ç‰ˆæœ¬ï¼š>= 6.1.0
```

## `utools.getWindowType()`

è·å–å½“å‰çª—å£ç±»å‹, 'main' ä¸»çª—å£ã€'detach' åˆ†ç¦»çª—å£ã€'browser' ç”± `createBrowserWindow` åˆ›å»ºçš„çª—å£

### ç±»å‹å®šä¹‰

```ts
function getWindowType(): "main" | "detach" | "browser";
```

### ç¤ºä¾‹ä»£ç 

```js
utools.onPluginEnter(({ code, type, payload }) => {
  if (utools.getWindowType() === "main") {
    utools.showNotification("å½“å‰çª—å£ä¸ºä¸»çª—å£");
  }
});
```

## `utools.isDarkColors()`

è·å–æ˜¯å¦æ·±è‰²ä¸»é¢˜

### ç±»å‹å®šä¹‰

```ts
function isDarkColors(): boolean;
```

### ç¤ºä¾‹ä»£ç 

```js
utools.onPluginEnter(({ code, type, payload }) => {
  document.body.className = utools.isDarkColors() ? "dark-mode" : "";
});
```

::: warning æ¨è

æ›´æ¨è web åŸç”Ÿæ–¹å¼åˆ¤æ–­
```js
  let theme
  // æ˜¯å¦æ·±è‰²ä¸»é¢˜
  const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches
  theme = isDark ? 'dark' : 'light'
  // ç›‘å¬ä¸»é¢˜åˆ‡æ¢
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    theme = e.matches ? 'dark' : 'light'
  })
```
:::


# å¤åˆ¶

æ‰§è¡Œå¤åˆ¶æ–‡æœ¬ã€å›¾åƒã€æ–‡ä»¶(å¤¹)

## `utools.copyText(text)`

å¤åˆ¶æ–‡æœ¬

### ç±»å‹å®šä¹‰

```ts
function copyText(text: string): boolean;
```

- `text` è¢«å¤åˆ¶çš„æ–‡æœ¬

### ç¤ºä¾‹ä»£ç 

```js
utools.copyText("Hello World!");
```

## `utools.copyFile(filePath)`

å¤åˆ¶æ–‡ä»¶

### ç±»å‹å®šä¹‰

```ts
function copyFile(filePath: string | string[]): boolean;
```

- `filePath` ä¸ºæ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥æ˜¯å•ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶è·¯å¾„æ•°ç»„ã€‚

### ç¤ºä¾‹ä»£ç 

```js
utools.copyFile("C:\\Users\\Administrator\\Desktop\\test.txt");
```

## `utools.copyImage(image)`

å¤åˆ¶å›¾åƒ

### ç±»å‹å®šä¹‰

```ts
function copyImage(image: string | Uint8Array): boolean;
```

- `image` å¯ä»¥æ˜¯ä¸€å¼ å›¾ç‰‡æ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯å›¾åƒ Base64 çš„ Data URLã€‚æˆ–å›¾åƒçš„ Buffer

### ç¤ºä¾‹ä»£ç 

```js
// base64
utools.copyImage("data:image/png;base64,......");
// è·¯å¾„
utools.copyImage("/path/to/img.png");
```

## `utools.getCopyedFiles()`

è·å–ç³»ç»Ÿå‰ªè´´æ¿ä¸­å¤åˆ¶çš„æ–‡ä»¶åˆ—è¡¨ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„å…ƒç´ ä¸ºæ–‡ä»¶è·¯å¾„ã€‚

### ç±»å‹å®šä¹‰

```ts
function getCopyedFiles(): CopiedFile[];
```

::: details `CopiedFile` ç±»å‹å®šä¹‰

```ts
interface CopiedFile {
  path: string;
  isDiractory: boolean;
  isFile: boolean;
  name: string;
}
```

#### å­—æ®µè¯´æ˜

- `path`
  - æ–‡ä»¶è·¯å¾„
- `isDiractory`
  - æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹
- `isFile`
  - æ˜¯å¦ä¸ºæ–‡ä»¶
- `name`
  - æ–‡ä»¶å

:::


# è¾“å…¥

å¯¹å¤–éƒ¨åº”ç”¨è¿›è¡Œä¸€äº›è¾“å…¥æ“ä½œï¼Œç²˜è´´æ–‡æœ¬ã€ç²˜è´´å›¾åƒã€ç²˜è´´æ–‡ä»¶ã€‚

## `utools.hideMainWindowPasteFile(filePath)`

å…ˆå¤åˆ¶æ–‡ä»¶å†æ‰§è¡Œç²˜è´´æ“ä½œ

### ç±»å‹å®šä¹‰

```ts
function hideMainWindowPasteFile(filePath: string | string[]): boolean;
```

- `filePath` ä¸ºæ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥æ˜¯å•ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶è·¯å¾„æ•°ç»„ã€‚

### ç¤ºä¾‹ä»£ç 

```js
utools.hideMainWindowPasteFile("C:\\Users\\Administrator\\Desktop\\test.txt");
```

## `utools.hideMainWindowPasteImage(image)`

å…ˆå¤åˆ¶å›¾åƒå†æ‰§è¡Œç²˜è´´æ“ä½œ

### ç±»å‹å®šä¹‰

```ts
function hideMainWindowPasteImage(image: string | Uint8Array): boolean;
```

- `image` å¯ä»¥æ˜¯ä¸€å¼ å›¾ç‰‡æ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯å›¾åƒ Base64 çš„ Data URLã€‚æˆ–å›¾åƒçš„ Buffer

### ç¤ºä¾‹ä»£ç 

```js
// base64
utools.hideMainWindowPasteImage("data:image/png;base64,......");
// è·¯å¾„
utools.hideMainWindowPasteImage("/path/to/test.png");
```

## `utools.hideMainWindowPasteText(text)`

å…ˆå¤åˆ¶æ–‡æœ¬å†æ‰§è¡Œç²˜è´´æ“ä½œ

### ç±»å‹å®šä¹‰

```ts
function hideMainWindowPasteText(text: string): boolean;
```

- `text` å­—ç¬¦ä¸²æ–‡æœ¬

### ç¤ºä¾‹ä»£ç 

```js
utools.hideMainWindowPasteText("Hello World!");
```

## `utools.hideMainWindowTypeString(text)`

è¾“å…¥æ–‡æœ¬ï¼Œä¸è¾“å…¥æ³•åŸç†ç±»ä¼¼ï¼Œå¯ä»¥è¾“å…¥ä»»æ„å­—ç¬¦ä¸²

### ç±»å‹å®šä¹‰

```ts
function hideMainWindowTypeString(text: string): boolean;
```

- `text` è¦è¾“å…¥çš„æ–‡æœ¬ï¼Œæ”¯æŒ Emoji

### ç¤ºä¾‹ä»£ç 

```js
utools.hideMainWindowTypeString("uTools æ–°ä¸€ä»£æ•ˆç‡å·¥å…·å¹³å° - ğŸ¼ğŸ‘ğŸ¦„ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ğŸšµğŸ»");
```


# ç³»ç»Ÿ

æä¾›ä¸€äº›ç³»ç»Ÿçº§ API çš„å°è£…ï¼Œä¹ŸåŒ…å«éƒ¨åˆ†å¯¹äº uTools åº•åº§åŠŸèƒ½çš„å°è£…ã€‚

## `utools.showNotification(body[, clickFeatureCode])`

å¼¹å‡ºç³»ç»Ÿé€šçŸ¥

### ç±»å‹å®šä¹‰

```ts
function showNotification(body: string, clickFeatureCode?: string): void;
```

- `body` é€šçŸ¥çš„å†…å®¹
- `clickFeatureCode` å¯¹åº” plugin.json é…ç½®çš„ feature.codeï¼Œç‚¹å‡»é€šçŸ¥è¿›å…¥æ’ä»¶åº”ç”¨

### ç¤ºä¾‹ä»£ç 

```js
utools.showNotification("hello test");
```

## `utools.shellOpenPath(fullPath)`

ç³»ç»Ÿé»˜è®¤æ–¹å¼æ‰“å¼€ç»™å®šçš„æ–‡ä»¶

### ç±»å‹å®šä¹‰

```ts
function shellOpenPath(fullPath: string): void;
```

- `fullPath` æ–‡ä»¶(å¤¹)è·¯å¾„

### ç¤ºä¾‹ä»£ç 

```js
utools.shellOpenPath("C:\\Users\\Public\\Desktop\\test.txt");
```

## `utools.shellTrashItem(fullPath)`

åˆ é™¤æ–‡ä»¶åˆ°å›æ”¶ç«™

### ç±»å‹å®šä¹‰

```ts
function shellTrashItem(fullPath: string): void;
```

- `fullPath` æ–‡ä»¶è·¯å¾„

### ç¤ºä¾‹ä»£ç 

```js
utools.shellTrashItem("C:\\Users\\Public\\Desktop\\test.txt");
```

## `utools.shellShowItemInFolder(fullPath)`

åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ˜¾ç¤ºæ–‡ä»¶

### ç±»å‹å®šä¹‰

```ts
function shellShowItemInFolder(fullPath: string): void;
```

- `fullPath` æ–‡ä»¶(å¤¹)è·¯å¾„

### ç¤ºä¾‹ä»£ç 

```js
utools.shellShowItemInFolder("C:\\Users\\Public\\Desktop\\test.txt");
```

## `utools.shellOpenExternal(url)`

ç³»ç»Ÿé»˜è®¤çš„åè®®æ‰“å¼€ URL

### ç±»å‹å®šä¹‰

```ts
function shellOpenExternal(url: string): void;
```

- `url` å¸¸è§„æ˜¯ http åè®®çš„ url, ä¹Ÿå¯ä»¥å…¶ä»–åè®®çš„ url, ä¾‹å¦‚ï¼šå†™é‚®ä»¶ mailto:example@example.com?subject=Hello&body=How%20are%20you%3F

### ç¤ºä¾‹ä»£ç 

```js
// æ‰“å¼€ uTools å®˜ç½‘
utools.shellOpenExternal("https://www.u-tools.cn");
```

## `utools.shellBeep()`

æ’­æ”¾ç³»ç»Ÿæç¤ºéŸ³

### ç±»å‹å®šä¹‰

```ts
function shellBeep(): void;
```

### ç¤ºä¾‹ä»£ç 

```js
utools.shellBeep();
```

## `utools.getNativeId()`

è·å–è®¾å¤‡ IDï¼Œç”¨äºåŒºåˆ«è®¾å¤‡

### ç±»å‹å®šä¹‰

```ts
function getNativeId(): string;
```

### ç¤ºä¾‹ä»£ç 

```js
// å­˜å‚¨åªä¸å½“å‰è®¾å¤‡ç›¸å…³çš„ä¿¡æ¯
const nativeId = utools.getNativeId();
utools.dbStorage.setItem(nativeId + "/key", "native value");
```

## `utools.getAppName()`

è·å–è½¯ä»¶åç§°

### ç±»å‹å®šä¹‰

```ts
function getAppName(): string;
```

### ç¤ºä¾‹ä»£ç 

```js
console.log(utools.getAppName());
```

## `utools.getAppVersion()`

è·å–è½¯ä»¶ç‰ˆæœ¬

### ç±»å‹å®šä¹‰

```ts
function getAppVersion(): string;
```

### ç¤ºä¾‹ä»£ç 

```js
console.log(utools.getAppVersion());
```

## `utools.getPath(name)`

è·å–è·¯å¾„ï¼Œæä¾›äº†ä¸€äº›ç‰¹æ®Šçš„è·¯å¾„è·å–æ–¹æ³•

### ç±»å‹å®šä¹‰

```ts
function getPath(name: string): string;
```

- `name` å¯ä»¥æ˜¯ä»¥ä¸‹ç‰¹å®šçš„å€¼
  - `home` ç”¨æˆ·ä¸»ç›®å½•
  - `appData` åº”ç”¨ç¨‹åºæ•°æ®ç›®å½•
    - `%APPDATA%` (Windows)
    - `~/Library/Application Support` (macOS)
  - `userData` åº”ç”¨ç¨‹åºç”¨æˆ·æ•°æ®ç›®å½•ï¼Œé»˜è®¤æ˜¯ appData æ–‡ä»¶å¤¹é™„åŠ åº”ç”¨çš„åç§°
  - `temp` ä¸´æ—¶ç›®å½•
  - `exe` å½“å‰å¯æ‰§è¡Œæ–‡ä»¶çš„ç»å¯¹è·¯å¾„
  - `desktop` ç”¨æˆ·æ¡Œé¢ç›®å½•
  - `documents` ç”¨æˆ·æ–‡æ¡£ç›®å½•
  - `downloads` ç”¨æˆ·ä¸‹è½½ç›®å½•
  - `music` ç”¨æˆ·éŸ³ä¹ç›®å½•
  - `pictures` ç”¨æˆ·å›¾ç‰‡ç›®å½•
  - `videos` ç”¨æˆ·è§†é¢‘ç›®å½•
  - `logs` ç”¨æˆ·æ—¥å¿—ç›®å½•


## `utools.getFileIcon(filePath)`

è·å–ç³»ç»Ÿå›¾æ ‡

### ç±»å‹å®šä¹‰

```ts
function getFileIcon(filePath: string): string;
```

- `filePath` æ–‡ä»¶è·¯å¾„æˆ–æ–‡ä»¶æ‰©å±•å
  - æ–‡ä»¶å¤¹ç”¨ 'folder'
- è¿”å›å›¾æ ‡çš„ base64 Data Url

### ç¤ºä¾‹ä»£ç 

```js
// txt æ–‡ä»¶æ‰©å±•ç±»å‹çš„ç³»ç»Ÿå›¾æ ‡
const txtIcon = utools.getFileIcon(".txt");
// æ–‡ä»¶å¤¹ç³»ç»Ÿå›¾æ ‡
const folderIcon = utools.getFileIcon("folder");
// å¾®ä¿¡å›¾æ ‡
const folderIcon = utools.getFileIcon("C:\\Users\\Public\\Desktop\\å¾®ä¿¡.lnk");
```

## `utools.readCurrentFolderPath()`

è¯»å–å½“å‰æ–‡ä»¶ç®¡ç†å™¨çª—å£è·¯å¾„ (linux ä¸æ”¯æŒ)ï¼Œå‰æå½“å‰æ´»åŠ¨ç³»ç»Ÿçª—å£æ˜¯ã€Œæ–‡ä»¶ç®¡ç†å™¨ã€

### ç±»å‹å®šä¹‰

```ts
function readCurrentFolderPath(): Promise<string>;
```

### ç¤ºä¾‹ä»£ç 

```js
const folderPath = await utools.readCurrentFolderPath();
console.log(folderPath);
```

## `utools.readCurrentBrowserUrl()`

è¯»å–å½“å‰æµè§ˆå™¨çª—å£è·¯å¾„ (linux ä¸æ”¯æŒ)ï¼Œå‰æå½“å‰æ´»åŠ¨ç³»ç»Ÿçª—å£æ˜¯æµè§ˆå™¨

::: warning è­¦å‘Š
ç”±äºæµè§ˆå™¨å·®å¼‚ï¼Œç›®å‰ä»…å¯¹ä»¥ä¸‹æµè§ˆå™¨å®Œæˆæµ‹è¯•ï¼š

- MacOS: Safariã€Chromeã€Microsoft Edgeã€Operaã€Vivaldiã€Brave
- Windows: Chromeã€Firefoxã€Edgeã€IEã€Operaã€Brave

:::

### ç±»å‹å®šä¹‰

```ts
function readCurrentBrowserUrl(): Promise<string>;
```

### ç¤ºä¾‹ä»£ç 

```js
const url = await utools.readCurrentBrowserUrl();
console.log(url);
```

## `utools.isDev()`

åˆ¤æ–­æ’ä»¶åº”ç”¨æ˜¯å¦åœ¨å¼€å‘ç¯å¢ƒ

::: tip æç¤º
æ’ä»¶åº”ç”¨å¼€å‘ç¯å¢ƒæ˜¯æŒ‡ï¼šæ’ä»¶åº”ç”¨é¡¹ç›®åœ¨ uTools å¼€å‘è€…å·¥å…·ä¸­æ¥å…¥å¼€å‘æ‰“å¼€çš„
:::

### ç±»å‹å®šä¹‰

```ts
function isDev(): boolean;
```

### ç¤ºä¾‹ä»£ç 

```js
if (utools.isDev()) {
  console.log("æ’ä»¶åº”ç”¨å¼€å‘ç¯å¢ƒ");
}
```

## `utools.isMacOS()`

åˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦æ˜¯ macOS

### ç±»å‹å®šä¹‰

```ts
function isMacOS(): boolean;
```

### ç¤ºä¾‹ä»£ç 

```js
if (utools.isMacOS()) {
  console.log("å½“å‰ç³»ç»Ÿæ˜¯ macOS");
}
```

## `utools.isWindows()`

åˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦æ˜¯ Windows

### ç±»å‹å®šä¹‰

```ts
function isWindows(): boolean;
```

### ç¤ºä¾‹ä»£ç 

```js
if (utools.isWindows()) {
  console.log("å½“å‰ç³»ç»Ÿæ˜¯ Windows");
}
```

## `utools.isLinux()`

åˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦æ˜¯ Linux

### ç±»å‹å®šä¹‰

```ts
function isLinux(): boolean;
```

### ç¤ºä¾‹ä»£ç 

```js
if (utools.isLinux()) {
  console.log("å½“å‰ç³»ç»Ÿæ˜¯ Linux");
}
```


# å±å¹•

æä¾›ä¸€äº›é’ˆå¯¹ç”¨æˆ·å±å¹•çš„æ“ä½œ

## `utools.screenColorPick(callback)`

å±å¹•å–è‰²ï¼Œå¼¹å‡ºä¸€ä¸ªå–è‰²å™¨ï¼Œç”¨æˆ·å–å®Œè‰²æ‰§è¡Œå›è°ƒå‡½æ•°

### ç±»å‹å®šä¹‰

```ts
function screenColorPick(callback: (colors: { hex: string; rgb: string }) => void): void;
```

- `callback`: é¢œè‰²é€‰æ‹©åçš„å›è°ƒå‡½æ•°
  - `colors`: é¢œè‰²å¯¹è±¡
    - `hex`: åå…­è¿›åˆ¶é¢œè‰²å€¼
    - `rgb`: RGB é¢œè‰²å€¼

### ç¤ºä¾‹ä»£ç 

```js
// å–è‰²
utools.screenColorPick((colors) => {
  const { hex, rgb } = colors;
  console.log(hex, rgb);
});
```

## `utools.screenCapture(callback)`

å±å¹•æˆªå›¾ï¼Œä¼šè¿›å…¥æˆªå›¾æ¨¡å¼ï¼Œç”¨æˆ·æˆªå›¾å®Œæ‰§è¡Œå›è°ƒå‡½æ•°

### ç±»å‹å®šä¹‰

```ts
function screenCapture(callback: (image: string) => void): void;
```
- `callback`: æˆªå›¾å®Œçš„å›è°ƒå‡½æ•°
  - `image` æˆªå›¾çš„å›¾åƒ base64 Data Url

### ç¤ºä¾‹ä»£ç 

```js
// æˆªå›¾å®Œå°†å›¾ç‰‡å‘é€åˆ°ã€ŒOCR æ–‡å­—è¯†åˆ«ã€å†è·³è½¬åˆ°è¿›è¡Œç¿»è¯‘
utools.screenCapture((image) => {
  utools.redirect(['OCR æ–‡å­—è¯†åˆ«', 'æ–‡å­—è¯†åˆ«+ç¿»è¯‘'], image)
});
```

## `utools.getPrimaryDisplay()`

è·å–ä¸»æ˜¾ç¤ºå™¨

### ç±»å‹å®šä¹‰

```ts
function getPrimaryDisplay(): Display;
```

::: tip æç¤º
åœ¨ä¸‹åˆ—è·å–å±å¹•å¯¹è±¡æ—¶ï¼Œ`Display` ç±»å‹å®šä¹‰è§ [Display](https://www.electronjs.org/docs/api/screen#screengetprimarydisplay)
:::

### ç¤ºä¾‹ä»£ç 

```js
const display = utools.getPrimaryDisplay();
console.log(display);
```

## `utools.getAllDisplays()`

è·å–æ‰€æœ‰æ˜¾ç¤ºå™¨

### ç±»å‹å®šä¹‰

```ts
function getAllDisplays(): Display[];
```

### ç¤ºä¾‹ä»£ç 

```js
const displays = utools.getAllDisplays();
console.log(displays);
```

## `utools.getCursorScreenPoint()`

è·å–é¼ æ ‡å½“å‰ä½ç½®ï¼Œä¸ºé¼ æ ‡åœ¨ç³»ç»Ÿä¸­çš„ç»å¯¹ä½ç½®

### ç±»å‹å®šä¹‰

```ts
function getCursorScreenPoint(): { x: number; y: number };
```

### ç¤ºä¾‹ä»£ç 

```js
const { x, y } = utools.getCursorScreenPoint();
console.log(x, y);
```

## `utools.getDisplayNearestPoint(point)`

è·å–ç‚¹ä½ç½®æ‰€åœ¨çš„æ˜¾ç¤ºå™¨

### ç±»å‹å®šä¹‰

```ts
function getDisplayNearestPoint(point: { x: number; y: number }): Display;
```

- `point` åŒ…å« x å’Œ y çš„ä½ç½®å¯¹è±¡

### ç¤ºä¾‹ä»£ç 

```js
const display = utools.getDisplayNearestPoint({ x: 100, y: 100 });
console.log(display);
```

## `utools.getDisplayMatching(rect)`

è·å–çŸ©å½¢æ‰€åœ¨çš„æ˜¾ç¤ºå™¨

### ç±»å‹å®šä¹‰

```ts
function getDisplayMatching(rect: { x: number; y: number; width: number; height: number; }): Display;
```

- `rect` çŸ©å½¢å¯¹è±¡

### ç¤ºä¾‹ä»£ç 

```js
const display = utools.getDisplayMatching({
  x: 100,
  y: 100,
  width: 200,
  height: 200,
});
console.log(display);
```

## `utools.screenToDipPoint(point)`

å±å¹•ç‰©ç†åæ ‡è½¬ DIP åæ ‡

### ç±»å‹å®šä¹‰

```ts
function screenToDipPoint(point: { x: number; y: number }): { x: number; y: number; };
```

- `point` åŒ…å« x å’Œ y çš„ä½ç½®å¯¹è±¡

### ç¤ºä¾‹ä»£ç 

```js
const dipPoint = utools.screenToDipPoint({ x: 200, y: 200 });
console.log(dipPoint);
```

## `utools.dipToScreenPoint(point)`

å±å¹• DIP åæ ‡è½¬ç‰©ç†åæ ‡

### ç±»å‹å®šä¹‰

```ts
function dipToScreenPoint(point: { x: number; y: number }): { x: number; y: number;};
```

- `point` åŒ…å« x å’Œ y çš„ä½ç½®å¯¹è±¡

### ç¤ºä¾‹ä»£ç 

```js
const screenPoint = utools.dipToScreenPoint({ x: 200, y: 200 });
console.log(screenPoint);
```

## `utools.screenToDipRect(rect)`

å±å¹•ç‰©ç†åŒºåŸŸè½¬ DIP åŒºåŸŸ

### ç±»å‹å®šä¹‰

```ts
function screenToDipRect(rect: { x: number; y: number; width: number; height: number; }): { x: number; y: number; width: number; height: number; };
```

- `rect` çŸ©å½¢å¯¹è±¡

### ç¤ºä¾‹ä»£ç 

```js
const dipRect = utools.screenToDipRect({ x: 0, y: 0, width: 200, height: 200 });
console.log(dipRect);
```

## `utools.dipToScreenRect(rect)`

DIP åŒºåŸŸè½¬å±å¹•ç‰©ç†åŒºåŸŸ

### ç±»å‹å®šä¹‰

```ts
function dipToScreenRect(rect: { x: number; y: number; width: number; height: number; }): { x: number; y: number; width: number; height: number; };
```

- `rect` çŸ©å½¢å¯¹è±¡

### ç¤ºä¾‹ä»£ç 

```js
const rect = utools.dipToScreenRect({ x: 0, y: 0, width: 200, height: 200 });
console.log(rect);
```

## `utools.desktopCaptureSources(options)`

è·å–æ¡Œé¢å½•å±æº

### ç±»å‹å®šä¹‰

```ts
function desktopCaptureSources(options: DesktopCaptureSourcesOptions): Promise<DesktopCaptureSource[]>;
```

- `options` ç”¨æ³•è¯·å‚è€ƒ[utools.desktopCaptureSources](https://docs.autocode.com/utools/api/desktopCaptureSources.html)

### ç¤ºä¾‹ä»£ç 

```js
(async () => {
  const ousrces = await utools.desktopCaptureSources({
    types: ["window", "screen"],
  });
  const stream = await navigator.mediaDevices.getUserMedia({
    audio: false,
    video: {
      mandatory: {
        chromeMediaSource: "desktop",
        chromeMediaSourceId: ousrces[0].id,
        minWidth: 1280,
        maxWidth: 1280,
        minHeight: 720,
        maxHeight: 720,
      },
    },
  });
  const video = document.querySelector("video");
  video.srcObject = stream;
  video.onloadedmetadata = (e) => video.play();
})();
```


# ç”¨æˆ·

é€šè¿‡ç”¨æˆ·æ¥å£ï¼Œå¯ä»¥è·å–åˆ°ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€ä¸´æ—¶ token ç­‰ã€‚

## `utools.getUser()`

è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤´åƒã€æ˜µç§°ç­‰ã€‚

### ç±»å‹å®šä¹‰

```ts
function getUser(): UserInfo | null;
```

- `getUser` ç™»å½•æ—¶è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼Œæœªç™»å½•æ—¶è¿”å› `null`

::: details `UserInfo` ç±»å‹å®šä¹‰

```ts
interface UserInfo {
  avatar: string;
  nickname: string;
  type: "member" | "user";
}
```

#### å­—æ®µè¯´æ˜

- `avatar`
  - ç”¨æˆ·å¤´åƒ
- `nickname`
  - ç”¨æˆ·æ˜µç§°
- `type`
  - ç”¨æˆ·ç±»å‹ï¼Œmember: ä¼šå‘˜ç”¨æˆ·, user: æ™®é€šç”¨æˆ·

:::

### ç¤ºä¾‹ä»£ç 

```js
const user = utools.getUser();
if (user) {
  console.log(user);
}
```

## `utools.fetchUserServerTemporaryToken()`

è·å–ç”¨æˆ·æœåŠ¡ç«¯ä¸´æ—¶ä»¤ç‰Œã€‚

### ç±»å‹å®šä¹‰

```ts
function fetchUserServerTemporaryToken(): Promise<TempToken>;
```

::: details `TempToken` ç±»å‹å®šä¹‰

```ts
interface TempToken {
  token: string;
  expire_at: number;
}
```

#### å­—æ®µè¯´æ˜

- `token`
  - ä¸´æ—¶ä»¤ç‰Œ
- `expire_at`
  - ä»¤ç‰Œè¿‡æœŸæ—¶é—´æˆ³

:::

### ç¤ºä¾‹ä»£ç 

```js
const { token, expire_at } = await utools.fetchUserServerTemporaryToken();
console.log(token);
console.log(expire_at);
```


# åŠ¨æ€æŒ‡ä»¤

å¾ˆå¤šæ—¶å€™ï¼Œæ’ä»¶åº”ç”¨ä¸­ä¼šæä¾›ä¸€äº›åŠŸèƒ½ä¾›ç”¨æˆ·è¿›è¡Œä¸ªæ€§åŒ–è®¾ç½®ï¼ˆä¾‹å¦‚ï¼šç½‘é¡µå¿«å¼€æ’ä»¶åº”ç”¨ï¼‰ï¼Œè¿™éƒ¨åˆ†é…ç½®æ— æ³•åœ¨ `plugin.json` äº‹å…ˆå®šä¹‰å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬æä¾›äº†ä»¥ä¸‹æ–¹æ³•å¯¹æ’ä»¶åº”ç”¨åŠŸèƒ½è¿›è¡ŒåŠ¨æ€å¢å‡ã€‚

## `utools.getFeatures([codes])`

è·å–æ’ä»¶åº”ç”¨åŠ¨æ€åˆ›å»ºçš„åŠŸèƒ½ã€‚

### ç±»å‹å®šä¹‰

```ts
function getFeatures(codes?: string[]): Feature[];
```

- `codes` è¦è·å–çš„åŠŸèƒ½ç¼–ç é›†åˆ

::: details `Feature` ç±»å‹å®šä¹‰ {#def-feature}

```ts
interface Feature {
  code: string;
  explain?: string;
  icon?: string;
  platform?: string | string[];
  mainHide?: boolean,
  mainPush?: boolean,
  cmds: Cmd[];
}
```

#### å­—æ®µè¯´æ˜

- `code` 
  - åŠŸèƒ½ç¼–ç ï¼Œè¿›å…¥æ’ä»¶åº”ç”¨ä¼šå°†è¯¥ç¼–ç å¸¦å…¥ï¼Œæ ¹æ®ä¸åŒç¼–ç å®ç°åŠŸèƒ½åŒºåˆ†æ‰§è¡Œã€‚ï¼ˆå¯å‚è€ƒ plugin.json ä¸­ feature.codeï¼‰
- `explain`
  - åŠŸèƒ½æè¿°ï¼ˆå¯å‚è€ƒ plugin.json ä¸­ feature.explainï¼‰
- `icon`
  - åŠŸèƒ½å›¾æ ‡ï¼ˆå¯å‚è€ƒ plugin.json ä¸­ feature.iconï¼‰
- `platform`
  - æŒ‡å®šåŠŸèƒ½å¯ç”¨å¹³å°ï¼ˆå¯å‚è€ƒ plugin.json ä¸­ feature.platformï¼‰
- `mainHide`
  - è‹¥é…ç½®ä¸º`true`ï¼Œæ‰“å¼€æ­¤åŠŸèƒ½ä¸ä¸»åŠ¨æ˜¾ç¤ºæœç´¢æ¡†ã€‚ï¼ˆå¯å‚è€ƒ plugin.json ä¸­ feature.mainHideï¼‰
- `mainPush`
  - æ˜¯å¦å‘æœç´¢æ¡†æ¨é€å†…å®¹ã€‚ï¼ˆå¯å‚è€ƒ plugin.json ä¸­ feature.mainPushï¼‰
- `cmds`
  - æŒ‡ä»¤é›†åˆï¼ˆå¯å‚è€ƒ plugin.json ä¸­ feature.cmdsï¼‰

:::

### ç¤ºä¾‹ä»£ç 

```js
// è·å–æ‰€æœ‰åŠ¨æ€åŠŸèƒ½
const features = utools.getFeatures();
console.log(features);
// è·å–ç‰¹å®š code
const features = utools.getFeatures(["code-1", "code-2"]);
console.log(features);
```

## `utools.setFeature(feature)`

ä¸ºæœ¬æ’ä»¶åº”ç”¨åŠ¨æ€æ–°å¢æŸä¸ªåŠŸèƒ½ã€‚

### ç±»å‹å®šä¹‰

```ts
function setFeature(feature: Feature): void;
```

- `feature` ç±»å‹å‚è€ƒ [`Feature` ç±»å‹å®šä¹‰](#def-feature)

### ç¤ºä¾‹ä»£ç 

```js
utools.setFeature({
  code: Date.now().toString(),
  explain: "æµ‹è¯•åŠ¨æ€åŠŸèƒ½",
  // "icon": "res/xxx.png",
  // "icon": "data:image/png;base64,xxx...",
  // "platform": ["win32", "darwin", "linux"]
  cmds: ["æµ‹è¯•"],
});
```

## `utools.removeFeature(code)`

åŠ¨æ€åˆ é™¤æœ¬æ’ä»¶åº”ç”¨çš„æŸä¸ªåŠŸèƒ½ã€‚

### ç±»å‹å®šä¹‰

```ts
function removeFeature(code: string): Boolean;
```

- `code` è¦åˆ é™¤çš„åŠŸèƒ½ç¼–ç 

### ç¤ºä¾‹ä»£ç 

```js
utools.removeFeature("code");
```




# æ¨¡æ‹ŸæŒ‰é”®

æ¨¡æ‹Ÿç”¨æˆ·çš„é”®ç›˜ä¸é¼ æ ‡æ“ä½œã€‚

## `utools.simulateKeyboardTap(key[, ...modifiers])`

æ¨¡æ‹Ÿé”®ç›˜æŒ‰é”®

### ç±»å‹å®šä¹‰

```ts
function simulateKeyboardTap(key: string, ...modifiers: string[]): void;
```

- `key`: è¦æ¨¡æ‹Ÿçš„æŒ‰é”®
- `modifiers`: è¦æ¨¡æ‹Ÿçš„ä¿®é¥°é”®ï¼Œä¸€èˆ¬ä¸º `shift`ã€`ctrl`ã€`alt`ã€`meta`

### ç¤ºä¾‹ä»£ç 

```js
// æ¨¡æ‹Ÿé”®ç›˜æ•²å‡» Enter
utools.simulateKeyboardTap("enter");
// windows linux æ¨¡æ‹Ÿç²˜è´´
utools.simulateKeyboardTap("v", "ctrl");
// macOS æ¨¡æ‹Ÿç²˜è´´
utools.simulateKeyboardTap("v", "command");
// æ¨¡æ‹Ÿ Ctrl + Alt + A
utools.simulateKeyboardTap("a", "ctrl", "alt");
```

## `utools.simulateMouseMove(x, y)`

æ¨¡æ‹Ÿé¼ æ ‡ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®

### ç±»å‹å®šä¹‰

```ts
function simulateMouseMove(x: number, y: number): void;
```

- `x` è·ç¦»å±å¹•å·¦ä¾§çš„ä½ç½®(åƒç´ )
- `y` è·ç¦»å±å¹•é¡¶éƒ¨çš„ä½ç½®(åƒç´ )

### ç¤ºä¾‹ä»£ç 

```js
// å°†é¼ æ ‡ç§»åŠ¨åˆ°å±å¹•å·¦ä¸Šè§’
utools.simulateMouseMove(50, 50);
```

## `utools.simulateMouseClick(x, y)`

æ¨¡æ‹Ÿé¼ æ ‡å·¦é”®ç‚¹å‡»

### ç±»å‹å®šä¹‰

```ts
function simulateMouseClick(x: number, y: number): void;
```

- `x` è·ç¦»å±å¹•å·¦ä¾§çš„ä½ç½®(åƒç´ )
- `y` è·ç¦»å±å¹•é¡¶éƒ¨çš„ä½ç½®(åƒç´ )

### ç¤ºä¾‹ä»£ç 

```js
// åœ¨å±å¹•è·ç¦»å·¦ä¾§ 100 åƒç´ é¡¶éƒ¨ 100 åƒç´ çš„ä½ç½®ç‚¹å‡»
utools.simulateMouseClick(100, 100);
```

## `utools.simulateMouseDoubleClick(x, y)`

æ¨¡æ‹Ÿé¼ æ ‡å·¦é”®åŒå‡»

### ç±»å‹å®šä¹‰

```ts
function simulateMouseDoubleClick(x: number, y: number): void;
```

- `x` è·ç¦»å±å¹•å·¦ä¾§çš„ä½ç½®(åƒç´ )
- `y` è·ç¦»å±å¹•é¡¶éƒ¨çš„ä½ç½®(åƒç´ )

### ç¤ºä¾‹ä»£ç 

```js
// åœ¨å±å¹•è·ç¦»å·¦ä¾§ 100 åƒç´ é¡¶éƒ¨ 100 åƒç´ çš„ä½ç½®åŒå‡»
utools.simulateMouseDoubleClick(100, 100);
```

## `utools.simulateMouseRightClick(x, y)`

æ¨¡æ‹Ÿé¼ æ ‡å³é”®ç‚¹å‡»

### ç±»å‹å®šä¹‰

```ts
function simulateMouseRightClick(x: number, y: number): void;
```

- `x` è·ç¦»å±å¹•å·¦ä¾§çš„ä½ç½®(åƒç´ )
- `y` è·ç¦»å±å¹•é¡¶éƒ¨çš„ä½ç½®(åƒç´ )

### ç¤ºä¾‹ä»£ç 

```js
// åœ¨å±å¹•è·ç¦»å·¦ä¾§ 100 åƒç´ é¡¶éƒ¨ 100 åƒç´ çš„ä½ç½®å³å‡»
utools.simulateMouseRightClick(100, 100);
```


# AI

è°ƒç”¨ AI èƒ½åŠ›ï¼Œæ”¯æŒ **Function Calling**

## `utools.ai(option[, streamCallback])`

è°ƒç”¨ AI

### ç±»å‹å®šä¹‰

::: code-group

```ts [æµå¼è°ƒç”¨]
function ai(
  option: AiOption,
  streamCallback: (chunk: Message) => void
): PromiseLike<void>; // ç‰ˆæœ¬ï¼š>=7.0.0
```

```ts [éæµå¼è°ƒç”¨]
function ai(option: AiOption): PromiseLike<Message>; // ç‰ˆæœ¬ï¼š>=7.0.0
```

:::

- `option`: Ai é€‰é¡¹
- `streamCallback`: æµå¼è°ƒç”¨å‡½æ•° (å¯é€‰)
- è¿”å›å®šåˆ¶çš„ `PromiseLike`

::: details `AiOption` ç±»å‹å®šä¹‰

```ts
interface AiOption {
  model?: string;
  messages: Message[];
  tools?: Tool[];
}
```

#### AiOption å­—æ®µè¯´æ˜

- `model`
  - AI æ¨¡å‹, ä¸ºç©ºé»˜è®¤ä½¿ç”¨ _deepseek-v3_
- `messages`
  - æ¶ˆæ¯åˆ—è¡¨
- `tools`
  - å·¥å…·åˆ—è¡¨

:::

::: details `Message` ç±»å‹å®šä¹‰

```ts
interface Message {
  role: "system" | "user" | "assistant";
  content?: string;
  reasoning_content?: string;
}
```

#### Message å­—æ®µè¯´æ˜

- `role`
  - æ¶ˆæ¯è§’è‰²
    - `system`ï¼šç³»ç»Ÿæ¶ˆæ¯
    - `user`ï¼šç”¨æˆ·æ¶ˆæ¯
    - `assistant`ï¼šAI æ¶ˆæ¯
- `content`
  - æ¶ˆæ¯å†…å®¹
- `reasoning_content`
  - æ¶ˆæ¯æ¨ç†å†…å®¹ï¼Œä¸€èˆ¬åªæœ‰æ¨ç†æ¨¡å‹ä¼šè¿”å›

:::

::: details `Tool` ç±»å‹å®šä¹‰

```ts
interface Tool {
  type: "function";
  function?: {
    name: string;
    description: string;
    parameters: {
      type: "object";
      properties: Record<string, any>;
    };
    required?: string[];
  };
}
```

#### Tool å­—æ®µè¯´æ˜

- `type`
  - å·¥å…·ç±»å‹
    - `function`ï¼šå‡½æ•°å·¥å…·
- `function`
  - å‡½æ•°å·¥å…·é…ç½®
    - `name`ï¼šå‡½æ•°åç§°
    - `description`ï¼šå‡½æ•°æè¿°
    - `parameters`ï¼šå‡½æ•°å‚æ•°
      - `type`ï¼šå‚æ•°ç±»å‹
      - `properties`ï¼šå‚æ•°å±æ€§
    - `required`ï¼šå¿…å¡«å‚æ•°

:::

::: warning `PromiseLike` ç±»å‹å®šä¹‰

`PromiseLike` æ˜¯ `Promise` çš„æ‰©å±•ç±»å‹ï¼ŒåŒ…å« `abort()` å‡½æ•°

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥å•çº¯æŠŠå®ƒå½“ä½œ `Promise` æ¥ä½¿ç”¨ï¼Œä½†æ˜¯æ‰©å±•äº† `abort()` å‡½æ•°ï¼Œå¯ä»¥è®©ä½ åœ¨è°ƒç”¨ AI è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œ `abort()` ä¸­æ­¢è°ƒç”¨ã€‚

```ts
interface PromiseLike<T> extends Promise<T> {
  abort(): void;
}
```

#### PromiseLike å­—æ®µè¯´æ˜

- `abort()`
  - ä¸­æ­¢ AI è°ƒç”¨

:::

### ç¤ºä¾‹ä»£ç 

---

#### AI å¯¹è¯

::: code-group

```js [æµå¼è°ƒç”¨]
const messages = [
  {
    role: "system",
    content:
      "ä½ æ˜¯ä¸€ä¸ªè‹±æ–‡ç¿»è¯‘ä¸“å®¶ï¼Œå°†ç”¨æˆ·çš„ä»»ä½•å†…å®¹éƒ½ç¿»è¯‘æˆè‹±æ–‡ï¼Œç¿»è¯‘ç»“æœè¦ç¬¦åˆè‹±æ–‡è¯­è¨€ä¹ æƒ¯",
  },
  {
    role: "user",
    content: "uTools æ˜¯ä¸€ç§é«˜æ•ˆå·¥ä½œæ–¹å¼",
  },
];

await utools.ai({ messages }, (chunk) => {
  console.log(chunk);
});
```

```js [éæµå¼è°ƒç”¨]
const messages = [
  {
    role: "system",
    content:
      "ä½ æ˜¯ä¸€ä¸ªè‹±æ–‡ç¿»è¯‘ä¸“å®¶ï¼Œå°†ç”¨æˆ·çš„ä»»ä½•å†…å®¹éƒ½ç¿»è¯‘æˆè‹±æ–‡ï¼Œç¿»è¯‘ç»“æœè¦ç¬¦åˆè‹±æ–‡è¯­è¨€ä¹ æƒ¯",
  },
  {
    role: "user",
    content: "uTools æ˜¯ä¸€ç§é«˜æ•ˆå·¥ä½œæ–¹å¼",
  },
];

const result = await utools.ai({ messages });
console.log(result.content);
```

:::

---

#### Function Calling è°ƒç”¨

::: warning

**Function Calling** åŠŸèƒ½è°ƒç”¨çš„å‡½æ•°**å¿…é¡»**æŒ‚åˆ° `window` å¯¹è±¡ä¸Šï¼Œä¾‹å¦‚ï¼š`window.getSystemInfo`
:::

::: code-group

```js [App.jsx]
const messages = [
  {
    role: "user",
    content: "æˆ‘ç”µè„‘çš„ CPU æ˜¯ä»€ä¹ˆï¼Œå†…å­˜å¤šå¤§",
  },
];
const tools = [
  {
    type: "function",
    function: {
      name: "getSystemInfo",
      description: "è·å–ç”¨æˆ·çš„ç”µè„‘ä¿¡æ¯",
      parameters: {
        type: "object",
        properties: {},
      },
    },
  },
];

// æµå¼è°ƒç”¨
await utools.ai({ messages, tools }, (delta) => {
  console.log(delta);
});
// éæµå¼è°ƒç”¨
const result = await utools.ai({ messages, tools });
console.log(result.content);
```

```js [preload.js]
window.getSystemInfo = () => {
  const os = require("node:os");
  return {
    // æ“ä½œç³»ç»Ÿä¿¡æ¯
    platform: os.platform(), // å¹³å°
    type: os.type(), // æ“ä½œç³»ç»Ÿç±»å‹
    release: os.release(), // æ“ä½œç³»ç»Ÿç‰ˆæœ¬
    arch: os.arch(), // CPU æ¶æ„
    // CPU ä¿¡æ¯
    cpus: os.cpus(), // CPU æ ¸å¿ƒä¿¡æ¯
    cpuCount: os.cpus().length, // CPU æ ¸å¿ƒæ•°
    // å†…å­˜ä¿¡æ¯
    totalMemory: (os.totalmem() / (1024 * 1024)).toFixed(2) + " MB", // æ€»å†…å­˜
    freeMemory: (os.freemem() / (1024 * 1024)).toFixed(2) + " MB", // ç©ºé—²å†…å­˜
    // ç³»ç»Ÿè¿è¡Œæ—¶é—´
    uptime: (os.uptime() / 3600).toFixed(2) + " å°æ—¶", // ç³»ç»Ÿè¿è¡Œæ—¶é—´
    // ç”¨æˆ·ä¿¡æ¯
    homedir: os.homedir(), // ç”¨æˆ·ä¸»ç›®å½•
    userInfo: os.userInfo(), // å½“å‰ç”¨æˆ·ä¿¡æ¯
    // ç½‘ç»œä¿¡æ¯
    networkInterfaces: os.networkInterfaces(), // ç½‘ç»œæ¥å£ä¿¡æ¯
    // ç³»ç»Ÿè´Ÿè½½
    loadavg: os.loadavg(), // ç³»ç»Ÿè´Ÿè½½
    // ç³»ç»Ÿæ—¶é—´
    currentTime: new Date().toLocaleString(), // å½“å‰ç³»ç»Ÿæ—¶é—´
    // å…¶ä»–ä¿¡æ¯
    hostname: os.hostname(), // ä¸»æœºå
    tempDir: os.tmpdir(), // ä¸´æ—¶ç›®å½•
  };
};
```

:::

## `utools.allAiModels()`

è·å–æ‰€æœ‰ AI æ¨¡å‹

### ç±»å‹å®šä¹‰

```ts
function allAiModels(): Promise<AiModel[]>; // ç‰ˆæœ¬ï¼š>=7.0.0
```

- åœ¨ `Promise` å†…è¿”å› `AiModel` æ•°ç»„

### AiModel ç±»å‹å®šä¹‰

::: details `AiModel` ç±»å‹å®šä¹‰

```ts
interface AiModel {
  id: string;
  label: string;
  description: string;
  icon: string;
  cost: number;
}
```

#### AiModel å­—æ®µè¯´æ˜

- `id`
  - AI æ¨¡å‹ IDï¼Œç”¨äº `utools.ai` è°ƒç”¨çš„ `model` å‚æ•°
- `label`
  - AI æ¨¡å‹åç§°
- `description`
  - AI æ¨¡å‹æè¿°
- `icon`
  - AI æ¨¡å‹å›¾æ ‡
- `cost`
  - AI æ¨¡å‹è°ƒç”¨æ¶ˆè€—

:::

### ç¤ºä¾‹ä»£ç 

```js
const models = await utools.allAiModels();
console.log(models);
```


# FFmpeg

[FFmpeg](https://ffmpeg.org) æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„å¼€æºéŸ³è§†é¢‘å¤„ç†å·¥å…·ï¼Œå°†å…¶ä»¥ç‹¬ç«‹æ‰©å±•çš„æ–¹å¼é›†æˆåˆ° uToolsã€‚(é¦–æ¬¡è°ƒç”¨ FFmpeg ä¼šå¼•å¯¼ç”¨æˆ·ä¸‹è½½é›†æˆ)

## `utools.runFFmpeg(args[, onProgress])`

è¿è¡Œ FFmpeg (é¦–æ¬¡è°ƒç”¨å°†å¼•å¯¼ç”¨æˆ·ä¸‹è½½é›†æˆ)

### ç±»å‹å®šä¹‰

```ts
function runFFmpeg(args: string[], onProgress?: (progress: RunProgress) => void): PromiseLike<void>; // ç‰ˆæœ¬ï¼š>=6.1.0
```

- `args`: ffmpeg è¿è¡Œå‚æ•°(æ•°ç»„)
- `onProgress`: å¤„ç†è¿›åº¦ä¸­çš„å›è°ƒå‡½æ•°
- è¿”å› Promise

::: warning `PromiseLike` ç±»å‹å®šä¹‰

`PromiseLike` æ˜¯ `Promise` çš„æ‰©å±•ç±»å‹ï¼ŒåŒ…å« `kill()` å’Œ `quit()` å‡½æ•°

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥å•çº¯æŠŠå®ƒå½“ä½œ `Promise` æ¥ä½¿ç”¨ï¼Œä½†æ˜¯æ‰©å±•äº† `kill()` å’Œ `quit()` å‡½æ•°ï¼Œå¯ä»¥è®©ä½ åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¼ºåˆ¶ç»“æŸ FFmpeg è¿è¡Œï¼Œæˆ–è€…é€šçŸ¥ FFmpeg é€€å‡ºã€‚

```ts
interface PromiseLike extends Promise<void> {
  kill(): void;
  quit(): void;
}
```

#### PromiseLike å­—æ®µè¯´æ˜

- `kill()`
  - å¼ºåˆ¶ç»“æŸ FFmpeg è¿è¡Œ
- `quit()`
  - é€šçŸ¥ FFmpeg é€€å‡ºï¼Œç±»ä¼¼å‘½ä»¤è¡Œä¸‹æŒ‰ q é”®

:::

::: details `RunProgress` ç±»å‹å®šä¹‰

```ts
interface RunProgress {
  bitrate: string;
  fps: number;
  frame: number;
  percent?: number;
  q: number | string;
  size: string;
  speed: string;
  time: string;
}
```

#### RunProgress å­—æ®µè¯´æ˜

- `bitrate`
  - è§†é¢‘æˆ–éŸ³é¢‘çš„æ¯”ç‰¹ç‡ï¼Œè¡¨ç¤ºæ¯ç§’ä¼ è¾“çš„æ¯”ç‰¹æ•°
- `fps`
  - å½“å‰å¤„ç†çš„è§†é¢‘å¸§ç‡ï¼Œæ¯ç§’å¤„ç†çš„å¸§æ•°
- `frame`
  - å·²å¤„ç†çš„å¸§æ•°
- `percent`
  - å¤„ç†å®Œæˆç™¾åˆ†æ¯”
- `q`
  - è´¨é‡æŒ‡æ ‡
- `size`
  - å·²å¤„ç†è¾“å‡ºçš„æ–‡ä»¶å¤§å°
- `speed`
  - å½“å‰çš„å¤„ç†é€Ÿåº¦
- `time`
  - å‰å·²å¤„ç†çš„æ—¶é—´

:::

### ç¤ºä¾‹ä»£ç 

```js
// è§†é¢‘å‹ç¼©
utools.runFFmpeg(
  ["-i", "/path/to/input.mp4", "-c:v", "libx264", "-tag:v", "avc1-movflags", "faststart", "-crf", "30", "-preset", "superfast", "pathto/output.mp4"],
  (progress) => {
    console.log("å‹ç¼©ä¸­ " + progress.percent + "%");
  }
).then(() => {
  console.log("å‹ç¼©å®Œæˆ");
}).catch((error) => {
  console.log("å‡ºé”™äº†ï¼š" + error.message);
});
```

```js
// è§†é¢‘è½¬ GIF
const run = utools.runFFmpeg(
  [ "-i", "/path/to/input.mp4", "-filter_complex", "[0]fps=15,split[v0][v1];[v0]palettegen=stats_mode=full[p];[v1][p]paletteuse", "/path/to/output.gif" ],
  () => {
    console.log("è½¬æ¢ä¸­ " + progress.percent + "%");
  }
);
run.then(() => {
  console.log("è½¬æ¢å®Œæˆ");
}).catch((error) => {
  console.log("å‡ºé”™äº†ï¼š" + error.message);
});

// å¯æ‰§è¡Œ run.kill() å¼ºåˆ¶ç»“æŸè½¬æ¢
```

```js
// éŸ³é¢‘æå–
utools.runFFmpeg(["-i", "/path/to/input.mp4", "-q:a", "0", "-map", "a", "/path/to/output.mp3"]).then(() => {
  console.log("æå–å®Œæˆ");
}).catch((error) => {
  console.log("å‡ºé”™äº†ï¼š" + error.message);
});
```

```js
// Windows å½•å±
const run = utools.runFFmpeg(['-f', 'gdigrab', '-framerate', '30', '-i', 'desktop', '/path/to/output.mp4'])

// macOS å½•å±
const run = utools.runFFmpeg(['-f', 'avfoundation', '-framerate', '30', '-i', 'default', '/path/to/output.mp4'])

// Linux å½•å±
const run = utools.runFFmpeg(['-f', 'x11grab', '-framerate', '30', '-i', ':0.0', '/path/to/output.mp4'])

setTimeout(() => {
  //æ‰§è¡Œ run.quit() ç»“æŸå½•å±
  run.quit()
}, 10000)

```

```js
// Windows æˆªå±
utools.runFFmpeg(['-f', 'gdigrab', '-i', 'desktop', '-vframes', '1', '/path/to/screenshot.png'])

// macOS æˆªå±
utools.runFFmpeg(['-f', 'avfoundation', '-i', 'default', '-vframes', '1', '/path/to/screenshot.png'])

// Linux æˆªå±
utools.runFFmpeg(['-f', 'x11grab', '-i', ':0.0', '-vframes', '1', '/path/to/screenshot.png'])

```


# æœ¬åœ°æ•°æ®åº“

uTools æä¾›äº†æœ¬åœ°æ•°æ®åº“çš„ APIï¼ŒåŸºäº nosql çš„è®¾è®¡ï¼Œé€šè¿‡å®ƒå¯ä»¥å®ç°ä¸€äº›ç®€å•çš„æ•°æ®å­˜å‚¨å’Œè¯»å–ã€‚
å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨ï¼Œæ•°æ®å­˜å‚¨åœ¨æœ¬åœ°è®¡ç®—æœºç³»ç»Ÿï¼Œå¦‚æœç”¨æˆ·å¼€å¯æ•°æ®åŒæ­¥ï¼Œå¯**å¤‡ä»½**åˆ° uTools æœåŠ¡ç«¯åŒæ—¶å¯åœ¨ç”¨æˆ·çš„å¤šä¸ªè®¾å¤‡é—´å®ç°**ç§’çº§åŒæ­¥**ã€‚
uTools çš„æ’ä»¶åº”ç”¨æ˜¯ä¸€ä¸ªè½»å‹çš„åº”ç”¨ç¨‹åºï¼Œåœ¨æ²¡æœ‰è¿œç«¯æœåŠ¡å™¨æä¾›æ•°æ®å­˜å‚¨ï¼Œæä¾›æœ¬åœ°æ•°æ®æŒä¹…åŒ–å­˜å‚¨è‡³å…³é‡è¦ã€‚

::: warning è­¦å‘Š
åœ¨å¤šä¸ªè®¾å¤‡ç¼–è¾‘åŒä¸€ä¸ªæ•°æ®åº“æ–‡æ¡£æ—¶ï¼Œå°†äº§ç”Ÿå†²çªï¼Œæ•°æ®åº“ä¼šç»Ÿä¸€é€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬ä½œä¸ºæœ€ç»ˆç‰ˆæœ¬ï¼Œä¸ºäº†å°½å¯èƒ½é¿å…å†²çªï¼Œåº”è¯¥å°†å†…å®¹åˆç†çš„åˆ†æ•£åœ¨å¤šä¸ªæ–‡æ¡£ï¼Œè€Œä¸æ˜¯éƒ½å­˜æ”¾åœ¨ä¸€ä¸ªæ•°æ®åº“æ–‡æ¡£ä¸­ã€‚
:::

## `utools.db.put(doc)` / `utools.db.promises.put(doc)`

åˆ›å»ºæˆ–æ›´æ–°æ•°æ®åº“æ–‡æ¡£ï¼Œæ–‡æ¡£å†…å®¹ä¸è¶…è¿‡ **1M**

### ç±»å‹å®šä¹‰

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
function put(doc: DbDoc): DbResult;
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
function put(doc: DbDoc): Promise<DbResult>;
```

:::

- `doc` æ–‡æ¡£å¯¹è±¡

::: details `DbDoc` ç±»å‹å®šä¹‰ {#def-dbdoc}

```ts
interface DbDoc {
  _id: string;
  _rev?: string;
  [key:string]: unknown
}
```

#### å­—æ®µè¯´æ˜

- `_id`
  - æ–‡æ¡£ IDï¼Œå¦‚æœ `_id` ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°æ–‡æ¡£ï¼Œå¦‚æœ `_id` å·²ç»å­˜åœ¨ï¼Œåˆ™æ›´æ–°æ–‡æ¡£ã€‚
- `_rev`
  - æ–‡æ¡£ç‰ˆæœ¬ï¼Œå¯¹æ–‡æ¡£æ›´æ–°æ—¶ï¼Œ`_rev` ä¸å¯çœç•¥ï¼Œå¦åˆ™å°†æ›´æ–°å¤±è´¥ã€‚

:::

::: details `DbResult` ç±»å‹å®šä¹‰ {#def-dbresult}

```ts
interface DbResult {
  id: string,
  rev?: string,
  ok?: boolean,
  error?: boolean,
  name?: string,
  message?: string
}
```

#### å­—æ®µè¯´æ˜

- `id`
  - æ–‡æ¡£ IDï¼Œå³æ–‡æ¡£å­—æ®µ `_id`ã€‚
- `rev`
  - æœ€æ–°æ–‡æ¡£ç‰ˆæœ¬
- `ok`
  - æ˜¯å¦æˆåŠŸ
- `error`
  - æ˜¯å¦é”™è¯¯
- `name`
  - é”™è¯¯åç§°
- `message`
  - é”™è¯¯åŸå› 
:::

### ç¤ºä¾‹ä»£ç 

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
// æ–°å»ºæ–‡æ¡£
const doc = {
  _id: "test/doc-1",
  a: "value 1",
  b: "value 2"
}
let result = utools.db.put(doc);
if (result.ok) {
  // ä¿å­˜æˆåŠŸ, æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬
  doc._rev = result.rev;
} else if (result.error) {
  // ä¿å­˜å‡ºé”™ï¼Œæ‰“å°é”™è¯¯åŸå› 
  console.log(result.message);
}

// ä¿®æ”¹æ–‡æ¡£
doc.a = "updated value 1";
doc.b = "updated value 2";
result = utools.db.put(doc);
if (result.ok) {
  // ä¿å­˜æˆåŠŸ, æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬
  doc._rev = result.rev;
} else if (result.error) {
  // ä¿å­˜å‡ºé”™ï¼Œæ‰“å°é”™è¯¯åŸå› 
  console.log(result.message);
}
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
// æ–°å»ºæ–‡æ¡£
const doc = {
  _id: "test/doc-1",
  a: "value 1",
  b: "value 2"
}
let result = await utools.db.promises.put(doc);
if (result.ok) {
  // ä¿å­˜æˆåŠŸ, æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬
  doc._rev = result.rev;
} else if (result.error) {
  // ä¿å­˜å‡ºé”™ï¼Œæ‰“å°é”™è¯¯åŸå› 
  console.log(result.message);
}

// ä¿®æ”¹æ–‡æ¡£
doc.a = "updated value 1";
doc.b = "updated value 2";
result = await utools.db.promises.put(doc);
if (result.ok) {
  // ä¿å­˜æˆåŠŸ, æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬
  doc._rev = result.rev;
} else if (result.error) {
  // ä¿å­˜å‡ºé”™ï¼Œæ‰“å°é”™è¯¯åŸå› 
  console.log(result.message);
}
```

:::

## `utools.db.get(id)` / `utools.db.promises.get(id)`

æ ¹æ®æ–‡æ¡£ ID `id` è·å–æ–‡æ¡£ï¼Œä¸å­˜åœ¨åˆ™è¿”å› null

### ç±»å‹å®šä¹‰

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
function get(id: string): DbDoc | null;
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
function get(id: string): Promise<DbDoc | null>;
```

:::

- `id` æ–‡æ¡£ ID
- DbDoc å‚è€ƒ [`DbDoc` ç±»å‹å®šä¹‰](#def-dbdoc)


### ç¤ºä¾‹ä»£ç 

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
// è·å–æ–‡æ¡£
const doc = utools.db.get("test/doc-1");
console.log(doc);
if (doc) {
  // ä¿®æ”¹æ–‡æ¡£
  doc.c = 123;
  result = utools.db.put(doc);
  if (result.ok) {
    // ä¿å­˜æˆåŠŸ, æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬
    doc._rev = result.rev;
  } else if (result.error) {
    // ä¿å­˜å‡ºé”™ï¼Œæ‰“å°é”™è¯¯åŸå› 
    console.log(result.message);
  }
}
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
// è·å–æ–‡æ¡£
const doc = await utools.db.promises.get("test/doc-1");
console.log(doc);
if (doc) {
  // ä¿®æ”¹æ–‡æ¡£
  doc.c = 123;
  result = await utools.db.promises.put(doc);
  if (result.ok) {
    // ä¿å­˜æˆåŠŸ, æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬
    doc._rev = result.rev;
  } else if (result.error) {
    // ä¿å­˜å‡ºé”™ï¼Œæ‰“å°é”™è¯¯åŸå› 
    console.log(result.message);
  }
}
```

:::

## `utools.db.remove(doc)` / `utools.db.promises.remove(doc)`

åˆ é™¤æ•°æ®åº“æ–‡æ¡£ï¼Œå¯ä»¥é€šè¿‡æ–‡æ¡£å¯¹è±¡æˆ–è€…æ–‡æ¡£ `id` åˆ é™¤

### ç±»å‹å®šä¹‰

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
function remove(doc: DbDoc): DbResult;
function remove(id: string): DbResult;
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
function remove(doc: DbDoc): Promise<DbResult>;
function remove(id: string): Promise<DbResult>;
```

:::

- `doc` æ–‡æ¡£å¯¹è±¡
- `id` æ–‡æ¡£ ID
- DBResult å‚è€ƒ [`DbResult` ç±»å‹å®šä¹‰](#def-dbresult)

### ç¤ºä¾‹ä»£ç 

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
// åˆ é™¤æ–‡æ¡£
const doc = utools.db.get("test/doc-1");
if (doc) {
  const result = utools.db.remove(doc);
  if (result.ok) {
    console.log("åˆ é™¤æˆåŠŸ");
  } else if (result.error) {
    // åˆ é™¤å¤±è´¥ï¼Œæ‰“å°é”™è¯¯åŸå› 
    console.log(result.message);
  }
}

// æ ¹æ®æ–‡æ¡£ ID åˆ é™¤æ–‡æ¡£
const result = utools.db.remove("test/doc-1");
if (result.ok) {
  console.log("åˆ é™¤æˆåŠŸ");
} else if (result.error) {
  // åˆ é™¤å¤±è´¥ï¼Œæ‰“å°é”™è¯¯åŸå› 
  console.log(result.message);
}
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
// åˆ é™¤æ–‡æ¡£
const doc = await utools.db.promises.get("test/doc-1");
if (doc) {
  const result = await utools.db.promises.remove(doc);
  if (result.ok) {
    console.log("åˆ é™¤æˆåŠŸ");
  } else if (result.error) {
    // åˆ é™¤å¤±è´¥ï¼Œæ‰“å°é”™è¯¯åŸå› 
    console.log(result.message);
  }
}

// æ ¹æ®æ–‡æ¡£ ID åˆ é™¤æ–‡æ¡£
const result = await utools.db.promises.remove("test/doc-1");
if (result.ok) {
  console.log("åˆ é™¤æˆåŠŸ");
} else if (result.error) {
  // åˆ é™¤å¤±è´¥ï¼Œæ‰“å°é”™è¯¯åŸå› 
  console.log(result.message);
}
```

:::

## `utools.db.bulkDocs(docs)` / `utools.db.promises.bulkDocs(docs)`

æ‰¹é‡åˆ›å»ºæˆ–æ›´æ–°æ•°æ®åº“æ–‡æ¡£

### ç±»å‹å®šä¹‰

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
function bulkDocs(docs: DbDoc[]): DbResult[];
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
function bulkDocs(docs: DbDoc[]): Promise<DbResult[]>;
```

:::

- `docs` æ–‡æ¡£å¯¹è±¡æ•°æ®
- DbDoc å‚è€ƒ [`DbDoc` ç±»å‹å®šä¹‰](#def-DbDoc)
- DbResult å‚è€ƒ [`DbResult` ç±»å‹å®šä¹‰](#def-dbresult)

### ç¤ºä¾‹ä»£ç 

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
// æ‰¹é‡åˆ›å»ºæ–‡æ¡£
const docs = [
  { _id: "test/doc-2", a: "a 2222222", b: "b 2222222" },
  { _id: "test/doc-3", b: "a 3333333", b: "b 3333333" }
];
const results = utools.db.bulkDocs(docs);
results.forEach(ret => {
  // æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬
  if (ret.ok) {
    docs.find(x => x._id === ret.id)?._rev = ret.rev;
  }
})
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
// æ‰¹é‡åˆ›å»ºæ–‡æ¡£
const docs = [
  { _id: "test/doc-2", a: "a 2222222", b: "b 2222222" },
  { _id: "test/doc-3", b: "a 3333333", b: "b 3333333" }
];
const results = await utools.db.promises.bulkDocs(docs);
results.forEach(ret => {
  // æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬
  if (ret.ok) {
    docs.find(x => x._id === ret.id)?._rev = ret.rev;
  }
})
```

:::

## `utools.db.allDocs([idStartsWith])` / `utools.db.promises.allDocs([idStartsWith])`

ç­›é€‰è·å–æ’ä»¶åº”ç”¨æ–‡æ¡£æ•°ç»„ï¼Œå‚æ•°ä¸ºå­—ç¬¦ä¸²åˆ™åŒ¹é…æ–‡æ¡£ ID å‰ç¼€æ¥è¿‡æ»¤ã€‚å‚æ•°ä¸ºæ•°ç»„åˆ™æŸ¥æ‰¾æ•°ç»„å†… id å¯¹åº”çš„æ–‡æ¡£ã€‚ä¸ä¼ å‚æ•°åˆ™è¿”å›æ‰€æœ‰æ–‡æ¡£ã€‚

### ç±»å‹å®šä¹‰

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
function allDocs(idStartsWith?: string): DbDoc[];
function allDocs(ids: string[]): DbDoc[];
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
function allDocs(idStartsWith?: string): Promise<DbDoc[]>;
function allDocs(ids: string[]): Promise<DbDoc[]>;
```

:::

- `idStartsWith` æ–‡æ¡£ ID å‰ç¼€
- `ids` æ–‡æ¡£ ID æ•°ç»„
- `DbDoc` å‚è€ƒ [`DbDoc` ç±»å‹å®šä¹‰](#def-dbdoc)

### ç¤ºä¾‹ä»£ç 

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
// è·å–æ‰€æœ‰ id ä»¥ "test/" ä½œä¸ºå‰ç¼€çš„æ–‡æ¡£
const docs1 = utools.db.allDocs("test/");
// æ ¹æ® id æ•°ç»„è·å–å¯¹åº”æ–‡æ¡£æ•°ç»„
const docs2 = utools.db.allDocs(["test/doc-2", "test/doc-3"]);
// è·å–æ’ä»¶åº”ç”¨æ‰€æœ‰æ–‡æ¡£
const docs3 = utools.db.allDocs();
console.log(docs1, docs2, docs3)
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
// è·å–æ‰€æœ‰ id ä»¥ "test/" ä½œä¸ºå‰ç¼€çš„æ–‡æ¡£
const docs1 = await utools.db.promises.allDocs("test/");
// æ ¹æ® id æ•°ç»„è·å–å¯¹åº”æ–‡æ¡£æ•°ç»„
const docs2 = await utools.db.promises.allDocs(["test/doc-2", "test/doc-3"]);
// è·å–æ’ä»¶åº”ç”¨æ‰€æœ‰æ–‡æ¡£
const docs3 = await utools.db.promises.allDocs();
console.log(docs1, docs2, docs3)
```

:::

## `utools.db.postAttachment(id, attachment, type)` / `utools.db.promises.postAttachment(id, attachment, type)`

å­˜å‚¨é™„ä»¶åˆ°æ–°æ–‡æ¡£ï¼Œé™„ä»¶åªèƒ½è¢«åˆ›å»ºä¸èƒ½è¢«æ›´æ–°ï¼Œåˆ›å»ºçš„é™„ä»¶æœ€å¤§ä¸è¶…è¿‡ 10M

### ç±»å‹å®šä¹‰

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
function postAttachment(id: string, attachment: Buffer | Uint8Array, type: string): DbResult;
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
function postAttachment(id: string, attachment: Buffer | Uint8Array, type: string): Promise<DbResult>;
```

:::

- `id` æ–‡æ¡£ ID
- `attachment` é™„ä»¶ Buffer
- `type` ä¸ºé™„ä»¶ç±»å‹ï¼Œå‚è€ƒ [mime/type](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types)ï¼Œæ¯”å¦‚ `image/png`ã€`text/plain` ã€‚
- `DbResult` å‚è€ƒ [`DbResult` ç±»å‹å®šä¹‰](#def-dbresult)


### ç¤ºä¾‹ä»£ç 

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
const fileBuffer = fs.readFileSync("/path/to/test.png");
const result = utools.db.postAttachment("test-image-file", fileBuffer, "image/png");
if (result.ok) {
  console.log("é™„ä»¶å­˜å‚¨æˆåŠŸ");
} else if (result.error) {
  // å­˜å‚¨å¤±è´¥ï¼Œæ‰“å°é”™è¯¯åŸå› 
  console.log(result.message);
}
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
const fileBuffer = fs.promises.readFile("/path/to/test.png");
const result = await utools.db.promises.postAttachment("test-image-file", fileBuffer, "image/png");
if (result.ok) {
  console.log("é™„ä»¶å­˜å‚¨æˆåŠŸ");
} else if (result.error) {
  // å­˜å‚¨å¤±è´¥ï¼Œæ‰“å°é”™è¯¯åŸå› 
  console.log(result.message);
}
```

:::

## `utools.db.getAttachment(id)` / `utools.db.promises.getAttachment(id)`

è·å–é™„ä»¶ï¼Œä¸å­˜åœ¨è¿”å› null

### ç±»å‹å®šä¹‰

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
function getAttachment(id: string): Uint8Array;
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
function getAttachment(id: string): Promise<Uint8Array>;
```
:::

- `id` é™„ä»¶æ–‡æ¡£ ID

### ç¤ºä¾‹ä»£ç 

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
const buf = utools.db.getAttachment("test-image-file");
if (buf) {
  fs.writeFileSync(utools.getPath('downloads') + "/test.png", buf);
}
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
const buf = await utools.db.promises.getAttachment("test-image-file");
if (buf) {
  await fs.promises.writeFile(utools.getPath('downloads') + "/test.png", buf);
}
```

:::

## `utools.db.getAttachmentType(id)` / `utools.db.promises.getAttachmentType(id)`

è·å–é™„ä»¶ç±»å‹

### ç±»å‹å®šä¹‰

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
function getAttachmentType(id: string): string;
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
function getAttachmentType(id: string): Promise<string>;
```

:::

- `id` é™„ä»¶æ–‡æ¡£ ID

### ç¤ºä¾‹ä»£ç 

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
const type = utools.db.getAttachmentType("test-image-file");
console.log("é™„ä»¶ç±»å‹ä¸º", type);
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
const type = await utools.db.promises.getAttachmentType("test-image-file");
console.log("é™„ä»¶ç±»å‹ä¸º", type);
```

:::

## `utools.db.replicateStateFromCloud()` / `utools.db.promises.replicateStateFromCloud()` {#db-sync}

äº‘ç«¯åŒæ­¥æ•°æ®åˆ°æœ¬åœ°çš„çŠ¶æ€ï¼Œè¯¥ API æ˜¯è§£å†³åœ¨æŸäº›ç¯å¢ƒä¸‹éœ€è¦åˆ¤æ–­æ•°æ®æ˜¯å¦ä»äº‘ç«¯å¤åˆ¶å®Œæˆã€‚

### ç±»å‹å®šä¹‰

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
function replicateStateFromCloud(): State;
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
function replicateStateFromCloud(): Promise<State>;
```

:::

::: details `State` ç±»å‹å®šä¹‰

```ts
type State = null | 0 | 1;
```

- `null`: æœªå¼€å¯æ•°æ®åŒæ­¥
- `0`: å·²å®ŒæˆåŒæ­¥
- `1`: åŒæ­¥ä¸­

:::

### ç¤ºä¾‹ä»£ç 

::: code-group

```ts [åŒæ­¥ç‰ˆæœ¬]
const state = utools.db.replicateStateFromCloud();
if (state === 1) {
  console.log("æ•°æ®ä»äº‘ç«¯æ‹‰å–åŒæ­¥ä¸­...");
} else {
  console.log("æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥å®Œæˆ");
}
```

```ts [å¼‚æ­¥ç‰ˆæœ¬]
const state = await utools.db.promises.replicateStateFromCloud();
if (state === 1) {
  console.log("æ•°æ®ä»äº‘ç«¯æ‹‰å–åŒæ­¥ä¸­...");
} else {
  console.log("æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥å®Œæˆ");
}
```

:::


# dbStorage

dbStorage æ˜¯åŸºäº [æœ¬åœ°æ•°æ®åº“](./local-db.md) åŸºç¡€ä¸Šï¼Œå°è£…çš„ä¸€å¥—ç±»ä¼¼ [LocalStorage](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage) çš„ APIï¼Œé€šè¿‡é”®å€¼å¯¹å½¢å¼å­˜å‚¨æ•°æ®ï¼Œå¯ä»¥å¿«é€Ÿå­˜å–æ•°æ®ã€‚

## `utools.dbStorage.setItem(key, value)`

å­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹æ•°æ®ï¼Œè‹¥é”®å·²å­˜åœ¨ï¼Œåˆ™è¦†ç›–å®ƒçš„å€¼ã€‚

### ç±»å‹å®šä¹‰

```ts
function setItem(key: string, value: any): void;
```

- `key` é”®å€¼
- `value` å€¼

### ç¤ºä¾‹ä»£ç 

```js
utools.dbStorage.setItem("key", "value");
```

## `utools.dbStorage.getItem(key)`

è·å–ä¸€ä¸ªé”®å€¼å¯¹æ•°æ®ã€‚

### ç±»å‹å®šä¹‰

```ts
function getItem(key: string): any;
```

- `key` é”®å€¼

### ç¤ºä¾‹ä»£ç 

```js
const value = utools.dbStorage.getItem("key");
console.log(value);
```

## `utools.dbStorage.removeItem(key)`

åˆ é™¤ä¸€ä¸ªé”®å€¼å¯¹æ•°æ®ã€‚

### ç±»å‹å®šä¹‰

```ts
function removeItem(key: string): void;
```

- `key` é”®å€¼

### ç¤ºä¾‹ä»£ç 

```js
utools.dbStorage.removeItem("key");
```


# dbCryptoStorage

dbCryptoStorage æ˜¯åŸºäº [æœ¬åœ°æ•°æ®åº“](./local-db.md) åŸºç¡€ä¸Šï¼Œå°è£…çš„ä¸€å¥—ç±»ä¼¼ [LocalStorage](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage) çš„ APIï¼Œé€šè¿‡é”®å€¼å¯¹å½¢å¼åŠ å¯†å­˜å‚¨æ•°æ®ã€‚

## `utools.dbCryptoStorage.setItem(key, value)`

å­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹æ•°æ®ï¼Œè‹¥é”®å·²å­˜åœ¨ï¼Œåˆ™è¦†ç›–å®ƒçš„å€¼ã€‚

### ç±»å‹å®šä¹‰

```ts
function setItem(key: string, value: any): void;
```

- `key` é”®å€¼
- `value` è¦åŠ å¯†å­˜å‚¨çš„å€¼

### ç¤ºä¾‹ä»£ç 

```js
utools.dbCryptoStorage.setItem("key", "value will encrypt");
```

## `utools.dbCryptoStorage.getItem(key)`

è·å–ä¸€ä¸ªé”®å€¼å¯¹æ•°æ®ã€‚

### ç±»å‹å®šä¹‰

```ts
function getItem(key: string): any;
```

- `key` é”®å€¼

### ç¤ºä¾‹ä»£ç 

```js
const value = utools.dbCryptoStorage.getItem("key");
console.log(value);
```

## `utools.dbCryptoStorage.removeItem(key)`

åˆ é™¤ä¸€ä¸ªé”®å€¼å¯¹æ•°æ®ã€‚

### ç±»å‹å®šä¹‰

```ts
function removeItem(key: string): void;
```

- `key` é”®å€¼

### ç¤ºä¾‹ä»£ç 

```js
utools.dbCryptoStorage.removeItem("key");
```


# å¯ç¼–ç¨‹æµè§ˆå™¨

uTools browser ç®€ç§° ubrowserï¼Œæ˜¯æ ¹æ® uTools çš„ç‰¹æ€§ï¼Œé‡èº«æ‰“é€ çš„ä¸€ä¸ªå¯ç¼–ç¨‹æµè§ˆå™¨ã€‚åˆ©ç”¨ ubrowser å¯ä»¥è½»è€Œæ˜“ä¸¾è¿æ¥ä¸€åˆ‡äº’è”ç½‘æœåŠ¡ï¼Œä¸”ä¸ uTools å®Œç¾ç»“åˆã€‚

::: tip å°æŠ€å·§
ubrowser æ‹¥æœ‰ä¼˜é›…çš„é“¾å¼è°ƒç”¨æ¥å£ï¼Œå¯ä»¥ç”¨å£è¯­åŒ–çš„æ•°è¡Œä»£ç ï¼Œå®ç°ä¸€ç³»åˆ—åŒªå¤·æ‰€æ€çš„æ“ä½œã€‚ä¾‹å¦‚ï¼š

1. RPA è‡ªåŠ¨åŒ–
2. ç½‘é¡µå†…å®¹é­”æ”¹
3. ç½‘é¡µå†…å®¹æŠ“å–

:::

### `ubrowser.goto(url[, headers][, timeout])`

æ‰“å¼€ä¸€ä¸ª ubrowser çª—å£ï¼Œå¹¶è·³è½¬åˆ°æŒ‡å®šç½‘é¡µ

#### ç±»å‹å®šä¹‰

```ts
function goto(
  url: string,
  headers?: Record<string, string>,
  timeout?: number
): UBrowser;
```

- `url`: è¦è·³è½¬çš„ç½‘é¡µåœ°å€
- `headers`: è¯·æ±‚å¤´
- `timeout`: è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’

### `ubrowser.useragent(ua)`

è®¾ç½®ç”¨æˆ·ä»£ç†ï¼ˆUser-Agentï¼‰

#### ç±»å‹å®šä¹‰

```ts
function useragent(ua: string): UBrowser;
```

- `ua`: User-Agent å­—ç¬¦ä¸²

### `ubrowser.viewport(width, height)`

è®¾ç½®æµè§ˆå™¨è§†çª—å¤§å°

#### ç±»å‹å®šä¹‰

```ts
function viewport(width: number, height: number): UBrowser;
```

- `width`: è§†çª—å®½åº¦
- `height`: è§†çª—é«˜åº¦

### `ubrowser.hide()`

éšè— ubrowser çª—å£

#### ç±»å‹å®šä¹‰

```ts
function hide(): UBrowser;
```

### `ubrowser.show()`

æ˜¾ç¤º ubrowser çª—å£

#### ç±»å‹å®šä¹‰

```ts
function show(): UBrowser;
```

## ç½‘é¡µæ“ä½œ

ubrowser æ”¯æŒç½‘é¡µå†…å®¹é­”æ”¹ï¼Œå³åœ¨ç½‘é¡µåŠ è½½å‰å¯¹ç½‘é¡µå†…å®¹è¿›è¡Œä¿®æ”¹ï¼Œä¾‹å¦‚æ·»åŠ è‡ªå®šä¹‰ CSSã€JavaScript ç­‰ã€‚

### `ubrowser.css(css)`

æ·»åŠ è‡ªå®šä¹‰ CSS

#### ç±»å‹å®šä¹‰

```ts
function css(css: string): UBrowser;
```

- `css`: è‡ªå®šä¹‰ CSS

### `ubrowser.evaluate(func[, params])`

åœ¨ç½‘é¡µä¸­æ‰§è¡Œè‡ªå®šä¹‰ JS ä»£ç 

#### ç±»å‹å®šä¹‰

```ts
function evaluate(func: Function, params?: any[]): UBrowser;
```

- `func`: ç½‘é¡µå†…æ‰§è¡Œçš„ JS å‡½æ•°ï¼Œå‡½æ•°è‹¥æœ‰è¿”å›å€¼ï¼Œåˆ™ä¼šåœ¨ `run` Promise ç»“æœè¿”å›
- `params`: ä¼ é€’ç»™`func`çš„å‚æ•°

### `ubrowser.press(key[, modifiers])`

æ¨¡æ‹Ÿé”®ç›˜æŒ‰é”®

#### ç±»å‹å®šä¹‰

```ts
function press(key: string, ...modifiers: string[]): UBrowser;
```

- `key`: è¦æ¨¡æ‹Ÿçš„æŒ‰é”®
- `modifiers`: è¦æ¨¡æ‹Ÿçš„ä¿®é¥°é”®ï¼Œä¸€èˆ¬ä¸º `shift`ã€`ctrl`ã€`alt`ã€`meta`

### `ubrowser.click(selector)`

æ‰§è¡Œç‚¹å‡»æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function click(selector: string): UBrowser;
```

- `selector`: CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨

### `ubrowser.mousedown(selector)`

æ‰§è¡Œé¼ æ ‡æŒ‰ä¸‹æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function mousedown(selector: string): UBrowser;
```

- `selector`: CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨

### `ubrowser.mouseup(selector)`

æ‰§è¡Œé¼ æ ‡æŠ¬èµ·æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function mouseup(selector: string): UBrowser;
```

- `selector`: CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨

### `ubrowser.file(selector, payload)`

å¯¹ç½‘é¡µä¸­çš„ input å…ƒç´ è®¾ç½®æ–‡ä»¶

#### ç±»å‹å®šä¹‰

```ts
function file(selector: string, payload: string | string[] | Buffer): UBrowser;
```

- `selector` å…ƒç´ å¿…é¡»æ˜¯å¯é€‰æ‹©æ–‡ä»¶çš„è¾“å…¥å…ƒç´  `input[type=file]`
- `payload` å¯ä»¥æ˜¯æ–‡ä»¶è·¯å¾„ã€æ–‡ä»¶è·¯å¾„é›†åˆä»¥åŠæ–‡ä»¶ Buffer

### `ubrowser.value(selector, payload)`

å¯¹ç½‘é¡µä¸­çš„ input å…ƒç´ è®¾ç½®å€¼

#### ç±»å‹å®šä¹‰

```ts
function value(selector: string, payload: string): UBrowser;
```

- `selector` å¿…é¡»æ˜¯ `input`ã€`textarea`ã€`select` å…ƒç´ ï¼Œä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨
- `payload` å°†ä¼šè®¾ç½®åˆ° `value` å±æ€§ä¸Š

### `ubrowser.check(selector, checked)`

æ‰§è¡Œå‹¾é€‰æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function check(selector: string, checked: boolean): UBrowser;
```

- `selector` å¿…é¡»æ˜¯ `checkbox`ã€`radio` å…ƒç´ ï¼Œä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨
- `checked` ä¸º `true` æ—¶ï¼Œå‹¾é€‰ï¼Œå¦åˆ™å–æ¶ˆå‹¾é€‰

### `ubrowser.focus(selector)`

æ‰§è¡Œèšç„¦æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function focus(selector: string): UBrowser;
```

- `selector`: CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨

### `ubrowser.scroll(selector)`

æ‰§è¡Œæ»šåŠ¨æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function scroll(selector: string): UBrowser;
function scroll(y: number): UBrowser;
function scroll(x: number, y: number): UBrowser;
```

- `selector` ä¸º `string` æ—¶ï¼Œæ»šåŠ¨åˆ°æŒ‡å®šå…ƒç´ , ä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨
- `selector` ä¸º `number` æ—¶ï¼Œåªæœ‰ä¸€ä¸ªå‚æ•°è¡¨ç¤º y è½´ï¼Œæ»šåŠ¨åˆ°çºµå‘æŒ‡å®šä½ç½®ã€‚ä¸¤ä¸ªå‚æ•°åˆ™è¡¨ç¤º x è½´ã€‚
- ä¼ é€’ `x` å’Œ `y`ï¼Œæ»šåŠ¨åˆ°æŒ‡å®šä½ç½®

### `ubrowser.download(url[, savePath])`

æ‰§è¡Œä¸‹è½½æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function download(url: string, savePath?: string): UBrowser;
function download(
  func: (...params: any[]) => string,
  savePath: string | null,
  ...params: any[]
): UBrowser;
```

- `url` å¾…ä¸‹è½½çš„èµ„æº URL
- `savePath` æŒ‡å®šä¸‹è½½è·¯å¾„ï¼Œä¸ä¼ åˆ™ä¸‹è½½åˆ°é»˜è®¤è·¯å¾„
- `func` ç½‘é¡µå†…æ‰§è¡Œçš„ JS å‡½æ•°, å‡½æ•°å¯è¿”å›èµ„æº URLï¼Œå†æ ¹æ®è¿”å› URL ä¸‹è½½èµ„æº
- `params` ä¼ é€’ç»™ `func` çš„å‚æ•°

### `ubrowser.paste(text)`

å…ˆå¤åˆ¶å†æ‰§è¡Œç²˜è´´æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function paste(text: string): UBrowser;
```

- `text`: è¦ç²˜è´´çš„å†…å®¹ï¼Œæ”¯æŒæ™®é€šæ–‡æœ¬è·Ÿå›¾åƒ Base64 Data URL

### `ubrowser.screenshot(target[, savePath])`

å¯¹ç½‘é¡µè¿›è¡Œæˆªå±å¹¶ä¿æŒåˆ°æŒ‡å®šè·¯å¾„ï¼Œå°†ä¼šä¿å­˜æˆä¸º png æ ¼å¼

#### ç±»å‹å®šä¹‰

```ts
function screenshot(target?: string | Rect, savePath?: string): UBrowser;
```

- æ²¡æœ‰å‚æ•°æ—¶ï¼Œæ•´ä¸ªç½‘é¡µçª—å£æˆªå±
- å½“ `target` ä¸º `string` æ—¶ï¼Œ`target` ä¸ºé€‰æ‹©å™¨ã€‚å¯ä»¥ä¼ å…¥ä¸€ä¸ª `Rect` å¯¹è±¡ï¼Œè¡¨ç¤ºæˆªå–æŒ‡å®šåŒºåŸŸã€‚
- `savePath` ä¿å­˜è·¯å¾„ï¼Œæ²¡æœ‰ä¼ é€’ `savePath` çš„æ—¶ï¼Œé»˜è®¤å­˜å‚¨åœ¨ä¸´æ—¶ç›®å½•ã€‚

::: details `Rect` ç±»å‹å®šä¹‰

```ts
interface Rect {
  x: number;
  y: number;
  width: number;
  height: number;
}
```

:::

### `ubrowser.markdown([selector])`

å°†å½“å‰ç½‘é¡µå†…å®¹è½¬æ¢ä¸º markdown

#### ç±»å‹å®šä¹‰

```ts
function markdown(selector?: string): UBrowser;
```

- `selector`: å¯é€‰ï¼ŒæŒ‡å®šè¦è½¬æ¢çš„å…ƒç´ ï¼Œä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨ï¼Œä¸ä¼ é€’åˆ™è½¬æ¢æ•´ä¸ªç½‘é¡µå†…å®¹

### `ubrowser.pdf(options[, savePath])`

å°†ç½‘é¡µä¿å­˜ä¸º PDF

#### ç±»å‹å®šä¹‰

```ts
function pdf(options: PdfOptions, savePath?: string): UBrowser;
```

- `PdfOptions` å‚è€ƒ [Electron `PrintToPDFOptions`](https://www.electronjs.org/docs/latest/api/web-contents#contentsprinttopdfoptions)
  >
- `savePath` ä¿å­˜è·¯å¾„ï¼Œæ²¡æœ‰ä¼ é€’ `savePath` çš„æ—¶ï¼Œé»˜è®¤å­˜å‚¨åœ¨ä¸´æ—¶ç›®å½•ã€‚

### `ubrowser.device(options)`

æ¨¡æ‹Ÿç§»åŠ¨è®¾å¤‡

#### ç±»å‹å®šä¹‰

```ts
function device(options: DeviceOptions): UBrowser;
```

- `options` æ¨¡æ‹Ÿè®¾å¤‡ä¿¡æ¯

::: details `DeviceOptions` ç±»å‹å®šä¹‰

```ts
interface DeviceOptions {
  userAgent: string;
  size: {
    width: number;
    height: number;
  };
}
```

:::

### `ubrowser.wait(ms)`

æ‰§è¡Œç­‰å¾…æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
// ç­‰å¾…æ—¶é—´
function wait(ms: number): this;
// ç­‰å¾…å…ƒç´ å‡ºç°
function wait(selector: string, timeout?: number): this;
// ç­‰å¾…å‡½æ•°è¿”å› true
function wait(
  func: (...params: any[]) => boolean,
  timeout?: number,
  ...params: any[]
): this;
```

- `ms` ç­‰å¾…æŒ‡å®šæ¯«ç§’æ•°
- `selector` ç­‰å¾…å…ƒç´ å‡ºç°ï¼Œä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨
- `timeout` ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 60000 ms (60 ç§’)
- `func` ç½‘é¡µå†…æ‰§è¡Œçš„ JS å‡½æ•°, è¿”å› `true` ç­‰å¾…ç»“æŸ
- `params` ä¼ é€’ç»™ `func` çš„å‚æ•°

### `ubrowser.when(selector)`

æ¡ä»¶åˆ¤æ–­

#### ç±»å‹å®šä¹‰

```ts
// åˆ¤æ–­å­˜åœ¨å…ƒç´ 
function when(selector: string): UBrowser;
// åˆ¤æ–­å‡½æ•°ç»“æœ
function when(func: (...params: any[]) => boolean, ...params: any[]): UBrowser;
```

- `selector` åˆ¤æ–­æ˜¯å¦å­˜åœ¨å…ƒç´ ï¼Œä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨
- `func` ç½‘é¡µå†…æ‰§è¡Œçš„ JS å‡½æ•°, åˆ¤æ–­å‡½æ•°è¿”å›çš„ç»“æœ
- `params` ä¼ é€’ç»™ `func` çš„å‚æ•°

### `ubrowser.end()`

ç»“æŸä¸Šä¸€ä¸ª `when`

#### ç±»å‹å®šä¹‰

```ts
function end(): UBrowser;
```

### `ubrowser.devTools([mode])`

æ‰“å¼€ ubrowser å¼€å‘è€…å·¥å…·ã€‚

#### ç±»å‹å®šä¹‰

```ts
function devTools(mode?: string): void;
```

- `mode`: å¯é€‰å€¼ 'right' | 'bottom' | 'undocked' | 'detach' ï¼Œé»˜è®¤ 'detach'

### `ubrowser.cookies([name])`

è·å– ubrowser cookie

#### ç±»å‹å®šä¹‰

```ts
// åœ¨å½“å‰ url æ ¹æ®åç§°è·å– cookie, ä¸ºç©ºè·å–å½“å‰ url å…¨éƒ¨ cookie
function cookies(name?: string): UBrowser;
// æ ¹æ®æ¡ä»¶è·å– Cookie
function cookies(filter: CookieFilter): UBrowser;
```

- `name` cookie åç§°
- `filter` è¿‡æ»¤å¯¹è±¡

::: details `CookieFilter` ç±»å‹å®šä¹‰

```ts
interface CookieFilter {
  url?: string;
  name?: string;
  domain?: string;
  path?: string;
  secure?: boolean;
  session?: boolean;
  httpOnly?: boolean;
}
```

- `url` æ£€ç´¢ä¸ url ç›¸å…³çš„ cookieã€‚ ç©ºæ„å‘³ç€æ£€ç´¢æ‰€æœ‰ URL çš„ cookie ã€‚
- `name` æŒ‰åç§°ç­›é€‰ cookieã€‚
- `domain` æ£€ç´¢ä¸åŸŸåæˆ–è€… domain å­åŸŸååŒ¹é…çš„ cookieã€‚
- `path` æ£€ç´¢è·¯å¾„ä¸ path åŒ¹é…çš„ cookieã€‚
- `secure` é€šè¿‡å…¶ Secure å±æ€§ç­›é€‰ cookieã€‚
- `session` ç­›é€‰å‡º session å†…å¯ç”¨æˆ–æŒä¹…æ€§ cookieã€‚
- `httpOnly` é€šè¿‡å…¶ httpOnly å±æ€§ç­›é€‰ cookieã€‚

:::

### `ubrowser.setCookies`

è®¾ç½® ubrowser çš„ cookie

#### ç±»å‹å®šä¹‰

```ts
function setCookies(name: string, value: string): UBrowser;
function setCookies(cookies: { name: string; value: string }[]): UBrowser;
```

- `name` cookie åç§°
- `value` cookie å€¼
- `cookies` cookie åç§°å’Œå€¼å¯¹è±¡çš„é›†åˆ

### `ubrowser.removeCookies(name)`

åˆ é™¤ ubrowser çš„ cookie

#### ç±»å‹å®šä¹‰

```ts
function removeCookies(name: string): UBrowser;
```

- `name` cookie åç§°

### `ubrowser.clearCookies([url])`

æ¸…ç©º ubrowser çš„ cookie ä¿¡æ¯ã€‚

#### ç±»å‹å®šä¹‰

```ts
function clearCookies(url?: string): UBrowser;
```

- `url`: æ ¹æ® url æ¸…é™¤ cookieï¼Œ`clearCookies` åœ¨ `goto` å‡½æ•°ä¹‹å‰è°ƒç”¨æ—¶ `url` ä¸èƒ½ä¸ºç©ºã€‚åœ¨ `goto` ä¹‹åè°ƒç”¨åˆ™æ¸…ç©ºå½“å‰ url çš„ cookie

### `ubrowser.run()`

å¼€å§‹è¿è¡Œ ubrowser å®ä¾‹ï¼Œå¹¶è¿”å›æ‰§è¡Œç»“æœ

#### ç±»å‹å®šä¹‰

```ts
function run(
  ubrowserId?: number,
  options?: UBrowserOptions
): Promise<[...any, UBrowserInstance]>;
```

- `ubrowserId` ä¸€èˆ¬ä»¥ä¸‹ä¸¤ç§å½¢å¼è·å–ï¼š
  - `ubrowser.run` è¿”å›çš„ `UBrowserInstance` çš„ `id` å±æ€§ï¼ˆubrowser çª—å£ä»åœ¨æ˜¾ç¤ºæ—¶ï¼‰ã€‚
  - [`utools.getIdleUBrowser`](./manage.md#utools-getidleubrowsers) è¿”å›çš„ `UBrowserInstance` çš„ `id` å±æ€§ã€‚
- `run` è¿”å›å°†ä¼šè¿”å›ä¸€ä¸ªåŒ…å«æ•°ç»„çš„ Promise å¯¹è±¡ï¼Œæ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ æ˜¯å½“å‰æœªå…³é—­çª—å£çš„ UBrowser å®ä¾‹ï¼Œå…¶ä½™çš„å…ƒç´ åˆ™æ˜¯è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»– ubrowser æ–¹æ³•çš„è¿”å›å€¼ï¼Œæ¯”å¦‚`evaluate`ã€`cookies`ç­‰ã€‚

::: details `UBrowserOptions` ç±»å‹å®šä¹‰

```ts
interface UBrowserOptions {
  show?: boolean;
  width?: number;
  height?: number;
  x?: number;
  y?: number;
  center?: boolean;
  minWidth?: number;
  minHeight?: number;
  maxWidth?: number;
  maxHeight?: number;
  resizable?: boolean;
  movable?: boolean;
  minimizable?: boolean;
  maximizable?: boolean;
  alwaysOnTop?: boolean;
  fullscreen?: boolean;
  fullscreenable?: boolean;
  enableLargerThanScreen?: boolean;
  opacity?: number;
  frame?: boolean;
  closable?: boolean;
  focusable?: boolean;
  skipTaskbar?: boolean;
  backgroundColor?: string;
  hasShadow?: boolean;
  transparent?: boolean;
  titleBarStyle?: string;
  thickFrame?: boolean;
}
```

- `show`: æ˜¯å¦æ˜¾ç¤ºæµè§ˆå™¨çª—å£
- `width`: æµè§ˆå™¨çª—å£å®½åº¦ï¼Œé»˜è®¤`800`
- `height`: æµè§ˆå™¨çª—å£é«˜åº¦ï¼Œé»˜è®¤`600`
- `x`: æµè§ˆå™¨çª—å£ä½ç½® x åæ ‡
- `y`: æµè§ˆå™¨çª—å£ä½ç½® y åæ ‡
- `center`: æµè§ˆå™¨çª—å£æ˜¯å¦å±…ä¸­
- `minWidth`: æµè§ˆå™¨çª—å£æœ€å°å®½åº¦ï¼Œé»˜è®¤`0`
- `minHeight`: æµè§ˆå™¨çª—å£æœ€å°é«˜åº¦ï¼Œé»˜è®¤`0`
- `maxWidth`: æµè§ˆå™¨çª—å£æœ€å¤§å®½åº¦ï¼Œé»˜è®¤æ— é™åˆ¶
- `maxHeight`: æµè§ˆå™¨çª—å£æœ€å¤§é«˜åº¦ï¼Œé»˜è®¤æ— é™åˆ¶
- `resizable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯ç¼©æ”¾ï¼Œé»˜è®¤`true`
- `movable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯ç§»åŠ¨ï¼Œé»˜è®¤`true`
- `minimizable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯æœ€å°åŒ–ï¼Œé»˜è®¤`true`
- `maximizable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯æœ€å¤§åŒ–ï¼Œé»˜è®¤`true`
- `alwaysOnTop`: æµè§ˆå™¨çª—å£æ˜¯å¦ç½®é¡¶ï¼Œé»˜è®¤`false`
- `fullscreen`: æµè§ˆå™¨çª—å£æ˜¯å¦å…¨å±ï¼Œé»˜è®¤`false`
- `fullscreenable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯å…¨å±ï¼Œé»˜è®¤`true`
- `enableLargerThanScreen`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯è¶…å‡ºå±å¹•ï¼Œé»˜è®¤`false`ï¼Œä»…åœ¨ macOS ä¸‹ç”Ÿæ•ˆ
- `opacity`: æµè§ˆå™¨çª—å£é€æ˜åº¦ï¼Œé»˜è®¤`1`ï¼Œæ”¯æŒ`0`-`1`ä¹‹é—´çš„å€¼ï¼Œä»…åœ¨ macOS è·Ÿ Windows ä¸‹ç”Ÿæ•ˆ
- `frame`: æµè§ˆå™¨çª—å£æ˜¯å¦æœ‰è¾¹æ¡†ï¼Œé»˜è®¤`true`
- `closable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯å…³é—­ï¼Œé»˜è®¤`true`
- `focusable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯èšç„¦ï¼Œé»˜è®¤`true`
- `skipTaskbar`: æµè§ˆå™¨çª—å£æ˜¯å¦è·³è¿‡ä»»åŠ¡æ ï¼Œé»˜è®¤`false`
- `backgroundColor`: æµè§ˆå™¨çª—å£èƒŒæ™¯é¢œè‰²ï¼Œé»˜è®¤`#ffffff`
- `hasShadow`: æµè§ˆå™¨çª—å£æ˜¯å¦æœ‰é˜´å½±ï¼Œé»˜è®¤`false`
- `transparent`: æµè§ˆå™¨çª—å£æ˜¯å¦é€æ˜ï¼Œé»˜è®¤`false`
- `titleBarStyle`: æµè§ˆå™¨çª—å£æ ‡é¢˜æ æ ·å¼ï¼Œé»˜è®¤`default`ï¼Œå¯é€‰å€¼`hidden`ã€`hiddenInset`ã€`customButtonsOnHover`
- `thickFrame`: æµè§ˆå™¨çª—å£è¾¹æ¡†æ˜¯å¦åŠ ç²—ï¼Œé»˜è®¤`false`

:::

::: details `UBrowserInstance` ç±»å‹å®šä¹‰ {#ubrowser-instance}

```ts
interface UBrowserInstance {
  id: string;
  url: string;
  title: string;
  width: number;
  height: number;
  x: number;
  y: number;
}
```

:::

### ç¤ºä¾‹ä»£ç 

```js
const address = "ç¦å·çƒŸå°å±±";
// åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºåœ°å€ä½ç½®
utools.ubrowser
  // æ‰“å¼€ç™¾åº¦åœ°å›¾ç«™ç‚¹
  .goto("https://map.baidu.com")
  // ç­‰å¾…å‡ºç°æœç´¢æ¡†
  .wait("#sole-input")
  // æœç´¢æ¡†è·å¾—ç„¦ç‚¹
  .focus("#sole-input")
  // åœ°å€æœç´¢æ¡†è¾“å…¥åœ°å€
  .value("#sole-input", address)
  // ç­‰å¾… 300 æ¯«ç§’
  .wait(300)
  // æŒ‰ä¸‹å›è½¦
  .press("enter")
  // å¼€å§‹è¿è¡Œ
  .run({ width: 1200, height: 800 });
```

```js
const expressNo = "YT8933937901850";
// å¿«é€’ 100 æŸ¥è¯¢å¿«é€’å•å·
utools.ubrowser
  // æ‰“å¼€å¿«é€’ 100
  .goto("https://www.kuaidi100.com/")
  // ç­‰å¾…è¾“å…¥æ¡†
  .wait("#input")
  // æ»šåŠ¨åˆ°åˆé€‚ä½ç½®
  .scroll(0, 450)
  // è¾“å…¥å¿«é€’å•å·
  .value("#input", expressNo)
  // ç‚¹å‡»æŸ¥è¯¢
  .click("#query")
  // å¼€å§‹è¿è¡Œ(çª—å£å¤§å° 1280x720)
  .run({ width: 1280, height: 720 });
```

```js
const image = "/path/to/test.png";
// å›¾ç‰‡è‡ªåŠ¨å»èƒŒæ™¯
utools.ubrowser
  // æ¸…ç©º cookies
  .clearCookies("https://www.remove.bg")
  // å‰å¾€ç«™ç‚¹
  .goto("https://www.remove.bg/zh/upload")
  // ç­‰ç•Œé¢åŠ è½½å‡ºç°ä¸Šä¼ æŒ‰é’®
  .wait('//div[text() = "ä¸Šä¼ å›¾ç‰‡"]')
  // ç²˜è´´å›¾ç‰‡
  .paste(image)
  // å¤„ç†ä¸­ï¼Œç­‰å¾…å‡ºç°ä¸‹è½½æŒ‰é’®
  .wait('//div[text() = "ä¸‹è½½"]')
  // å†ç­‰å¾… 3 ç§’ï¼Œç­‰ç»“æœè¿”å›
  .wait(3000)
  // ä¸‹è½½å›¾ç‰‡
  .download(function () {
    document
      .evaluate(
        '//div[text() = "ä¸‹è½½"]',
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      )
      .singleNodeValue?.click();
  }, utools.getPath("downloads") + "/removebg_" + Date.now() + ".png")
  // å…³é—­çª—å£
  .hide()
  // å¼€å§‹è¿è¡Œ
  .run({ width: 880, height: 720 });
```

```js
const filePath = `/path/to/test.zip`;
// å‘é€æ–‡ä»¶åˆ°å¾®ä¿¡æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹
utools.ubrowser
  .goto("https://filehelper.weixin.qq.com")
  // ç­‰å¾…æ‰«ç ç™»å½•
  .wait("textarea")
  // ä¸Šä¼ æ–‡ä»¶ï¼Œè‡ªåŠ¨å‘é€
  .file("#btnFile", filePath)
  // å¼€å§‹è¿è¡Œ
  .run({ width: 720, Height: 680 });
```

```js
const text = `https://pan.baidu.com/s/1ekPm-ooS0uvVA_J7ZqVGDQ æå–ç : kvr5`;
const matchs = text.match(
  /(https?:\/\/[a-z0-9-._~:/?=#]+)\s*(?:\(|ï¼ˆ)?(?:æå–å¯†?ç ?|è®¿é—®å¯†?ç |å¯†ç )\s*(?::|ï¼š)?\s*([a-z0-9]{4,6})/i
);
// ç½‘ç›˜è‡ªåŠ¨æå–
utools.ubrowser
  // æ‰“å¼€ç½‘ç›˜åœ°å€
  .goto(matchs[1])
  // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆå‡ºç° input å…ƒç´ 
  .wait("input")
  // ç­‰å¾… 500 ms
  .wait(500)
  // è®©æå–ç è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹
  .evaluate(function () {
    const inputDoms = Array.from(document.querySelectorAll("input"));
    const targetInput =
      inputDoms.find(
        (x) =>
          x.placeholder.includes("æå–ç ") || x.placeholder.includes("è®¿é—®ç ")
      ) || inputDoms[0];
    targetInput.focus();
  })
  // ç²˜è´´æå–ç 
  .paste(matchs[2])
  // ç­‰å¾… 300 ms
  .wait(300)
  // å›è½¦
  .press("enter")
  .run({ width: 1280, height: 720 });
```


# å¯ç¼–ç¨‹æµè§ˆå™¨

uTools browser ç®€ç§° ubrowserï¼Œæ˜¯æ ¹æ® uTools çš„ç‰¹æ€§ï¼Œé‡èº«æ‰“é€ çš„ä¸€ä¸ªå¯ç¼–ç¨‹æµè§ˆå™¨ã€‚åˆ©ç”¨ ubrowser å¯ä»¥è½»è€Œæ˜“ä¸¾è¿æ¥ä¸€åˆ‡äº’è”ç½‘æœåŠ¡ï¼Œä¸”ä¸ uTools å®Œç¾ç»“åˆã€‚

::: tip å°æŠ€å·§
ubrowser æ‹¥æœ‰ä¼˜é›…çš„é“¾å¼è°ƒç”¨æ¥å£ï¼Œå¯ä»¥ç”¨å£è¯­åŒ–çš„æ•°è¡Œä»£ç ï¼Œå®ç°ä¸€ç³»åˆ—åŒªå¤·æ‰€æ€çš„æ“ä½œã€‚ä¾‹å¦‚ï¼š

1. RPA è‡ªåŠ¨åŒ–
2. ç½‘é¡µå†…å®¹é­”æ”¹
3. ç½‘é¡µå†…å®¹æŠ“å–

:::

### `ubrowser.goto(url[, headers][, timeout])`

æ‰“å¼€ä¸€ä¸ª ubrowser çª—å£ï¼Œå¹¶è·³è½¬åˆ°æŒ‡å®šç½‘é¡µ

#### ç±»å‹å®šä¹‰

```ts
function goto(
  url: string,
  headers?: Record<string, string>,
  timeout?: number
): UBrowser;
```

- `url`: è¦è·³è½¬çš„ç½‘é¡µåœ°å€
- `headers`: è¯·æ±‚å¤´
- `timeout`: è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’

### `ubrowser.useragent(ua)`

è®¾ç½®ç”¨æˆ·ä»£ç†ï¼ˆUser-Agentï¼‰

#### ç±»å‹å®šä¹‰

```ts
function useragent(ua: string): UBrowser;
```

- `ua`: User-Agent å­—ç¬¦ä¸²

### `ubrowser.viewport(width, height)`

è®¾ç½®æµè§ˆå™¨è§†çª—å¤§å°

#### ç±»å‹å®šä¹‰

```ts
function viewport(width: number, height: number): UBrowser;
```

- `width`: è§†çª—å®½åº¦
- `height`: è§†çª—é«˜åº¦

### `ubrowser.hide()`

éšè— ubrowser çª—å£

#### ç±»å‹å®šä¹‰

```ts
function hide(): UBrowser;
```

### `ubrowser.show()`

æ˜¾ç¤º ubrowser çª—å£

#### ç±»å‹å®šä¹‰

```ts
function show(): UBrowser;
```

## ç½‘é¡µæ“ä½œ

ubrowser æ”¯æŒç½‘é¡µå†…å®¹é­”æ”¹ï¼Œå³åœ¨ç½‘é¡µåŠ è½½å‰å¯¹ç½‘é¡µå†…å®¹è¿›è¡Œä¿®æ”¹ï¼Œä¾‹å¦‚æ·»åŠ è‡ªå®šä¹‰ CSSã€JavaScript ç­‰ã€‚

### `ubrowser.css(css)`

æ·»åŠ è‡ªå®šä¹‰ CSS

#### ç±»å‹å®šä¹‰

```ts
function css(css: string): UBrowser;
```

- `css`: è‡ªå®šä¹‰ CSS

### `ubrowser.evaluate(func[, params])`

åœ¨ç½‘é¡µä¸­æ‰§è¡Œè‡ªå®šä¹‰ JS ä»£ç 

#### ç±»å‹å®šä¹‰

```ts
function evaluate(func: Function, params?: any[]): UBrowser;
```

- `func`: ç½‘é¡µå†…æ‰§è¡Œçš„ JS å‡½æ•°ï¼Œå‡½æ•°è‹¥æœ‰è¿”å›å€¼ï¼Œåˆ™ä¼šåœ¨ `run` Promise ç»“æœè¿”å›
- `params`: ä¼ é€’ç»™`func`çš„å‚æ•°

### `ubrowser.press(key[, modifiers])`

æ¨¡æ‹Ÿé”®ç›˜æŒ‰é”®

#### ç±»å‹å®šä¹‰

```ts
function press(key: string, ...modifiers: string[]): UBrowser;
```

- `key`: è¦æ¨¡æ‹Ÿçš„æŒ‰é”®
- `modifiers`: è¦æ¨¡æ‹Ÿçš„ä¿®é¥°é”®ï¼Œä¸€èˆ¬ä¸º `shift`ã€`ctrl`ã€`alt`ã€`meta`

### `ubrowser.click(selector)`

æ‰§è¡Œç‚¹å‡»æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function click(selector: string): UBrowser;
```

- `selector`: CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨

### `ubrowser.mousedown(selector)`

æ‰§è¡Œé¼ æ ‡æŒ‰ä¸‹æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function mousedown(selector: string): UBrowser;
```

- `selector`: CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨

### `ubrowser.mouseup(selector)`

æ‰§è¡Œé¼ æ ‡æŠ¬èµ·æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function mouseup(selector: string): UBrowser;
```

- `selector`: CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨

### `ubrowser.file(selector, payload)`

å¯¹ç½‘é¡µä¸­çš„ input å…ƒç´ è®¾ç½®æ–‡ä»¶

#### ç±»å‹å®šä¹‰

```ts
function file(selector: string, payload: string | string[] | Buffer): UBrowser;
```

- `selector` å…ƒç´ å¿…é¡»æ˜¯å¯é€‰æ‹©æ–‡ä»¶çš„è¾“å…¥å…ƒç´  `input[type=file]`
- `payload` å¯ä»¥æ˜¯æ–‡ä»¶è·¯å¾„ã€æ–‡ä»¶è·¯å¾„é›†åˆä»¥åŠæ–‡ä»¶ Buffer

### `ubrowser.value(selector, payload)`

å¯¹ç½‘é¡µä¸­çš„ input å…ƒç´ è®¾ç½®å€¼

#### ç±»å‹å®šä¹‰

```ts
function value(selector: string, payload: string): UBrowser;
```

- `selector` å¿…é¡»æ˜¯ `input`ã€`textarea`ã€`select` å…ƒç´ ï¼Œä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨
- `payload` å°†ä¼šè®¾ç½®åˆ° `value` å±æ€§ä¸Š

### `ubrowser.check(selector, checked)`

æ‰§è¡Œå‹¾é€‰æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function check(selector: string, checked: boolean): UBrowser;
```

- `selector` å¿…é¡»æ˜¯ `checkbox`ã€`radio` å…ƒç´ ï¼Œä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨
- `checked` ä¸º `true` æ—¶ï¼Œå‹¾é€‰ï¼Œå¦åˆ™å–æ¶ˆå‹¾é€‰

### `ubrowser.focus(selector)`

æ‰§è¡Œèšç„¦æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function focus(selector: string): UBrowser;
```

- `selector`: CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨

### `ubrowser.scroll(selector)`

æ‰§è¡Œæ»šåŠ¨æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function scroll(selector: string): UBrowser;
function scroll(y: number): UBrowser;
function scroll(x: number, y: number): UBrowser;
```

- `selector` ä¸º `string` æ—¶ï¼Œæ»šåŠ¨åˆ°æŒ‡å®šå…ƒç´ , ä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨
- `selector` ä¸º `number` æ—¶ï¼Œåªæœ‰ä¸€ä¸ªå‚æ•°è¡¨ç¤º y è½´ï¼Œæ»šåŠ¨åˆ°çºµå‘æŒ‡å®šä½ç½®ã€‚ä¸¤ä¸ªå‚æ•°åˆ™è¡¨ç¤º x è½´ã€‚
- ä¼ é€’ `x` å’Œ `y`ï¼Œæ»šåŠ¨åˆ°æŒ‡å®šä½ç½®

### `ubrowser.download(url[, savePath])`

æ‰§è¡Œä¸‹è½½æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function download(url: string, savePath?: string): UBrowser;
function download(
  func: (...params: any[]) => string,
  savePath: string | null,
  ...params: any[]
): UBrowser;
```

- `url` å¾…ä¸‹è½½çš„èµ„æº URL
- `savePath` æŒ‡å®šä¸‹è½½è·¯å¾„ï¼Œä¸ä¼ åˆ™ä¸‹è½½åˆ°é»˜è®¤è·¯å¾„
- `func` ç½‘é¡µå†…æ‰§è¡Œçš„ JS å‡½æ•°, å‡½æ•°å¯è¿”å›èµ„æº URLï¼Œå†æ ¹æ®è¿”å› URL ä¸‹è½½èµ„æº
- `params` ä¼ é€’ç»™ `func` çš„å‚æ•°

### `ubrowser.paste(text)`

å…ˆå¤åˆ¶å†æ‰§è¡Œç²˜è´´æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
function paste(text: string): UBrowser;
```

- `text`: è¦ç²˜è´´çš„å†…å®¹ï¼Œæ”¯æŒæ™®é€šæ–‡æœ¬è·Ÿå›¾åƒ Base64 Data URL

### `ubrowser.screenshot(target[, savePath])`

å¯¹ç½‘é¡µè¿›è¡Œæˆªå±å¹¶ä¿æŒåˆ°æŒ‡å®šè·¯å¾„ï¼Œå°†ä¼šä¿å­˜æˆä¸º png æ ¼å¼

#### ç±»å‹å®šä¹‰

```ts
function screenshot(target?: string | Rect, savePath?: string): UBrowser;
```

- æ²¡æœ‰å‚æ•°æ—¶ï¼Œæ•´ä¸ªç½‘é¡µçª—å£æˆªå±
- å½“ `target` ä¸º `string` æ—¶ï¼Œ`target` ä¸ºé€‰æ‹©å™¨ã€‚å¯ä»¥ä¼ å…¥ä¸€ä¸ª `Rect` å¯¹è±¡ï¼Œè¡¨ç¤ºæˆªå–æŒ‡å®šåŒºåŸŸã€‚
- `savePath` ä¿å­˜è·¯å¾„ï¼Œæ²¡æœ‰ä¼ é€’ `savePath` çš„æ—¶ï¼Œé»˜è®¤å­˜å‚¨åœ¨ä¸´æ—¶ç›®å½•ã€‚

::: details `Rect` ç±»å‹å®šä¹‰

```ts
interface Rect {
  x: number;
  y: number;
  width: number;
  height: number;
}
```

:::

### `ubrowser.markdown([selector])`

å°†å½“å‰ç½‘é¡µå†…å®¹è½¬æ¢ä¸º markdown

#### ç±»å‹å®šä¹‰

```ts
function markdown(selector?: string): UBrowser;
```

- `selector`: å¯é€‰ï¼ŒæŒ‡å®šè¦è½¬æ¢çš„å…ƒç´ ï¼Œä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨ï¼Œä¸ä¼ é€’åˆ™è½¬æ¢æ•´ä¸ªç½‘é¡µå†…å®¹

### `ubrowser.pdf(options[, savePath])`

å°†ç½‘é¡µä¿å­˜ä¸º PDF

#### ç±»å‹å®šä¹‰

```ts
function pdf(options: PdfOptions, savePath?: string): UBrowser;
```

- `PdfOptions` å‚è€ƒ [Electron `PrintToPDFOptions`](https://www.electronjs.org/docs/latest/api/web-contents#contentsprinttopdfoptions)
  >
- `savePath` ä¿å­˜è·¯å¾„ï¼Œæ²¡æœ‰ä¼ é€’ `savePath` çš„æ—¶ï¼Œé»˜è®¤å­˜å‚¨åœ¨ä¸´æ—¶ç›®å½•ã€‚

### `ubrowser.device(options)`

æ¨¡æ‹Ÿç§»åŠ¨è®¾å¤‡

#### ç±»å‹å®šä¹‰

```ts
function device(options: DeviceOptions): UBrowser;
```

- `options` æ¨¡æ‹Ÿè®¾å¤‡ä¿¡æ¯

::: details `DeviceOptions` ç±»å‹å®šä¹‰

```ts
interface DeviceOptions {
  userAgent: string;
  size: {
    width: number;
    height: number;
  };
}
```

:::

### `ubrowser.wait(ms)`

æ‰§è¡Œç­‰å¾…æ“ä½œ

#### ç±»å‹å®šä¹‰

```ts
// ç­‰å¾…æ—¶é—´
function wait(ms: number): this;
// ç­‰å¾…å…ƒç´ å‡ºç°
function wait(selector: string, timeout?: number): this;
// ç­‰å¾…å‡½æ•°è¿”å› true
function wait(
  func: (...params: any[]) => boolean,
  timeout?: number,
  ...params: any[]
): this;
```

- `ms` ç­‰å¾…æŒ‡å®šæ¯«ç§’æ•°
- `selector` ç­‰å¾…å…ƒç´ å‡ºç°ï¼Œä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨
- `timeout` ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 60000 ms (60 ç§’)
- `func` ç½‘é¡µå†…æ‰§è¡Œçš„ JS å‡½æ•°, è¿”å› `true` ç­‰å¾…ç»“æŸ
- `params` ä¼ é€’ç»™ `func` çš„å‚æ•°

### `ubrowser.when(selector)`

æ¡ä»¶åˆ¤æ–­

#### ç±»å‹å®šä¹‰

```ts
// åˆ¤æ–­å­˜åœ¨å…ƒç´ 
function when(selector: string): UBrowser;
// åˆ¤æ–­å‡½æ•°ç»“æœ
function when(func: (...params: any[]) => boolean, ...params: any[]): UBrowser;
```

- `selector` åˆ¤æ–­æ˜¯å¦å­˜åœ¨å…ƒç´ ï¼Œä½¿ç”¨ CSS é€‰æ‹©å™¨æˆ– XPath é€‰æ‹©å™¨
- `func` ç½‘é¡µå†…æ‰§è¡Œçš„ JS å‡½æ•°, åˆ¤æ–­å‡½æ•°è¿”å›çš„ç»“æœ
- `params` ä¼ é€’ç»™ `func` çš„å‚æ•°

### `ubrowser.end()`

ç»“æŸä¸Šä¸€ä¸ª `when`

#### ç±»å‹å®šä¹‰

```ts
function end(): UBrowser;
```

### `ubrowser.devTools([mode])`

æ‰“å¼€ ubrowser å¼€å‘è€…å·¥å…·ã€‚

#### ç±»å‹å®šä¹‰

```ts
function devTools(mode?: string): void;
```

- `mode`: å¯é€‰å€¼ 'right' | 'bottom' | 'undocked' | 'detach' ï¼Œé»˜è®¤ 'detach'

### `ubrowser.cookies([name])`

è·å– ubrowser cookie

#### ç±»å‹å®šä¹‰

```ts
// åœ¨å½“å‰ url æ ¹æ®åç§°è·å– cookie, ä¸ºç©ºè·å–å½“å‰ url å…¨éƒ¨ cookie
function cookies(name?: string): UBrowser;
// æ ¹æ®æ¡ä»¶è·å– Cookie
function cookies(filter: CookieFilter): UBrowser;
```

- `name` cookie åç§°
- `filter` è¿‡æ»¤å¯¹è±¡

::: details `CookieFilter` ç±»å‹å®šä¹‰

```ts
interface CookieFilter {
  url?: string;
  name?: string;
  domain?: string;
  path?: string;
  secure?: boolean;
  session?: boolean;
  httpOnly?: boolean;
}
```

- `url` æ£€ç´¢ä¸ url ç›¸å…³çš„ cookieã€‚ ç©ºæ„å‘³ç€æ£€ç´¢æ‰€æœ‰ URL çš„ cookie ã€‚
- `name` æŒ‰åç§°ç­›é€‰ cookieã€‚
- `domain` æ£€ç´¢ä¸åŸŸåæˆ–è€… domain å­åŸŸååŒ¹é…çš„ cookieã€‚
- `path` æ£€ç´¢è·¯å¾„ä¸ path åŒ¹é…çš„ cookieã€‚
- `secure` é€šè¿‡å…¶ Secure å±æ€§ç­›é€‰ cookieã€‚
- `session` ç­›é€‰å‡º session å†…å¯ç”¨æˆ–æŒä¹…æ€§ cookieã€‚
- `httpOnly` é€šè¿‡å…¶ httpOnly å±æ€§ç­›é€‰ cookieã€‚

:::

### `ubrowser.setCookies`

è®¾ç½® ubrowser çš„ cookie

#### ç±»å‹å®šä¹‰

```ts
function setCookies(name: string, value: string): UBrowser;
function setCookies(cookies: { name: string; value: string }[]): UBrowser;
```

- `name` cookie åç§°
- `value` cookie å€¼
- `cookies` cookie åç§°å’Œå€¼å¯¹è±¡çš„é›†åˆ

### `ubrowser.removeCookies(name)`

åˆ é™¤ ubrowser çš„ cookie

#### ç±»å‹å®šä¹‰

```ts
function removeCookies(name: string): UBrowser;
```

- `name` cookie åç§°

### `ubrowser.clearCookies([url])`

æ¸…ç©º ubrowser çš„ cookie ä¿¡æ¯ã€‚

#### ç±»å‹å®šä¹‰

```ts
function clearCookies(url?: string): UBrowser;
```

- `url`: æ ¹æ® url æ¸…é™¤ cookieï¼Œ`clearCookies` åœ¨ `goto` å‡½æ•°ä¹‹å‰è°ƒç”¨æ—¶ `url` ä¸èƒ½ä¸ºç©ºã€‚åœ¨ `goto` ä¹‹åè°ƒç”¨åˆ™æ¸…ç©ºå½“å‰ url çš„ cookie

### `ubrowser.run()`

å¼€å§‹è¿è¡Œ ubrowser å®ä¾‹ï¼Œå¹¶è¿”å›æ‰§è¡Œç»“æœ

#### ç±»å‹å®šä¹‰

```ts
function run(
  ubrowserId?: number,
  options?: UBrowserOptions
): Promise<[...any, UBrowserInstance]>;
```

- `ubrowserId` ä¸€èˆ¬ä»¥ä¸‹ä¸¤ç§å½¢å¼è·å–ï¼š
  - `ubrowser.run` è¿”å›çš„ `UBrowserInstance` çš„ `id` å±æ€§ï¼ˆubrowser çª—å£ä»åœ¨æ˜¾ç¤ºæ—¶ï¼‰ã€‚
  - [`utools.getIdleUBrowser`](./manage.md#utools-getidleubrowsers) è¿”å›çš„ `UBrowserInstance` çš„ `id` å±æ€§ã€‚
- `run` è¿”å›å°†ä¼šè¿”å›ä¸€ä¸ªåŒ…å«æ•°ç»„çš„ Promise å¯¹è±¡ï¼Œæ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ æ˜¯å½“å‰æœªå…³é—­çª—å£çš„ UBrowser å®ä¾‹ï¼Œå…¶ä½™çš„å…ƒç´ åˆ™æ˜¯è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»– ubrowser æ–¹æ³•çš„è¿”å›å€¼ï¼Œæ¯”å¦‚`evaluate`ã€`cookies`ç­‰ã€‚

::: details `UBrowserOptions` ç±»å‹å®šä¹‰

```ts
interface UBrowserOptions {
  show?: boolean;
  width?: number;
  height?: number;
  x?: number;
  y?: number;
  center?: boolean;
  minWidth?: number;
  minHeight?: number;
  maxWidth?: number;
  maxHeight?: number;
  resizable?: boolean;
  movable?: boolean;
  minimizable?: boolean;
  maximizable?: boolean;
  alwaysOnTop?: boolean;
  fullscreen?: boolean;
  fullscreenable?: boolean;
  enableLargerThanScreen?: boolean;
  opacity?: number;
  frame?: boolean;
  closable?: boolean;
  focusable?: boolean;
  skipTaskbar?: boolean;
  backgroundColor?: string;
  hasShadow?: boolean;
  transparent?: boolean;
  titleBarStyle?: string;
  thickFrame?: boolean;
}
```

- `show`: æ˜¯å¦æ˜¾ç¤ºæµè§ˆå™¨çª—å£
- `width`: æµè§ˆå™¨çª—å£å®½åº¦ï¼Œé»˜è®¤`800`
- `height`: æµè§ˆå™¨çª—å£é«˜åº¦ï¼Œé»˜è®¤`600`
- `x`: æµè§ˆå™¨çª—å£ä½ç½® x åæ ‡
- `y`: æµè§ˆå™¨çª—å£ä½ç½® y åæ ‡
- `center`: æµè§ˆå™¨çª—å£æ˜¯å¦å±…ä¸­
- `minWidth`: æµè§ˆå™¨çª—å£æœ€å°å®½åº¦ï¼Œé»˜è®¤`0`
- `minHeight`: æµè§ˆå™¨çª—å£æœ€å°é«˜åº¦ï¼Œé»˜è®¤`0`
- `maxWidth`: æµè§ˆå™¨çª—å£æœ€å¤§å®½åº¦ï¼Œé»˜è®¤æ— é™åˆ¶
- `maxHeight`: æµè§ˆå™¨çª—å£æœ€å¤§é«˜åº¦ï¼Œé»˜è®¤æ— é™åˆ¶
- `resizable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯ç¼©æ”¾ï¼Œé»˜è®¤`true`
- `movable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯ç§»åŠ¨ï¼Œé»˜è®¤`true`
- `minimizable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯æœ€å°åŒ–ï¼Œé»˜è®¤`true`
- `maximizable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯æœ€å¤§åŒ–ï¼Œé»˜è®¤`true`
- `alwaysOnTop`: æµè§ˆå™¨çª—å£æ˜¯å¦ç½®é¡¶ï¼Œé»˜è®¤`false`
- `fullscreen`: æµè§ˆå™¨çª—å£æ˜¯å¦å…¨å±ï¼Œé»˜è®¤`false`
- `fullscreenable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯å…¨å±ï¼Œé»˜è®¤`true`
- `enableLargerThanScreen`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯è¶…å‡ºå±å¹•ï¼Œé»˜è®¤`false`ï¼Œä»…åœ¨ macOS ä¸‹ç”Ÿæ•ˆ
- `opacity`: æµè§ˆå™¨çª—å£é€æ˜åº¦ï¼Œé»˜è®¤`1`ï¼Œæ”¯æŒ`0`-`1`ä¹‹é—´çš„å€¼ï¼Œä»…åœ¨ macOS è·Ÿ Windows ä¸‹ç”Ÿæ•ˆ
- `frame`: æµè§ˆå™¨çª—å£æ˜¯å¦æœ‰è¾¹æ¡†ï¼Œé»˜è®¤`true`
- `closable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯å…³é—­ï¼Œé»˜è®¤`true`
- `focusable`: æµè§ˆå™¨çª—å£æ˜¯å¦å¯èšç„¦ï¼Œé»˜è®¤`true`
- `skipTaskbar`: æµè§ˆå™¨çª—å£æ˜¯å¦è·³è¿‡ä»»åŠ¡æ ï¼Œé»˜è®¤`false`
- `backgroundColor`: æµè§ˆå™¨çª—å£èƒŒæ™¯é¢œè‰²ï¼Œé»˜è®¤`#ffffff`
- `hasShadow`: æµè§ˆå™¨çª—å£æ˜¯å¦æœ‰é˜´å½±ï¼Œé»˜è®¤`false`
- `transparent`: æµè§ˆå™¨çª—å£æ˜¯å¦é€æ˜ï¼Œé»˜è®¤`false`
- `titleBarStyle`: æµè§ˆå™¨çª—å£æ ‡é¢˜æ æ ·å¼ï¼Œé»˜è®¤`default`ï¼Œå¯é€‰å€¼`hidden`ã€`hiddenInset`ã€`customButtonsOnHover`
- `thickFrame`: æµè§ˆå™¨çª—å£è¾¹æ¡†æ˜¯å¦åŠ ç²—ï¼Œé»˜è®¤`false`

:::

::: details `UBrowserInstance` ç±»å‹å®šä¹‰ {#ubrowser-instance}

```ts
interface UBrowserInstance {
  id: string;
  url: string;
  title: string;
  width: number;
  height: number;
  x: number;
  y: number;
}
```

:::

### ç¤ºä¾‹ä»£ç 

```js
const address = "ç¦å·çƒŸå°å±±";
// åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºåœ°å€ä½ç½®
utools.ubrowser
  // æ‰“å¼€ç™¾åº¦åœ°å›¾ç«™ç‚¹
  .goto("https://map.baidu.com")
  // ç­‰å¾…å‡ºç°æœç´¢æ¡†
  .wait("#sole-input")
  // æœç´¢æ¡†è·å¾—ç„¦ç‚¹
  .focus("#sole-input")
  // åœ°å€æœç´¢æ¡†è¾“å…¥åœ°å€
  .value("#sole-input", address)
  // ç­‰å¾… 300 æ¯«ç§’
  .wait(300)
  // æŒ‰ä¸‹å›è½¦
  .press("enter")
  // å¼€å§‹è¿è¡Œ
  .run({ width: 1200, height: 800 });
```

```js
const expressNo = "YT8933937901850";
// å¿«é€’ 100 æŸ¥è¯¢å¿«é€’å•å·
utools.ubrowser
  // æ‰“å¼€å¿«é€’ 100
  .goto("https://www.kuaidi100.com/")
  // ç­‰å¾…è¾“å…¥æ¡†
  .wait("#input")
  // æ»šåŠ¨åˆ°åˆé€‚ä½ç½®
  .scroll(0, 450)
  // è¾“å…¥å¿«é€’å•å·
  .value("#input", expressNo)
  // ç‚¹å‡»æŸ¥è¯¢
  .click("#query")
  // å¼€å§‹è¿è¡Œ(çª—å£å¤§å° 1280x720)
  .run({ width: 1280, height: 720 });
```

```js
const image = "/path/to/test.png";
// å›¾ç‰‡è‡ªåŠ¨å»èƒŒæ™¯
utools.ubrowser
  // æ¸…ç©º cookies
  .clearCookies("https://www.remove.bg")
  // å‰å¾€ç«™ç‚¹
  .goto("https://www.remove.bg/zh/upload")
  // ç­‰ç•Œé¢åŠ è½½å‡ºç°ä¸Šä¼ æŒ‰é’®
  .wait('//div[text() = "ä¸Šä¼ å›¾ç‰‡"]')
  // ç²˜è´´å›¾ç‰‡
  .paste(image)
  // å¤„ç†ä¸­ï¼Œç­‰å¾…å‡ºç°ä¸‹è½½æŒ‰é’®
  .wait('//div[text() = "ä¸‹è½½"]')
  // å†ç­‰å¾… 3 ç§’ï¼Œç­‰ç»“æœè¿”å›
  .wait(3000)
  // ä¸‹è½½å›¾ç‰‡
  .download(function () {
    document
      .evaluate(
        '//div[text() = "ä¸‹è½½"]',
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      )
      .singleNodeValue?.click();
  }, utools.getPath("downloads") + "/removebg_" + Date.now() + ".png")
  // å…³é—­çª—å£
  .hide()
  // å¼€å§‹è¿è¡Œ
  .run({ width: 880, height: 720 });
```

```js
const filePath = `/path/to/test.zip`;
// å‘é€æ–‡ä»¶åˆ°å¾®ä¿¡æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹
utools.ubrowser
  .goto("https://filehelper.weixin.qq.com")
  // ç­‰å¾…æ‰«ç ç™»å½•
  .wait("textarea")
  // ä¸Šä¼ æ–‡ä»¶ï¼Œè‡ªåŠ¨å‘é€
  .file("#btnFile", filePath)
  // å¼€å§‹è¿è¡Œ
  .run({ width: 720, Height: 680 });
```

```js
const text = `https://pan.baidu.com/s/1ekPm-ooS0uvVA_J7ZqVGDQ æå–ç : kvr5`;
const matchs = text.match(
  /(https?:\/\/[a-z0-9-._~:/?=#]+)\s*(?:\(|ï¼ˆ)?(?:æå–å¯†?ç ?|è®¿é—®å¯†?ç |å¯†ç )\s*(?::|ï¼š)?\s*([a-z0-9]{4,6})/i
);
// ç½‘ç›˜è‡ªåŠ¨æå–
utools.ubrowser
  // æ‰“å¼€ç½‘ç›˜åœ°å€
  .goto(matchs[1])
  // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆå‡ºç° input å…ƒç´ 
  .wait("input")
  // ç­‰å¾… 500 ms
  .wait(500)
  // è®©æå–ç è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹
  .evaluate(function () {
    const inputDoms = Array.from(document.querySelectorAll("input"));
    const targetInput =
      inputDoms.find(
        (x) =>
          x.placeholder.includes("æå–ç ") || x.placeholder.includes("è®¿é—®ç ")
      ) || inputDoms[0];
    targetInput.focus();
  })
  // ç²˜è´´æå–ç 
  .paste(matchs[2])
  // ç­‰å¾… 300 ms
  .wait(300)
  // å›è½¦
  .press("enter")
  .run({ width: 1280, height: 720 });
```


# å›¢é˜Ÿåº”ç”¨

æä¾›å›¢é˜Ÿç‰ˆæ’ä»¶ç›¸å…³çš„æ¥å£ï¼Œç”¨æ¥è·å–å›¢é˜Ÿç‰ˆç®¡ç†é…ç½®çš„ä¿¡æ¯ã€‚

:::tip
å›¢é˜Ÿåº”ç”¨ API éœ€è¦é…åˆå›¢é˜Ÿç®¡ç†åå°ä½¿ç”¨ï¼Œè¯·åœ¨å›¢é˜Ÿåå°åˆ›å»ºå¯¹åº”åº”ç”¨åå¯ä»¥ä½¿ç”¨ã€‚ï¼ˆæš‚æœªå¼€æ”¾ç¬¬ä¸‰æ–¹åº”ç”¨ï¼‰
:::

## `utools.team.info()`

è·å–å½“å‰å›¢é˜Ÿä¿¡æ¯

### ç±»å‹å®šä¹‰

```ts
function info(): TeamInfo;
```

::: details `TeamInfo` ç±»å‹å®šä¹‰

```ts
interface TeamInfo {
  teamId: string;
  teamName: string;
  teamLogo: string;
  userId: string;
  userName: string;
  userAvatar: string;
}
```

#### å­—æ®µè¯´æ˜

- `teamId`
  - å›¢é˜Ÿ IDï¼Œåˆ›å»ºå›¢é˜Ÿæ—¶ç”Ÿæˆ
- `teamName`
  - å›¢é˜Ÿåç§°ï¼Œåˆ›å»ºå›¢é˜Ÿæ—¶å¡«å†™
- `teamLogo`
  - å›¢é˜Ÿå›¾æ ‡ï¼Œè¿”å›å›¾ç‰‡çš„ç½‘ç»œåœ°å€
- `userId`
  - å›¢é˜Ÿæˆå‘˜ IDï¼ŒåŠ å…¥å›¢é˜Ÿæ—¶ç”Ÿæˆ
- `userName`
  - å›¢é˜Ÿæˆå‘˜åå­—ï¼ŒåŠ å…¥å›¢é˜Ÿæ—¶å¡«å†™
- `userAvatar`
  - å›¢é˜Ÿæˆå‘˜å¤´åƒ

:::

### ç¤ºä¾‹ä»£ç 

```js
const { teamName } = utools.team.info();

console.log(`å½“å‰å›¢é˜Ÿä¸ºï¼š${teamName}`);
```

## `utools.team.preset(key)`

è·å–å¯¹åº”çš„å›¢é˜Ÿé…ç½®ï¼Œè·å–çš„é…ç½®éœ€è¦åœ¨å›¢é˜Ÿç‰ˆï¼Œè¿”å›çš„æ•°æ®ä¸ºä¸€ä¸ª JSON å¯¹è±¡

### ç±»å‹å®šä¹‰

```ts
function preset<T>(key: string): T | null;
```

### ç¤ºä¾‹ä»£ç 

```js
// è¯»å–é…ç½®
const configValue = utools.team.preset("config-key");
console.log(configValue);
```

## `utools.team.allPresets([keyStartsWith])`

è·å–å½“å‰å›¢é˜Ÿä¸‹å‘çš„æ‰€æœ‰é…ç½®ï¼Œæ”¯æŒæ¥æ”¶ä¸€ä¸ª key å‰ç¼€æˆ–è€… keys æ¥è¿‡æ»¤

### ç±»å‹å®šä¹‰

```ts
function allPresets(keyStartsWith?: string): Promise<{ key: string; value: any }[]>;
function allPresets(keys: string[]): Promise<{ key: string; value: any }[]>;
```

### ç¤ºä¾‹ä»£ç 

```js
// è·å– key æ˜¯ "config-" å¼€å¤´çš„æ‰€æœ‰é…ç½®
const allPresets1 = utools.team.allPresets("config-");
// è·å– key æ•°ç»„å¯¹åº”çš„é…ç½®
const allPresets2 = utools.team.allPresets(["config-key-1", "config-key-2"]);
// è·å–æ‰€æœ‰é…ç½®
const allPresets3 = utools.team.allPresets();
```


# ç”¨æˆ·ä»˜è´¹

## `utools.isPurchasedUser()`

æ˜¯å¦ä»˜è´¹ç”¨æˆ·

### ç±»å‹å®šä¹‰

```ts
function isPurchasedUser(): boolean | string
```

- è¿”å› `false` éä»˜è´¹ç”¨æˆ·ï¼Œè¿”å› `true` æ°¸ä¹…æˆæƒç”¨æˆ·(ä»˜è´¹ä¹°æ–­)ï¼Œè¿”å› "yyyy-mm-dd hh:mm:ss" æ—¥æœŸå­—ç¬¦ä¸²è¡¨ç¤ºæˆæƒç”¨æˆ·åˆ°æœŸæ—¶é—´

### ç¤ºä¾‹ä»£ç 

```js
utools.onPluginEnter(({ type, code, payload }) => {
  const purchasedUser = utools.isPurchasedUser();
  if (purchasedUser) {
    // å·²ä»˜è´¹çš„åˆæ³•ç”¨æˆ·ï¼Œå¯ä½¿ç”¨æ’ä»¶åº”ç”¨å®Œæ•´åŠŸèƒ½
    // purchasedUser === true æ°¸ä¹…æˆæƒ(ä»˜è´¹ä¹°æ–­)
    // purchasedUser === "yyyy-mm-dd hh:mm:ss", æˆæƒåˆ°æœŸæ—¶é—´
  } else {
    // æ‰“å¼€ä»˜è´¹
    utools.openPurchase({ goodsId: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" }, () => {
      console.log("ä»˜è´¹æˆåŠŸ");
    });
  }
});
```

## `utools.openPurchase(options, callback)`

æ‰“å¼€ä»˜è´¹ (é€‚ç”¨è½¯ä»¶ä»˜è´¹æ¨¡å¼)

::: warning è½¯ä»¶ä»˜è´¹
è½¯ä»¶ä»˜è´¹æŒ‡çš„æ˜¯ï¼Œç”¨æˆ·æŒ‰å¤©æ•°è´­ä¹°æˆæƒï¼Œåœ¨æˆæƒç”Ÿæ•ˆæœŸå†…ï¼Œå¯ä»¥ä½¿ç”¨å¯¹åº”çš„æ’ä»¶åº”ç”¨åŠŸèƒ½

ä»˜è´¹æ¨¡å¼
- æ’ä»¶åº”ç”¨åŸºç¡€åŠŸèƒ½å…è´¹ï¼Œé«˜çº§åŠŸèƒ½ä»˜è´¹ä½¿ç”¨ï¼ˆæ¨èï¼‰
- æ’ä»¶åº”ç”¨å®Œå…¨æ”¶è´¹
:::

### ç±»å‹å®šä¹‰

```ts
function openPurchase(options: OpenPurchaseOptions, callback?: () => void): void
```

::: details `OpenPurchaseOptions` ç±»å‹å®šä¹‰

```ts
interface OpenPurchaseOptions {
  goodsId: string;
  outOrderId?: string;
  attach?: string;
}
```

#### å­—æ®µè¯´æ˜

- `goodsId`
  - å•†å“ IDï¼Œåœ¨ â€œ uTools å¼€å‘è€…å·¥å…·â€ æ’ä»¶åº”ç”¨ä¸­åˆ›å»º
- `outOrderId`
  - ç¬¬ä¸‰æ–¹æœåŠ¡ç”Ÿæˆçš„è®¢å•å·ï¼ˆ6 - 64 å­—ç¬¦ï¼‰
- `attach`
  - ç¬¬ä¸‰æ–¹æœåŠ¡é™„åŠ æ•°æ®ï¼Œåœ¨æŸ¥è¯¢ API å’Œæ”¯ä»˜é€šçŸ¥ä¸­åŸæ ·è¿”å›ï¼Œå¯ä½œä¸ºè‡ªå®šä¹‰å‚æ•°ä½¿ç”¨ï¼ˆæœ€å¤š 256 å­—ç¬¦ï¼‰

:::

- `options` ä»˜è´¹å‚æ•°
- `callback` ä»˜è´¹æˆåŠŸæ‰§è¡Œçš„å›è°ƒå‡½æ•°

### ç¤ºä¾‹ä»£ç 

```js
utools.onPluginEnter(({ type, code, payload }) => {
  const purchasedUser = utools.isPurchasedUser();
  if (purchasedUser) {
    // å·²ä»˜è´¹çš„åˆæ³•ç”¨æˆ·ï¼Œå¯ä½¿ç”¨æ’ä»¶åº”ç”¨å®Œæ•´åŠŸèƒ½
    // purchasedUser === true æ°¸ä¹…æˆæƒ(ä»˜è´¹ä¹°æ–­)
    // purchasedUser === "yyyy-mm-dd hh:mm:ss", æˆæƒåˆ°æœŸæ—¶é—´
  } else {
    // æ‰“å¼€ä»˜è´¹
    utools.openPurchase({ goodsId: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" }, () => {
      console.log("ä»˜è´¹æˆåŠŸ");
    });
  }
});
```

## `utools.openPayment(options, callback)`

æ‰“å¼€æ”¯ä»˜ (é€‚ç”¨æœåŠ¡ä»˜è´¹æ¨¡å¼)

::: warning æœåŠ¡ä»˜è´¹
æœåŠ¡ä»˜è´¹æŒ‡çš„æ˜¯ï¼Œç”¨æˆ·æŒ‰ä½¿ç”¨é‡è´­ä¹°åº”ç”¨æœåŠ¡ï¼Œåœ¨è´­ä¹°åï¼Œå¯ä»¥åœ¨å›ºå®šçš„æ¬¡æ•°æˆ–è€…æ•°é‡ä¸‹ï¼Œä½¿ç”¨åº”ç”¨æœåŠ¡ã€‚

ä»˜è´¹æ¨¡å¼
- æœåŠ¡ API æŒ‰æ¬¡/æŒ‰é‡è´­ä¹°ã€‚
- å”®å–è™šæ‹Ÿå•†å“ã€‚
:::

### ç±»å‹å®šä¹‰

```ts
function openPayment(options: OpenPaymentOptions, callback?: () => void): void
```

::: details `OpenPaymentOptions` ç±»å‹å®šä¹‰

```ts
interface OpenPaymentOptions {
  goodsId: string;
  outOrderId?: string;
  attach?: string;
}
```

#### å­—æ®µè¯´æ˜

- `goodsId`
  - å•†å“ IDï¼Œåœ¨ â€œ uTools å¼€å‘è€…å·¥å…·â€ æ’ä»¶åº”ç”¨ä¸­åˆ›å»º
- `outOrderId`
  - ç¬¬ä¸‰æ–¹æœåŠ¡ç”Ÿæˆçš„è®¢å•å·ï¼ˆ6 - 64 å­—ç¬¦ï¼‰
- `attach`
  - ç¬¬ä¸‰æ–¹æœåŠ¡é™„åŠ æ•°æ®ï¼Œåœ¨æŸ¥è¯¢ API å’Œæ”¯ä»˜é€šçŸ¥ä¸­åŸæ ·è¿”å›ï¼Œå¯ä½œä¸ºè‡ªå®šä¹‰å‚æ•°ä½¿ç”¨ï¼ˆæœ€å¤š 256 å­—ç¬¦ï¼‰

:::

- `options` æ”¯ä»˜å‚æ•°
- `callback` æ”¯ä»˜æˆåŠŸæ‰§è¡Œçš„å›è°ƒå‡½æ•°

### ç¤ºä¾‹ä»£ç 

```js
// 1. é…ç½®å¥½æœåŠ¡ç«¯æ”¯ä»˜é€šçŸ¥åœ°å€
// 2. æ‰“å¼€æ”¯ä»˜
utools.openPayment({ goodsId: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" }, () => {
  console.log("æ”¯ä»˜æˆåŠŸ");
  // é‡æ–°ä»æœåŠ¡å™¨è·å–å·²è´­ä¹°å•†å“é‡
});
```

## `utools.fetchUserPayments()`

è·å–ç”¨æˆ·æ”¯ä»˜è®°å½•

### ç±»å‹å®šä¹‰

```ts
function fetchUserPayments(): Promise<Payment[]>
```

::: details `Payment` ç±»å‹å®šä¹‰

```ts
interface Payment {
  order_id: string;
  out_order_id: string;
  open_id: string;
  pay_fee: number;
  body: string;
  attach: string;
  goods_id: string;
  paid_at: string;
  created_at: string;
}
```

#### å­—æ®µè¯´æ˜

- `order_id`
  - uTools è®¢å• ID
- `out_order_id`
  - å¤–éƒ¨æˆ–ç¬¬ä¸‰æ–¹æœåŠ¡ç”Ÿæˆçš„è®¢å•å·
- `open_id`
  - uTools ç”¨æˆ· ID
- `pay_fee`
  - æ”¯ä»˜é‡‘é¢ï¼Œå•ä½ä¸ºåˆ†
- `body`
  - å•†å“æè¿°
- `attach`
  - é™„åŠ æ•°æ®
- `goods_id`
  - å•†å“ ID
- `paid_at`
  - æ”¯ä»˜æ—¶é—´
- `created_at`
  - è®¢å•ç”Ÿæˆæ—¶é—´

:::

### ç¤ºä¾‹ä»£ç 

```js
utools.fetchUserPayments().then((payments) => {
  console.log(payments);
});
```


# æœåŠ¡ç«¯ API

é€šè¿‡ uTools çš„æœåŠ¡ç«¯ APIï¼Œå¯ä»¥å°†ä½ çš„åº”ç”¨å’Œ uTools ç”¨æˆ·å…³è”ï¼Œå®ç°å¸å·äº’é€šã€æ¥æ”¶æ”¯ä»˜é€šçŸ¥ã€æŸ¥è¯¢ç”¨æˆ·æ”¯ä»˜è®°å½•ç­‰ï¼Œä¸ºä¿æŠ¤å¯†é’¥å®‰å…¨ï¼Œè¯·ä»…åœ¨æœåŠ¡ç«¯è°ƒç”¨æ¥å£ã€‚

## å…¬å…±å®šä¹‰

### è¿”å›çŠ¶æ€ç 

| çŠ¶æ€ç  | è¯´æ˜                         |
| ------ | ---------------------------- |
| 200    | æˆåŠŸ                         |
| 400    | å®¢æˆ·ç«¯é”™è¯¯                   |
| 401    | ä½ç½®ç”¨æˆ·ï¼ˆsign é”™è¯¯ï¼‰        |
| 403    | æ— æƒé™è®¿é—®ï¼ˆtimestamp è¿‡æœŸï¼‰ |
| 404    | æœªæ‰¾åˆ°å¯¹åº”æ’ä»¶               |
| 422    | è¯·æ±‚å‚æ•°æ ¡éªŒå¤±è´¥             |
| 500    | uTools æš‚æ—¶æ— æ³•æä¾›æœåŠ¡      |

## è·å–ç”¨æˆ·åŸºç¡€ä¿¡æ¯

æ­¤æ¥å£ç”¨äºè·å– uTools ç”¨æˆ·çš„åŸºç¡€ä¿¡æ¯ã€éªŒè¯ç”¨æˆ·çœŸå®æ€§ï¼Œä¸ç¬¬ä¸‰æ–¹ç³»ç»Ÿè¿›è¡Œå¸å·æ‰“é€šï¼Œå®ç°ç³»ç»Ÿé—´å…ç™»å½•è·³è½¬ç­‰ã€‚

### æ¥å£å®šä¹‰

```http
GET https://open.u-tools.cn/baseinfo
Accept: application/json
```

### è¯·æ±‚å‚æ•°

| å‚æ•°å       | ç±»å‹   | å¿…å¡« | è¯´æ˜                                            |
| ------------ | ------ | ---- | ----------------------------------------------- |
| plugin_id    | string | æ˜¯   | æ’ä»¶ ID                                         |
| access_token | string | æ˜¯   | ç”¨æˆ·ç™»å½•å‡­è¯ï¼Œ[ç‚¹å‡»æŸ¥çœ‹è·å–æ–¹å¼](#access_token) |
| timestamp    | string | æ˜¯   | è¯·æ±‚æ—¶é—´æˆ³(ç§’)ï¼Œè¯¯å·®éœ€å°äº 10 åˆ†é’Ÿ              |
| sign         | string | æ˜¯   | ç­¾åï¼Œè¯¦è§[ç­¾åç®—æ³•](#sign_method)              |

### å“åº”æ•°æ®

- çŠ¶æ€`200`æ—¶è¿”å›

```json
{
  "resource": {
    "avatar": "https://res.u-tools.cn/assets/avatars/eZCBIawAkspLw8Xg.png",
    "member": 1, // æ˜¯å¦ uTools ä¼šå‘˜ï¼ˆ0: å¦ï¼Œ1: æ˜¯ï¼‰
    "nickname": "å´æ­¥.",
    "open_id": "00a50cd81c37c4e381e8161b2d762158", // uTools ç”¨æˆ· ID, å¯¹äºæ­¤æ’ä»¶åº”ç”¨ä¸å˜ä¸”å”¯ä¸€
    "timestamp": 1624329616
  },
  "sign": "4dbf21a9d5a0f0e3906a0180522fd6393b4e91f738d57cafddf309afc6c547bb" // ç­¾åç®—æ³•ä¸ 1.3 ç›¸åŒ
}
```

- å…¶ä»–çŠ¶æ€æ—¶è¿”å›

```json
{
  "message": "The given data was invalid.", // message å­—æ®µå§‹ç»ˆå­˜åœ¨
  "errors": {
    // å¯èƒ½æ²¡æœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯
    "access_token": ["access token å¿…é¡»æ˜¯ 32 ä¸ªå­—ç¬¦ã€‚"]
  }
}
```

### è°ƒç”¨æ­¥éª¤

1. åœ¨å®¢æˆ·ç«¯è·å–ç”¨æˆ·ç™»å½•å‡­è¯ access_tokenï¼Œ[é€šè¿‡`utools.fetchUserServerTemporaryToken`è·å–](./utools/user.md#utools-fetchuserservertemporarytoken) {#access_token}

2. æœåŠ¡ç«¯ç­¾åç®—æ³• {#sign_method}

- å¯¹è¯·æ±‚å‚æ•°æŒ‰å‚æ•°åå‡åºæ’åº
- å¯¹å‚æ•°å†…å®¹è¿›è¡Œ `url_encode` ç¼–ç åï¼Œç»„åˆæˆ URL å‚æ•°å½¢å¼çš„å­—ç¬¦ä¸²ï¼Œå¦‚ï¼š`access_token=aaaaaaa&plugin_id=ccccc&timestamp=1624329435`
- ä½¿ç”¨ HMAC æ–¹æ³•å¯¹å­—ç¬¦ä¸²ç”Ÿæˆå¸¦æœ‰å¯†é’¥çš„å“ˆå¸Œå€¼ï¼Œå¾—åˆ°ç­¾å

::: code-group

```php
$params = [
  "plugin_id" => "zueadppw", // å¯åœ¨å¼€å‘è€…æ’ä»¶åº”ç”¨ä¸­è·å¾—
  "access_token" => "user access_token 32ä½",
  "timestamp" => "1624329435",
];
// 1. æŒ‰ç…§é”®åå¯¹æ•°ç»„è¿›è¡Œå‡åºæ’åº
ksort($params);
// 2. ç”Ÿæˆ URL-encode ä¹‹åçš„è¯·æ±‚å­—ç¬¦ä¸²
$str = http_build_query($params);
// 3. ä½¿ç”¨ HMAC æ–¹æ³•ç”Ÿæˆå¸¦æœ‰å¯†é’¥çš„å“ˆå¸Œå€¼
$secret = "your secret 32ä½"; // secret åœ¨å¼€å‘è€…æ’ä»¶åº”ç”¨ä¸­é€šè¿‡é‡ç½®è·å–
$sign = hash_hmac("sha256", $str, $secret);
```

```js [nodejs]
const crypto = require("crypto");
const params = {
  plugin_id: "zueadppw", // å¯åœ¨å¼€å‘è€…æ’ä»¶åº”ç”¨ä¸­è·å¾—
  access_token: "user access_token 32ä½",
  timestamp: "1624329435",
};
// 1. æŒ‰ç…§é”®åå¯¹æ•°ç»„è¿›è¡Œå‡åºæ’åº
const keys = Object.keys(params).sort();
const sortedParams = keys.reduce((acc, key) => {
  acc[key] = params[key];
  return acc;
}, {});
// 2. ç”Ÿæˆ URL-encode ä¹‹åçš„è¯·æ±‚å­—ç¬¦ä¸²
const str = new URLSearchParams(sortedParams).toString();
// 3. ä½¿ç”¨ HMAC æ–¹æ³•ç”Ÿæˆå¸¦æœ‰å¯†é’¥çš„å“ˆå¸Œå€¼
const secret = "your secret 32ä½"; // secret åœ¨å¼€å‘è€…æ’ä»¶åº”ç”¨ä¸­é€šè¿‡é‡ç½®è·å–
const sign = crypto.createHmac("sha256", secret).update(str).digest("hex");
```

:::

3. å‘èµ·è¯·æ±‚

::: code-group

```bash [curl]
curl --location --request GET 'https://open.u-tools.cn/baseinfo' \
--header 'Content-Type: application/json' \
--data-raw '{
  "plugin_id": "zueadppw", // å¯åœ¨å¼€å‘è€…æ’ä»¶åº”ç”¨ä¸­è·å¾—
  "access_token": "user access_token 32ä½",
  "timestamp": "1624329435",
  "sign": "xxx"
  }'
```

```php
$ch = curl_init();
$url = "https://open.u-tools.cn/baseinfo?" . http_build_query($params);
$headers = array(
  "Content-Type: application/json",
  "Accept: application/json",
)
curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
$response = curl_exec($ch);
if (!curl_errno($ch)) {
  $json = json_decode($response, true);
  echo $json;
}
curl_close($ch);
```

```js [nodejs]
const fetch = require('node-fetch')
const params = {
  plugin_id: "zueadppw", // å¯åœ¨å¼€å‘è€…æ’ä»¶åº”ç”¨ä¸­è·å¾—
  access_token: "user access_token 32ä½",
  timestamp: "1624329435",
  sign: "xxx"
}
fetch('https://open.u-tools.cn/baseinfo?' + new URLSearchParams(params), {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json'
  },
).then(res => res.json()).then(data => {
  console.log(data)
})
```

:::

## æ”¯ä»˜è®¢å•æŸ¥è¯¢æ¥å£

æ­¤æ¥å£ç”¨äºä¸»åŠ¨æŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€ã€‚

### æ¥å£å®šä¹‰

```http
GET https://open.u-tools.cn/payments/record
Accept: application/json
```

### è¯·æ±‚å‚æ•°

| å‚æ•°å       | ç±»å‹   | å¿…å¡« | è¯´æ˜                               |
| ------------ | ------ | ---- | ---------------------------------- |
| plugin_id    | string | æ˜¯   | æ’ä»¶ ID                            |
| out_order_id | string | æ˜¯   | ä¼  out_order_id æˆ– order_id å‡å¯ |
| timestamp    | int    | æ˜¯   | æ—¶é—´æˆ³ï¼ˆç§’ï¼‰ï¼Œè¯¯å·®éœ€å°äº 10 åˆ†é’Ÿ   |
| sign         | string | æ˜¯   | ç­¾åï¼Œè¯¦è§[ç­¾åç®—æ³•](#sign_method) |

### å“åº”æ•°æ®

- çŠ¶æ€`200`æ—¶è¿”å›

```json
{
  "resource": {
    "attach": "", // é™„åŠ æ•°æ®
    "body": "ä¼šå‘˜1å¹´", // æ”¯ä»˜å†…å®¹
    "created_at": "2021-06-18 16:42:16", // è®¢å•ç”Ÿæˆæ—¶é—´
    "goods_id": "6n193s7P95p9gA13786YkwQ5oxHpVW4f", // å•†å“ID
    "open_id": "a331127d654761ac91d086b942aae7b6", // uTools ç”¨æˆ· ID
    "order_id": "KMFSOZt5cMe5A0ClkdCAAyPasyXZJzP6", // uTools è®¢å•å·
    "out_order_id": "123456", // å¤–éƒ¨è®¢å•å·
    "paid_at": "", // ç”¨æˆ·æ”¯ä»˜æ—¶é—´
    "pay_fee": 1, // æ”¯ä»˜é‡‘é¢ï¼ˆåˆ†ï¼‰
    "plugin_id": "FFFFFFFF",
    "status": 0, // æ˜¯å¦æ”¯ä»˜ï¼ˆ0: æœªæ”¯ä»˜ï¼Œ10: å·²æ”¯ä»˜ï¼‰
    "timestamp": 1624346603 // è¯·æ±‚å‘é€æ—¶é—´æˆ³
  },
  "sign": "dbb3d05f6e794ca3b2bc2fa7ef45c3f7cd6a3b20c601b37317863b67998d535e"
}
```

## åˆ›å»ºå•†å“æ¥å£

æ­¤æ¥å£ç”¨äºåŠ¨æ€åˆ›å»ºå•†å“ï¼Œä¸»è¦è§£å†³ä¸å›ºå®šé‡‘é¢å•†å“é—®é¢˜ï¼Œä¸€èˆ¬ä¸ºä¸€æ¬¡æ€§ä½¿ç”¨ï¼Œé€šè¿‡æ­¤ API åˆ›å»ºçš„å•†å“ä¸ä¼šå‡ºç°åœ¨å¼€å‘è€…å·¥å…·çš„å•†å“åˆ—è¡¨ä¸­

### æ¥å£å®šä¹‰

```http
POST https://open.u-tools.cn/goods
Accept: application/json
```

### è¯·æ±‚å‚æ•°

| å‚æ•°å       | ç±»å‹   | å¿…å¡« | è¯´æ˜                                            |
| ------------ | ------ | ---- | ----------------------------------------------- |
| plugin_id    | string | æ˜¯   | æ’ä»¶ ID                                         |
| access_token | string | æ˜¯   | ç”¨æˆ·ç™»å½•å‡­è¯ï¼Œ[ç‚¹å‡»æŸ¥çœ‹è·å–æ–¹å¼](#access_token) |
| timestamp    | int    | æ˜¯   | æ—¶é—´æˆ³ï¼ˆç§’ï¼‰ï¼Œè¯¯å·®éœ€å°äº 10 åˆ†é’Ÿ                |
| sign         | string | æ˜¯   | ç­¾åï¼Œ[ç‚¹å‡»æŸ¥çœ‹ç­¾åæ–¹å¼](#sign)                 |

### å“åº”æ•°æ®

```json
{
  "message": "ZyxrbSpWBH360pSWG0ueYI3rKSWXMcic"
}
```

## ç”¨æˆ·æ”¯ä»˜æˆåŠŸå›è°ƒæ¥å£

å½“ç”¨æˆ·é€šè¿‡ uTools åœ¨ä½ çš„æ’ä»¶åº”ç”¨å†…å®Œæˆæ”¯ä»˜ï¼Œä¸”åœ¨å¼€å‘è€…å·¥å…·ä¸­é…ç½®äº†å›è°ƒåœ°å€ï¼Œåœ¨æ”¶åˆ°ä»˜æ¬¾æ—¶ï¼Œä¼šå°†ä¿¡æ¯æ¨é€åˆ°é…ç½®çš„å›è°ƒåœ°å€ã€‚

### æ¥å£å®šä¹‰

æ­¤å¤„çš„æ¥å£å®šä¹‰æŒ‡çš„æ˜¯å¼€å‘è€…å·¥å…·ä¸­é…ç½®çš„å›è°ƒåœ°å€ï¼Œå°†ä¼šä»¥ `POST` æ–¹å¼æ¨é€æ•°æ®åˆ°å¼€å‘è€…å·¥å…·ä¸­é…ç½®çš„å›è°ƒåœ°å€ã€‚

```http
POST /<*api_path>
Content-Type: application/json
```

### è¯·æ±‚å‚æ•°

æ­¤å¤„çš„è¯·æ±‚å‚æ•°æŒ‡çš„æ˜¯å°†å¯¹å¼€å‘è€…å·¥å…·ä¸­é…ç½®çš„å›è°ƒåœ°å€å‘èµ· `POST` è¯·æ±‚æ—¶ï¼Œä¼šè¢«æºå¸¦çš„å‚æ•°ã€‚

```json
{
  "resource": {
    "attach": "", // é™„åŠ æ•°æ®
    "body": "æ”¯ä»˜å†…å®¹", // æ”¯ä»˜å†…å®¹
    "created_at": "2021-06-18 16:42:16", // è®¢å•ç”Ÿæˆæ—¶é—´
    "goods_id": "xxx", // å•†å“ID
    "open_id": "xxx", // uTools ç”¨æˆ· ID
    "order_id": "xxx", // uTools è®¢å•å·
    "out_order_id": "123456", // å¤–éƒ¨è®¢å•å·
    "paid_at": "2021-06-18 16:42:36", // ç”¨æˆ·æ”¯ä»˜æ—¶é—´
    "pay_fee": 1, // æ”¯ä»˜é‡‘é¢ï¼ˆåˆ†ï¼‰
    "plugin_id": "FFFFFFFF",
    "status": 10, // æ˜¯å¦æ”¯ä»˜ï¼ˆ0: æœªæ”¯ä»˜ï¼Œ10: å·²æ”¯ä»˜ï¼‰
    "timestamp": 1624346603 // è¯·æ±‚å‘é€æ—¶é—´æˆ³
  },
  "sign": "xxx"
}
```

::: warning æ³¨æ„äº‹é¡¹

1. å½“å¤„ç†å®Œæˆåï¼Œè¯·è¿”å›å­—ç¬¦ä¸² SUCCESS
2. å¦‚æœè¿”å›å€¼ä¸ºå…¶ä»–ï¼ŒuTools ä¼šå»¶æ—¶åå†æ¬¡é€šçŸ¥ï¼Œæœ€å¤šé€šçŸ¥ 5 æ¬¡ï¼Œæ—¶é—´é—´éš” [15, 30, 60, 300, 600] ç§’ã€‚
3. é€šçŸ¥æœ€é•¿ç­‰å¾… 10 ç§’ã€‚
4. é¿å…æ¶ˆæ¯ä¼ªé€ ï¼Œè¯·åŠ¡å¿…éªŒè¯ signï¼Œç­¾åæ–¹å¼ä¸è·å–ç”¨æˆ·åŸºç¡€ä¿¡æ¯æ¥å£ 1.3 ä¸€è‡´

:::


ä»¥ä¸‹æ˜¯AI Anywhereçš„READMEæ–‡ä»¶
# [Anywhere](https://github.com/Komorebi-yaodong/Anywhere)

**ä½ çš„æ™ºèƒ½å¿«æ·AIåŠ©æ‰‹ï¼Œéšæ—¶éšåœ°ï¼Œä¾¿æ·å¬å”¤AIï¼ˆæ”¯æŒMCPï¼‰ï¼**

Anywhereï¼Œä¸€æ¬¾åŠŸèƒ½å¼ºå¤§ã€é«˜æ•ˆå®ç”¨çš„AIåŠ©æ‰‹ï¼Œæ—¨åœ¨ä¸ºä½ æä¾›å“è¶Šçš„AIæœåŠ¡ä½“éªŒã€‚æ— è®ºæ˜¯æ—¥å¸¸å­¦ä¹ ã€å·¥ä½œã€åˆ›æ„æ¢ç´¢ï¼Œè¿˜æ˜¯å®ç°åˆ’è¯ç¿»è¯‘ã€å˜é‡åå‘½åã€OCRã€æ–‡ä»¶æ€»ç»“ã€éŸ³é¢‘è½¬å½•ï¼Œç”šè‡³AIç»˜å›¾ï¼Œå®ƒéƒ½èƒ½æˆä¸ºä½ çš„å¾—åŠ›åŠ©æ‰‹ã€‚

åŒæ—¶ï¼ŒAnywhere ä¹Ÿå¯ä½œä¸ºAIæœåŠ¡å•†çš„é›†æˆå¹³å°ï¼Œæˆ–ä¸ªäººæç¤ºè¯çš„ç†æƒ³å­˜å‚¨ä¸ç®¡ç†å·¥å…·ã€‚

---

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹ä¸ä½“éªŒ

é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼Œä½ å¯ä»¥ç«‹å³å…è´¹ä½“éªŒAnywhereçš„å¼ºå¤§åŠŸèƒ½ï¼š

1. **AI Studioï¼ˆGoogleå…è´¹æä¾›Gemini APIï¼Œæ¨èï¼‰**

   * è®¿é—®[https://aistudio.google.com/apikey](https://aistudio.google.com/apikey)ç”³è¯·ä½ çš„APIå¯†é’¥
   * åœ¨Anywhereåº”ç”¨ä¸­å¡«å…¥URLï¼Œä½¿ç”¨geminiå®˜æ–¹url `https://generativelanguage.googleapis.com/v1beta/openai`æˆ–è€…ä½¿ç”¨ä½œè€…æä¾›çš„ä¸­è½¬æ¥å£ `https://gemini-oai.141277.xyz/v1`ã€`https://gemini-oai-cf.141277.xyz/v1`ï¼ˆå¤‡ç”¨æ¥å£ï¼‰ã€‚
   * åœ¨Anywhereåº”ç”¨ä¸­å¡«å…¥KEYï¼š`ä½ çš„å¯†é’¥`
   * **æ¨¡å‹åç¼€åŠŸèƒ½**ï¼šåœ¨æ‰‹åŠ¨æ·»åŠ æ¨¡å‹æ—¶ï¼Œä¸ºæ¨¡å‹åç§°å¢åŠ åç¼€ä»¥å¯ç”¨ç‰¹æ®ŠåŠŸèƒ½ï¼ˆéœ€ä¸­è½¬ç«™æ”¯æŒï¼‰ï¼š
     * `:search` - è”ç½‘æœç´¢æ¨¡å‹ï¼ˆè°ƒç”¨Googleæœç´¢ï¼‰
     * `:url` - ç½‘é¡µè¯»å–æ¨¡å‹ï¼ˆè¯»å–ç”¨æˆ·è¾“å…¥çš„ç½‘é¡µï¼‰
     * `:execode` - ä»£ç æ‰§è¡Œæ¨¡å‹ï¼ˆæ‰§è¡Œä»£ç ï¼‰
     * ä¾‹å¦‚ï¼š`gemini-1.5-flash-latest:search`
2. **OpenAIï¼ˆéœ€ç”³è¯·å¯†é’¥ï¼Œå…è´¹è´¦å·å¯ä»¥ä½¿ç”¨å…è´¹æ¨¡å‹ï¼‰**ï¼š

   * è®¿é—®[https://platform.openai.com/api-keys](https://platform.openai.com/api-keys)ç”³è¯·ä½ çš„APIå¯†é’¥ã€‚
   * åœ¨Anywhereåº”ç”¨ä¸­å¡«å…¥URLï¼š`https://api.openai.com/v1`ã€‚
   * åœ¨Anywhereåº”ç”¨ä¸­å¡«å…¥KEYï¼š`ä½ çš„å¯†é’¥`ã€‚
   * å…è´¹ä½¿ç”¨ `gpt-4o-mini`ï¼ˆæ”¯æŒè¯»å–PDFï¼ï¼‰
3. **OpenRouterï¼ˆæ¨èå…è´¹ä½“éªŒï¼‰**ï¼š

   * è®¿é—®[https://openrouter.ai](https://openrouter.ai)ç”³è¯·ä½ çš„APIå¯†é’¥ã€‚
   * åœ¨Anywhereåº”ç”¨ä¸­å¡«å…¥URLï¼š`https://openrouter.ai/api/v1`ã€‚
   * åœ¨Anywhereåº”ç”¨ä¸­å¡«å…¥KEYï¼š`ä½ çš„å¯†é’¥`ã€‚
4. **Pollinationsï¼ˆæ— éœ€å¯†é’¥ï¼‰**ï¼š

   * ç›´æ¥åœ¨Anywhereåº”ç”¨ä¸­å¡«å…¥URLï¼š`https://text.pollinations.ai/openai`ï¼Œå³å¯è½»æ¾ä½“éªŒOpenAIæ¨¡å‹ï¼Œæ— éœ€é¢å¤–é…ç½®å¯†é’¥
   * åœ¨ `https://auth.pollinations.ai`é¡µé¢è·å–tokenï¼ˆå³å¯†é’¥ï¼‰ï¼Œæˆ–è€…å¿½è§†è¿™ä¸€æ­¥
   * `openai-audio`æ”¯æŒè¯­éŸ³å›å¤ï¼Œé€‰æ‹©OpenAIæ”¯æŒçš„å£°éŸ³å³å¯è¯­éŸ³èŠå¤©

**ä½œè€…å¸¸ç”¨æç¤ºè¯åº“**ï¼š
è®¿é—® `https://komorebi.141277.xyz`è·å–å¹¶ä½¿ç”¨ä½œè€…å¸¸ç”¨çš„æç¤ºè¯åº“ï¼ˆéœ€ç½‘ç»œè®¿é—®GitHubï¼‰ã€‚

æ¨èä»¥ä¸‹MCPå¹³å°ï¼š

* [é­”æ­ï¼ˆModelScopeï¼‰MCPå¹³å°](https://modelscope.cn/mcp)ï¼Œå»ºè®®åªæ˜¯ç”¨å…¶hostedçš„MCPæœåŠ¡ï¼Œéœ€è¦æœ¬åœ°éƒ¨ç½²çš„MCPæœåŠ¡èƒ½åœ¨å…¶ä»–å¹³å°æ‰¾åˆ°æ›´å¥½çš„~
* [Lobehubå¹³å°çš„MCPå¸‚åœº](https://lobehub.com/zh/mcp)ï¼Œç²¾é€‰MCPï¼Œç”šè‡³è¿˜æœ‰è¯„åˆ†æœºåˆ¶ï¼Œæ¨è~
* [MCP Hub](https://mcphub.com/mcp-servers)ï¼Œæä¾›å¤§é‡äº‘ç«¯MCPï¼Œæ³¨å†Œåå³å¯ä½¿ç”¨ï¼Œï¼ˆ50000æ¬¡å·¥å…·è°ƒç”¨é¢åº¦ï¼Œå¯ä»¥è‡ªå·±éƒ¨ç½²ï¼‰ï¼Œæ¨è~
* [Glamaå¹³å°çš„MCPå¸‚åœº](https://glama.ai/mcp/servers)ï¼Œå¤§è€Œå…¨ï¼Œä¹Ÿæœ‰è¯„åˆ†æœºåˆ¶ï¼Œæ¨è~
* [GitHub MCPæ¨è](https://github.com/punkpeye/awesome-mcp-servers/blob/main/README-zh.md)ï¼ŒGitHubå…¬å¼€MCPæ¨èä»“åº“ï¼Œå€¼å¾—å‚è€ƒ

---

## ğŸ’¡ æ ¸å¿ƒåŠŸèƒ½äº®ç‚¹

### ä¸€ã€ä¾¿æ·æ™ºèƒ½äº¤äº’

1. **ä¸€é”®è°ƒç”¨AI**ï¼š
   * è®¾ç½®å¿«æ·åŠ©æ‰‹åï¼Œå¯é€šè¿‡åŠŸèƒ½æŒ‡ä»¤ã€åŒ¹é…æŒ‡ä»¤æˆ–è‡ªå®šä¹‰å¿«æ·é”®å¿«é€Ÿæ‰“å¼€å¯¹è¯çª—å£ã€‚
   * **æ™ºèƒ½è¾“å…¥**ï¼šé€‰ä¸­æˆ–å¤åˆ¶æ–‡æœ¬/æ–‡ä»¶ï¼Œæˆ–æˆªå›¾åï¼Œè°ƒç”¨å¿«æ·æ–¹å¼å³å¯å¿«é€Ÿå¤„ç†ã€‚æˆªå›¾å‹åŠ©æ‰‹åœ¨æ— å›¾ç‰‡è¾“å…¥æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨æˆªå›¾åŠŸèƒ½ã€‚
   * **çª—å£æ¨¡å¼**ä¸‹ï¼Œæ‰“å¼€æ–‡ä»¶ä¸ä¼šç«‹å³å‘é€ï¼Œå¯åœ¨å¿«æ·åŠ©æ‰‹ä¸­é…ç½®æ˜¯å¦ç›´æ¥å‘é€ã€‚
2. **å¤šæ¨¡æ€ä¸è¯­éŸ³äº¤äº’**ï¼š
   * **è¯­éŸ³è¾“å…¥**ï¼šç‚¹å‡»éº¦å…‹é£æŒ‰é’®å¯é€‰æ‹© **ğŸ™ï¸ éº¦å…‹é£** æˆ– **ğŸ’» ç³»ç»ŸéŸ³é¢‘** ä½œä¸ºéŸ³æºï¼Œå®ç°æ›´çµæ´»çš„è¯­éŸ³è¾“å…¥ã€‚
   * **è¯­éŸ³è¾“å‡º**ï¼šä¸ºå¿«æ·åŠ©æ‰‹é…ç½®é»˜è®¤å£°éŸ³è§’è‰²åï¼ŒAIçš„å›å¤å°†ä»¥è¯­éŸ³å½¢å¼æ’­æ”¾ï¼Œå¹¶æ”¯æŒåœ¨å¯¹è¯ç•Œé¢ä¸­æš‚åœã€é‡æ’­ã€‚
3. **çµæ´»è¾“å‡ºæ¨¡å¼**ï¼šAIç”Ÿæˆç»“æœå¯ç›´æ¥ä½œä¸ºæ–‡æœ¬è¾“å…¥åˆ°å½“å‰åº”ç”¨ä¸­ã€å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œæˆ–é€šè¿‡ç‹¬ç«‹çš„çª—å£æ¨¡å¼å±•ç¤ºã€‚
4. **å…¨æ–°è¾“å…¥æ¡†ä½“éªŒ**ï¼šå¯¹è¯çª—å£è¾“å…¥æ¡†é‡‡ç”¨å…¨æ–°å‚ç›´å¸ƒå±€ï¼Œ**é‡æ–°èšç„¦çª—å£æ—¶ï¼Œè¾“å…¥æ¡†ä¼šè‡ªåŠ¨æ¿€æ´»å¹¶æ¢å¤ä¸Šæ¬¡çš„å…‰æ ‡ä½ç½®ï¼Œæ— ç¼è¡”æ¥ä½ çš„æ€è·¯**ã€‚

### äºŒã€æ²‰æµ¸å¼å¯¹è¯ä¸æ˜¾ç¤º

1. **å¤šè½®å¯¹è¯è¿½é—®**ï¼šçª—å£æ¨¡å¼æ”¯æŒæŒç»­çš„å¯¹è¯äº¤æµï¼Œä½ å¯ç›´æ¥è¾“å…¥æ–‡å­—ã€ç²˜è´´å›¾ç‰‡æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶ã€‚é€šè¿‡ **`Enter` æˆ– `Ctrl+Enter`ï¼ˆå¯åœ¨è®¾ç½®ä¸­åˆ‡æ¢ï¼‰**å‘é€ä¿¡æ¯ã€‚
2. **å¯¹è¯ç¼–è¾‘ä¸è°ƒæ•´**ï¼š
   * **æ¶ˆæ¯ç¼–è¾‘**ï¼šæ”¯æŒç›´æ¥ç¼–è¾‘å·²å‘é€çš„ç”¨æˆ·æ¶ˆæ¯æˆ–AIå›å¤ï¼Œæ–¹ä¾¿å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œå¾®è°ƒå’Œä¿®æ­£ã€‚
   * **ç³»ç»Ÿæç¤ºè¯ç¼–è¾‘**ï¼šåœ¨å¯¹è¯ä¸­å¯éšæ—¶ç¼–è¾‘å½“å‰åŠ©æ‰‹çš„ç³»ç»Ÿæç¤ºè¯ã€‚å¦‚æœå½“å‰å¯¹è¯å¹¶éåŸºäºå·²ä¿å­˜çš„å¿«æ·åŠ©æ‰‹ï¼Œç¼–è¾‘åä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºä¸€ä¸ªæ–°çš„å¿«æ·åŠ©æ‰‹ã€‚
3. **ä¸°å¯Œå†…å®¹æ¸²æŸ“**ï¼š
   * æ”¯æŒMarkdownæ¸²æŸ“ï¼ŒåŒ…æ‹¬**å…¬å¼(KaTeX)**ã€**æµç¨‹å›¾(Mermaid)**ã€ä»£ç é«˜äº®å’Œå¯äº¤äº’çš„HTMLå†…å®¹ã€‚
   * **è§†è§‰ä¼˜åŒ–**ï¼šç”¨æˆ·ä¸AIçš„å¯¹è¯æ°”æ³¡å¢åŠ äº†é¢œè‰²åŒºåˆ†ï¼Œä¸Šä¸‹æ–‡æ›´åˆ†æ˜ï¼›ä»£ç å—é¡¶éƒ¨å’Œåº•éƒ¨æä¾›ä¸€é”®å¤åˆ¶æŒ‰é’®ã€‚
4. **èˆ’é€‚è§†è§‰ä½“éªŒ**ï¼šæ”¯æŒå…¨å±€**æµ…è‰²/æš—è‰²ä¸»é¢˜åˆ‡æ¢**ï¼Œå¹¶ä¼˜åŒ–äº†ä¸»é¢˜æ ·å¼ï¼Œå‘OpenAIé£æ ¼çœ‹é½ã€‚
5. **å¯¹è¯ç®¡ç†**ï¼šæ”¯æŒ**æ— è®°å¿†å¯¹è¯**ã€**å¯¹è¯æŠ˜å /å±•å¼€**ï¼Œæ–¹ä¾¿å¿«é€Ÿæµè§ˆä¸Šä¸‹æ–‡ã€‚

### ä¸‰ã€é«˜åº¦è‡ªå®šä¹‰ä¸ç®¡ç†

1. **æ•°æ®äº‘åŒæ­¥ä¸æœ¬åœ°ç®¡ç†**ï¼š
   * **æœ¬åœ°å¯¹è¯ç®¡ç†**ï¼šåœ¨è®¾ç½®ä¸­æŒ‡å®šæœ¬åœ°è·¯å¾„åï¼Œå¯ç›´æ¥ç®¡ç†æœ¬åœ°å¯¹è¯è®°å½•ï¼Œå¹¶ä¸äº‘ç«¯ï¼ˆWebDAVï¼‰è¿›è¡ŒåŒæ­¥ã€‚
   * **é‡è¦å¯¹è¯è‡ªåŠ¨ä¿å­˜**ï¼šå¯¹äºå·²å‘½åï¼ˆé€šè¿‡åŠ è½½æˆ–ä¿å­˜ï¼‰çš„å¯¹è¯ï¼Œæ¯éš”15ç§’ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œé˜²æ­¢å†…å®¹ä¸¢å¤±ã€‚
   * **æ•°æ®å¯¼å…¥å¯¼å‡º**ï¼šæ”¯æŒç”¨æˆ·é…ç½®æ•°æ®çš„å¯¼å‡ºä¸å¯¼å…¥ï¼Œæ”¯æŒ**WebDAV**äº‘ç«¯å¤‡ä»½ä¸æ¢å¤ã€‚
2. **ä¸ªæ€§åŒ–å¿«æ·åŠ©æ‰‹**ï¼š
   * æ”¯æŒè‡ªå®šä¹‰æç¤ºè¯ï¼Œå¹¶å¯æ ¹æ®å‘é€å†…å®¹ç±»å‹ï¼ˆæ–‡å­—ã€æˆªå›¾ã€æ–‡ä»¶å’Œé€šç”¨ï¼‰é€‰æ‹©ä¸åŒçš„æäº¤æ–¹å¼ã€‚
   * **å›¾æ ‡ç®¡ç†**ï¼šæ”¯æŒè‡ªå®šä¹‰å¿«æ·åŠ©æ‰‹å›¾æ ‡ï¼Œå¹¶å¯ä¸‹è½½å·²è®¾ç½®çš„å›¾æ ‡è¿›è¡Œå¤‡ä»½ã€‚
   * **æ‰¹é‡æ¨¡å‹æ›¿æ¢**ï¼šåœ¨æœåŠ¡å•†æ›´æ–°æ¨¡å‹åï¼Œå¯åœ¨å¿«æ·åŠ©æ‰‹é¡µé¢ä¸€é”®æ›¿æ¢æ‰€æœ‰ä½¿ç”¨æ—§æ¨¡å‹çš„åŠ©æ‰‹ã€‚
3. **æœåŠ¡å•†ä¸æ¨¡å‹ç®¡ç†**ï¼š
   * æ”¯æŒé…ç½®å…¼å®¹OpenAI APIæ ¼å¼çš„è‡ªå®šä¹‰APIåœ°å€å’Œæ¨¡å‹ã€‚
   * **å¤šå¯†é’¥è½®è¯¢**ï¼šæ”¯æŒè®¾ç½®å¤šä¸ªAPIå¯†é’¥ï¼ˆè‹±æ–‡é€—å·åˆ†éš”ï¼‰ï¼ŒAnywhereå°†éšæœºè°ƒç”¨ï¼Œæé«˜å¯ç”¨æ€§ã€‚
   * **æ¨¡å‹æ‹–æ‹½æ’åº**ï¼šåœ¨æœåŠ¡å•†é¡µé¢ï¼Œå¯æ‹–æ‹½æ¨¡å‹åˆ—è¡¨è¿›è¡Œæ’åºã€‚
4. **è‡ªå®šä¹‰UIå¤–è§‚**ï¼š
   * **è®¾ç½®é¡µé¢é‡‡ç”¨å…¨æ–°çš„å¡ç‰‡å¼è®¾è®¡**ï¼Œå¸ƒå±€æ›´æ¸…æ™°ã€æ›´æ˜“ç”¨ã€‚
   * æ”¯æŒè‡ªå®šä¹‰å¿«æ·åŠ©æ‰‹åˆ†ç±»æ ‡ç­¾ï¼Œæ‰“é€ ä¸“å±çš„æ“ä½œç•Œé¢ã€‚
   * **æ”¯æŒåœ¨è®¾ç½®ä¸­è‡ªå®šä¹‰ç®¡ç†å¯ç”¨çš„å£°éŸ³è§’è‰²åˆ—è¡¨**ã€‚

### å››ã€ä¸ªæ€§åŒ–çª—å£è®¾ç½®

1. **ç‹¬ç«‹çª—å£é…ç½®**ï¼šæ¯ä¸ªå¿«æ·åŠ©æ‰‹éƒ½å¯ä»¥ç‹¬ç«‹é…ç½®å…¶çª—å£è¡Œä¸ºï¼ŒåŒ…æ‹¬**é»˜è®¤å¤§å°ã€å‡ºç°ä½ç½®ã€æ˜¯å¦ç½®é¡¶ã€æ˜¯å¦åœ¨å¤±ç„¦åè‡ªåŠ¨æ¶ˆå¤±**ä»¥åŠæ˜¯å¦å¼€å¯æµå¼ä¼ è¾“ã€‚
2. **å…¨å±€æ§åˆ¶ä¸å›ºå®šä½ç½®**ï¼šè®¾ç½®é¡µé¢çš„â€œå…¨å±€çª—å£ç½®é¡¶â€å’Œâ€œå…¨å±€å¤±ç„¦å…³é—­â€å¯ä¸€é”®åº”ç”¨åˆ°æ‰€æœ‰å¿«æ·åŠ©æ‰‹ã€‚å¯ç”¨â€œå›ºå®šçª—å£ä½ç½®â€åï¼Œç‚¹å‡»æ¨¡å‹åç§°å·¦ä¾§å›¾æ ‡å¯æ›´æ–°é»˜è®¤çª—å£çš„å‡ºç°ä½ç½®ã€‚
3. **æ™ºèƒ½æ»šåŠ¨ä¸å¯¼èˆª**ï¼šå½“ä½ å‘ä¸Šæ»šåŠ¨æŸ¥çœ‹å†å²è®°å½•æ—¶ï¼Œå³ä¸‹è§’ä¼šæµ®ç°å¯¼èˆªæŒ‰é’®ï¼Œå¸®åŠ©ä½ å¿«é€Ÿå®šä½åˆ°**ä¸Šä¸€æ¡/ä¸‹ä¸€æ¡æ¶ˆæ¯**ï¼Œæˆ–**ä¸€é”®è¿”å›å¯¹è¯åº•éƒ¨**ã€‚
4. **çª—å£ç¼©æ”¾**ï¼šåœ¨ç‹¬ç«‹å¯¹è¯çª—å£ä¸­ï¼ŒæŒ‰ä½ `Ctrl` å¹¶æ»šåŠ¨é¼ æ ‡æ»šè½®ï¼Œå¯ä»¥å®æ—¶ç¼©æ”¾çª—å£å†…å®¹ã€‚çª—å£çš„ç¼©æ”¾æ¯”ä¾‹ä¼šè‡ªåŠ¨ä¿å­˜ã€‚

### äº”ã€é«˜çº§åŠŸèƒ½ï¼šMCP (æ¨¡å‹ä¸Šä¸‹æ–‡åè®®)

1. **åŸºäº Function Call**ï¼šAnywhere é‡ç£…é›†æˆ MCP åŠŸèƒ½ï¼ŒåŸºäºç²¾å‡†çš„ Function Calling å®ç°ï¼Œè€Œéä¼ ç»Ÿçš„æç¤ºè¯å·¥ç¨‹ï¼Œè®©AIèƒ½å¤Ÿæ›´é«˜æ•ˆã€æ›´å‡†ç¡®åœ°è°ƒç”¨å¤–éƒ¨å·¥å…·ã€‚
2. **èµ„æºç®¡ç†ä¼˜åŒ–**ï¼šé‡‡ç”¨éšç”¨éšåŠ è½½çš„ç­–ç•¥ï¼Œå·§å¦™ç»•è¿‡ uTools å¯¹æŒä¹…è¿æ¥æ•°é‡ï¼ˆ5ä¸ªï¼‰çš„é™åˆ¶ã€‚ç°åœ¨ä½ å¯ä»¥é…ç½®ä»»æ„æ•°é‡çš„ MCP æœåŠ¡ï¼ŒAnywhere ä¼šæ™ºèƒ½ç®¡ç†è¿æ¥ï¼Œä¿è¯æµç•…ä½“éªŒã€‚
3. **é»˜è®¤æœåŠ¡å…³è”**ï¼šå¯åœ¨å¿«æ·åŠ©æ‰‹ä¸­è®¾ç½®â€œé»˜è®¤MCPæœåŠ¡â€ï¼Œå¯åŠ¨ç‹¬ç«‹çª—å£æ—¶å°†è‡ªåŠ¨åŠ è½½å¹¶å…³è”æŒ‡å®šçš„å·¥å…·ã€‚

### å…­ã€æ”¯æŒçš„æ–‡ä»¶ç±»å‹

1. **å¤šæ–‡ä»¶å¤„ç†**ï¼šæ”¯æŒé€šè¿‡**æ‹–æ‹½ã€ç²˜è´´ã€ä¸Šä¼ **æ–¹å¼åŒæ—¶å¤„ç†å¤šä¸ªæ–‡ä»¶ã€‚
2. **å¯è‡ªåŠ¨è§£æä¸ºæ–‡æœ¬**çš„æ–‡ä»¶ï¼š
   * å¸¸è§„æ–‡æœ¬æ–‡æ¡£ï¼š`.txt`, `.md`, `.markdown`, `.json`, `.xml`, `.html`, `.css`, `.csv`
   * Officeæ–‡æ¡£ï¼š**`.docx`**, **`.xlsx`**, **`.xls`**
   * å„ç±»ä»£ç æ–‡ä»¶ï¼š`.py`, `.js`, `.ts`, `.java`, `.c`, `.cpp`, `.h`, `.hpp`, `.cs`, `.go`, `.php`, `.rb`, `.rs`, `.sh`, `.sql`, `.vue`
3. éœ€è¦**æ¨¡å‹æ”¯æŒï¼ˆå¤šæ¨¡æ€ï¼‰**çš„æ–‡ä»¶ï¼š
   * å›¾ç‰‡æ–‡ä»¶ï¼š`.png`, `.jpg`, `.jpeg`, `.webp`
   * éŸ³é¢‘æ–‡ä»¶ï¼š`.mp3`, `.wav`
   * æ–‡æ¡£æ–‡ä»¶ï¼š`.pdf`ï¼ˆ**æç¤ºï¼šPDFæ–‡ä»¶ç°å·²ä¼˜åŒ–ï¼Œè°ƒç”¨æ¨¡å‹åŸç”Ÿæ¥å£å¤„ç†ï¼Œæ•ˆæœæ›´ä½³**ï¼‰
   * å¯¹äºå¯¹è¯è®°å½•çš„ `.json`æ–‡ä»¶ï¼Œä½¿ç”¨çª—å£æ¨¡å¼åŠ è½½å°†ä¼šç›´æ¥æ‰“å¼€ä¿å­˜çš„å¯¹è¯ï¼Œè€Œéæ–°çš„å¯¹è¯ï¼Œæ³¨æ„ç»§ç»­å¯¹è¯ä¸ä¼šæ›´æ”¹å·²ä¿å­˜çš„å¯¹è¯ã€‚

### ä¸ƒã€è¯­éŸ³è¾“å‡ºæ¨¡å‹å£°éŸ³è§’è‰²ï¼ˆä¸ªäººæ€»ç»“+ç½‘ç»œæ‘˜å½•ï¼Œæ¬¢è¿åˆ†äº«è¡¥å……ï¼‰

> æ³¨æ„è¾“å…¥å£°éŸ³IDï¼Œå¦‚ `alloy`ï¼Œè€Œä¸æ˜¯ `Alloy`ï¼Œå¯ç”¨ `å£°éŸ³-è‡ªå®šä¹‰æè¿°`æ ¼å¼è®°å½•ï¼Œæœ‰æ•ˆéƒ¨åˆ†ä¸ºè¿æ¥ç¬¦å‰åŠéƒ¨åˆ†

1. **OpenAI**ï¼š

```json
   [
      "alloy-ğŸ‘©",
      "echo-ğŸ‘¨â€ğŸ¦°æ¸…æ™°",
      "nova-ğŸ‘©æ¸…æ™°",
      "sage-ğŸ‘§å¹´è½»",
      "shimmer-ğŸ‘§æ˜äº®",
      "fable-ğŸ˜ä¸­æ€§",
      "coral-ğŸ‘©å®¢æœ",
      "ash-ğŸ§”â€â™‚ï¸å•†ä¸š",
      "ballad-ğŸ‘¨æ•…äº‹",
      "verse-ğŸ‘¨è¯—æ­Œ",
      "onyx-ğŸ‘¨â€ğŸ¦°æ–°é—»"
   ]
```

2. **Gemini**ï¼š

```json
   [
      "Zephyr-ğŸ‘§æ˜äº®",
      "Puck-ğŸ‘¦æ¬¢å¿«",
      "Charon-ğŸ‘¦ä¿¡æ¯ä¸°å¯Œ",
      "Kore-ğŸ‘©åšå®š",
      "Fenrir-ğŸ‘¨â€ğŸ¦°æ˜“æ¿€åŠ¨",
      "Leda-ğŸ‘§å¹´è½»",
      "Orus-ğŸ‘¨â€ğŸ¦°é‰´å®š",
      "Aoede-ğŸ‘©è½»æ¾",
      "Callirrhoe-ğŸ‘©éšå’Œ",
      "Autonoe-ğŸ‘©æ˜äº®",
      "Enceladus-ğŸ§”â€â™‚ï¸å‘¼å¸æ„Ÿ",
      "Iapetus-ğŸ‘¦æ¸…æ™°",
      "Umbriel-ğŸ‘¦éšå’Œ",
      "Algieba-ğŸ‘¦å¹³æ»‘",
      "Despina-ğŸ‘©å¹³æ»‘",
      "Erinome-ğŸ‘©æ¸…æ™°",
      "Algenib-ğŸ‘¨â€ğŸ¦°æ²™å“‘",
      "Rasalgethi-ğŸ‘¨â€ğŸ¦°ä¿¡æ¯ä¸°å¯Œ",
      "Laomedeia-ğŸ‘©æ¬¢å¿«",
      "Achernar-ğŸ‘©è½»æŸ”",
      "Alnilam-ğŸ‘¦åšå®š",
      "Schedar-ğŸ‘¦å¹³ç¨³",
      "Gacrux-ğŸ‘©æˆç†Ÿ",
      "Pulcherrima-ğŸ‘©å‘å‰",
      "Achird-ğŸ‘¦å‹å¥½",
      "Zubenelgenubi-ğŸ‘¦ä¼‘é—²",
      "Vindemiatrix-ğŸ‘©æ¸©æŸ”",
      "Sadachbia-ğŸ‘¨â€ğŸ¦°æ´»æ³¼",
      "Sadaltager-ğŸ‘¨â€ğŸ¦°åšå­¦",
      "Sulafat-ğŸ‘©æ¸©æš–"
   ]
```

---

## âœ¨ é¡µé¢å±•ç¤º

![å¿«æ·è¾“å…¥æ¨¡å¼](image/å¿«æ·è¾“å…¥æ¨¡å¼-æ·±è‰².gif)

*è¾“å…¥æ¡†æ¨¡å¼åŠŸèƒ½*

![ç‹¬ç«‹çª—å£æ¨¡å¼](image/ç‹¬ç«‹å¯¹è¯çª—å£ç•Œé¢.gif)
![è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡](image/èƒŒæ™¯å›¾ç‰‡ç¤ºä¾‹.png)

*çª—å£æ¨¡å¼ç¤ºä¾‹*

![æŒ‡ä»¤è°ƒç”¨](image/æŒ‡ä»¤è°ƒç”¨.png)

*æŒ‡ä»¤è°ƒç”¨*

![å¿«æ·è°ƒç”¨æ–¹æ³•](image/å¿«æ·è°ƒç”¨æ–¹æ³•.png)

*å¿«æ·è°ƒç”¨æ–¹æ³•*

![äº‘ç«¯å¯¹è¯ç®¡ç†é¡µé¢](image/å¯¹è¯ç®¡ç†ç•Œé¢.png)

*å¯¹è¯ç®¡ç†é¡µé¢ï¼ˆæœ¬åœ°|äº‘ç«¯ï¼‰*

![å¿«æ·åŠ©æ‰‹ç•Œé¢](image/å¿«æ·åŠ©æ‰‹ç•Œé¢.png)

*å¿«æ·åŠ©æ‰‹é¡µé¢*

![MCPç®¡ç†ç•Œé¢](image/MCPç®¡ç†ç•Œé¢.png)

*MCPç®¡ç†é¡µé¢*

![æœåŠ¡å•†é¡µé¢](image/æœåŠ¡å•†ç•Œé¢.png)

*æœåŠ¡å•†é¡µé¢*

![è®¾ç½®ç•Œé¢](image/è®¾ç½®ç•Œé¢.png)

*è®¾ç½®ç•Œé¢*

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è™šæ‹Ÿæœºå…¼å®¹æ€§**ï¼šAnywhereä½¿ç”¨utoolså†…ç½®APIå®ç°æ¨¡æ‹Ÿè¾“å…¥ï¼Œå¯èƒ½å¯¹è™šæ‹Ÿæœºç¯å¢ƒå…¼å®¹æ€§ä¸ä½³ï¼Œè‡ªåŠ¨è¾“å…¥å¯èƒ½å¯¼è‡´æ–‡æœ¬é‡å¤ï¼Œè¯·é¿å…åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨ã€‚
2. **Markdownè¾“å‡ºå†²çª**ï¼šç”±äºAIè‡ªåŠ¨å›å¤é»˜è®¤æ˜¯Markdownæ ¼å¼ï¼Œä¸”å¤§å¤šMarkdownè½¯ä»¶ä¼šè‡ªåŠ¨è¡¥å…¨ç”¨æˆ·æ ¼å¼ï¼ˆä¾‹å¦‚åˆ—è¡¨å°¾éƒ¨æ¢è¡Œåè‡ªåŠ¨å¢åŠ åºå·ï¼Œè€ŒAIçš„å›å¤å¹¶ä¸ä¼šæ³¨æ„åˆ°è¿™ä¸€ç‚¹ï¼‰ã€‚åœ¨é€‰æ‹©â€œè¾“å…¥æ¡†â€æ¨¡å¼æ—¶ï¼Œè¿™å¯èƒ½äº§ç”Ÿå†²çªï¼Œå»ºè®®ä½¿ç”¨Markdownçš„æºç æ¨¡å¼æ¥é¿å…ã€‚
3. **ç‹¬ç«‹çª—å£ä¸è®¾ç½®**ï¼šå½“å¼€å¯â€œè‡ªåŠ¨åˆ†ç¦»ä¸ºç‹¬ç«‹çª—å£â€åŠŸèƒ½æ—¶ï¼Œæ–‡æœ¬ç”ŸæˆæœŸé—´å¯¼è‡´è®¾ç½®ç•Œé¢å¼¹å‡ºã€‚
4. **æ–‡ä»¶ä¸Šä¼ æŠ¥é”™**ï¼šä¸Šä¼ çš„æ¨¡å‹ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹å¯èƒ½ä¼šå¯¼è‡´AIå¤„ç†æŠ¥é”™ï¼Œè¯·ç¡®ä¿é€‰æ‹©çš„æ¨¡å‹ä¸æ–‡ä»¶ç±»å‹å…¼å®¹ï¼Œä¹Ÿè¯·æ³¨æ„æ˜¯å¦æ˜¯æ–‡ä»¶æ ¼å¼ä¿å­˜é”™è¯¯ï¼ˆä¾‹å¦‚mp3æ–‡ä»¶åç§°ä¸ºwavï¼Œæ­¤æ—¶ä¸Šä¼ å¯èƒ½å‡ºé”™ï¼‰ã€‚
5. **å¯¹è¯çª—å£å…³é—­**ï¼šå¦‚æœè®¾ç½®é¡µé¢åˆ†ç¦»ï¼Œå…³é—­è®¾ç½®é¡µé¢ï¼Œå¦‚æœæ­¤æ—¶æœ‰å¼€å¯çš„å¯¹è¯çª—å£ï¼Œä¹Ÿä¼šä¸€å¹¶å…³é—­ã€‚
6. **é…ç½®ä¿å­˜å¤±è´¥**ï¼šUtoolsæ•°æ®åº“å…·æœ‰å¤§å°é™åˆ¶ï¼Œè¯·å°½å¯èƒ½æ§åˆ¶å¿«æ·åŠ©æ‰‹å›¾æ ‡å¤§å°ï¼Œå»ºè®®ä¸º128x128æˆ–æ›´å°ã€‚
7. **Stdio ç±»å‹ MCP**ï¼šéƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒæŒ‡ä»¤å¯èƒ½éœ€è¦è®¾ç½®ä¸ºç»å¯¹è·¯å¾„ï¼Œä¾‹å¦‚ `node`è®¾ç½®ä¸º `/user/local/bin/node`ã€‚
8. **Windows10çª—å£è¾¹ç¼˜ä¸æ˜¾ç¤º**ï¼šæ›´æ–°ç³»ç»Ÿè®¾ç½®ï¼šhttps://jingyan.baidu.com/article/90bc8fc8281fd6b753640cc2.html

---

## ğŸ“– å…¶ä»–å‚è€ƒ

è·å–Utoolsæ’ä»¶åœ°å€ï¼Œè¯·è®¿é—®ï¼š
[AI Anywhereæ’ä»¶åœ°å€](https://www.u-tools.cn/plugins/detail/AI%20Anywhere/)

è·å–æ›´è¯¦ç»†çš„åŠŸèƒ½ä»‹ç»ã€é…ç½®æ­¥éª¤å’Œä½¿ç”¨æŠ€å·§ï¼Œè¯·è®¿é—®ï¼š
[Anywhere æ•™ç¨‹](https://github.com/Komorebi-yaodong/Anywhere/blob/main/Tutorial.md)

å‚è€ƒä½œè€…ä½¿ç”¨çš„æç¤ºè¯ï¼ˆæ¥æºäºè‡ªå·±è®¾è®¡/ç½‘ç»œæ”¶é›†ï¼‰ï¼Œè¯·è®¿é—®ï¼š
[Anywhere æç¤ºè¯ï¼ˆä¸€ç›´æ›´æ–°ï¼‰](https://komorebi.141277.xyz/post?file=posts%2F5.md)

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

### 2025-12-07

- **æ–°å¢**
  - ç‹¬ç«‹å¯¹è¯çª—å£å¢åŠ **æœç´¢åŠŸèƒ½**ï¼ŒCtrl/Cmd+F å”¤é†’
  - ç‹¬ç«‹å¯¹è¯çª—å£å¢åŠ **å¯¼å‡ºhtmlæ–‡æ¡£**çš„åŠŸèƒ½
  - ç‹¬ç«‹å¯¹è¯çª—å£å¢åŠ **ç½®é¡¶æŒ‰é’®**
  - æ–‡æœ¬è¾“å…¥æ¨¡å¼å¯ä»¥**è‡ªå®šä¹‰æ­£åˆ™åŒ¹é…**
  - é€‚é…**å„ç§å¿«æ·é”®**
  - å¯¹**XSS**ä¸**CSRF**æ”»å‡»çš„é˜²èŒƒ
  - **ä¸­è½¬ç«™**æ”¯æŒ**gemini-3-pro**ï¼Œå¯åœ¨AI Anywhereä¸­ä½¿ç”¨ï¼
- **ä¼˜åŒ–**
  - ç•Œé¢å¤§ä¼˜åŒ–ï¼
  - ä¼˜åŒ–MCPè¿æ¥æ–¹å¼ï¼Œæ”¯æŒ**è‡ªåŠ¨æ‰¹å‡†åŠŸèƒ½**
  - ç‹¬ç«‹å¯¹è¯çª—å£çš„ **MCPæœåŠ¡å¼¹çª—** æ‰“å¼€æ—¶å°†è‡ªåŠ¨æ‹‰å–æœ€æ–°é…ç½®
  - ç‹¬ç«‹å¯¹è¯çª—å£çš„ **æ¨¡å‹è®¾ç½®å¼¹çª—** æ‰“å¼€æ—¶å°†è‡ªåŠ¨æ‹‰å–æœ€æ–°é…ç½®

### 2025-11-07

- **æ–°å¢**
  - **æœ¬åœ°å¯¹è¯ç®¡ç†**ï¼šæ”¯æŒåœ¨è®¾ç½®ä¸­æŒ‡å®šæœ¬åœ°å¯¹è¯å­˜å‚¨è·¯å¾„ï¼Œå¯ç›´æ¥ç®¡ç†æœ¬åœ°å¯¹è¯è®°å½•ï¼Œå¹¶ä¸äº‘ç«¯(WebDAV)è‡ªåŠ¨åŒæ­¥æœ€æ–°èŠå¤©è®°å½•ã€‚
  - **é‡è¦å¯¹è¯è‡ªåŠ¨ä¿å­˜**ï¼šå¯¹äºå·²å‘½åï¼ˆé€šè¿‡åŠ è½½æˆ–ä¿å­˜ï¼‰çš„å¯¹è¯ï¼Œæ¯éš”15ç§’ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œé˜²æ­¢å†…å®¹ä¸¢å¤±ã€‚
  - **æˆªå›¾æ™ºèƒ½è°ƒç”¨**ï¼šé€šè¿‡æˆªå›¾è°ƒç”¨å¿«æ·åŠ©æ‰‹æ—¶ï¼Œè‹¥æœªé€‰ä¸­/å¤åˆ¶å›¾ç‰‡ï¼Œå°†è‡ªåŠ¨æ‰“å¼€æˆªå›¾åŠŸèƒ½ã€‚
  - æ”¯æŒä»è®¾ç½®é¡µé¢ç›´æ¥æ‰“å¼€å¿«æ·åŠ©æ‰‹å¯¹è¯çª—å£ã€‚
- **ä¼˜åŒ–**
  - **ç•Œé¢ä¼˜åŒ–**ï¼šä¼˜åŒ–äº†å¿«æ·åŠ©æ‰‹ã€MCPé…ç½®é¡µé¢çš„ä¿¡æ¯å¯†åº¦ä¸æ˜¾ç¤ºæ•ˆæœï¼Œç®¡ç†æ›´èˆ’é€‚ã€‚
  - ä¼˜åŒ–äº†çª—å£æœ€å¤§å®½åº¦é™åˆ¶ã€‚

### 2025-11-04

- **æ–°å¢**
  - **MCP (æ¨¡å‹ä¸Šä¸‹æ–‡åè®®)**ï¼šé‡ç£…å‡çº§ï¼ŒåŸºäºç²¾å‡†é«˜æ•ˆçš„ Function Calling å®ç°ï¼Œéä¼ ç»Ÿæç¤ºè¯å·¥ç¨‹ã€‚
  - **é»˜è®¤MCPæœåŠ¡**ï¼šå¿«æ·åŠ©æ‰‹æ–°å¢â€œé»˜è®¤MCPæœåŠ¡â€é€‰é¡¹ï¼Œç‹¬ç«‹çª—å£å¯åŠ¨æ—¶å¯è‡ªåŠ¨å…³è”MCPå·¥å…·ã€‚
- **ä¼˜åŒ–**
  - **èµ„æºç®¡ç†**ï¼šä¼˜åŒ–MCPå·¥å…·åŠ è½½ç­–ç•¥ï¼Œé‡‡ç”¨éšç”¨éšåŠ è½½æ–¹å¼ï¼Œç¼“è§£Utoolså¯¹MCPåŠ è½½æ•°é‡ï¼ˆ5ä¸ªï¼‰çš„é™åˆ¶ï¼Œå˜ä¸ºæœ€å¤šåŒæ—¶ä½¿ç”¨5ä¸ªMCPã€‚
  - **ç¨³å®šæ€§**ï¼šå¢åŠ éšæœºå¯†é’¥é‡è¯•è¯·æ±‚åŠŸèƒ½ï¼Œæé«˜APIè°ƒç”¨ç¨³å®šæ€§ã€‚
  - **å…¼å®¹æ€§**ï¼šå…¼å®¹å„ç§ä¸è§„èŒƒè¡¨è¿°çš„ `streamable http` æ ¼å¼ã€‚
  - **ä½“éªŒä¼˜åŒ–**ï¼šåˆ‡æ¢æ¨¡å‹ç•Œé¢ã€å¿«æ·åŠ©æ‰‹å¯¹è¯çª—å£æ”¯æŒæœç´¢åŠŸèƒ½ï¼›ç‹¬ç«‹çª—å£æç¤ºæ¶ˆæ¯æ”¯æŒç‚¹å‡»æ¶ˆé™¤ã€‚
- **ä¿®å¤**
  - ä¿®å¤äº†ç‹¬ç«‹çª—å£æŠ˜å çŠ¶æ€ä¸‹åˆ é™¤æ¶ˆæ¯æ—¶ï¼Œçª—å£ä¼šè‡ªåŠ¨å±•å¼€çš„é”™è¯¯ã€‚
  - ä¿®å¤äº†æ€è€ƒæ°”æ³¡æ¶ˆå¤±ã€å¯¼å…¥å¯¹è¯è®°å½•åæ¸…é™¤å†å²å¯¼è‡´ç³»ç»Ÿæç¤ºè¯è¢«æ¸…é™¤ã€å¤±ç„¦è‡ªåŠ¨å…³é—­å¤±æ•ˆã€ç¯å¢ƒå˜é‡ä¸èµ·æ•ˆæœç­‰å¤šä¸ªBugã€‚

### 2025-10-22

- **ä¼˜åŒ–**
  - **AIè°ƒç”¨**ï¼šä¼˜åŒ–AIè°ƒç”¨åŠŸèƒ½ï¼Œæ”¹ç”¨ `openai`åº“ã€‚
  - **ä½“éªŒä¼˜åŒ–**ï¼šä¼˜åŒ–å¯¹è¯ä¸­ä¿å­˜ç³»ç»Ÿæç¤ºè¯çš„åŠŸèƒ½åŠå…¶æ»šåŠ¨æ¡ï¼›å¿«æ·åŠ©æ‰‹è®¾ç½®é¡µé¢å³ä¸‹è§’å¢åŠ åˆ·æ–°æŒ‰é’®ã€‚
- **é€šçŸ¥**
  - æ’ä»¶æ›´æ¢æ–°Logoï¼
  - ä½œè€…çš„å…è´¹ä¸­è½¬ç«™æ–°å¢å¤‡ç”¨URLã€‚

### 2025-10-13

- **æ–°å¢**
  - **å¯¹è¯ç¼–è¾‘**ï¼šå¢åŠ ç¼–è¾‘å·²å‘é€æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œæ–¹ä¾¿è°ƒæ•™AIã€‚
  - **åŠ¨æ€ç³»ç»Ÿæç¤ºè¯**ï¼šæ”¯æŒåœ¨å¯¹è¯ä¸­ç¼–è¾‘ç³»ç»Ÿæç¤ºè¯ï¼Œè‹¥æœ¬åœ°æ²¡æœ‰å¯¹åº”çš„å¿«æ·åŠ©æ‰‹ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºã€‚
- **ä¼˜åŒ–**
  - **ä¸»é¢˜ä¸æ˜¾ç¤º**ï¼šä¸»é¢˜æ ·å¼å‘OpenAIé é½ï¼Œä¼˜åŒ–å›¾ç‰‡æ˜¾ç¤ºã€‚
- **é€šçŸ¥**
  - ä½œè€…çš„ä¸­è½¬ç«™æ–°å¢æ¨¡å‹åç¼€åŠŸèƒ½ï¼ˆ`:search`, `:url`, `:execode`ï¼‰ã€‚

### 2025-09-26

- **ä¼˜åŒ–**
  - **æ¨¡å‹ç®¡ç†**ï¼šå¿«æ·åŠ©æ‰‹ç•Œé¢å¢åŠ æ¨¡å‹æ›¿æ¢åŠŸèƒ½ï¼Œå¯æ‰¹é‡æ›¿æ¢æ—§æ¨¡å‹ã€‚
  - **æ’åºåŠŸèƒ½**ï¼šæœåŠ¡å•†é…ç½®ç•Œé¢æ”¯æŒæ‹–æ‹½è°ƒæ•´æ¨¡å‹é¡ºåºã€‚

### 2025-08-08 ~ 2025-09-25

- **æ–°å¢**
  - **è¯­éŸ³è¾“å…¥æºé€‰æ‹©**ï¼šå‘é€è¯­éŸ³æ—¶ï¼Œèƒ½å¤Ÿé€‰æ‹© **ğŸ™ï¸ éº¦å…‹é£** æˆ– **ğŸ’» ç³»ç»ŸéŸ³é¢‘** ä½œä¸ºéŸ³æºã€‚
  - **å¯¹è¯æ°”æ³¡æ¸²æŸ“**ï¼šä½¿ç”¨ `element-plus-x`åº“æ¸²æŸ“å¯¹è¯æ°”æ³¡ï¼Œæ”¯æŒé¢„è§ˆMermaidå›¾è¡¨ä¸HTMLä»£ç ã€‚
  - **å¿«æ·åŠ©æ‰‹å›¾æ ‡ä¸‹è½½**ï¼šæ”¯æŒä¸‹è½½å·²è®¾ç½®çš„å¿«æ·åŠ©æ‰‹å›¾æ ‡ã€‚
- **ä¼˜åŒ–**
  - **å¿«æ·åŠ©æ‰‹ç‹¬ç«‹é…ç½®**ï¼šæ¯ä¸ªå¿«æ·åŠ©æ‰‹å¯ç‹¬ç«‹é…ç½®çª—å£å¤§å°ã€ä½ç½®ã€æµå¼ä¼ è¾“ã€å¤±ç„¦å…³é—­åŠçª—å£ç½®é¡¶ç­‰è¡Œä¸ºã€‚
  - **æ™ºèƒ½æ»šåŠ¨ä¼˜åŒ–**ï¼šå¯¹è¯çª—å£æ–°å¢ä¸Šä¸‹æ–‡å¯¼èˆªæŒ‰é’®ï¼Œå¯å¿«é€Ÿè·³è½¬è‡³ä¸Š/ä¸‹æ¡æ¶ˆæ¯æˆ–è¿”å›åº•éƒ¨ã€‚
  - **è§†è§‰ä½“éªŒæå‡**ï¼šç”¨æˆ·ä¸AIçš„å¯¹è¯æ°”æ³¡å¢åŠ é¢œè‰²åŒºåˆ†ï¼›ä¼˜åŒ–å…¬å¼æ˜¾ç¤ºå’Œä»£ç æ¡†é¢œè‰²ã€‚
  - **è¾“å…¥æ¡†èšç„¦ä¼˜åŒ–**ï¼šé‡æ–°èšç„¦å¯¹è¯çª—å£æ—¶ï¼Œè¾“å…¥æ¡†å…‰æ ‡å°†è‡ªåŠ¨æ¢å¤åˆ°ä¸Šæ¬¡ç¦»å¼€æ—¶çš„ä½ç½®ã€‚
  - **æ•°æ®å­˜å‚¨**ï¼šä¼˜åŒ–äº†æ•°æ®å­˜å‚¨ç»“æ„ã€‚
- **ä¿®å¤**
  - ä¿®å¤äº†è¾“å…¥æ³•å…¼å®¹æ€§ã€é…ç½®ç«äº‰ã€ç©ºç™½å¿«æ·åŠ©æ‰‹æ ‡ç­¾æ— æ³•åˆ é™¤ã€åˆ é™¤æ¶ˆæ¯åç•Œé¢å¡é¡¿ã€æ¨¡å‹å‚æ•°é…ç½®ã€HTMLæ¸²æŸ“ä¸å…¨ã€è¯­éŸ³è¿ç»­å¯¹è¯ç­‰å¤šä¸ªé—®é¢˜ã€‚

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](LICENSE) å¼€æºã€‚

---


ä»¥ä¸‹æ˜¯é¢„åŠ è½½æ–‡ä»¶å’Œä¸»é¡µé¢,preloadï¼Œpreload.jsæ˜¯ä¸»ç•Œé¢çš„é¢„åŠ è½½æ–‡ä»¶ã€window_preload.jsæ˜¯ç‹¬ç«‹çª—å£ç•Œé¢çš„é¢„åŠ è½½æ–‡ä»¶ï¼Œå…¶å®ƒæ˜¯å…¶ä»–å·¥å…·æ–‡ä»¶
```js
./backend/src/data.js
const { webFrame, nativeImage } = require('electron');
const crypto = require('crypto');
const windowMap = new Map();
const feature_suffix = "anywhereåŠ©æ‰‹^_^"

const {
  requestTextOpenAI
} = require('./input.js');
const { 
  getBuiltinServers
} = require('./mcp_builtin.js');

// é»˜è®¤é…ç½® (ä¿æŒä¸å˜)
const defaultConfig = {
  config: {
    providers: {
      "0": {
        name: "default",
        url: "https://api.openai.com/v1",
        api_key: "",
        modelList: [],
        enable: true,
      },
    },
    providerOrder: ["0",],
    providerFolders: {},
    prompts: {
      AI: {
        type: "over",
        prompt: `ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹`,
        showMode: "window",
        model: "0|gpt-4o",
        enable: true,
        icon: "",
        stream: true,
        temperature: 0.7,
        isTemperature: false,
        isDirectSend_file: false,
        isDirectSend_normal: true,
        ifTextNecessary: false,
        voice: null,
        reasoning_effort: "default",
        defaultMcpServers: [],
        window_width: 580,
        window_height: 740,
        position_x: 0,
        position_y: 0,
        autoCloseOnBlur: true,
        isAlwaysOnTop: true,
        autoSaveChat: false,
      },
    },
    fastWindowPosition: { x: 0, y: 0 },
    mcpServers: {},
    language: "zh",
    tags: {},
    skipLineBreak: false,
    CtrlEnterToSend: false,
    showNotification: true,
    isDarkMode: false,
    fix_position: false,
    isAlwaysOnTop_global: true,
    autoCloseOnBlur_global: true,
    autoSaveChat_global: false,
    zoom: 1,
    webdav: {
      url: "",
      username: "",
      password: "",
      path: "/anywhere",
      data_path: "/anywhere_data",
      localChatPath: ""
    },
    voiceList: [
      "alloy-ğŸ‘©",
      "echo-ğŸ‘¨â€ğŸ¦°æ¸…æ™°",
      "nova-ğŸ‘©æ¸…æ™°",
      "sage-ğŸ‘§å¹´è½»",
      "shimmer-ğŸ‘§æ˜äº®",
      "fable-ğŸ˜ä¸­æ€§",
      "coral-ğŸ‘©å®¢æœ",
      "ash-ğŸ§”â€â™‚ï¸å•†ä¸š",
      "ballad-ğŸ‘¨æ•…äº‹",
      "verse-ğŸ‘¨è¯—æ­Œ",
      "onyx-ğŸ‘¨â€ğŸ¦°æ–°é—»",
      "Zephyr-ğŸ‘§æ˜äº®",
      "Puck-ğŸ‘¦æ¬¢å¿«",
      "Charon-ğŸ‘¦ä¿¡æ¯ä¸°å¯Œ",
      "Kore-ğŸ‘©åšå®š",
      "Fenrir-ğŸ‘¨â€ğŸ¦°æ˜“æ¿€åŠ¨",
      "Leda-ğŸ‘§å¹´è½»",
      "Orus-ğŸ‘¨â€ğŸ¦°é‰´å®š",
      "Aoede-ğŸ‘©è½»æ¾",
      "Callirrhoe-ğŸ‘©éšå’Œ",
      "Autonoe-ğŸ‘©æ˜äº®",
      "Enceladus-ğŸ§”â€â™‚ï¸å‘¼å¸æ„Ÿ",
      "Iapetus-ğŸ‘¦æ¸…æ™°",
      "Umbriel-ğŸ‘¦éšå’Œ",
      "Algieba-ğŸ‘¦å¹³æ»‘",
      "Despina-ğŸ‘©å¹³æ»‘",
      "Erinome-ğŸ‘©æ¸…æ™°",
      "Algenib-ğŸ‘¨â€ğŸ¦°æ²™å“‘",
      "Rasalgethi-ğŸ‘¨â€ğŸ¦°ä¿¡æ¯ä¸°å¯Œ",
      "Laomedeia-ğŸ‘©æ¬¢å¿«",
      "Achernar-ğŸ‘©è½»æŸ”",
      "Alnilam-ğŸ‘¦åšå®š",
      "Schedar-ğŸ‘¦å¹³ç¨³",
      "Gacrux-ğŸ‘©æˆç†Ÿ",
      "Pulcherrima-ğŸ‘©å‘å‰",
      "Achird-ğŸ‘¦å‹å¥½",
      "Zubenelgenubi-ğŸ‘¦ä¼‘é—²",
      "Vindemiatrix-ğŸ‘©æ¸©æŸ”",
      "Sadachbia-ğŸ‘¨â€ğŸ¦°æ´»æ³¼",
      "Sadaltager-ğŸ‘¨â€ğŸ¦°åšå­¦",
      "Sulafat-ğŸ‘©æ¸©æš–"
    ],
  }
};

/**
 * [å·²é‡æ„] æ‹†åˆ†å®Œæ•´çš„ config å¯¹è±¡ä»¥ä¾¿äºåˆ†å—å­˜å‚¨
 * @param {object} fullConfig - åŒ…å« prompts å’Œ providers çš„å®Œæ•´ config å¯¹è±¡
 * @returns {{baseConfigPart: object, promptsPart: object, providersPart: object, mcpServersPart: object}} - æ‹†åˆ†åçš„å››éƒ¨åˆ†
 */
function splitConfigForStorage(fullConfig) {
  const { prompts, providers, mcpServers, ...restOfConfig } = fullConfig;

  return {
    baseConfigPart: { config: restOfConfig },
    promptsPart: prompts,
    providersPart: providers,
    mcpServersPart: mcpServers,
  };
}

/**
 * ä»æ•°æ®åº“å¼‚æ­¥è¯»å–é…ç½®ï¼Œåˆå¹¶åˆ†å—æ•°æ®ï¼Œå¹¶å¤„ç†æ—§ç‰ˆæœ¬æ•°æ®è¿ç§»
 * @returns {Promise<object>} - è¿”å›åŒ…å«å®Œæ•´é…ç½®å¯¹è±¡çš„ Promise
 */
async function getConfig() {
  let configDoc = await utools.db.promises.get("config");

  // --- 1. æ–°ç”¨æˆ·åˆå§‹åŒ– ---
  if (!configDoc) {
    const { baseConfigPart, promptsPart, providersPart, mcpServersPart } = splitConfigForStorage(defaultConfig.config);
    await utools.db.promises.put({ _id: "config", data: baseConfigPart });
    await utools.db.promises.put({ _id: "prompts", data: promptsPart });
    await utools.db.promises.put({ _id: "providers", data: providersPart });
    await utools.db.promises.put({ _id: "mcpServers", data: mcpServersPart });
    return defaultConfig;
  }

  // --- 2. æ—§ç‰ˆæœ¬æ•°æ®è‡ªåŠ¨è¿ç§» ---
  if (configDoc.data.config && configDoc.data.config.prompts) {
    console.warn("Anywhere: Old configuration format detected. Starting migration.");
    const oldFullConfig = configDoc.data.config;
    const { baseConfigPart, promptsPart, providersPart, mcpServersPart } = splitConfigForStorage(oldFullConfig);

    await utools.db.promises.put({ _id: "prompts", data: promptsPart });
    await utools.db.promises.put({ _id: "providers", data: providersPart });
    await utools.db.promises.put({ _id: "mcpServers", data: mcpServersPart });

    const updateResult = await utools.db.promises.put({
      _id: "config",
      data: baseConfigPart,
      _rev: configDoc._rev
    });

    if (updateResult.ok) {
      // console.log("Anywhere: Migration successful. Old config cleaned.");
    } else {
      console.error("Anywhere: Migration failed to update old config document.", updateResult.message);
    }
    configDoc = await utools.db.promises.get("config");
  }

  // --- 3. å¼‚æ­¥è¯»å–æ–°ç‰ˆåˆ†å—æ•°æ®å¹¶åˆå¹¶ ---
  const fullConfigData = configDoc.data;
  const [promptsDoc, providersDoc, mcpServersDoc] = await Promise.all([
    utools.db.promises.get("prompts"),
    utools.db.promises.get("providers"),
    utools.db.promises.get("mcpServers")
  ]);

  fullConfigData.config.prompts = promptsDoc ? promptsDoc.data : defaultConfig.config.prompts;
  fullConfigData.config.providers = providersDoc ? providersDoc.data : defaultConfig.config.providers;
  
  // åˆå¹¶ç”¨æˆ·é…ç½®å’Œå†…ç½®æœåŠ¡å™¨
  const userMcpServers = mcpServersDoc ? mcpServersDoc.data : (defaultConfig.config.mcpServers || {});
  const builtinServers = getBuiltinServers();
  
  // å¦‚æœç”¨æˆ·æ•°æ®åº“é‡Œæœ‰åŒåIDï¼Œè¯´æ˜ç”¨æˆ·å¯èƒ½ä¿®æ”¹äº†çŠ¶æ€(isActive/isPersistent)ï¼Œåˆå¹¶çŠ¶æ€
  const mergedMcpServers = { ...userMcpServers };
  
  for (const [id, server] of Object.entries(builtinServers)) {
      if (mergedMcpServers[id]) {
          mergedMcpServers[id] = { 
              ...server, 
              isActive: mergedMcpServers[id].isActive,
              isPersistent: mergedMcpServers[id].isPersistent
          };
      } else {
          mergedMcpServers[id] = server;
      }
  }
  fullConfigData.config.mcpServers = mergedMcpServers;

  return fullConfigData;
}


function checkConfig(config) {
  let flag = false;
  const CURRENT_VERSION = "1.9.13";

  // --- 1. ç‰ˆæœ¬æ£€æŸ¥ä¸æ—§æ•°æ®è¿ç§» ---
  if (config.version !== CURRENT_VERSION) {
    config.version = CURRENT_VERSION;
    flag = true;
  }

  // è¿ç§»æ—§çš„ apiUrl é…ç½®åˆ° providers
  if (config.apiUrl) {
    config.providers = config.providers || {};
    config.providerOrder = config.providerOrder || [];
    config.providers["0"] = {
      name: "default",
      url: config.apiUrl,
      api_key: config.apiKey,
      modelList: [config.modelSelect, ...(config.ModelsListByUser || [])].filter(Boolean),
      enable: true,
    };
    // æ ‡è®°æ—§å­—æ®µå¾…åˆ é™¤
    config.activeProviderId = undefined; // è§¦å‘åç»­æ¸…ç†
    config.providerOrder.unshift("0");
    flag = true;
  }

  // --- 2. æ ¹ç›®å½•å­—æ®µæ¸…æ´— (ä½¿ç”¨åˆ—è¡¨é©±åŠ¨) ---
  // éœ€è¦åˆ é™¤çš„åºŸå¼ƒå­—æ®µ
  const obsoleteKeys = [
    'window_width', 'window_height', 'stream', 'autoCloseOnBlur', 'isAlwaysOnTop',
    'inputLayout', 'tool_list', 'promptOrder', 'ModelsListByUser',
    'apiUrl', 'apiKey', 'modelList', 'modelSelect', 'activeProviderId'
  ];
  obsoleteKeys.forEach(key => {
    if (config[key] !== undefined) { delete config[key]; flag = true; }
  });

  // éœ€è¦è¡¥å…¨çš„é»˜è®¤å€¼
  const rootDefaults = {
    isAlwaysOnTop_global: true,
    autoCloseOnBlur_global: true,
    autoSaveChat_global: false,
    CtrlEnterToSend: false,
    showNotification: false,
    fix_position: false,
    zoom: 1,
    language: "zh",
    providerFolders: {},
    mcpServers: {},
    tags: {},
    isDarkMode: false,
    themeMode: "system",
    fastWindowPosition: null,
    // ç›´æ¥å¼•ç”¨ defaultConfig ä¸­çš„å®Œæ•´åˆ—è¡¨ï¼Œé¿å…ä»£ç å†—é•¿
    voiceList: defaultConfig.config.voiceList || []
  };

  for (const [key, val] of Object.entries(rootDefaults)) {
    if (config[key] === undefined) { config[key] = val; flag = true; }
  }

  // --- 3. WebDAV æ£€æŸ¥ ---
  if (!config.webdav) {
    config.webdav = { url: "", username: "", password: "", path: "/anywhere", data_path: "/anywhere_data", localChatPath: "" };
    flag = true;
  } else {
    if (config.webdav.dataPath) { // è¿ç§»æ—§å­—æ®µ
      config.webdav.data_path = config.webdav.data_path || config.webdav.dataPath;
      delete config.webdav.dataPath;
      flag = true;
    }
    const webdavDefaults = { data_path: "/anywhere_data", localChatPath: "" };
    for (const [k, v] of Object.entries(webdavDefaults)) {
      if (config.webdav[k] === undefined) { config.webdav[k] = v; flag = true; }
    }
  }

  // --- 4. Prompts (å¿«æ·åŠ©æ‰‹) æ£€æŸ¥ ---
  if (config.prompts) {
    const promptDefaults = {
      enable: true, stream: true, showMode: 'window', type: "general",
      isTemperature: false, temperature: 0.7,
      isDirectSend_normal: true, isDirectSend_file: false, ifTextNecessary: false,
      voice: '', reasoning_effort: "default", defaultMcpServers: [],
      window_width: 580, window_height: 740, position_x: 0, position_y: 0,
      isAlwaysOnTop: true, autoCloseOnBlur: true, matchRegex: "", icon: "",
      autoSaveChat: false
    };

    for (const key of Object.keys(config.prompts)) {
      const p = config.prompts[key];

      // 4.1 ç»“æ„æœ‰æ•ˆæ€§æ£€æŸ¥ (ä½ è¦æ±‚çš„é€»è¾‘)
      if (!p || typeof p !== 'object' || '0' in p || !p.type || p.prompt === undefined || p.model === undefined) {
        delete config.prompts[key];
        flag = true;
        continue;
      }

      // 4.2 å­—æ®µè¿ç§»ä¸æ¸…ç†
      if (['input', 'clipboard'].includes(p.showMode)) { p.showMode = 'fastinput'; flag = true; }
      if (p.isDirectSend !== undefined) {
        if (p.isDirectSend_file === undefined) p.isDirectSend_file = p.isDirectSend;
        delete p.isDirectSend;
        flag = true;
      }
      if (p.idex !== undefined) { delete p.idex; flag = true; }

      // 4.3 é»˜è®¤å€¼è¡¥å…¨
      for (const [pk, pv] of Object.entries(promptDefaults)) {
        if (p[pk] === undefined) { p[pk] = pv; flag = true; }
      }
      if (p.voice === null) { p.voice = ''; flag = true; }

      // 4.4 æ¨¡å‹è‡ªåŠ¨ä¿®å¤
      let hasValidModel = p.model && config.providers && config.providers[p.model.split("|")[0]];
      if (!hasValidModel) {
        // å°è¯•æŒ‡å‘ç¬¬ä¸€ä¸ªå¯ç”¨æ¨¡å‹
        const firstProvId = config.providerOrder?.[0];
        const firstModel = config.providers?.[firstProvId]?.modelList?.[0];
        p.model = (firstProvId && firstModel) ? `${firstProvId}|${firstModel}` : "";
        flag = true;
      }
    }
  }

  // --- 5. Providers & Order æ£€æŸ¥ ---
  if (config.providers) {
    for (const key in config.providers) {
      const prov = config.providers[key];
      if (prov.modelSelect !== undefined) { delete prov.modelSelect; flag = true; }
      if (prov.modelListByUser !== undefined) { delete prov.modelListByUser; flag = true; }
      if (prov.enable === undefined) { prov.enable = true; flag = true; }
      if (prov.folderId === undefined) { prov.folderId = ""; flag = true; }
    }
  }

  // ä¿®å¤ ProviderOrder
  if (!Array.isArray(config.providerOrder) || config.providerOrder.length === 0) {
    config.providerOrder = Object.keys(config.providers || {});
    flag = true;
  } else {
    // è¿‡æ»¤ä¸å­˜åœ¨çš„ ID å¹¶ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
    const validOrder = config.providerOrder
      .map(String)
      .filter(id => config.providers && config.providers[id]);

    if (validOrder.length !== config.providerOrder.length) {
      config.providerOrder = validOrder;
      flag = true;
    }
  }

  if (flag) {
    updateConfig({ "config": config });
  }
}

/**
 * ä¿å­˜å•ä¸ªè®¾ç½®é¡¹ï¼Œè‡ªåŠ¨åˆ¤æ–­åº”å†™å…¥å“ªä¸ªæ–‡æ¡£
 * ä¼˜åŒ–è·¯å¾„è§£æé€»è¾‘ï¼Œé˜²æ­¢é”®åä¸­åŒ…å«ç‚¹å·(.)å¯¼è‡´è·¯å¾„å±‚çº§é”™è¯¯
 * @param {string} keyPath - å±æ€§è·¯å¾„
 * @param {*} value - è¦è®¾ç½®çš„å€¼
 * @returns {{success: boolean, message?: string}}
 */
async function saveSetting(keyPath, value) {
  const rootKey = keyPath.split('.')[0];
  let docId;
  let targetObjectKey; // äºŒçº§é”®å (å¦‚ promptKey æˆ– serverId)
  let targetPropKey;   // å±æ€§å (å¦‚ model, enable)

  if (rootKey === 'prompts') {
    docId = 'prompts';
    // é€»è¾‘ï¼škeyPath æ ¼å¼ä¸º "prompts.{promptKey}.{property}"
    // æˆ‘ä»¬éœ€è¦æå–ä¸­é—´çš„ promptKeyï¼Œå®ƒå¯èƒ½åŒ…å«ç‚¹å·
    const firstDotIndex = keyPath.indexOf('.');
    const lastDotIndex = keyPath.lastIndexOf('.');

    if (firstDotIndex === -1 || lastDotIndex === -1 || firstDotIndex === lastDotIndex) {
      console.error(`Invalid keyPath for prompts: ${keyPath}`);
      return { success: false, message: `Invalid keyPath: ${keyPath}` };
    }

    targetObjectKey = keyPath.substring(firstDotIndex + 1, lastDotIndex);
    targetPropKey = keyPath.substring(lastDotIndex + 1);

  } else if (rootKey === 'providers') {
    docId = 'providers';
    // providers çš„ id é€šå¸¸æ˜¯æ—¶é—´æˆ³ï¼Œä¸å«ç‚¹å·ï¼Œä½†ä¸ºäº†ä¿é™©ä¹Ÿç”¨åŒæ ·é€»è¾‘
    const firstDotIndex = keyPath.indexOf('.');
    const lastDotIndex = keyPath.lastIndexOf('.');
    if (firstDotIndex !== -1 && lastDotIndex !== -1 && firstDotIndex !== lastDotIndex) {
      targetObjectKey = keyPath.substring(firstDotIndex + 1, lastDotIndex);
      targetPropKey = keyPath.substring(lastDotIndex + 1);
    } else {
      // Fallback for simple paths
      const parts = keyPath.split('.');
      targetObjectKey = parts[1];
      targetPropKey = parts[2];
    }
  } else if (rootKey === 'mcpServers') {
    docId = 'mcpServers';
    // MCP server id å¯èƒ½åŒ…å«ç‚¹å·
    const firstDotIndex = keyPath.indexOf('.');
    const lastDotIndex = keyPath.lastIndexOf('.');

    if (firstDotIndex !== -1 && lastDotIndex !== -1 && firstDotIndex !== lastDotIndex) {
      targetObjectKey = keyPath.substring(firstDotIndex + 1, lastDotIndex);
      targetPropKey = keyPath.substring(lastDotIndex + 1);
    } else {
      return { success: false, message: `Invalid keyPath for mcpServers: ${keyPath}` };
    }
  } else {
    docId = 'config';
  }

  const doc = await utools.db.promises.get(docId);
  if (!doc) {
    console.error(`Config document "${docId}" not found, cannot save setting.`);
    return { success: false, message: `Config document "${docId}" not found` };
  }

  let dataToUpdate = (docId === 'config') ? doc.data.config : doc.data;

  if (docId === 'config') {
    const pathParts = keyPath.split('.');
    let current = dataToUpdate;
    for (let i = 0; i < pathParts.length - 1; i++) {
      const part = pathParts[i];
      if (current[part] === undefined || typeof current[part] !== 'object') {
        current[part] = {};
      }
      current = current[part];
    }
    current[pathParts[pathParts.length - 1]] = value;

  } else {
    if (!dataToUpdate[targetObjectKey]) {
      dataToUpdate[targetObjectKey] = {};
    }
    dataToUpdate[targetObjectKey][targetPropKey] = value;
  }

  const result = await utools.db.promises.put({
    _id: docId,
    data: doc.data,
    _rev: doc._rev
  });

  if (result.ok) {
    const fullConfig = await getConfig();
    for (const windowInstance of windowMap.values()) {
      if (!windowInstance.isDestroyed()) {
        windowInstance.webContents.send('config-updated', fullConfig.config);
      }
    }
    return { success: true };
  } else {
    console.error(`Failed to save setting to "${docId}"`, result);
    return { success: false, message: result.message };
  }
}

/**
 * æ›´æ–°å®Œæ•´çš„é…ç½®ï¼Œå°†å…¶æ‹†åˆ†å¹¶åˆ†åˆ«å­˜å‚¨
 */
function updateConfigWithoutFeatures(newConfig) {
  // åœ¨å°†é…ç½®å­˜å…¥æ•°æ®åº“å‰ï¼Œå°†å…¶è½¬æ¢ä¸ºçº¯å‡€çš„ JavaScript å¯¹è±¡ï¼Œä»¥ç§»é™¤ Vue çš„å“åº”å¼ Proxyã€‚
  const plainConfig = JSON.parse(JSON.stringify(newConfig.config));
  
  // [å…³é”®ä¿®æ”¹] åœ¨æ‹†åˆ†å‰ï¼Œè¿‡æ»¤ mcpServersï¼Œé˜²æ­¢å†…ç½®MCPçš„å…¨é‡é…ç½®è¢«å†™å…¥æ•°æ®åº“
  if (plainConfig.mcpServers) {
      const serverToSave = {};
      const builtinIds = Object.keys(getBuiltinServers());
      
      for (const [id, server] of Object.entries(plainConfig.mcpServers)) {
          if (server.type === 'builtin' || builtinIds.includes(id)) {
              // å¯¹äºå†…ç½®æœåŠ¡ï¼Œä»…ä¿å­˜çŠ¶æ€ï¼Œä¸ä¿å­˜å®Œæ•´å®šä¹‰
              serverToSave[id] = {
                  id: server.id,
                  type: 'builtin',
                  name: server.name,
                  isActive: server.isActive,
                  isPersistent: server.isPersistent
              };
          } else {
              serverToSave[id] = server;
          }
      }
      plainConfig.mcpServers = serverToSave;
  }

  const { baseConfigPart, promptsPart, providersPart, mcpServersPart } = splitConfigForStorage(plainConfig);

  // 1. æ›´æ–°åŸºç¡€é…ç½® (config)
  let configDoc = utools.db.get("config");
  utools.db.put({
    _id: "config",
    data: baseConfigPart,
    _rev: configDoc ? configDoc._rev : undefined,
  });

  // 2. æ›´æ–°å¿«æ·åŠ©æ‰‹é…ç½® (prompts)
  let promptsDoc = utools.db.get("prompts");
  utools.db.put({
    _id: "prompts",
    data: promptsPart,
    _rev: promptsDoc ? promptsDoc._rev : undefined,
  });

  // 3. æ›´æ–°æœåŠ¡å•†é…ç½® (providers)
  let providersDoc = utools.db.get("providers");
  utools.db.put({
    _id: "providers",
    data: providersPart,
    _rev: providersDoc ? providersDoc._rev : undefined,
  });

  // 4. æ›´æ–°MCPæœåŠ¡å™¨é…ç½® (mcpServers)
  let mcpServersDoc = utools.db.get("mcpServers");
  utools.db.put({
    _id: "mcpServers",
    data: mcpServersPart,
    _rev: mcpServersDoc ? mcpServersDoc._rev : undefined,
  });

  // 5. å¹¿æ’­é…ç½®æ›´æ–°ç»™æ‰€æœ‰å·²æ‰“å¼€çš„ç‹¬ç«‹çª—å£
  const fullConfigForFrontend = JSON.parse(JSON.stringify(newConfig.config));
  
  for (const windowInstance of windowMap.values()) {
    if (!windowInstance.isDestroyed()) {
      windowInstance.webContents.send('config-updated', fullConfigForFrontend);
    }
  }

  cleanUpBackgroundCache(newConfig);
}

function updateConfig(newConfig) {
  const features = utools.getFeatures();
  const featuresMap = new Map(features.map((feature) => [feature.code, feature]));
  const currentPrompts = newConfig.config.prompts || {};
  const enabledPromptKeys = new Set();

  for (let key in currentPrompts) {
    const prompt = currentPrompts[key];
    if (prompt.enable) {
      enabledPromptKeys.add(key);
      const featureCode = key;
      const functionCmdCode = key + feature_suffix;

      // æ›´æ–°æˆ–æ·»åŠ åŒ¹é…æŒ‡ä»¤
      const expectedMatchFeature = {
        code: featureCode,
        explain: key,
        mainHide: true,
        cmds: [],
        icon: prompt.icon || ""
      };
      if (prompt.type === "general") {
        expectedMatchFeature.cmds.push({ type: "over", label: key, "maxLength": 99999999999 });
        expectedMatchFeature.cmds.push({ type: "img", label: key });
        expectedMatchFeature.cmds.push({ type: "files", label: key, fileType: "file", match: "/\\.(png|jpeg|jpg|webp|docx|xlsx|xls|csv|pdf|mp3|wav|txt|md|markdown|json|xml|html|htm|css|yml|py|js|ts|java|c|cpp|h|hpp|cs|go|php|rb|rs|sh|sql|vue|tex|latex|bib|sty|yaml|yml|ini|bat|log|toml)$/i" });
      } else if (prompt.type === "files") {
        expectedMatchFeature.cmds.push({ type: "files", label: key, fileType: "file", match: "/\\.(png|jpeg|jpg|webp|docx|xlsx|xls|csv|pdf|mp3|wav|txt|md|markdown|json|xml|html|htm|css|yml|py|js|ts|java|c|cpp|h|hpp|cs|go|php|rb|rs|sh|sql|vue|tex|latex|bib|sty|yaml|yml|ini|bat|log|toml)$/i" });
      } else if (prompt.type === "img") {
        expectedMatchFeature.cmds.push({ type: "img", label: key });
      } else if (prompt.type === "over") {
        // æ ¹æ® matchRegex å†³å®šç”Ÿæˆ regex è¿˜æ˜¯ over ç±»å‹çš„ cmd
        if (prompt.matchRegex && prompt.matchRegex.trim() !== '') {
          expectedMatchFeature.cmds.push({
            type: "regex",
            label: key,
            match: prompt.matchRegex,
            minLength: 1
          });
        } else {
          expectedMatchFeature.cmds.push({ type: "over", label: key, "maxLength": 99999999999 });
        }
      }
      utools.setFeature(expectedMatchFeature);

      // æ›´æ–°æˆ–æ·»åŠ åŠŸèƒ½æŒ‡ä»¤ï¼ˆä»…é™çª—å£æ¨¡å¼å’Œå¿«é€Ÿå±•ç¤ºæ¨¡å¼ï¼‰
      if (prompt.showMode === "window") {
        utools.setFeature({
          code: functionCmdCode,
          explain: key,
          mainHide: true,
          cmds: [key],
          icon: prompt.icon || ""
        });
      } else {
        if (featuresMap.has(functionCmdCode)) {
          utools.removeFeature(functionCmdCode);
        }
      }
    }
  }

  // ç§»é™¤ä¸å†éœ€è¦çš„ features
  for (const [code, feature] of featuresMap) {
    if (code === "Anywhere Settings" || code === "Resume Conversation") continue;
    const promptKey = feature.explain;
    if (!enabledPromptKeys.has(promptKey) ||
      (currentPrompts[promptKey] && (currentPrompts[promptKey].showMode !== "window") && code.endsWith(feature_suffix))
    ) {
      utools.removeFeature(code);
    }
  }

  // æœ€åå°†é…ç½®å†™å…¥æ•°æ®åº“
  updateConfigWithoutFeatures(newConfig);
}

function getUser() {
  return utools.getUser();
}

function getPosition(config, promptCode) {
  const promptConfig = config.prompts[promptCode];
  const OVERFLOW_ALLOWANCE = 10;

  // å¼ºåˆ¶è½¬æ¢ä¸º Numberï¼Œé˜²æ­¢ undefined æˆ– null å¯¼è‡´ NaN
  let width = Number(promptConfig?.window_width) || 580;
  let height = Number(promptConfig?.window_height) || 740;
  let windowX = 0, windowY = 0;

  const primaryDisplay = utools.getPrimaryDisplay();
  let currentDisplay;

  const hasFixedPosition = config.fix_position && promptConfig && promptConfig.position_x != null && promptConfig.position_y != null;

  if (hasFixedPosition) {
    let set_position = { x: Number(promptConfig.position_x), y: Number(promptConfig.position_y) };
    currentDisplay = utools.getDisplayNearestPoint(set_position) || primaryDisplay;
    windowX = Math.floor(set_position.x);
    windowY = Math.floor(set_position.y);
  } else {
    const mouse_position = utools.getCursorScreenPoint();
    currentDisplay = utools.getDisplayNearestPoint(mouse_position) || primaryDisplay;
    windowX = Math.floor(mouse_position.x - (width / 2));
    windowY = Math.floor(mouse_position.y);
  }

  if (currentDisplay) {
    const display = currentDisplay.bounds;

    if (width > display.width) {
      width = display.width;
    }
    if (height > display.height) {
      height = display.height;
    }

    const minX = display.x - OVERFLOW_ALLOWANCE;
    const maxX = display.x + display.width - width + OVERFLOW_ALLOWANCE;
    const minY = display.y - OVERFLOW_ALLOWANCE;
    const maxY = display.y + display.height - height + OVERFLOW_ALLOWANCE;

    if (
      (windowX + width < display.x) || (windowX > display.x + display.width) ||
      (windowY + height < display.y) || (windowY > display.y + display.height)
    ) {
      windowX = display.x + (display.width - width) / 2;
      windowY = display.y + (display.height - height) / 2;
    } else {
      if (windowX < minX) windowX = minX;
      if (windowX > maxX) windowX = maxX;
      if (windowY < minY) windowY = minY;
      if (windowY > maxY) windowY = maxY;
    }
  }

  return { x: Math.round(windowX), y: Math.round(windowY), width, height };
}

function saveFastInputWindowPosition(position) {
  const configDoc = utools.db.get("config");
  if (configDoc) {
    const data = configDoc.data;
    data.config.fastWindowPosition = position;
    utools.db.put({
      _id: "config",
      data: data,
      _rev: configDoc._rev
    });
  }
}

function getFastInputPosition(config) {
  const width = 300;
  const height = 70;

  const primaryDisplay = utools.getPrimaryDisplay();
  let displayBounds;
  let x, y;

  if (config.fastWindowPosition && typeof config.fastWindowPosition.x === 'number' && typeof config.fastWindowPosition.y === 'number') {
    x = config.fastWindowPosition.x;
    y = config.fastWindowPosition.y;
    displayBounds = utools.getDisplayNearestPoint({ "x": x, "y": y }).bounds;
  } else {
    // é»˜è®¤ä½ç½®ï¼šå±å¹•ä¸­å¤®åä¸‹ (90%é«˜åº¦å¤„)
    displayBounds = primaryDisplay.bounds;
    x = Math.floor(displayBounds.x + (displayBounds.width - width) / 2);
    y = Math.floor(displayBounds.y + displayBounds.height * 0.85);
  }

  // è¾¹ç•Œæ£€æŸ¥ï¼Œé˜²æ­¢çª—å£è·‘å‡ºå±å¹•
  const padding = 10;
  if (x < displayBounds.x) x = displayBounds.x + padding;
  if (x + width > displayBounds.x + displayBounds.width) x = displayBounds.x + displayBounds.width - width - padding;
  if (y < displayBounds.y) y = displayBounds.y + padding;
  if (y + height > displayBounds.y + displayBounds.height) y = displayBounds.y + displayBounds.height - height - padding;

  return { x, y, width, height };
}

// utools æ’ä»¶è°ƒç”¨ copyText å‡½æ•°
function copyText(content) {
  utools.copyText(content);
}

async function sethotkey(prompt_name, auto_copy) {
  utools.redirectHotKeySetting(prompt_name, auto_copy);
}

async function openWindow(config, msg) {
  // è®¡æ—¶å¼€å§‹
  let startTime;
  if (utools.isDev()) {
    startTime = performance.now();
    console.log(`[Timer Start] Opening window for code: ${msg.code}`);
  }

  const promptCode = msg.originalCode || msg.code;
  const { x, y, width, height } = getPosition(config, promptCode);
  const promptConfig = config.prompts[promptCode];
  const isAlwaysOnTop = promptConfig?.isAlwaysOnTop ?? true;
  let channel = "window";
  const backgroundColor = config.isDarkMode ? `rgba(33, 33, 33, 1)` : 'rgba(255, 255, 253, 1)';

  // ä¸ºçª—å£ç”Ÿæˆå”¯ä¸€IDå¹¶æ·»åŠ åˆ°æ¶ˆæ¯ä¸­
  const senderId = crypto.randomUUID();
  msg.senderId = senderId;
  msg.isAlwaysOnTop = isAlwaysOnTop;

  const windowOptions = {
    show: false,
    backgroundColor: backgroundColor,
    title: "Anywhere",
    width: width,
    height: height,
    alwaysOnTop: isAlwaysOnTop,
    x: x,
    y: y,
    frame: false,
    transparent: false,
    hasShadow: true,
    webPreferences: {
      preload: "./window_preload.js",
      devTools: utools.isDev()
    },
  };
  const entryPath = config.isDarkMode ? "./window/index.html?dark=1" : "./window/index.html";
  const ubWindow = utools.createBrowserWindow(
    entryPath,
    windowOptions,
    () => {
      // å°†çª—å£å®ä¾‹å­˜å…¥Map
      windowMap.set(senderId, ubWindow);
      ubWindow.show();

      // è®¡æ—¶ç»“æŸ
      if (utools.isDev()) {
        const windowShownTime = performance.now();
        console.log(`[Timer Checkpoint] utools.createBrowserWindow callback executed. Elapsed: ${(windowShownTime - startTime).toFixed(2)} ms`);
      }
      ubWindow.webContents.send(channel, msg);
    }
  );
  if (utools.isDev()) {
    ubWindow.webContents.openDevTools({ mode: "detach" });
  }
}

async function coderedirect(label, payload) {
  utools.redirect(label, payload);
}

function setZoomFactor(factor) {
  webFrame.setZoomFactor(factor);
}

/**
 * ä¿å­˜å•ä¸ªå¿«æ·åŠ©æ‰‹çš„çª—å£è®¾ç½®ï¼Œç›´æ¥æ“ä½œ "prompts" æ–‡æ¡£
 * @param {string} promptKey - å¿«æ·åŠ©æ‰‹çš„ key
 * @param {object} settings - è¦ä¿å­˜çš„çª—å£è®¾ç½®
 * @returns {Promise<{success: boolean, message?: string}>}
 */
async function savePromptWindowSettings(promptKey, settings) {
  const MAX_RETRIES = 5;
  let attempt = 0;

  while (attempt < MAX_RETRIES) {
    const promptsDoc = utools.db.get("prompts");
    if (!promptsDoc || !promptsDoc.data) {
      return { success: false, message: "Prompts document not found" };
    }

    const promptsData = promptsDoc.data;
    if (!promptsData[promptKey]) {
      // å¦‚æœå¿«æ·åŠ©æ‰‹ä¸å­˜åœ¨ï¼Œåˆ™æ— æ³•æ›´æ–°ã€‚è¿™æ˜¯ä¸€ä¸ªé”™è¯¯æƒ…å†µã€‚
      return { success: false, message: `Prompt with key '${promptKey}' not found in document` };
    }

    // å°†æ–°çš„è®¾ç½®åˆå¹¶åˆ°ç°æœ‰çš„å¿«æ·åŠ©æ‰‹é…ç½®ä¸­
    promptsData[promptKey] = {
      ...promptsData[promptKey],
      ...settings
    };

    // å°è¯•ä¿å­˜æ›´æ–°åçš„æ–‡æ¡£
    const result = utools.db.put({
      _id: "prompts",
      data: promptsData,
      _rev: promptsDoc._rev
    });

    if (result.ok) {
      return { success: true, rev: result.rev }; // æˆåŠŸï¼
    }

    if (result.error && result.name === 'conflict') {
      // æ£€æµ‹åˆ°å†²çªã€‚å¢åŠ å°è¯•æ¬¡æ•°ï¼Œå¾ªç¯å°†è‡ªåŠ¨é‡è¯•ã€‚
      attempt++;
      // ä¸ºè°ƒè¯•è®°å½•å†²çªï¼Œä½†ä¸æ‰“æ‰°ç”¨æˆ·ã€‚
      // console.log(`Anywhere: DB conflict on saving window settings (attempt ${attempt}/${MAX_RETRIES}). Retrying...`);
    } else {
      // å‘ç”Ÿäº†å…¶ä»–é”™è¯¯ï¼ˆä¾‹å¦‚éªŒè¯å¤±è´¥ï¼‰ï¼Œå› æ­¤ç«‹å³å¤±è´¥ã€‚
      return { success: false, message: result.message || 'An unknown database error occurred.' };
    }
  }

  // å¦‚æœé€€å‡ºå¾ªç¯ï¼Œæ„å‘³ç€å·²è¶…å‡ºé‡è¯•æ¬¡æ•°ã€‚
  return { success: false, message: `Failed to save settings after ${MAX_RETRIES} attempts due to persistent database conflicts.` };
}

async function openFastInputWindow(config, msg) {
  // è®¡æ—¶å¼€å§‹
  let startTime;
  if (utools.isDev()) {
    startTime = performance.now();
    console.log(`[Timer Start] Opening window for code: ${msg.code}`);
  }
  // 1. ã€å¹¶è¡Œã€‘ç«‹å³å‘èµ· AI è¯·æ±‚
  const streamBuffer = []; // ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨çª—å£æœªå°±ç»ªæ—¶æ”¶åˆ°çš„æ•°æ®
  let fastWindowRef = null; // ç”¨äºåœ¨è¯·æ±‚å›è°ƒä¸­å¼•ç”¨çª—å£

  // å®šä¹‰å‘é€æ•°æ®åˆ°çª—å£çš„è¾…åŠ©å‡½æ•°
  const sendToWindow = (type, payload) => {
    if (fastWindowRef && !fastWindowRef.isDestroyed()) {
      fastWindowRef.webContents.send('stream-update', { type, payload });
    } else {
      // çª—å£è¿˜æ²¡å¥½ï¼Œå­˜å…¥ç¼“å†²åŒº
      streamBuffer.push({ type, payload });
    }
  };

  // æ‰§è¡Œè¯·æ±‚å¤„ç†é€»è¾‘ (ä¸ awaitï¼Œè®©å…¶åœ¨åå°è¿è¡Œ)
  requestTextOpenAI(msg.code, msg.content, config).then(async (response) => {
    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }

    const isStream = config.prompts[msg.code].stream ?? true;

    if (isStream) {
      // --- æµå¼å¤„ç† ---
      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let buffer = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        let boundary = buffer.lastIndexOf("\n");

        if (boundary !== -1) {
          const completeData = buffer.substring(0, boundary);
          buffer = buffer.substring(boundary + 1);

          const lines = completeData.split("\n").filter((line) => line.trim() !== "");
          for (const line of lines) {
            const message = line.replace(/^data: /, "");
            if (message === "[DONE]") break;
            try {
              const parsed = JSON.parse(message);
              if (parsed.choices[0].delta.content) {
                const chunk = parsed.choices[0].delta.content;
                sendToWindow('chunk', chunk);
              }
            } catch (e) {
              // å¿½ç•¥è§£æé”™è¯¯
            }
          }
        }
      }
    } else {
      // --- éæµå¼å¤„ç† ---
      const data = await response.json();
      const fullText = data.choices[0].message.content || "";
      sendToWindow('chunk', fullText);
    }

    isStreamEnded = true;
    sendToWindow('done', null);

  }).catch((error) => {
    console.error("FastWindow AI Request Error:", error);
    streamError = error.message;
    sendToWindow('error', error.message);
  });

  // 2. ã€å¹¶è¡Œã€‘åˆ›å»ºçª—å£
  msg.config = config;
  const { x, y, width, height } = getFastInputPosition(config);
  let channel = "fast-window";
  const senderId = crypto.randomUUID();
  msg.senderId = senderId;

  const windowOptions = {
    show: true,
    width: width,
    height: height,
    useContentSize: true,
    alwaysOnTop: true,
    x: x,
    y: y,
    frame: false,
    transparent: true,
    hasShadow: false,
    backgroundColor: config.isDarkMode ? 'rgba(0, 0, 0, 0)' : 'rgba(255, 255, 255, 0)',
    resizable: false,
    skipTaskbar: true,
    webPreferences: {
      preload: "./fast_window_preload.js",
      devTools: utools.isDev()
    }
  };

  const entryPath = "./fast_window/fast_input.html";

  const fastWindow = utools.createBrowserWindow(
    entryPath,
    windowOptions,
    () => {
      fastWindowRef = fastWindow; // èµ‹å€¼å¼•ç”¨
      windowMap.set(senderId, fastWindow);

      // å‘é€åˆå§‹åŒ–é…ç½®
      fastWindow.webContents.send(channel, msg);

      // 3. ã€åŒæ­¥ã€‘å‘é€ç¼“å†²åŒºä¸­å·²ç§¯å‹çš„æ•°æ®
      if (streamBuffer.length > 0) {
        streamBuffer.forEach(item => {
          fastWindow.webContents.send('stream-update', item);
        });
        streamBuffer.length = 0; // æ¸…ç©º
      }

      // è®¡æ—¶ç»“æŸ
      if (utools.isDev()) {
        const windowShownTime = performance.now();
        console.log(`[Timer Checkpoint] utools.createBrowserWindow callback executed. Elapsed: ${(windowShownTime - startTime).toFixed(2)} ms`);
      }
    }
  );
  if (utools.isDev()) {// è°ƒè¯•ç”¨
    fastWindow.webContents.openDevTools({ mode: "detach" });
  }
}

/**
 * ä¿å­˜ MCP å·¥å…·åˆ—è¡¨åˆ°ç¼“å­˜æ–‡æ¡£
 * @param {string} serverId - æœåŠ¡å™¨ ID
 * @param {Array} tools - å·¥å…·åˆ—è¡¨
 */
async function saveMcpToolCache(serverId, tools) {
  let doc = await utools.db.promises.get("mcp_tools_cache");
  if (!doc) {
    doc = { _id: "mcp_tools_cache", data: {} };
  }
  doc.data[serverId] = tools;
  return await utools.db.promises.put({
    _id: "mcp_tools_cache",
    data: doc.data,
    _rev: doc._rev
  });
}

/**
 * è·å–æ‰€æœ‰ MCP å·¥å…·ç¼“å­˜
 */
async function getMcpToolCache() {
  const doc = await utools.db.promises.get("mcp_tools_cache");
  return doc ? doc.data : {};
}

/**
 * è®¡ç®— URL çš„ MD5 Hash ä½œä¸º ID
 */
function getUrlHash(url) {
  return crypto.createHash('md5').update(url).digest('hex');
}

/**
 * è·å–ç¼“å­˜çš„èƒŒæ™¯å›¾ç‰‡ï¼ˆåŒ…å«æ—§æ•°æ®è‡ªåŠ¨å‹ç¼©è¿ç§»é€»è¾‘ï¼‰
 * @param {string} url å›¾ç‰‡åŸå§‹ URL
 * @returns {Promise<Uint8Array|null>} è¿”å›å›¾ç‰‡çš„ Buffer æ•°æ®æˆ– null
 */
async function getCachedBackgroundImage(url) {
  if (!url) return null;
  const hash = getUrlHash(url);

  // 1. æ£€æŸ¥æ˜ å°„æ˜¯å¦å­˜åœ¨
  const cacheDoc = await utools.db.promises.get("background_cache");
  if (!cacheDoc || !cacheDoc.data || !cacheDoc.data[hash]) {
    return null;
  }

  const attachmentId = cacheDoc.data[hash];

  // 2. è·å–é™„ä»¶
  let buffer = await utools.db.promises.getAttachment(attachmentId);
  if (!buffer) return null;

  if (buffer.length > 500 * 1024) {
    // console.log(`[Cache] Image is too large (${(buffer.length/1024/1024).toFixed(2)}MB), compressing...`);
    try {
      const image = nativeImage.createFromBuffer(buffer);
      if (!image.isEmpty()) {
        const size = image.getSize();
        // ç­–ç•¥ï¼šå®½åº¦é™åˆ¶ 1920ï¼ŒJPEG è´¨é‡ 75
        if (size.width > 1920) {
          const newHeight = Math.floor(size.height * (1920 / size.width));
          const resizedImage = image.resize({ width: 1920, height: newHeight, quality: 'better' });
          buffer = resizedImage.toJPEG(75);
        } else {
          buffer = image.toJPEG(75);
        }

        (async () => {
          try {
            // uTools çš„ attachment æ–‡æ¡£æ— æ³•ç›´æ¥æ›´æ–°å†…å®¹ï¼Œéœ€è¦åˆ é™¤é‡å»º
            // 1. åˆ é™¤æ—§æ–‡æ¡£
            await utools.db.promises.remove(attachmentId);
            // 2. å†™å…¥æ–°æ–‡æ¡£ (IDä¸å˜)
            await utools.db.promises.postAttachment(attachmentId, buffer, "image/jpeg");
            // console.log(`[Cache] Migrated/Compressed image: ${attachmentId}`);
          } catch (dbErr) {
            console.error("[Cache] Failed to update compressed image to DB:", dbErr);
          }
        })();
      }
    } catch (err) {
      console.warn("[Cache] Failed to compress legacy image, returning original:", err);
    }
  }

  return buffer;
}

/**
 * ç¼“å­˜èƒŒæ™¯å›¾ç‰‡ï¼ˆå¢åŠ å‹ç¼©é€»è¾‘ï¼‰
 * @param {string} url å›¾ç‰‡åŸå§‹ URL
 */
async function cacheBackgroundImage(url) {
  if (!url || url.startsWith('data:') || url.startsWith('file:')) return;

  const hash = getUrlHash(url);
  const attachmentId = `bg-${hash}`;

  try {
    // 1. æ£€æŸ¥æ˜¯å¦å·²ç¼“å­˜
    let cacheDoc = await utools.db.promises.get("background_cache");
    if (!cacheDoc) {
      cacheDoc = { _id: "background_cache", data: {} };
      await utools.db.promises.put(cacheDoc);
      cacheDoc = await utools.db.promises.get("background_cache");
    }

    if (cacheDoc.data[hash]) {
      const existingBuf = await utools.db.promises.getAttachment(cacheDoc.data[hash]);
      if (existingBuf) return;
    }

    // 2. ä¸‹è½½å›¾ç‰‡
    const response = await fetch(url);
    if (!response.ok) throw new Error(`Failed to fetch image: ${response.statusText}`);
    const arrayBuffer = await response.arrayBuffer();
    let buffer = Buffer.from(arrayBuffer);

    // 3. [æ–°å¢] å›¾ç‰‡å‹ç¼©å¤„ç†
    try {
      const image = nativeImage.createFromBuffer(buffer);
      if (!image.isEmpty()) {
        const size = image.getSize();
        // å¦‚æœå®½åº¦å¤§äº 1920ï¼Œç­‰æ¯”ç¼©æ”¾
        if (size.width > 1920) {
          const newHeight = Math.floor(size.height * (1920 / size.width));
          const resizedImage = image.resize({ width: 1920, height: newHeight, quality: 'better' });
          // è½¬ä¸º JPEGï¼Œè´¨é‡ 75ï¼Œé€šå¸¸èƒ½å°†å¤§å›¾å‹åˆ°å‡ ç™¾KB
          buffer = resizedImage.toJPEG(75);
        } else {
          // å³ä½¿å°ºå¯¸ä¸å¤§ï¼Œä¹Ÿè½¬ä¸º JPEG 75 å‹ç¼©ä½“ç§¯
          buffer = image.toJPEG(75);
        }
      }
    } catch (compressErr) {
      console.warn("[Cache] Image compression failed, using original buffer:", compressErr);
    }

    // 4. å­˜å‚¨é™„ä»¶ (é™åˆ¶ 10MB -> å‹ç¼©åé€šå¸¸è¿œå°äºæ­¤)
    if (buffer.length > 10 * 1024 * 1024) {
      console.warn("Background image too large (>10MB):", url);
      return;
    }

    // ç»Ÿä¸€å­˜å‚¨ä¸º image/jpeg ç±»å‹
    const attachResult = await utools.db.promises.postAttachment(attachmentId, buffer, "image/jpeg");

    if (attachResult.ok) {
      // 5. æ›´æ–°æ˜ å°„æ–‡æ¡£
      cacheDoc = await utools.db.promises.get("background_cache");
      cacheDoc.data[hash] = attachmentId;
      await utools.db.promises.put({
        _id: "background_cache",
        data: cacheDoc.data,
        _rev: cacheDoc._rev
      });
    }
  } catch (error) {
    console.error(`[Cache] Error caching background ${url}:`, error);
  }
}

/**
 * æ¸…ç†æœªä½¿ç”¨çš„èƒŒæ™¯å›¾ç‰‡ç¼“å­˜
 * @param {object} fullConfig å½“å‰çš„å®Œæ•´é…ç½®å¯¹è±¡
 */
async function cleanUpBackgroundCache(fullConfig) {
  try {
    const prompts = fullConfig.config.prompts || {};
    // 1. æ”¶é›†æ‰€æœ‰æ­£åœ¨ä½¿ç”¨çš„ URL Hash
    const activeHashes = new Set();
    Object.values(prompts).forEach(p => {
      if (p.backgroundImage && !p.backgroundImage.startsWith('data:')) {
        activeHashes.add(getUrlHash(p.backgroundImage));
      }
    });

    // 2. è·å–ç¼“å­˜è®°å½•
    const cacheDoc = await utools.db.promises.get("background_cache");
    if (!cacheDoc || !cacheDoc.data) return;

    const cacheData = cacheDoc.data;
    let hasChanges = false;

    // 3. éå†ç¼“å­˜ï¼Œåˆ é™¤æœªä½¿ç”¨çš„
    for (const [hash, attachmentId] of Object.entries(cacheData)) {
      if (!activeHashes.has(hash)) {
        // åˆ é™¤é™„ä»¶
        try {
          const removeResult = await utools.db.promises.remove(attachmentId);
          if (removeResult.ok || removeResult.error) { // å³ä½¿é™„ä»¶ä¸å­˜åœ¨(error)ä¹Ÿåº”è¯¥åˆ é™¤æ˜ å°„
            delete cacheData[hash];
            hasChanges = true;
            // console.log(`[Cache] Removed unused background cache: ${attachmentId}`);
          }
        } catch (e) {
          // é™„ä»¶å¯èƒ½å·²ç»ä¸å­˜åœ¨äº†ï¼Œç›´æ¥åˆ é™¤æ˜ å°„
          delete cacheData[hash];
          hasChanges = true;
        }
      }
    }

    // 4. æ›´æ–°æ˜ å°„æ–‡æ¡£
    if (hasChanges) {
      await utools.db.promises.put({
        _id: "background_cache",
        data: cacheData,
        _rev: cacheDoc._rev
      });
    }
  } catch (error) {
    console.error("[Cache] Cleanup failed:", error);
  }
}

module.exports = {
  getConfig,
  checkConfig,
  updateConfig,
  saveSetting,
  updateConfigWithoutFeatures,
  savePromptWindowSettings,
  getUser,
  copyText,
  sethotkey,
  openWindow,
  coderedirect,
  setZoomFactor,
  feature_suffix,
  defaultConfig,
  windowMap,
  saveFastInputWindowPosition,
  openFastInputWindow,
  saveMcpToolCache,
  getMcpToolCache,
  getCachedBackgroundImage,
  cacheBackgroundImage,
};
```
```js
./backend/src/fast_window_preload.js
const { ipcRenderer } = require('electron');
const {
    saveFastInputWindowPosition,
    copyText,
    coderedirect,
} = require('./data.js');

const channel = "fast-window";
let senderId = null;

window.preload = {
    // æ¥æ”¶åˆå§‹åŒ–æ¶ˆæ¯ (Config, Code ç­‰)
    receiveMsg: (callback) => {
        ipcRenderer.on(channel, (event, data) => {
            if (data) {
                if (data.senderId) {
                    senderId = data.senderId;
                }
                callback(data);
            }
        });
    },
    // [æ–°å¢] æ¥æ”¶æµå¼æ•°æ®æ›´æ–°
    onStreamUpdate: (callback) => {
        ipcRenderer.on('stream-update', (event, data) => {
            callback(data); // data format: { type: 'chunk'|'done'|'error', payload: ... }
        });
    }
}

window.api = {
    copyText,
    coderedirect,
    typeText: (text) => {
        utools.hideMainWindowPasteText(text);
    },
    
    // å…³é—­çª—å£å¹¶ä¿å­˜ä½ç½®
    closeWindow: (pos) => {
        if (pos && typeof pos.x === 'number' && typeof pos.y === 'number') {
            saveFastInputWindowPosition({ x: pos.x, y: pos.y });
        }
        if (senderId) {
            utools.sendToParent('window-event', { senderId, event: 'close-window' });
        } else {
            window.close(); 
        }
    }
}
```
```js
./backend/src/file.js
const fs = require('fs/promises');
const fs_node = require('node:fs');
const path = require('path');


const parseWord = async (base64Data) => {
    const mammoth = (await import('mammoth')).default;
    const s = base64Data.split(',')[1];
    if (!s) throw new Error("Invalid base64 data for Word file");

    const buffer = Buffer.from(s, 'base64');
    const arrayBuffer = buffer.buffer.slice(buffer.byteOffset, buffer.byteOffset + buffer.byteLength);
    const r = await mammoth.convertToHtml({ buffer: buffer, arrayBuffer: arrayBuffer });
    const d = document.createElement('div');
    d.innerHTML = r.value;
    return (d.textContent || d.innerText || "").replace(/\s+/g, ' ').trim();
};

const parseTextFile = async (base64Data) => {
    const s = base64Data.split(',')[1]; if (!s) throw new Error("Invalid base64 data for text file");
    return Buffer.from(s, 'base64').toString('utf-8');
};

const parseExcel = async (base64Data) => {
    //   const XLSX = await import('xlsx');
    const XLSX = require('xlsx/dist/xlsx.mini.min.js');
    const s = base64Data.split(',')[1]; if (!s) throw new Error("Invalid base64 data for Excel file");
    const buffer = Buffer.from(s, 'base64');
    const workbook = XLSX.read(buffer, { type: 'buffer' });

    let fullTextContent = '';
    workbook.SheetNames.forEach(sheetName => {
        const worksheet = workbook.Sheets[sheetName];
        const csvData = XLSX.utils.sheet_to_csv(worksheet);
        fullTextContent += `--- Sheet: ${sheetName} ---\n${csvData}\n\n`;
    });
    return fullTextContent.trim();
};

// Centralized file handling configuration
const fileHandlers = {
    text: {
        extensions: ['.txt', '.md', '.markdown', '.json', '.xml', '.html', '.css', '.csv', '.py', '.js', '.ts', '.java', '.c', '.cpp', '.h', '.hpp', '.cs', '.go', '.php', '.rb', '.rs', '.sh', '.sql', '.vue', '.tex', '.latex', '.bib', '.sty', '.yaml', '.yml', '.ini', '.bat', '.log', '.toml'],
        handler: async (file) => ({ type: "text", text: `file name:${file.name}\nfile content:\n${await parseTextFile(file.url)}\nfile end` })
    },
    docx: {
        extensions: ['.docx'],
        handler: async (file) => ({ type: "text", text: `file name:${file.name}\nfile content:\n${await parseWord(file.url)}\nfile end` })
    },
    excel: {
        extensions: ['.xlsx', '.xls'],
        handler: async (file) => ({ type: "text", text: `file name:${file.name}\nfile content:\n${await parseExcel(file.url)}\nfile end` })
    },
    image: {
        extensions: ['.png', '.jpg', '.jpeg', '.webp'],
        handler: async (file) => ({ type: "image_url", image_url: { url: file.url } })
    },
    audio: {
        extensions: ['.mp3', '.wav'],
        handler: async (file) => {
            const commaIndex = file.url.indexOf(',');
            if (commaIndex > -1) return { type: "input_audio", input_audio: { data: file.url.substring(commaIndex + 1), format: file.name.split('.').pop().toLowerCase() } };
            showDismissibleMessage.error(`éŸ³é¢‘æ–‡ä»¶ ${file.name} æ ¼å¼ä¸æ­£ç¡®`); return null;
        }
    },
    pdf: {
        extensions: ['.pdf'],
        handler: async (file) => ({ type: "file", file: { filename: file.name, file_data: file.url } })
    }
};

const isFileTypeSupported = (fileName) => {
    if (!fileName) return false;
    const extension = ('.' + fileName.split('.').pop()).toLowerCase();
    for (const category in fileHandlers) {
        if (fileHandlers[category].extensions.includes(extension)) {
            return true;
        }
    }
    return false;
};

const parseFileObject = async (fileObj) => {
    const handler = getFileHandler(fileObj.name);
    if (!handler) {
        throw new Error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${fileObj.name}`);
    }
    return await handler(fileObj);
};

// Helper function to get the correct handler for a file
const getFileHandler = (fileName) => {
    if (!fileName) return null;
    const extension = ('.' + fileName.split('.').pop()).toLowerCase();
    for (const category in fileHandlers) {
        if (fileHandlers[category].extensions.includes(extension)) {
            return fileHandlers[category].handler;
        }
    }
    return null;
};


async function sendFile(fileList) {
    let contentList = [];
    if (fileList.length === 0) return contentList;

    for (const currentFile of fileList) {
        const handler = getFileHandler(currentFile.name);
        if (handler) {
            try {
                const processedContent = await handler(currentFile);
                if (processedContent) {
                    contentList.push(processedContent);
                }
            } catch (error) {
                console.log(`å¤„ç†æ–‡ä»¶ ${currentFile.name} å¤±è´¥: ${error.message}`);
            }
        } else {
            console.log(`æ–‡ä»¶ç±»å‹ä¸æ”¯æŒ: ${currentFile.name}`);
        }
    }
    return contentList;
}

const extensionToMimeType = {
    // æ–‡æœ¬å’Œä»£ç 
    '.txt': 'text/plain',
    '.md': 'text/markdown',
    '.markdown': 'text/markdown',
    '.json': 'application/json',
    '.xml': 'application/xml',
    '.html': 'text/html',
    '.css': 'text/css',
    '.csv': 'text/csv',
    '.py': 'text/plain',
    '.js': 'application/javascript',
    '.ts': 'application/typescript',
    '.java': 'text/x-java-source',
    '.c': 'text/plain',
    '.cpp': 'text/plain',
    '.h': 'text/plain',
    '.hpp': 'text/plain',
    '.cs': 'text/plain',
    '.go': 'text/plain',
    '.php': 'application/x-httpd-php',
    '.rb': 'application/x-ruby',
    '.rs': 'text/rust',
    '.sh': 'application/x-sh',
    '.sql': 'application/sql',
    '.vue': 'text/plain',
    '.tex': 'text/x-tex',
    '.latex': 'text/x-tex',
    '.bib': 'text/plain',
    '.sty': 'text/plain',
    '.yaml': 'text/yaml',
    '.yml': 'text/yaml',
    '.ini': 'text/plain',
    '.toml': 'text/plain',
    '.bat': 'text/plain',
    '.log': 'text/plain',

    // æ–‡æ¡£
    '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    '.pdf': 'application/pdf',
    '.xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    '.xls': 'application/vnd.ms-excel',

    // å›¾ç‰‡
    '.png': 'image/png',
    '.jpg': 'image/jpeg',
    '.jpeg': 'image/jpeg',
    '.webp': 'image/webp',

    // éŸ³é¢‘
    '.mp3': 'audio/mpeg',
    '.wav': 'audio/wav',
};

/**
 * [æ–°å¢] æ ¸å¿ƒå‡½æ•°ï¼šå°†æ–‡ä»¶è·¯å¾„è½¬æ¢ä¸º File å¯¹è±¡ã€‚
 * @param {string} filePath - æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚
 * @returns {Promise<File|null>} - è¿”å›ä¸€ä¸ªå¯ä¾›å‰ç«¯ä½¿ç”¨çš„ File å¯¹è±¡ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å› nullã€‚
 */
const handleFilePath = async (filePath) => {
    try {
        // 1. éªŒè¯è·¯å¾„æ˜¯å¦å­˜åœ¨
        await fs.access(filePath);

        // 2. è¯»å–æ–‡ä»¶å†…å®¹åˆ° Buffer
        const fileBuffer = await fs.readFile(filePath);

        // 3. è·å–æ–‡ä»¶å
        const fileName = path.basename(filePath);

        // 4. è·å–æ–‡ä»¶åç¼€å¹¶æŸ¥æ‰¾å¯¹åº”çš„ MIME ç±»å‹
        const extension = path.extname(fileName).toLowerCase();
        const mimeType = extensionToMimeType[extension] || 'application/octet-stream'; // æä¾›ä¸€ä¸ªå®‰å…¨çš„é»˜è®¤å€¼

        // 5. åˆ›å»ºä¸€ä¸ªå‰ç«¯å¯ä»¥è¯†åˆ«çš„ File å¯¹è±¡
        //    File æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªåŒ…å« [BlobPart] çš„æ•°ç»„ï¼ŒNode.js çš„ Buffer å¯ä»¥ç›´æ¥ä½œä¸º BlobPart ä½¿ç”¨ã€‚
        const fileObject = new File([fileBuffer], fileName, { type: mimeType });

        return fileObject;

    } catch (error) {
        console.error(`å¤„ç†æ–‡ä»¶è·¯å¾„å¤±è´¥: ${filePath}`, error);
        return null;
    }
};

// ï¼ˆæ–‡ä»¶è·¯å¾„=>æ–‡ä»¶å¯¹è±¡=>æ–‡ä»¶åˆ—è¡¨=>å¯¹è¯æ ¼å¼ï¼‰
async function sendfileDirect(filePathList) {
    if (!filePathList || filePathList.length === 0) {
        return [];
    }
    const contentPromises = filePathList.map(async (item) => {
        try {
            const filePath = item.path;
            if (!filePath || typeof filePath !== 'string') {
                return null;
            }
            // 1. è·¯å¾„ -> File å¯¹è±¡
            const fileObject = await handleFilePath(filePath);
            if (!fileObject) {
                utools.showNotification('æ— æ³•è¯»å–æˆ–è®¿é—®æ–‡ä»¶:', filePath);
                return null;
            }
            // 2. File å¯¹è±¡ -> Base64 Data URL
            const base64String = fileObject.stream ? Buffer.from(await fileObject.arrayBuffer()).toString('base64') : '';
            const dataUrl = `data:${fileObject.type};base64,${base64String}`;
            const fileForHandler = {
                name: fileObject.name,
                size: fileObject.size,
                type: fileObject.type,
                url: dataUrl
            };
            return await parseFileObject(fileForHandler);
        } catch (error) {
            console.error(`å¤„ç†æ–‡ä»¶å‡ºé”™: ${item.path}`, error);
            // ä»…åœ¨éä¸æ”¯æŒç±»å‹é”™è¯¯æ—¶å¼¹çª—ï¼Œé¿å…éªšæ‰°
            if (!error.message.includes('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹')) {
                utools.showNotification('å¤„ç†æ–‡ä»¶å‡ºé”™:', item.path);
            }
            return null;
        }
    });
    // ç­‰å¾…æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆï¼Œå¹¶è¿‡æ»¤æ‰å¤±è´¥çš„(null)
    const contentList = (await Promise.all(contentPromises)).filter(Boolean);

    return contentList;
}

function saveFile(options) {
    return new Promise((resolve, reject) => {
        try {
            const { fileContent, ...dialogOptions } = options;
            const savePath = utools.showSaveDialog(dialogOptions);
            if (!savePath) {
                return reject(new Error('ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜æ“ä½œ'));
            }
            fs_node.writeFileSync(savePath, fileContent, 'utf-8');
            resolve({ success: true, path: savePath });
        } catch (error) {
            reject(error);
        }
    });
}

/**
 * [æ–°å¢] å¼¹å‡ºç›®å½•é€‰æ‹©æ¡†
 * @returns {Promise<string|null>} è¿”å›é€‰æ‹©çš„ç›®å½•è·¯å¾„ï¼Œå¦‚æœå–æ¶ˆåˆ™è¿”å› null
 */
async function selectDirectory() {
    const result = utools.showOpenDialog({
        properties: ['openDirectory']
    });
    return result && result.length > 0 ? result[0] : null;
}

/**
 * [æ–°å¢] è¯»å–æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰ .json æ–‡ä»¶ä¿¡æ¯
 * @param {string} dirPath - ç›®å½•è·¯å¾„
 * @returns {Promise<Array<object>>} è¿”å›æ–‡ä»¶ä¿¡æ¯æ•°ç»„
 */
async function listJsonFiles(dirPath) {
    if (!dirPath) return [];
    const files = await fs.readdir(dirPath);
    const jsonFiles = files.filter(file => path.extname(file).toLowerCase() === '.json');

    const fileDetails = await Promise.all(
        jsonFiles.map(async file => {
            const filePath = path.join(dirPath, file);
            try {
                const stats = await fs_node.promises.stat(filePath);
                return {
                    basename: file,
                    path: filePath,
                    lastmod: stats.mtime.toISOString(),
                    size: stats.size,
                    type: 'file'
                };
            } catch (error) {
                console.error(`æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯: ${filePath}`, error);
                return null;
            }
        })
    );
    return fileDetails.filter(Boolean).sort((a, b) => new Date(b.lastmod) - new Date(a.lastmod));
}

/**
 * å–æœ¬åœ°æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒ AbortSignal
 * @param {string} filePath - æ–‡ä»¶è·¯å¾„
 * @param {AbortSignal} signal - ç”¨äºå–æ¶ˆæ“ä½œçš„ä¿¡å·
 * @returns {Promise<string>} æ–‡ä»¶å†…å®¹
 */
async function readLocalFile(filePath, signal) {
    return await fs.readFile(filePath, { encoding: 'utf-8', signal });
}

/**
 * é‡å‘½åæœ¬åœ°æ–‡ä»¶
 * @param {string} oldPath 
 * @param {string} newPath 
 * @returns {Promise<void>}
 */
async function renameLocalFile(oldPath, newPath) {
    return await fs.rename(oldPath, newPath);
}

/**
 * åˆ é™¤æœ¬åœ°æ–‡ä»¶
 * @param {string} filePath 
 * @returns {Promise<void>}
 */
async function deleteLocalFile(filePath) {
    return await fs.unlink(filePath);
}

/**
 * å¼‚æ­¥å°†å†…å®¹å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼Œæ”¯æŒ AbortSignal
 * @param {string} filePath - æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
 * @param {string} content - è¦å†™å…¥çš„æ–‡ä»¶å†…å®¹
 * @param {AbortSignal} signal - ç”¨äºå–æ¶ˆæ“ä½œçš„ä¿¡å·
 * @returns {Promise<void>}
 */
async function writeLocalFile(filePath, content, signal) {
    return await fs.writeFile(filePath, content, { encoding: 'utf-8', signal });
}

/**
 * è®¾ç½®æœ¬åœ°æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´
 * @param {string} filePath - æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
 * @param {Date | string | number} mtime - æ–°çš„ä¿®æ”¹æ—¶é—´
 * @returns {Promise<void>}
 */
async function setFileMtime(filePath, mtime) {
    const date = new Date(mtime);
    // utimes éœ€è¦ access time å’Œ modification time
    // æˆ‘ä»¬å°† access time ä¹Ÿè®¾ç½®ä¸º modification time
    return await fs.utimes(filePath, date, date);
}

module.exports = {
    handleFilePath, // (æ–‡ä»¶è·¯å¾„=>æ–‡ä»¶å¯¹è±¡)
    sendfileDirect, //ï¼ˆæ–‡ä»¶è·¯å¾„=>æ–‡ä»¶å¯¹è±¡=>æ–‡ä»¶åˆ—è¡¨=>å¯¹è¯æ ¼å¼ï¼‰
    saveFile,

    selectDirectory,
    listJsonFiles,
    readLocalFile,
    renameLocalFile,
    deleteLocalFile,
    writeLocalFile,
    setFileMtime,
    isFileTypeSupported,
    parseFileObject,
};
```
```js
./backend/src/input.js
function getRandomItem(list) {
  // æ£€æŸ¥listæ˜¯ä¸æ˜¯å­—ç¬¦ä¸²
  if (typeof list === "string") {
    // å¦‚æœå­—ç¬¦ä¸²åŒ…å«é€—å·
    if (list.includes(",")) {
      list = list.split(",");
      // åˆ é™¤ç©ºç™½å­—ç¬¦
      list = list.filter(item => item.trim() !== "");
    }
    else if (list.includes("ï¼Œ")) {
      list = list.split("ï¼Œ");
      // åˆ é™¤ç©ºç™½å­—ç¬¦
      list = list.filter(item => item.trim() !== "");
    }
    else {
      return list;
    }
  }

  if (list.length === 0) {
    return "";
  }
  else {
    const resault = list[Math.floor(Math.random() * list.length)];
    return resault;
  }
}

// å‡½æ•°ï¼šå¤„ç†æ–‡æœ¬
async function requestTextOpenAI(code, content, config) {
    // ä» prompt é…ç½®ä¸­è·å–æ¨¡å‹ä¿¡æ¯
    const modelInfo = config.prompts[code].model;
    let apiUrl = config.apiUrl;
    let apiKey = config.apiKey;
    let model = config.modelSelect;

    if (modelInfo) {
        const [providerId, modelName] = modelInfo.split("|");
        const provider = config.providers[providerId];
        if (provider) {
            apiUrl = provider.url;
            apiKey = provider.api_key;
            model = modelName;
        }
    }
    if (config.prompts[code] && config.prompts[code].ifTextNecessary) {
        const now = new Date();
        const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        // å¦‚æœæ˜¯å­—ç¬¦ä¸²
        if (typeof content === "string") {
            content = timestamp + "\n\n" + content;
        }
        else if (Array.isArray(content)) {
            let flag = false;
            for (let i = 0; i < content.length; i++) {
                // æ˜¯æ–‡æœ¬ç±»å‹ï¼Œä¸”ä¸æ˜¯æ–‡æœ¬æ–‡ä»¶
                if (content[i].type === "content" && content[i].text && !(content[i].text.toLowerCase().startsWith('file name:') && content[i].text.toLowerCase().endsWith('file end'))) {
                    content[i].text = timestamp + "\n\n" + content[i].text;
                    flag = true;
                    break;
                }
            }
            if (!flag) {
                content.push({
                    type: "text",
                    text: timestamp
                });
            }
        }
    }

    const isStream = config.prompts[code].stream ?? true;
    
    const response = await fetch(apiUrl + "/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + getRandomItem(apiKey),
        },
        body: JSON.stringify({
            model: model,
            messages: [
                {
                    role: "system",
                    content: config.prompts[code].prompt,
                },
                {
                    role: "user",
                    content: content,
                },
            ],
            stream: isStream,
        }),
    });
    return response;
}

// å‡½æ•°ï¼šè¾“å‡º
async function handelReplyOpenAI(code, response, stream) {
    try {
        if (stream) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";
            let output = "";
            let is_think_flag = false;
            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    break;
                }

                buffer += decoder.decode(value, { stream: true });

                let boundary = buffer.lastIndexOf("\n");
                if (boundary !== -1) {
                    const completeData = buffer.substring(0, boundary);
                    buffer = buffer.substring(boundary + 1);
                    // openrouterçš„ç‰¹æ®Šå¤„ç†
                    if (completeData.trim() === ": OPENROUTER PROCESSING") {
                        continue
                    }
                    const lines = completeData
                        .split("\n")
                        .filter((line) => line.trim() !== "");
                    for (const line of lines) {
                        const message = line.replace(/^data: /, "");
                        if (message === "[DONE]") {
                            if (output.trim()) {
                                utools.hideMainWindowTypeString(output.trimEnd());
                            }
                            break;
                        }
                        try {
                            const parsed = JSON.parse(message);
                            if (parsed.choices[0].delta.content) {

                                if (output.trim() === "<think>" && !is_think_flag) {  // æ€è€ƒå¼€å§‹
                                    is_think_flag = true;
                                }
                                else if (output.trim() === "</think>" && is_think_flag) {  // æ€è€ƒä¸­
                                    is_think_flag = false;
                                }
                                else if (is_think_flag) {  // æ€è€ƒç»“æŸ
                                }
                                else {  // éæ€è€ƒé˜¶æ®µ
                                    utools.hideMainWindowTypeString(output);
                                }
                                output = parsed.choices[0].delta.content;
                            }
                        } catch (error) {
                            utools.showNotification(
                                "Could not parse stream message",
                                message,
                                error
                            );
                            return;
                        }
                    }
                }
            }
        } else {
            const data = await response.json();
            utools.hideMainWindowTypeString(data.choices[0].message.content.trimEnd());
        }
    } catch (error) {
        utools.showNotification("error: " + error);
    }
}

module.exports = {
    requestTextOpenAI,
    handelReplyOpenAI,
    getRandomItem,
};
```
```js
./backend/src/mcp.js
const { MultiServerMCPClient } = require("@langchain/mcp-adapters");
const { getBuiltinTools, invokeBuiltinTool } = require('./mcp_builtin.js');

const PERSISTENT_CONNECTION_LIMIT = 5; // uTools é™åˆ¶æœ€å¤š5ä¸ªæŒä¹…è¿æ¥
const ON_DEMAND_CONCURRENCY_LIMIT = 5; // éæŒä¹…è¿æ¥çš„å¹¶å‘é™åˆ¶

let persistentClients = new Map(); // å­˜å‚¨æŒä¹…åŒ–å®¢æˆ·ç«¯å®ä¾‹ï¼Œå®ƒä»¬ä¼šä¸€ç›´å­˜åœ¨ç›´åˆ°è¢«æ˜ç¡®å…³é—­
let fullToolInfoMap = new Map();
let currentlyConnectedServerIds = new Set();

function normalizeTransportType(transport) {
  const streamableHttpRegex = /^streamable[\s_-]?http$/i;
  if (streamableHttpRegex.test(transport)) {
    return 'http';
  }
  return transport;
}

/**
 * ç‹¬ç«‹è¿æ¥å¹¶è·å–å·¥å…·åˆ—è¡¨çš„å‡½æ•°
 * ç”¨äºæµ‹è¯•è¿æ¥ï¼Œä»¥åŠæ— ç¼“å­˜æ—¶çš„ä¸´æ—¶è¿æ¥è·å–
 * åŒ…å« 10s è¶…æ—¶å’Œå¼ºåˆ¶å…³é—­é€»è¾‘
 */
async function connectAndFetchTools(id, config) {
  // [æ‹¦æˆª] å†…ç½®ç±»å‹ç›´æ¥è¿”å›å®šä¹‰çš„å·¥å…·åˆ—è¡¨
  if (config.transport === 'builtin' || config.type === 'builtin') {
    return getBuiltinTools(id);
  }

  // console.log(`[MCP] Connecting to ${id} (${config.transport})...`);
  let tempClient = null;
  const controller = new AbortController();

  // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢è¿æ¥å¡æ­»å¯¼è‡´æ— æ³•å…³é—­ (ç‰¹åˆ«æ˜¯ stdio)
  const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶

  try {
    const modifiedConfig = { ...config, transport: normalizeTransportType(config.transport) };

    // åˆ›å»ºå®¢æˆ·ç«¯
    tempClient = new MultiServerMCPClient({ [id]: { id, ...modifiedConfig } }, { signal: controller.signal });

    // è·å–å·¥å…·
    const tools = await tempClient.getTools();
    // console.log(`[MCP] Successfully fetched ${tools.length} tools from ${id}`);

    return tools; // è¿”å›åŸç”Ÿå·¥å…·æ•°ç»„
  } catch (error) {
    console.error(`[MCP] Error fetching tools from ${id}:`, error);
    throw error;
  } finally {
    clearTimeout(timeoutId);
    controller.abort(); // ç¡®ä¿ä¿¡å·ä¸­æ­¢
    if (tempClient) {
      try {
        // console.log(`[MCP] Closing temp connection for ${id}...`);
        await tempClient.close();
        // console.log(`[MCP] Connection closed for ${id}`);
      } catch (closeError) {
        console.error(`[MCP] Error closing connection for ${id}:`, closeError);
      }
    }
  }
}

/**
 * å¢é‡å¼åœ°åˆå§‹åŒ–/åŒæ­¥ MCP å®¢æˆ·ç«¯ã€‚
 * 1. å…ˆå¤„ç†éæŒä¹…è¿æ¥ï¼ˆä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œæ— ç¼“å­˜åˆ™å³ç”¨å³èµ°å¹¶è‡ªåŠ¨ç¼“å­˜ï¼‰
 * 2. å†å¤„ç†æŒä¹…è¿æ¥
 * 3. saveCacheCallback å‚æ•°ï¼Œç”¨äºè‡ªåŠ¨ç¼“å­˜è·å–åˆ°çš„å·¥å…·
 */
async function initializeMcpClient(activeServerConfigs = {}, cachedToolsMap = {}, saveCacheCallback = null) {
  const newIds = new Set(Object.keys(activeServerConfigs));
  const oldIds = new Set(currentlyConnectedServerIds);

  const idsToAdd = [...newIds].filter(id => !oldIds.has(id));
  const idsToRemove = [...oldIds].filter(id => !newIds.has(id));
  const failedServerIds = [];

  // --- æ­¥éª¤ 1: å¤„ç†éœ€è¦ç§»é™¤çš„æœåŠ¡ ---
  for (const id of idsToRemove) {
    if (persistentClients.has(id)) {
      const client = persistentClients.get(id);
      try { await client.close(); } catch (e) { }
      persistentClients.delete(id);
    }
    // ç§»é™¤ç›¸å…³å·¥å…·
    for (const [toolName, toolInfo] of fullToolInfoMap.entries()) {
      if (toolInfo.serverConfig.id === id) {
        fullToolInfoMap.delete(toolName);
      }
    }
    currentlyConnectedServerIds.delete(id);
  }

  const onDemandConfigsToAdd = idsToAdd
    .map(id => ({ id, config: activeServerConfigs[id] }))
    .filter(({ config }) => config && !config.isPersistent);

  const persistentConfigsToAdd = idsToAdd
    .map(id => ({ id, config: activeServerConfigs[id] }))
    .filter(({ config }) => config && config.isPersistent);

  // è¾…åŠ©å‡½æ•°ï¼šè·å–å·¥å…·çš„å¯ç”¨çŠ¶æ€
  const getToolEnabledState = (serverId, toolName) => {
    if (cachedToolsMap && cachedToolsMap[serverId]) {
      const cachedTool = cachedToolsMap[serverId].find(t => t.name === toolName);
      // å¦‚æœç¼“å­˜ä¸­æœ‰è®°å½•ï¼Œä½¿ç”¨ç¼“å­˜çš„ enabledï¼Œå¦åˆ™é»˜è®¤ true
      return cachedTool ? (cachedTool.enabled ?? true) : true;
    }
    return true;
  };

  // --- æ­¥éª¤ 2: å¤„ç†éæŒä¹…åŒ–ï¼ˆå³ç”¨å³èµ°ï¼‰è¿æ¥ ---
  const onDemandToConnect = [];

  for (const { id, config } of onDemandConfigsToAdd) {
    const isBuiltin = config.transport === 'builtin' || config.type === 'builtin';

    // å¦‚æœæ˜¯å†…ç½®æœåŠ¡ï¼Œä¸å†ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œç¡®ä¿èµ° onDemandToConnect è·¯å¾„ä»¥æ‹‰å–æºç å®šä¹‰
    if (!isBuiltin && cachedToolsMap && cachedToolsMap[id] && Array.isArray(cachedToolsMap[id]) && cachedToolsMap[id].length > 0) {
      const tools = cachedToolsMap[id];
      tools.forEach(tool => {
        fullToolInfoMap.set(tool.name, {
          schema: tool.inputSchema || tool.schema,
          description: tool.description,
          isPersistent: false,
          serverConfig: { id, ...config },
          isBuiltin: false,
          enabled: tool.enabled ?? true
        });
      });
      currentlyConnectedServerIds.add(id);
    } else {
      onDemandToConnect.push({ id, config });
    }
  }

  // å¯¹æ— ç¼“å­˜(æˆ–å†…ç½®)çš„éæŒä¹…åŒ–æœåŠ¡è¿›è¡Œè¿æ¥è·å–
  if (onDemandToConnect.length > 0) {
    const pool = new Set();
    const allTasks = [];

    for (const { id, config } of onDemandToConnect) {
      const taskPromise = (async () => {
        try {
          const tools = await connectAndFetchTools(id, config);

          // è‡ªåŠ¨ç¼“å­˜é€»è¾‘
          if (saveCacheCallback && typeof saveCacheCallback === 'function') {
            // ä¿å­˜å‰åˆå¹¶æ—§ç¼“å­˜çš„ enabled çŠ¶æ€
            const oldToolsCache = cachedToolsMap[id] || [];
            const sanitizedTools = tools.map(tool => {
              const oldTool = oldToolsCache.find(t => t.name === tool.name);
              return {
                name: tool.name,
                description: tool.description,
                inputSchema: tool.inputSchema || tool.schema || {},
                enabled: oldTool ? (oldTool.enabled ?? true) : true
              };
            });
            const cleanTools = JSON.parse(JSON.stringify(sanitizedTools));
            saveCacheCallback(id, cleanTools).catch(e => console.error(`[MCP] Auto-cache failed for ${id}:`, e));
          }

          const isBuiltin = config.transport === 'builtin' || config.type === 'builtin';

          tools.forEach(tool => {
            fullToolInfoMap.set(tool.name, {
              schema: tool.schema || tool.inputSchema,
              description: tool.description,
              isPersistent: false,
              serverConfig: { id, ...config },
              isBuiltin: isBuiltin,
              enabled: getToolEnabledState(id, tool.name) // [æ–°å¢] åº”ç”¨çŠ¶æ€
            });
          });
          currentlyConnectedServerIds.add(id);
        } catch (error) {
          if (error.name !== 'AbortError') console.error(`[MCP Debug] Failed to process on-demand server ${id}. Error:`, error.message);
          failedServerIds.push(id);
        }
      })();

      allTasks.push(taskPromise);
      pool.add(taskPromise);
      const cleanup = () => pool.delete(taskPromise);
      taskPromise.then(cleanup, cleanup);

      if (pool.size >= 5) { // ON_DEMAND_CONCURRENCY_LIMIT
        await Promise.race(pool);
      }
    }
    await Promise.all(allTasks);
  }

  // --- æ­¥éª¤ 3: å¤„ç†éœ€è¦æŒä¹…åŒ–çš„è¿æ¥ ---
  if (persistentConfigsToAdd.length > 0) {
    for (const { id, config } of persistentConfigsToAdd) {
      // å†…ç½®ä¸”æŒä¹…åŒ–
      if (config.transport === 'builtin' || config.type === 'builtin') {
        try {
          const tools = require('./mcp_builtin.js').getBuiltinTools(id);

          // [æ–°å¢] å¼ºåˆ¶æ›´æ–°å†…ç½®æœåŠ¡çš„ç¼“å­˜
          if (saveCacheCallback && typeof saveCacheCallback === 'function') {
            const oldToolsCache = cachedToolsMap[id] || [];
            const sanitizedTools = tools.map(tool => {
              const oldTool = oldToolsCache.find(t => t.name === tool.name);
              return {
                name: tool.name,
                description: tool.description,
                inputSchema: tool.inputSchema || tool.schema || {},
                enabled: oldTool ? (oldTool.enabled ?? true) : true // ä¿ç•™ç”¨æˆ·çš„å¼€å…³çŠ¶æ€
              };
            });
            saveCacheCallback(id, JSON.parse(JSON.stringify(sanitizedTools))).catch(e => { });
          }

          tools.forEach(tool => {
            fullToolInfoMap.set(tool.name, {
              schema: tool.schema || tool.inputSchema,
              description: tool.description,
              isPersistent: true,
              serverConfig: { id, ...config },
              isBuiltin: true,
              enabled: getToolEnabledState(id, tool.name)
            });
          });
          currentlyConnectedServerIds.add(id);
        } catch (e) {
          failedServerIds.push(id);
        }
        continue;
      }

      if (persistentClients.size >= 5) { // PERSISTENT_CONNECTION_LIMIT
        failedServerIds.push(id);
        continue;
      }
      try {
        const modifiedConfig = { ...config, transport: normalizeTransportType(config.transport) };
        const client = new MultiServerMCPClient({ [id]: { id, ...modifiedConfig } });
        const tools = await client.getTools();

        if (saveCacheCallback && typeof saveCacheCallback === 'function') {
          const oldToolsCache = cachedToolsMap[id] || [];
          const sanitizedTools = tools.map(tool => {
            const oldTool = oldToolsCache.find(t => t.name === tool.name);
            return {
              name: tool.name,
              description: tool.description,
              inputSchema: tool.inputSchema || tool.schema || {},
              enabled: oldTool ? (oldTool.enabled ?? true) : true
            };
          });
          const cleanTools = JSON.parse(JSON.stringify(sanitizedTools));
          saveCacheCallback(id, cleanTools).catch(e => console.error(`[MCP] Auto-cache failed for persistent ${id}:`, e));
        }

        tools.forEach(tool => {
          fullToolInfoMap.set(tool.name, {
            instance: tool,
            schema: tool.schema || tool.inputSchema,
            description: tool.description,
            isPersistent: true,
            serverConfig: { id, ...config },
            isBuiltin: false,
            enabled: getToolEnabledState(id, tool.name) // [æ–°å¢] åº”ç”¨çŠ¶æ€
          });
        });
        persistentClients.set(id, client);
        currentlyConnectedServerIds.add(id);
      } catch (error) {
        console.error(`[MCP Debug] Failed to connect to persistent server ${id}:`, error);
        failedServerIds.push(id);
        const client = persistentClients.get(id);
        if (client) await client.close();
        persistentClients.delete(id);
      }
    }
  }

  return {
    openaiFormattedTools: buildOpenaiFormattedTools(),
    successfulServerIds: [...currentlyConnectedServerIds],
    failedServerIds
  };
}

function buildOpenaiFormattedTools() {
  const formattedTools = [];
  for (const [toolName, toolInfo] of fullToolInfoMap.entries()) {
    if (toolInfo.schema && toolInfo.enabled !== false) {
      formattedTools.push({
        type: "function",
        function: { name: toolName, description: toolInfo.description, parameters: toolInfo.schema }
      });
    }
  }
  return formattedTools;
}

/**
 * æ­¤æ—¶å¦‚æœæ˜¯éæŒä¹…åŒ–è¿æ¥ï¼Œä¼šå†æ¬¡åˆ›å»ºä¸´æ—¶è¿æ¥æ¥æ‰§è¡Œå·¥å…·
 */
async function invokeMcpTool(toolName, toolArgs, signal, context = null) {
  const toolInfo = fullToolInfoMap.get(toolName);

  if (!toolInfo) {
    try {
      const { invokeBuiltinTool } = require('./mcp_builtin.js');
      return await invokeBuiltinTool(toolName, toolArgs, signal, context);
    } catch (e) {
      throw new Error(`Tool "${toolName}" not found.`);
    }
  }

  if (toolInfo.enabled === false) {
    throw new Error(`Tool "${toolName}" has been disabled.`);
  }

  // 2. å¦‚æœæ˜¯æ³¨å†Œè¿‡çš„å†…ç½®å·¥å…·ï¼Œè°ƒç”¨ invokeBuiltinTool å¹¶ä¼ é€’ signal å’Œ context
  if (toolInfo.isBuiltin) {
    const { invokeBuiltinTool } = require('./mcp_builtin.js');
    return await invokeBuiltinTool(toolName, toolArgs, signal, context);
  }

  // 3. æŒä¹…è¿æ¥
  if (toolInfo.isPersistent && toolInfo.instance) {
    return await toolInfo.instance.invoke(toolArgs, { signal });
  }

  // 4. ä¸´æ—¶è¿æ¥
  const serverConfig = toolInfo.serverConfig;
  if (!toolInfo.isPersistent && serverConfig) {
    let tempClient = null;
    const controller = new AbortController();

    // è¿æ¥å¤–éƒ¨ä¼ å…¥çš„ signal
    if (signal) {
      if (signal.aborted) controller.abort();
      signal.addEventListener('abort', () => controller.abort());
    }

    try {
      const modifiedConfig = { ...serverConfig };
      modifiedConfig.transport = normalizeTransportType(modifiedConfig.transport);

      tempClient = new MultiServerMCPClient({ [serverConfig.id]: { id: serverConfig.id, ...modifiedConfig } }, { signal: controller.signal });
      const tools = await tempClient.getTools();
      const toolToCall = tools.find(t => t.name === toolName);
      if (!toolToCall) throw new Error(`Tool "${toolName}" not found.`);
      return await toolToCall.invoke(toolArgs, { signal: controller.signal });
    } finally {
      // å¦‚æœæ²¡æœ‰å¤–éƒ¨ signalï¼Œæˆ‘ä»¬éœ€è¦è´Ÿè´£æ¸…ç†ï¼›å¦‚æœæœ‰ï¼Œå¤–éƒ¨ signal è§¦å‘ abort æ—¶ controller ä¹Ÿä¼š abort
      if (!signal) controller.abort();
      if (tempClient) await tempClient.close();
    }
  }

  throw new Error(`Configuration error for tool "${toolName}".`);
}

/**
 * ç‹¬ç«‹è¿æ¥å¹¶æ‰§è¡Œå·¥å…·
 * ç”¨äºåœ¨è®¾ç½®ç•Œé¢æµ‹è¯•å…·ä½“çš„å·¥å…·è°ƒç”¨
 */
async function connectAndInvokeTool(id, config, toolName, toolArgs, context = null) {
  // [æ‹¦æˆª] å†…ç½®ç±»å‹ç›´æ¥è°ƒç”¨
  if (config.transport === 'builtin' || config.type === 'builtin') {
    const { invokeBuiltinTool } = require('./mcp_builtin.js');
    return await invokeBuiltinTool(toolName, toolArgs, null, context);
  }

  let tempClient = null;
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 60000);

  try {
    const modifiedConfig = { ...config, transport: normalizeTransportType(config.transport) };
    tempClient = new MultiServerMCPClient({ [id]: { id, ...modifiedConfig } }, { signal: controller.signal });
    const tools = await tempClient.getTools();
    const targetTool = tools.find(t => t.name === toolName || t.name === `${id}_${toolName}`);

    if (!targetTool) {
      throw new Error(`Tool '${toolName}' not found on server '${id}'. Available tools: ${tools.map(t => t.name).join(', ')}`);
    }

    const result = await targetTool.invoke(toolArgs, { signal: controller.signal });
    return result;
  } catch (error) {
    console.error(`[MCP] Error invoking tool ${toolName} on ${id}:`, error);
    throw error;
  } finally {
    clearTimeout(timeoutId);
    controller.abort();
    if (tempClient) {
      try {
        if (typeof tempClient.close === 'function') {
          await tempClient.close();
        }
      } catch (closeError) {
        console.error(`[MCP] Error closing temp connection for ${id}:`, closeError);
      }
    }
  }
}

async function closeMcpClient() {
  if (persistentClients.size > 0) {
    for (const client of persistentClients.values()) {
      await client.close();
    }
    persistentClients.clear();
  }
  fullToolInfoMap.clear();
  currentlyConnectedServerIds.clear();
}

module.exports = {
  initializeMcpClient,
  invokeMcpTool,
  closeMcpClient,
  connectAndFetchTools, // å¯¼å‡ºä¾›æµ‹è¯•
  connectAndInvokeTool, // å¯¼å‡ºä¾›æµ‹è¯•
};
```
```js
./backend/src/mcp_builtin.js
const fs = require('fs');
const path = require('path');
const os = require('os');
const { exec, spawn } = require('child_process');
const { handleFilePath, parseFileObject } = require('./file.js');

const isWin = process.platform === 'win32';
const currentOS = process.platform === 'win32' ? 'Windows' : (process.platform === 'darwin' ? 'macOS' : 'Linux');

// --- Bash Session State ---
let bashCwd = os.homedir();

const MAX_READ = 512 * 1000; // 512k characters

// æ•°æ®æå–å‡½æ•° (æå–æ ‡é¢˜ã€ä½œè€…ã€ç®€ä»‹)
function extractMetadata(html) {
    const meta = {
        title: '',
        author: '',
        description: '',
        siteName: ''
    };

    // æå– Title
    const titleMatch = html.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
    if (titleMatch) meta.title = titleMatch[1].trim();
    
    // è¾…åŠ©æ­£åˆ™ï¼šä» meta æ ‡ç­¾æå– content
    const getMetaContent = (propName) => {
        const regex = new RegExp(`<meta\\s+(?:name|property)=["']${propName}["']\\s+content=["'](.*?)["']`, 'i');
        const match = html.match(regex);
        return match ? match[1].trim() : null;
    };

    // å°è¯•å¤šç§å¸¸è§çš„ Meta æ ‡ç­¾
    meta.title = getMetaContent('og:title') || getMetaContent('twitter:title') || meta.title;
    meta.author = getMetaContent('author') || getMetaContent('article:author') || getMetaContent('og:site_name') || 'Unknown Author';
    meta.description = getMetaContent('description') || getMetaContent('og:description') || getMetaContent('twitter:description') || '';
    meta.siteName = getMetaContent('og:site_name') || '';

    return meta;
}

// HTML è½¬ Markdown è¾…åŠ©å‡½æ•°
function convertHtmlToMarkdown(html, baseUrl = '') {
    let text = html;

    // --- 1. SPA/SEO å¢å¼ºï¼šæ£€æŸ¥ <noscript> ---
    // å¾ˆå¤šå•é¡µåº”ç”¨(Linux.do, Discourse)ä¼šå°†æ­£æ–‡æ”¾åœ¨ noscript ä¸­ä¾›çˆ¬è™«è¯»å–
    // å¦‚æœ noscript å†…å®¹æ¯”å½“å‰ body å†…å®¹é•¿å¾ˆå¤šï¼Œä¼˜å…ˆä½¿ç”¨ noscript
    const noscriptMatch = text.match(/<noscript[^>]*>([\s\S]*?)<\/noscript>/i);
    const bodyMatch = text.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
    
    let bodyText = bodyMatch ? bodyMatch[1] : text;
    if (noscriptMatch && noscriptMatch[1].length > bodyText.length) {
        text = noscriptMatch[1];
    } else {
        text = bodyText;
    }

    // --- 2. ç§»é™¤ç»å¯¹æ— å…³çš„æ ‡ç­¾ ---
    text = text.replace(/<(script|style|svg|noscript|iframe|form|button|input|select|option|textarea)[^>]*>[\s\S]*?<\/\1>/gi, '');
    
    // --- 3. ç§»é™¤ HTML5 è¯­ä¹‰åŒ–å™ªéŸ³æ ‡ç­¾ ---
    text = text.replace(/<(nav|footer|aside)[^>]*>[\s\S]*?<\/\1>/gi, '');

    // --- 4. åŸºäºç±»å/ID çš„é€šç”¨é™å™ª ---
    const noiseKeywords = "sidebar|comment|recommend|advert|ads|menu|login|modal|popup|cookie|auth|related|footer|copyright";
    const noiseRegex = new RegExp(`<div[^>]*(?:id|class)=["'][^"']*(${noiseKeywords})[^"']*["'][^>]*>[\\s\\S]*?<\\/div>`, 'gi');
    text = text.replace(noiseRegex, ''); 
    text = text.replace(noiseRegex, ''); 

    // --- 5. ç§»é™¤æ³¨é‡Š ---
    text = text.replace(/<!--[\s\S]*?-->/g, '');

    // --- 6. è¾…åŠ©å‡½æ•°ï¼šå¤„ç†ç›¸å¯¹ URL ---
    const resolveUrl = (relativeUrl) => {
        if (!relativeUrl || !baseUrl) return relativeUrl;
        if (relativeUrl.startsWith('http')) return relativeUrl;
        if (relativeUrl.startsWith('data:')) return ''; 
        try {
            return new URL(relativeUrl, baseUrl).href;
        } catch (e) {
            return relativeUrl;
        }
    };

    // --- 7. å…ƒç´ è½¬æ¢ Markdown ---
    text = text.replace(/<h([1-6])[^>]*>([\s\S]*?)<\/h\1>/gi, (match, level, content) => {
        const cleanContent = content.replace(/<[^>]+>/g, '').trim();
        return cleanContent ? `\n\n${'#'.repeat(level)} ${cleanContent}\n` : '';
    });

    text = text.replace(/<\/li>/gi, '\n');
    text = text.replace(/<li[^>]*>/gi, '- ');
    text = text.replace(/<\/(ul|ol)>/gi, '\n\n');
    text = text.replace(/<\/(p|div|tr|table|article|section|blockquote|main)>/gi, '\n');
    text = text.replace(/<br\s*\/?>/gi, '\n');

    text = text.replace(/<img[^>]*src="([^"]*)"[^>]*alt="([^"]*)"[^>]*>/gi, (match, src, alt) => {
        const fullUrl = resolveUrl(src);
        return fullUrl ? `\n![${alt.trim()}](${fullUrl})\n` : '';
    });
    text = text.replace(/<img[^>]*src="([^"]*)"[^>]*>/gi, (match, src) => {
        const fullUrl = resolveUrl(src);
        return fullUrl ? `\n![](${fullUrl})\n` : '';
    });

    text = text.replace(/<a[^>]*href="([^"]*)"[^>]*>([\s\S]*?)<\/a>/gi, (match, href, content) => {
        const cleanContent = content.replace(/<[^>]+>/g, '').trim();
        if (!cleanContent || href.startsWith('javascript:') || href.startsWith('#')) return cleanContent;
        return ` [${cleanContent}](${resolveUrl(href)}) `;
    });

    text = text.replace(/<(b|strong)[^>]*>([\s\S]*?)<\/\1>/gi, '**$2**');
    
    // ä»£ç å—å¤„ç†
    text = text.replace(/<pre[^>]*>[\s\S]*?<code[^>]*>([\s\S]*?)<\/code>[\s\S]*?<\/pre>/gi, (match, code) => {
        return `\n\`\`\`\n${code}\n\`\`\`\n`;
    });
    text = text.replace(/<pre[^>]*>([\s\S]*?)<\/pre>/gi, '\n```\n$1\n```\n');
    text = text.replace(/<code[^>]*>([\s\S]*?)<\/code>/gi, ' `$1` ');

    // --- 8. ç§»é™¤å‰©ä½™ HTML æ ‡ç­¾ ---
    text = text.replace(/<[^>]+>/g, '');

    // --- 9. å®ä½“è§£ç  ---
    const entities = { '&nbsp;': ' ', '&amp;': '&', '&lt;': '<', '&gt;': '>', '&quot;': '"', '&#39;': "'", '&copy;': 'Â©', '&mdash;': 'â€”' };
    text = text.replace(/&[a-z0-9]+;/gi, (match) => entities[match] || '');

    // --- 10. è¡Œçº§æ¸…æ´—ä¸å»é‡ ---
    const lines = text.split('\n').map(line => line.trim());
    const cleanLines = [];
    
    const lineNoiseRegex = /^(Sign in|Sign up|Log in|Register|Subscribe|Share|Follow us|Menu|Top|Home|About|Contact|Privacy|Terms)/i;

    let blankLineCount = 0;

    for (let line of lines) {
        if (!line) {
            blankLineCount++;
            if (blankLineCount < 2) cleanLines.push(''); 
            continue;
        }
        blankLineCount = 0;

        // [æ–°å¢] è¿‡æ»¤çº¯æ•°å­—è¡Œ (è§£å†³ä»£ç å—è¡Œå·é—®é¢˜)
        if (/^\d+$/.test(line)) continue;

        // [æ–°å¢] è¿‡æ»¤æçŸ­çš„çº¯ç¬¦å·è¡Œ
        if (line.length < 5 && !/[a-zA-Z0-9\u4e00-\u9fa5]/.test(line)) continue;

        // è¿‡æ»¤å¯¼èˆªç±»å™ªéŸ³
        if (line.length < 20 && lineNoiseRegex.test(line)) continue;

        cleanLines.push(line);
    }

    return cleanLines.join('\n'); 
}

// --- Definitions ---
const BUILTIN_SERVERS = {
    "builtin_python": {
        id: "builtin_python",
        name: "Python Executor",
        description: "è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒï¼Œæ‰§è¡Œæœ¬åœ° Python è„šæœ¬ã€‚",
        type: "builtin",
        isActive: false,
        isPersistent: false,
        tags: ["python", "code"],
        logoUrl: "https://upload.wikimedia.org/wikipedia/commons/c/c3/Python-logo-notext.svg"
    },
    "builtin_filesystem": {
        id: "builtin_filesystem",
        name: "File Operations",
        description: "å…¨èƒ½æ–‡ä»¶æ“ä½œå·¥å…·ã€‚æ”¯æŒ Glob æ–‡ä»¶åŒ¹é…ã€Grep å†…å®¹æœç´¢ã€ä»¥åŠæ–‡ä»¶çš„è¯»å–ã€ç¼–è¾‘å’Œå†™å…¥ã€‚æ”¯æŒæœ¬åœ°æ–‡ä»¶åŠè¿œç¨‹URLã€‚",
        type: "builtin",
        isActive: false,
        isPersistent: false,
        tags: ["file", "fs", "read", "write", "edit", "search"],
        logoUrl: "https://cdn-icons-png.flaticon.com/512/2965/2965335.png"
    },
    "builtin_bash": {
        id: "builtin_bash",
        name: "Shell Executor",
        description: isWin ? "æ‰§è¡Œ PowerShell å‘½ä»¤" : "æ‰§è¡Œ Bash å‘½ä»¤",
        type: "builtin",
        isActive: false,
        isPersistent: false,
        tags: ["shell", "bash", "cmd"],
        logoUrl: "https://upload.wikimedia.org/wikipedia/commons/4/4b/Bash_Logo_Colored.svg"
    },
    "builtin_search": {
        id: "builtin_search",
        name: "Web Search",
        description: "ä½¿ç”¨ DuckDuckGo è¿›è¡Œå…è´¹è”ç½‘æœç´¢ï¼Œè·å–ç›¸å…³ç½‘é¡µæ ‡é¢˜ã€é“¾æ¥å’Œæ‘˜è¦ï¼›æŠ“å–ç½‘é¡µå†…å®¹ã€‚",
        type: "builtin",
        isActive: false,
        isPersistent: false,
        tags: ["search", "web", "fetch"],
        logoUrl: "https://upload.wikimedia.org/wikipedia/en/9/90/The_DuckDuckGo_Duck.png"
    },
    "builtin_subagent": {
        id: "builtin_subagent",
        name: "Sub-Agent",
        description: "ä¸€ä¸ªèƒ½å¤Ÿè‡ªä¸»è§„åˆ’çš„å­æ™ºèƒ½ä½“ã€‚ä¸»æ™ºèƒ½ä½“éœ€æ˜¾å¼åˆ†é…å·¥å…·ç»™å®ƒã€‚",
        type: "builtin",
        isActive: false,
        isPersistent: false,
        tags: ["agent"],
        logoUrl: "https://s2.loli.net/2026/01/22/tTsJjkpiOYAeGdy.png"
    },
};

const BUILTIN_TOOLS = {
    "builtin_python": [
        {
            name: "list_python_interpreters",
            description: "Scan the system for available Python interpreters (Path & Conda).",
            inputSchema: { type: "object", properties: {} }
        },
        {
            name: "run_python_code",
            description: "Execute Python code. Writes code to a temporary file and runs it.",
            inputSchema: {
                type: "object",
                properties: {
                    code: { type: "string", description: "The Python code to execute." },
                    interpreter: { type: "string", description: "Optional. Path to specific python executable." }
                },
                required: ["code"]
            }
        },
        {
            name: "run_python_file",
            description: "Execute a local Python script file. Supports setting working directory and arguments.",
            inputSchema: {
                type: "object",
                properties: {
                    file_path: { type: "string", description: "Absolute path to the .py file." },
                    working_directory: { type: "string", description: "Optional. The directory to execute the script in. If not provided, defaults to the file's directory." },
                    interpreter: { type: "string", description: "Optional. Path to specific python executable." },
                    args: { type: "array", items: { type: "string" }, description: "Optional. Command line arguments to pass to the script." }
                },
                required: ["file_path"]
            }
        }
    ],
    "builtin_filesystem": [
        {
            name: "glob_files",
            description: "Fast file pattern matching to locate file paths. Use this to find files before reading them.",
            inputSchema: {
                type: "object",
                properties: {
                    pattern: { type: "string", description: "Glob pattern (e.g., 'src/**/*.ts' for recursive, '*.json' for current dir)." },
                    path: { type: "string", description: "Root directory to search. Defaults to current user home." }
                },
                required: ["pattern"]
            }
        },
        {
            name: "grep_search",
            description: "Search for patterns in file contents using Regex.",
            inputSchema: {
                type: "object",
                properties: {
                    pattern: { type: "string", description: "Regex pattern to search for." },
                    path: { type: "string", description: "Root directory to search." },
                    glob: { type: "string", description: "Glob pattern to filter files (e.g., '**/*.js')." },
                    output_mode: { 
                        type: "string", 
                        enum: ["content", "files_with_matches", "count"], 
                        description: "Output mode: 'content' (lines), 'files_with_matches' (paths only), 'count'." 
                    },
                    multiline: { type: "boolean", description: "Enable multiline matching." }
                },
                required: ["pattern"]
            }
        },
        {
            name: "read_file",
            description: "Read content from a local file path or a remote file. Supports text, code, and document parsing. For large files, use 'offset' and 'length' to read in chunks.",
            inputSchema: {
                type: "object",
                properties: {
                    file_path: { type: "string", description: "Absolute path to the local file OR a valid HTTP/HTTPS URL." },
                    offset: { type: "integer", description: "Optional. The character position to start reading from. Defaults to 0.", default: 0 },
                    length: { type: "integer", description: `Optional. Number of characters to read. Defaults to ${MAX_READ}.`, default: MAX_READ }
                },
                required: ["file_path"]
            }
        },
        {
            name: "edit_file",
            description: "Precise string replacement for modifying code or text files. YOU MUST READ THE FILE FIRST to ensure you have the exact 'old_string'.",
            inputSchema: {
                type: "object",
                properties: {
                    file_path: { type: "string", description: "Absolute path to the local file." },
                    old_string: { type: "string", description: "The EXACT text to be replaced. Must be unique in the file unless replace_all is true." },
                    new_string: { type: "string", description: "The new text to replace with." },
                    replace_all: { type: "boolean", description: "If true, replaces all occurrences. If false, fails if old_string is not unique." }
                },
                required: ["file_path", "old_string", "new_string"]
            }
        },
        {
            name: "write_file",
            description: "Create a new file or completely overwrite an existing file.",
            inputSchema: {
                type: "object",
                properties: {
                    file_path: { type: "string", description: "Absolute path to the file." },
                    content: { type: "string", description: "Full content to write to the file." }
                },
                required: ["file_path", "content"]
            }
        }
    ],
    "builtin_bash": [
        {
            name: "execute_bash_command",
            description: `Execute a shell command on the current ${currentOS} system. Note: Long-running commands (like servers) will be terminated after the timeout (default 15s) to prevent blocking.`,
            inputSchema: {
                type: "object",
                properties: {
                    command: { type: "string", description: `The command to execute (e.g., 'ls -la', 'git status', 'npm install'). Current OS: ${currentOS}.` },
                    timeout: { 
                        type: "integer", 
                        description: "Optional. Timeout in milliseconds. Default is 15000 (15 seconds). Set higher (e.g., 300000 for 5 mins) for long-running tasks like installations.",
                        default: 15000
                    }
                },
                required: ["command"]
            }
        }
    ],
    "builtin_search": [
        {
            name: "web_search",
            description: "Search the internet for a given query. Returns snippets only. Constraint: After replying, 'Sources:' citation links must be included.",
            inputSchema: {
                type: "object",
                properties: {
                    query: { type: "string", description: "The search keywords." },
                    count: { type: "integer", description: "Number of results to return (default 5, max 10)." },
                    language: { 
                        type: "string", 
                        description: "Preferred language/region code (e.g., 'zh-CN', 'en-US', 'jp'). Defaults to 'zh-CN'." 
                    }
                },
                required: ["query"]
            }
        },
        {
            name: "web_fetch",
            description: "Retrieve and parse the FULL text content of a specific URL. Use this when the user provides a URL or after getting a URL from search results. Capable of parsing complex pages like documentation, papers, and code repositories.",
            inputSchema: {
                type: "object",
                properties: {
                    url: { type: "string", description: "The URL of the webpage to read." },
                    offset: { type: "integer", description: "Optional. The character position to start reading from. Defaults to 0.", default: 0 },
                    length: { type: "integer", description: `Optional. Number of characters to read. Defaults to ${MAX_READ}.`, default: MAX_READ }
                },
                required: ["url"]
            }
        }
    ],
    "builtin_subagent": [
        {
            name: "sub_agent",
            description: "Delegates a complex task to a Sub-Agent. You can assign specific tools, set the planning depth, and provide context. The Sub-Agent will autonomous plan and execute.",
            inputSchema: {
                type: "object",
                properties: {
                    task: { type: "string", description: "The detailed task description." },
                    context: { type: "string", description: "Background info, previous conversation summary, code snippets, or user constraints. Do NOT leave empty if the task depends on previous messages." },
                    tools: { 
                        type: "array", 
                        items: { type: "string" }, 
                        description: "List of tool names to grant. You MUST explicitly list the tools required for the task. If omitted or empty, the Sub-Agent will have NO tools." 
                    },
                    planning_level: {
                        type: "string",
                        enum: ["fast", "medium", "high", "custom"],
                        description: "Complexity level: 'fast'(10 steps), 'medium'(20 steps, default), 'high'(30 steps), or 'custom'."
                    },
                    custom_steps: {
                        type: "integer",
                        minimum: 10,
                        maximum: 100,
                        description: "Only used if planning_level is 'custom'."
                    }
                },
                required: ["task", "tools"] 
            }
        }
    ],
};

// --- Helpers ---

// è·¯å¾„è§£æå™¨ï¼šç›¸å¯¹è·¯å¾„é»˜è®¤ç›¸å¯¹äºç”¨æˆ·ä¸»ç›®å½•ï¼Œè€Œä¸æ˜¯æ’ä»¶è¿è¡Œç›®å½•
const resolvePath = (inputPath) => {
    if (!inputPath) return os.homedir();
    let p = inputPath.replace(/^["']|["']$/g, '');
    if (p.startsWith('~')) {
        p = path.join(os.homedir(), p.slice(1));
    }
    if (!path.isAbsolute(p)) {
        p = path.join(os.homedir(), p);
    }
    return path.normalize(p);
};

// ç¨³å¥çš„ Glob è½¬ Regex è½¬æ¢å™¨
const globToRegex = (glob) => {
    if (!glob) return null;
    
    // 1. å°† Glob ç‰¹æ®Šç¬¦å·æ›¿æ¢ä¸ºå”¯ä¸€çš„ä¸´æ—¶å ä½ç¬¦
    // å¿…é¡»å…ˆå¤„ç† ** (é€’å½’)ï¼Œå†å¤„ç† * (å•å±‚)
    let regex = glob
        .replace(/\\/g, '/') // ç»Ÿä¸€åæ–œæ ä¸ºæ­£æ–œæ ï¼Œé˜²æ­¢è½¬ä¹‰æ··ä¹±
        .replace(/\*\*/g, '___DOUBLE_STAR___')
        .replace(/\*/g, '___SINGLE_STAR___')
        .replace(/\?/g, '___QUESTION___');
    
    // 2. è½¬ä¹‰å­—ç¬¦ä¸²ä¸­å‰©ä½™çš„æ‰€æœ‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
    regex = regex.replace(/[\\^$|.+()\[\]{}]/g, '\\$&');
    
    // 3. å°†å ä½ç¬¦æ›¿æ¢å›å¯¹åº”çš„æ­£åˆ™è¡¨è¾¾å¼é€»è¾‘
    // ** -> .* (åŒ¹é…ä»»æ„å­—ç¬¦)
    regex = regex.replace(/___DOUBLE_STAR___/g, '.*');
    // * -> [^/]* (åŒ¹é…é™¤è·¯å¾„åˆ†éš”ç¬¦å¤–çš„ä»»æ„å­—ç¬¦)
    regex = regex.replace(/___SINGLE_STAR___/g, '[^/\\\\]*');
    // ? -> . (åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦)
    regex = regex.replace(/___QUESTION___/g, '.');
    
    try {
        return new RegExp(`^${regex}$`, 'i'); // å¿½ç•¥å¤§å°å†™
    } catch (e) {
        console.error("Glob regex conversion failed:", e);
        return /^__INVALID_GLOB__$/;
    }
};

// è·¯å¾„æ ‡å‡†åŒ– (ç»Ÿä¸€ä½¿ç”¨ /)
const normalizePath = (p) => p.split(path.sep).join('/');

// é€’å½’æ–‡ä»¶éå†å™¨
async function* walkDir(dir, maxDepth = 20, currentDepth = 0) {
    if (currentDepth > maxDepth) return;
    try {
        const dirents = await fs.promises.readdir(dir, { withFileTypes: true });
        for (const dirent of dirents) {
            const res = path.resolve(dir, dirent.name);
            if (dirent.isDirectory()) {
                if (['node_modules', '.git', '.idea', '.vscode', 'dist', 'build', '__pycache__'].includes(dirent.name)) continue;
                yield* walkDir(res, maxDepth, currentDepth + 1);
            } else {
                yield res;
            }
        }
    } catch (e) {
        // å¿½ç•¥è®¿é—®æƒé™é”™è¯¯ï¼Œé˜²æ­¢éå†ä¸­æ–­
    }
}

// Simple Content-Type to Extension mapper
const getExtensionFromContentType = (contentType) => {
    if (!contentType) return null;
    const type = contentType.split(';')[0].trim().toLowerCase();
    const map = {
        'application/pdf': '.pdf',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': '.docx',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': '.xlsx',
        'text/csv': '.csv',
        'text/plain': '.txt',
        'text/markdown': '.md',
        'text/html': '.html',
        'application/json': '.json',
        'image/png': '.png',
        'image/jpeg': '.jpg',
        'image/webp': '.webp'
    };
    return map[type] || null;
};

// Python Finder Logic
const findAllPythonPaths = () => {
    return new Promise((resolve) => {
        const allPaths = [];
        const cmd = isWin ? 'where python' : 'which -a python3';

        exec(cmd, (error, stdout, stderr) => {
            if (!error) {
                const lines = stdout.split(/\r?\n/).filter(p => p.trim() !== '');
                allPaths.push(...lines);
            }

            const potentialCondaBases = allPaths.map(p => {
                return isWin ? path.dirname(p) : path.dirname(path.dirname(p));
            });

            potentialCondaBases.forEach(baseDir => {
                const envsDir = path.join(baseDir, 'envs');
                if (fs.existsSync(envsDir)) {
                    try {
                        const subDirs = fs.readdirSync(envsDir);
                        subDirs.forEach(subDir => {
                            let venvPython;
                            if (isWin) {
                                venvPython = path.join(envsDir, subDir, 'python.exe');
                            } else {
                                venvPython = path.join(envsDir, subDir, 'bin', 'python');
                                if (!fs.existsSync(venvPython)) {
                                    venvPython = path.join(envsDir, subDir, 'bin', 'python3');
                                }
                            }
                            if (fs.existsSync(venvPython)) allPaths.push(venvPython);
                        });
                    } catch (e) { }
                }
            });
            resolve([...new Set(allPaths)]);
        });
    });
};

const runPythonScript = (code, interpreter) => {
    return new Promise(async (resolve, reject) => {
        let pythonPath = interpreter;
        if (!pythonPath) {
            const paths = await findAllPythonPaths();
            pythonPath = paths.length > 0 ? paths[0] : (isWin ? 'python' : 'python3');
        }

        const tempDir = os.tmpdir();
        const tempFile = path.join(tempDir, `anywhere_script_${Date.now()}.py`);

        try {
            fs.writeFileSync(tempFile, code, 'utf-8');
        } catch (e) {
            return resolve(`Failed to write temp file: ${e.message}`);
        }

        const env = { ...process.env, PYTHONIOENCODING: 'utf-8' };
        
        const child = spawn(pythonPath, [tempFile], { env });

        let output = "";
        let errorOutput = "";

        child.stdout.on('data', (data) => { output += data.toString(); });
        child.stderr.on('data', (data) => { errorOutput += data.toString(); });

        child.on('close', (code) => {
            fs.unlink(tempFile, () => { }); // Cleanup
            if (code === 0) {
                resolve(output || "Execution completed with no output.");
            } else {
                resolve(`Error (Exit Code ${code}):\n${errorOutput}\n${output}`);
            }
        });

        child.on('error', (err) => {
            fs.unlink(tempFile, () => { });
            resolve(`Execution failed: ${err.message}`);
        });
    });
};

// å®‰å…¨æ£€æŸ¥è¾…åŠ©å‡½æ•°
const isPathSafe = (targetPath) => {
    // åŸºç¡€é»‘åå•ï¼šSSHå¯†é’¥ã€AWSå‡­è¯ã€ç¯å¢ƒå˜é‡æ–‡ä»¶ã€Gité…ç½®ã€ç³»ç»ŸShadowæ–‡ä»¶
    const forbiddenPatterns = [
        /[\\/]\.ssh[\\/]/i,
        /[\\/]\.aws[\\/]/i,
        /[\\/]\.env/i,
        /[\\/]\.gitconfig/i,
        /id_rsa/i,
        /authorized_keys/i,
        /\/etc\/shadow/i,
        /\/etc\/passwd/i,
        /C:\\Windows\\System32\\config/i // Windows SAM hive
    ];
    
    return !forbiddenPatterns.some(regex => regex.test(targetPath));
};

async function runSubAgent(args, globalContext, signal) {
    const { task, context: userContext, tools: allowedToolNames, planning_level, custom_steps } = args;
    const { apiKey, baseUrl, model, tools: allToolDefinitions, mcpSystemPrompt, onUpdate } = globalContext;

    // --- 1. å·¥å…·æƒé™æ§åˆ¶ (æœ€å°æƒé™åŸåˆ™) ---
    // é»˜è®¤æ²¡æœ‰ä»»ä½•å·¥å…·æƒé™
    let availableTools = [];

    // åªæœ‰å½“ allowedToolNames è¢«æ˜ç¡®æä¾›ä¸”ä¸ºéç©ºæ•°ç»„æ—¶ï¼Œæ‰è¿›è¡Œç­›é€‰å¹¶æˆäºˆæƒé™
    if (allowedToolNames && Array.isArray(allowedToolNames) && allowedToolNames.length > 0) {
        const allowedSet = new Set(allowedToolNames);
        availableTools = (allToolDefinitions || []).filter(t => 
            allowedSet.has(t.function.name) && t.function.name !== 'sub_agent' // æ’é™¤è‡ªèº«ï¼Œé˜²æ­¢é€’å½’
        );
    }

    // --- 2. æ­¥éª¤æ§åˆ¶ ---
    let MAX_STEPS = 20; // Default medium
    if (planning_level === 'fast') MAX_STEPS = 10;
    else if (planning_level === 'high') MAX_STEPS = 30;
    else if (planning_level === 'custom' && custom_steps) MAX_STEPS = Math.min(100, Math.max(10, custom_steps));

    // --- 3. æç¤ºè¯æ„å»º ---

    // System Prompt: èº«ä»½ã€è§„åˆ™ã€ç¯å¢ƒ
    const systemInstruction = `You are a specialized Sub-Agent Worker.
Your Role: Autonomous task executor.
Strategy: Plan, execute tools, observe results, and iterate until the task is done.
Output: When finished, output the final answer directly as text. Do NOT ask the user for clarification unless all tools fail.
${mcpSystemPrompt ? '\n' + mcpSystemPrompt : ''}`;

    // User Prompt: å…·ä½“ä»»åŠ¡ã€ä¸Šä¸‹æ–‡ã€é™åˆ¶
    const userInstruction = `## Current Assignment
**Task**: ${task}

**Context & Background**:
${userContext || 'No additional context provided.'}

**Execution Constraints**:
- Maximum Steps: ${MAX_STEPS}
- Please start by analyzing the task and available tools.`;

    const messages = [
        { role: 'system', content: systemInstruction },
        { role: 'user', content: userInstruction }
    ];

    let step = 0;
    
    // ç”¨äºè®°å½•å®Œæ•´è¿‡ç¨‹çš„æ—¥å¿—
    const executionLog = [];
    const log = (msg) => {
        executionLog.push(msg);
        // å®æ—¶å›è°ƒç»™å‰ç«¯
        if (onUpdate && typeof onUpdate === 'function') {
            onUpdate(executionLog.join('\n'));
        }
    };

    log(`[Sub-Agent] Started. Max steps: ${MAX_STEPS}. Tools: ${availableTools.map(t=>t.function.name).join(', ') || 'None'}`);

    // åŠ¨æ€å¯¼å…¥
    const { invokeMcpTool } = require('./mcp.js'); 

    while (step < MAX_STEPS) {
        if (signal && signal.aborted) throw new Error("Sub-Agent execution aborted by user.");
        step++;
        
        log(`\n--- Step ${step}/${MAX_STEPS} ---`);

        try {
            // 3.1 LLM æ€è€ƒ
            const response = await fetch(`${baseUrl}/chat/completions`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${Array.isArray(apiKey) ? apiKey[0] : apiKey.split(',')[0].trim()}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    tools: availableTools.length > 0 ? availableTools : undefined,
                    tool_choice: availableTools.length > 0 ? "auto" : undefined,
                    stream: false
                }),
                signal: signal
            });

            if (!response.ok) {
                const err = `API Call failed: ${response.status}`;
                log(`[Error] ${err}`);
                return `[Sub-Agent Error] ${err}`;
            }

            const data = await response.json();
            const message = data.choices[0].message;
            messages.push(message);

            // 3.2 å†³ç­–
            if (message.content) {
                log(`[Thought] ${message.content}`);
            }

            if (!message.tool_calls || message.tool_calls.length === 0) {
                log(`[Result] Task Completed.`);
                // è¿”å›æœ€ç»ˆç»“æœ
                return message.content || "[Sub-Agent finished without content]";
            }

            // 3.3 æ‰§è¡Œå·¥å…·
            for (const toolCall of message.tool_calls) {
                if (signal && signal.aborted) throw new Error("Sub-Agent execution aborted.");

                const toolName = toolCall.function.name;
                let toolArgsObj = {};
                let toolResult = "";
                
                try {
                    toolArgsObj = JSON.parse(toolCall.function.arguments);
                    log(`[Action] Calling ${toolName}...`);
                    
                    // æ‰§è¡Œ
                    const result = await invokeMcpTool(toolName, toolArgsObj, signal, null);
                    
                    if (typeof result === 'string') toolResult = result;
                    else if (Array.isArray(result)) toolResult = result.map(i => i.text || JSON.stringify(i)).join('\n');
                    else toolResult = JSON.stringify(result);

                    log(`[Observation] Tool output length: ${toolResult.length} chars.`);

                } catch (e) {
                    if (e.name === 'AbortError') throw e;
                    toolResult = `Error: ${e.message}`;
                    log(`[Error] Tool execution failed: ${e.message}`);
                }

                messages.push({
                    role: "tool",
                    tool_call_id: toolCall.id,
                    name: toolName,
                    content: toolResult
                });
            }
        } catch (e) {
            if (e.name === 'AbortError') throw e;
            log(`[Critical Error] ${e.message}`);
            return `[Sub-Agent Error] ${e.message}`;
        }
    }

    log(`[Stop] Reached maximum step limit.`);
    return `[Sub-Agent] Reached max steps (${MAX_STEPS}). Final state returned.`;
}

// --- Execution Handlers ---
const handlers = {
    // Python
    list_python_interpreters: async () => {
        const paths = await findAllPythonPaths();
        return JSON.stringify(paths, null, 2);
    },
    run_python_code: async ({ code, interpreter }) => {
        return await runPythonScript(code, interpreter);
    },
    run_python_file: async ({ file_path, working_directory, interpreter, args = [] }) => {
        return new Promise(async (resolve, reject) => {
            const cleanPath = file_path.replace(/^["']|["']$/g, '');
            if (!fs.existsSync(cleanPath)) {
                return resolve(`Error: Python file not found at ${cleanPath}`);
            }

            let pythonPath = interpreter;
            if (!pythonPath) {
                const paths = await findAllPythonPaths();
                pythonPath = paths.length > 0 ? paths[0] : (isWin ? 'python' : 'python3');
            }

            const cwd = working_directory ? working_directory.replace(/^["']|["']$/g, '') : path.dirname(cleanPath);
            if (!fs.existsSync(cwd)) {
                 return resolve(`Error: Working directory not found at ${cwd}`);
            }

            const scriptArgs = Array.isArray(args) ? args : [args];
            const spawnArgs = [cleanPath, ...scriptArgs];
            const env = { ...process.env, PYTHONIOENCODING: 'utf-8' };

            const child = spawn(pythonPath, spawnArgs, { cwd, env });

            let output = "";
            let errorOutput = "";

            child.stdout.on('data', (data) => { output += data.toString(); });
            child.stderr.on('data', (data) => { errorOutput += data.toString(); });

            child.on('close', (code) => {
                const header = `[Executed: ${path.basename(cleanPath)}]\n[CWD: ${cwd}]\n-------------------\n`;
                if (code === 0) {
                    resolve(header + (output || "Execution completed with no output."));
                } else {
                    resolve(`${header}Error (Exit Code ${code}):\n${errorOutput}\n${output}`);
                }
            });

            child.on('error', (err) => {
                resolve(`Execution failed to start: ${err.message}`);
            });
        });
    },

    // --- File Operations Handlers ---

    // 1. Glob Files
    glob_files: async ({ pattern, path: searchPath }) => {
        try {
            const rootDir = resolvePath(searchPath);
            if (!fs.existsSync(rootDir)) return `Error: Directory not found: ${rootDir}`;
            if (!isPathSafe(rootDir)) return `[Security Block] Access restricted.`;

            const results = [];
            const regex = globToRegex(pattern);
            if (!regex) return "Error: Invalid glob pattern.";

            const MAX_RESULTS = 200; 
            const normalizedRoot = normalizePath(rootDir);

            for await (const filePath of walkDir(rootDir)) {
                const normalizedFilePath = normalizePath(filePath);
                
                // è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼šä¾‹å¦‚ "src/main.ts"
                let relativePath = normalizedFilePath.replace(normalizedRoot, '');
                if (relativePath.startsWith('/')) relativePath = relativePath.slice(1);

                // åŒ¹é…ç›¸å¯¹è·¯å¾„ æˆ– æ–‡ä»¶å
                if (regex.test(relativePath) || regex.test(path.basename(filePath))) {
                    results.push(filePath);
                }
                if (results.length >= MAX_RESULTS) break;
            }

            if (results.length === 0) return "No files matched the pattern.";
            return results.join('\n') + (results.length >= MAX_RESULTS ? `\n... (Limit reached: ${MAX_RESULTS})` : '');
        } catch (e) {
            return `Glob error: ${e.message}`;
        }
    },

    // 2. Grep Search
    grep_search: async ({ pattern, path: searchPath, glob, output_mode = 'content', multiline = false }) => {
        try {
            const rootDir = resolvePath(searchPath);
            if (!fs.existsSync(rootDir)) return `Error: Directory not found: ${rootDir}`;
            
            const regexFlags = multiline ? 'gmi' : 'gi';
            let searchRegex;
            try {
                searchRegex = new RegExp(pattern, regexFlags);
            } catch (e) { return `Invalid Regex: ${e.message}`; }

            const globRegex = glob ? globToRegex(glob) : null;
            const normalizedRoot = normalizePath(rootDir);
            
            const results = [];
            let matchCount = 0;
            const MAX_SCANNED = 2000; 
            let scanned = 0;

            for await (const filePath of walkDir(rootDir)) {
                if (scanned++ > MAX_SCANNED) break;

                // Glob è¿‡æ»¤
                if (globRegex) {
                    const normalizedFilePath = normalizePath(filePath);
                    let relativePath = normalizedFilePath.replace(normalizedRoot, '');
                    if (relativePath.startsWith('/')) relativePath = relativePath.slice(1);
                    
                    if (!globRegex.test(relativePath) && !globRegex.test(path.basename(filePath))) continue;
                }

                // è·³è¿‡äºŒè¿›åˆ¶æ–‡ä»¶
                const ext = path.extname(filePath).toLowerCase();
                if (['.png', '.jpg', '.jpeg', '.gif', '.pdf', '.exe', '.bin', '.zip', '.node', '.dll', '.db'].includes(ext)) continue;

                try {
                    const stats = await fs.promises.stat(filePath);
                    if (stats.size > 1024 * 1024) continue; 

                    const content = await fs.promises.readFile(filePath, 'utf-8');
                    
                    if (output_mode === 'files_with_matches') {
                        if (searchRegex.test(content)) {
                            results.push(filePath);
                            searchRegex.lastIndex = 0;
                        }
                    } else {
                        const matches = [...content.matchAll(searchRegex)];
                        if (matches.length > 0) {
                            matchCount += matches.length;
                            if (output_mode === 'count') continue;

                            const lines = content.split(/\r?\n/);
                            matches.forEach(m => {
                                const offset = m.index;
                                const lineNum = content.substring(0, offset).split(/\r?\n/).length;
                                const lineContent = lines[lineNum - 1].trim();
                                results.push(`${filePath}:${lineNum}: ${lineContent.substring(0, 100)}`);
                            });
                        }
                    }
                } catch (readErr) { /* ignore */ }
            }

            if (output_mode === 'count') return `Total matches: ${matchCount}`;
            if (results.length === 0) return "No matches found.";
            return results.join('\n');
        } catch (e) {
            return `Grep error: ${e.message}`;
        }
    },

    // 3. Read File
    read_file: async ({ file_path, offset = 0, length = MAX_READ }) => {
        try {
            const MAX_SINGLE_READ = MAX_READ;
            const readLength = Math.min(length, MAX_SINGLE_READ);
            let fileForHandler;

            if (file_path.startsWith('http://') || file_path.startsWith('https://')) {
                // å¤„ç† URL
                try {
                    const response = await fetch(file_path);
                    if (!response.ok) {
                        return `Error fetching URL: ${response.status} ${response.statusText}`;
                    }

                    const arrayBuffer = await response.arrayBuffer();
                    const buffer = Buffer.from(arrayBuffer);
                    const base64String = buffer.toString('base64');
                    const contentType = response.headers.get('content-type');

                    let filename = path.basename(new URL(file_path).pathname);
                    if (!filename || !filename.includes('.')) {
                        const ext = getExtensionFromContentType(contentType) || '.txt';
                        filename = `downloaded_file${ext}`;
                    }

                    fileForHandler = {
                        name: filename,
                        size: buffer.length,
                        type: contentType || 'application/octet-stream',
                        url: `data:${contentType || 'application/octet-stream'};base64,${base64String}`
                    };

                } catch (fetchErr) {
                    return `Network error: ${fetchErr.message}`;
                }
            } else {
                // å¤„ç†æœ¬åœ°æ–‡ä»¶
                const safePath = resolvePath(file_path);
                if (!isPathSafe(safePath)) {
                    return `[Security Block] Access to sensitive system file '${path.basename(safePath)}' is restricted.`;
                }
                
                if (!fs.existsSync(safePath)) return `Error: File not found at ${safePath}`;

                const stats = await fs.promises.stat(safePath);
                // ä»…é’ˆå¯¹éæ–‡æœ¬çš„å¤æ‚è§£ææ–‡ä»¶ï¼ˆå¦‚ PDFï¼‰é™åˆ¶åŸå§‹å¤§å°ï¼ˆ50MBï¼‰ï¼Œæ™®é€šæ–‡æœ¬è¯»å–ç”±ä¸‹æ–¹çš„å­—ç¬¦æˆªæ–­æ§åˆ¶
                if (stats.size > 200 * 1024 * 1024) {
                    return `Error: File is too large for processing (>50MB).`;
                }

                const fileObj = await handleFilePath(safePath);
                if (!fileObj) return `Error: Unable to access or read file at ${safePath}`;

                const arrayBuffer = await fileObj.arrayBuffer();
                const base64String = Buffer.from(arrayBuffer).toString('base64');
                const dataUrl = `data:${fileObj.type || 'application/octet-stream'};base64,${base64String}`;
                
                fileForHandler = {
                    name: fileObj.name,
                    size: fileObj.size,
                    type: fileObj.type,
                    url: dataUrl 
                };
            }

            const result = await parseFileObject(fileForHandler);
            if (!result) return "Error: Unsupported file type or parsing failed.";

            let fullText = "";
            if (result.type === 'text' && result.text) {
                fullText = result.text;
            } else {
                const typeInfo = result.type === 'image_url' ? 'Image' : 'Binary/PDF';
                return `[System] File '${fileForHandler.name}' detected as ${typeInfo}. \nContent extraction is currently NOT supported via this tool for binary formats in this context.`;
            }

            // --- åˆ†é¡µè¯»å–é€»è¾‘ ---
            const totalChars = fullText.length;
            const startPos = Math.max(0, offset);
            const contentChunk = fullText.substring(startPos, startPos + readLength);
            const remainingChars = totalChars - (startPos + contentChunk.length);

            let output = contentChunk;

            if (remainingChars > 0) {
                const nextOffset = startPos + contentChunk.length;
                output += `\n\n--- [SYSTEM NOTE: CONTENT TRUNCATED] ---\n`;
                output += `Total characters in file: ${totalChars}\n`;
                output += `Current chunk: ${startPos} to ${nextOffset}\n`;
                output += `Remaining unread characters: ${remainingChars}\n`;
                output += `To read more, call read_file with offset: ${nextOffset}\n`;
                output += `---------------------------------------`;
            } else if (startPos > 0) {
                output += `\n\n--- [SYSTEM NOTE: END OF FILE REACHED] ---`;
            }

            return output;

        } catch (e) {
            return `Error reading file: ${e.message}`;
        }
    },

    // 4. Edit File
    edit_file: async ({ file_path, old_string, new_string, replace_all = false }) => {
        try {
            const safePath = resolvePath(file_path);
            if (!isPathSafe(safePath)) return `[Security Block] Access denied to ${safePath}.`;
            if (!fs.existsSync(safePath)) return `Error: File not found: ${safePath}`;

            let content = await fs.promises.readFile(safePath, 'utf-8');

            // æ£€æŸ¥ old_string æ˜¯å¦å­˜åœ¨
            if (!content.includes(old_string)) {
                return `Error: 'old_string' not found in file. Please ensure you read the file first and use the exact string.`;
            }

            // æ£€æŸ¥å”¯ä¸€æ€§
            if (!replace_all) {
                // è®¡ç®—å‡ºç°æ¬¡æ•°
                const count = content.split(old_string).length - 1;
                if (count > 1) {
                    return `Error: 'old_string' occurs ${count} times. Please set 'replace_all' to true if you intend to replace all, or provide a more unique context string.`;
                }
            }

            if (replace_all) {
                content = content.split(old_string).join(new_string);
            } else {
                content = content.replace(old_string, new_string);
            }

            await fs.promises.writeFile(safePath, content, 'utf-8');
            return `Successfully edited ${path.basename(safePath)}.`;

        } catch (e) {
            return `Edit failed: ${e.message}`;
        }
    },

    // 5. Write File
    write_file: async ({ file_path, content }) => {
        try {
            const safePath = resolvePath(file_path);
            if (!isPathSafe(safePath)) return `[Security Block] Access denied to ${safePath}.`;

            const dir = path.dirname(safePath);
            if (!fs.existsSync(dir)) {
                await fs.promises.mkdir(dir, { recursive: true });
            }

            await fs.promises.writeFile(safePath, content, 'utf-8');
            return `Successfully wrote to ${safePath}`;
        } catch (e) {
            return `Write failed: ${e.message}`;
        }
    },

    // Bash / PowerShell
    execute_bash_command: async ({ command, timeout = 15000 }) => {
        return new Promise((resolve) => {
            const trimmedCmd = command.trim();

            // [æ–°å¢] é«˜å±å‘½ä»¤ç®€å•æ‹¦æˆª
            const dangerousPatterns = [
                /^rm\s+(-rf|-r|-f)\s+\/$/i, // rm -rf /
                />\s*\/dev\/sd/i,     // å†™å…¥è®¾å¤‡
                /mkfs/i, 
                /dd\s+/i,
                /wget\s+/i,           // é˜²æ­¢ä¸‹è½½æœ¨é©¬
                /curl\s+.*\|\s*sh/i,  // ç®¡é“æ‰§è¡Œç½‘ç»œè„šæœ¬
                /chmod\s+777/i,
                /cat\s+.*id_rsa/i     // è¯»å–ç§é’¥
            ];
            
            if (dangerousPatterns.some(p => p.test(trimmedCmd))) {
                return resolve(`[Security Block] The command contains potentially destructive operations and has been blocked.`);
            }

            if (trimmedCmd.startsWith('cd ')) {
                let targetDir = trimmedCmd.substring(3).trim();
                targetDir = targetDir.replace(/^["']|["']$/g, '');
                
                try {
                    const newPath = path.resolve(bashCwd, targetDir);
                    if (fs.existsSync(newPath) && fs.statSync(newPath).isDirectory()) {
                        bashCwd = newPath;
                        return resolve(`Directory changed to: ${bashCwd}`);
                    } else {
                        return resolve(`Error: Directory not found: ${newPath}`);
                    }
                } catch (e) {
                    return resolve(`Error changing directory: ${e.message}`);
                }
            }

            // ç¡®ä¿ timeout æ˜¯æœ‰æ•ˆçš„æ­£æ•´æ•°ï¼Œå¦‚æœæœªæä¾›æˆ–æ— æ•ˆåˆ™å›é€€åˆ° 15000
            const validTimeout = (typeof timeout === 'number' && timeout > 0) ? timeout : 15000;

            let shellOptions = {
                cwd: bashCwd,
                encoding: 'utf-8',
                maxBuffer: 1024 * 1024 * 10, // ç¨å¾®è°ƒå¤§ä¸€ç‚¹ buffer é˜²æ­¢å¤§é‡è¾“å‡ºæˆªæ–­
                timeout: validTimeout 
            };

            let finalCommand = command;
            let shellToUse;

            if (isWin) {
                shellToUse = 'powershell.exe';
                finalCommand = `[Console]::OutputEncoding = [System.Text.Encoding]::UTF8; ${command}`;
                shellOptions.shell = shellToUse;
            } else {
                shellToUse = '/bin/bash';
                shellOptions.shell = shellToUse;
            }

            exec(finalCommand, shellOptions, (error, stdout, stderr) => {
                let result = "";
                
                if (stdout) result += stdout;
                if (stderr) result += `\n[Stderr]: ${stderr}`;
                
                if (error) {
                    if (error.signal === 'SIGTERM') {
                        result += `\n[System Note]: Command timed out after ${validTimeout / 1000}s and was terminated. This is expected for long-running processes. Output captured so far is shown above.`;
                    } else {
                        result += `\n[Error Code]: ${error.code}`;
                        if (error.message && !stderr) result += `\n[Message]: ${error.message}`;
                    }
                }
                
                if (!result.trim()) result = "Command executed successfully (no output).";
                resolve(`[CWD: ${bashCwd}]\n${result}`);
            });
        });
    },

    // Web Search Handler
    web_search: async ({ query, count = 5, language = 'zh-CN' }) => {
        try {
            const limit = Math.min(Math.max(parseInt(count) || 5, 1), 10);
            const url = "https://html.duckduckgo.com/html/";
            
            let ddgRegion = 'cn-zh'; // é»˜è®¤: ä¸­å›½-ä¸­æ–‡
            let acceptLang = 'zh-CN,zh;q=0.9,en;q=0.8'; // é»˜è®¤ Header
            
            const langInput = (language || '').toLowerCase();

            if (langInput.includes('en') || langInput.includes('us')) {
                ddgRegion = 'us-en';
                acceptLang = 'en-US,en;q=0.9';
            } else if (langInput.includes('jp') || langInput.includes('ja')) {
                ddgRegion = 'jp-jp';
                acceptLang = 'ja-JP,ja;q=0.9,en;q=0.8';
            } else if (langInput.includes('ru')) {
                ddgRegion = 'ru-ru';
                acceptLang = 'ru-RU,ru;q=0.9,en;q=0.8';
            } else if (langInput === 'all' || langInput === 'world') {
                ddgRegion = 'wt-wt'; // å…¨çƒ
                acceptLang = 'en-US,en;q=0.9';
            }

            const headers = {
                "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
                "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8",
                "Accept-Language": acceptLang, // åŠ¨æ€è¯­è¨€å¤´
                "Content-Type": "application/x-www-form-urlencoded",
                "Origin": "https://html.duckduckgo.com",
                "Referer": "https://html.duckduckgo.com/"
            };

            const body = new URLSearchParams();
            body.append('q', query);
            body.append('b', '');
            body.append('kl', ddgRegion); // åŠ¨æ€åœ°åŒºå‚æ•°

            const response = await fetch(url, { 
                method: 'POST',
                headers: headers,
                body: body
            });

            if (!response.ok) throw new Error(`HTTP Error ${response.status}: ${response.statusText}`);
            const html = await response.text();

            const results = [];
            
            const titleLinkRegex = /<a[^>]*class="result__a"[^>]*href="([^"]+)"[^>]*>([\s\S]*?)<\/a>/g;
            const snippetRegex = /<a[^>]*class="result__snippet"[^>]*>([\s\S]*?)<\/a>/g;

            const titles = [...html.matchAll(titleLinkRegex)];
            const snippets = [...html.matchAll(snippetRegex)];

            const decodeHtml = (str) => {
                if (!str) return "";
                return str
                    .replace(/&amp;/g, '&')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'")
                    .replace(/&lt;/g, "<")
                    .replace(/&gt;/g, ">")
                    .replace(/&nbsp;/g, " ")
                    .replace(/<b>/g, "")
                    .replace(/<\/b>/g, "")
                    .replace(/\s+/g, " ")
                    .trim();
            };

            for (let i = 0; i < titles.length && i < limit; i++) {
                let link = titles[i][1];
                const titleRaw = titles[i][2];
                const snippetRaw = snippets[i] ? snippets[i][1] : "";

                try {
                    if (link.includes('uddg=')) {
                        const urlObj = new URL(link, "https://html.duckduckgo.com");
                        const uddg = urlObj.searchParams.get("uddg");
                        if (uddg) link = decodeURIComponent(uddg);
                    }
                } catch(e) {}

                results.push({
                    title: decodeHtml(titleRaw),
                    link: link,
                    snippet: decodeHtml(snippetRaw)
                });
            }
            
            if (results.length === 0) {
                if (ddgRegion === 'cn-zh') {
                     return JSON.stringify({ message: "No results found in Chinese region. Try setting language='en' or 'all'.", query: query });
                }
                return JSON.stringify({ message: "No results found.", query: query });
            }
            
            return JSON.stringify(results, null, 2);

        } catch (e) {
            return `Search failed: ${e.message}`;
        }
    },
    // Web Fetch Handler
    web_fetch: async ({ url, offset = 0, length = MAX_READ }) => {
        try {
            if (!url || !url.startsWith('http')) {
                return "Error: Invalid URL. Please provide a full URL starting with http:// or https://";
            }

            const MAX_SINGLE_READ = MAX_READ;
            const readLength = Math.min(length, MAX_SINGLE_READ);

            // 1. æ¨¡æ‹Ÿå¸¸ç”¨æµè§ˆå™¨ Headerï¼Œé˜²æ­¢è¢«ç®€å•åçˆ¬æ‹¦æˆª
            const headers = {
                "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",
                "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8",
                "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
                "Referer": "https://www.google.com/"
            };

            const response = await fetch(url, { headers, redirect: 'follow' });
            
            if (response.status === 403 || response.status === 521) {
                return `Failed to fetch page (Anti-bot protection ${response.status}). The site requires a real browser environment.`;
            }

            if (!response.ok) {
                return `Failed to fetch page. Status: ${response.status} ${response.statusText}`;
            }

            const contentType = response.headers.get('content-type') || '';
            const rawText = await response.text();

            let fullText = "";
            
            // å¦‚æœæ˜¯ JSON æ•°æ®ï¼Œç›´æ¥æ ¼å¼åŒ–è¿”å›
            if (contentType.includes('application/json')) {
                try { 
                    fullText = JSON.stringify(JSON.parse(rawText), null, 2); 
                } catch(e) { 
                    fullText = rawText; 
                }
            } else {
                // æå–å…ƒæ•°æ®
                const metadata = extractMetadata(rawText);
                
                // ä¼ å…¥ URL ä»¥å¤„ç†ç›¸å¯¹è·¯å¾„ï¼Œå¹¶ä½¿ç”¨æ–°çš„é€šç”¨é™å™ªé€»è¾‘
                const markdownBody = convertHtmlToMarkdown(rawText, url);

                if (!markdownBody || markdownBody.length < 50) {
                    // å†…å®¹è¿‡çŸ­ï¼Œå¯èƒ½æ˜¯ SPA ç½‘ç«™ï¼ˆå¦‚ Bilibiliï¼‰ï¼Œè¿”å›å…ƒæ•°æ®å‘ŠçŸ¥ AI
                    return `Fetched URL: ${url}\n\nTitle: ${metadata.title}\n\n[System Info]: The extracted content is very short. This website might be a Single Page Application (SPA) relying on JavaScript, which this tool cannot render. \nDescription: ${metadata.description}`;
                }

                fullText = `URL: ${url}\n\n`;
                if (metadata.title) fullText += `# ${metadata.title}\n\n`;
                if (metadata.description) fullText += `> **Description:** ${metadata.description}\n\n`;
                fullText += `---\n\n${markdownBody}`;
            }

            // --- åˆ†é¡µè¯»å–é€»è¾‘ ---
            const totalChars = fullText.length;
            const startPos = Math.max(0, offset);
            const contentChunk = fullText.substring(startPos, startPos + readLength);
            const remainingChars = totalChars - (startPos + contentChunk.length);

            let result = contentChunk;

            if (remainingChars > 0) {
                const nextOffset = startPos + contentChunk.length;
                result += `\n\n--- [SYSTEM NOTE: CONTENT TRUNCATED] ---\n`;
                result += `Total characters: ${totalChars}. Current chunk: ${startPos}-${nextOffset}.\n`;
                result += `Remaining: ${remainingChars}. Call 'web_fetch' with offset=${nextOffset} to read more.\n`;
            } else if (startPos > 0) {
                result += `\n\n--- [SYSTEM NOTE: END OF PAGE REACHED] ---`;
            }

            return result;

        } catch (e) {
            return `Error fetching page: ${e.message}`;
        }
    },

    // Sub Agent Handler
    sub_agent: async (args, globalContext, signal) => {
        if (!globalContext || !globalContext.apiKey) {
            return "Error: Sub-Agent requires global context(should be in a chat session).";
        }
        return await runSubAgent(args, globalContext, signal);
    }
};

// --- Exports ---

function getBuiltinServers() {
    return JSON.parse(JSON.stringify(BUILTIN_SERVERS));
}

function getBuiltinTools(serverId) {
    return BUILTIN_TOOLS[serverId] || [];
}

async function invokeBuiltinTool(toolName, args, signal = null, context = null) {
    if (handlers[toolName]) {
        // å¦‚æœæ˜¯ sub_agentï¼Œå®ƒéœ€è¦ context å’Œ signal
        if (toolName === 'sub_agent') {
            return await handlers[toolName](args, context, signal);
        }
        // ä¸ºäº†å…¼å®¹æ€§ï¼Œæˆ‘ä»¬åªç»™ sub_agent ä¼  context
        return await handlers[toolName](args); 
    }
    throw new Error(`Built-in tool '${toolName}' not found.`);
}

module.exports = {
    getBuiltinServers,
    getBuiltinTools,
    invokeBuiltinTool
};
```
```js
./backend/src/preload.js
const {
  getConfig,
  updateConfig,
  saveSetting,
  updateConfigWithoutFeatures,
  checkConfig,
  getUser,
  copyText,
  sethotkey,
  openWindow,
  openFastInputWindow,
  coderedirect,
  setZoomFactor,
  feature_suffix,
  defaultConfig,
  savePromptWindowSettings,
  saveMcpToolCache,
  getMcpToolCache,
} = require('./data.js');

const {
  handleFilePath,
  sendfileDirect,
  saveFile,
  selectDirectory,
  listJsonFiles,
  readLocalFile,
  renameLocalFile,
  deleteLocalFile,
  writeLocalFile,
  setFileMtime,
  isFileTypeSupported,
  parseFileObject,
} = require('./file.js');

const {
  getRandomItem,
} = require('./input.js');

// å¼•å…¥é‡æ„åçš„ MCP æ¨¡å—
const {
  initializeMcpClient,
  invokeMcpTool,
  closeMcpClient,
  connectAndFetchTools,
  connectAndInvokeTool,
} = require('./mcp.js');

window.api = {
  getConfig,
  updateConfig,
  saveSetting,
  updateConfigWithoutFeatures,
  getUser,
  getRandomItem,
  copyText,
  handleFilePath,
  sendfileDirect,
  saveFile,
  selectDirectory,
  listJsonFiles,
  readLocalFile,
  renameLocalFile,
  deleteLocalFile,
  writeLocalFile,
  setFileMtime,
  sethotkey,
  coderedirect,
  setZoomFactor,
  defaultConfig,
  savePromptWindowSettings,
  desktopCaptureSources: utools.desktopCaptureSources,
  copyImage: utools.copyImage,
  getMcpToolCache,
  initializeMcpClient: async (activeServerConfigs) => {
    try {
      const cache = await getMcpToolCache();
      return await initializeMcpClient(activeServerConfigs, cache, saveMcpToolCache);
    } catch (e) {
      console.error("[Preload] Error loading MCP cache:", e);
      return await initializeMcpClient(activeServerConfigs, {}, saveMcpToolCache);
    }
  },
  testMcpConnection: async (serverConfig) => {
    try {
      // 1. è·å–æ–°å·¥å…·åˆ—è¡¨
      const rawTools = await connectAndFetchTools(serverConfig.id, {
        transport: serverConfig.type,
        command: serverConfig.command,
        args: serverConfig.args,
        url: serverConfig.baseUrl,
        env: serverConfig.env,
        headers: serverConfig.headers,
      });
      
      const sanitizedTools = rawTools.map(tool => ({
        name: tool.name,
        description: tool.description,
        inputSchema: tool.inputSchema || tool.schema || {} 
      }));

      // 2. è¯»å–æ—§ç¼“å­˜å¹¶åˆå¹¶çŠ¶æ€
      const oldCacheMap = await getMcpToolCache();
      const oldTools = oldCacheMap ? (oldCacheMap[serverConfig.id] || []) : [];
      
      const mergedTools = sanitizedTools.map(newTool => {
          const oldTool = oldTools.find(t => t.name === newTool.name);
          return {
              ...newTool,
              // å¦‚æœæ—§ç¼“å­˜å­˜åœ¨ä¸”æ˜ç¡®è®¾ç½®äº† enabledï¼Œåˆ™æ²¿ç”¨ï¼›å¦åˆ™é»˜è®¤ä¸º true
              enabled: oldTool ? (oldTool.enabled ?? true) : true
          };
      });

      const cleanTools = JSON.parse(JSON.stringify(mergedTools));
      
      // 3. ä¿å­˜åˆå¹¶åçš„ç»“æœ
      await saveMcpToolCache(serverConfig.id, cleanTools);
      
      return { success: true, tools: cleanTools };
    } catch (error) {
      console.error("[Preload] MCP Test Connection Error:", error);
      return { success: false, error: String(error.message || error) };
    }
  },
  saveMcpToolCache,
  // æµ‹è¯•å…·ä½“å·¥å…·è°ƒç”¨
  testInvokeMcpTool: async (serverConfig, toolName, args) => {
      try {
          const result = await connectAndInvokeTool(serverConfig.id, {
              transport: serverConfig.type,
              command: serverConfig.command,
              args: serverConfig.args,
              url: serverConfig.baseUrl,
              env: serverConfig.env,
              headers: serverConfig.headers,
              type: serverConfig.type // ç¡®ä¿ type ä¼ é€’ç»™ builtin åˆ¤æ–­
          }, toolName, args);
          return { success: true, result };
      } catch (error) {
          return { success: false, error: String(error.message || error) };
      }
  },
  invokeMcpTool,
  closeMcpClient,
  isFileTypeSupported,
  parseFileObject,
};

const commandHandlers = {
  'Anywhere Settings': async () => {
    // ä½¿ç”¨ await
    const configResult = await getConfig();
    checkConfig(configResult.config);
  },

  'Resume Conversation': async ({ type, payload }) => {
    utools.hideMainWindow();
    // ä½¿ç”¨ await
    const configResult = await getConfig();
    const config = configResult.config;
    checkConfig(config);

    let sessionPayloadString = null;
    let sessionObject = null;
    let filename = null;
    let originalCode = null;

    try {
      if (type === "files" && Array.isArray(payload) && payload.length > 0 && payload[0].path) {
        const filePath = payload[0].path;
        if (filePath.toLowerCase().endsWith('.json')) {
          const fs = require('fs');
          sessionPayloadString = fs.readFileSync(filePath, 'utf-8');
          sessionObject = JSON.parse(sessionPayloadString);
          filename = payload[0].name;
        } else {
          sessionPayloadString = JSON.stringify(payload);
        }
      } else if (type === "over") {
        sessionPayloadString = payload;
        const parsedPayload = JSON.parse(sessionPayloadString);

        if (parsedPayload && parsedPayload.sessionData) {
          sessionObject = JSON.parse(parsedPayload.sessionData);
          filename = parsedPayload.filename || null;
        } else if (parsedPayload && parsedPayload.anywhere_history === true) {
          sessionObject = parsedPayload;
        }
      }
    } catch (e) {
      console.warn("Payload is not a valid session JSON or file is unreadable. It will be opened as plain text/file.", e);
      if (!sessionPayloadString) {
        sessionPayloadString = (typeof payload === 'object') ? JSON.stringify(payload) : payload;
      }
    }

    if (sessionObject && sessionObject.CODE) {
      originalCode = sessionObject.CODE;
    }

    const finalPayload = sessionObject ? JSON.stringify(sessionObject) : (sessionPayloadString || payload);

    const msg = {
      os: utools.isMacOS() ? "macos" : utools.isWindows() ? "win" : "linux",
      code: "Resume Conversation",
      type: "over",
      payload: finalPayload,
      filename: filename,
      originalCode: originalCode
    };
    // ä¼ é€’ config
    await openWindow(config, msg);

    utools.outPlugin();
  },

  // ç›´æ¥æ‰“å¼€å¿«æ·åŠ©æ‰‹
  handleAssistant: async ({ code, type, payload }) => {
    utools.hideMainWindow();
    // ä½¿ç”¨ await
    const configResult = await getConfig();
    const config = configResult.config;
    checkConfig(config);
    const assistantName = code.replace(feature_suffix, "");
    if (config.prompts[assistantName].type === "img") {
      utools.screenCapture((image) => {
        const msg = {
          os: utools.isMacOS() ? "macos" : utools.isWindows() ? "win" : "linux",
          code: assistantName,
          type: "img",
          payload: image,
        };
        // ä¼ é€’ config
        openWindow(config, msg);
      });
    } else {
      const msg = {
        os: utools.isMacOS() ? "macos" : utools.isWindows() ? "win" : "linux",
        code: assistantName,
        type: "over",
        payload: assistantName,
      };
      // ä¼ é€’ config
      await openWindow(config, msg);
    }
    utools.outPlugin();
  },

  // åŒ¹é…è°ƒç”¨
  handlePrompt: async ({ code, type, payload }) => {
    utools.hideMainWindow();
    // ä½¿ç”¨ await
    const configResult = await getConfig();
    const config = configResult.config;
    checkConfig(config);

    const promptConfig = config.prompts[code];
    if (!promptConfig) {
      utools.showNotification(`Error: Prompt "${code}" not found.`);
      utools.outPlugin();
      return;
    }

    // æ­£åˆ™åŒ¹é…æˆåŠŸåï¼Œæ¢å¤ä¸ºover
    if (type === 'regex') {
        type = 'over';
    }

    if (promptConfig.showMode === 'window') {
      const msg = {
        os: utools.isMacOS() ? "macos" : utools.isWindows() ? "win" : "linux",
        code,
        type,
        payload,
      };
      // ä¼ é€’ config
      await openWindow(config, msg);
    } else if (promptConfig.showMode === 'fastinput') {
      let content = null;
      if (type === "over") {
        if (config.skipLineBreak) {
          payload = payload
            .replace(/([a-zA-Z])\s*\n\s*([a-zA-Z])/g, "$1 $2")
            .replace(/\s*\n\s*/g, "");
        }
        content = payload;
      } else if (type === "img") {
        content = [{ type: "image_url", image_url: { url: payload } }];
      } else if (type === "files") {
        content = await sendfileDirect(payload);
      } else {
        utools.showNotification("Unsupported input type");
      }

      if (content) {
        const msg = {
          code,
          content,
        };
        await openFastInputWindow(config, msg);
      }
    }
    utools.outPlugin();
  }
};

// --- Main Plugin Entry ---
utools.onPluginEnter(async (action) => {
  const { code } = action;
  if (commandHandlers[code]) {
    await commandHandlers[code](action);
  } else if (code.endsWith(feature_suffix)) { // æ‰“å¼€ç©ºç™½åŠ©æ‰‹
    await commandHandlers.handleAssistant(action);
  } else {  // æ ¹æ®æç¤ºè¯åŒ¹é…è°ƒç”¨
    await commandHandlers.handlePrompt(action);
  }
});

const { ipcRenderer } = require('electron');
const { windowMap } = require('./data.js');

ipcRenderer.on('window-event', (e, { senderId, event }) => {
  const bw = windowMap.get(senderId);
  if (!bw) {
    console.warn(`[IPC Hub] Window with senderId ${senderId} not found.`);
    return;
  }

  try {
    switch (event) {
      case 'toggle-always-on-top': {
        const currentState = bw.isAlwaysOnTop();
        const newState = !currentState;
        bw.setAlwaysOnTop(newState);
        bw.webContents.send('always-on-top-changed', newState);
        break;
      }
      case 'close-window': {
        bw.close();
        windowMap.delete(senderId);
        break;
      }
      // [æ–°å¢] æœ€å°åŒ–
      case 'minimize-window': {
        bw.minimize();
        break;
      }
      // [æ–°å¢] æœ€å¤§åŒ–/è¿˜åŸ
      case 'maximize-window': {
        if (bw.isMaximized()) {
          bw.unmaximize();
        } else {
          bw.maximize();
        }
        break;
      }
    }
  } catch (err) {
    console.error(`[IPC Hub] Error handling event '${event}' for window ${senderId}:`, err);
  }
});
```
```js
./backend/src/window_preload.js
const { ipcRenderer } = require('electron');

const {
  
    getRandomItem,
} = require('./input.js');

const {
    getConfig,
    updateConfig,
    saveSetting,
    getUser,
    copyText,
    sethotkey,
    setZoomFactor,
    defaultConfig,
    savePromptWindowSettings,
    saveMcpToolCache,
    getMcpToolCache,
    getCachedBackgroundImage,
    cacheBackgroundImage,
} = require('./data.js');

const {
    handleFilePath,
    saveFile,
    writeLocalFile,
    isFileTypeSupported,
    parseFileObject,
    renameLocalFile,
    listJsonFiles,
} = require('./file.js');

const { 
  initializeMcpClient, 
  invokeMcpTool,
  closeMcpClient,
} = require('./mcp.js');

const channel = "window";
let senderId = null; // [æ–°å¢] ç”¨äºå­˜å‚¨å½“å‰çª—å£çš„å”¯ä¸€ID

window.preload = {
    receiveMsg: (callback) => {
        ipcRenderer.on(channel, (event, data) => {
            if (data) {
                // æ•è·å¹¶å­˜å‚¨ senderId
                if (data.senderId) {
                    senderId = data.senderId;
                }
                callback(data);
            }
        });
    }
}

window.addEventListener('DOMContentLoaded', () => {
    document.addEventListener('click', (event) => {
        let target = event.target;
        while (target && target.tagName !== 'A') {
            target = target.parentNode;
        }

        if (target && target.tagName === 'A' && target.href) {
            event.preventDefault();
            utools.shellOpenExternal(target.href);
        }
    });
});

window.api = {
    getConfig,
    updateConfig,
    saveSetting,
    getUser,
    getRandomItem,
    copyText,
    handleFilePath,
    saveFile,
    renameLocalFile,
    listJsonFiles,
    writeLocalFile,
    sethotkey,
    setZoomFactor,
    defaultConfig,
    savePromptWindowSettings,
    desktopCaptureSources: utools.desktopCaptureSources,
    copyImage: utools.copyImage,
    getMcpToolCache,
    initializeMcpClient: async (activeServerConfigs) => {
        try {
            const cache = await getMcpToolCache();            
            return await initializeMcpClient(activeServerConfigs, cache, saveMcpToolCache);
        } catch (e) {
            console.error("[WindowPreload] Error loading MCP cache:", e);
            return await initializeMcpClient(activeServerConfigs, {}, saveMcpToolCache);
        }
    },
    invokeMcpTool: async (toolName, toolArgs, signal, context = null) => {
        return await invokeMcpTool(toolName, toolArgs, signal, context);
    },
    saveMcpToolCache,
    closeMcpClient,
    isFileTypeSupported,
    parseFileObject,

    // å‘çˆ¶è¿›ç¨‹(preload.js)å‘é€åˆ‡æ¢ç½®é¡¶çŠ¶æ€çš„è¯·æ±‚
    toggleAlwaysOnTop: () => {
      if (senderId) {
        utools.sendToParent('window-event', { senderId, event: 'toggle-always-on-top' });
      } else {
        console.error("senderId is not available, cannot toggle always-on-top.");
      }
    },
    windowControl: (action) => {
      if (senderId) {
        // action å¯¹åº” preload.js switch ä¸­çš„ caseï¼Œä¾‹å¦‚ 'minimize-window'
        utools.sendToParent('window-event', { senderId, event: action });
      }
    },
    // ç›‘å¬çˆ¶è¿›ç¨‹å‘å›çš„çŠ¶æ€å˜æ›´æ¶ˆæ¯
    onAlwaysOnTopChanged: (callback) => {
      ipcRenderer.on('always-on-top-changed', (event, newState) => {
        callback(newState);
      });
    },
    // ç›‘å¬é…ç½®æ›´æ–°æ¶ˆæ¯
    onConfigUpdated: (callback) => {
      ipcRenderer.on('config-updated', (event, newConfig) => {
        callback(newConfig);
      });
    },
    getCachedBackgroundImage,
    cacheBackgroundImage: (url) => {
        // å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ UI
        cacheBackgroundImage(url).catch(e => console.error(e));
    },
};
```

ä»¥ä¸‹æ˜¯ä¸»é¡µé¢çš„å‰ç«¯ä»£ç ï¼Œåœ¨./Anywhere_main/ç›®å½•ä¸‹ï¼Œæ˜¯è®¾ç½®é¡µé¢ï¼Œå…¶é¢„åŠ è½½æ–‡ä»¶ä¸ºpreload.js
```json
./Anywhere_main/package.json
{
  "name": "anywhere",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite --force",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@element-plus/icons-vue": "^2.3.1",
    "element-plus": "^2.9.7",
    "vue": "^3.5.13",
    "vue-i18n": "^11.1.3",
    "vuedraggable": "^4.1.0",
    "webdav": "^5.8.0"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^5.2.1",
    "vite": "^7.3.1",
    "vite-plugin-vue-devtools": "^7.7.2"
  }
}

```
```js
./Anywhere_main/vite.config.js
import { fileURLToPath, URL } from 'node:url'

import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import vueDevTools from 'vite-plugin-vue-devtools'

// https://vite.dev/config/
export default defineConfig({
  plugins: [
    vue(),
    vueDevTools(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    },
  },
  base: './'
})

```
```html
./Anywhere_main/index.html
<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Anywhere</title>
</head>

<body>
  <div id="app"></div>
  <style>
    :root {
      /* THEME VARS */
      --bg-primary: #FFFFFF; /*ç¨å¾®è°ƒæ•´èƒŒæ™¯è‰²ï¼Œä½¿å…¶ä¸çº¯ç™½å¡ç‰‡å¯¹æ¯”åº¦æ›´é«˜*/
      --bg-secondary: #FFFFFD;
      --bg-tertiary: #F0F2F5;
      --bg-accent: #1F2937;
      --bg-accent-light: #F0F0F0;
      --text-primary: #1F2937;
      --text-secondary: #4B5563;
      --text-tertiary: #9CA3AF;
      --text-accent: #1F2937;
      --text-on-accent: #FFFFFD;
      
      --border-primary: #DCDFE6;
      --border-secondary: #E4E7ED;
      --border-accent: #909399;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      
      /* ELEMENT PLUS OVERRIDES - LIGHT MODE */
      color-scheme: light;
      --el-color-primary: var(--bg-accent);
      --el-color-primary-light-3: #4B5563;
      --el-color-primary-light-5: #9CA3AF;
      --el-color-primary-light-7: #E5E7EB;
      --el-color-primary-light-9: #F3F4F6;

      /* SWITCH VARS */
      --el-switch-on-color: var(--bg-accent);
      --el-switch-off-color: var(--border-primary);
    }

    .el-button--primary.is-link {
      color: #409EFF; /* Element Plus é»˜è®¤ä¸»è‰²è“ */
    }
    .el-button--primary.is-link:hover,
    .el-button--primary.is-link:focus {
      color: #79bbff; /* æ‚¬æµ®æ—¶å˜æµ… */
    }

    html.dark {
      /* THEME VARS */
      --bg-primary: #181818; /* åŠ æ·±èƒŒæ™¯ï¼Œçªå‡ºå¡ç‰‡ */
      --bg-secondary: #212121;
      --bg-tertiary: #303030;
      --bg-accent: #FFFFFD;
      --bg-accent-light: #424242;
      --text-primary: #E5EAF3;
      --text-secondary: #A3A6AD;
      --text-tertiary: #6C6E72;
      --text-accent: #F9FAFB;
      --text-on-accent: #303030;
      
      --border-primary: #414243; /* æäº®è¾¹æ¡† (åŸ: #424242)ï¼Œåœ¨æ·±è‰²èƒŒæ™¯ä¸‹ç”»å‡ºè½®å»“ */
      --border-secondary: #303030;
      --border-accent: #6C6E72;

      color-scheme: dark;
      --el-color-primary: var(--bg-accent);
      --el-color-primary-light-3: #E5E7EB;
      --el-color-primary-light-5: #F9FAFB;
      --el-color-primary-light-6: #D4D4D4;
      --el-color-primary-light-7: #4B5563;
      --el-color-primary-light-9: #424242;
      --el-color-primary-dark-2: #D1D5DB;

      --el-switch-on-color: var(--bg-accent);
      --el-switch-off-color: var(--border-primary);

      --el-bg-color: #212121;
      --el-bg-color-page: #181818;
      --el-bg-color-overlay: #212121;
      --el-fill-color: #303030;
      --el-fill-color-light: #303030;
      --el-fill-color-lighter: #212121;
      --el-fill-color-lightest: #212121;
      --el-fill-color-dark: #303030;
      --el-fill-color-darker: #181818;
      --el-fill-color-blank: #181818;
      
      --el-border-color: #414243; /* åŒæ­¥ä¿®æ”¹ */
      --el-border-color-light: #414243;
      --el-border-color-lighter: #414243;
      --el-border-color-dark: #6C6E72;
      --el-border-color-darker: #A3A6AD;
      
      --el-text-color-primary: #E5EAF3;
      --el-text-color-regular: #CFD3DC;
      --el-text-color-secondary: #A3A6AD;
      --el-text-color-placeholder: #6C6E72;
      --el-text-color-disabled: #4C4D4F;
      
      --el-box-shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
      --el-table-border-color: var(--border-primary);
      --el-collapse-border-color: var(--border-primary);
    }

    html,
    body,
    #app {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80" width="80" height="80"><g fill="%239C92AC" fill-opacity="0.06"><circle fill-rule="evenodd" cx="40" cy="40" r="40"/><circle fill-rule="evenodd" cx="40" cy="40" r="30"/><circle fill-rule="evenodd" cx="40" cy="40" r="20"/><circle fill-rule="evenodd" cx="40" cy="40" r="10"/></g></svg>');
      opacity: 0.5;
      z-index: -1;
      pointer-events: none;
    }

    html.dark body::before {
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80" width="80" height="80"><g fill="%23E2E2E2" fill-opacity="0.04"><circle fill-rule="evenodd" cx="40" cy="40" r="40"/><circle fill-rule="evenodd" cx="40" cy="40" r="30"/><circle fill-rule="evenodd" cx="40" cy="40" r="20"/><circle fill-rule="evenodd" cx="40" cy="40" r="10"/></g></svg>');
    }

    .el-dialog {
      background-color: var(--bg-secondary) !important;
      border-radius: var(--radius-lg) !important;
      box-shadow: var(--shadow-md) !important;
    }

    .el-dialog__header {
      padding: 10px 12px !important;
      margin-right: 0 !important;
      border-bottom: 1px solid var(--border-primary);
    }

    .el-dialog__title {
      color: var(--text-primary) !important;
      font-weight: 600;
      font-size: 18px;
    }

    .el-dialog__body {
      padding: 0 0 0 0;
      color: var(--text-primary);
    }

    .el-message-box {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-primary);
    }

    .el-message-box__title,
    .el-message-box__message {
      color: var(--text-primary);
    }

    html.dark {
      --el-bg-color: #212121;
      --el-bg-color-page: #303030;
      --el-bg-color-overlay: #212121;
      --el-fill-color: #424242;
      --el-fill-color-light: #424242;
      --el-fill-color-lighter: #2c2e33;
      --el-fill-color-lightest: #2c2e33;
      --el-fill-color-dark: #2c2e33;
      --el-fill-color-darker: #303030;
      --el-fill-color-blank: #303030;
      --el-border-color: #424242;
      --el-border-color-light: #424242;
      --el-border-color-lighter: #424242;
      --el-border-color-dark: #656a76;
      --el-border-color-darker: #a0a5b1;
      --el-text-color-primary: #f9fafb;
      --el-text-color-regular: #e3e3e3;
      --el-text-color-secondary: #a0a5b1;
      --el-text-color-placeholder: #656a76;
      --el-text-color-disabled: #585a63;
      --el-box-shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
      --el-table-border-color: var(--border-primary);
      --el-collapse-border-color: var(--border-primary);
    }

    html.dark .el-button.is-plain,
    html.dark .el-button--default {
      --el-button-bg-color: transparent;
      --el-button-border-color: var(--border-primary);
      --el-button-text-color: var(--text-secondary);
    }

    html.dark .el-button.is-plain:hover,
    html.dark .el-button.is-plain:focus,
    html.dark .el-button--default:hover,
    html.dark .el-button--default:focus {
      --el-button-hover-text-color: var(--text-accent);
      --el-button-hover-bg-color: var(--bg-tertiary);
      --el-button-hover-border-color: var(--border-accent);
    }

    html.dark .el-button--danger.is-plain {
      --el-button-text-color: var(--el-color-danger);
    }

    html.dark .el-button--danger.is-plain:hover,
    html.dark .el-button--danger.is-plain:focus {
      --el-button-hover-text-color: #fff;
      --el-button-hover-bg-color: var(--el-color-danger);
      --el-button-hover-border-color: var(--el-color-danger);
    }

    html.dark .el-input__wrapper,
    html.dark .el-textarea__inner,
    html.dark .el-select__wrapper {
      background-color: var(--bg-tertiary) !important;
      box-shadow: 0 0 0 1px var(--border-primary) inset !important;
      color: var(--text-primary);
    }

    html.dark .el-input__wrapper.is-focus,
    html.dark .el-textarea__inner:focus,
    html.dark .el-select__wrapper.is-focused {
      box-shadow: 0 0 0 1px var(--text-accent) inset !important;
    }

    html.dark .el-input-number {
      --el-input-number-bg-color: var(--bg-tertiary);
    }

    html.dark .el-input-number .el-input__wrapper {
      box-shadow: none !important;
    }

    html.dark .el-input-number__decrease,
    html.dark .el-input-number__increase {
      background-color: var(--bg-primary);
      border-color: var(--border-primary);
      color: var(--text-secondary);
    }

    html.dark .el-input-number__decrease:hover,
    html.dark .el-input-number__increase:hover {
      color: var(--text-accent);
    }

    html.dark .el-input__inner,
    html.dark .el-select-v2__inner{
      color: var(--text-primary) !important;
    }
    
    html.dark .el-radio-button.is-active .el-radio-button__inner {
      color: #000000 !important;
    }

    html.dark .el-select-dropdown {
      background-color: var(--bg-secondary) !important;
      border-color: var(--border-primary) !important;
      box-shadow: var(--shadow-md) !important;
    }

    html.dark .el-select-dropdown__item {
      color: var(--text-secondary);
    }

    html.dark .el-select-dropdown__item.is-hovering,
    html.dark .el-select-dropdown__item:hover {
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
    }

    html.dark .el-select-dropdown__item.is-selected {
      color: var(--text-accent);
      font-weight: 600;
      background-color: var(--bg-accent-light);
    }

    html.dark .el-loading-mask {
      background-color: rgba(23, 24, 28, 0.7);
    }

    html.dark .el-table--border::before,
    html.dark .el-table--border::after,
    html.dark .el-table__inner-wrapper::before,
    html.dark .el-table__inner-wrapper::after,
    html.dark .el-table--group::after,
    html.dark .el-table__border-left-patch {
      background-color: var(--border-primary);
    }

    /* === Global Scrollbar Styles === */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-tertiary);
      border-radius: var(--radius-lg);
      border: 2px solid var(--bg-primary);
      background-clip: content-box;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
      background-clip: content-box;
    }

    html.dark .el-main::-webkit-scrollbar-track,
    html.dark .el-scrollbar__view::-webkit-scrollbar-track,
    html.dark .settings-scrollbar-wrapper::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    html.dark .el-main::-webkit-scrollbar-thumb,
    html.dark .el-scrollbar__view::-webkit-scrollbar-thumb,
    html.dark .settings-scrollbar-wrapper::-webkit-scrollbar-thumb {
      background: var(--text-tertiary);
      border-color: var(--bg-secondary);
    }

    html.dark .el-main::-webkit-scrollbar-thumb:hover,
    html.dark .el-scrollbar__view::-webkit-scrollbar-thumb:hover,
    html.dark .settings-scrollbar-wrapper::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    html.dark .el-button--primary {
      --el-button-text-color: var(--text-on-accent);
      --el-button-bg-color: var(--el-color-primary);
      --el-button-border-color: var(--el-color-primary);
    }
    html.dark .el-button--primary:hover,
    html.dark .el-button--primary:focus {
      --el-button-hover-text-color: var(--text-on-accent);
      --el-button-hover-bg-color: var(--el-color-primary-light-3);
      --el-button-hover-border-color: var(--el-color-primary-light-3);
    }

    .el-switch .el-switch__core .el-switch__inner .is-text {
      color: var(--text-primary) !important;
    }
    .el-switch.is-checked .el-switch__core .el-switch__inner .is-text {
      color: var(--text-on-accent) !important;
    }

    /* FIX: Force switch 'on' state to use theme colors, overriding defaults */
    .el-switch.is-checked .el-switch__core {
      background-color: var(--el-switch-on-color) !important;
      border-color: var(--el-switch-on-color) !important;
    }

    /* RESTORE: Revert danger button to its default behavior */
    .el-button--danger {
      --el-button-text-color: var(--el-color-white);
      --el-button-bg-color: var(--el-color-danger);
      --el-button-border-color: var(--el-color-danger);
    }
    .el-button--danger:hover, .el-button--danger:focus {
      --el-button-hover-text-color: var(--el-color-white);
      --el-button-hover-bg-color: var(--el-color-danger-light-3);
      --el-button-hover-border-color: var(--el-color-danger-light-3);
    }
    html.dark .el-button--danger {
        --el-button-text-color: var(--el-color-white);
        --el-button-bg-color: var(--el-color-danger);
        --el-button-border-color: var(--el-color-danger);
    }
    html.dark .el-button--danger:hover, html.dark .el-button--danger:focus {
        --el-button-hover-text-color: var(--el-color-white);
        --el-button-hover-bg-color: var(--el-color-danger-light-3);
        --el-button-hover-border-color: var(--el-color-danger-light-3);
    }


    .el-pagination.is-background .el-pager li:not(.is-disabled).is-active {
      background-color: var(--bg-accent);
      color: var(--text-on-accent);
    }

    .el-loading-spinner .path {
        stroke: var(--text-accent);
    }

    html.dark .el-button--primary.is-link {
      color: #79bbff; /* ä¸€ä¸ªé€‚åˆæ·±è‰²æ¨¡å¼çš„äº®è“è‰² */
    }
    html.dark .el-button--primary.is-link:hover,
    html.dark .el-button--primary.is-link:focus {
      color: #a0cfff; /* æ‚¬æµ®æ—¶æ›´äº® */
    }
    html.dark .el-button--warning.is-link {
      color: var(--el-color-warning-light-3);
    }
    html.dark .el-button--danger.is-link {
      color: var(--el-color-danger-light-3);
    }
    html.dark .el-switch.is-checked .el-switch__core {
      background-color: #FFFFFD !important;
    }
    html.dark .el-switch.is-checked .el-switch__core .el-switch__action {
      background-color: var(--text-on-accent);
    }

    html.dark .el-checkbox__input.is-checked .el-checkbox__inner {
      background-color: #fff !important;
      border-color: #fff !important;
    }
    html.dark .el-checkbox__input.is-checked .el-checkbox__inner::after {
      border-color: var(--text-on-accent) !important;
    }
  </style>
  <script type="module" src="/src/main.js"></script>
</body>

</html>
```
```vue
./Anywhere_main/src/components/Chats.vue
<script setup>
import { ref, onMounted, computed, watch } from 'vue'
import { useI18n } from 'vue-i18n'
import { createClient } from "webdav/web";
import { Refresh, Delete as DeleteIcon, ChatDotRound, Edit, Upload, Download, Switch, QuestionFilled, Brush } from '@element-plus/icons-vue'
import { ElMessage, ElMessageBox, ElProgress, ElScrollbar } from 'element-plus'

const { t } = useI18n();

// --- Component State ---
const activeView = ref('local');
const localChatPath = ref('');
const webdavConfig = ref(null);
const isWebdavConfigValid = ref(false);
const isCloudDataLoaded = ref(false);

const localChatFiles = ref([]);
const cloudChatFiles = ref([]);
const isTableLoading = ref(false);
const selectedFiles = ref([]);
const currentPage = ref(1);
const pageSize = ref(10);
const singleFileSyncing = ref({});

// --- Sync Progress State ---
const isSyncing = ref(false);
const syncProgress = ref(0);
const syncStatusText = ref('');
const syncAbortController = ref(null);

// --- è‡ªåŠ¨æ¸…ç†åŠŸèƒ½çŠ¶æ€ ---
const showCleanDialog = ref(false);
const cleanDaysOption = ref(30); // é»˜è®¤30å¤©
const cleanCustomDays = ref(60);
const isCleaning = ref(false);

// --- Computed Properties ---
const getFileMap = (fileList) => new Map(fileList.map(f => [f.basename, f]));

const uploadableCount = computed(() => {
    if (!isWebdavConfigValid.value) return 0;
    const cloudMap = getFileMap(cloudChatFiles.value);
    return localChatFiles.value.filter(local => {
        const cloudFile = cloudMap.get(local.basename);
        return !cloudFile || new Date(local.lastmod) > new Date(cloudFile.lastmod);
    }).length;
});

const downloadableCount = computed(() => {
    if (!isWebdavConfigValid.value) return 0;
    const localMap = getFileMap(localChatFiles.value);
    return cloudChatFiles.value.filter(cloud => {
        const localFile = localMap.get(cloud.basename);
        return !localFile || new Date(cloud.lastmod) > new Date(localFile.lastmod);
    }).length;
});

const currentFiles = computed(() => activeView.value === 'local' ? localChatFiles.value : cloudChatFiles.value);
const paginatedFiles = computed(() => {
    const start = (currentPage.value - 1) * pageSize.value;
    const end = start + pageSize.value;
    return currentFiles.value.slice(start, end);
});

// --- Helper Functions ---
const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString();
};
const formatBytes = (bytes, decimals = 2) => {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
};

onMounted(async () => {
    try {
        const result = await window.api.getConfig();
        if (result && result.config && result.config.webdav) {
            localChatPath.value = result.config.webdav.localChatPath;
            webdavConfig.value = result.config.webdav;
            isWebdavConfigValid.value = !!(webdavConfig.value.url && webdavConfig.value.data_path);
            if (localChatPath.value) await fetchLocalFiles();
        }
    } catch (error) { ElMessage.error(t('chats.alerts.configError')); }
});

watch(activeView, async (newView) => {
    if (newView === 'cloud' && !isCloudDataLoaded.value && isWebdavConfigValid.value) {
        await fetchCloudFiles();
        isCloudDataLoaded.value = true;
    }
});

// --- Main Functions ---
async function fetchLocalFiles() {
    if (!localChatPath.value) return;
    isTableLoading.value = true;
    try {
        localChatFiles.value = await window.api.listJsonFiles(localChatPath.value);
    } catch (error) { ElMessage.error(`è¯»å–æœ¬åœ°æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`); localChatFiles.value = []; } finally { isTableLoading.value = false; }
}

async function fetchCloudFiles() {
    if (!isWebdavConfigValid.value) return;
    isTableLoading.value = true;
    try {
        const { url, username, password, data_path } = webdavConfig.value;
        const client = createClient(url, { username, password });
        const remoteDir = data_path.endsWith('/') ? data_path.slice(0, -1) : data_path;
        if (!(await client.exists(remoteDir))) await client.createDirectory(remoteDir, { recursive: true });
        const response = await client.getDirectoryContents(remoteDir, { details: true });
        cloudChatFiles.value = response.data.filter(item => item.type === 'file' && item.basename.endsWith('.json')).sort((a, b) => new Date(b.lastmod) - new Date(a.lastmod));
    } catch (error) { ElMessage.error(`${t('chats.alerts.fetchFailed')}: ${error.message}`); cloudChatFiles.value = []; } finally { isTableLoading.value = false; }
}
async function refreshData() {
    if (activeView.value === 'local') {
        if (localChatPath.value) {
            await fetchLocalFiles();
        }
    } else if (activeView.value === 'cloud') {
        if (isWebdavConfigValid.value) {
            await fetchCloudFiles();
            isCloudDataLoaded.value = true;
        }
    }
}
async function startChat(file) {
    ElMessage.info(t('chats.alerts.loadingChat'));
    try {
        let jsonString;
        if (activeView.value === 'local') {
            jsonString = await window.api.readLocalFile(file.path);
        } else {
            const { url, username, password, data_path } = webdavConfig.value;
            const client = createClient(url, { username, password });
            jsonString = await client.getFileContents(`${data_path.endsWith('/') ? data_path.slice(0, -1) : data_path}/${file.basename}`, { format: "text" });
        }
        await window.api.coderedirect(t('chats.alerts.restoreChat'), JSON.stringify({ sessionData: jsonString, filename: file.basename }));
        ElMessage.success(t('chats.alerts.restoreInitiated'));
    } catch (error) { ElMessage.error(`${t('chats.alerts.restoreFailed')}: ${error.message}`); }
}
async function renameFile(file) {
    const defaultInputValue = file.basename.endsWith('.json') ? file.basename.slice(0, -5) : file.basename;
    try {
        const { value: userInput } = await ElMessageBox.prompt(t('chats.rename.promptMessage'), t('chats.rename.promptTitle'), { inputValue: defaultInputValue });
        let finalFilename = (userInput || "").trim();
        if (!finalFilename.toLowerCase().endsWith('.json')) finalFilename += '.json';
        if (finalFilename === file.basename || finalFilename === '.json') return;

        if (activeView.value === 'local') {
            await window.api.renameLocalFile(file.path, `${localChatPath.value}/${finalFilename}`);
            if (isWebdavConfigValid.value && cloudChatFiles.value.some(f => f.basename === file.basename)) {
                const confirm = await ElMessageBox.confirm(
                    t('chats.rename.syncCloudConfirm'),
                    t('chats.rename.syncTitle'),
                    { type: 'info' }
                ).catch(() => false);
                if (confirm) {
                    const client = createClient(webdavConfig.value.url, { username: webdavConfig.value.username, password: webdavConfig.value.password });
                    await client.moveFile(`${webdavConfig.value.data_path}/${file.basename}`, `${webdavConfig.value.data_path}/${finalFilename}`);
                }
            }
        } else { // cloud
            const client = createClient(webdavConfig.value.url, { username: webdavConfig.value.username, password: webdavConfig.value.password });
            await client.moveFile(`${webdavConfig.value.data_path}/${file.basename}`, `${webdavConfig.value.data_path}/${finalFilename}`);
            if (localChatFiles.value.some(f => f.basename === file.basename)) {
                const confirm = await ElMessageBox.confirm(
                    t('chats.rename.syncLocalConfirm'),
                    t('chats.rename.syncTitle'),
                    { type: 'info' }
                ).catch(() => false);
                if (confirm) await window.api.renameLocalFile(`${localChatPath.value}/${file.basename}`, `${localChatPath.value}/${finalFilename}`);
            }
        }
        ElMessage.success(t('chats.alerts.renameSuccess'));
        await refreshData();
    } catch (error) {
        if (error !== 'cancel' && error !== 'close') ElMessage.error(`${t('chats.alerts.renameFailed')}: ${error.message}`);
    }
}
async function deleteFiles(filesToDelete) {
    if (filesToDelete.length === 0) {
        ElMessage.warning(t('common.noFileSelected'));
        return;
    }

    try {
        await ElMessageBox.confirm(t('common.confirmDeleteMultiple', { count: filesToDelete.length }), t('common.warningTitle'), { type: 'warning' });

        let syncDeletions = false;

        if (isWebdavConfigValid.value && localChatPath.value) {
            const localMap = new Map(localChatFiles.value.map(f => [f.basename, f]));
            const cloudMap = new Map(cloudChatFiles.value.map(f => [f.basename, f]));

            const counterpartFiles = filesToDelete.filter(file => {
                return activeView.value === 'local' ? cloudMap.has(file.basename) : localMap.has(file.basename);
            });

            if (counterpartFiles.length > 0) {
                const location = activeView.value === 'local' ? t('chats.view.cloud') : t('chats.view.local');
                try {
                    await ElMessageBox.confirm(
                        t('chats.alerts.confirmSyncDeleteMessage', { count: counterpartFiles.length, location: location }),
                        t('chats.alerts.confirmSyncDeleteTitle'),
                        { type: 'info' }
                    );
                    syncDeletions = true;
                } catch (e) {
                    syncDeletions = false;
                }
            }
        }

        isTableLoading.value = true;
        const client = isWebdavConfigValid.value ? createClient(webdavConfig.value.url, { username: webdavConfig.value.username, password: webdavConfig.value.password }) : null;

        for (const file of filesToDelete) {
            if (activeView.value === 'local') {
                await window.api.deleteLocalFile(file.path);
                if (syncDeletions && client && cloudChatFiles.value.some(f => f.basename === file.basename)) {
                    await client.deleteFile(`${webdavConfig.value.data_path}/${file.basename}`);
                }
            } else { // cloud view
                if (client) {
                    await client.deleteFile(`${webdavConfig.value.data_path}/${file.basename}`);
                    if (syncDeletions && localChatFiles.value.some(f => f.basename === file.basename)) {
                        await window.api.deleteLocalFile(`${localChatPath.value}/${file.basename}`);
                    }
                }
            }
        }

        ElMessage.success(t('common.deleteSuccessMultiple'));
        await refreshData();
        selectedFiles.value = [];

    } catch (error) {
        if (error !== 'cancel' && error !== 'close') {
            ElMessage.error(`${t('common.deleteFailedMultiple')}: ${error.message}`);
        }
    } finally {
        isTableLoading.value = false;
    }
}
const handleSelectionChange = (val) => selectedFiles.value = val;

const cancelSync = () => {
    if (syncAbortController.value) {
        syncAbortController.value.abort();
    }
};

async function runConcurrentTasks(tasks, signal, concurrencyLimit = 3) {
    const results = { completed: 0, failed: 0, failedFiles: [] };
    const queue = [...tasks];

    const worker = async () => {
        while (queue.length > 0) {
            if (signal.aborted) throw new Error("Cancelled");
            const task = queue.shift();
            try {
                await task.action(signal);
                results.completed++;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error("Cancelled");
                }
                results.failed++;
                results.failedFiles.push(task.name);
                console.error(`Task failed for ${task.name}:`, error);
            } finally {
                if (!signal.aborted) {
                    syncProgress.value = Math.round(((results.completed + results.failed) / tasks.length) * 100);
                    syncStatusText.value = t('chats.alerts.syncProcessing', { completed: results.completed + results.failed, total: tasks.length });
                }
            }
        }
    };

    const workers = Array(concurrencyLimit).fill(null).map(worker);
    await Promise.all(workers);
    return results;
}

async function intelligentUpload() {
    if (!isWebdavConfigValid.value) return ElMessage.warning(t('chats.alerts.webdavRequired'));
    const filesToUpload = localChatFiles.value.filter(local => {
        const cloudFile = getFileMap(cloudChatFiles.value).get(local.basename);
        return !cloudFile || new Date(local.lastmod) > new Date(cloudFile.lastmod);
    });
    if (filesToUpload.length === 0) return ElMessage.info(t('chats.alerts.syncNoUpload'));

    try {
        await ElMessageBox.confirm(
            t('chats.tooltips.uploadChanges', { count: filesToUpload.length }) + ' ' + t('chats.alerts.continueConfirm'),
            t('chats.alerts.syncConfirmUploadTitle'),
            { type: 'info' }
        );
        const tasks = filesToUpload.map(file => ({ name: file.basename, action: (signal) => forceSyncFile(file.basename, 'upload', signal) }));
        await executeSync(tasks, t('chats.alerts.syncConfirmUploadTitle'));
    } catch (error) {
        if (error === 'cancel' || error === 'close') return;
        ElMessage.error(`${error.message}`);
    }
}

async function intelligentDownload() {
    if (!localChatPath.value) return ElMessage.warning(t('chats.alerts.localPathRequired'));
    const filesToDownload = cloudChatFiles.value.filter(cloud => {
        const localFile = getFileMap(localChatFiles.value).get(cloud.basename);
        return !localFile || new Date(cloud.lastmod) > new Date(localFile.lastmod);
    });
    if (filesToDownload.length === 0) return ElMessage.info(t('chats.alerts.syncNoDownload'));

    try {
        await ElMessageBox.confirm(
            t('chats.tooltips.downloadChanges', { count: filesToDownload.length }) + ' ' + t('chats.alerts.continueConfirm'),
            t('chats.alerts.syncConfirmDownloadTitle'),
            { type: 'info' }
        );
        const tasks = filesToDownload.map(file => ({ name: file.basename, action: (signal) => forceSyncFile(file.basename, 'download', signal) }));
        await executeSync(tasks, t('chats.alerts.syncConfirmDownloadTitle'));
    } catch (error) {
        if (error === 'cancel' || error === 'close') return;
        ElMessage.error(`${error.message}`);
    }
}

async function executeSync(tasks, title) {
    isSyncing.value = true;
    syncProgress.value = 0;
    syncAbortController.value = new AbortController();
    syncStatusText.value = title === t('chats.alerts.syncConfirmUploadTitle') ? t('chats.alerts.syncPreparingUpload') : t('chats.alerts.syncPreparingDownload');

    try {
        const results = await runConcurrentTasks(tasks, syncAbortController.value.signal);
        let message = title === t('chats.alerts.syncConfirmUploadTitle') ? t('chats.alerts.syncSuccessUpload', { count: results.completed }) : t('chats.alerts.syncSuccessDownload', { count: results.completed });
        if (results.failed > 0) message += ` ${t('chats.alerts.syncFailedPartially', { failedCount: results.failed })}`;
        ElMessage.success(message);
        await refreshData();
    } catch (error) {
        if (error.message === 'Cancelled') {
            ElMessage.warning(t('chats.alerts.syncCancelled'));
        } else {
            ElMessage.error(t('chats.alerts.syncFailed', { message: error.message }));
        }
    } finally {
        isSyncing.value = false;
        syncAbortController.value = null;
    }
}

async function forceSyncFile(basename, direction, signal) {
    singleFileSyncing.value[basename] = true;
    try {
        const client = createClient(webdavConfig.value.url, { username: webdavConfig.value.username, password: webdavConfig.value.password });
        const remotePath = `${webdavConfig.value.data_path}/${basename}`;
        const localPath = `${localChatPath.value}/${basename}`;

        if (direction === 'upload') {
            const localFile = localChatFiles.value.find(f => f.basename === basename);
            if (!localFile) throw new Error(`æœ¬åœ°æ–‡ä»¶ "${basename}" æœªæ‰¾åˆ°`);

            const content = await window.api.readLocalFile(localPath, signal);
            await client.putFileContents(remotePath, content, { overwrite: true, signal });

            await client.customRequest(remotePath, {
                method: "PROPPATCH",
                headers: { "Content-Type": "application/xml" },
                data: `<?xml version="1.0"?>
                       <d:propertyupdate xmlns:d="DAV:">
                         <d:set>
                           <d:prop>
                             <lastmodified xmlns="DAV:">${new Date(localFile.lastmod).toUTCString()}</lastmodified>
                           </d:prop>
                         </d:set>
                       </d:propertyupdate>`,
                signal
            });

        } else { // download
            const cloudFile = cloudChatFiles.value.find(f => f.basename === basename);
            if (!cloudFile) throw new Error(`äº‘ç«¯æ–‡ä»¶ "${basename}" æœªæ‰¾åˆ°`);

            const content = await client.getFileContents(remotePath, { format: 'text', signal });
            await window.api.writeLocalFile(localPath, content, signal);

            await window.api.setFileMtime(localPath, cloudFile.lastmod);
        }
    } catch (error) {
        if (error.name === 'AbortError') throw new Error("Cancelled");
        ElMessage.error(`åŒæ­¥æ–‡ä»¶ "${basename}" å¤±è´¥: ${error.message}`);
        throw error;
    } finally {
        singleFileSyncing.value[basename] = false;
    }
}

const computedFilesToClean = computed(() => {
    const days = cleanDaysOption.value === -1 ? cleanCustomDays.value : cleanDaysOption.value;
    if (!days || days < 1) return [];

    // è®¡ç®—æˆªæ­¢æ—¶é—´æˆ³
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);

    return currentFiles.value.filter(file => {
        const fileDate = new Date(file.lastmod);
        return fileDate < cutoffDate;
    });
});

const totalCleanSize = computed(() => {
    return computedFilesToClean.value.reduce((acc, file) => acc + (file.size || 0), 0);
});

function openCleanDialog() {
    showCleanDialog.value = true;
}

async function executeAutoClean() {
    const filesToDelete = computedFilesToClean.value;
    if (filesToDelete.length === 0) return;

    isCleaning.value = true;
    try {
        // ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæ‰¹é‡æ¸…ç†ä»…åˆ é™¤å½“å‰è§†å›¾çš„æ–‡ä»¶ï¼Œä¸è¿›è¡ŒåŒå‘åŒæ­¥åˆ é™¤è¯¢é—®
        // ç›´æ¥å¤ç”¨åº•å±‚çš„åˆ é™¤ API
        const client = isWebdavConfigValid.value ? createClient(webdavConfig.value.url, { username: webdavConfig.value.username, password: webdavConfig.value.password }) : null;

        // å¹¶å‘å¤„ç†
        const tasks = filesToDelete.map(file => async () => {
            if (activeView.value === 'local') {
                await window.api.deleteLocalFile(file.path);
            } else {
                if (client) {
                    await client.deleteFile(`${webdavConfig.value.data_path}/${file.basename}`);
                }
            }
        });

        // ç®€å•çš„å¹¶å‘æ§åˆ¶å™¨
        const batchSize = 5;
        for (let i = 0; i < tasks.length; i += batchSize) {
            const batch = tasks.slice(i, i + batchSize);
            await Promise.all(batch.map(t => t()));
        }

        ElMessage.success(t('chats.clean.success', { count: filesToDelete.length }));
        await refreshData();
        showCleanDialog.value = false;
        // æ¸…ç©ºé€‰æ‹©ï¼Œé˜²æ­¢æ®‹ç•™
        selectedFiles.value = [];

    } catch (error) {
        ElMessage.error(`æ¸…ç†å¤±è´¥: ${error.message}`);
    } finally {
        isCleaning.value = false;
    }
}

</script>

<template>
    <div class="chats-page-container">
        <div class="chats-content-wrapper">
            <div class="info-button-container">
                <el-popover placement="bottom-start" :title="t('chats.info.title')" :width="450" trigger="click">
                    <template #reference>
                        <el-button :icon="QuestionFilled" circle />
                    </template>
                    <div class="info-popover-content">
                        <p v-html="t('chats.info.localDesc', { path: localChatPath || t('chats.info.pathNotSet') })">
                        </p>
                        <p v-html="t('chats.info.cloudDesc')"></p>
                    </div>
                </el-popover>
                <el-tooltip :content="t('chats.clean.button')" placement="bottom">
                    <el-button :icon="Brush" circle @click="openCleanDialog" />
                </el-tooltip>
            </div>
            <div class="sync-buttons-container">
                <el-tooltip :content="t('chats.tooltips.uploadChanges', { count: uploadableCount })" placement="bottom">
                    <el-badge :value="uploadableCount" :hidden="uploadableCount === 0" type="primary">
                        <el-button :icon="Upload" @click="intelligentUpload" circle
                            :disabled="!isWebdavConfigValid || !localChatPath" />
                    </el-badge>
                </el-tooltip>
                <el-tooltip :content="t('chats.tooltips.downloadChanges', { count: downloadableCount })"
                    placement="bottom">
                    <el-badge :value="downloadableCount" :hidden="downloadableCount === 0" type="success">
                        <el-button :icon="Download" @click="intelligentDownload" circle
                            :disabled="!isWebdavConfigValid || !localChatPath" />
                    </el-badge>
                </el-tooltip>
            </div>
            <div class="view-selector">
                <el-radio-group v-model="activeView" @change="currentPage = 1">
                    <el-radio-button value="local">{{ t('chats.view.local') }}</el-radio-button>
                    <el-radio-button value="cloud" :disabled="!isWebdavConfigValid">{{ t('chats.view.cloud')
                        }}</el-radio-button>
                </el-radio-group>
            </div>

            <div class="table-container">
                <div v-if="activeView === 'local' && !localChatPath" class="config-prompt-small">
                    <el-empty :description="t('chats.configRequired.localPathDescription')">
                        <template #image>
                            <el-icon :size="50" color="#909399">
                                <Edit />
                            </el-icon>
                        </template>
                    </el-empty>
                </div>

                <div v-else-if="activeView === 'cloud' && !isWebdavConfigValid" class="config-prompt-small">
                    <el-empty :description="t('chats.configRequired.webdavDescription')">
                        <template #image>
                            <el-icon :size="50" color="#909399">
                                <Edit />
                            </el-icon>
                        </template>
                    </el-empty>
                </div>

                <el-table v-else :data="paginatedFiles" v-loading="isTableLoading"
                    @selection-change="handleSelectionChange" style="width: 100%" height="100%" border stripe>
                    <el-table-column type="selection" width="50" align="center" />
                    <el-table-column prop="basename" :label="t('chats.table.filename')" sortable show-overflow-tooltip
                        min-width="120">
                        <template #default="scope">
                            <span class="filename-text">{{ scope.row.basename.endsWith('.json') ?
                                scope.row.basename.slice(0, -5) : scope.row.basename }}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="lastmod" :label="t('chats.table.modifiedTime')" width="160" sortable
                        align="center">
                        <template #default="scope">{{ formatDate(scope.row.lastmod) }}</template>
                    </el-table-column>
                    <el-table-column prop="size" :label="t('chats.table.size')" width="90" sortable align="center">
                        <template #default="scope">{{ formatBytes(scope.row.size) }}</template>
                    </el-table-column>
                    <el-table-column :label="t('chats.table.actions')" width="300" align="center">
                        <template #default="scope">
                            <div class="action-buttons-container">
                                <el-button link type="primary" :icon="ChatDotRound" @click="startChat(scope.row)">{{
                                    t('chats.actions.chat') }}</el-button>
                                <el-divider direction="vertical" />
                                <el-tooltip
                                    :content="activeView === 'local' ? t('chats.tooltips.forceUpload') : t('chats.tooltips.forceDownload')"
                                    placement="top">
                                    <el-button link type="primary" :icon="Switch"
                                        @click="forceSyncFile(scope.row.basename, activeView === 'local' ? 'upload' : 'download')"
                                        :loading="singleFileSyncing[scope.row.basename]">
                                        {{ t('chats.actions.forceSync') }}
                                    </el-button>
                                </el-tooltip>
                                <el-divider direction="vertical" />
                                <el-button link type="warning" :icon="Edit" @click="renameFile(scope.row)">{{
                                    t('chats.actions.rename') }}</el-button>
                                <el-divider direction="vertical" />
                                <el-button link type="danger" :icon="DeleteIcon" @click="deleteFiles([scope.row])">{{
                                    t('chats.actions.delete') }}</el-button>
                            </div>
                        </template>
                    </el-table-column>
                </el-table>
            </div>

            <div class="footer-bar">
                <div class="footer-left">
                    <el-button :icon="Refresh" @click="refreshData">{{ t('common.refresh') }}</el-button>
                    <el-button type="danger" :icon="DeleteIcon" @click="deleteFiles(selectedFiles)"
                        :disabled="selectedFiles.length === 0">
                        {{ t('common.deleteSelected') }} ({{ selectedFiles.length }})
                    </el-button>
                </div>
                <div class="footer-center">
                    <el-pagination v-if="currentFiles.length > 0" v-model:current-page="currentPage"
                        v-model:page-size="pageSize" :page-sizes="[10, 20, 50, 100]" :total="currentFiles.length"
                        layout="total, sizes, prev, pager, next, jumper" background size="small" />
                </div>
                <div class="footer-right">
                </div>
            </div>
        </div>
    </div>
    <el-dialog v-model="isSyncing" :title="t('chats.alerts.syncInProgress')" :close-on-click-modal="false"
        :show-close="false" :close-on-press-escape="false" width="400px" center>
        <div class="sync-progress-container">
            <el-progress :percentage="syncProgress" :stroke-width="10" striped striped-flow />
            <p class="sync-status-text">{{ syncStatusText }}</p>
        </div>
        <template #footer>
            <el-button @click="cancelSync">{{ t('common.cancel') }}</el-button>
        </template>
    </el-dialog>

    <el-dialog v-model="showCleanDialog" :title="t('chats.clean.title')" width="500px" append-to-body>
        <div class="clean-dialog-body">
            <div class="clean-options">
                <span class="label">{{ t('chats.clean.timeRangeLabel') }}:</span>
                <el-select v-model="cleanDaysOption" style="width: 140px; margin-right: 10px;">
                    <el-option :label="t('chats.clean.ranges.3')" :value="3" />
                    <el-option :label="t('chats.clean.ranges.7')" :value="7" />
                    <el-option :label="t('chats.clean.ranges.30')" :value="30" />
                    <el-option :label="t('chats.clean.ranges.custom')" :value="-1" />
                </el-select>
                <el-input-number v-if="cleanDaysOption === -1" v-model="cleanCustomDays" :min="1" :max="3650"
                    style="width: 120px;" controls-position="right" />
            </div>

            <div class="clean-preview">
                <p v-if="computedFilesToClean.length > 0" class="preview-title">
                    {{ t('chats.clean.previewTitle', {
                        count: computedFilesToClean.length,
                        days: cleanDaysOption === -1 ? cleanCustomDays : cleanDaysOption,
                        size: formatBytes(totalCleanSize)
                    }) }}
                </p>
                <p v-else class="preview-title text-gray">{{ t('chats.clean.noFilesFound') }}</p>

                <el-scrollbar max-height="30vh" v-if="computedFilesToClean.length > 0" class="custom-clean-scrollbar">
                    <ul class="file-preview-list">
                        <li v-for="file in computedFilesToClean" :key="file.basename">
                            <span class="fname">{{ file.basename }}</span>
                            <span class="fdate">{{ formatDate(file.lastmod) }}</span>
                        </li>
                    </ul>
                </el-scrollbar>
            </div>
        </div>
        <template #footer>
            <el-button @click="showCleanDialog = false">{{ t('common.cancel') }}</el-button>
            <el-button type="danger" @click="executeAutoClean" :loading="isCleaning"
                :disabled="computedFilesToClean.length === 0">
                {{ t('chats.clean.confirmBtn') }}
            </el-button>
        </template>
    </el-dialog>
</template>

<style scoped>
.view-selector {
    padding: 5px 15px 0px 0px;
    text-align: center;
}

.chats-page-container {
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
    padding: 21px;
    box-sizing: border-box;
    overflow: hidden;
    background-color: var(--bg-primary);
}

.config-prompt {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    height: 100%;
    text-align: center;
    background-color: var(--bg-secondary);
    border-radius: var(--radius-lg);
    box-shadow: 0 0 0 1px var(--border-primary);
}

.config-prompt-title {
    font-size: 18px;
    color: var(--text-primary);
    margin-top: 0;
    margin-bottom: 8px;
    font-weight: 600;
}

:deep(.el-empty__description p) {
    color: var(--text-secondary);
    font-size: 14px;
}

.chats-content-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    background-color: var(--bg-secondary);
    border-radius: var(--radius-lg);
    box-shadow: 0 0 0 1px var(--border-primary), var(--shadow-sm);
    overflow: hidden;
}

.table-container {
    flex-grow: 1;
    overflow: hidden;
    padding: 5px 10px 10px 10px;
}

.filename-text {
    font-weight: 600;
    color: var(--text-primary);
}

:deep(.el-table),
:deep(.el-table__expanded-cell) {
    background-color: transparent;
}

:deep(.el-table .el-table__cell) {
    color: var(--text-secondary);
}

:deep(.el-table tr) {
    background-color: transparent;
    transition: background-color 0.2s;
}

:deep(.el-table--striped .el-table__body tr.el-table__row--striped td.el-table__cell) {
    background-color: var(--bg-primary);
}

:deep(.el-table--enable-row-hover .el-table__body tr:hover>td.el-table__cell) {
    background-color: var(--bg-tertiary);
}

:deep(.el-table__header-wrapper th) {
    background-color: var(--bg-primary) !important;
    color: var(--text-secondary);
    font-weight: 600;
}

:deep(.el-table__border-left-patch) {
    border-left: 1px solid var(--border-primary);
}

:deep(.el-table__border-right-patch) {
    border-left: 1px solid var(--border-primary);
}

:deep(.el-table--border .el-table__inner-wrapper::after),
:deep(.el-table--border::after),
:deep(.el-table--border::before),
:deep(.el-table__inner-wrapper::before) {
    background-color: var(--border-primary);
}

:deep(.el-table td.el-table__cell),
:deep(.el-table th.el-table__cell.is-leaf) {
    border-bottom: 1px solid var(--border-primary);
    color: var(--text-primary);
}

:deep(.el-table--border .el-table__cell) {
    border-right: 1px solid var(--border-primary);
}

:deep(.el-table__empty-text) {
    color: var(--text-tertiary);
}

.action-buttons-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0;
}

.action-buttons-container .el-button {
    font-weight: 500;
}

.action-buttons-container .el-divider--vertical {
    height: 1em;
    border-left: 1px solid var(--border-primary);
    margin: 0 8px;
}

.footer-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px 15px;
    border-top: 1px solid var(--border-primary);
    background-color: var(--bg-primary);
    flex-shrink: 0;
}

.footer-left,
.footer-right {
    display: flex;
    align-items: center;
    gap: 10px;
}

.footer-center {
    flex-grow: 1;
    display: flex;
    justify-content: center;
}

.footer-right {
    justify-content: flex-end;
}

:deep(.el-pagination) {
    --el-pagination-text-color: var(--text-secondary);
}

:deep(.el-pagination.is-background .el-pager li),
:deep(.el-pagination.is-background .btn-prev),
:deep(.el-pagination.is-background .btn-next) {
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
}

:deep(.el-pagination.is-background .el-pager li:not(.is-disabled).is-active) {
    background-color: var(--bg-accent);
    color: var(--text-on-accent);
}

:deep(.el-pagination.is-background .el-pager li:hover) {
    color: var(--text-accent);
}

:deep(.el-pagination.is-background .btn-prev:hover),
:deep(.el-pagination.is-background .btn-next:hover) {
    color: var(--text-accent);
}

.config-prompt-small {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
}

.sync-progress-container {
    padding: 20px;
    text-align: center;
}

.sync-status-text {
    margin-top: 15px;
    color: var(--text-secondary);
}

.sync-buttons-container {
    position: absolute;
    top: 8px;
    /* æ ¹æ®è§†è§‰æ•ˆæœå¾®è°ƒ */
    right: 20px;
    z-index: 10;
    /* ç¡®ä¿åœ¨è¡¨æ ¼ä¹‹ä¸Š */
    display: flex;
    gap: 8px;
}

.sync-buttons-container .el-button {
    width: 32px;
    height: 32px;
}

.sync-buttons-container :deep(.el-badge__content) {
    font-size: 10px;
    padding: 0 5px;
    height: 16px;
    line-height: 16px;
    min-width: 16px;
    border-width: 1px;
    /* è°ƒæ•´ä½ç½® */
    transform: translateY(-50%) translateX(70%);
}

/* ä¿®å¤æ·±è‰²æ¨¡å¼ä¸‹ primary å¾½ç« çš„é¢œè‰² */
html.dark .sync-buttons-container :deep(.el-badge__content--primary) {
    background-color: var(--el-color-primary);
    color: var(--bg-primary);
    /* ä½¿ç”¨æ·±è‰²èƒŒæ™¯ä½œä¸ºæ–‡å­—é¢œè‰² */
}

.info-button-container {
    position: absolute;
    top: 8px;
    left: 20px;
    z-index: 10;
}

.info-button-container .el-button {
    width: 32px;
    height: 32px;
}

/* å¼¹å‡ºæ¡†å†…å®¹çš„æ ·å¼ */
.info-popover-content p {
    margin: 0 0 8px 0;
    line-height: 1.6;
    color: var(--text-secondary);
}

.info-popover-content p:last-child {
    margin-bottom: 0;
}

.info-popover-content strong {
    color: var(--text-primary);
}

.info-popover-content code {
    background-color: var(--bg-tertiary);
    color: var(--el-color-primary);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
    word-break: break-all;
}

.clean-options {
    display: flex;
    align-items: center;
    margin-top: 10px;
}

.clean-options .label {
    margin-right: 10px;
    font-weight: 500;
    color: var(--text-primary);
}

.clean-preview {
    margin-top: 15px;
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: 10px 10px 5px 10px;
    background-color: var(--bg-tertiary);
}

.preview-title {
    margin: 0 0 8px 0;
    font-size: 13px;
    font-weight: 600;
    color: var(--el-color-danger);
}

.preview-title.text-gray {
    color: var(--text-tertiary);
}

.file-preview-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.custom-clean-scrollbar {
    width: 100%;
}
.custom-clean-scrollbar :deep(.el-scrollbar__view) {
    display: block;
}


html.dark .custom-clean-scrollbar :deep(.el-scrollbar__thumb) {
    background-color: var(--text-tertiary);
    opacity: 0.5;
}

html.dark .custom-clean-scrollbar :deep(.el-scrollbar__thumb:hover) {
    background-color: var(--text-secondary);
    opacity: 0.8;
}

.file-preview-list li {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    padding: 4px 0;
    border-bottom: 1px dashed var(--border-primary);
    color: var(--text-secondary);
}

.file-preview-list li:last-child {
    border-bottom: none;
}

.file-preview-list .fname {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 10px;
}

.file-preview-list .fdate {
    flex-shrink: 0;
    color: var(--text-tertiary);
    margin-right: 12px;
}
</style>
```
```vue
./Anywhere_main/src/components/Mcp.vue
<script setup>
import { ref, reactive, computed, inject } from 'vue';
import { useI18n } from 'vue-i18n';
import { ElMessage, ElMessageBox, ElScrollbar, ElAlert } from 'element-plus';
import { Plus, Delete, Edit, CopyDocument, Tools, Search, Refresh, QuestionFilled, Link, CaretRight, CaretBottom } from '@element-plus/icons-vue';
const { t } = useI18n();
const currentConfig = inject('config');

const showEditDialog = ref(false);
const showJsonDialog = ref(false);
const isNewServer = ref(false);
const jsonEditorContent = ref('');
const searchQuery = ref('');
const advancedCollapse = ref([]);

// æµ‹è¯•ç›¸å…³çŠ¶æ€
const activeTestTab = ref('list');
const showTestResultDialog = ref(false);
const currentTestingServer = ref(null); // ä¿å­˜å½“å‰æ­£åœ¨æŸ¥çœ‹/æµ‹è¯•çš„æœåŠ¡å™¨å¼•ç”¨
const testResult = reactive({
    loading: false,
    success: false,
    message: '',
    tools: [],
    serverName: '',
    serverDescription: '',
    isCached: false
});
const isTestAreaExpanded = ref(false);
const currentTestToolName = ref('');
const testFormData = ref({});
const testRunning = ref(false);
const testOutput = ref('');

// è®¡ç®—å½“å‰é€‰ä¸­å·¥å…·çš„ Schema
const currentTestToolSchema = computed(() => {
    if (!currentTestToolName.value) return [];
    const tool = testResult.tools.find(t => t.name === currentTestToolName.value);
    if (!tool || !tool.inputSchema || !tool.inputSchema.properties) return [];

    // å°† properties å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„ä»¥ä¾¿ v-for
    return Object.entries(tool.inputSchema.properties).map(([key, schema]) => ({
        key,
        ...schema,
        required: tool.inputSchema.required?.includes(key) || false
    }));
});

// åˆ‡æ¢æµ‹è¯•å·¥å…·æ—¶ï¼Œé‡ç½®è¡¨å•
const handleTestToolChange = (val) => {
    testFormData.value = {};
    testOutput.value = '';
    if (!val) return;

    // åˆå§‹åŒ–é»˜è®¤å€¼
    const tool = testResult.tools.find(t => t.name === val);
    if (tool && tool.inputSchema && tool.inputSchema.properties) {
        Object.entries(tool.inputSchema.properties).forEach(([key, schema]) => {
            // æ ¹æ®ç±»å‹è®¾ç½®é»˜è®¤å€¼
            if (schema.type === 'boolean') {
                testFormData.value[key] = false;
            } else if (schema.type === 'array' || schema.type === 'object') {
                testFormData.value[key] = ''; // å¤æ‚ç±»å‹ç”¨å­—ç¬¦ä¸²è¾“å…¥ï¼Œåç»­ parse
            } else {
                testFormData.value[key] = '';
            }
        });
    }
};

const defaultServer = {
    id: null,
    name: '',
    description: '',
    type: 'sse',
    isActive: true,
    isPersistent: false,
    baseUrl: '',
    command: '',
    args: [],
    env: {},
    headers: {},
    provider: '',
    providerUrl: '',
    logoUrl: '',
    tags: []
};

const createEditingServerState = () => ({
    ...defaultServer,
    args: '',
    env: '',
    headers: '',
    tags: ''
});

const editingServer = reactive(createEditingServerState());

const normalizedEditingServerType = computed({
    get() {
        const streamableHttpRegex = /^streamable[\s_-]?http$/i;
        if (editingServer.type && (streamableHttpRegex.test(editingServer.type) || editingServer.type.toLowerCase() === 'http')) {
            return 'http';
        }
        return editingServer.type;
    },
    set(newValue) {
        editingServer.type = newValue;
    }
});

const mcpServersList = computed(() => {
    if (!currentConfig.value || !currentConfig.value.mcpServers) return [];
    return Object.entries(currentConfig.value.mcpServers)
        .filter(([id, value]) => value && typeof value === 'object' && typeof value.name === 'string')
        .map(([id, value]) => ({ id, ...value }))
        .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
});

const filteredMcpServersList = computed(() => {
    if (!searchQuery.value) {
        return mcpServersList.value;
    }
    const lowerCaseQuery = searchQuery.value.toLowerCase();
    return mcpServersList.value.filter(server =>
        (server.name && server.name.toLowerCase().includes(lowerCaseQuery)) ||
        (server.description && server.description.toLowerCase().includes(lowerCaseQuery)) ||
        (server.provider && server.provider.toLowerCase().includes(lowerCaseQuery)) ||
        (server.tags && server.tags.some(tag => tag.toLowerCase().includes(lowerCaseQuery))) ||
        // æ–°å¢ï¼šæ”¯æŒæŒ‰åŸå§‹ç±»å‹(å¦‚ 'builtin')å’Œæ˜¾ç¤ºåç§°(å¦‚ 'å†…ç½®')æœç´¢
        (server.type && server.type.toLowerCase().includes(lowerCaseQuery)) ||
        (server.type && getDisplayTypeName(server.type).toLowerCase().includes(lowerCaseQuery))
    );
});

function getDisplayTypeName(type) {
    if (!type) return '';
    const streamableHttpRegex = /^streamable[\s_-]?http$/i;
    const lowerType = type.toLowerCase();

    if (lowerType === 'builtin') return t('mcp.typeOptions.builtin');

    if (streamableHttpRegex.test(lowerType) || lowerType === 'http') {
        return t('mcp.typeOptions.http');
    }

    switch (lowerType) {
        case 'sse': return t('mcp.typeOptions.sse');
        case 'stdio': return t('mcp.typeOptions.stdio');
        default: return type;
    }
}

function generateUniqueId() {
    return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
}

async function atomicSave(updateFunction) {
    try {
        const latestConfigData = await window.api.getConfig();
        const latestConfig = latestConfigData.config;
        updateFunction(latestConfig);
        await window.api.updateConfigWithoutFeatures({ config: latestConfig });
        currentConfig.value = latestConfig;
    } catch (error) {
        console.error("Atomic save failed:", error);
        ElMessage.error(t('mcp.alerts.saveFailed'));
    }
}

const convertTextToLines = (text) => text ? text.split('\n').map(l => l.trim()).filter(Boolean) : [];
const convertLinesToText = (lines) => Array.isArray(lines) ? lines.join('\n') : '';

const convertTextToObject = (text) => {
    if (!text) return {};
    return text.split('\n').reduce((acc, line) => {
        const trimmedLine = line.trim();
        if (!trimmedLine || trimmedLine.startsWith('#')) return acc;
        const separatorIndex = trimmedLine.search(/[=:]/);
        if (separatorIndex > 0) {
            const key = trimmedLine.substring(0, separatorIndex).trim();
            let value = trimmedLine.substring(separatorIndex + 1).trim();
            if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
                value = value.substring(1, value.length - 1);
            }
            if (key) acc[key] = value;
        }
        return acc;
    }, {});
};
const convertObjectToText = (obj) => {
    if (!obj || Object.keys(obj).length === 0) return '';
    return Object.entries(obj).map(([key, value]) => `${key}: ${value}`).join('\n');
};

function prepareAddServer() {
    isNewServer.value = true;
    Object.assign(editingServer, createEditingServerState());
    advancedCollapse.value = [];
    showEditDialog.value = true;
}

function prepareEditServer(server) {
    isNewServer.value = false;
    Object.assign(editingServer, {
        ...createEditingServerState(),
        ...server,
        args: convertLinesToText(server.args),
        env: convertObjectToText(server.env),
        headers: convertObjectToText(server.headers),
        tags: Array.isArray(server.tags) ? server.tags.join(', ') : ''
    });
    advancedCollapse.value = [];
    showEditDialog.value = true;
}

async function saveServer() {
    const addIfPresent = (obj, key, value) => { if (value) obj[key] = value; };
    const addIfArrayPresent = (obj, key, value) => { if (value && value.length > 0) obj[key] = value; };
    const addIfObjectPresent = (obj, key, value) => { if (value && Object.keys(value).length > 0) obj[key] = value; };

    const serverData = {
        name: editingServer.name,
        type: editingServer.type,
        isActive: editingServer.isActive,
        isPersistent: editingServer.isPersistent,
    };

    addIfPresent(serverData, 'description', editingServer.description);
    addIfPresent(serverData, 'baseUrl', editingServer.baseUrl);
    addIfPresent(serverData, 'command', editingServer.command);
    addIfArrayPresent(serverData, 'args', convertTextToLines(editingServer.args));
    addIfObjectPresent(serverData, 'env', convertTextToObject(editingServer.env));
    addIfObjectPresent(serverData, 'headers', convertTextToObject(editingServer.headers));
    addIfPresent(serverData, 'provider', editingServer.provider);
    addIfPresent(serverData, 'providerUrl', editingServer.providerUrl);
    addIfPresent(serverData, 'logoUrl', editingServer.logoUrl);
    addIfArrayPresent(serverData, 'tags', editingServer.tags ? editingServer.tags.split(',').map(t => t.trim()).filter(Boolean) : []);

    await atomicSave(config => {
        if (!config.mcpServers) config.mcpServers = {};
        const serverId = isNewServer.value ? generateUniqueId() : editingServer.id;
        config.mcpServers[serverId] = serverData;
    });

    ElMessage.success(t('mcp.alerts.saveSuccess'));
    showEditDialog.value = false;
}

function deleteServer(serverId, serverName) {
    ElMessageBox.confirm(
        t('mcp.alerts.deleteConfirmText', { name: serverName }),
        t('mcp.alerts.deleteConfirmTitle'),
        { type: 'warning' }
    ).then(async () => {
        await atomicSave(config => {
            // 1. åˆ é™¤ MCP æœåŠ¡é…ç½®
            if (config.mcpServers) {
                delete config.mcpServers[serverId];
            }

            // 2. éå†æ‰€æœ‰å¿«æ·åŠ©æ‰‹ï¼Œä» defaultMcpServers ä¸­ç§»é™¤å·²åˆ é™¤çš„ ID
            if (config.prompts) {
                Object.values(config.prompts).forEach(prompt => {
                    if (Array.isArray(prompt.defaultMcpServers)) {
                        const originalLength = prompt.defaultMcpServers.length;
                        prompt.defaultMcpServers = prompt.defaultMcpServers.filter(id => id !== serverId);
                    }
                });
            }
        });
        ElMessage.success(t('mcp.alerts.deleteSuccess'));
    }).catch(() => { });
}

async function handleSwitchChange(serverId, key, value) {
    await atomicSave(config => {
        if (config.mcpServers && config.mcpServers[serverId]) {
            config.mcpServers[serverId][key] = value;
        }
    });
}

async function copyServerJson(server) {
    const { id, ...serverConfig } = server;
    const jsonString = JSON.stringify(serverConfig, null, 2);
    await window.api.copyText(jsonString);
    ElMessage.success(t('mcp.alerts.configCopied'));
}

function prepareEditJson() {
    const dataToShow = { mcpServers: currentConfig.value.mcpServers || {} };
    jsonEditorContent.value = JSON.stringify(dataToShow, null, 2);
    showJsonDialog.value = true;
}

async function saveJson() {
    try {
        const parsedJson = JSON.parse(jsonEditorContent.value);
        if (typeof parsedJson !== 'object' || parsedJson === null || !parsedJson.hasOwnProperty('mcpServers')) {
            throw new Error(t('mcp.alerts.jsonError'));
        }
        const newMcpServers = parsedJson.mcpServers;

        await atomicSave(config => {
            config.mcpServers = newMcpServers;
        });
        ElMessage.success(t('mcp.alerts.saveSuccess'));
        showJsonDialog.value = false;
    } catch (error) {
        ElMessage.error(`${t('mcp.alerts.invalidJson')}: ${error.message}`);
    }
}

async function refreshMcpConfig() {
    try {
        const latestConfigData = await window.api.getConfig();
        if (latestConfigData && latestConfigData.config) {
            currentConfig.value = latestConfigData.config;
            ElMessage.success(t('mcp.alerts.refreshSuccess'));
        } else {
            throw new Error(t('mcp.alerts.configInvalid'));
        }
    } catch (error) {
        console.error("åˆ·æ–°MCPé…ç½®å¤±è´¥:", error);
        ElMessage.error(t('mcp.alerts.refreshFailed'));
    }
}

// åˆ‡æ¢å·¥å…·æµ‹è¯•é¢æ¿å±•å¼€/æŠ˜å 
function toggleToolTest(index) {
    if (!toolTestState.value[index]) {
        toolTestState.value[index] = {
            expanded: true,
            argsJson: '{}', // é»˜è®¤ç©ºJSONå¯¹è±¡
            running: false,
            result: ''
        };

        // å°è¯•æ ¹æ® schema ç”Ÿæˆé»˜è®¤å‚æ•°æ¨¡æ¿ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
        const tool = testResult.tools[index];
        if (tool && tool.inputSchema && tool.inputSchema.properties) {
            const defaultArgs = {};
            Object.keys(tool.inputSchema.properties).forEach(key => {
                defaultArgs[key] = "";
            });
            toolTestState.value[index].argsJson = JSON.stringify(defaultArgs, null, 2);
        }
    } else {
        toolTestState.value[index].expanded = !toolTestState.value[index].expanded;
    }
}

// è¿è¡Œå·¥å…·æµ‹è¯•
async function runToolTest() {
    if (!currentTestToolName.value) return;

    testRunning.value = true;
    testOutput.value = '';

    try {
        const args = {};
        // å¤„ç†è¡¨å•æ•°æ®
        for (const [key, value] of Object.entries(testFormData.value)) {
            if (value === '' || value === null || value === undefined) continue;
            const fieldSchema = currentTestToolSchema.value.find(f => f.key === key);
            if (fieldSchema && (fieldSchema.type === 'object' || fieldSchema.type === 'array')) {
                try {
                    args[key] = JSON.parse(value);
                } catch (e) {
                    testOutput.value = t('mcp.test.paramErrorJson', { key });
                    testRunning.value = false;
                    return;
                }
            } else if (fieldSchema && (fieldSchema.type === 'number' || fieldSchema.type === 'integer')) {
                const num = Number(value);
                if (isNaN(num)) {
                    testOutput.value = t('mcp.test.paramErrorNumber', { key });
                    testRunning.value = false;
                    return;
                }
                args[key] = num;
            } else {
                args[key] = value;
            }
        }

        const server = currentTestingServer.value;
        const configToTest = {
            id: server.id,
            name: server.name,
            type: server.type,
            command: server.command,
            baseUrl: server.baseUrl,
            env: typeof server.env === 'string' ? convertTextToObject(server.env) : server.env,
            headers: typeof server.headers === 'string' ? convertTextToObject(server.headers) : server.headers,
            args: Array.isArray(server.args) ? server.args : convertTextToLines(server.args)
        };

        const response = await window.api.testInvokeMcpTool(configToTest, currentTestToolName.value, args);

        // æ£€æŸ¥æ˜¯å¦å·²è¢«ç”¨æˆ·å–æ¶ˆ
        if (!testRunning.value) return;

        if (response.success) {
            const rawResult = response.result;
            if (typeof rawResult === 'string') {
                testOutput.value = rawResult;
            } else if (rawResult.content && Array.isArray(rawResult.content)) {
                testOutput.value = rawResult.content.map(item => {
                    if (item.type === 'text') return item.text;
                    if (item.type === 'image') return `[Image: ${item.mimeType}]`;
                    return JSON.stringify(item);
                }).join('\n\n');
            } else {
                testOutput.value = JSON.stringify(rawResult, null, 2);
            }
            if (!testOutput.value) testOutput.value = t('mcp.test.successNoContent');
        } else {
            testOutput.value = t('mcp.test.executionError') + response.error;
        }

    } catch (err) {
        if (!testRunning.value) return; // å¿½ç•¥å–æ¶ˆåçš„é”™è¯¯
        testOutput.value = t('mcp.test.systemError') + err.message;
    } finally {
        if (testRunning.value) {
            testRunning.value = false;
        }
    }
}

// å–æ¶ˆæµ‹è¯•
function cancelToolTest() {
    testRunning.value = false;
    // ç”±äºåç«¯ Promise æ— æ³•ä¸­æ–­ï¼Œè¿™é‡Œåš UI å±‚é¢çš„â€œå¿½ç•¥ç»“æœâ€
    ElMessage.info(t('mcp.test.opCancelled'));
}

// æ›´æ–°å·¥å…·ç¼“å­˜çŠ¶æ€ (å¯ç”¨/ç¦ç”¨)
async function updateToolCacheStatus() {
    if (!currentTestingServer.value || !testResult.tools) return;

    // æ·±æ‹·è´ä»¥å»é™¤ Vue å“åº”å¼ä»£ç†
    const toolsToSave = JSON.parse(JSON.stringify(testResult.tools));

    try {
        await window.api.saveMcpToolCache(currentTestingServer.value.id, toolsToSave);
        // é™é»˜ä¿å­˜ï¼Œä¸æ‰“æ‰°ç”¨æˆ·
    } catch (e) {
        console.error("ä¿å­˜å·¥å…·çŠ¶æ€å¤±è´¥", e);
        ElMessage.error(t('mcp.test.saveToolStateFailed'));
    }
}

// å¤„ç†ç‚¹å‡»è¿æ¥æŒ‰é’®
async function handleTestClick(server) {
    currentTestToolName.value = '';
    testFormData.value = {};
    testOutput.value = '';
    activeTestTab.value = 'list';
    currentTestingServer.value = server;
    testResult.serverName = server.name;
    testResult.serverDescription = server.description;
    testResult.loading = true;
    showTestResultDialog.value = true;

    try {
        const cache = await window.api.getMcpToolCache();
        if (cache && cache[server.id] && Array.isArray(cache[server.id]) && cache[server.id].length > 0) {
            testResult.tools = cache[server.id].map(tool => ({
                ...tool,
                enabled: tool.enabled ?? true
            }));

            testResult.success = true;
            testResult.isCached = true;
            testResult.message = '';
            testResult.loading = false;

            if (testResult.tools.length > 0) {
                currentTestToolName.value = testResult.tools[0].name;
                handleTestToolChange(testResult.tools[0].name);
            }
        } else {
            await triggerConnectionTest(server);
        }
    } catch (error) {
        console.error("Cache read failed", error);
        await triggerConnectionTest(server);
    }
}

// å¼ºåˆ¶åˆ·æ–°ï¼ˆç‚¹å‡»å¼¹çª—å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ï¼‰
async function handleRefreshTest() {
    if (currentTestingServer.value) {
        await triggerConnectionTest(currentTestingServer.value);
    }
}

// æ‰§è¡ŒçœŸå®è¿æ¥æµ‹è¯•
async function triggerConnectionTest(server) {
    testResult.loading = true;
    testResult.isCached = false;
    testResult.success = false;
    testResult.message = '';
    testResult.tools = [];
    currentTestToolName.value = '';

    const configToTest = { /* ... æ„é€ é…ç½® ... */
        id: server.id,
        name: server.name,
        type: server.type,
        command: server.command,
        baseUrl: server.baseUrl,
        env: typeof server.env === 'string' ? convertTextToObject(server.env) : server.env,
        headers: typeof server.headers === 'string' ? convertTextToObject(server.headers) : server.headers,
        args: Array.isArray(server.args) ? server.args : convertTextToLines(server.args)
    };

    try {
        const result = await window.api.testMcpConnection(configToTest);

        if (result.success) {
            testResult.success = true;
            testResult.tools = result.tools || [];
            ElMessage.success(t('mcp.alerts.testSuccess'));
            if (testResult.tools.length > 0) {
                currentTestToolName.value = testResult.tools[0].name;
                handleTestToolChange(testResult.tools[0].name);
            }
        } else {
            testResult.success = false;
            testResult.message = result.error;
            ElMessage.error(t('mcp.alerts.testFailed'));
        }
    } catch (e) {
        testResult.success = false;
        testResult.message = e.message;
        ElMessage.error(t('mcp.alerts.testFailed'));
    } finally {
        testResult.loading = false;
    }
}
</script>

<template>
    <div class="page-container">
        <el-scrollbar class="main-content-scrollbar">
            <div class="content-wrapper">
                <div v-if="mcpServersList.length === 0" class="empty-state">
                    <el-empty :description="t('mcp.noServers')" />
                </div>
                <div v-else>
                    <div class="search-bar-container">
                        <el-input v-model="searchQuery" :placeholder="t('mcp.searchPlaceholder')" :prefix-icon="Search"
                            clearable />
                    </div>
                    <div v-if="filteredMcpServersList.length === 0" class="empty-state">
                        <el-empty :description="t('mcp.noMatch')" />
                    </div>
                    <div v-else class="mcp-grid-container">
                        <div v-for="server in filteredMcpServersList" :key="server.id" class="mcp-card">
                            <div class="mcp-card-header">
                                <el-avatar :src="server.logoUrl" shape="square" :size="32" class="mcp-card-icon">
                                    <el-icon :size="20">
                                        <Tools />
                                    </el-icon>
                                </el-avatar>
                                <div class="mcp-card-title-group">
                                    <span class="mcp-name">{{ server.name }}</span>
                                    <span class="mcp-provider" v-if="server.provider">{{ server.provider }}</span>
                                </div>

                                <!-- æŒä¹…è¿æ¥å¼€å…³ç§»åˆ° Header -->
                                <div class="mcp-header-actions">
                                    <el-tooltip
                                        :content="server.isPersistent ? t('mcp.persistentOn') : t('mcp.persistentOff')"
                                        placement="top">
                                        <el-button text circle size="small"
                                            :class="{ 'is-persistent-active': server.isPersistent }"
                                            @click.stop="handleSwitchChange(server.id, 'isPersistent', !server.isPersistent)"
                                            class="persistent-btn-header">
                                            <el-icon :size="14">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                    stroke-linejoin="round">
                                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                                                </svg>
                                            </el-icon>
                                        </el-button>
                                    </el-tooltip>

                                    <el-switch :model-value="server.isActive"
                                        @change="(value) => handleSwitchChange(server.id, 'isActive', value)"
                                        size="small" class="mcp-active-toggle" />
                                </div>
                            </div>
                            <div class="mcp-card-body">
                                <p class="mcp-description">{{ server.description }}</p>
                            </div>
                            <div class="mcp-card-footer">
                                <div class="mcp-tags">
                                    <el-tag v-if="server.type" size="small" type="info">{{
                                        getDisplayTypeName(server.type) }}</el-tag>
                                    <el-tag v-for="tag in server.tags" :key="tag" size="small">{{ tag }}</el-tag>
                                </div>
                                <div class="mcp-actions">
                                    <el-tooltip :content="t('mcp.testConnectionTooltip')" placement="top">
                                        <el-button :icon="Link" text circle @click="handleTestClick(server)"
                                            class="action-btn-compact" />
                                    </el-tooltip>
                                    <el-button v-if="server.type !== 'builtin'" :icon="Edit" text circle
                                        @click="prepareEditServer(server)" class="action-btn-compact" />
                                    <el-button v-if="server.type !== 'builtin'" :icon="Delete" text circle type="danger"
                                        @click="deleteServer(server.id, server.name)" class="action-btn-compact" />
                                    <el-button :icon="CopyDocument" text circle @click="copyServerJson(server)"
                                        class="action-btn-compact" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </el-scrollbar>

        <div class="bottom-actions-container">
            <el-button class="action-btn" @click="prepareAddServer" :icon="Plus" type="primary">
                {{ t('mcp.addServer') }}
            </el-button>
            <el-button class="action-btn" @click="prepareEditJson" :icon="Edit">
                {{ t('mcp.editJson') }}
            </el-button>
        </div>

        <!-- ç¼–è¾‘å¼¹çª— (ä¿æŒä¸å˜) -->
        <el-dialog v-model="showEditDialog" :title="isNewServer ? t('mcp.addServerTitle') : t('mcp.editServerTitle')"
            width="700px" :close-on-click-modal="false">
            <el-scrollbar max-height="50vh" class="mcp-dialog-scrollbar">
                <el-form :model="editingServer" label-position="top" @submit.prevent="saveServer">
                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-form-item :label="t('mcp.nameLabel')" required>
                                <el-input v-model="editingServer.name" />
                            </el-form-item>
                        </el-col>
                        <el-col :span="6">
                            <el-form-item :label="t('mcp.typeLabel')">
                                <el-select v-model="normalizedEditingServerType" style="width: 100%;">
                                    <el-option :label="t('mcp.typeOptions.sse')" value="sse" />
                                    <el-option :label="t('mcp.typeOptions.http')" value="http" />
                                    <el-option :label="t('mcp.typeOptions.stdio')" value="stdio" />
                                </el-select>
                            </el-form-item>
                        </el-col>
                        <el-col :span="6" class="switches-container">
                            <el-form-item :label="t('mcp.activeLabel')" class="compact-form-item">
                                <el-switch v-model="editingServer.isActive" />
                            </el-form-item>
                            <el-form-item class="compact-form-item">
                                <template #label>
                                    <span>{{ t('mcp.persistent.label') }}</span>
                                    <el-tooltip :content="t('mcp.persistent.tooltip')" placement="top">
                                        <el-icon style="margin-left: 4px; cursor: help; vertical-align: middle;">
                                            <QuestionFilled />
                                        </el-icon>
                                    </el-tooltip>
                                </template>
                                <el-switch v-model="editingServer.isPersistent"
                                    style="--el-switch-on-color: #67C23A;" />
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-form-item :label="t('mcp.descriptionLabel')">
                        <el-scrollbar max-height="100px" class="item-scrollbar">
                            <el-input v-model="editingServer.description" type="textarea" :autosize="{ minRows: 2 }"
                                resize="none" />
                        </el-scrollbar>
                    </el-form-item>

                    <el-divider content-position="left"></el-divider>

                    <template v-if="normalizedEditingServerType === 'http' || normalizedEditingServerType === 'sse'">
                        <el-form-item :label="t('mcp.http.url')"><el-input
                                v-model="editingServer.baseUrl" /></el-form-item>
                        <el-form-item :label="t('mcp.http.headers')">
                            <el-scrollbar max-height="80px" class="item-scrollbar">
                                <el-input v-model="editingServer.headers" type="textarea" :autosize="{ minRows: 2 }"
                                    resize="none" :placeholder="t('mcp.headersPlaceholder')" />
                            </el-scrollbar>
                        </el-form-item>
                    </template>

                    <template v-if="editingServer.type === 'stdio'">
                        <el-form-item :label="t('mcp.stdio.command')">
                            <el-scrollbar class="item-scrollbar">
                                <el-input v-model="editingServer.command" />
                            </el-scrollbar>
                        </el-form-item>
                        <el-form-item :label="t('mcp.stdio.args')">
                            <el-scrollbar max-height="80px" class="item-scrollbar">
                                <el-input v-model="editingServer.args" type="textarea" :autosize="{ minRows: 1 }"
                                    resize="none" :placeholder="t('mcp.argsPlaceholder')" />
                            </el-scrollbar>
                        </el-form-item>
                        <el-form-item :label="t('mcp.stdio.env')">
                            <el-scrollbar max-height="80px" class="item-scrollbar">
                                <el-input v-model="editingServer.env" type="textarea" :autosize="{ minRows: 2 }"
                                    resize="none" :placeholder="t('mcp.envPlaceholder')" />
                            </el-scrollbar>
                        </el-form-item>
                    </template>

                    <el-collapse v-model="advancedCollapse" class="advanced-collapse">
                        <el-collapse-item :title="t('mcp.advanced')" name="1">
                            <el-row :gutter="20">
                                <el-col :span="12">
                                    <el-form-item :label="t('mcp.providerName')">
                                        <el-input v-model="editingServer.provider" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item :label="t('mcp.logoUrl')">
                                        <el-input v-model="editingServer.logoUrl" />
                                    </el-form-item>
                                </el-col>
                            </el-row>
                            <el-form-item :label="t('mcp.providerUrl')"><el-input
                                    v-model="editingServer.providerUrl" /></el-form-item>
                            <el-form-item :label="t('mcp.tags')"><el-input v-model="editingServer.tags"
                                    :placeholder="t('mcp.tagsPlaceholder')" /></el-form-item>
                        </el-collapse-item>
                    </el-collapse>
                </el-form>
            </el-scrollbar>
            <template #footer>
                <el-button @click="showEditDialog = false">{{ t('common.cancel') }}</el-button>
                <el-button type="primary" @click="saveServer">{{ t('common.confirm') }}</el-button>
            </template>
        </el-dialog>

        <!-- JSON ç¼–è¾‘å¼¹çª— (ä¿æŒä¸å˜) -->
        <el-dialog v-model="showJsonDialog" :title="t('mcp.jsonDialog.title')" width="700px"
            :close-on-click-modal="false" custom-class="mcp-json-dialog">
            <el-alert :title="t('mcp.jsonDialog.description')" type="warning" show-icon :closable="false"
                style="margin-bottom: 15px;" />
            <el-scrollbar max-height="50vh" class="json-editor-scrollbar">
                <el-input v-model="jsonEditorContent" type="textarea" :autosize="true" resize="none" />
            </el-scrollbar>
            <template #footer>
                <el-button @click="showJsonDialog = false">{{ t('common.cancel') }}</el-button>
                <el-button type="primary" @click="saveJson">{{ t('common.confirm') }}</el-button>
            </template>
        </el-dialog>

        <!-- æµ‹è¯•ç»“æœå¼¹çª— -->
        <el-dialog v-model="showTestResultDialog" width="650px" append-to-body class="test-result-dialog">
            <template #header>
                <div class="test-dialog-header">
                    <div class="header-left">
                        <span class="dialog-title">
                            <el-tooltip v-if="testResult.serverDescription" :content="testResult.serverDescription"
                                placement="bottom-start" popper-class="mcp-tooltip-width">
                                {{ `${testResult.serverName}` }}
                            </el-tooltip>
                        </span>
                    </div>
                    <el-button v-if="!testResult.loading" :icon="Refresh" circle size="small" @click="handleRefreshTest"
                        :title="t('mcp.refreshTooltip')" />
                </div>
            </template>

            <div v-if="testResult.loading" class="test-loading-state">
                <el-icon class="is-loading" :size="24">
                    <Refresh />
                </el-icon>
                <p>{{ t('mcp.connecting') }}</p>
            </div>

            <div v-else class="test-result-content">
                <el-alert v-if="testResult.success && !testResult.isCached"
                    :title="t('mcp.connectionSuccess', { count: testResult.tools.length })" type="success" show-icon
                    style="margin-bottom: 10px; flex-shrink: 0;" />

                <el-alert v-else-if="!testResult.success" :title="t('mcp.connectionFailed')"
                    :description="testResult.message" type="error" show-icon :closable="false"
                    style="margin-bottom: 15px; flex-shrink: 0;" />

                <div v-if="testResult.success && testResult.tools.length > 0" class="tabs-wrapper">

                    <el-tabs v-model="activeTestTab" class="test-tabs">
                        <!-- Tab 1: å¯ç”¨å·¥å…·åˆ—è¡¨ -->
                        <el-tab-pane :label="t('mcp.tabs.tools')" name="list">
                            <el-scrollbar max-height="32vh" class="tab-inner-scrollbar">
                                <div class="tab-pane-content">
                                    <div class="list-header">
                                        <el-tag v-if="testResult.isCached" type="info" size="small" effect="plain" round
                                            class="cached-tag">
                                            {{ t('mcp.cached') }}
                                        </el-tag>
                                        <span class="hint-text">{{ t('mcp.hints.selectTools') }}</span>
                                    </div>
                                    <div class="tools-compact-list">
                                        <div v-for="tool in testResult.tools" :key="tool.name"
                                            class="tool-compact-item">
                                            <el-switch v-model="tool.enabled" size="small"
                                                @change="updateToolCacheStatus" />
                                            <span class="tool-compact-name" :title="tool.name">{{ tool.name }}</span>
                                            <el-tooltip :content="tool.description || t('mcp.noDescription')"
                                                placement="top" :show-after="500" popper-class="mcp-tooltip-width">
                                                <span class="tool-compact-desc">{{ tool.description ||
                                                    t('mcp.noDescription')
                                                    }}</span>
                                            </el-tooltip>
                                        </div>
                                    </div>
                                </div>
                            </el-scrollbar>
                        </el-tab-pane>

                        <!-- Tab 2: å·¥å…·è°ƒç”¨æµ‹è¯• -->
                        <el-tab-pane :label="t('mcp.tabs.test')" name="test">
                            <el-scrollbar max-height="32vh" class="tab-inner-scrollbar">
                                <div class="tab-pane-content">
                                    <div class="test-form-area no-border">
                                        <!-- å·¥å…·é€‰æ‹© -->
                                        <div class="test-form-row">
                                            <span class="label">{{ t('mcp.test.selectTool') }}</span>
                                            <el-select v-model="currentTestToolName"
                                                :placeholder="t('mcp.test.selectToolPlaceholder')" filterable
                                                @change="handleTestToolChange" style="flex: 1;">
                                                <el-option v-for="tool in testResult.tools" :key="tool.name"
                                                    :label="tool.name" :value="tool.name" />
                                            </el-select>
                                            <el-button v-if="testRunning" type="danger" plain @click="cancelToolTest">
                                                {{ t('mcp.test.cancel') }}
                                            </el-button>
                                            <el-button v-else type="primary" @click="runToolTest"
                                                :disabled="!currentTestToolName">
                                                {{ t('mcp.test.run') }}
                                            </el-button>
                                        </div>

                                        <!-- åŠ¨æ€å‚æ•°è¡¨å• -->
                                        <div v-if="currentTestToolName" class="dynamic-form-container">
                                            <div v-if="currentTestToolSchema.length === 0" class="no-params-text">
                                                {{ t('mcp.test.noParams') }}
                                            </div>

                                            <div v-else class="form-grid">
                                                <div v-for="field in currentTestToolSchema" :key="field.key"
                                                    class="dynamic-field">
                                                    <div class="field-label">
                                                        <span class="required-star" v-if="field.required">*</span>
                                                        {{ field.key }}
                                                        <el-tooltip v-if="field.description"
                                                            :content="field.description" placement="top"
                                                            popper-class="mcp-tooltip-width">
                                                            <el-icon class="info-icon">
                                                                <QuestionFilled />
                                                            </el-icon>
                                                        </el-tooltip>
                                                    </div>

                                                    <el-switch v-if="field.type === 'boolean'"
                                                        v-model="testFormData[field.key]" />

                                                    <el-input
                                                        v-else-if="field.type === 'integer' || field.type === 'number'"
                                                        v-model="testFormData[field.key]" type="number"
                                                        :placeholder="field.default !== undefined ? `${t('mcp.test.default')}: ${field.default}` : t('mcp.test.leaveEmpty')"
                                                        style="width: 100%;" />

                                                    <el-input
                                                        v-else-if="field.type === 'array' || field.type === 'object'"
                                                        v-model="testFormData[field.key]" type="textarea" :rows="2"
                                                        :placeholder="t('mcp.test.inputJsonPlaceholder', { type: field.type })"
                                                        style="font-family: monospace;" />

                                                    <el-select v-else-if="field.enum" v-model="testFormData[field.key]"
                                                        :placeholder="t('mcp.test.selectPlaceholder')"
                                                        style="width: 100%;" clearable>
                                                        <el-option v-for="opt in field.enum" :key="opt" :label="opt"
                                                            :value="opt" />
                                                    </el-select>

                                                    <el-input v-else v-model="testFormData[field.key]"
                                                        :placeholder="field.description || t('mcp.test.inputPlaceholder')" />
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ç»“æœè¾“å‡º -->
                                        <div v-if="testOutput" class="test-output-box">
                                            <div class="output-label">{{ t('mcp.test.response') }}</div>
                                            <el-scrollbar max-height="200px" class="result-scrollbar">
                                                <pre class="result-pre">{{ testOutput }}</pre>
                                            </el-scrollbar>
                                        </div>
                                    </div>
                                </div>
                            </el-scrollbar>
                        </el-tab-pane>
                    </el-tabs>

                </div>
                <el-empty v-else-if="testResult.success" :description="t('mcp.noToolsProvided')" :image-size="60" />
            </div>

            <template #footer>
                <el-button @click="showTestResultDialog = false">{{ t('common.close') }}</el-button>
            </template>
        </el-dialog>

        <el-button class="refresh-fab-button" :icon="Refresh" type="primary" circle @click="refreshMcpConfig"
            :title="t('mcp.refreshConfig')" />
    </div>
</template>

<style>
.mcp-tooltip-width {
    max-width: 60vw;
    line-height: 1.4;
}

/* é’ˆå¯¹ç»“æœæ¡†å†…éƒ¨çš„åŸç”Ÿæ»šåŠ¨æ¡ç¾åŒ– */
.result-content-static pre::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
</style>

<style scoped>
/* ================= å…¨å±€å¸ƒå±€ ================= */
.page-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    background-color: var(--bg-primary);
}

.main-content-scrollbar {
    flex-grow: 1;
}

html.dark .main-content-scrollbar :deep(.el-scrollbar__thumb) {
    background-color: var(--text-tertiary);
}

html.dark .main-content-scrollbar :deep(.el-scrollbar__thumb:hover) {
    background-color: var(--text-secondary);
}

.content-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0px 24px 80px 24px;
}

.search-bar-container {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: var(--bg-primary);
    padding: 8px 0px 8px 0px;
    margin: 0px 0px 5px 0px;
}

.search-bar-container :deep(.el-input__wrapper) {
    box-shadow: 0 0 0 1px var(--border-primary) inset !important;
}

.search-bar-container :deep(.el-input__wrapper.is-focus) {
    box-shadow: 0 0 0 1px var(--text-accent) inset !important;
}

.empty-state {
    display: flex;
    justify-content: center;
    align-items: center;
    height: calc(100vh - 200px);
}

.mcp-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 15px;
}

.mcp-card {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: 8px 16px 4px 16px;
    display: flex;
    flex-direction: column;
    transition: all 0.2s ease-in-out;
}

.mcp-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
    border-color: var(--border-accent);
}

.mcp-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.mcp-card-icon {
    flex-shrink: 0;
    background-color: var(--bg-tertiary);
}

.mcp-card-title-group {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.mcp-header-actions {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 4px;
}

.mcp-name {
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.mcp-provider {
    font-size: 12px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.mcp-active-toggle {
    margin-left: 4px;
}

.mcp-card-body {
    flex-grow: 1;
}

.mcp-description {
    font-size: 13px;
    color: var(--text-secondary);
    margin: 0;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    -webkit-line-clamp: 2;
    line-clamp: 2;
}

.mcp-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0px;
    margin-bottom: 0px;
    gap: 12px;
}

.mcp-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    flex-grow: 1;
    min-width: 0;
    margin-top: 0px;
    padding-top: 0px;
}

.persistent-btn-header {
    color: var(--text-tertiary);
    padding: 4px;
    height: 24px;
    width: 24px;
}

.persistent-btn-header:hover {
    color: var(--text-accent);
    background-color: var(--bg-tertiary);
}

.persistent-btn-header.is-persistent-active {
    color: #67C23A;
}

.persistent-btn-header.is-persistent-active:hover {
    background-color: rgba(103, 194, 58, 0.1);
}

.mcp-actions {
    display: flex;
    align-items: center;
    gap: 2px;
    flex-shrink: 0;
}

.action-btn-compact {
    padding: 6px;
    margin-left: 0 !important;
}

.mcp-actions .el-button {
    color: var(--text-tertiary);
}

.mcp-actions .el-button:hover {
    color: var(--text-accent);
    background-color: var(--bg-tertiary);
}

.bottom-actions-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 16px;
    padding: 12px 24px;
    background-color: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-top: 1px solid var(--border-primary);
    z-index: 20;
}

html.dark .bottom-actions-container {
    background-color: rgba(23, 24, 28, 0.7);
}

.bottom-actions-container .action-btn {
    flex-grow: 0;
    min-width: 180px;
    font-weight: 500;
}

.advanced-collapse {
    border-top: none;
    border-bottom: none;
    padding-left: 15px;
    padding-right: 15px;
    margin: 15px 0 0 0;
}

.advanced-collapse :deep(.el-collapse-item__header) {
    border-bottom: 1px solid var(--border-primary);
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    line-height: 1;
    height: 36px;
    background-color: transparent;
}

.advanced-collapse :deep(.el-collapse-item__header.is-active) {
    border-bottom-style: dashed;
}

.advanced-collapse :deep(.el-collapse-item__wrap) {
    border-bottom: none;
    padding-top: 20px;
    background-color: transparent;
}

.advanced-collapse :deep(.el-collapse-item__content) {
    padding-bottom: 0;
}

html.dark .advanced-collapse {
    background-color: var(--bg-primary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-primary);
}

html.dark .advanced-collapse :deep(.el-collapse-item__header) {
    border-bottom-color: var(--border-primary);
}

html.dark .advanced-collapse :deep(.el-collapse-item__header.is-active) {
    border-bottom-color: var(--border-accent);
}

html.dark .advanced-collapse :deep(.el-collapse-item__wrap) {
    background-color: transparent;
}

.mcp-dialog-scrollbar :deep(.el-scrollbar__view) {
    padding: 5px 20px 5px 5px;
}

.json-editor-scrollbar {
    border-radius: var(--el-input-border-radius, var(--el-border-radius-base));
    border: 1px solid var(--el-border-color);
    background-color: var(--el-fill-color-blank);
    transition: border-color .2s;
}

.json-editor-scrollbar:has(:focus-within) {
    border-color: var(--el-color-primary);
}

.json-editor-scrollbar :deep(.el-textarea__inner) {
    background-color: transparent;
    border: none;
    box-shadow: none !important;
    padding: 5px 11px;
    resize: none;
}

.item-scrollbar :deep(.el-textarea__inner:focus) {
    box-shadow: none !important;
}

.item-scrollbar :deep(.el-input__wrapper) {
    background-color: transparent !important;
    box-shadow: none !important;
}

.item-scrollbar :deep(.el-input__wrapper.is-focus) {
    box-shadow: none !important;
}

.refresh-fab-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 21;
    width: 24px;
    height: 24px;
    font-size: 16px;
    box-shadow: var(--el-box-shadow-light);
}

.item-scrollbar {
    width: 100%;
    border-radius: var(--el-input-border-radius, var(--el-border-radius-base));
    border: 1px solid var(--el-border-color);
    background-color: var(--el-fill-color-blank);
    transition: border-color .2s;
}

.item-scrollbar:has(:focus-within) {
    border-color: var(--el-color-primary);
}

.item-scrollbar :deep(.el-textarea__inner) {
    overflow: hidden;
    box-shadow: none !important;
    background-color: transparent !important;
    padding: 5px 11px;
}

.item-scrollbar :deep(.el-scrollbar__view) {
    padding-right: 2px;
}

.switches-container {
    display: flex;
    justify-content: space-around;
    align-items: flex-start;
    padding-top: 6px;
}

.compact-form-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 0;
}

.compact-form-item :deep(.el-form-item__label) {
    margin-bottom: 8px;
    line-height: 1;
    padding: 0 !important;
    display: flex;
    align-items: center;
}

.compact-form-item :deep(.el-form-item__content) {
    line-height: 1;
}

.test-dialog-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-right: 20px;
}

.header-left {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin-right: 10px;
    flex: 1;
}

.dialog-title {
    font-weight: 600;
    font-size: 16px;
    color: var(--text-primary);
}

.test-loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-secondary);
}

.test-loading-state .is-loading {
    animation-direction: reverse;
}

/* 2. æµ‹è¯•å†…å®¹ä¸»ä½“å®¹å™¨ (Flexå¸ƒå±€ï¼Œé™åˆ¶é«˜åº¦) */
.test-result-content {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* 3. Tabs å®¹å™¨ */
.tabs-wrapper {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    margin-top: 0px;
}

/* 4. Element Tabs æ ·å¼é‡ç½® */
.test-tabs {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.test-tabs :deep(.el-tabs__header) {
    flex-shrink: 0;
    margin-bottom: 0;
    order: 0 !important;
}

.test-tabs :deep(.el-tabs__nav-wrap) {
    padding: 0 10px;
}

/* å…³é”®ï¼šel-tabs__content å¿…é¡»æœ‰é«˜åº¦ä¸”ç¦æ­¢åŸç”Ÿæ»šåŠ¨ */
.test-tabs :deep(.el-tabs__content) {
    flex: 1;
    min-height: 0;
    height: 100%;
    /* ç¡®ä¿æ’‘æ»¡ */
    order: 1 !important;
    padding: 0;
    overflow: hidden !important;
}

/* Tab Pane å¿…é¡»ä¹Ÿæ˜¯ 100% é«˜åº¦ */
.test-tabs :deep(.el-tab-pane) {
    height: 100%;
    width: 100%;
}

/* 5. Tab å†…éƒ¨æ»šåŠ¨æ¡å®¹å™¨ */
.tab-inner-scrollbar {
    height: 100%;
    width: 100%;
}

.tab-inner-scrollbar :deep(.el-scrollbar__view) {
    padding: 15px 10px 20px 5px;
    min-height: 100%;
    display: flex;
    flex-direction: column;
}

/* 6. Tab å†…å®¹å¸ƒå±€ */
.tab-pane-content {
    display: flex;
    flex-direction: column;
    flex: 1;
}

/* Tab 1: å·¥å…·åˆ—è¡¨ */
.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-shrink: 0;
}

.cached-tag {
    height: 18px;
    line-height: 16px;
    font-size: 11px;
}

.hint-text {
    font-size: 12px;
    color: var(--text-tertiary);
}

.tools-compact-list {
    border: 1px solid var(--border-primary);
    border-radius: 6px;
    background-color: var(--bg-primary);
}

.tool-compact-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-primary);
    gap: 10px;
}

.tool-compact-item:last-child {
    border-bottom: none;
}

.tool-compact-name {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 13px;
    white-space: nowrap;
}

.tool-compact-desc {
    color: var(--text-secondary);
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
}

/* Tab 2: æµ‹è¯•è¡¨å• */
.test-form-area.no-border {
    border: none;
    padding: 0;
    background-color: transparent;
    display: flex;
    flex-direction: column;
}

.test-form-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    flex-shrink: 0;
}

.test-form-row .label {
    font-size: 13px;
    color: var(--text-secondary);
    white-space: nowrap;
}

.dynamic-form-container {
    padding-right: 8px;
    margin-bottom: 15px;
}

.no-params-text {
    font-size: 12px;
    color: var(--text-tertiary);
    text-align: center;
    padding: 8px 0;
    font-style: italic;
    border: 1px dashed var(--border-primary);
    /* å¯é€‰ï¼šåŠ ä¸ªè™šçº¿æ¡†è¡¨ç¤ºè¿™é‡Œæ˜¯å‚æ•°åŒº */
    border-radius: 4px;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.dynamic-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.dynamic-field:has(textarea) {
    grid-column: span 2;
}

.field-label {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
}

.required-star {
    color: #F56C6C;
    margin-right: 2px;
}

.info-icon {
    margin-left: 4px;
    cursor: help;
    font-size: 12px;
}

/* ç»“æœè¾“å‡ºæ¡† */
.test-output-box {
    margin-top: 10px;
    background-color: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    padding: 8px;
    /* ä¸å†é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œè®©å…¶è‡ªç„¶æ’‘å¼€é¡µé¢ä»è€Œè§¦å‘å¤–å±‚æ»šåŠ¨ */
    display: flex;
    flex-direction: column;
}

.output-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 4px;
    flex-shrink: 0;
}

.result-content-static pre {
    margin: 0;
    font-family: monospace;
    font-size: 12px;
    white-space: pre-wrap;
    word-break: break-all;
    color: var(--text-primary);
    max-height: 400px;
    overflow-y: auto;
}
</style>
```
```vue
./Anywhere_main/src/components/Prompts.vue
<script setup>
import { ref, reactive, computed, inject, watch, nextTick } from 'vue';
import { Plus, Delete, Close, ChatLineRound, UploadFilled, Position, QuestionFilled, Switch, Refresh, Edit, Download } from '@element-plus/icons-vue';
import { useI18n } from 'vue-i18n';
import { ElMessage } from 'element-plus';

const { t } = useI18n();

const currentConfig = inject('config');
const activeTabName = ref('__ALL_PROMPTS__');
const searchQueries = reactive({});
const tabsContainerRef = ref(null); // ç¡®ä¿ ref å·²å®šä¹‰

const openPromptWindow = (promptKey) => {
  window.api.coderedirect(promptKey);
};
watch(activeTabName, (newTabName) => {
  nextTick(() => {
    if (!tabsContainerRef.value) return;
    const scrollContainer = tabsContainerRef.value.$el.querySelector('.el-tabs__nav-wrap');
    if (!scrollContainer) return;
    const activeTabEl = scrollContainer.querySelector(`#tab-${newTabName}`);

    if (activeTabEl) {
      activeTabEl.scrollIntoView({
        behavior: 'smooth', // å¹³æ»‘æ»šåŠ¨
        inline: 'center',   // æ°´å¹³å±…ä¸­
        block: 'nearest'    // å‚ç›´æ–¹å‘ä¸Šä¿æŒæœ€è¿‘
      });
    } else if (newTabName === '__ALL_PROMPTS__') {
      scrollContainer.scrollTo({ left: 0, behavior: 'smooth' });
    }
  });
});


const activeTabPrompts = computed(() => {
  const tab = activeTabName.value;
  let prompts;
  if (tab === '__ALL_PROMPTS__') {
    prompts = allPrompts.value;
  } else {
    prompts = promptsInTag.value(tab);
  }
  return prompts.sort((a, b) => a.key.localeCompare(b.key));
});

const areAllPromptsEnabled = computed(() => {
  if (allPromptsCount.value === 0) return false;
  return allPrompts.value.every(p => p.enable);
});

function toggleAllPrompts(enableState) {
  atomicSave(config => {
    Object.keys(config.prompts).forEach(promptKey => {
      config.prompts[promptKey].enable = enableState;
    });
  }, true);
}

function getFilteredPrompts(prompts, query) {
  if (!query) {
    return prompts;
  }
  const lowerCaseQuery = query.toLowerCase();
  return prompts.filter(item =>
    (item.key && item.key.toLowerCase().includes(lowerCaseQuery)) ||
    (item.prompt && item.prompt.toLowerCase().includes(lowerCaseQuery))
  );
}

const showPromptEditDialog = ref(false);
const editingPrompt = reactive({
  originalKey: null,
  key: "",
  type: "general",
  prompt: "",
  showMode: "window",
  model: "",
  enable: true,
  selectedTag: [],
  icon: "",
  stream: true,
  isTemperature: false,
  temperature: 0.7,
  isDirectSend_file: false,
  isDirectSend_normal: true,
  ifTextNecessary: false,
  voice: '',
  reasoning_effort: "default",
  defaultMcpServers: [],
  window_width: 540,
  window_height: 700,
  isAlwaysOnTop: true,
  autoCloseOnBlur: true,
  matchRegex: "",
  backgroundImage: "",
  backgroundOpacity: 0.6,
  backgroundBlur: 0,
  autoSaveChat: false,
});

const showIconEditDialog = ref(false);
const iconEditorState = reactive({
  imgUrl: '',
  scale: 1,
  radius: 0, // 0 - 50 (%)
  offsetX: 0,
  offsetY: 0
});
const editorCanvasRef = ref(null);
let editorImageObj = null;
let isDraggingImage = false;
let lastMouseX = 0;
let lastMouseY = 0;

// å¤„ç†å›¾ç‰‡é€‰æ‹©/æ‹–æ‹½/ç²˜è´´å…¥å£
const processIconFile = (file) => {
  const isImage = file.type.startsWith('image/');
  if (!isImage) {
    ElMessage.error(t('prompts.alerts.invalidImageFormat', { formats: 'JPG, PNG, WEBP' }));
    return;
  }
  // æ­¤æ—¶ä¸é™åˆ¶å¤§å°ï¼Œå› ä¸ºä¼šåœ¨ç¼–è¾‘å™¨ä¸­å‹ç¼©è£å‰ª
  const reader = new FileReader();
  reader.onload = (e) => {
    openIconEditor(e.target.result);
  };
  reader.readAsDataURL(file);
};

// æ‰“å¼€ç¼–è¾‘å™¨
const openIconEditor = (dataUrl) => {
  iconEditorState.imgUrl = dataUrl;
  iconEditorState.scale = 1;
  iconEditorState.radius = 0;
  iconEditorState.offsetX = 0;
  iconEditorState.offsetY = 0;

  editorImageObj = new Image();
  editorImageObj.onload = () => {
    showIconEditDialog.value = true;
    nextTick(() => drawEditorCanvas());
  };
  editorImageObj.src = dataUrl;
};

// ç»˜åˆ¶ Canvas
const drawEditorCanvas = () => {
  const canvas = editorCanvasRef.value;
  if (!canvas || !editorImageObj) return;
  const ctx = canvas.getContext('2d');
  const size = 256; // è¾“å‡ºå°ºå¯¸å›ºå®šä¸º 256x256

  // æ¸…ç©º
  ctx.clearRect(0, 0, size, size);

  // 1. ç»˜åˆ¶åœ†è§’é®ç½©
  ctx.save();
  ctx.beginPath();
  const r = (iconEditorState.radius / 100) * size;
  ctx.roundRect(0, 0, size, size, r);
  ctx.clip();

  // 2. ç»˜åˆ¶å›¾ç‰‡ (åº”ç”¨ç¼©æ”¾å’Œåç§»)
  // è®¡ç®—å›¾ç‰‡ç»˜åˆ¶å°ºå¯¸ï¼ˆä¿æŒæ¯”ä¾‹è¦†ç›–å®¹å™¨ï¼‰
  const imgAspect = editorImageObj.width / editorImageObj.height;
  let drawW = size * iconEditorState.scale;
  let drawH = size * iconEditorState.scale;

  if (imgAspect > 1) {
    drawH = size * iconEditorState.scale;
    drawW = drawH * imgAspect;
  } else {
    drawW = size * iconEditorState.scale;
    drawH = drawW / imgAspect;
  }

  // å±…ä¸­ + åç§»
  const x = (size - drawW) / 2 + iconEditorState.offsetX;
  const y = (size - drawH) / 2 + iconEditorState.offsetY;

  ctx.drawImage(editorImageObj, x, y, drawW, drawH);
  ctx.restore();
};

// ä¿å­˜ç¼–è¾‘åçš„å›¾æ ‡
const saveEditedIcon = () => {
  const canvas = editorCanvasRef.value;
  if (canvas) {
    editingPrompt.icon = canvas.toDataURL('image/png');
    showIconEditDialog.value = false;
  }
};

// äº¤äº’äº‹ä»¶å¤„ç†
const handleIconUploadChange = (file) => {
  processIconFile(file); // ä½¿ç”¨æ–°é€»è¾‘
  return false; // é˜»æ­¢é»˜è®¤ä¸Šä¼ 
};

const handleIconDrop = (e) => {
  const file = e.dataTransfer.files[0];
  if (file) processIconFile(file);
};

const handleIconPaste = (e) => {
  const items = (e.clipboardData || e.originalEvent.clipboardData).items;
  for (let index in items) {
    const item = items[index];
    if (item.kind === 'file') {
      const blob = item.getAsFile();
      processIconFile(blob);
      return;
    }
  }
};

// Canvas æ‹–æ‹½å›¾ç‰‡é€»è¾‘
const handleCanvasMouseDown = (e) => {
  isDraggingImage = true;
  lastMouseX = e.clientX;
  lastMouseY = e.clientY;
};
const handleCanvasMouseMove = (e) => {
  if (!isDraggingImage) return;
  const dx = e.clientX - lastMouseX;
  const dy = e.clientY - lastMouseY;
  // ç”±äº Canvas æ˜¾ç¤ºå¤§å°å¯èƒ½è¢« CSS ç¼©æ”¾ï¼Œè¿™é‡Œç²—ç•¥æ˜ å°„
  iconEditorState.offsetX += dx;
  iconEditorState.offsetY += dy;
  lastMouseX = e.clientX;
  lastMouseY = e.clientY;
  drawEditorCanvas();
};
const handleCanvasMouseUp = () => { isDraggingImage = false; };
const handleCanvasWheel = (e) => {
  e.preventDefault();
  const delta = e.deltaY > 0 ? -0.1 : 0.1;
  let newScale = iconEditorState.scale + delta;
  if (newScale < 0.1) newScale = 0.1;
  if (newScale > 5) newScale = 5;
  iconEditorState.scale = newScale;
  drawEditorCanvas();
};

// ç›‘å¬å‚æ•°å˜åŒ–é‡ç»˜
watch(() => [iconEditorState.scale, iconEditorState.radius], () => {
  drawEditorCanvas();
});

const isNewPrompt = ref(false);

const showAddTagDialog = ref(false);
const newTagName = ref("");

const showAssignPromptDialog = ref(false);
const assignPromptForm = reactive({
  targetTagName: '',
  selectedPromptKeys: [],
});

// [æ–°å¢] æ›¿æ¢æ¨¡å‹å¼¹çª—çš„çŠ¶æ€
const showReplaceModelDialog = ref(false);
const replaceModelForm = reactive({
  sourceModel: null,
  targetModel: null,
});

const availableModels = computed(() => {
  const models = [];
  if (!currentConfig.value || !currentConfig.value.providers) return models;
  const providerOrder = currentConfig.value.providerOrder || [];
  providerOrder.forEach(providerId => {
    const provider = currentConfig.value.providers[providerId];
    if (provider && provider.enable && provider.modelList && provider.modelList.length > 0) {
      provider.modelList.forEach(modelName => {
        models.push({
          value: `${providerId}|${modelName}`,
          label: `${provider.name}|${modelName}`
        });
      });
    }
  });
  return models;
});

// è·å–å¯ç”¨çš„MCPæœåŠ¡åˆ—è¡¨
const availableMcpServers = computed(() => {
  if (!currentConfig.value || !currentConfig.value.mcpServers) return [];
  return Object.entries(currentConfig.value.mcpServers)
    .filter(([, server]) => server.isActive)
    .map(([id, server]) => ({
      value: id,
      label: server.name,
    }))
    .sort((a, b) => a.label.localeCompare(b.label)); // æ–°å¢æ­¤è¡Œä»¥æŒ‰åç§°æ’åº
});

// [æ–°å¢] è®¡ç®—æ‰€æœ‰å¿«æ·åŠ©æ‰‹ä¸­æ­£åœ¨ä½¿ç”¨çš„æ¨¡å‹åˆ—è¡¨ (ç”¨äºæ›¿æ¢æ¨¡å‹çš„æºæ¨¡å‹ä¸‹æ‹‰)
const usedModels = computed(() => {
  if (!currentConfig.value || !currentConfig.value.prompts) return [];
  const modelSet = new Set();
  Object.values(currentConfig.value.prompts).forEach(p => {
    if (p.model) {
      modelSet.add(p.model);
    }
  });
  return Array.from(modelSet).sort().map(modelValue => ({
    value: modelValue,
    label: availableModels.value.find(m => m.value === modelValue)?.label || modelValue
  }));
});

const availableVoices = computed(() => {
  const voices = currentConfig.value?.voiceList || [];
  return [
    { label: t('prompts.voiceOptions.off'), value: '' },
    ...voices.map(v => ({ label: v, value: v }))
  ];
});

const allPrompts = computed(() => {
  if (!currentConfig.value.prompts) return [];
  return Object.entries(currentConfig.value.prompts).map(([key, value]) => ({ key, ...value }));
});

const allPromptsCount = computed(() => allPrompts.value.length);

const allEnabledPromptsCount = computed(() => {
  if (!currentConfig.value.prompts) return 0;
  return Object.values(currentConfig.value.prompts).filter(p => p.enable).length;
});

const tagEabledPromptsCount = computed(() => (tagName) => {
  if (!currentConfig.value.tags || !currentConfig.value.tags[tagName]) return 0;
  return currentConfig.value.tags[tagName].reduce((count, promptKey) => {
    if (currentConfig.value.prompts[promptKey] && currentConfig.value.prompts[promptKey].enable) {
      count++;
    }
    return count;
  }, 0);
});

const sortedTagNames = computed(() => {
  if (!currentConfig.value.tags) return [];
  return Object.keys(currentConfig.value.tags).sort((a, b) => a.localeCompare(b));
});

const promptsInTag = computed(() => (tagName) => {
  if (!currentConfig.value.prompts || !currentConfig.value.tags || !currentConfig.value.tags[tagName]) {
    return [];
  }
  return currentConfig.value.tags[tagName]
    .map(promptKey => ({
      key: promptKey,
      ...(currentConfig.value.prompts[promptKey] || {})
    }))
    .filter(p => p.key && currentConfig.value.prompts[p.key]);
});

const promptsAvailableToAssign = computed(() => (tagName) => {
  if (!tagName || !currentConfig.value.prompts) return [];
  const promptsInCurrentTag = new Set(currentConfig.value.tags[tagName] || []);
  return Object.keys(currentConfig.value.prompts)
    .filter(key => !promptsInCurrentTag.has(key))
    .map(key => ({ key, label: key, data: currentConfig.value.prompts[key] }));
});

async function atomicSave(updateFunction, syncFeatures = false) {
  try {
    const latestConfigData = await window.api.getConfig();
    if (!latestConfigData || !latestConfigData.config) {
      throw new Error("Failed to get latest config from DB.");
    }
    const latestConfig = latestConfigData.config;

    updateFunction(latestConfig);

    const configToSave = { config: latestConfig };

    if (syncFeatures) {
      await window.api.updateConfig(configToSave);
    } else {
      await window.api.updateConfigWithoutFeatures(configToSave);
    }

    currentConfig.value = latestConfig;

  } catch (error) {
    console.error("Atomic save failed:", error);
    ElMessage.error(t('prompts.alerts.saveFailed'));
  }
}

function prepareAddTag() {
  newTagName.value = "";
  showAddTagDialog.value = true;
}

function addTag() {
  const tagName = newTagName.value.trim();
  if (!tagName) {
    ElMessage.warning(t('prompts.alerts.tagNameEmpty')); return;
  }
  if (currentConfig.value.tags[tagName]) {
    ElMessage.warning(t('prompts.alerts.tagExists', { tagName })); return;
  }

  atomicSave(config => {
    config.tags[tagName] = [];
    // åˆ‡æ¢åˆ°æ–°åˆ›å»ºçš„æ ‡ç­¾
    activeTabName.value = tagName;
  });

  showAddTagDialog.value = false;
}

function deleteTag(tagName) {
  atomicSave(config => {
    delete config.tags[tagName];
    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ´»åŠ¨æ ‡ç­¾ï¼Œåˆ™åˆ‡æ¢åˆ°â€œå…¨éƒ¨â€æ ‡ç­¾
    if (activeTabName.value === tagName) {
      activeTabName.value = '__ALL_PROMPTS__';
    }
  });
}
function toggleAllPromptsInTag(tagName, enableState) {
  atomicSave(config => {
    if (!config.tags[tagName]) return;
    config.tags[tagName].forEach(promptKey => {
      if (config.prompts[promptKey]) {
        config.prompts[promptKey].enable = enableState;
      }
    });
  }, true);
}

function areAllPromptsInTagEnabled(tagName) {
  if (!currentConfig.value.tags[tagName] || currentConfig.value.tags[tagName].length === 0) {
    return false;
  }
  return currentConfig.value.tags[tagName].every(promptKey =>
    currentConfig.value.prompts[promptKey] && currentConfig.value.prompts[promptKey].enable
  );
}

function prepareAddPrompt() {
  isNewPrompt.value = true;
  Object.assign(editingPrompt, {
    originalKey: null, key: "", type: "general", prompt: "", showMode: "window", model: "",
    enable: true, selectedTag: [], icon: "", stream: true, isTemperature: false, temperature: 0.7,
    isDirectSend_file: false, isDirectSend_normal: true, ifTextNecessary: false,
    voice: '', reasoning_effort: "default", defaultMcpServers: [],
    window_width: 540, window_height: 700,
    position_x: 0, position_y: 0,
    isAlwaysOnTop: currentConfig.value.isAlwaysOnTop_global,
    autoCloseOnBlur: currentConfig.value.autoCloseOnBlur_global,
    matchRegex: "",
    backgroundImage: "",
    backgroundOpacity: 0.6,
    backgroundBlur: 0,
    autoSaveChat: currentConfig.value.autoSaveChat_global ?? false,
  });
  showPromptEditDialog.value = true;
}

async function prepareEditPrompt(promptKey, currentTagName = null) {
  isNewPrompt.value = false;

  try {
    // [MODIFIED] ä½¿ç”¨ await ç­‰å¾…å¼‚æ­¥çš„ getConfig
    const latestConfigData = await window.api.getConfig();
    if (latestConfigData && latestConfigData.config) {
      currentConfig.value = latestConfigData.config;
    } else {
      throw new Error("Failed to fetch latest config.");
    }
  } catch (error) {
    console.error("Failed to refresh config before editing prompt:", error);
    ElMessage.error(t('prompts.alerts.configFetchFailed'));
  }

  const p = currentConfig.value.prompts[promptKey];
  if (!p) {
    ElMessage.error(t('prompts.alerts.promptNotFound'));
    return;
  }

  const belongingTags = Object.entries(currentConfig.value.tags || {})
    .filter(([, promptKeys]) => promptKeys.includes(promptKey))
    .map(([tagName]) => tagName);

  Object.assign(editingPrompt, {
    originalKey: promptKey, key: promptKey, type: p.type, prompt: p.prompt,
    showMode: p.showMode, model: p.model, enable: p.enable, icon: p.icon || "",
    selectedTag: belongingTags,
    stream: p.stream ?? true, isTemperature: p.isTemperature ?? false,
    temperature: p.temperature ?? 0.7, isDirectSend_file: p.isDirectSend_file ?? false,
    isDirectSend_normal: p.isDirectSend_normal ?? true, ifTextNecessary: p.ifTextNecessary ?? false,
    voice: p.voice ?? '', reasoning_effort: p.reasoning_effort ?? "default",
    defaultMcpServers: p.defaultMcpServers ?? [],
    window_width: p.window_width ?? 540, window_height: p.window_height ?? 700,
    isAlwaysOnTop: p.isAlwaysOnTop ?? true, autoCloseOnBlur: p.autoCloseOnBlur ?? true,
    matchRegex: p.matchRegex || "",
    backgroundImage: p.backgroundImage || "",
    backgroundOpacity: p.backgroundOpacity ?? 0.6,
    backgroundBlur: p.backgroundBlur ?? 0,
    autoSaveChat: p.autoSaveChat ?? false,
  });
  showPromptEditDialog.value = true;
}

function savePrompt() {
  const newKey = editingPrompt.key.trim();
  const oldKey = editingPrompt.originalKey;
  if (!newKey) { ElMessage.warning(t('prompts.alerts.promptKeyEmpty')); return; }

  atomicSave(config => {
    if (newKey !== oldKey && config.prompts[newKey]) {
      ElMessage.warning(t('prompts.alerts.promptKeyExists', { newKey }));
      throw new Error("Prompt key exists");
    }

    const promptData = {
      type: editingPrompt.type, prompt: editingPrompt.prompt, showMode: editingPrompt.showMode,
      model: editingPrompt.model, enable: editingPrompt.enable, icon: editingPrompt.icon || "",
      stream: editingPrompt.stream, isTemperature: editingPrompt.isTemperature,
      temperature: editingPrompt.temperature, isDirectSend_file: editingPrompt.isDirectSend_file,
      isDirectSend_normal: editingPrompt.isDirectSend_normal, ifTextNecessary: editingPrompt.ifTextNecessary,
      voice: editingPrompt.voice, reasoning_effort: editingPrompt.reasoning_effort,
      defaultMcpServers: editingPrompt.defaultMcpServers,
      window_width: editingPrompt.window_width, window_height: editingPrompt.window_height,
      isAlwaysOnTop: editingPrompt.isAlwaysOnTop, autoCloseOnBlur: editingPrompt.autoCloseOnBlur,
      matchRegex: editingPrompt.matchRegex,
      backgroundImage: editingPrompt.backgroundImage,
      backgroundOpacity: editingPrompt.backgroundOpacity,
      backgroundBlur: editingPrompt.backgroundBlur,
      autoSaveChat: editingPrompt.autoSaveChat,
    };

    // 1. æ›´æ–°æˆ–åˆ›å»º prompts å¯¹è±¡ä¸­çš„æ¡ç›®
    if (isNewPrompt.value) {
      promptData.position_x = 0; promptData.position_y = 0;
      config.prompts[newKey] = promptData;
    } else {
      const existingPrompt = config.prompts[oldKey] || {};
      promptData.position_x = existingPrompt.position_x || 0;
      promptData.position_y = existingPrompt.position_y || 0;

      // å¦‚æœé”®å·²æ›´æ”¹ï¼Œåˆ™éœ€è¦é‡å‘½å
      if (newKey !== oldKey) {
        config.prompts[newKey] = { ...existingPrompt, ...promptData };
        delete config.prompts[oldKey];
      } else {
        config.prompts[newKey] = { ...config.prompts[newKey], ...promptData };
      }
    }

    // 2. æ›´æ–°æ ‡ç­¾
    const keyToUseForTags = isNewPrompt.value ? newKey : oldKey;
    const oldTags = Object.keys(config.tags).filter(tagName => config.tags[tagName].includes(keyToUseForTags));
    const newTags = editingPrompt.selectedTag;

    // ä»ä¸å†åŒ…å«æ­¤å¿«æ·åŠ©æ‰‹çš„æ ‡ç­¾ä¸­ç§»é™¤
    oldTags.forEach(tagName => {
      if (!newTags.includes(tagName)) {
        config.tags[tagName] = config.tags[tagName].filter(pk => pk !== keyToUseForTags);
      }
    });

    // æ·»åŠ åˆ°æ–°çš„æ ‡ç­¾ä¸­
    newTags.forEach(tagName => {
      if (!config.tags[tagName]) config.tags[tagName] = [];
      if (!config.tags[tagName].includes(keyToUseForTags)) {
        config.tags[tagName].push(keyToUseForTags);
      }
    });

    // å¦‚æœ prompt key è¢«é‡å‘½åï¼Œæ›´æ–°æ‰€æœ‰æ ‡ç­¾ä¸­çš„å¼•ç”¨
    if (!isNewPrompt.value && newKey !== oldKey) {
      Object.keys(config.tags).forEach(tagName => {
        const index = config.tags[tagName].indexOf(oldKey);
        if (index > -1) {
          config.tags[tagName][index] = newKey;
        }
      });
    }

  }, true);

  showPromptEditDialog.value = false;
}

function deletePrompt(promptKeyToDelete) {
  atomicSave(config => {
    if (!config.prompts[promptKeyToDelete]) return;
    delete config.prompts[promptKeyToDelete];
    Object.keys(config.tags).forEach(tagName => {
      config.tags[tagName] = config.tags[tagName].filter(pk => pk !== promptKeyToDelete);
    });
  }, true);
}

function removePromptFromTag(tagName, promptKey) {
  atomicSave(config => {
    if (config.tags[tagName]) {
      config.tags[tagName] = config.tags[tagName].filter(pk => pk !== promptKey);
    }
  });
}

function changePromptOrderInTag(tagName, promptKey, direction) {
  atomicSave(config => {
    const tagPrompts = config.tags[tagName];
    if (!tagPrompts) return;
    const currentIndex = tagPrompts.indexOf(promptKey);

    if (direction === 'left' && currentIndex > 0) {
      [tagPrompts[currentIndex], tagPrompts[currentIndex - 1]] = [tagPrompts[currentIndex - 1], tagPrompts[currentIndex]];
    } else if (direction === 'right' && currentIndex < tagPrompts.length - 1) {
      [tagPrompts[currentIndex], tagPrompts[currentIndex + 1]] = [tagPrompts[currentIndex + 1], tagPrompts[currentIndex]];
    }
  });
}

async function handlePromptEnableChange(promptKey, value) {
  try {
    await window.api.saveSetting(`prompts.${promptKey}.enable`, value);
    atomicSave(config => { }, true);
  } catch (e) {
    ElMessage.error(t('prompts.alerts.saveSettingFailed'));
    currentConfig.value.prompts[promptKey].enable = !value;
  }
}

const isFirstInTag = (tagName, promptKey) => {
  const prompts = currentConfig.value.tags[tagName];
  return prompts && prompts.indexOf(promptKey) === 0;
};
const isLastInTag = (tagName, promptKey) => {
  const prompts = currentConfig.value.tags[tagName];
  return prompts && prompts.indexOf(promptKey) === prompts.length - 1;
};

function openAssignPromptDialog(tagName) {
  assignPromptForm.targetTagName = tagName;
  assignPromptForm.selectedPromptKeys = [];
  showAssignPromptDialog.value = true;
}

function assignSelectedPromptsToTag() {
  const tagName = assignPromptForm.targetTagName;
  atomicSave(config => {
    if (!tagName || !config.tags[tagName]) {
      ElMessage.warning(t('prompts.alerts.targetTagNotFound'));
      return;
    }
    assignPromptForm.selectedPromptKeys.forEach(promptKey => {
      if (!config.tags[tagName].includes(promptKey)) {
        config.tags[tagName].push(promptKey);
      }
    });
  });
  showAssignPromptDialog.value = false;
}

function formatDescription(text) {
  if (!text) return '';
  const singleLineText = text.replace(/\n/g, ' ').trim();
  const maxLength = 110;
  if (singleLineText.length > maxLength) {
    return singleLineText.substring(0, maxLength) + '...';
  }
  return singleLineText;
}

const handleIconUpload = (file) => {
  const isImage = file.type.startsWith('image/');
  if (!isImage) {
    ElMessage.error(t('prompts.alerts.invalidImageFormat', { formats: 'JPG, PNG' }));
    return false;
  }
  const isLt = file.size < 102400;
  if (!isLt) {
    ElMessage.error(t('prompts.alerts.imageSizeTooLarge', { maxSize: '100KB' }));
    return false;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    editingPrompt.icon = e.target.result;
  };
  reader.readAsDataURL(file);
  return false;
};

const removeEditingIcon = () => { editingPrompt.icon = ""; };

const downloadEditingIcon = () => {
  if (!editingPrompt.icon) { ElMessage.warning(t('prompts.alerts.noIconToDownload')); return; }
  const link = document.createElement('a');
  link.href = editingPrompt.icon;
  const matches = editingPrompt.icon.match(/^data:image\/([a-zA-Z+]+);base64,/);
  const extension = matches && matches[1] ? matches[1].replace('svg+xml', 'svg') : 'png';
  link.download = `icon.${extension}`;
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
};

// æ‰“å¼€æ›¿æ¢æ¨¡å‹å¼¹çª—çš„å‡½æ•°
function prepareReplaceModels() {
  replaceModelForm.sourceModel = null;
  replaceModelForm.targetModel = null;
  showReplaceModelDialog.value = true;
}

// å°†å‡½æ•°æ”¹ä¸º async å¹¶ä½¿ç”¨ await
async function replaceModels() {
  const { sourceModel, targetModel } = replaceModelForm;
  if (!sourceModel || !targetModel) {
    ElMessage.warning(t('prompts.alerts.selectModels'));
    return;
  }
  if (sourceModel === targetModel) {
    ElMessage.warning(t('prompts.alerts.sameModels'));
    return;
  }

  let updatedCount = 0;
  // ä½¿ç”¨ await ç­‰å¾… atomicSave å®Œæˆ
  await atomicSave(config => {
    Object.values(config.prompts).forEach(prompt => {
      if (prompt.model === sourceModel) {
        prompt.model = targetModel;
        updatedCount++;
      }
    });
  }, true);

  ElMessage.success(t('prompts.alerts.modelsReplacedSuccess', { count: updatedCount }));
  showReplaceModelDialog.value = false;
}

// åˆ·æ–°é…ç½®å‡½æ•°
async function refreshPromptsConfig() {
  try {
    const latestConfigData = await window.api.getConfig();
    if (latestConfigData && latestConfigData.config) {
      currentConfig.value = latestConfigData.config;
      ElMessage.success(t('prompts.alerts.refreshSuccess'));
    } else {
      throw new Error(t('prompts.alerts.configInvalid'));
    }
  } catch (error) {
    console.error("åˆ·æ–°é…ç½®å¤±è´¥:", error);
    ElMessage.error(t('prompts.alerts.refreshFailed'));
  }
}
</script>

<template>
  <div class="page-container">
    <div class="prompts-header">
      <div class="custom-all-tab" :class="{ 'is-active': activeTabName === '__ALL_PROMPTS__' }"
        @click="activeTabName = '__ALL_PROMPTS__'">
        <div class="tab-label-multiline">
          <span class="tab-name">{{ t('prompts.allPrompts') }}</span>
          <span class="tab-count">({{ allEnabledPromptsCount }} / {{ allPromptsCount }})</span>
        </div>
      </div>

      <el-tabs v-model="activeTabName" ref="tabsContainerRef" class="tags-tabs-container">
        <el-tab-pane v-for="tagName in sortedTagNames" :key="tagName" :name="tagName">
          <template #label>
            <div class="tab-label-multiline">
              <span class="tab-name">{{ tagName }}</span>
              <span class="tab-count">({{ tagEabledPromptsCount(tagName) }} / {{ currentConfig.tags[tagName]?.length ||
                0 }})</span>
            </div>
          </template>
        </el-tab-pane>
      </el-tabs>

      <!-- å³ä¾§æ“ä½œæŒ‰é’®åŒºåŸŸï¼Œé¡ºåºå’Œç¦ç”¨é€»è¾‘å·²è°ƒæ•´ -->
      <div class="tab-actions">
        <el-tooltip v-if="activeTabName === '__ALL_PROMPTS__'"
          :content="areAllPromptsEnabled ? t('prompts.disableAll') : t('prompts.enableAll')">
          <el-switch :model-value="areAllPromptsEnabled" @change="(value) => toggleAllPrompts(value)"
            class="tag-enable-toggle" />
        </el-tooltip>
        <el-tooltip v-else
          :content="areAllPromptsInTagEnabled(activeTabName) ? t('prompts.disableAll') : t('prompts.enableAll')">
          <el-switch :model-value="areAllPromptsInTagEnabled(activeTabName)"
            @change="(value) => toggleAllPromptsInTag(activeTabName, value)" class="tag-enable-toggle"
            :disabled="!currentConfig.tags[activeTabName] || currentConfig.tags[activeTabName].length === 0" />
        </el-tooltip>

        <el-tooltip :content="t('prompts.addExistingPrompt')" placement="top">
          <el-button class="add-existing-prompt-btn" plain size="small" :icon="Plus" circle
            @click="openAssignPromptDialog(activeTabName)"
            :disabled="activeTabName === '__ALL_PROMPTS__' || !promptsAvailableToAssign(activeTabName) || promptsAvailableToAssign(activeTabName).length === 0" />
        </el-tooltip>

        <el-button type="danger" :icon="Delete" circle plain size="small" @click.stop="deleteTag(activeTabName)"
          class="delete-tag-btn" :disabled="activeTabName === '__ALL_PROMPTS__'" />
      </div>
    </div>

    <el-scrollbar class="main-content-scrollbar">
      <div class="content-wrapper">
        <div class="search-input-container">
          <el-input v-model="searchQueries[activeTabName]" :placeholder="t('prompts.searchPlaceholder')" clearable />
        </div>
        <div class="prompts-grid-container">
          <div v-if="!activeTabPrompts.length" class="empty-tag-message">
            <el-text type="info" size="small">{{ activeTabName === '__ALL_PROMPTS__' ? t('prompts.noPrompts') :
              t('prompts.noPromptsInTag') }}</el-text>
          </div>
          <div v-for="item in getFilteredPrompts(activeTabPrompts, searchQueries[activeTabName])" :key="item.key"
            class="prompt-card">
            <div class="prompt-card-header">
              <el-avatar v-if="item.icon" :src="item.icon" shape="square" :size="28" class="prompt-card-icon" />
              <el-icon v-else :size="28" class="prompt-card-icon-default">
                <Position />
              </el-icon>
              <el-tooltip :content="item.key" placement="top">
                <span class="prompt-name" @click="prepareEditPrompt(item.key, activeTabName)">{{ item.key }}</span>
              </el-tooltip>
              <el-tooltip v-if="item.showMode === 'window' && item.enable" :content="t('prompts.openWindow')"
                placement="top">
                <el-button :icon="ChatLineRound" circle text @click.stop="openPromptWindow(item.key)"
                  class="open-prompt-btn" />
              </el-tooltip>
              <div class="prompt-card-tag-actions">
                <el-switch v-model="item.enable" @change="(value) => handlePromptEnableChange(item.key, value)"
                  size="small" class="prompt-enable-toggle" />
                <el-button v-if="activeTabName !== '__ALL_PROMPTS__'" type="danger" :icon="Close" circle plain
                  size="small" @click="removePromptFromTag(activeTabName, item.key)"
                  :title="t('prompts.tooltips.removeFromTag')" />
                <el-button v-else type="danger" :icon="Delete" circle plain size="small" @click="deletePrompt(item.key)"
                  :title="t('prompts.deletePrompt')" />
              </div>
            </div>
            <div class="prompt-description-container" @click="prepareEditPrompt(item.key, activeTabName)"
              v-html="formatDescription(item.prompt)"></div>
          </div>
        </div>
      </div>
    </el-scrollbar>

    <div class="bottom-actions-container">
      <el-button class="action-btn" @click="prepareAddPrompt" :icon="Plus" type="primary">
        {{ t('prompts.addNewPrompt') }}
      </el-button>
      <el-button class="action-btn" @click="prepareAddTag" :icon="Plus">
        {{ t('prompts.addNewTag') }}
      </el-button>
      <el-button class="action-btn" @click="prepareReplaceModels" :icon="Switch">
        {{ t('prompts.replaceModels') }}
      </el-button>
      <el-button class="refresh-fab-button" :icon="Refresh" type="primary" circle @click="refreshPromptsConfig" />
    </div>

    <el-dialog v-model="showPromptEditDialog" :title="isNewPrompt ? t('prompts.addNewPrompt') : t('prompts.editPrompt')"
      width="700px" :close-on-click-modal="false" top="5vh" custom-class="edit-prompt-dialog">
      <el-scrollbar max-height="60vh" class="prompt-dialog-scrollbar">
        <el-form :model="editingPrompt" @submit.prevent="savePrompt" class="edit-prompt-form">
          <div class="top-section-grid">
            <div class="icon-area">
              <div class="icon-editor-area" @paste="handleIconPaste" tabindex="0" style="outline: none;">
                <el-upload class="icon-uploader" action="#" drag :show-file-list="false"
                  :before-upload="handleIconUploadChange" accept="image/png, image/jpeg, image/webp"
                  @drop.prevent="handleIconDrop" @dragover.prevent>
                  <template v-if="editingPrompt.icon">
                    <el-avatar :src="editingPrompt.icon" shape="square" :size="64" class="uploaded-icon-avatar" />
                    <div class="icon-hover-mask" @click.stop.prevent="openIconEditor(editingPrompt.icon)">
                      <el-icon>
                        <Edit />
                      </el-icon>
                    </div>
                  </template>
                  <template v-else>
                    <div class="icon-uploader-placeholder">
                      <el-icon :size="20">
                        <UploadFilled />
                      </el-icon>
                      <div class="icon-upload-text"
                        style="font-size: 10px; margin-top: 4px; color: var(--text-tertiary); line-height: 1.2; white-space: pre-line;">
                        {{ t('prompts.icon.uploadText') }}
                      </div>
                    </div>
                  </template>
                </el-upload>

                <div class="icon-button-group">
                  <el-button class="icon-action-button" size="small" @click="downloadEditingIcon"
                    :title="t('prompts.icon.downloadTooltip')">
                    <el-icon>
                      <Download />
                    </el-icon>
                  </el-button>
                  <el-button class="icon-action-button" size="small" @click="removeEditingIcon"
                    :title="t('prompts.icon.removeTooltip')">
                    <el-icon>
                      <Delete />
                    </el-icon>
                  </el-button>
                </div>
              </div>
            </div>
            <div class="form-fields-area">
              <div class="form-grid">
                <label for="promptName" class="el-form-item__label">{{ t('prompts.promptKeyLabelShort', 'åç§°') }}</label>
                <el-form-item prop="key" class="grid-item no-margin">
                  <el-input id="promptName" v-model="editingPrompt.key" />
                </el-form-item>
                <div class="enable-switch-group">
                  <label class="el-form-item__label">{{ t('prompts.enabledLabel') }}</label>
                  <el-switch v-model="editingPrompt.enable" />
                </div>

                <div style="grid-column: 1 / 4;">
                  <el-row :gutter="12">
                    <el-col :span="12">
                      <el-form-item :label="t('prompts.typeLabel')">
                        <el-select v-model="editingPrompt.type" style="width: 100%;">
                          <el-option :label="t('prompts.typeOptions.general')" value="general" />
                          <el-option :label="t('prompts.typeOptions.text')" value="over" />
                          <el-option :label="t('prompts.typeOptions.image')" value="img" />
                          <el-option :label="t('prompts.typeOptions.files')" value="files" />
                        </el-select>
                      </el-form-item>
                    </el-col>
                    <el-col :span="12">
                      <el-form-item :label="t('prompts.showModeLabel')">
                        <el-select v-model="editingPrompt.showMode" style="width: 100%;">
                          <el-option :label="t('prompts.showModeOptions.fastinput')" value="fastinput" />
                          <el-option :label="t('prompts.showModeOptions.window')" value="window" />
                        </el-select>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-form-item v-if="editingPrompt.type === 'over'" class="regex-form-item">
                    <template #label>
                      <span>{{ t('prompts.regex.label') }}</span>
                      <el-tooltip placement="right" raw-content>
                        <template #content>
                          <div style="max-width: 350px; line-height: 1.6;" v-html="t('prompts.regex.tooltip')
                            .replace(/(\d+\.\s)/g, '<br/>$1')
                            .replace(/(â€¢)/g, '<br/>&nbsp;&nbsp;$1')
                            .replace(/(å¸¸ç”¨ç¬¦å·é€ŸæŸ¥:|Quick Reference:)/g, '<br/><br/><b>$1</b>')">
                          </div>
                        </template>
                        <el-icon class="tip-icon" style="margin-left: 4px;">
                          <QuestionFilled />
                        </el-icon>
                      </el-tooltip>
                    </template>
                    <el-input v-model="editingPrompt.matchRegex" :placeholder="t('prompts.regex.placeholder')" />
                  </el-form-item>
                </div>

                <label class="el-form-item__label">{{ t('prompts.modelLabel') }}</label>
                <el-form-item class="grid-item full-width no-margin">
                  <el-select v-model="editingPrompt.model" filterable clearable style="width: 100%;">
                    <el-option v-for="item in availableModels" :key="item.value" :label="item.label"
                      :value="item.value" />
                  </el-select>
                </el-form-item>
              </div>
            </div>
          </div>

          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item :label="t('prompts.promptContentLabel')" label-position="top">
                <el-scrollbar max-height="150px" class="prompt-textarea-scrollbar">
                  <el-input v-model="editingPrompt.prompt" type="textarea" :autosize="{ minRows: 6 }" resize="none"
                    :placeholder="t('prompts.inputPlaceholder')" />
                </el-scrollbar>
              </el-form-item>
              <el-form-item label-position="top">
                <template #label>
                  <div>
                    {{ t('prompts.llmParametersLabel') }}
                    <div class="form-item-subtitle">{{ t('prompts.llmParametersRemark', 'ï¼ˆä»…å½“å‰å¿«æ·åŠ©æ‰‹æ¨¡å‹ç”Ÿæ•ˆï¼Œæ›´æ¢å…¶ä»–æ¨¡å‹åä¸å†ç”Ÿæ•ˆï¼‰') }}
                    </div>
                  </div>
                </template>
                <div class="llm-params-container">
                  <div class="param-item"
                    v-if="editingPrompt.showMode === 'window' || editingPrompt.showMode === 'fastinput'">
                    <span class="param-label">{{ t('prompts.streamLabel') }}</span>
                    <div class="spacer"></div>
                    <el-switch v-model="editingPrompt.stream" />
                  </div>
                  <div class="param-item">
                    <span class="param-label">{{ t('prompts.enableTemperatureLabel') }}</span>
                    <div class="spacer"></div>
                    <el-switch v-model="editingPrompt.isTemperature" />
                  </div>
                  <div class="param-item reasoning-effort-param">
                    <span class="param-label">{{ t('prompts.reasoningEffortLabel') }}</span>
                    <el-tooltip :content="t('prompts.tooltips.reasoningEffort')" placement="top"><el-icon
                        class="tip-icon">
                        <QuestionFilled />
                      </el-icon></el-tooltip>
                    <div class="spacer"></div>
                    <el-select v-model="editingPrompt.reasoning_effort" size="small" style="width: 120px;">
                      <el-option :label="t('prompts.reasoningEffort.default')" value="default" />
                      <el-option :label="t('prompts.reasoningEffort.low')" value="low" />
                      <el-option :label="t('prompts.reasoningEffort.medium')" value="medium" />
                      <el-option :label="t('prompts.reasoningEffort.high')" value="high" />
                    </el-select>
                  </div>
                </div>
              </el-form-item>
              <el-form-item v-if="editingPrompt.isTemperature" :label="t('prompts.temperatureLabel')"
                label-position="top" class="slider-form-item">
                <el-slider v-model="editingPrompt.temperature" :min="0" :max="2" :step="0.1" show-input />
              </el-form-item>
            </el-col>

            <el-col :span="12">
              <el-form-item :label="t('prompts.AssistantParametersLabel')" label-position="top">
                <div class="llm-params-container full-height">
                  <div class="param-item">
                    <span class="param-label">{{ t('prompts.sendDirectLabel') }}</span>
                    <el-tooltip :content="t('prompts.tooltips.sendDirect')" placement="top"><el-icon class="tip-icon">
                        <QuestionFilled />
                      </el-icon></el-tooltip>
                    <div class="spacer"></div>
                    <el-switch v-model="editingPrompt.isDirectSend_normal" />
                  </div>
                  <div class="param-item">
                    <span class="param-label">{{ t('prompts.sendFileLabel') }}</span>
                    <el-tooltip :content="t('prompts.tooltips.sendFile')" placement="top"><el-icon class="tip-icon">
                        <QuestionFilled />
                      </el-icon></el-tooltip>
                    <div class="spacer"></div>
                    <el-switch v-model="editingPrompt.isDirectSend_file" />
                  </div>
                  <div class="param-item">
                    <span class="param-label">{{ t('prompts.ifTextNecessary') }}</span>
                    <el-tooltip :content="t('prompts.tooltips.ifTextNecessary')" placement="top"><el-icon
                        class="tip-icon">
                        <QuestionFilled />
                      </el-icon></el-tooltip>
                    <div class="spacer"></div>
                    <el-switch v-model="editingPrompt.ifTextNecessary" />
                  </div>
                  <div v-if="editingPrompt.showMode === 'window'" class="param-item">
                    <span class="param-label">{{ t('prompts.isAlwaysOnTopLabel') }}</span>
                    <el-tooltip :content="t('prompts.tooltips.isAlwaysOnTopTooltip')" placement="top"><el-icon
                        class="tip-icon">
                        <QuestionFilled />
                      </el-icon></el-tooltip>
                    <div class="spacer"></div>
                    <el-switch v-model="editingPrompt.isAlwaysOnTop" />
                  </div>
                  <div v-if="editingPrompt.showMode === 'window'" class="param-item">
                    <span class="param-label">{{ t('prompts.autoCloseOnBlurLabel') }}</span>
                    <el-tooltip :content="t('prompts.tooltips.autoCloseOnBlurTooltip')" placement="top"><el-icon
                        class="tip-icon">
                        <QuestionFilled />
                      </el-icon></el-tooltip>
                    <div class="spacer"></div>
                    <el-switch v-model="editingPrompt.autoCloseOnBlur" />
                  </div>
                  <div v-if="editingPrompt.showMode === 'window'" class="param-item">
                    <span class="param-label">{{ t('prompts.autoSaveChatLabel') }}</span>
                    <el-tooltip :content="t('prompts.tooltips.autoSaveChatTooltip')" placement="top"><el-icon
                        class="tip-icon">
                        <QuestionFilled />
                      </el-icon></el-tooltip>
                    <div class="spacer"></div>
                    <el-switch v-model="editingPrompt.autoSaveChat" />
                  </div>

                  <div class="param-item voice-param">
                    <span class="param-label">{{ t('prompts.voiceLabel') }}</span>
                    <el-tooltip :content="t('prompts.voiceTooltip')" placement="top"><el-icon class="tip-icon">
                        <QuestionFilled />
                      </el-icon></el-tooltip>
                    <div class="spacer"></div>
                    <el-select v-model="editingPrompt.voice" :placeholder="t('prompts.voicePlaceholder')" clearable
                      size="small" style="width: 120px;">
                      <el-option v-for="item in availableVoices" :key="item.value" :label="item.label"
                        :value="item.value" />
                    </el-select>
                  </div>
                  <div v-if="editingPrompt.showMode === 'window'" class="param-item">
                    <span class="param-label">{{ t('prompts.defaultMcpServersLabel') }}</span>
                    <el-tooltip :content="t('prompts.tooltips.defaultMcpServers')" placement="top"><el-icon
                        class="tip-icon">
                        <QuestionFilled />
                      </el-icon></el-tooltip>
                    <div class="spacer"></div>
                    <el-select v-model="editingPrompt.defaultMcpServers" multiple filterable clearable
                      :reserve-keyword="false" :placeholder="t('prompts.defaultMcpServersPlaceholder')"
                      style="width: 100%;">
                      <el-option v-for="server in availableMcpServers" :key="server.value" :label="server.label"
                        :value="server.value" />
                    </el-select>
                  </div>
                  <div v-if="editingPrompt.showMode === 'window'" class="param-item"
                    style="align-items: flex-start; margin-top: 10px;">
                    <div style="width: 100%;">
                      <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <span class="param-label">{{ t('prompts.background.imageLabel') }}</span>
                        <div class="spacer"></div>
                      </div>
                      <el-input v-model="editingPrompt.backgroundImage"
                        :placeholder="t('prompts.background.imagePlaceholder')" size="small" clearable />
                      <div v-if="editingPrompt.backgroundImage" style="margin-top: 8px;">
                        <div style="display: flex; align-items: center; margin-bottom: 0px;">
                          <span class="param-label" style="font-size: 12px;">{{ t('prompts.background.opacityLabel') }}:
                            {{
                              editingPrompt.backgroundOpacity }}</span>
                        </div>
                        <el-slider v-model="editingPrompt.backgroundOpacity" :min="0.05" :max="1" :step="0.05"
                          size="small" />
                        <div style="display: flex; align-items: center; margin-bottom: 0px; margin-top: 4px;">
                          <span class="param-label" style="font-size: 12px;">{{ t('prompts.background.blurLabel') }}: {{
                            editingPrompt.backgroundBlur }}px</span>
                        </div>
                        <el-slider v-model="editingPrompt.backgroundBlur" :min="0" :max="20" :step="1" size="small" />
                      </div>
                    </div>
                  </div>
                  <el-row :gutter="20" v-if="editingPrompt.showMode === 'window'" class="dimensions-group-row">
                    <el-col :span="12">
                      <el-form-item :label="t('setting.dimensions.widthLabel')" label-position="top">
                        <el-input-number v-model="editingPrompt.window_width" :min="200" controls-position="right"
                          style="width: 100%;" />
                      </el-form-item>
                    </el-col>
                    <el-col :span="12">
                      <el-form-item :label="t('setting.dimensions.heightLabel')" label-position="top">
                        <el-input-number v-model="editingPrompt.window_height" :min="150" controls-position="right"
                          style="width: 100%;" />
                      </el-form-item>
                    </el-col>
                  </el-row>
                </div>
              </el-form-item>
            </el-col>
          </el-row>

          <el-form-item :label="t('prompts.addToTagLabel')" label-position="top">
            <el-select v-model="editingPrompt.selectedTag" :placeholder="t('prompts.addToTagPlaceholder')"
              style="width: 100%;" multiple filterable clearable>
              <el-option v-for="tagNameItem in sortedTagNames" :key="tagNameItem" :label="tagNameItem"
                :value="tagNameItem" />
            </el-select>
          </el-form-item>
        </el-form>
      </el-scrollbar>
      <template #footer>
        <el-button @click="showPromptEditDialog = false">{{ t('common.cancel') }}</el-button>
        <el-button type="primary" @click="savePrompt">{{ t('common.confirm') }}</el-button>
      </template>
    </el-dialog>

    <!-- å›¾æ ‡ç¼–è¾‘å™¨å¼¹çª— -->
    <el-dialog v-model="showIconEditDialog" :title="t('prompts.editPrompt')" width="400px" :close-on-click-modal="false"
      append-to-body>
      <div class="icon-edit-container">
        <div class="canvas-wrapper">
          <canvas ref="editorCanvasRef" width="256" height="256" @mousedown="handleCanvasMouseDown"
            @mousemove="handleCanvasMouseMove" @mouseup="handleCanvasMouseUp" @mouseleave="handleCanvasMouseUp"
            @wheel="handleCanvasWheel"></canvas>
          <div class="canvas-hint">{{ t('prompts.iconEditor.hint') }}</div>
        </div>

        <div class="editor-controls">
          <div class="control-row">
            <span class="label">{{ t('prompts.iconEditor.scale') }}</span>
            <el-slider v-model="iconEditorState.scale" :min="0.1" :max="3" :step="0.1" @input="drawEditorCanvas" />
          </div>
          <div class="control-row">
            <span class="label">{{ t('prompts.iconEditor.radius') }}</span>
            <el-slider v-model="iconEditorState.radius" :min="0" :max="50" :step="1" @input="drawEditorCanvas"
              :format-tooltip="val => val + '%'" />
          </div>
        </div>
      </div>
      <template #footer>
        <el-button @click="showIconEditDialog = false">{{ t('prompts.iconEditor.cancel') }}</el-button>
        <el-button type="primary" @click="saveEditedIcon">{{ t('prompts.iconEditor.confirm') }}</el-button>
      </template>
    </el-dialog>

    <el-dialog v-model="showAddTagDialog" :title="t('prompts.addNewTag')" width="400px" :close-on-click-modal="false">
      <el-form @submit.prevent="addTag">
        <el-form-item :label="t('prompts.tagNameLabel')" required>
          <el-input v-model="newTagName" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showAddTagDialog = false">{{ t('common.cancel') }}</el-button>
        <el-button type="primary" @click="addTag">{{ t('common.addTag') }}</el-button>
      </template>
    </el-dialog>

    <el-dialog v-model="showAssignPromptDialog"
      :title="t('prompts.assignPromptsToTag', { tagName: assignPromptForm.targetTagName })" width="600px"
      :close-on-click-modal="false">
      <el-form :model="assignPromptForm" label-position="top">
        <el-form-item :label="t('prompts.selectPromptsToAddLabel')">
          <el-alert v-if="!promptsAvailableToAssign(assignPromptForm.targetTagName).length"
            :title="t('prompts.alerts.noPromptsToAssign')" type="info" :closable="false" show-icon />
          <el-select v-else v-model="assignPromptForm.selectedPromptKeys" multiple filterable
            :placeholder="t('prompts.selectPromptsPlaceholder')" style="width: 100%;">
            <el-option v-for="item in promptsAvailableToAssign(assignPromptForm.targetTagName)" :key="item.key"
              :label="item.label" :value="item.key" />
          </el-select>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showAssignPromptDialog = false">{{ t('common.cancel') }}</el-button>
        <el-button type="primary" @click="assignSelectedPromptsToTag"
          :disabled="!assignPromptForm.selectedPromptKeys.length">{{ t('common.assignSelected') }}</el-button>
      </template>
    </el-dialog>

    <el-dialog v-model="showReplaceModelDialog" :title="t('prompts.replaceModelsDialog.title')" width="600px"
      :close-on-click-modal="false">
      <el-form :model="replaceModelForm" label-position="top">
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item :label="t('prompts.replaceModelsDialog.sourceModel')">
              <el-select v-model="replaceModelForm.sourceModel" filterable
                :placeholder="t('prompts.replaceModelsDialog.sourceModel')" style="width: 100%;">
                <el-option v-for="item in usedModels" :key="item.value" :label="item.label" :value="item.value" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item :label="t('prompts.replaceModelsDialog.targetModel')">
              <el-select v-model="replaceModelForm.targetModel" filterable :placeholder="t('prompts.selectNewModel')"
                style="width: 100%;">
                <el-option v-for="item in availableModels" :key="item.value" :label="item.label" :value="item.value" />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>
      <template #footer>
        <el-button @click="showReplaceModelDialog = false">{{ t('common.cancel') }}</el-button>
        <el-button type="primary" @click="replaceModels">{{ t('common.confirm') }}</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<style scoped>
.page-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  width: 100%;
  background-color: var(--bg-primary);
}

.prompts-header {
  display: flex;
  align-items: center;
  height: 45px;
  padding: 0 12px;
  background-color: var(--bg-secondary);
  border-bottom: 1px solid var(--border-primary);
  position: sticky;
  top: 0;
  z-index: 10;
  gap: 16px;
}

.custom-all-tab {
  display: flex;
  align-items: center;
  height: 45px;
  padding: 0 12px;
  cursor: pointer;
  color: var(--text-secondary);
  border-bottom: 2px solid transparent;
  flex-shrink: 0;
  transition: color 0.3s, border-color 0.3s;
}

.custom-all-tab:hover {
  color: var(--text-accent);
}

.custom-all-tab.is-active {
  color: var(--text-accent);
  border-bottom-color: var(--text-accent);
}

.tags-tabs-container {
  flex-grow: 1;
  min-width: 0;
  height: 60px;
}

.tags-tabs-container :deep(.el-tabs__header) {
  height: 60px;
  margin-bottom: 0;
}

.tags-tabs-container :deep(.el-tabs__nav-wrap) {
  overflow-x: auto;
  padding-bottom: 8px;
  margin-bottom: -8px;
}

/* ç¾åŒ–æ»šåŠ¨æ¡ (Webkit) */
.tags-tabs-container :deep(.el-tabs__nav-wrap::-webkit-scrollbar) {
  height: 6px;
}

.tags-tabs-container :deep(.el-tabs__nav-wrap::-webkit-scrollbar-track) {
  background: transparent;
}

.tags-tabs-container :deep(.el-tabs__nav-wrap::-webkit-scrollbar-thumb) {
  background-color: var(--border-primary);
  border-radius: 3px;
}

.tags-tabs-container :deep(.el-tabs__nav-wrap::-webkit-scrollbar-thumb:hover) {
  background-color: var(--text-tertiary);
}

/* ç¾åŒ–æ»šåŠ¨æ¡ (Firefox) */
.tags-tabs-container :deep(.el-tabs__nav-wrap) {
  scrollbar-width: thin;
  scrollbar-color: var(--border-primary) transparent;
}

.tags-tabs-container :deep(.el-tabs__nav-prev),
.tags-tabs-container :deep(.el-tabs__nav-next) {
  display: none !important;
}

.tags-tabs-container :deep(.el-tabs__nav) {
  white-space: nowrap;
}

.tags-tabs-container :deep(.el-tabs__item) {
  flex-shrink: 0;
  padding: 0 12px;
  height: 60px;
  color: var(--text-secondary);
}

.tags-tabs-container :deep(.el-tabs__nav-wrap::after) {
  content: none;
}

.tags-tabs-container :deep(.el-tabs__item.is-active) {
  color: var(--text-accent);
}

.tags-tabs-container :deep(.el-tabs__active-bar) {
  background-color: var(--text-accent);
}

.tab-label-multiline {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  line-height: 1.3;
  text-align: center;
  padding: 8px 0;
  width: 100%;
}

.tab-name {
  font-weight: 600;
  font-size: 14px;
}

.tab-count {
  font-size: 11px;
  color: var(--text-tertiary);
  margin-top: 2px;
}

.tab-actions {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}

.tab-actions .el-button {
  margin-left: 0 !important;
}

.main-content-scrollbar {
  flex-grow: 1;
  height: 0;
  width: 100%;
}

.main-content-scrollbar :deep(.el-scrollbar__thumb) {
  background-color: var(--text-tertiary);
}

.main-content-scrollbar :deep(.el-scrollbar__thumb:hover) {
  background-color: var(--text-secondary);
}

.content-wrapper {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0px 24px 80px 24px;
}

.search-input-container {
  position: sticky;
  top: 0;
  z-index: 10;
  background-color: var(--bg-primary);
  padding: 8px 0px 8px 0px;
  margin: 0px 0px 5px 0px;
}

.search-input-container :deep(.el-input__wrapper) {
  box-shadow: 0 0 0 1px var(--border-primary) inset !important;
}

.search-input-container :deep(.el-input__wrapper.is-focus) {
  box-shadow: 0 0 0 1px var(--text-accent) inset !important;
}

.prompts-grid-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 15px;
  padding-top: 4px;
}

.prompt-card {
  background-color: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-md);
  padding: 10px 16px 10px 16px;
  transition: all 0.25s ease;
  display: flex;
  flex-direction: column;
  height: 104px;
}

.prompt-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-sm);
  border-color: var(--text-accent);
}

.prompt-card-header {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  gap: 12px;
}

.prompt-card-icon {
  flex-shrink: 0;
  border-radius: var(--radius-sm);
}

.prompt-card-icon-default {
  flex-shrink: 0;
  border-radius: var(--radius-sm);
  background-color: var(--bg-tertiary);
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
}

.prompt-name {
  font-weight: 600;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 15px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-grow: 1;
  min-width: 0;
}

.prompt-name:hover {
  color: var(--text-accent);
}

.prompt-card-tag-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
  margin-left: auto;
}

.prompt-description-container {
  padding: 0;
  font-size: 13px;
  color: var(--text-secondary);
  flex-grow: 1;
  cursor: pointer;
  overflow: hidden;
  word-break: break-word;
  line-height: 1.6;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  display: -webkit-box;
  -webkit-box-orient: vertical;
}

.prompt-enable-toggle {
  margin-left: 8px;
}

.empty-tag-message {
  grid-column: 1 / -1;
  text-align: center;
  padding: 24px 0;
  color: var(--text-secondary);
}

.bottom-actions-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 16px;
  padding: 12px 24px;
  background-color: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-top: 1px solid var(--border-primary);
  z-index: 20;
}

html.dark .bottom-actions-container {
  background-color: rgba(23, 24, 28, 0.7);
}

.bottom-actions-container .action-btn {
  flex-grow: 0;
  min-width: 180px;
  font-weight: 500;
}

.action-btn.el-button--primary {
  background-color: var(--bg-accent);
  border-color: var(--bg-accent);
  color: var(--text-on-accent);
}

.edit-prompt-dialog .el-form-item[label-position="top"]> :deep(.el-form-item__label) {
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 6px !important;
  line-height: 1.2;
}

.top-section-grid {
  display: flex;
  gap: 20px;
  align-items: flex-start;
  border-bottom: 1px solid var(--border-primary);
  padding-bottom: 15px;
  margin-bottom: 15px;
}

.icon-area {
  flex: 0 0 90px;
}

.form-fields-area {
  flex: 1;
}

.form-grid {
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 10px 12px;
  align-items: center;
}

.form-grid .el-form-item__label {
  font-weight: 500;
  color: var(--text-secondary);
  padding: 0 !important;
  justify-content: flex-start;
}

.grid-item.no-margin {
  margin-bottom: 0;
}

.grid-item.full-width {
  grid-column: 2 / 4;
}

.enable-switch-group {
  display: flex;
  align-items: center;
  gap: 8px;
  justify-self: end;
}

.enable-switch-group .el-form-item__label {
  margin-bottom: 0;
}

.icon-editor-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  width: 100%;
  margin-top: 12px;
}

.icon-uploader :deep(.el-upload-dragger) {
  width: 64px;
  height: 64px;
  padding: 0;
  border: 1px dashed var(--border-primary);
  border-radius: var(--radius-md);
  background-color: var(--bg-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
  transition: border-color 0.3s;
}

.icon-uploader :deep(.el-upload-dragger:hover) {
  border-color: var(--bg-accent);
}

.icon-uploader-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
}

.icon-hover-mask {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 5;
}

.icon-uploader:hover .icon-hover-mask {
  opacity: 1;
}

.uploaded-icon-avatar {
  width: 100%;
  height: 100%;
  border-radius: 0 !important;
}

.icon-button-group {
  display: flex;
  gap: 6px;
  width: 100%;
  justify-content: center;
}

.icon-action-button {
  flex: 1;
  margin: 0;
}

/* ----------------------------------------------------
   [New] Canvas Icon Editor Dialog Styles
   ---------------------------------------------------- */
.icon-edit-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.canvas-wrapper {
  position: relative;
  width: 256px;
  height: 256px;
  /* Checkerboard background */
  background-image:
    linear-gradient(45deg, #eee 25%, transparent 25%),
    linear-gradient(-45deg, #eee 25%, transparent 25%),
    linear-gradient(45deg, transparent 75%, #eee 75%),
    linear-gradient(-45deg, transparent 75%, #eee 75%);
  background-size: 20px 20px;
  background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
  border: 1px solid var(--border-primary);
  border-radius: 4px;
  overflow: hidden;
  cursor: grab;
}

html.dark .canvas-wrapper {
  background-image:
    linear-gradient(45deg, #333 25%, transparent 25%),
    linear-gradient(-45deg, #333 25%, transparent 25%),
    linear-gradient(45deg, transparent 75%, #333 75%),
    linear-gradient(-45deg, transparent 75%, #333 75%);
}

.canvas-wrapper:active {
  cursor: grabbing;
}

.canvas-wrapper canvas {
  width: 100%;
  height: 100%;
}

.canvas-hint {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  text-align: center;
  font-size: 12px;
  color: var(--text-secondary);
  background-color: var(--bg-primary);
  opacity: 0.8;
  padding: 4px 0;
  pointer-events: none;
}

.editor-controls {
  width: 100%;
  padding: 0 10px;
}

.control-row {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 10px;
}

.control-row .label {
  width: 40px;
  font-size: 13px;
  color: var(--text-secondary);
  flex-shrink: 0;
}

/* ---------------------------------------------------- */

.form-item-subtitle {
  font-size: 12px;
  color: var(--text-tertiary);
  font-weight: 400;
  line-height: 1.4;
  margin-top: 2px;
}

.llm-params-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  background-color: var(--bg-tertiary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-md);
  padding: 16px;
  width: 100%;
  box-sizing: border-box;
}

.llm-params-container.full-height {
  height: 100%;
}

.param-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.param-label {
  font-size: 14px;
  color: var(--text-secondary);
  line-height: 1;
}

.tip-icon {
  color: var(--text-tertiary);
  cursor: help;
}

.spacer {
  flex-grow: 1;
}

.param-item.voice-param .el-select {
  flex-shrink: 0;
}

.slider-form-item {
  margin-top: 15px;
}

:deep(.el-slider__runway) {
  background-color: var(--bg-tertiary);
}

:deep(.el-slider__bar) {
  background-color: var(--bg-accent);
}

:deep(.el-slider__button) {
  border-color: var(--bg-accent);
}

:deep(.el-slider .el-input-number) {
  width: 130px;
}

.dimensions-group-row {
  margin-top: 0px;
  padding-top: 12px;
  border-top: 1px solid var(--border-primary);
}

.dimensions-group-row .el-form-item {
  margin-bottom: 0;
}

:deep(.el-dialog__body) {
  padding: 15px 20px 10px 20px !important;
}

:deep(.el-dialog__footer) {
  padding: 5px;
}

.dimensions-group-row :deep(.el-form-item__label) {
  margin-bottom: 6px !important;
}

:deep(.el-dialog__header) {
  padding: 5px !important;
}

.prompt-dialog-scrollbar :deep(.el-scrollbar__view) {
  padding: 5px 20px 5px 5px;
}

.prompt-textarea-scrollbar {
  width: 100%;
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-md);
  background-color: var(--bg-tertiary);
  transition: all 0.2s;
}

.prompt-textarea-scrollbar:focus-within {
  border-color: var(--text-accent);
  box-shadow: 0 0 0 1px var(--text-accent) inset;
}

.prompt-textarea-scrollbar :deep(.el-textarea__inner) {
  box-shadow: none !important;
  background-color: transparent !important;
  padding: 4px;
  border: none !important;
}

.prompt-textarea-scrollbar :deep(.el-textarea__inner),
.prompt-textarea-scrollbar :deep(.el-textarea__inner:focus),
.prompt-textarea-scrollbar :deep(.el-textarea__inner:hover) {
  box-shadow: none !important;
}

.prompt-textarea-scrollbar :deep(.el-textarea__inner::-webkit-scrollbar) {
  display: none;
}

html.dark .prompt-textarea-scrollbar :deep(.el-scrollbar__thumb) {
  background-color: var(--text-tertiary);
}

html.dark .prompt-textarea-scrollbar :deep(.el-scrollbar__thumb:hover) {
  background-color: var(--text-secondary);
}

.refresh-fab-button {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 21;
  width: 24px;
  height: 24px;
  font-size: 16px;
  box-shadow: var(--el-box-shadow-light);
}

.edit-prompt-form :deep(.el-form-item) {
  margin-bottom: 0;
}

.open-prompt-btn {
  margin-left: 8px;
  color: var(--bg-accent);
  font-size: 16px;
}

.open-prompt-btn:hover {
  color: var(--text-accent);
  background-color: var(--bg-tertiary) !important;
}

.regex-form-item {
  margin-top: 10px;
}
</style>
```
```vue
./Anywhere_main/src/components/Providers.vue
<script setup>
import { ref, reactive, onMounted, computed, inject } from 'vue'
import { Plus, Delete, Edit, ArrowUp, ArrowDown, Refresh, CirclePlus, Remove, Search, Folder, FolderOpened, FolderAdd } from '@element-plus/icons-vue';
import { useI18n } from 'vue-i18n';
import { ElMessage, ElMessageBox } from 'element-plus';
import draggable from 'vuedraggable';

const { t } = useI18n();

const currentConfig = inject('config');
const provider_key = ref(null);

// æ–‡ä»¶å¤¹ç›¸å…³çŠ¶æ€
const addFolder_page = ref(false);
const addFolder_form = reactive({ name: "" });
const renameFolder_page = ref(false);
const renameFolder_form = reactive({ id: "", name: "" });

onMounted(() => {
  if (currentConfig.value.providerOrder && currentConfig.value.providerOrder.length > 0) {
    provider_key.value = currentConfig.value.providerOrder[0];
  } else if (currentConfig.value.providers && Object.keys(currentConfig.value.providers).length > 0) {
    provider_key.value = Object.keys(currentConfig.value.providers)[0];
  } else {
    provider_key.value = null;
  }
});

const selectedProvider = computed(() => {
  if (provider_key.value && currentConfig.value.providers && currentConfig.value.providers[provider_key.value]) {
    return currentConfig.value.providers[provider_key.value];
  }
  return null;
});

// è®¡ç®—å±æ€§ï¼šæ’åºåçš„æ–‡ä»¶å¤¹åˆ—è¡¨
const sortedFolders = computed(() => {
  if (!currentConfig.value.providerFolders) return [];
  return Object.entries(currentConfig.value.providerFolders)
    .map(([id, folder]) => ({ id, ...folder }))
    .sort((a, b) => a.name.localeCompare(b.name));
});

// è®¡ç®—å±æ€§ï¼šæ ¹ç›®å½•ä¸‹çš„æœåŠ¡å•† (æ²¡æœ‰ folderId æˆ– folderId æ— æ•ˆ)
const rootProviders = computed(() => {
  if (!currentConfig.value.providerOrder) return [];
  const folders = currentConfig.value.providerFolders || {};
  return currentConfig.value.providerOrder.filter(key => {
    const p = currentConfig.value.providers[key];
    // å¦‚æœæ²¡æœ‰ provider æˆ– folderId ä¸ºç©ºï¼Œæˆ– folderId æŒ‡å‘çš„æ–‡ä»¶å¤¹ä¸å­˜åœ¨
    return p && (!p.folderId || !folders[p.folderId]);
  });
});

// æ–¹æ³•ï¼šè·å–æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„æœåŠ¡å•† (æŒ‰ providerOrder æ’åº)
const getProvidersInFolder = (folderId) => {
  if (!currentConfig.value.providerOrder) return [];
  return currentConfig.value.providerOrder.filter(key => {
    const p = currentConfig.value.providers[key];
    return p && p.folderId === folderId;
  });
};

// [æ–°å¢] è·å–å½“å‰é€‰ä¸­æœåŠ¡å•†æ‰€åœ¨çš„â€œåˆ†ç»„â€å†…çš„æ‰€æœ‰IDåˆ—è¡¨ï¼ˆæŒ‰é¡ºåºï¼‰
// åˆ†ç»„æŒ‡çš„æ˜¯ï¼šå…·ä½“çš„æ–‡ä»¶å¤¹ æˆ– æ ¹ç›®å½•
const getCurrentGroupIds = () => {
  if (!selectedProvider.value) return [];
  const targetFolderId = selectedProvider.value.folderId;
  const folders = currentConfig.value.providerFolders || {};

  // åˆ¤æ–­å½“å‰é€‰ä¸­çš„æ˜¯åœ¨å“ªä¸ªæœ‰æ•ˆåˆ†ç»„ä¸‹
  // å¦‚æœ folderId å­˜åœ¨ä¸”æ–‡ä»¶å¤¹é…ç½®ä¸­å­˜åœ¨è¯¥IDï¼Œåˆ™æ˜¯åœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹ï¼›å¦åˆ™è§†ä¸ºæ ¹ç›®å½•
  const effectiveFolderId = (targetFolderId && folders[targetFolderId]) ? targetFolderId : "";

  return currentConfig.value.providerOrder.filter(key => {
    const p = currentConfig.value.providers[key];
    if (!p) return false;
    const pFolderId = p.folderId;
    const pEffectiveFolderId = (pFolderId && folders[pFolderId]) ? pFolderId : "";
    return pEffectiveFolderId === effectiveFolderId;
  });
};

// [æ–°å¢] åˆ¤æ–­æ˜¯å¦å¯ä»¥ä¸Šç§»
const canMoveUp = computed(() => {
  if (!selectedProvider.value || !provider_key.value) return false;
  const groupIds = getCurrentGroupIds();
  return groupIds.indexOf(provider_key.value) > 0;
});

// [æ–°å¢] åˆ¤æ–­æ˜¯å¦å¯ä»¥ä¸‹ç§»
const canMoveDown = computed(() => {
  if (!selectedProvider.value || !provider_key.value) return false;
  const groupIds = getCurrentGroupIds();
  return groupIds.indexOf(provider_key.value) < groupIds.length - 1;
});

// åŸå­åŒ–ä¿å­˜å‡½æ•°
async function atomicSave(updateFunction) {
  try {
    const latestConfigData = await window.api.getConfig();
    if (!latestConfigData || !latestConfigData.config) {
      throw new Error("Failed to get latest config from DB.");
    }
    const latestConfig = latestConfigData.config;

    updateFunction(latestConfig);

    await window.api.updateConfigWithoutFeatures({ config: latestConfig });

    currentConfig.value = latestConfig;

  } catch (error) {
    console.error("Atomic save failed:", error);
    ElMessage.error(t('providers.alerts.configSaveFailed'));
  }
}

// æ·»åŠ æ–‡ä»¶å¤¹
function add_folder_function() {
  const name = addFolder_form.name.trim();
  if (!name) return;

  const folderId = `folder_${Date.now()}`;

  atomicSave(config => {
    if (!config.providerFolders) config.providerFolders = {};
    config.providerFolders[folderId] = {
      name: name,
      collapsed: false
    };
  });

  addFolder_form.name = "";
  addFolder_page.value = false;
  ElMessage.success(t('providers.folders.createSuccess'));
}

// æ‰“å¼€é‡å‘½åå¼¹çª—
function open_rename_folder_dialog(id, currentName) {
  renameFolder_form.id = id;
  renameFolder_form.name = currentName;
  renameFolder_page.value = true;
}

// é‡å‘½åæ–‡ä»¶å¤¹
function rename_folder_function() {
  const newName = renameFolder_form.name.trim();
  if (!newName) return;

  atomicSave(config => {
    if (config.providerFolders && config.providerFolders[renameFolder_form.id]) {
      config.providerFolders[renameFolder_form.id].name = newName;
    }
  });

  renameFolder_page.value = false;
  ElMessage.success(t('providers.folders.renameSuccess'));
}

// åˆ é™¤æ–‡ä»¶å¤¹ (æœåŠ¡å•†ç§»å›æ ¹ç›®å½•)
function delete_folder(folderId) {
  ElMessageBox.confirm(
    t('providers.folders.deleteConfirmMessage'),
    t('providers.folders.deleteConfirmTitle'),
    { type: 'warning', confirmButtonText: t('common.confirm'), cancelButtonText: t('common.cancel') }
  ).then(() => {
    atomicSave(config => {
      if (config.providerFolders) delete config.providerFolders[folderId];
      for (const key in config.providers) {
        if (config.providers[key].folderId === folderId) {
          config.providers[key].folderId = "";
        }
      }
    });
    ElMessage.success(t('providers.folders.deleteSuccess'));
  }).catch(() => { });
}

// åˆ‡æ¢æ–‡ä»¶å¤¹æŠ˜å çŠ¶æ€
function toggle_folder(folderId) {
  atomicSave(config => {
    if (config.providerFolders && config.providerFolders[folderId]) {
      config.providerFolders[folderId].collapsed = !config.providerFolders[folderId].collapsed;
    }
  });
}

// è®¾ç½®æœåŠ¡å•†æ‰€å±æ–‡ä»¶å¤¹
function set_provider_folder(folderId) {
  if (!provider_key.value) return;
  const keyToUpdate = provider_key.value;

  atomicSave(config => {
    if (config.providers[keyToUpdate]) {
      config.providers[keyToUpdate].folderId = folderId;
    }
  });
}

function delete_provider() {
  if (!provider_key.value) return;

  atomicSave(config => {
    const keyToDelete = provider_key.value;
    const index = config.providerOrder.indexOf(keyToDelete);

    delete config.providers[keyToDelete];
    config.providerOrder = config.providerOrder.filter(key => key !== keyToDelete);

    // æ›´æ–° provider_key ä»¥é€‰æ‹©ä¸€ä¸ªæ–°çš„æœåŠ¡å•†
    if (config.providerOrder.length > 0) {
      if (index > 0 && index <= config.providerOrder.length) {
        provider_key.value = config.providerOrder[index - 1];
      } else {
        provider_key.value = config.providerOrder[0];
      }
    } else {
      provider_key.value = null;
    }
  });
}

const addProvider_page = ref(false);
const addprovider_form = reactive({ name: "" });

function add_prvider_function() {
  const timestamp = String(Date.now());
  const newName = addprovider_form.name || `${t('providers.unnamedProvider')} ${timestamp.slice(-4)}`;

  atomicSave(config => {
    config.providers[timestamp] = {
      name: newName,
      url: "", api_key: "", modelList: [], enable: true,
      folderId: "" // é»˜è®¤ä¸ºç©º
    };
    config.providerOrder.push(timestamp);
    provider_key.value = timestamp; // è®¾ç½®æ–°æ·»åŠ çš„ä¸ºå½“å‰é€‰ä¸­
  });

  addprovider_form.name = "";
  addProvider_page.value = false;
}

const change_provider_name_page = ref(false);
const change_provider_name_form = reactive({ name: "" });

function openChangeProviderNameDialog() {
  if (selectedProvider.value) {
    change_provider_name_form.name = selectedProvider.value.name;
    change_provider_name_page.value = true;
  }
}

function change_provider_name_function() {
  if (!provider_key.value) return;
  const keyToUpdate = provider_key.value;
  const newName = change_provider_name_form.name;

  atomicSave(config => {
    if (config.providers[keyToUpdate]) {
      config.providers[keyToUpdate].name = newName;
    }
  });

  change_provider_name_form.name = "";
  change_provider_name_page.value = false;
}

function delete_model(model) {
  if (!provider_key.value) return;
  const keyToUpdate = provider_key.value;

  atomicSave(config => {
    const provider = config.providers[keyToUpdate];
    if (provider) {
      provider.modelList = provider.modelList.filter(m => m !== model);
    }
  });
}

const addModel_page = ref(false);
const addModel_form = reactive({ name: "" })

function add_model_function() {
  if (!provider_key.value || !addModel_form.name.trim()) return;
  const keyToUpdate = provider_key.value;
  const newModelName = addModel_form.name.trim();

  atomicSave(config => {
    const provider = config.providers[keyToUpdate];
    if (provider) {
      if (!provider.modelList) {
        provider.modelList = [];
      }
      provider.modelList.push(newModelName);
    }
  });

  addModel_form.name = "";
  addModel_page.value = false;
}

const getModel_page = ref(false);
const getModel_form = reactive({ modelList: [], isLoading: false, error: null });
const searchQuery = ref('');

const filteredModels = computed(() => {
  if (!searchQuery.value) {
    return getModel_form.modelList;
  }
  const lowerCaseQuery = searchQuery.value.toLowerCase();
  return getModel_form.modelList.filter(model =>
    (model.id && model.id.toLowerCase().includes(lowerCaseQuery)) ||
    (model.owned_by && model.owned_by.toLowerCase().includes(lowerCaseQuery))
  );
});


async function activate_get_model_function() {
  if (!selectedProvider.value || !selectedProvider.value.url) {
    ElMessage.warning(t('providers.alerts.providerUrlNotSet'));
    return;
  }
  getModel_page.value = true;
  getModel_form.isLoading = true;
  getModel_form.error = null;
  getModel_form.modelList = [];
  searchQuery.value = '';

  const url = selectedProvider.value.url;
  const apiKey = selectedProvider.value.api_key;
  const apiKeyToUse = window.api && typeof window.api.getRandomItem === 'function' && apiKey ? window.api.getRandomItem(apiKey) : apiKey;


  const options = {
    method: 'GET',
    headers: { 'Content-Type': 'application/json' }
  };
  if (apiKeyToUse) {
    options.headers['Authorization'] = `Bearer ${apiKeyToUse}`;
  }

  try {
    const response = await fetch(`${url}/models`, options);
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ message: response.statusText }));
      const errorMessage = t('providers.alerts.fetchModelsError', { status: response.status, message: errorData.message || t('providers.alerts.fetchModelsFailedDefault') });
      throw new Error(errorMessage);
    }
    const data = await response.json();
    if (data?.data && Array.isArray(data.data)) {
      getModel_form.modelList = data.data.map(m => ({ id: m.id, owned_by: m.owned_by }));
    } else {
      getModel_form.modelList = [];
    }
  } catch (error) {
    console.error(error);
    getModel_form.error = error.message;
    ElMessage.error(error.message);
  } finally {
    getModel_form.isLoading = false;
  }
}

function get_model_function(add, modelId) {
  if (!provider_key.value) return;
  const keyToUpdate = provider_key.value;

  atomicSave(config => {
    const provider = config.providers[keyToUpdate];
    if (provider) {
      if (!provider.modelList) {
        provider.modelList = [];
      }
      if (add) {
        if (!provider.modelList.includes(modelId)) {
          provider.modelList.push(modelId);
        }
      } else {
        provider.modelList = provider.modelList.filter(m => m !== modelId);
      }
    }
  });
}

// [ä¿®æ”¹] æ’åºå‡½æ•°ï¼šç°åœ¨æ”¯æŒåœ¨åˆ†ç»„å†…éƒ¨æ’åº
function change_order(flag) {
  if (!provider_key.value) return;
  const currentId = provider_key.value;

  // è·å–å½“å‰åˆ†ç»„å†…çš„æ‰€æœ‰ ID åˆ—è¡¨
  const groupIds = getCurrentGroupIds();
  const indexInGroup = groupIds.indexOf(currentId);

  if (indexInGroup === -1) return;

  let targetId = null; // å‚ç…§ç‰© IDï¼ˆè¦äº¤æ¢ä½ç½®çš„é‚»å±…ï¼‰
  let insertAfter = false; // true: æ’å…¥åˆ° target åé¢ï¼Œfalse: æ’å…¥åˆ° target å‰é¢

  if (flag === "up") {
    if (indexInGroup > 0) {
      targetId = groupIds[indexInGroup - 1];
      insertAfter = false; // æ”¾åœ¨ä¸Šä¸€ä¸ªçš„å‰é¢ï¼Œå³äº¤æ¢ä½ç½®
    }
  } else if (flag === "down") {
    if (indexInGroup < groupIds.length - 1) {
      targetId = groupIds[indexInGroup + 1];
      insertAfter = true; // æ”¾åœ¨ä¸‹ä¸€ä¸ªçš„åé¢
    }
  }

  if (!targetId) return;

  atomicSave(config => {
    const order = config.providerOrder;
    const currentIndex = order.indexOf(currentId);
    // targetId åœ¨å…¨å±€æ•°ç»„ä¸­çš„ä½ç½®
    const targetIndex = order.indexOf(targetId);

    if (currentIndex === -1 || targetIndex === -1) return;

    // 1. å…ˆæŠŠå½“å‰ ID æ‹¿å‡ºæ¥
    const newOrder = order.filter(id => id !== currentId);

    // 2. æ‰¾åˆ° target åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®ï¼ˆå› ä¸ºåˆ é™¤äº†ä¸€ä¸ªå…ƒç´ ï¼Œç´¢å¼•å¯èƒ½å˜äº†ï¼‰
    const newTargetIndex = newOrder.indexOf(targetId);

    // 3. æ’å…¥åˆ° target é™„è¿‘
    const insertIndex = insertAfter ? newTargetIndex + 1 : newTargetIndex;
    newOrder.splice(insertIndex, 0, currentId);

    config.providerOrder = newOrder;
  });
}

// æ‹–æ‹½æ’åºç»“æŸåè°ƒç”¨çš„ä¿å­˜å‡½æ•°
function saveModelOrder() {
  if (!provider_key.value) return;
  const keyToUpdate = provider_key.value;
  // v-modelå·²ç»æ›´æ–°äº†selectedProvider.modelListçš„é¡ºåº
  const newOrder = selectedProvider.value.modelList;

  atomicSave(config => {
    const provider = config.providers[keyToUpdate];
    if (provider) {
      provider.modelList = newOrder;
    }
  });
}

// å¯¹äºç®€å•çš„å¼€å…³å’Œè¾“å…¥æ¡†ï¼Œä½¿ç”¨ç²¾ç¡®çš„ saveSetting
async function saveSingleProviderSetting(key, value) {
  if (!provider_key.value) return;
  const keyPath = `providers.${provider_key.value}.${key}`;
  try {
    await window.api.saveSetting(keyPath, value);
  } catch (e) {
    ElMessage.error(t('providers.alerts.saveFailed'));
  }
}

const apiKeyCount = computed(() => {
  if (!selectedProvider.value || !selectedProvider.value.api_key || !selectedProvider.value.api_key.trim()) {
    return 0;
  }
  // åŒæ—¶æ”¯æŒä¸­è‹±æ–‡é€—å·ï¼Œå¹¶è¿‡æ»¤ç©ºå­—ç¬¦ä¸²
  const keys = selectedProvider.value.api_key.split(/[,ï¼Œ]/).filter(k => k.trim() !== '');
  return keys.length;
});
</script>

<template>
  <div class="providers-page-container">
    <div class="providers-content-wrapper">
      <el-container>
        <el-aside width="240px" class="providers-aside">
          <el-scrollbar class="provider-list-scrollbar">
            <!-- 1. æ¸²æŸ“æ–‡ä»¶å¤¹ -->
            <div v-for="folder in sortedFolders" :key="folder.id" class="folder-group">
              <div class="folder-header" @click="toggle_folder(folder.id)">
                <div class="folder-icon-wrapper">
                  <el-icon :size="16" class="folder-icon">
                    <Folder v-if="folder.collapsed" />
                    <FolderOpened v-else />
                  </el-icon>
                </div>
                <span class="folder-name">{{ folder.name }}</span>
                <!-- ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®å®¹å™¨ï¼Œhoveræ—¶æ˜¾ç¤º -->
                <div class="folder-actions" @click.stop>
                  <el-button link :icon="Edit" size="small" class="folder-action-btn"
                    @click.stop="open_rename_folder_dialog(folder.id, folder.name)" />
                  <el-button link type="danger" :icon="Delete" size="small" class="folder-action-btn"
                    @click.stop="delete_folder(folder.id)" />
                </div>
              </div>

              <!-- æ–‡ä»¶å¤¹å†…çš„æœåŠ¡å•† -->
              <div v-show="!folder.collapsed" class="folder-content">
                <div v-for="key_id in getProvidersInFolder(folder.id)" :key="key_id" class="provider-item in-folder"
                  :class="{
                    'active': provider_key === key_id, 'disabled': currentConfig.providers[key_id] && !currentConfig.providers[key_id].enable
                  }" @click="provider_key = key_id">
                  <span class="provider-item-name">{{ currentConfig.providers[key_id]?.name ||
                    t('providers.unnamedProvider') }}</span>
                  <el-tag v-if="currentConfig.providers[key_id] && !currentConfig.providers[key_id].enable" type="info"
                    size="small" effect="dark" round>{{ t('providers.statusOff') }}</el-tag>
                </div>
                <!-- ç©ºæ–‡ä»¶å¤¹æç¤º -->
                <div v-if="getProvidersInFolder(folder.id).length === 0" class="empty-folder-tip">
                  {{ t('providers.folders.empty') }}
                </div>
              </div>
            </div>

            <!-- åˆ†éš”çº¿ -->
            <div class="root-providers-divider" v-if="sortedFolders.length > 0 && rootProviders.length > 0"></div>

            <!-- 2. æ¸²æŸ“æ ¹ç›®å½•æœåŠ¡å•† -->
            <div v-for="key_id in rootProviders" :key="key_id" class="provider-item" :class="{
              'active': provider_key === key_id, 'disabled': currentConfig.providers[key_id] && !currentConfig.providers[key_id].enable
            }" @click="provider_key = key_id">
              <span class="provider-item-name">{{ currentConfig.providers[key_id]?.name ||
                t('providers.unnamedProvider') }}</span>
              <el-tag v-if="currentConfig.providers[key_id] && !currentConfig.providers[key_id].enable" type="info"
                size="small" effect="dark" round>{{ t('providers.statusOff') }}</el-tag>
            </div>
            <div
              v-if="(!currentConfig.providerOrder || currentConfig.providerOrder.length === 0) && sortedFolders.length === 0"
              class="no-providers">
              {{ t('providers.noProviders') }}
            </div>
          </el-scrollbar>
          <div class="aside-actions">
            <el-button-group class="action-group">
              <el-tooltip content="æ–°å»ºç›®å½•" placement="top">
                <el-button :icon="FolderAdd" @click="addFolder_page = true" />
              </el-tooltip>
              <el-button type="primary" :icon="Plus" @click="addProvider_page = true" class="add-provider-btn">
                {{ t('providers.addProviderBtn') }}
              </el-button>
            </el-button-group>
          </div>
        </el-aside>

        <el-main class="provider-main-content">
          <el-scrollbar class="provider-details-scrollbar">
            <div v-if="selectedProvider" class="provider-details">
              <div class="provider-header">
                <div class="provider-title-actions">
                  <h2 class="provider-name" @click="openChangeProviderNameDialog">
                    {{ selectedProvider.name }}
                    <el-tooltip :content="t('providers.editNameTooltip')" placement="top">
                      <el-icon class="edit-icon">
                        <Edit />
                      </el-icon>
                    </el-tooltip>
                  </h2>
                  <div class="header-buttons">
                    <!-- [ä¿®æ”¹] ç¦ç”¨çŠ¶æ€ç»‘å®šåˆ° canMoveUp/canMoveDown -->
                    <el-button :icon="ArrowUp" circle plain size="small" :title="t('providers.moveUpTooltip')"
                      :disabled="!canMoveUp" @click="change_order('up')" />
                    <el-button :icon="ArrowDown" circle plain size="small" :title="t('providers.moveDownTooltip')"
                      :disabled="!canMoveDown" @click="change_order('down')" />
                    <el-button type="danger" :icon="Delete" circle plain size="small" @click="delete_provider"
                      :title="t('providers.deleteProviderTooltip')" />
                  </div>
                </div>
                <el-switch v-model="selectedProvider.enable"
                  @change="(value) => saveSingleProviderSetting('enable', value)" size="large" />
              </div>

              <el-form label-position="left" label-width="75px" class="provider-form">
                <div class="form-item-header">
                  <div class="form-item-description">{{ t('providers.apiKeyDescription') }}</div>
                  <el-tag v-if="apiKeyCount > 0" size="small" round class="api-key-count-tag">
                    {{ apiKeyCount }}
                  </el-tag>
                </div>
                <el-form-item :label="t('providers.apiKeyLabel')">
                  <el-input v-model="selectedProvider.api_key" type="password"
                    :placeholder="t('providers.apiKeyPlaceholder')" show-password
                    @change="(value) => saveSingleProviderSetting('api_key', value)" />
                </el-form-item>
                <el-form-item :label="t('providers.apiUrlLabel')">
                  <el-input v-model="selectedProvider.url" :placeholder="t('providers.apiUrlPlaceholder')" clearable
                    @change="(value) => saveSingleProviderSetting('url', value)" />
                </el-form-item>

                <el-form-item :label="t('providers.modelsLabel')">
                  <div class="models-actions-row">
                    <el-button :icon="Refresh" plain @click="activate_get_model_function">{{
                      t('providers.getModelsFromApiBtn')
                    }}</el-button>
                    <el-button :icon="Plus" plain @click="addModel_page = true">{{
                      t('providers.addManuallyBtn')
                    }}</el-button>
                  </div>
                </el-form-item>
                <div class="models-list-wrapper">
                  <draggable v-if="selectedProvider.modelList && selectedProvider.modelList.length > 0"
                    v-model="selectedProvider.modelList" item-key="model"
                    class="models-list-container draggable-models-list" @end="saveModelOrder"
                    ghost-class="sortable-ghost">
                    <template #item="{ element: model }">
                      <el-tag :key="model" closable @close="delete_model(model)" class="model-tag" type="info"
                        effect="light">
                        {{ model }}
                      </el-tag>
                    </template>
                  </draggable>
                  <div v-else class="models-list-container">
                    <div class="no-models-message">
                      {{ t('providers.noModelsAdded') }}
                    </div>
                  </div>
                </div>

                <!-- æ–‡ä»¶å¤¹ä½ç½®é€‰æ‹©å™¨ -->
                <el-form-item :label="t('providers.folders.floder_label')">
                  <div class="folder-selector">
                    <el-radio-group :model-value="selectedProvider.folderId || ''" @change="set_provider_folder"
                      size="small">
                      <el-radio-button value="">{{ t('providers.folders.root') }}</el-radio-button>
                      <el-radio-button v-for="f in sortedFolders" :key="f.id" :value="f.id">{{ f.name
                      }}</el-radio-button>
                    </el-radio-group>
                  </div>
                </el-form-item>

              </el-form>
            </div>
            <el-empty v-else :description="t('providers.selectProviderOrAdd')" class="empty-state-main" />
          </el-scrollbar>
        </el-main>
      </el-container>
    </div>

    <!-- Dialogs -->
    <el-dialog v-model="addProvider_page" :title="t('providers.addProviderDialogTitle')" width="500px"
      :close-on-click-modal="false">
      <el-form :model="addprovider_form" @submit.prevent="add_prvider_function" label-position="top">
        <el-form-item :label="t('providers.providerNameLabel')" required>
          <el-input v-model="addprovider_form.name" autocomplete="off"
            :placeholder="t('providers.providerNamePlaceholder')" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="addProvider_page = false">{{ t('common.cancel') }}</el-button>
        <el-button type="primary" @click="add_prvider_function">{{ t('common.confirm') }}</el-button>
      </template>
    </el-dialog>

    <el-dialog v-model="change_provider_name_page" :title="t('providers.changeProviderNameDialogTitle')" width="500px"
      :close-on-click-modal="false">
      <el-form :model="change_provider_name_form" @submit.prevent="change_provider_name_function" label-position="top">
        <el-form-item :label="t('providers.providerNameLabel')" required>
          <el-input v-model="change_provider_name_form.name" autocomplete="off" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="change_provider_name_page = false">{{ t('common.cancel') }}</el-button>
        <el-button type="primary" @click="change_provider_name_function">{{ t('common.confirm') }}</el-button>
      </template>
    </el-dialog>

    <el-dialog v-model="addModel_page" :title="t('providers.addModelDialogTitle')" width="500px"
      :close-on-click-modal="false">
      <el-form :model="addModel_form" @submit.prevent="add_model_function" label-position="top">
        <el-form-item :label="t('providers.modelNameIdLabel')" required>
          <el-input v-model="addModel_form.name" autocomplete="off"
            :placeholder="t('providers.modelNameIdPlaceholder')" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="addModel_page = false">{{ t('common.cancel') }}</el-button>
        <el-button type="primary" @click="add_model_function">{{ t('common.confirm') }}</el-button>
      </template>
    </el-dialog>

    <el-dialog v-model="getModel_page" :title="t('providers.availableModelsDialogTitle')" width="700px" top="10vh"
      :close-on-click-modal="false" class="available-models-dialog">
      <el-input v-model="searchQuery" :placeholder="t('providers.searchModelsPlaceholder')" clearable
        :prefix-icon="Search" class="dialog-search-input" />

      <el-alert v-if="getModel_form.error" :title="getModel_form.error" type="error" show-icon :closable="false"
        class="dialog-error-alert" />

      <el-table :data="filteredModels" v-loading="getModel_form.isLoading" style="width: 100%" max-height="50vh"
        :empty-text="searchQuery ? t('providers.noModelsMatchSearch') : t('providers.noModelsFoundError')" stripe
        border>
        <el-table-column prop="id" :label="t('providers.table.modelId')" sortable />
        <el-table-column prop="owned_by" :label="t('providers.table.ownedBy')" width="175" sortable />
        <el-table-column :label="t('providers.table.action')" width="100" align="center">
          <template #default="scope">
            <el-tooltip
              :content="selectedProvider && selectedProvider.modelList && selectedProvider.modelList.includes(scope.row.id) ? t('providers.removeModelTooltip') : t('providers.addModelTooltip')"
              placement="top">
              <el-button
                :type="selectedProvider && selectedProvider.modelList && selectedProvider.modelList.includes(scope.row.id) ? 'danger' : 'success'"
                :icon="selectedProvider && selectedProvider.modelList && selectedProvider.modelList.includes(scope.row.id) ? Remove : CirclePlus"
                circle size="small"
                @click="get_model_function(!(selectedProvider && selectedProvider.modelList && selectedProvider.modelList.includes(scope.row.id)), scope.row.id)" />
            </el-tooltip>
          </template>
        </el-table-column>
      </el-table>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="getModel_page = false">{{ t('common.close') }}</el-button>
        </div>
      </template>
    </el-dialog>

    <el-dialog v-model="addFolder_page" :title="t('providers.folders.newFolderTitle')" width="400px"
      :close-on-click-modal="false">
      <el-form :model="addFolder_form" @submit.prevent="add_folder_function">
        <el-form-item :label="t('providers.folders.folderNameLabel')" required>
          <el-input v-model="addFolder_form.name" :placeholder="t('providers.folders.folderNamePlaceholder')"
            @keyup.enter="add_folder_function" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="addFolder_page = false">{{ t('common.cancel') }}</el-button>
        <el-button type="primary" @click="add_folder_function">{{ t('common.confirm') }}</el-button>
      </template>
    </el-dialog>

    <!-- é‡å‘½åç›®å½•å¼¹çª— -->
    <el-dialog v-model="renameFolder_page" :title="t('providers.folders.renameFolderTitle')" width="400px"
      :close-on-click-modal="false">
      <el-form :model="renameFolder_form" @submit.prevent="rename_folder_function">
        <el-form-item :label="t('providers.folders.folderNameLabel')" required>
          <el-input v-model="renameFolder_form.name" :placeholder="t('providers.folders.folderNamePlaceholder')"
            @keyup.enter="rename_folder_function" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="renameFolder_page = false">{{ t('common.cancel') }}</el-button>
        <el-button type="primary" @click="rename_folder_function">{{ t('common.confirm') }}</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<style scoped>
.providers-page-container {
  height: 100%;
  width: 100%;
  padding: 0;
  box-sizing: border-box;
  background-color: var(--bg-primary);
  display: flex;
}

.providers-content-wrapper {
  flex-grow: 1;
  width: 100%;
  background-color: transparent;
  overflow: hidden;
  display: flex;
  padding: 20px;
  gap: 20px;
}

.providers-content-wrapper>.el-container {
  width: 100%;
  height: 100%;
  background-color: var(--bg-secondary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-primary);
  overflow: hidden;
}

.providers-aside {
  background-color: var(--bg-primary);
  border-right: 1px solid var(--border-primary);
  display: flex;
  flex-direction: column;
  padding: 0;
}

.provider-list-scrollbar {
  flex-grow: 1;
  padding: 8px;
}

.no-providers {
  padding: 20px;
  text-align: center;
  color: var(--text-secondary);
  font-size: 14px;
}

.provider-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 14px;
  margin-bottom: 4px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background-color 0.2s, color 0.2s;
  font-size: 14px;
  color: var(--text-primary) !important;
}

.provider-item-name {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-grow: 1;
  margin-right: 8px;
  font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  font-weight: bolder;
}

.provider-item:hover {
  background-color: var(--bg-tertiary);
}

.provider-item.active {
  background-color: var(--bg-accent-light);
  color: var(--text-accent);
  font-weight: 600;
}

.provider-item.disabled .provider-item-name {
  color: var(--text-tertiary);
  text-decoration: line-through;
}

.aside-actions {
  padding: 12px;
  border-top: 1px solid var(--border-primary);
  display: flex;
}

.action-group {
  display: flex;
  width: 100%;
}

.action-group .el-button:first-child {
  flex: 0 0 50px;
}

.action-group .add-provider-btn {
  flex: 1;
  width: auto;
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  background-color: var(--bg-accent);
  color: var(--text-on-accent);
  border: none;
  font-weight: 500;
}

.add-provider-btn:hover {
  opacity: 0.9;
  background-color: var(--bg-accent);
}

.provider-main-content {
  padding: 0;
  background-color: var(--bg-secondary);
  height: 100%;
}

.provider-details-scrollbar {
  height: 100%;
}

.provider-details-scrollbar :deep(.el-scrollbar__view) {
  height: 100%;
  display: flex;
  flex-direction: column;
}


.provider-details {
  padding: 15px 30px 0px 30px;
  flex-grow: 1;
}

.provider-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 0px;
  padding-bottom: 5px;
  border-bottom: 1px solid var(--border-primary);
}

.provider-title-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}

.provider-name {
  font-size: 22px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
  cursor: pointer;
  display: flex;
  align-items: center;
}

.provider-name .edit-icon {
  margin-left: 10px;
  color: var(--text-secondary);
  font-size: 16px;
  opacity: 0;
  transition: opacity 0.2s;
}

.provider-name:hover .edit-icon {
  opacity: 1;
}

.header-buttons {
  display: flex;
  gap: 8px;
}

.provider-form {
  margin-top: 20px !important;
}

.provider-form :deep(.el-form-item__label) {
  font-weight: 500;
  color: var(--text-secondary);
}

.form-item-description {
  font-size: 12px;
  color: var(--text-tertiary);
  margin-top: 6px;
  line-height: 1.4;
}

.models-list-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 12px;
  background-color: var(--bg-primary);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-primary);
  min-height: 75px;
  width: 100%;
  box-sizing: border-box;
}

.no-models-message {
  width: 100%;
  text-align: center;
  color: var(--text-secondary);
  font-size: 13px;
  padding: 12px 0;
}

.model-tag {
  background-color: var(--bg-accent) !important;
  color: var(--text-on-accent) !important;
  border: none !important;
  font-weight: 500;

  display: inline-flex !important;
  align-items: center !important;
  height: 25px !important;
  line-height: 1 !important;
}

.model-tag :deep(.el-tag__content) {
  display: inline-flex;
  align-items: center;
  height: 100%;
  padding-bottom: 2px;
}

.model-tag :deep(.el-tag__close) {
  color: inherit !important;
  position: relative;
  top: 0;
  margin-left: 6px;
}

.model-tag :deep(.el-tag__close:hover) {
  background-color: rgba(255, 255, 255, 0.3) !important;
  color: #FFFFFF !important;
}

html.dark .model-tag :deep(.el-tag__close:hover) {
  background-color: rgba(0, 0, 0, 0.2) !important;
  color: #000000 !important;
}

.draggable-models-list .model-tag {
  cursor: move;
}

.draggable-models-list .sortable-ghost {
  opacity: 0.5;
  background-color: var(--bg-accent-light);
  border: 1px dashed var(--border-accent);
}

.empty-state-main {
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

:deep(.el-switch.is-checked .el-switch__core) {
  background-color: var(--bg-accent);
  border-color: var(--bg-accent);
}

:deep(.el-table__header-wrapper th) {
  background-color: var(--bg-primary) !important;
  font-weight: 500;
  color: var(--text-secondary);
}

:deep(.el-table tr),
:deep(.el-table) {
  background-color: var(--bg-secondary);
}

:deep(.el-table--striped .el-table__body tr.el-table__row--striped td.el-table__cell) {
  background-color: var(--bg-primary);
}

:deep(.el-table td.el-table__cell),
:deep(.el-table th.el-table__cell.is-leaf) {
  border-bottom: 1px solid var(--border-primary);
  color: var(--text-primary);
}

:deep(.el-table--border .el-table__cell) {
  border-right: 1px solid var(--border-primary);
}

:deep(.el-table--border::after),
:deep(.el-table--border::before) {
  background-color: var(--border-primary);
}

:deep(.el-dialog__header) {
  padding: 5px !important;
}

:deep(.el-dialog__body) {
  padding: 15px 20px 10px 20px !important;
}

:deep(.available-models-dialog .dialog-search-input) {
  margin-bottom: 0 !important;
}

:deep(.available-models-dialog .dialog-error-alert) {
  margin-bottom: 15px !important;
}

:deep(.el-dialog__footer) {
  padding: 5px;
}

.api-key-count-tag {
  background-color: transparent !important;
  color: var(--text-primary);
  height: 18px;
  line-height: 18px;
  box-shadow: none;
  margin-top: -4px !important;
}

.form-item-header {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 2px;
  padding-left: 85px;

}

.form-item-header .form-item-description {
  margin-top: 0;
}

.provider-form {
  margin-top: 20px;
}

.provider-form :deep(.el-form-item) {
  margin-bottom: 18px;
}

.models-actions-row {
  display: flex;
  gap: 10px;
}

.models-list-wrapper {
  margin-left: 0px;
  margin-bottom: 18px;
}

/* æ–‡ä»¶å¤¹ç›¸å…³æ ·å¼ */
.folder-group {
  margin-bottom: 4px;
}

.folder-header {
  display: flex;
  align-items: center;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  border-radius: var(--radius-md);
  transition: background-color 0.2s;
}

.folder-header:hover {
  background-color: var(--bg-tertiary);
  color: var(--text-primary);
}

.folder-icon-wrapper {
  display: flex;
  align-items: center;
  margin-right: 6px;
  color: #FFB02E;
}

.folder-name {
  flex-grow: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.folder-actions {
  display: flex;
  gap: 0;
  opacity: 0;
  transition: opacity 0.2s;
}

.folder-header:hover .folder-actions {
  opacity: 1;
}

.folder-action-btn {
  padding: 2px;
  height: auto;
  margin-left: 2px !important;
}

.folder-content {
  margin-top: 2px;
  position: relative;
}

.provider-item.in-folder {
  margin-left: 12px;
  padding: 8px 12px;
  font-size: 13px;
  border-left: 2px solid var(--border-primary);
  border-radius: 0 var(--radius-md) var(--radius-md) 0;
}

.empty-folder-tip {
  font-size: 12px;
  color: var(--text-tertiary);
  padding: 4px 0 4px 24px;
  font-style: italic;
}

.root-providers-divider {
  height: 1px;
  background-color: var(--border-primary);
  margin: 8px 10px;
}

.folder-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

html.dark .folder-icon-wrapper {
  color: #E6A23C;
}

html.dark .provider-item.in-folder {
  border-left-color: var(--border-primary);
}
</style>
```
```vue
./Anywhere_main/src/components/Setting.vue
<script setup>
import { ref, onMounted, computed, inject, h } from 'vue'
import { useI18n } from 'vue-i18n'
import { createClient } from "webdav/web";
import { Upload, FolderOpened, Refresh, Delete as DeleteIcon, Download, Plus } from '@element-plus/icons-vue'
import { ElMessage, ElMessageBox, ElInput } from 'element-plus'

const { t, locale } = useI18n()

const currentConfig = inject('config');
const selectedLanguage = ref(locale.value);


// --- å¤‡ä»½ç®¡ç†å™¨çŠ¶æ€ ---
const isBackupManagerVisible = ref(false);
const backupFiles = ref([]);
const isTableLoading = ref(false);
const selectedFiles = ref([]);
const currentPage = ref(1);
const pageSize = ref(10);

// --- è®¡ç®—å±æ€§ç”¨äºåˆ†é¡µ ---
const paginatedFiles = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value;
  const end = start + pageSize.value;
  return backupFiles.value.slice(start, end);
});

// --- è¾…åŠ©å‡½æ•° ---
const formatDate = (dateString) => {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleString();
};

const formatBytes = (bytes, decimals = 2) => {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const dm = decimals < 0 ? 0 : decimals;
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
};


onMounted(() => {
  selectedLanguage.value = locale.value;
});

// æ–°çš„ã€æ›´ç²¾ç¡®çš„ä¿å­˜å‡½æ•°
async function saveSingleSetting(keyPath, value) {
  try {
    if (window.api && window.api.saveSetting) {
      // è°ƒç”¨ preload æš´éœ²çš„æ–° APIï¼Œåªä¼ é€’å˜æ›´
      await window.api.saveSetting(keyPath, value);
    } else {
      console.warn("window.api.saveSetting is not available.");
    }
  } catch (error) {
    console.error(`Error saving setting for ${keyPath}:`, error);
    ElMessage.error(`${t('setting.alerts.saveFailedPrefix')} ${keyPath}`);
  }
}

//  ä¿å­˜æ•´ä¸ªé…ç½®çš„å‡½æ•°ï¼Œä»…ç”¨äºè¯­éŸ³åˆ—è¡¨ç­‰å¤æ‚æ“ä½œ
async function saveFullConfig() {
  if (!currentConfig.value) return;
  try {
    const configToSave = { config: JSON.parse(JSON.stringify(currentConfig.value)) };
    // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨æ—§çš„ä¿å­˜æ–¹å¼ï¼Œå› ä¸ºå®ƒé€‚ç”¨äºæ•´ä¸ªåˆ—è¡¨çš„ä¿®æ”¹
    // æ›´å¥½çš„åšæ³•æ˜¯ä¹Ÿä¸ºåˆ—è¡¨åˆ›å»ºå¢åˆ æ”¹çš„åŸå­æ“ä½œï¼Œä½†ä¸ºäº†èŠ‚çœå·¥ä½œé‡ï¼Œè¿™é‡Œæš‚æ—¶ä¿ç•™
    if (window.api && window.api.updateConfigWithoutFeatures) {
      await window.api.updateConfigWithoutFeatures(configToSave);
    } else {
      console.warn("window.api.updateConfigWithoutFeatures is not available.");
    }
  } catch (error) {
    console.error("Error saving settings config:", error);
  }
}

function handleLanguageChange(lang) {
  locale.value = lang;
  localStorage.setItem('language', lang);
  selectedLanguage.value = lang;
  // è¯­è¨€è®¾ç½®ä¸å±äºconfigï¼Œæ‰€ä»¥ä¸éœ€è¦ä¿å­˜åˆ°utoolsæ•°æ®åº“
}

// --- å…¨å±€å¼€å…³å¤„ç†å‡½æ•° ---
async function handleGlobalToggleChange(key, value) {
  if (!currentConfig.value || !currentConfig.value.prompts) return;

  // 1. æ›´æ–°å…¨å±€å¼€å…³è‡ªèº«çš„çŠ¶æ€
  if (key === 'isAlwaysOnTop') {
    currentConfig.value.isAlwaysOnTop_global = value;
  } else if (key === 'autoCloseOnBlur') {
    currentConfig.value.autoCloseOnBlur_global = value;
  } else if (key === 'autoSaveChat') {
    currentConfig.value.autoSaveChat_global = value;
  }

  // 2. æ‰¹é‡æ›´æ–°æ‰€æœ‰å¿«æ·åŠ©æ‰‹çš„å¯¹åº”è®¾ç½®
  Object.keys(currentConfig.value.prompts).forEach(promptKey => {
    const prompt = currentConfig.value.prompts[promptKey];
    if (prompt) {
      // è¿™é‡Œçš„ key åˆ†åˆ«å¯¹åº” prompts å¯¹è±¡ä¸­çš„å±æ€§åï¼š
      // 'isAlwaysOnTop', 'autoCloseOnBlur', 'autoSaveChat'
      prompt[key] = value;
    }
  });

  // 3. ä¿å­˜æ•´ä¸ªæ›´æ–°åçš„é…ç½®
  await saveFullConfig();
  ElMessage.success(t('setting.alerts.saveSuccess'));
}

async function exportConfig() {
  if (!currentConfig.value) return;
  try {
    // åˆ›å»ºé…ç½®çš„æ·±æ‹·è´ä»¥è¿›è¡Œä¿®æ”¹ï¼Œä¸å½±å“å½“å‰åº”ç”¨çš„é…ç½®
    const configToExport = JSON.parse(JSON.stringify(currentConfig.value));

    // åœ¨å¯¼å‡ºå‰ç§»é™¤æœ¬åœ°å¯¹è¯è·¯å¾„
    if (configToExport.webdav && configToExport.webdav.localChatPath) {
      delete configToExport.webdav.localChatPath;
    }

    const jsonString = JSON.stringify(configToExport, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Anywhere_config.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    console.log("Configuration exported successfully.");
  } catch (error) {
    console.error("Error exporting config:", error);
  }
}

function importConfig() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          // åœ¨å¯¼å…¥æ–°é…ç½®å‰ï¼Œå…ˆä¿å­˜å½“å‰çš„æœ¬åœ°å¯¹è¯è·¯å¾„
          const currentLocalChatPath = currentConfig.value.webdav?.localChatPath;

          const importedData = JSON.parse(e.target.result);
          if (typeof importedData !== 'object' || importedData === null) {
            throw new Error("Imported file is not a valid configuration object.");
          }

          // å°†ä¿å­˜çš„æœ¬åœ°è·¯å¾„å†™å›åˆ°å³å°†åº”ç”¨çš„é…ç½®ä¸­
          if (currentLocalChatPath) {
            if (!importedData.webdav) {
              importedData.webdav = {}; // ç¡®ä¿ webdav å¯¹è±¡å­˜åœ¨
            }
            importedData.webdav.localChatPath = currentLocalChatPath;
          }

          if (window.api && window.api.updateConfig) {
            await window.api.updateConfig({ config: importedData });
            const result = await window.api.getConfig();
            if (result && result.config) {
              currentConfig.value = result.config;
            }
          }
          console.log("Configuration imported and replaced successfully.");
          ElMessage.success(t('setting.alerts.importSuccess'));
        } catch (err) {
          console.error("Error importing configuration:", err);
          ElMessage.error(t('setting.alerts.importFailed'));
        }
      };
      reader.readAsText(file);
    }
  };
  input.click();
}

async function handleThemeChange(mode) {
  if (!currentConfig.value) return;

  // 1. ä¿å­˜ç”¨æˆ·é€‰æ‹©çš„æ¨¡å¼
  await saveSingleSetting('themeMode', mode);

  // 2. è®¡ç®—å®é™…çš„å¸ƒå°”å€¼
  let newIsDarkMode = currentConfig.value.isDarkMode;

  if (mode === 'system') {
    // æ£€æµ‹ç³»ç»Ÿå½“å‰ä¸»é¢˜
    newIsDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
  } else if (mode === 'dark') {
    newIsDarkMode = true;
  } else {
    newIsDarkMode = false;
  }

  // 3. æ›´æ–°æœ¬åœ°çŠ¶æ€å¹¶ä¿å­˜å¸ƒå°”å€¼ï¼ˆä¸ºäº†å…¼å®¹æ—§é€»è¾‘å’Œå…¶ä»–çª—å£ï¼‰
  currentConfig.value.isDarkMode = newIsDarkMode;
  await saveSingleSetting('isDarkMode', newIsDarkMode);
}

// --- Voice Management (ä½¿ç”¨ saveFullConfig å› ä¸ºå®ƒä¿®æ”¹çš„æ˜¯ä¸€ä¸ªæ•°ç»„) ---
const addNewVoice = () => {
  ElMessageBox.prompt(t('setting.voice.addPromptMessage'), t('setting.voice.addPromptTitle'), {
    confirmButtonText: t('common.confirm'),
    cancelButtonText: t('common.cancel'),
    inputValidator: (value) => {
      if (!value || value.trim() === '') return t('setting.voice.addFailEmpty');
      if (currentConfig.value.voiceList.includes(value.trim())) return t('setting.voice.addFailExists');
      return true;
    },
  }).then(({ value }) => {
    const newVoice = value.trim();
    if (!currentConfig.value.voiceList) {
      currentConfig.value.voiceList = [];
    }
    currentConfig.value.voiceList.push(newVoice);
    saveFullConfig();
    ElMessage.success(t('setting.voice.addSuccess'));
  }).catch(() => { });
};

const editVoice = (oldVoice) => {
  ElMessageBox.prompt(t('setting.voice.editPromptMessage'), t('setting.voice.editPromptTitle'), {
    confirmButtonText: t('common.confirm'),
    cancelButtonText: t('common.cancel'),
    inputValue: oldVoice,
    inputValidator: (value) => {
      const trimmedValue = value.trim();
      if (!trimmedValue) return t('setting.voice.addFailEmpty');
      if (trimmedValue !== oldVoice && currentConfig.value.voiceList.includes(trimmedValue)) {
        return t('setting.voice.addFailExists');
      }
      return true;
    },
  }).then(({ value }) => {
    const newVoice = value.trim();
    if (newVoice === oldVoice) return;
    const index = currentConfig.value.voiceList.indexOf(oldVoice);
    if (index > -1) {
      currentConfig.value.voiceList[index] = newVoice;
      Object.values(currentConfig.value.prompts).forEach(prompt => {
        if (prompt.voice === oldVoice) {
          prompt.voice = newVoice;
        }
      });
      saveFullConfig();
      ElMessage.success(t('setting.voice.editSuccess'));
    }
  }).catch(() => { });
};

const deleteVoice = (voiceToDelete) => {
  const index = currentConfig.value.voiceList.indexOf(voiceToDelete);
  if (index > -1) {
    currentConfig.value.voiceList.splice(index, 1);
    Object.values(currentConfig.value.prompts).forEach(prompt => {
      if (prompt.voice === voiceToDelete) {
        prompt.voice = null;
      }
    });
    saveFullConfig();
  }
};


// --- WebDAV åŠŸèƒ½ ---
async function backupToWebdav() {
  if (!currentConfig.value) return;
  const { url, username, password, path } = currentConfig.value.webdav;
  if (!url) {
    ElMessage.error(t('setting.webdav.alerts.urlRequired'));
    return;
  }

  const now = new Date();
  const timestamp = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
  const defaultBasename = `Anywhere-${timestamp}`;

  const inputValue = ref(defaultBasename);

  try {
    await ElMessageBox({
      title: t('setting.webdav.backup.confirmTitle'),
      // ä¿®æ”¹å¤„ï¼šå¢åŠ å®¹å™¨ Flex å±…ä¸­æ ·å¼ï¼Œå¢åŠ  P æ ‡ç­¾æ–‡å­—å±…ä¸­ï¼Œé™åˆ¶ Input å®½åº¦
      message: () => h('div', { style: 'display: flex; flex-direction: column; align-items: center; width: 100%;' }, [
        h('p', { style: 'margin-bottom: 15px; font-size: 14px; color: var(--text-secondary); text-align: center; width: 100%;' }, t('setting.webdav.backup.confirmMessage')),
        h(ElInput, {
          modelValue: inputValue.value,
          'onUpdate:modelValue': (val) => { inputValue.value = val; },
          placeholder: t('setting.webdav.backup.inputFilename'),
          autofocus: true,
          style: 'width: 100%; max-width: 400px;'
        }, {
          append: () => h('div', { class: 'input-suffix-display' }, '.json')
        })
      ]),
      showCancelButton: true,
      confirmButtonText: t('common.confirm'),
      cancelButtonText: t('common.cancel'),
      customClass: 'filename-prompt-dialog',
      center: true, // ä¿®æ”¹å¤„ï¼šå¼€å¯ Element Plus å¼¹çª—å±…ä¸­æ¨¡å¼
      beforeClose: async (action, instance, done) => {
        if (action === 'confirm') {
          let finalBasename = inputValue.value.trim();
          if (!finalBasename) {
            ElMessage.error(t('setting.webdav.backup.emptyFilenameError'));
            return;
          }
          const filename = finalBasename + '.json';

          instance.confirmButtonLoading = true;
          ElMessage.info(t('setting.webdav.alerts.backupInProgress'));

          try {
            const client = createClient(url, { username, password });
            const remoteDir = path.endsWith('/') ? path.slice(0, -1) : path;
            const remoteFilePath = `${remoteDir}/${filename}`;

            if (!(await client.exists(remoteDir))) {
              await client.createDirectory(remoteDir, { recursive: true });
            }

            //åœ¨å¤‡ä»½å‰ç§»é™¤æœ¬åœ°å¯¹è¯è·¯å¾„
            const configToBackup = JSON.parse(JSON.stringify(currentConfig.value));
            if (configToBackup.webdav && configToBackup.webdav.localChatPath) {
              delete configToBackup.webdav.localChatPath;
            }

            const jsonString = JSON.stringify(configToBackup, null, 2);
            await client.putFileContents(remoteFilePath, jsonString, { overwrite: true });

            ElMessage.success(t('setting.webdav.alerts.backupSuccess'));
            done();
          } catch (error) {
            console.error("WebDAV backup failed:", error);
            ElMessage.error(`${t('setting.webdav.alerts.backupFailed')}: ${error.message}`);
          } finally {
            instance.confirmButtonLoading = false;
          }
        } else {
          done();
        }
      }
    });
  } catch (error) {
    if (error === 'cancel' || error === 'close') {
      ElMessage.info(t('setting.webdav.backup.cancelled'));
    } else {
      console.error("MessageBox error:", error);
    }
  }
}

async function openBackupManager() {
  if (!currentConfig.value) return;
  const { url } = currentConfig.value.webdav;
  if (!url) {
    ElMessage.error(t('setting.webdav.alerts.urlRequired'));
    return;
  }
  isBackupManagerVisible.value = true;
  await fetchBackupFiles();
}

async function fetchBackupFiles() {
  isTableLoading.value = true;
  const { url, username, password, path } = currentConfig.value.webdav;
  try {
    const client = createClient(url, { username, password });
    const remoteDir = path.endsWith('/') ? path.slice(0, -1) : path;

    if (!(await client.exists(remoteDir))) {
      backupFiles.value = [];
      ElMessage.warning(t('setting.webdav.manager.pathNotFound'));
      return;
    }

    const response = await client.getDirectoryContents(remoteDir, { details: true });
    const contents = response.data;

    if (!Array.isArray(contents)) {
      console.error("Failed to fetch backup files: WebDAV response.data is not an array.", response);
      ElMessage.error(t('setting.webdav.manager.fetchFailed') + ': Invalid response structure from server');
      backupFiles.value = [];
      return;
    }

    backupFiles.value = contents
      .filter(item => item.type === 'file' && item.basename.endsWith('.json'))
      .sort((a, b) => new Date(b.lastmod) - new Date(a.lastmod));

  } catch (error) {
    console.error("Failed to fetch backup files:", error);
    let errorMessage = error.message;
    if (error.response && error.response.statusText) {
      errorMessage = `${error.response.status} ${error.response.statusText}`;
    }
    ElMessage.error(`${t('setting.webdav.manager.fetchFailed')}: ${errorMessage}`);
    backupFiles.value = [];
  } finally {
    isTableLoading.value = false;
  }
}

async function restoreFromWebdav(file) {
  try {
    await ElMessageBox.confirm(
      t('setting.webdav.manager.confirmRestore', { filename: file.basename }),
      t('common.warningTitle'),
      {
        confirmButtonText: t('common.confirm'),
        cancelButtonText: t('common.cancel'),
        type: 'warning',
      }
    );

    ElMessage.info(t('setting.webdav.alerts.restoreInProgress'));

    // åœ¨æ¢å¤å‰ä¿å­˜å½“å‰çš„æœ¬åœ°å¯¹è¯è·¯å¾„
    const currentLocalChatPath = currentConfig.value.webdav?.localChatPath;

    const { url, username, password, path } = currentConfig.value.webdav;
    const client = createClient(url, { username, password });
    const remoteDir = path.endsWith('/') ? path.slice(0, -1) : path;
    const remoteFilePath = `${remoteDir}/${file.basename}`;

    const jsonString = await client.getFileContents(remoteFilePath, { format: "text" });
    const importedData = JSON.parse(jsonString);

    if (typeof importedData !== 'object' || importedData === null) {
      throw new Error("Downloaded file is not a valid configuration object.");
    }

    if (currentLocalChatPath) {
      if (!importedData.webdav) {
        importedData.webdav = {};
      }
      importedData.webdav.localChatPath = currentLocalChatPath;
    }

    if (window.api && window.api.updateConfig) {
      await window.api.updateConfig({ config: importedData });
      const result = await window.api.getConfig();
      if (result && result.config) {
        currentConfig.value = result.config;
      }
    }

    ElMessage.success(t('setting.webdav.alerts.restoreSuccess'));
    isBackupManagerVisible.value = false;

  } catch (error) {
    if (error !== 'cancel' && error !== 'close') {
      console.error("WebDAV restore failed:", error);
      ElMessage.error(`${t('setting.webdav.alerts.restoreFailed')}: ${error.message}`);
    }
  }
}

async function deleteFile(file) {
  try {
    await ElMessageBox.confirm(
      t('setting.webdav.manager.confirmDelete', { filename: file.basename }),
      t('common.warningTitle'),
      { type: 'warning' }
    );

    const { url, username, password, path } = currentConfig.value.webdav;
    const client = createClient(url, { username, password });
    const remoteDir = path.endsWith('/') ? path.slice(0, -1) : path;
    const remoteFilePath = `${remoteDir}/${file.basename}`;

    await client.deleteFile(remoteFilePath);
    ElMessage.success(t('setting.webdav.manager.deleteSuccess'));
    await fetchBackupFiles();
  } catch (error) {
    if (error !== 'cancel' && error !== 'close') {
      console.error("Failed to delete file:", error);
      ElMessage.error(`${t('setting.webdav.manager.deleteFailed')}: ${error.message}`);
    }
  }
}

async function deleteSelectedFiles() {
  if (selectedFiles.value.length === 0) {
    ElMessage.warning(t('setting.webdav.manager.noFileSelected'));
    return;
  }

  try {
    await ElMessageBox.confirm(
      t('setting.webdav.manager.confirmDeleteMultiple', { count: selectedFiles.value.length }),
      t('common.warningTitle'),
      { type: 'warning' }
    );

    const { url, username, password, path } = currentConfig.value.webdav;
    const client = createClient(url, { username, password });
    const remoteDir = path.endsWith('/') ? path.slice(0, -1) : path;

    const deletePromises = selectedFiles.value.map(file =>
      client.deleteFile(`${remoteDir}/${file.basename}`)
    );

    await Promise.all(deletePromises);
    ElMessage.success(t('setting.webdav.manager.deleteSuccessMultiple'));
    await fetchBackupFiles();
  } catch (error) {
    if (error !== 'cancel' && error !== 'close') {
      console.error("Failed to delete selected files:", error);
      ElMessage.error(`${t('setting.webdav.manager.deleteFailedMultiple')}: ${error.message}`);
    }
  }
}

const handleSelectionChange = (val) => {
  selectedFiles.value = val;
};

async function selectLocalChatPath() {
  const path = await window.api.selectDirectory();
  if (path) {
    currentConfig.value.webdav.localChatPath = path;
    saveSingleSetting('webdav.localChatPath', path);
  }
}
</script>

<template>
  <div class="settings-page-container">
    <el-scrollbar class="settings-scrollbar-wrapper">
      <div class="settings-content">
        <!-- é€šç”¨è®¾ç½®å¡ç‰‡ -->
        <el-card class="settings-card" shadow="never">
          <template #header>
            <div class="card-header"><span>{{ t('setting.title') }}</span></div>
          </template>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.language.label') }}</span>
              <span class="setting-option-description">{{ t('setting.language.selectPlaceholder') }}</span>
            </div>
            <el-select v-model="selectedLanguage" @change="handleLanguageChange" size="default" style="width: 120px;">
              <el-option :label="t('setting.language.chinese')" value="zh"></el-option>
              <el-option :label="t('setting.language.english')" value="en"></el-option>
              <el-option :label="t('setting.language.japanese')" value="ja"></el-option>
              <el-option :label="t('setting.language.russian')" value="ru"></el-option>
            </el-select>
          </div>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.darkMode.label') }}</span>
              <span class="setting-option-description">{{ t('setting.darkMode.description') }}</span>
            </div>
            <el-select v-model="currentConfig.themeMode" @change="handleThemeChange" size="default"
              style="width: 120px;">
              <el-option :label="t('setting.darkMode.system')" value="system"></el-option>
              <el-option :label="t('setting.darkMode.light')" value="light"></el-option>
              <el-option :label="t('setting.darkMode.dark')" value="dark"></el-option>
            </el-select>
          </div>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.isAlwaysOnTop_global.label') }}</span>
              <span class="setting-option-description">{{ t('setting.isAlwaysOnTop_global.description') }}</span>
            </div>
            <el-switch v-model="currentConfig.isAlwaysOnTop_global"
              @change="(value) => handleGlobalToggleChange('isAlwaysOnTop', value)" />
          </div>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.autoCloseOnBlur_global.label') }}</span>
              <span class="setting-option-description">{{ t('setting.autoCloseOnBlur_global.description') }}</span>
            </div>
            <el-switch v-model="currentConfig.autoCloseOnBlur_global"
              @change="(value) => handleGlobalToggleChange('autoCloseOnBlur', value)" />
          </div>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.autoSaveChat_global.label') }}</span>
              <span class="setting-option-description">{{ t('setting.autoSaveChat_global.description') }}</span>
            </div>
            <el-switch v-model="currentConfig.autoSaveChat_global"
              @change="(value) => handleGlobalToggleChange('autoSaveChat', value)" />
          </div>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.skipLineBreak.label') }}</span>
              <span class="setting-option-description">{{ t('setting.skipLineBreak.description') }}</span>
            </div>
            <el-switch v-model="currentConfig.skipLineBreak"
              @change="(value) => saveSingleSetting('skipLineBreak', value)" />
          </div>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.ctrlEnter.label') }}</span>
              <span class="setting-option-description">{{ t('setting.ctrlEnter.description') }}</span>
            </div>
            <el-switch v-model="currentConfig.CtrlEnterToSend"
              @change="(value) => saveSingleSetting('CtrlEnterToSend', value)" />
          </div>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.notification.label') }}</span>
              <span class="setting-option-description">{{ t('setting.notification.description') }}</span>
            </div>
            <el-switch v-model="currentConfig.showNotification"
              @change="(value) => saveSingleSetting('showNotification', value)" />
          </div>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.fixPosition.label') }}</span>
              <span class="setting-option-description">{{ t('setting.fixPosition.description') }}</span>
            </div>
            <el-switch v-model="currentConfig.fix_position"
              @change="(value) => saveSingleSetting('fix_position', value)" />
          </div>
        </el-card>

        <!-- [MODIFIED] è¯­éŸ³è®¾ç½®å¡ç‰‡ -->
        <el-card class="settings-card" shadow="never">
          <template #header>
            <div class="card-header">
              <el-tooltip :content="t('setting.voice.description')" placement="top">
                <span>{{ t('setting.voice.title') }}</span>
              </el-tooltip>
            </div>
          </template>
          <div class="voice-list-container">
            <el-tag v-for="voice in currentConfig.voiceList" :key="voice" closable @click="editVoice(voice)"
              @close="deleteVoice(voice)" class="voice-tag" size="large">
              {{ voice }}
            </el-tag>
            <el-button class="add-voice-button" type="primary" plain :icon="Plus" @click="addNewVoice">
              {{ t('setting.voice.add') }}
            </el-button>
          </div>
        </el-card>

        <!-- æ•°æ®ç®¡ç†å¡ç‰‡ -->
        <el-card class="settings-card" shadow="never">
          <template #header>
            <div class="card-header"><span>{{ t('setting.dataManagement.title') }}</span></div>
          </template>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.dataManagement.exportLabel') }}</span>
              <span class="setting-option-description">{{ t('setting.dataManagement.exportDesc') }}</span>
            </div>
            <el-button @click="exportConfig" :icon="Download" size="default" plain>{{
              t('setting.dataManagement.exportButton')
            }}</el-button>
          </div>
          <div class="setting-option-item">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.dataManagement.importLabel') }}</span>
              <span class="setting-option-description">{{ t('setting.dataManagement.importDesc') }}</span>
            </div>
            <el-button @click="importConfig" :icon="Upload" size="default" plain>{{
              t('setting.dataManagement.importButton')
            }}</el-button>
          </div>
          <div class="setting-option-item no-border">
            <div class="setting-text-content">
              <span class="setting-option-label">{{ t('setting.webdav.localChatPath') }}</span>
              <span class="setting-option-description">{{ t('setting.webdav.localChatPathPlaceholder') }}</span>
            </div>
            <el-input v-model="currentConfig.webdav.localChatPath"
              @change="(value) => saveSingleSetting('webdav.localChatPath', value)"
              :placeholder="t('setting.webdav.localChatPathPlaceholder')" style="width: 320px;">
              <template #append>
                <el-button @click="selectLocalChatPath">{{ t('setting.webdav.selectFolder') }}</el-button>
              </template>
            </el-input>
          </div>
        </el-card>

        <!-- WebDAV å¡ç‰‡ -->
        <el-card class="settings-card" shadow="never">
          <template #header>
            <div class="card-header"><span>WebDAV</span></div>
          </template>
          <el-form label-width="200px" label-position="left" size="default">
            <el-form-item :label="t('setting.webdav.url')"><el-input v-model="currentConfig.webdav.url"
                @change="(value) => saveSingleSetting('webdav.url', value)"
                :placeholder="t('setting.webdav.urlPlaceholder')" /></el-form-item>
            <el-form-item :label="t('setting.webdav.username')"><el-input v-model="currentConfig.webdav.username"
                @change="(value) => saveSingleSetting('webdav.username', value)"
                :placeholder="t('setting.webdav.usernamePlaceholder')" /></el-form-item>
            <el-form-item :label="t('setting.webdav.password')"><el-input v-model="currentConfig.webdav.password"
                @change="(value) => saveSingleSetting('webdav.password', value)" type="password" show-password
                :placeholder="t('setting.webdav.passwordPlaceholder')" /></el-form-item>
            <el-form-item :label="t('setting.webdav.path')"><el-input v-model="currentConfig.webdav.path"
                @change="(value) => saveSingleSetting('webdav.path', value)"
                :placeholder="t('setting.webdav.pathPlaceholder')" /></el-form-item>
            <el-form-item :label="t('setting.webdav.dataPath')"><el-input v-model="currentConfig.webdav.data_path"
                @change="(value) => saveSingleSetting('webdav.data_path', value)"
                :placeholder="t('setting.webdav.dataPathPlaceholder')" /></el-form-item>
            <el-form-item :label="t('setting.webdav.backupRestoreTitle')" class="no-margin-bottom">
              <el-button @click="backupToWebdav" :icon="Upload">{{ t('setting.webdav.backupButton') }}</el-button>
              <el-button @click="openBackupManager" :icon="FolderOpened">{{ t('setting.webdav.restoreButton')
              }}</el-button>
            </el-form-item>
          </el-form>
        </el-card>
      </div>
    </el-scrollbar>

    <!-- [ä¿®æ”¹] å¤‡ä»½æ•°æ®ç®¡ç†å¼¹çª— -->
    <el-dialog v-model="isBackupManagerVisible" :title="t('setting.webdav.manager.title')" width="700px" top="10vh"
      :destroy-on-close="true" style="max-width: 90vw;" class="backup-manager-dialog">
      <el-table :data="paginatedFiles" v-loading="isTableLoading" @selection-change="handleSelectionChange"
        style="width: 100%" max-height="50vh" border stripe>
        <el-table-column type="selection" width="50" align="center" />
        <el-table-column prop="basename" :label="t('setting.webdav.manager.filename')" sortable show-overflow-tooltip
          min-width="160" />
        <el-table-column prop="lastmod" :label="t('setting.webdav.manager.modifiedTime')" width="170" sortable
          align="center">
          <template #default="scope">{{ formatDate(scope.row.lastmod) }}</template>
        </el-table-column>
        <el-table-column prop="size" :label="t('setting.webdav.manager.size')" width="100" sortable align="center">
          <template #default="scope">{{ formatBytes(scope.row.size) }}</template>
        </el-table-column>
        <el-table-column :label="t('setting.webdav.manager.actions')" width="120" align="center">
          <template #default="scope">
            <div class="action-buttons-container">
              <el-button link type="primary" @click="restoreFromWebdav(scope.row)">{{
                t('setting.webdav.manager.restore') }}</el-button>
              <el-divider direction="vertical" />
              <el-button link type="danger" @click="deleteFile(scope.row)">{{ t('setting.webdav.manager.delete')
              }}</el-button>
            </div>
          </template>
        </el-table-column>
      </el-table>

      <template #footer>
        <div class="dialog-footer">
          <div class="footer-left">
            <el-button :icon="Refresh" @click="fetchBackupFiles">{{ t('common.refresh') }}</el-button>
            <el-button type="danger" :icon="DeleteIcon" @click="deleteSelectedFiles"
              :disabled="selectedFiles.length === 0">
              {{ t('common.deleteSelected') }} ({{ selectedFiles.length }})
            </el-button>
          </div>
          <div class="footer-center">
            <el-pagination v-if="backupFiles.length > 0" v-model:current-page="currentPage" v-model:page-size="pageSize"
              :page-sizes="[10, 20, 50, 100]" :total="backupFiles.length"
              layout="total, sizes, prev, pager, next, jumper" background size="small" />
          </div>
          <div class="footer-right">
            <el-button @click="isBackupManagerVisible = false">{{ t('common.close') }}</el-button>
          </div>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<style scoped>
/* [MODIFIED] Voice settings styles */
.voice-list-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 15px 0;
}

.voice-tag {
  font-size: 14px;
  height: 32px;
  padding: 0 12px;
  cursor: pointer;
  transition: transform 0.2s ease-in-out, filter 0.2s ease-in-out;
}

.voice-tag:hover {
  transform: scale(1.05);
  filter: brightness(1.2);
}

.add-voice-button {
  border-style: dashed;
}

.settings-page-container {
  height: 100%;
  width: 100%;
  background-color: var(--bg-primary);
  display: flex;
  justify-content: center;
  overflow: hidden;
}

.settings-scrollbar-wrapper {
  height: 100%;
  width: 100%;
  max-width: 900px;
}

.settings-content {
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.settings-card {
  --el-card-padding: 0;
  border: 1px solid var(--border-primary);
  background-color: var(--bg-secondary);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.card-header {
  padding: 15px 25px;
  font-size: 18px;
  color: var(--text-primary);
}

/* MODIFIED: Specifically target spans inside the header for boldness */
.card-header>span,
.card-header :deep(span) {
  font-weight: 700;
  /* or 'bold' */
}

:deep(.el-card__header) {
  padding: 0;
  border-bottom: 1px solid var(--border-primary);
}

:deep(.el-card__body) {
  padding: 10px 25px;
}

.setting-option-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border-primary);
  gap: 20px;
  flex-wrap: wrap;
}

.setting-option-item:last-child,
.setting-option-item.no-border {
  border-bottom: none;
}

.setting-text-content {
  display: flex;
  align-items: baseline;
  flex-wrap: wrap;
  gap: 8px;
  flex: 1;
  min-width: 0;
}

.setting-option-label {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
  white-space: nowrap;
}

.setting-option-description {
  font-size: 13px;
  color: var(--text-tertiary);
  line-height: 1.4;
}

.el-switch {
  --el-switch-on-color: var(--bg-accent);
  flex-shrink: 0;
}

.el-select,
.el-button,
.el-input-number {
  flex-shrink: 0;
}

:deep(.el-form-item__label) {
  line-height: 1.5;
  color: var(--text-secondary);
  font-weight: 500;
}

.action-buttons-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0;
}

.action-buttons-container .el-divider--vertical {
  height: 1em;
  border-left: 1px solid var(--border-primary);
  margin: 0 8px;
}

.dialog-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  flex-wrap: wrap;
  gap: 10px;
  padding-top: 10px;
}

.footer-left,
.footer-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.footer-center {
  flex-grow: 1;
  display: flex;
  justify-content: center;
}

:deep(.el-pagination.is-background .el-pager li),
:deep(.el-pagination.is-background .btn-prev),
:deep(.el-pagination.is-background .btn-next) {
  background-color: var(--bg-tertiary);
  color: var(--text-primary);
}

:deep(.el-pagination.is-background .el-pager li:not(.is-disabled).is-active) {
  background-color: var(--bg-accent);
  color: var(--text-on-accent);
}

:deep(.el-table__header-wrapper th) {
  background-color: var(--bg-primary) !important;
  color: var(--text-secondary);
  font-weight: 600;
}

:deep(.el-table),
:deep(.el-table tr) {
  background-color: var(--bg-secondary);
}

:deep(.el-table--striped .el-table__body tr.el-table__row--striped td.el-table__cell) {
  background-color: var(--bg-primary);
}

:deep(.el-table td.el-table__cell),
:deep(.el-table th.el-table__cell.is-leaf) {
  border-bottom: 1px solid var(--border-primary);
  color: var(--text-primary);
}

:deep(.el-table--border .el-table__cell) {
  border-right: 1px solid var(--border-primary);
}


:deep(.backup-manager-dialog .el-dialog__header) {
  padding: 5px !important;
}

:deep(.backup-manager-dialog .el-dialog__body) {
  padding: 15px 20px 10px 20px !important;
}

:deep(.backup-manager-dialog .el-dialog__footer) {
  padding: 5px;
}
</style>
```
```vue
./Anywhere_main/src/App.vue
<script setup>
import { ref, watch, onMounted, provide, onBeforeUnmount } from 'vue'
import Chats from './components/Chats.vue'
import Prompts from './components/Prompts.vue'
import Mcp from './components/Mcp.vue' // å¼•å…¥æ–°ç»„ä»¶
import Setting from './components/Setting.vue'
import Providers from './components/Providers.vue'
import { useI18n } from 'vue-i18n'
import { ChatDotRound, MagicStick, Cloudy, Setting as SettingIcon } from '@element-plus/icons-vue' // ç§»é™¤ Server

const { t, locale } = useI18n()
const tab = ref(0);
const header_text = ref(t('app.header.chats'));

const config = ref(null);

// [MODIFIED] å°† config provide ç»™æ‰€æœ‰å­ç»„ä»¶
provide('config', config);

// This watcher is now very effective because of the CSS variables and shared state.
watch(() => config.value?.isDarkMode, (isDark) => {
  if (isDark === undefined) return;
  if (isDark) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
}, { deep: true }); // [MODIFIED] deep watch might be more robust here

const handleGlobalEsc = (e) => {
  if (e.key === 'Escape') {
    // 1. ä¼˜å…ˆæ£€æŸ¥å›¾ç‰‡é¢„è§ˆç»„ä»¶ (Image Viewer)
    const imageViewerCloseBtn = document.querySelector('.el-image-viewer__close');
    if (imageViewerCloseBtn && window.getComputedStyle(imageViewerCloseBtn).display !== 'none') {
      e.stopPropagation(); // é˜»æ­¢ uTools é€€å‡º
      imageViewerCloseBtn.click(); // æ‰‹åŠ¨è§¦å‘å…³é—­
      return;
    }

    // 2. æ£€æŸ¥å¯è§çš„å¼¹çª—é®ç½©å±‚ (Dialog Overlays)
    const overlays = Array.from(document.querySelectorAll('.el-overlay')).filter(el => {
      return el.style.display !== 'none' && !el.classList.contains('is-hidden');
    });

    if (overlays.length > 0) {
      // æ‰¾åˆ°å±‚çº§æœ€é«˜ï¼ˆæœ€ä¸Šå±‚ï¼‰çš„å¼¹çª—
      const topOverlay = overlays.reduce((max, current) => {
        return (parseInt(window.getComputedStyle(current).zIndex) || 0) >
               (parseInt(window.getComputedStyle(max).zIndex) || 0) ? current : max;
      });

      // é˜»æ­¢ uTools é€€å‡º
      e.stopPropagation();

      // A. å°è¯•ç‚¹å‡»å³ä¸Šè§’çš„å…³é—­(X)æŒ‰é’®
      // åŒæ—¶æ”¯æŒ Dialog å’Œ MessageBox çš„å…³é—­æŒ‰é’®ç±»å
      const headerBtn = topOverlay.querySelector('.el-dialog__headerbtn, .el-message-box__headerbtn');
      if (headerBtn) {
        headerBtn.click();
        return;
      }

      // B. å°è¯•ç‚¹å‡»åº•éƒ¨çš„å–æ¶ˆ/å…³é—­æŒ‰é’®
      // åŒæ—¶æ”¯æŒ Dialog Footer å’Œ MessageBox Buttons å®¹å™¨
      const footer = topOverlay.querySelector('.el-dialog__footer, .el-message-box__btns');
      if (footer) {
        // ç‰¹æ®Šå¤„ç† Setting.vue ä¸­å¤‡ä»½ç®¡ç†çš„å¸ƒå±€ (å…³é—­æŒ‰é’®åœ¨ .footer-right)
        const rightBtn = footer.querySelector('.footer-right .el-button');
        if (rightBtn) {
          rightBtn.click();
          return;
        }
        // é€šç”¨å¤„ç†ï¼šç‚¹å‡»åº•éƒ¨ç¬¬ä¸€ä¸ªæŒ‰é’® (é€šå¸¸æ˜¯ å–æ¶ˆ/Cancel)
        const buttons = footer.querySelectorAll('.el-button');
        if (buttons.length > 0) {
          buttons[0].click();
          return;
        }
      }
    }
  }
};

const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
const handleSystemThemeChange = (e) => {
  // åªæœ‰å½“è®¾ç½®ä¸º "system" æ—¶æ‰å“åº”
  if (config.value?.themeMode === 'system') {
    const isDark = e.matches;
    if (config.value.isDarkMode !== isDark) {
      config.value.isDarkMode = isDark;
      // åŒæ­¥æ›´æ–°åˆ°æ•°æ®åº“ï¼Œç¡®ä¿ç‹¬ç«‹çª—å£æ‰“å¼€æ—¶ä¹Ÿæ˜¯æ­£ç¡®çš„é¢œè‰²
      if (window.api && window.api.saveSetting) {
        window.api.saveSetting('isDarkMode', isDark);
      }
    }
  }
};

onMounted(async () => {
  window.addEventListener('keydown', handleGlobalEsc, true);
  mediaQuery.addEventListener('change', handleSystemThemeChange);
  try {
    const result = await window.api.getConfig();
    if (result && result.config) {
      const baseConfig = JSON.parse(JSON.stringify(window.api.defaultConfig.config));
      config.value = Object.assign({}, baseConfig, result.config);
      if (config.value.themeMode === 'system') {
        const systemDark = mediaQuery.matches;
        if (config.value.isDarkMode !== systemDark) {
          config.value.isDarkMode = systemDark;
          window.api.saveSetting('isDarkMode', systemDark);
        }
      }
    } else {
      config.value = JSON.parse(JSON.stringify(window.api.defaultConfig.config));
    }
  } catch (error) {
    console.error("Error fetching config in App.vue:", error);
    config.value = JSON.parse(JSON.stringify(window.api.defaultConfig.config));
  }

  // Immediately apply dark mode on mount
  if (config.value?.isDarkMode) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
});

onBeforeUnmount(() => {
  window.removeEventListener('keydown', handleGlobalEsc, true);
  mediaQuery.removeEventListener('change', handleSystemThemeChange);
});

function changeTab(newTab) {
  tab.value = newTab;
  updateHeaderText();
}

function updateHeaderText() {
  const tabMap = {
    0: 'app.header.chats',
    1: 'app.header.prompts',
    2: 'app.header.mcp',
    3: 'app.header.providers',
    4: 'app.header.settings'
  };
  header_text.value = t(tabMap[tab.value]);
}

watch(locale, () => {
  updateHeaderText();
});
</script>

<template>
  <el-container class="common-layout">
    <el-header>
      <el-row :gutter="0" class="header-row" align="middle">
        <el-col :span="6" class="blank-col"></el-col>
        <el-col :span="12" class="header-title-col">
          <el-text class="header-title-text">{{ header_text }}</el-text>
        </el-col>
        <el-col :span="6" class="tabs-col">
          <div class="tabs-container">
            <!-- 1. Chats (äº‘ç«¯å¯¹è¯) -->
            <el-tooltip :content="t('app.tabs.chats')" placement="bottom">
              <el-button class="tab-button" text @click="changeTab(0)" :class="{ 'active-tab': tab === 0 }">
                <el-icon :size="20">
                  <svg t="1765030297139" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="72601" width="200" height="200">
                    <path
                      d="M512 64c259.2 0 469.333333 200.576 469.333333 448s-210.133333 448-469.333333 448a484.48 484.48 0 0 1-232.725333-58.88l-116.394667 50.645333a42.666667 42.666667 0 0 1-58.517333-49.002666l29.76-125.013334C76.629333 703.402667 42.666667 611.477333 42.666667 512 42.666667 264.576 252.8 64 512 64z m0 64C287.488 128 106.666667 300.586667 106.666667 512c0 79.573333 25.557333 155.434667 72.554666 219.285333l5.525334 7.317334 18.709333 24.192-26.965333 113.237333 105.984-46.08 27.477333 15.018667C370.858667 878.229333 439.978667 896 512 896c224.512 0 405.333333-172.586667 405.333333-384S736.512 128 512 128z m-157.696 341.333333a42.666667 42.666667 0 1 1 0 85.333334 42.666667 42.666667 0 0 1 0-85.333334z m159.018667 0a42.666667 42.666667 0 1 1 0 85.333334 42.666667 42.666667 0 0 1 0-85.333334z m158.997333 0a42.666667 42.666667 0 1 1 0 85.333334 42.666667 42.666667 0 0 1 0-85.333334z"
                      fill="currentColor" p-id="72602"></path>
                  </svg>
                </el-icon>
              </el-button>
            </el-tooltip>

            <!-- 2. Prompts (å¿«æ·åŠ©æ‰‹/Agent) -->
            <el-tooltip :content="t('app.tabs.prompts')" placement="bottom">
              <el-button class="tab-button" text @click="changeTab(1)" :class="{ 'active-tab': tab === 1 }">
                <el-icon :size="20">
                  <svg t="1765030347985" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="77085" width="200" height="200">
                    <path
                      d="M617.92 198.784A270.4 270.4 0 0 1 888.32 469.12v225.344a270.464 270.464 0 0 1-270.4 270.464h-315.52A270.4 270.4 0 0 1 32 694.528v-225.28a270.4 270.4 0 0 1 270.4-270.464h315.52z m0 90.112h-315.52a180.288 180.288 0 0 0-180.288 180.288v225.344a180.288 180.288 0 0 0 180.288 180.288h315.52a180.288 180.288 0 0 0 180.288-180.288v-225.28a180.288 180.288 0 0 0-180.288-180.352z"
                      p-id="77086"></path>
                    <path
                      d="M324.928 491.712c30.08 0 45.12 15.04 45.12 45.056v90.176c0 30.08-15.04 45.056-45.12 45.056-30.016 0-45.056-15.04-45.056-45.056V536.768c0-30.08 15.04-45.056 45.056-45.056zM594.944 483.584a38.336 38.336 0 0 1 45.952 61.312l-49.28 36.992 49.28 36.928a38.336 38.336 0 0 1 10.496 49.28l-2.816 4.352a38.272 38.272 0 0 1-53.632 7.68l-66.112-49.6a60.8 60.8 0 0 1 0-97.28l66.112-49.664zM922.944 220.544l-21.312 44.544a17.536 17.536 0 0 1-7.104 7.488 21.312 21.312 0 0 1-21.376 0 17.536 17.536 0 0 1-7.104-7.488l-21.376-44.544a44.608 44.608 0 0 0-21.312-20.608l-37.696-17.984a18.368 18.368 0 0 1-7.296-6.144 15.232 15.232 0 0 1-2.688-8.576c0-3.008 0.896-6.016 2.688-8.576a18.368 18.368 0 0 1 7.296-6.144l37.76-17.92a44.8 44.8 0 0 0 21.248-20.736l21.376-44.48a17.536 17.536 0 0 1 7.04-7.488 21.376 21.376 0 0 1 21.44 0c3.2 1.792 5.632 4.48 7.04 7.488l21.376 44.48a44.672 44.672 0 0 0 21.376 20.672l37.632 17.92a18.368 18.368 0 0 1 7.36 6.208 15.168 15.168 0 0 1 0 17.152 18.368 18.368 0 0 1-7.36 6.144l-37.632 17.92a44.608 44.608 0 0 0-21.376 20.672z"
                      p-id="77087"></path>
                  </svg>
                </el-icon>
              </el-button>
            </el-tooltip>

            <!-- 3. MCP -->
            <el-tooltip :content="t('app.tabs.mcp')" placement="bottom">
              <el-button class="tab-button" text @click="changeTab(2)" :class="{ 'active-tab': tab === 2 }">
                <el-icon :size="19">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 12-8.373 8.373a1 1 0 1 1-3-3L12 9"></path>
                    <path d="m18 15 4-4"></path>
                    <path
                      d="m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172V7l-2.26-2.26a6 6 0 0 0-4.202-1.756L9 2.96l.92.82A6.18 6.18 0 0 1 12 8.4V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5">
                    </path>
                  </svg>
                </el-icon>
              </el-button>
            </el-tooltip>

            <!-- 4. Providers (äº‘æœåŠ¡å•†) -->
            <el-tooltip :content="t('app.tabs.providers')" placement="bottom">
              <el-button class="tab-button" text @click="changeTab(3)" :class="{ 'active-tab': tab === 3 }">
                <el-icon :size="20">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"></path>
                  </svg>
                </el-icon>
              </el-button>
            </el-tooltip>

            <!-- 5. Settings (è®¾ç½®) -->
            <el-tooltip :content="t('app.tabs.settings')" placement="bottom">
              <el-button class="tab-button" text @click="changeTab(4)" :class="{ 'active-tab': tab === 4 }">
                <el-icon :size="18">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                      d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
                    </path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </el-icon>
              </el-button>
            </el-tooltip>
          </div>
        </el-col>
      </el-row>
    </el-header>

    <el-main v-if="config">
      <Chats v-if="tab === 0" key="chats" />
      <Prompts v-if="tab === 1" key="prompts" />
      <Mcp v-if="tab === 2" key="mcp" />
      <Providers v-if="tab === 3" key="providers" />
      <Setting v-if="tab === 4" key="settings" />
    </el-main>
  </el-container>
</template>

<style scoped>
.common-layout,
.el-container {
  width: 100%;
  height: 100%;
  padding: 0;
  margin: 0;
  overflow: hidden;
  background-color: var(--bg-primary);
  display: flex;
  flex-direction: column;
}

.el-header {
  padding: 0px 20px 0px 0px;
  height: 50px;
  display: flex;
  align-items: center;
  background-color: var(--bg-secondary);
  border-bottom: 1px solid var(--border-primary);
  flex-shrink: 0;
  z-index: 10;
}

.header-row {
  width: 100%;
}

.header-title-col {
  display: flex;
  justify-content: center;
  align-items: center;
}

.header-title-text {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: 0.5px;
  transition: color 0.3s ease;
}

.tabs-col {
  display: flex;
  justify-content: flex-end;
}

.tabs-container {
  display: flex;
  gap: 0px;
  background-color: var(--bg-tertiary);
  padding: 4px;
  border-radius: var(--radius-md);
}

.tab-button {
  padding: 8px;
  border: none;
  background-color: transparent;
  color: var(--text-secondary);
  border-radius: var(--radius-sm);
  transition: background-color 0.2s, color 0.2s;
  height: 32px;
  width: 32px;
}

.tab-button:hover {
  background-color: var(--bg-secondary);
  color: var(--text-primary);
}

.active-tab {
  background-color: var(--bg-secondary);
  color: var(--text-accent);
  box-shadow: var(--shadow-sm);
}

.el-main {
  padding: 0;
  flex-grow: 1;
  overflow-y: auto;
  background-color: var(--bg-primary);
}

.blank-col {
  min-width: 32px;
}
</style>
```
```json
./Anywhere_main/src/locales/en.json
{
  "app": {
    "header": {
      "chats": "Chats ğŸ’¬",
      "prompts": "Agent Prompts ğŸš€",
      "mcp": "MCP Servers ğŸ”§",
      "providers": "Providers â˜ï¸",
      "settings": "Settings âš™ï¸"
    },
    "tabs": {
      "chats": "Chat History",
      "prompts": "Agent Prompts",
      "mcp": "MCP Servers",
      "providers": "Providers",
      "settings": "Settings"
    }
  },
  "chats": {
    "view": {
      "local": "Local Chats",
      "cloud": "Cloud Chats"
    },
    "info": {
      "title": "Information",
      "localDesc": "Â· Local Chats: Named conversations (saved, loaded from JSON, or opened from cloud) are auto-saved every 15 seconds. All conversations are stored in JSON format at {path}. Different paths can be used on different devices.",
      "pathNotSet": "Not configured",
      "cloudDesc": "Â· Cloud Chats: Conversations uploaded to the cloud, which can be pulled to local at any time."
    },
    "configRequired": {
      "title": "Cloud Chats",
      "webdavDescription": "Please configure WebDAV URL and data path (data_path) in 'Settings' to use this feature.",
      "localPathDescription": "Please configure your local chat storage path in the 'Settings' page first"
    },
    "table": {
      "filename": "Chat Name",
      "modifiedTime": "Modified Time",
      "size": "Size",
      "actions": "Actions"
    },
    "actions": {
      "chat": "Chat",
      "rename": "Rename",
      "delete": "Delete",
      "forceSync": "Sync"
    },
    "rename": {
      "promptTitle": "Rename Chat",
      "promptMessage": "Please enter the new conversation name.",
      "invalidFilename": "Invalid filename, must end with .json.",
      "syncTitle": "Sync Operation",
      "syncCloudConfirm": "A file with the same name exists in the cloud. Rename it synchronously?",
      "syncLocalConfirm": "A file with the same name exists locally. Rename it synchronously?"
    },
    "tooltips": {
      "syncToCloud": "Upload to Cloud",
      "syncFromCloud": "Sync from Cloud",
      "uploadChanges": "Upload {count} new or updated local files",
      "downloadChanges": "Download {count} new or updated cloud files",
      "forceUpload": "Force upload this file to the cloud (overwrite)",
      "forceDownload": "Force download this file from the cloud (overwrite)"
    },
    "confirmDelete": "Are you sure you want to permanently delete chat '{filename}'?",
    "clean": {
      "button": "Clean Old Chats",
      "title": "Auto Clean Chats",
      "timeRangeLabel": "Keep Time Range",
      "customDaysLabel": "Custom Days",
      "previewTitle": "Will delete {count} chats older than {days} days ({size})",
      "noFilesFound": "No old chats found matching criteria",
      "confirmBtn": "Confirm Clean",
      "success": "Successfully cleaned {count} files",
      "ranges": {
        "3": "Older than 3 days",
        "7": "Older than 7 days",
        "30": "Older than 30 days",
        "custom": "Custom"
      },
      "scopeTip": "Note: This action only deletes files in the current view ({view}) and will not sync delete files on the other side."
    },
    "alerts": {
      "configError": "Failed to get configuration.",
      "pathNotFound": "Specified WebDAV data path not found.",
      "pathCreated": "Data path does not exist, has been created automatically.",
      "fetchFailed": "Failed to fetch chat list.",
      "loadingChat": "Loading chat...",
      "restoreInitiated": "Chat has started.",
      "restoreFailed": "Failed to restore chat.",
      "renameSuccess": "Rename successful.",
      "renameFailed": "Rename failed.",
      "syncInProgress": "Syncing...",
      "syncPreparingUpload": "Preparing to upload...",
      "syncPreparingDownload": "Preparing to download...",
      "syncProcessing": "Processing... {completed}/{total}",
      "syncCancelled": "Sync operation has been cancelled",
      "syncSuccessUpload": "{count} files successfully synced to the cloud.",
      "syncSuccessDownload": "{count} files successfully synced from the cloud.",
      "syncFailedPartially": "{failedCount} files failed.",
      "syncFailed": "Sync failed: {message}",
      "syncConfirmUpload": "This will upload all local conversations to the cloud, overwriting any files with the same name. Continue?",
      "syncConfirmUploadTitle": "Upload to Cloud",
      "syncConfirmDownload": "This will download all cloud conversations to your local machine, overwriting any files with the same name. Continue?",
      "syncConfirmDownloadTitle": "Sync from Cloud",
      "syncNoUpload": "All local files are up-to-date or newer on the cloud. Nothing to upload.",
      "syncNoDownload": "All cloud files are synced or newer locally. Nothing to download.",
      "confirmSyncDeleteTitle": "Confirm Sync Deletion",
      "confirmSyncDeleteMessage": "{count} of the selected files also exist on the {location}. Do you want to delete them from there as well?",
      "webdavRequired": "Please configure WebDAV first",
      "localPathRequired": "Please configure local chat path first",
      "continueConfirm": "Continue?",
      "restoreChat": "Restore Chat"
    }
  },
  "prompts": {
    "allPrompts": "ALL",
    "searchPlaceholder": "Search name or content...",
    "noPrompts": "No prompts defined yet.",
    "noPromptsInTag": "No prompts in this tag.",
    "addExistingPrompt": "Add Existing Prompt",
    "addNewPrompt": "Add New Prompt",
    "editPrompt": "Edit Prompt",
    "addNewTag": "Add New Tag",
    "assignPromptsToTag": "Add Prompts to '{tagName}'",
    "promptKeyLabel": "Name",
    "promptKeyPlaceholder": "e.g., CodeGeneration",
    "typeLabel": "Type",
    "iconLabel": "Icon",
    "iconUploadTip": "Supports {formats} format, max size {maxSize}.",
    "dragIconHere": "Drag ",
    "orClickToUpload": "or click",
    "disableAll": "Disable All",
    "enableAll": "Enable All",
    "openWindow": "Open Dialog Window",
    "deletePrompt": "Delete this Prompt",
    "inputPlaceholder": "Enter prompt content...",
    "selectNewModel": "Please select a new model",
    "icon": {
      "uploadText": "Drag/Paste\nClick to Upload",
      "downloadTooltip": "Download Icon",
      "removeTooltip": "Remove Icon"
    },
    "iconEditor": {
      "hint": "Drag to move / Scroll to scale",
      "scale": "Scale",
      "radius": "Radius",
      "cancel": "Cancel",
      "confirm": "Confirm"
    },
    "background": {
      "imageLabel": "Window Background Image (URL)",
      "imagePlaceholder": "Enter image link (http/https/data:image)",
      "opacityLabel": "Background Opacity",
      "blurLabel": "Background Blur"
    },
    "regex": {
      "label": "Custom Regex Match",
      "tooltip": "When the input type is 'Text', you can set a regular expression here to match specific content.1. Format must be /.../flags, e.g., /^https?:\\/\\// to match URLs.2. Important: Backslashes \\ in the expression must be escaped as \\\\.3. flags are optional, like i for case-insensitivity (e.g., /hello/i).4. Leave empty to match any text.Quick Reference:â€¢ . - Matches any character except newlineâ€¢ \\d - Matches any digitâ€¢ \\s - Matches any whitespace (space, tab, newline)â€¢ \\S - Matches any non-whitespaceâ€¢ \\w - Matches word characters (a-z, A-Z, 0-9, _)â€¢ [...] - Matches any character in the set, e.g., [abc]â€¢ * - Matches 0 or more timesâ€¢ + - Matches 1 or more timesâ€¢ ? - Matches 0 or 1 timeâ€¢ ^ - Matches start of stringâ€¢ $ - Matches end of string",
      "placeholder": "/.../flags (empty for any text)"
    },
    "typeOptions": {
      "general": "General",
      "text": "Text",
      "image": "Screenshot",
      "files": "Files"
    },
    "showModeLabel": "Show Mode",
    "showModeOptions": {
      "fastinput": "Fast Input",
      "window": "Standalone Window"
    },
    "promptKeyLabelShort": "Name",
    "modelLabel": "Model",
    "llmParametersLabel": "Model Parameters",
    "llmParametersRemark": "Only effective for the current Quick Prompt model; no longer effective after switching to other models",
    "AssistantParametersLabel": "Quick Prompt Parameters",
    "sendDirectLabel": "Direct Text/Screenshot Sending",
    "sendFileLabel": "Direct File Sending",
    "ifTextNecessary": "Add Text Info",
    "streamLabel": "Stream Responses",
    "enableTemperatureLabel": "Custom Temperature",
    "temperatureLabel": "Temperature Settings",
    "promptContentLabel": "Prompt Content",
    "enabledLabel": "Enabled",
    "addToTagLabel": "Add to Tag (Optional)",
    "addToTagPlaceholder": "Select tag (optional)",
    "tagNameLabel": "Tag Name",
    "selectPromptsToAddLabel": "Select Prompts to Add",
    "selectPromptsPlaceholder": "Choose prompts",
    "isAlwaysOnTopLabel": "Always on Top",
    "autoCloseOnBlurLabel": "Auto-close on Blur",
    "autoSaveChatLabel": "Auto-save Chat",
    "replaceModels": "Replace Models",
    "replaceModelsDialog": {
      "title": "Bulk Replace Models",
      "sourceModel": "Source Model",
      "targetModel": "Target Model"
    },
    "alerts": {
      "tagNameEmpty": "Tag name cannot be empty.",
      "tagExists": "Tag \"{tagName}\" already exists.",
      "promptKeyEmpty": "Prompt name cannot be empty.",
      "promptKeyExists": "Prompt name \"{newKey}\" already exists.",
      "targetTagNotFound": "Target tag not found.",
      "noPromptsToAssign": "No other prompts available to assign to this tag.",
      "invalidImageFormat": "Invalid image format. Please use {formats}.",
      "imageSizeTooLarge": "Image size exceeds {maxSize}.",
      "modelsReplacedSuccess": "Successfully replaced the model for {count} prompts.",
      "refreshSuccess": "Agent Prompts configuration has been refreshed!",
      "noIconToDownload": "No icon available to download.",
      "selectModels": "Please select source and target models.",
      "sameModels": "Source and target models cannot be the same.",
      "configFetchFailed": "Failed to fetch latest prompts settings, data might be stale.",
      "promptNotFound": "Prompt not found, it may have been deleted.",
      "saveFailed": "Configuration save failed, please try again.",
      "saveSettingFailed": "Save failed"
    },
    "tooltips": {
      "moveLeft": "Move Left",
      "moveRight": "Move Right",
      "removeFromTag": "Remove prompt from this tag",
      "sendDirect": "When enabled, selected text or screenshot will be sent directly to the AI.",
      "sendFile": "When enabled, selected files will be sent directly to the AI for processing.",
      "ifTextNecessary": "Once enabled, if the user sends an empty text message, a timestamp is added to ensure that every request contains text, satisfying the requirements of some service providers (e.g., Vertex).",
      "reasoningEffort": "Sets the computational budget for the model's reasoning process. Higher values may yield more thorough answers but increase latency and cost.",
      "isAlwaysOnTopTooltip": "Enable to keep the window always on top of other windows.",
      "autoCloseOnBlurTooltip": "Enable to close the standalone window when it loses focus.",
      "autoSaveChatTooltip": "When enabled, conversations will be automatically saved to local storage every 15 seconds (requires local chat path configured in settings).",
      "defaultMcpServers": "When set, the selected MCP services will be automatically enabled when this assistant is opened in a standalone window."
    },
    "voiceLabel": "Default Voice",
    "voicePlaceholder": "Select a voice or disable",
    "voiceTooltip": "Select a voice to enable speech output by default. The model must support speech output. Select 'Disable' to not use it.",
    "voiceOptions": {
      "off": "Disable"
    },
    "reasoningEffortLabel": "Reasoning Effort",
    "reasoningEffort": {
      "default": "Default",
      "low": "Low",
      "medium": "Medium",
      "high": "High"
    },
    "defaultMcpServersLabel": "MCP",
    "defaultMcpServersPlaceholder": "Select default MCP services for this assistant"
  },
  "mcp": {
    "title": "MCP Servers",
    "addServer": "Add MCP Server",
    "editJson": "Edit JSON",
    "noServers": "No MCP servers configured.",
    "searchPlaceholder": "Search name, description, provider or tags...",
    "noMatch": "No matching services found",
    "addServerTitle": "Add New MCP Server",
    "editServerTitle": "Edit MCP Server",
    "nameLabel": "Name",
    "descriptionLabel": "Description",
    "typeLabel": "Type",
    "activeLabel": "Active",
    "persistentOn": "Persistent connection ON",
    "persistentOff": "Persistent connection OFF",
    "testConnectionTooltip": "Test Connection / View Cached Tools",
    "refreshTooltip": "Force Refresh (Reconnect)",
    "connecting": "Connecting and fetching tool list...",
    "connectionSuccess": "Connected! Found {count} tools",
    "connectionFailed": "Connection Failed",
    "toolList": "Tool List:",
    "cached": "Cached",
    "noDescription": "No description",
    "noToolsProvided": "No tools provided by this service",
    "refreshConfig": "Refresh MCP Configuration",
    "typeOptions": {
      "stdio": "Stdio",
      "http": "Streamable HTTP",
      "sse": "SSE",
      "builtin": "Built-in"
    },
    "stdio": {
      "command": "Command",
      "args": "Arguments",
      "env": "Environment Variables"
    },
    "http": {
      "url": "Base URL",
      "headers": "Request Headers"
    },
    "advanced": "Advanced/Optional Settings",
    "registryUrl": "Registry URL",
    "providerName": "Provider Name",
    "providerUrl": "Provider URL",
    "logoUrl": "Logo URL",
    "tags": "Tags",
    "argsPlaceholder": "Enter one argument per line",
    "envPlaceholder": "KEY1: VALUE1\nKEY2: VALUE2",
    "headersPlaceholder": "Header-Name: Header-Value\nAuthorization: Bearer token",
    "tagsPlaceholder": "Enter tags separated by commas",
    "alerts": {
      "deleteConfirmTitle": "Confirm Deletion",
      "deleteConfirmText": "Are you sure you want to delete the MCP server '{name}'?",
      "saveSuccess": "MCP server saved successfully.",
      "saveFailed": "Failed to save MCP server.",
      "deleteSuccess": "MCP server deleted successfully.",
      "deleteFailed": "Failed to delete MCP server.",
      "invalidJson": "Invalid JSON format. Please check your input.",
      "jsonError": "JSON must be an object containing the \"mcpServers\" key.",
      "configCopied": "Server config copied to clipboard",
      "refreshSuccess": "MCP config refreshed!",
      "configInvalid": "Failed to get valid config data.",
      "refreshFailed": "Refresh failed, please try again later.",
      "testSuccess": "Connection successful.",
      "testFailed": "Connection failed. Please check your configuration."
    },
    "jsonDialog": {
      "title": "Edit MCP Servers JSON",
      "description": "Warning: Directly editing the JSON can cause issues if the format is incorrect. Proceed with caution."
    },
    "persistent": {
      "label": "Persistent Connection",
      "tooltip": "After enabling, a persistent connection will be maintained, which will occupy one slot of the total number of connections (up to 5). This is suitable for certain Stdio services that cannot be disconnected."
    },
    "tabs": {
      "tools": "Enabled Tools",
      "test": "Test Invocation"
    },
    "hints": {
      "selectTools": "Please select tools to enable"
    },
    "test": {
      "selectTool": "Select Tool:",
      "selectToolPlaceholder": "Select a tool to test",
      "run": "Run",
      "cancel": "Cancel",
      "noParams": "No parameters required",
      "paramErrorJson": "Parameter {key} format error: Must be valid JSON",
      "paramErrorNumber": "Parameter {key} format error: Must be a number",
      "successNoContent": "Execution successful, no content returned.",
      "executionError": "Execution Error: ",
      "systemError": "System Error: ",
      "opCancelled": "Operation cancelled",
      "saveToolStateFailed": "Failed to save tool state",
      "inputJsonPlaceholder": "Enter JSON formatted {type}",
      "inputPlaceholder": "Enter parameter value",
      "default": "Default",
      "leaveEmpty": "Leave empty for default",
      "response": "Response Result:"
    }
  },
  "providers": {
    "addProviderBtn": "Add Provider",
    "noProviders": "No providers yet.",
    "statusOff": "Off",
    "unnamedProvider": "Unnamed Provider",
    "editNameTooltip": "Edit Name",
    "moveUpTooltip": "Move Up",
    "moveDownTooltip": "Move Down",
    "deleteProviderTooltip": "Delete Provider",
    "apiKeyLabel": "API Key",
    "apiKeyPlaceholder": "Enter API Key (multiple can be entered, separated by commas)",
    "apiKeyDescription": "You can enter multiple API keys separated by commas.",
    "apiUrlLabel": "API URL",
    "apiUrlPlaceholder": "e.g., https://api.openai.com/v1",
    "modelsLabel": "Models",
    "searchModelsPlaceholder": "Search models",
    "noModelsAdded": "No models added yet.",
    "getModelsFromApiBtn": "Get Models from API",
    "addManuallyBtn": "Add Manually",
    "selectProviderOrAdd": "Select a provider or add a new one",
    "addProviderDialogTitle": "Add New Provider",
    "providerNameLabel": "Provider Name",
    "providerNamePlaceholder": "e.g., OpenAI Main Account",
    "changeProviderNameDialogTitle": "Change Provider Name",
    "addModelDialogTitle": "Add Model Manually",
    "modelNameIdLabel": "Model Name/ID",
    "modelNameIdPlaceholder": "e.g., gpt-4, text-davinci-003",
    "availableModelsDialogTitle": "Available Models from API",
    "table": {
      "modelId": "Model ID",
      "ownedBy": "Owned By",
      "action": "Action"
    },
    "folders": {
      "createSuccess": "Directory created successfully",
      "renameSuccess": "Directory renamed successfully",
      "deleteSuccess": "Directory deleted",
      "deleteConfirmTitle": "Confirm Deletion",
      "deleteConfirmMessage": "Are you sure you want to delete this directory? Providers inside will move to root.",
      "floder_label": "Folder",
      "root": "Root",
      "empty": "(Empty)",
      "newFolderTitle": "New Directory",
      "renameFolderTitle": "Rename Directory",
      "folderNameLabel": "Directory Name",
      "folderNamePlaceholder": "Enter name"
    },
    "noModelsFoundError": "No models found or API error.",
    "noModelsMatchSearch": "No models match search.",
    "addModelTooltip": "Add Model",
    "removeModelTooltip": "Remove Model",
    "alerts": {
      "providerUrlNotSet": "Provider URL is not set.",
      "fetchModelsError": "Error {status}: {message}",
      "fetchModelsFailedDefault": "Failed to fetch models.",
      "configSaveFailed": "Failed to save configuration.",
      "saveFailed": "Save failed"
    }
  },
  "setting": {
    "language": {
      "label": "Language",
      "english": "English",
      "chinese": "ä¸­æ–‡",
      "japanese": "æ—¥æœ¬èª",
      "russian": "Ğ ÑƒÑÑĞºĞ¸Ğ¹",
      "selectPlaceholder": "Select Language"
    },
    "voice": {
      "title": "Voice Settings  (Voice Name - Custom Description)",
      "description": "Manage the list of voices available for speech synthesis.",
      "add": "Add Voice",
      "addPromptTitle": "Add New Voice",
      "addPromptMessage": "Please enter the voice name (e.g., alloy).",
      "addSuccess": "Voice added successfully.",
      "addFailExists": "Voice already exists.",
      "addFailEmpty": "Voice name cannot be empty.",
      "editPromptTitle": "Edit Voice Name",
      "editPromptMessage": "Please enter the new voice name",
      "editSuccess": "Voice modified successfully"
    },
    "title": "General Settings",
    "isAlwaysOnTop_global": {
      "label": "Global Always on Top",
      "description": "Globally control whether all assistant windows are always on top"
    },
    "autoCloseOnBlur_global": {
      "label": "Global Auto-close on Blur",
      "description": "Globally control whether all assistant windows close automatically on blur"
    },
    "autoSaveChat_global": {
      "label": "Global Auto-save Chat",
      "description": "Globally control whether all assistants automatically save chats locally"
    },
    "skipLineBreak": {
      "label": "Skip Line Breaks on Send",
      "description": "Enable to skip line breaks when selecting text."
    },
    "ctrlEnter": {
      "label": "Ctrl+Enter to Send",
      "description": "Enable to send messages by pressing Ctrl+Enter."
    },
    "notification": {
      "label": "Show Success Notification",
      "description": "Enable to show a notification on successful response."
    },
    "darkMode": {
      "label": "Theme",
      "description": "Light mode or dark mode",
      "dark": "Dark",
      "light": "Light",
      "system": "Follow System"
    },
    "fixPosition": {
      "label": "Fix Window Position",
      "description": "Enable to fix the position where the dialog window appears."
    },
    "dataManagement": {
      "title": "Data Management",
      "exportLabel": "Export Configuration",
      "exportDesc": "Export all current settings to a JSON file. Note: The configuration file contains sensitive information, do not share it.",
      "exportButton": "Export",
      "importLabel": "Import Configuration",
      "importDesc": "Import settings from a JSON file. This will overwrite current settings.",
      "importButton": "Import"
    },
    "dimensions": {
      "widthLabel": "Window Width (px)",
      "heightLabel": "Window Height (px)"
    },
    "webdav": {
      "url": "WebDAV URL",
      "urlPlaceholder": "http://localhost:8080",
      "username": "WebDAV Username",
      "usernamePlaceholder": "WebDAV Username",
      "password": "WebDAV Password",
      "passwordPlaceholder": "WebDAV Password",
      "path": "WebDAV Config Path",
      "pathPlaceholder": "/anywhere",
      "dataPath": "WebDAV Data Path",
      "dataPathPlaceholder": "/anywhere_data",
      "backupRestoreTitle": "Config Backup & Restore",
      "backupButton": "Backup to WebDAV",
      "restoreButton": "Manage Backups",
      "localChatPath": "Local Chat Path",
      "localChatPathPlaceholder": "Please select a local folder to store chat history",
      "selectFolder": "Select Folder",
      "webdavDescription": "Please configure WebDAV URL and data path in 'Settings' first",
      "backup": {
        "confirmTitle": "Confirm Backup Filename",
        "confirmMessage": "Please enter the backup filename. It is recommended to use the default name to keep the timestamp.",
        "invalidFilename": "Invalid filename, must end with .json.",
        "cancelled": "Backup cancelled.",
        "emptyFilenameError": "Filename cannot be empty.",
        "inputFilename": "Please enter filename"
      },
      "manager": {
        "title": "Backup Data Management",
        "pathNotFound": "The specified WebDAV path does not exist.",
        "fetchFailed": "Failed to fetch backup list.",
        "filename": "Filename",
        "modifiedTime": "Modified Time",
        "size": "Size",
        "actions": "Actions",
        "restore": "Restore",
        "delete": "Delete",
        "confirmRestore": "Are you sure you want to restore this backup file '{filename}'? This will overwrite your current configuration.",
        "confirmDelete": "Are you sure you want to permanently delete the file '{filename}'?",
        "noFileSelected": "No files selected.",
        "confirmDeleteMultiple": "Are you sure you want to permanently delete the {count} selected files?",
        "deleteSuccess": "Deleted successfully.",
        "deleteFailed": "Deletion failed.",
        "deleteSuccessMultiple": "Selected files deleted successfully.",
        "deleteFailedMultiple": "Error deleting selected files."
      },
      "alerts": {
        "urlRequired": "WebDAV URL cannot be empty.",
        "backupInProgress": "Backing up...",
        "backupSuccess": "Backup successful.",
        "backupFailed": "Backup failed.",
        "fileNotFound": "Backup file not found.",
        "restoreInProgress": "Restoring...",
        "restoreSuccess": "Restore successful.",
        "restoreFailed": "Restore failed."
      }
    },
    "alerts": {
      "importSuccess": "Configuration imported successfully.",
      "importFailed": "Configuration import failed.",
      "saveSuccess": "Saved successfully!",
      "saveFailedPrefix": "Failed to save setting: "
    }
  },
  "common": {
    "cancel": "Cancel",
    "confirm": "Confirm",
    "add": "Add",
    "delete": "Delete",
    "edit": "Edit",
    "save": "Save",
    "close": "Close",
    "assignSelected": "Assign Selected",
    "addTag": "Add Tag",
    "removeIcon": "Remove",
    "downloadIcon": "Download",
    "warningTitle": "Warning",
    "refresh": "Refresh",
    "deleteSelected": "Delete",
    "noFileSelected": "No files selected.",
    "confirmDeleteMultiple": "Are you sure you want to permanently delete the {count} selected files?",
    "deleteSuccess": "Deleted successfully.",
    "deleteFailed": "Deletion failed.",
    "deleteSuccessMultiple": "Selected files deleted successfully.",
    "deleteFailedMultiple": "Error deleting selected files."
  }
}
```
```json
./Anywhere_main/src/locales/ja.json
{
  "app": {
    "header": {
      "chats": "å¯¾è©± ğŸ’¬",
      "prompts": "ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ ğŸš€",
      "mcp": "MCPã‚µãƒ¼ãƒãƒ¼ ğŸ”§",
      "providers": "ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ â˜ï¸",
      "settings": "è¨­å®š âš™ï¸"
    },
    "tabs": {
      "chats": "éå»ã®å¯¾è©±",
      "prompts": "ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",
      "mcp": "MCPã‚µãƒ¼ãƒãƒ¼",
      "providers": "ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼",
      "settings": "è¨­å®š"
    }
  },
  "chats": {
    "view": {
      "local": "ãƒ­ãƒ¼ã‚«ãƒ«å¯¾è©±",
      "cloud": "ã‚¯ãƒ©ã‚¦ãƒ‰å¯¾è©±"
    },
    "info": {
      "title": "æƒ…å ±",
      "localDesc": "Â· ãƒ­ãƒ¼ã‚«ãƒ«å¯¾è©±ï¼šåå‰ä»˜ãã®ä¼šè©±ï¼ˆä¿å­˜æ¸ˆã¿ã€JSONã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã€ã¾ãŸã¯ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰é–‹ã„ãŸã‚‚ã®ï¼‰ã¯15ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã™ã¹ã¦ã®ä¼šè©±ã¯ {path} ã«JSONå½¢å¼ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒã‚¤ã‚¹ã”ã¨ã«ç•°ãªã‚‹ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚",
      "pathNotSet": "æœªè¨­å®š",
      "cloudDesc": "Â· ã‚¯ãƒ©ã‚¦ãƒ‰å¯¾è©±ï¼šã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸä¼šè©±ã§ã€ã„ã¤ã§ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ—ãƒ«ã§ãã¾ã™ã€‚"
    },
    "configRequired": {
      "title": "ã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒ£ãƒƒãƒˆ",
      "webdavDescription": "ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã€Œè¨­å®šã€ã§WebDAV URLã¨ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ï¼ˆdata_pathï¼‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚",
      "localPathDescription": "ã¾ãšã€Œè¨­å®šã€ãƒšãƒ¼ã‚¸ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ£ãƒƒãƒˆã®ä¿å­˜ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„"
    },
    "table": {
      "filename": "ãƒãƒ£ãƒƒãƒˆå",
      "modifiedTime": "æ›´æ–°æ—¥æ™‚",
      "size": "ã‚µã‚¤ã‚º",
      "actions": "æ“ä½œ"
    },
    "actions": {
      "chat": "ãƒãƒ£ãƒƒãƒˆ",
      "rename": "åå‰ã‚’å¤‰æ›´",
      "delete": "å‰Šé™¤",
      "forceSync": "åŒæœŸ"
    },
    "rename": {
      "promptTitle": "ãƒãƒ£ãƒƒãƒˆã®åå‰ã‚’å¤‰æ›´",
      "promptMessage": "æ–°ã—ã„ä¼šè©±åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      "invalidFilename": "ãƒ•ã‚¡ã‚¤ãƒ«åãŒç„¡åŠ¹ã§ã™ã€‚'.json'ã§çµ‚ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚",
      "syncTitle": "åŒæœŸæ“ä½œã®ç¢ºèª",
      "syncCloudConfirm": "ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚‚åŒåã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™ã€‚åŒæœŸã—ã¦åå‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ",
      "syncLocalConfirm": "ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚åŒåã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™ã€‚åŒæœŸã—ã¦åå‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ"
    },
    "tooltips": {
      "syncToCloud": "ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
      "syncFromCloud": "ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰åŒæœŸ",
      "uploadChanges": "ãƒ­ãƒ¼ã‚«ãƒ«ã®æ–°è¦ãŠã‚ˆã³æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ{count}å€‹ï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
      "downloadChanges": "ã‚¯ãƒ©ã‚¦ãƒ‰ã®æ–°è¦ãŠã‚ˆã³æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ{count}å€‹ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
      "forceUpload": "ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«å¼·åˆ¶ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆä¸Šæ›¸ãï¼‰",
      "forceDownload": "ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å¼·åˆ¶ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä¸Šæ›¸ãï¼‰"
    },
    "confirmDelete": "ãƒãƒ£ãƒƒãƒˆ '{filename}' ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
    "clean": {
      "button": "å¤ã„å¯¾è©±ã‚’æ•´ç†",
      "title": "å¯¾è©±ã®è‡ªå‹•æ•´ç†",
      "timeRangeLabel": "ä¿æŒæœŸé–“ã‚’é¸æŠ",
      "customDaysLabel": "ã‚«ã‚¹ã‚¿ãƒ æ—¥æ•°",
      "previewTitle": "{days}æ—¥å‰ã®å¯¾è©± {count} ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ ({size})",
      "noFilesFound": "æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹å¤ã„å¯¾è©±ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ",
      "confirmBtn": "æ•´ç†ã‚’å®Ÿè¡Œ",
      "success": "{count} å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ",
      "ranges": {
        "3": "3æ—¥ä»¥ä¸Šå‰",
        "7": "7æ—¥ä»¥ä¸Šå‰",
        "30": "30æ—¥ä»¥ä¸Šå‰",
        "custom": "ã‚«ã‚¹ã‚¿ãƒ "
      },
      "scopeTip": "æ³¨æ„ï¼šã“ã®æ“ä½œã¯ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ï¼ˆ{view}ï¼‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å‰Šé™¤ã—ã€ã‚‚ã†ä¸€æ–¹ã®ç«¯ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯åŒæœŸå‰Šé™¤ã—ã¾ã›ã‚“ã€‚"
    },
    "alerts": {
      "configError": "è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      "pathNotFound": "æŒ‡å®šã•ã‚ŒãŸWebDAVãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚",
      "pathCreated": "ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚",
      "fetchFailed": "ãƒãƒ£ãƒƒãƒˆãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      "loadingChat": "ãƒãƒ£ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...",
      "restoreInitiated": "ãƒãƒ£ãƒƒãƒˆãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚",
      "restoreFailed": "ãƒãƒ£ãƒƒãƒˆã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      "renameSuccess": "åå‰ã®å¤‰æ›´ã«æˆåŠŸã—ã¾ã—ãŸã€‚",
      "renameFailed": "åå‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      "syncInProgress": "åŒæœŸä¸­...",
      "syncPreparingUpload": "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...",
      "syncPreparingDownload": "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...",
      "syncProcessing": "å‡¦ç†ä¸­... {completed}/{total}",
      "syncCancelled": "åŒæœŸæ“ä½œãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ",
      "syncSuccessUpload": "{count}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«æ­£å¸¸ã«åŒæœŸã—ã¾ã—ãŸã€‚",
      "syncSuccessDownload": "{count}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰æ­£å¸¸ã«åŒæœŸã—ã¾ã—ãŸã€‚",
      "syncFailedPartially": "{failedCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚",
      "syncFailed": "åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ: {message}",
      "syncConfirmUpload": "ã“ã‚Œã«ã‚ˆã‚Šã€ã™ã¹ã¦ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¼šè©±ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€åŒåã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ",
      "syncConfirmUploadTitle": "ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
      "syncConfirmDownload": "ã“ã‚Œã«ã‚ˆã‚Šã€ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¦ãƒ‰ä¼šè©±ãŒãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€åŒåã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ",
      "syncConfirmDownloadTitle": "ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰åŒæœŸ",
      "syncNoUpload": "ã™ã¹ã¦ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ€æ–°ã§ã‚ã‚‹ã‹ã€ã‚¯ãƒ©ã‚¦ãƒ‰ç‰ˆã®æ–¹ãŒæ–°ã—ã„ãŸã‚ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ä¸è¦ã§ã™ã€‚",
      "syncNoDownload": "ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã¯åŒæœŸæ¸ˆã¿ã§ã‚ã‚‹ã‹ã€ãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆã®æ–¹ãŒæ–°ã—ã„ãŸã‚ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ä¸è¦ã§ã™ã€‚",
      "confirmSyncDeleteTitle": "åŒæœŸå‰Šé™¤ã®ç¢ºèª",
      "confirmSyncDeleteMessage": "é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã†ã¡{count}å€‹ãŒ{location}ã«ã‚‚å­˜åœ¨ã—ã¾ã™ã€‚ãã¡ã‚‰ã‚‚ä¸€ç·’ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
      "webdavRequired": "WebDAVã‚’å…ˆã«è¨­å®šã—ã¦ãã ã•ã„",
      "localPathRequired": "ãƒ­ãƒ¼ã‚«ãƒ«ã®ä¼šè©±ãƒ‘ã‚¹ã‚’å…ˆã«è¨­å®šã—ã¦ãã ã•ã„",
      "continueConfirm": "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ",
      "restoreChat": "ãƒãƒ£ãƒƒãƒˆã‚’å¾©å…ƒ"
    }
  },
  "prompts": {
    "allPrompts": "å…¨éƒ¨",
    "searchPlaceholder": "åå‰ã¾ãŸã¯å†…å®¹ã‚’æ¤œç´¢...",
    "noPrompts": "ã¾ã ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¯å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
    "noPromptsInTag": "ã“ã®ã‚¿ã‚°ã«ã¯ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
    "addExistingPrompt": "æ—¢å­˜ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’è¿½åŠ ",
    "addNewPrompt": "æ–°ã—ã„ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’è¿½åŠ ",
    "editPrompt": "ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’ç·¨é›†",
    "addNewTag": "æ–°ã—ã„ã‚¿ã‚°ã‚’è¿½åŠ ",
    "assignPromptsToTag": "'{tagName}' ã«ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’è¿½åŠ ",
    "promptKeyLabel": "åç§°",
    "promptKeyPlaceholder": "ä¾‹ï¼šCodeGeneration",
    "typeLabel": "ã‚¿ã‚¤ãƒ—",
    "iconLabel": "ã‚¢ã‚¤ã‚³ãƒ³",
    "iconUploadTip": "{formats}å½¢å¼ã‚’ã‚µãƒãƒ¼ãƒˆã€æœ€å¤§{maxSize}ã€‚",
    "dragIconHere": "ãƒ‰ãƒ©ãƒƒã‚°",
    "orClickToUpload": "ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯",
    "disableAll": "ã™ã¹ã¦ç„¡åŠ¹",
    "enableAll": "ã™ã¹ã¦æœ‰åŠ¹",
    "openWindow": "å¯¾è©±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã",
    "deletePrompt": "ã“ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’å‰Šé™¤",
    "inputPlaceholder": "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã‚’å…¥åŠ›...",
    "selectNewModel": "æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„",
    "icon": {
      "uploadText": "ãƒ‰ãƒ©ãƒƒã‚°/è²¼ã‚Šä»˜ã‘\nã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
      "downloadTooltip": "ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
      "removeTooltip": "ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤"
    },
    "iconEditor": {
      "hint": "ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹• / ãƒ›ã‚¤ãƒ¼ãƒ«ã§æ‹¡å¤§ç¸®å°",
      "scale": "æ‹¡å¤§ç¸®å°",
      "radius": "è§’ä¸¸",
      "cancel": "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
      "confirm": "ä½¿ç”¨ã™ã‚‹"
    },
    "background": {
      "imageLabel": "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦èƒŒæ™¯ç”»åƒ (URL)",
      "imagePlaceholder": "ç”»åƒãƒªãƒ³ã‚¯ã‚’å…¥åŠ› (http/https/data:image)",
      "opacityLabel": "èƒŒæ™¯ã®ä¸é€æ˜åº¦",
      "blurLabel": "èƒŒæ™¯ã®ã¼ã‹ã—"
    },
    "regex": {
      "label": "ã‚«ã‚¹ã‚¿ãƒ æ­£è¦è¡¨ç¾",
      "tooltip": "å…¥åŠ›ã‚¿ã‚¤ãƒ—ãŒã€Œãƒ†ã‚­ã‚¹ãƒˆã€ã®å ´åˆã€ã“ã“ã§æ­£è¦è¡¨ç¾ã‚’è¨­å®šã—ã¦ç‰¹å®šã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ãƒãƒƒãƒã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚1. ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ /.../flags ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ï¼š/^https?:\\/\\// ã¯URLã«ãƒãƒƒãƒã—ã¾ã™ã€‚2. é‡è¦ï¼šå¼ä¸­ã®ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ \\ ã¯ \\\\ ã¨ã—ã¦ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚3. flags ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ•ãƒ©ã‚°ã§ã™ã€‚ä¾‹ãˆã° i ã¯å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ã¾ã›ã‚“ (ä¾‹: /hello/i)ã€‚4. ç©ºç™½ã®ã¾ã¾ã«ã™ã‚‹ã¨ã€ä»»æ„ã®ãƒ†ã‚­ã‚¹ãƒˆã«ãƒãƒƒãƒã—ã¾ã™ã€‚ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹:â€¢ . - æ”¹è¡Œã‚’é™¤ãä»»æ„ã®1æ–‡å­—â€¢ \\d - ä»»æ„ã®æ•°å­—â€¢ \\s - ä»»æ„ã®ç©ºç™½æ–‡å­— (ã‚¹ãƒšãƒ¼ã‚¹, ã‚¿ãƒ–, æ”¹è¡Œ)â€¢ \\S - ä»»æ„ã®éç©ºç™½æ–‡å­—â€¢ \\w - å˜èªæ§‹æˆæ–‡å­— (è‹±æ•°å­—, _)â€¢ [...] - ã‚«ãƒƒã‚³å†…ã®ã„ãšã‚Œã‹1æ–‡å­—, ä¾‹ [abc]â€¢ * - 0å›ä»¥ä¸Šâ€¢ + - 1å›ä»¥ä¸Šâ€¢ ? - 0å›ã¾ãŸã¯1å›â€¢ ^ - å…ˆé ­ã«ãƒãƒƒãƒâ€¢ $ - æœ«å°¾ã«ãƒãƒƒãƒ",
      "placeholder": "/.../flags (ç©ºã®å ´åˆã¯ä»»æ„ãƒ†ã‚­ã‚¹ãƒˆ)"
    },
    "typeOptions": {
      "general": "æ±ç”¨",
      "text": "ãƒ†ã‚­ã‚¹ãƒˆ",
      "image": "ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ",
      "files": "ãƒ•ã‚¡ã‚¤ãƒ«"
    },
    "showModeLabel": "è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰",
    "showModeOptions": {
      "fastinput": "é«˜é€Ÿå…¥åŠ›",
      "window": "ç‹¬ç«‹ã—ãŸã‚¦ã‚£ãƒ³ãƒ‰ã‚¦"
    },
    "promptKeyLabelShort": "åå‰",
    "modelLabel": "ãƒ¢ãƒ‡ãƒ«",
    "llmParametersLabel": "ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿",
    "llmParametersRemark": "ç¾åœ¨ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¢ãƒ‡ãƒ«ã«ã®ã¿æœ‰åŠ¹ã€ä»–ã®ãƒ¢ãƒ‡ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ç„¡åŠ¹ã«ãªã‚Šã¾ã™",
    "AssistantParametersLabel": "ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿",
    "sendDirectLabel": "ãƒ†ã‚­ã‚¹ãƒˆ/ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç›´æ¥é€ä¿¡",
    "sendFileLabel": "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é€ä¿¡",
    "ifTextNecessary": "ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’è£œè¶³",
    "streamLabel": "ã‚¹ãƒˆãƒªãƒ¼ãƒ å¿œç­”",
    "enableTemperatureLabel": "ã‚«ã‚¹ã‚¿ãƒ æ¸©åº¦",
    "temperatureLabel": "æ¸©åº¦è¨­å®š",
    "promptContentLabel": "ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå†…å®¹",
    "enabledLabel": "æœ‰åŠ¹",
    "addToTagLabel": "ã‚¿ã‚°ã«è¿½åŠ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰",
    "addToTagPlaceholder": "ã‚¿ã‚°ã‚’é¸æŠï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰",
    "tagNameLabel": "ã‚¿ã‚°å",
    "selectPromptsToAddLabel": "è¿½åŠ ã™ã‚‹ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’é¸æŠ",
    "selectPromptsPlaceholder": "ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’é¸æŠ",
    "isAlwaysOnTopLabel": "å¸¸ã«æœ€å‰é¢ã«è¡¨ç¤º",
    "autoCloseOnBlurLabel": "ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸã‚‰é–‰ã˜ã‚‹",
    "autoSaveChatLabel": "ãƒãƒ£ãƒƒãƒˆè‡ªå‹•ä¿å­˜",
    "replaceModels": "ãƒ¢ãƒ‡ãƒ«ã‚’ç½®æ›",
    "replaceModelsDialog": {
      "title": "ãƒ¢ãƒ‡ãƒ«ã®ä¸€æ‹¬ç½®æ›",
      "sourceModel": "å…ƒã®ãƒ¢ãƒ‡ãƒ«",
      "targetModel": "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¢ãƒ‡ãƒ«"
    },
    "alerts": {
      "tagNameEmpty": "ã‚¿ã‚°åã¯ç©ºã«ã§ãã¾ã›ã‚“ã€‚",
      "tagExists": "ã‚¿ã‚°ã€Œ{tagName}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚",
      "promptKeyEmpty": "ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåã¯ç©ºã«ã§ãã¾ã›ã‚“ã€‚",
      "promptKeyExists": "ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåã€Œ{newKey}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚",
      "targetTagNotFound": "å¯¾è±¡ã®ã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚",
      "noPromptsToAssign": "ã“ã®ã‚¿ã‚°ã«å‰²ã‚Šå½“ã¦ã‚‹ä»–ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
      "invalidImageFormat": "ç„¡åŠ¹ãªç”»åƒå½¢å¼ã§ã™ã€‚{formats}ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚",
      "imageSizeTooLarge": "ç”»åƒã‚µã‚¤ã‚ºãŒ{maxSize}ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚",
      "modelsReplacedSuccess": "{count}å€‹ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ãƒ¢ãƒ‡ãƒ«ã‚’æ­£å¸¸ã«ç½®æ›ã—ã¾ã—ãŸã€‚",
      "refreshSuccess": "ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®è¨­å®šãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼",
      "noIconToDownload": "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
      "selectModels": "ã‚½ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",
      "sameModels": "ã‚½ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¢ãƒ‡ãƒ«ã‚’åŒã˜ã«ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚",
      "configFetchFailed": "æœ€æ–°ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆè¨­å®šã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒå¤ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
      "promptNotFound": "ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
      "saveFailed": "è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚",
      "saveSettingFailed": "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"
    },
    "tooltips": {
      "moveLeft": "å·¦ã«ç§»å‹•",
      "moveRight": "å³ã«ç§»å‹•",
      "removeFromTag": "ã“ã®ã‚¿ã‚°ã‹ã‚‰ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’å‰Šé™¤",
      "sendDirect": "æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€é¸æŠã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚„ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒç›´æ¥AIã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚",
      "sendFile": "æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç›´æ¥AIã«é€ä¿¡ã•ã‚Œã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚",
      "ifTextNecessary": "æœ‰åŠ¹åŒ–ã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç©ºã®ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸå ´åˆã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ†ã‚­ã‚¹ãƒˆãŒå«ã¾ã‚Œã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã€ä¸€éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆä¾‹ï¼šVertexï¼‰ã®è¦ä»¶ãŒæº€ãŸã•ã‚Œã¾ã™ã€‚",
      "reasoningEffort": "ãƒ¢ãƒ‡ãƒ«ã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã®è¨ˆç®—äºˆç®—ã‚’è¨­å®šã—ã¾ã™ã€‚é«˜ã„å€¤ã¯ã‚ˆã‚Šè©³ç´°ãªå›ç­”ã‚’ã‚‚ãŸã‚‰ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€é…å»¶ã¨ã‚³ã‚¹ãƒˆãŒå¢—åŠ ã—ã¾ã™ã€‚",
      "isAlwaysOnTopTooltip": "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’å¸¸ã«ä»–ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤ºã—ã¾ã™ã€‚",
      "autoCloseOnBlurTooltip": "ç‹¬ç«‹ã—ãŸã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤±ã£ãŸã¨ãã«è‡ªå‹•çš„ã«é–‰ã˜ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚",
      "autoSaveChatTooltip": "ã‚ªãƒ³ã«ã™ã‚‹ã¨ã€ãƒãƒ£ãƒƒãƒˆã¯15ç§’ã”ã¨ã«ãƒ­ãƒ¼ã‚«ãƒ«ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆè¨­å®šã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ£ãƒƒãƒˆãƒ‘ã‚¹ã®è¨­å®šãŒå¿…è¦ï¼‰ã€‚",
      "defaultMcpServers": "è¨­å®šã™ã‚‹ã¨ã€ã“ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã„ãŸã¨ãã«ã€é¸æŠã—ãŸMCPã‚µãƒ¼ãƒ“ã‚¹ãŒè‡ªå‹•çš„ã«æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚"
    },
    "voiceLabel": "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³å£°",
    "voicePlaceholder": "éŸ³å£°ã‚’é¸æŠã¾ãŸã¯ç„¡åŠ¹åŒ–",
    "voiceTooltip": "éŸ³å£°ã‚’é¸æŠã™ã‚‹ã¨ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éŸ³å£°å‡ºåŠ›ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ãŒéŸ³å£°å‡ºåŠ›ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã€Œç„¡åŠ¹åŒ–ã€ã‚’é¸æŠã™ã‚‹ã¨ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚",
    "voiceOptions": {
      "off": "ç„¡åŠ¹åŒ–"
    },
    "reasoningEffortLabel": "æ€è€ƒé‡",
    "reasoningEffort": {
      "default": "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ",
      "low": "ä½",
      "medium": "ä¸­",
      "high": "é«˜"
    },
    "defaultMcpServersLabel": "MCP",
    "defaultMcpServersPlaceholder": "ã“ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ã«ã™ã‚‹MCPã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠ"
  },
  "mcp": {
    "title": "MCPã‚µãƒ¼ãƒãƒ¼",
    "addServer": "MCPã‚µãƒ¼ãƒãƒ¼ã‚’è¿½åŠ ",
    "editJson": "JSONã‚’ç·¨é›†",
    "noServers": "MCPã‚µãƒ¼ãƒãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
    "searchPlaceholder": "åå‰ã€èª¬æ˜ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã€ã¾ãŸã¯ã‚¿ã‚°ã§æ¤œç´¢...",
    "noMatch": "ä¸€è‡´ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",
    "addServerTitle": "æ–°ã—ã„MCPã‚µãƒ¼ãƒãƒ¼ã‚’è¿½åŠ ",
    "editServerTitle": "MCPã‚µãƒ¼ãƒãƒ¼ã‚’ç·¨é›†",
    "nameLabel": "åå‰",
    "descriptionLabel": "èª¬æ˜",
    "typeLabel": "ã‚¿ã‚¤ãƒ—",
    "activeLabel": "æœ‰åŠ¹",
    "persistentOn": "æ°¸ç¶šæ¥ç¶šã‚ªãƒ³",
    "persistentOff": "æ°¸ç¶šæ¥ç¶šã‚ªãƒ•",
    "testConnectionTooltip": "æ¥ç¶šãƒ†ã‚¹ãƒˆ / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ„ãƒ¼ãƒ«è¡¨ç¤º",
    "refreshTooltip": "å¼·åˆ¶æ›´æ–°ï¼ˆå†æ¥ç¶šï¼‰",
    "connecting": "æ¥ç¶šã—ã¦ãƒ„ãƒ¼ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—ä¸­...",
    "connectionSuccess": "æ¥ç¶šæˆåŠŸï¼ {count} å€‹ã®ãƒ„ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¾ã—ãŸ",
    "connectionFailed": "æ¥ç¶šå¤±æ•—",
    "toolList": "ãƒ„ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ:",
    "cached": "ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿",
    "noDescription": "èª¬æ˜ãªã—",
    "noToolsProvided": "ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ãƒ„ãƒ¼ãƒ«ã‚’æä¾›ã—ã¦ã„ã¾ã›ã‚“",
    "refreshConfig": "MCPè¨­å®šã‚’æ›´æ–°",
    "typeOptions": {
      "stdio": "Stdio",
      "http": "ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°HTTP",
      "sse": "SSE",
      "builtin": "çµ„ã¿è¾¼ã¿"
    },
    "stdio": {
      "command": "ã‚³ãƒãƒ³ãƒ‰",
      "args": "å¼•æ•°",
      "env": "ç’°å¢ƒå¤‰æ•°"
    },
    "http": {
      "url": "ãƒ™ãƒ¼ã‚¹URL",
      "headers": "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼"
    },
    "advanced": "è©³ç´°/ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š",
    "registryUrl": "ãƒ¬ã‚¸ã‚¹ãƒˆãƒªURL",
    "providerName": "ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å",
    "providerUrl": "ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼URL",
    "logoUrl": "ãƒ­ã‚´URL",
    "tags": "ã‚¿ã‚°",
    "argsPlaceholder": "å¼•æ•°ã‚’1è¡Œã«1ã¤ãšã¤å…¥åŠ›",
    "envPlaceholder": "KEY1: VALUE1\nKEY2: VALUE2",
    "headersPlaceholder": "Header-Name: Header-Value\nAuthorization: Bearer token",
    "tagsPlaceholder": "ã‚¿ã‚°ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›",
    "alerts": {
      "deleteConfirmTitle": "å‰Šé™¤ã®ç¢ºèª",
      "deleteConfirmText": "æœ¬å½“ã«MCPã‚µãƒ¼ãƒãƒ¼ã€Œ{name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
      "saveSuccess": "MCPã‚µãƒ¼ãƒãƒ¼ã®ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸã€‚",
      "saveFailed": "MCPã‚µãƒ¼ãƒãƒ¼ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      "deleteSuccess": "MCPã‚µãƒ¼ãƒãƒ¼ã®å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸã€‚",
      "deleteFailed": "MCPã‚µãƒ¼ãƒãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      "invalidJson": "ç„¡åŠ¹ãªJSONå½¢å¼ã§ã™ã€‚å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
      "jsonError": "JSONã¯ \"mcpServers\" ã‚­ãƒ¼ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚",
      "configCopied": "ã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ",
      "refreshSuccess": "MCPè¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸï¼",
      "configInvalid": "æœ‰åŠ¹ãªè¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚",
      "refreshFailed": "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
      "testSuccess": "ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸã€‚",
      "testFailed": "ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    },
    "jsonDialog": {
      "title": "MCPã‚µãƒ¼ãƒãƒ¼ã®JSONã‚’ç·¨é›†",
      "description": "è­¦å‘Šï¼šJSONã‚’ç›´æ¥ç·¨é›†ã™ã‚‹ã¨ã€å½¢å¼ãŒæ­£ã—ããªã„å ´åˆã«å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ³¨æ„ã—ã¦é€²ã‚ã¦ãã ã•ã„ã€‚"
    },
    "persistent": {
      "label": "æ°¸ç¶šæ¥ç¶š",
      "tooltip": "æœ‰åŠ¹åŒ–ã™ã‚‹ã¨ã€é•·æ™‚é–“æ¥ç¶šãŒç¶­æŒã•ã‚Œã€ç·æ¥ç¶šæ•°ï¼ˆæœ€å¤§5ä»¶ï¼‰ã®ã†ã¡ã®1ã¤ã‚’å æœ‰ã—ã¾ã™ã€‚åˆ‡æ–­ã§ããªã„ä¸€éƒ¨ã®Stdioã‚µãƒ¼ãƒ“ã‚¹ã«é©ã—ã¦ã„ã¾ã™ã€‚"
    },
    "tabs": {
      "tools": "æœ‰åŠ¹ãªãƒ„ãƒ¼ãƒ«",
      "test": "å‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ"
    },
    "hints": {
      "selectTools": "æœ‰åŠ¹ã«ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"
    },
    "test": {
      "selectTool": "ãƒ„ãƒ¼ãƒ«é¸æŠ:",
      "selectToolPlaceholder": "ãƒ†ã‚¹ãƒˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’é¸æŠ",
      "run": "å®Ÿè¡Œ",
      "cancel": "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
      "noParams": "ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä¸è¦ã§ã™",
      "paramErrorJson": "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ {key} ã®å½¢å¼ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªJSONã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™",
      "paramErrorNumber": "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ {key} ã®å½¢å¼ã‚¨ãƒ©ãƒ¼: æ•°å­—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™",
      "successNoContent": "å®Ÿè¡ŒæˆåŠŸã€è¿”å´ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãªã—ã€‚",
      "executionError": "å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ",
      "systemError": "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ",
      "opCancelled": "æ“ä½œãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ",
      "saveToolStateFailed": "ãƒ„ãƒ¼ãƒ«çŠ¶æ…‹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ",
      "inputJsonPlaceholder": "JSONå½¢å¼ã® {type} ã‚’å…¥åŠ›",
      "inputPlaceholder": "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã‚’å…¥åŠ›",
      "default": "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ",
      "leaveEmpty": "ç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨",
      "response": "å¿œç­”çµæœ:"
    }
  },
  "providers": {
    "addProviderBtn": "ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è¿½åŠ ",
    "noProviders": "ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
    "statusOff": "ã‚ªãƒ•",
    "unnamedProvider": "ç„¡åã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼",
    "editNameTooltip": "åå‰ã‚’ç·¨é›†",
    "moveUpTooltip": "ä¸Šã«ç§»å‹•",
    "moveDownTooltip": "ä¸‹ã«ç§»å‹•",
    "deleteProviderTooltip": "ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’å‰Šé™¤",
    "apiKeyLabel": "APIã‚­ãƒ¼",
    "apiKeyPlaceholder": "APIã‚­ãƒ¼ã‚’å…¥åŠ›ï¼ˆè¤‡æ•°å¯ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰",
    "apiKeyDescription": "è¤‡æ•°ã®APIã‚­ãƒ¼ã‚’ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã§ãã¾ã™ã€‚",
    "apiUrlLabel": "API URL",
    "apiUrlPlaceholder": "ä¾‹ï¼šhttps://api.openai.com/v1",
    "modelsLabel": "ãƒ¢ãƒ‡ãƒ«",
    "searchModelsPlaceholder": "ãƒ¢ãƒ‡ãƒ«ã‚’æ¤œç´¢",
    "noModelsAdded": "ãƒ¢ãƒ‡ãƒ«ã¯ã¾ã è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
    "getModelsFromApiBtn": "APIã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—",
    "addManuallyBtn": "æ‰‹å‹•ã§è¿½åŠ ",
    "selectProviderOrAdd": "ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é¸æŠã¾ãŸã¯æ–°è¦è¿½åŠ ",
    "addProviderDialogTitle": "æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è¿½åŠ ",
    "providerNameLabel": "ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å",
    "providerNamePlaceholder": "ä¾‹ï¼šOpenAIãƒ¡ã‚¤ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ",
    "changeProviderNameDialogTitle": "ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åã®å¤‰æ›´",
    "addModelDialogTitle": "ãƒ¢ãƒ‡ãƒ«ã®æ‰‹å‹•è¿½åŠ ",
    "modelNameIdLabel": "ãƒ¢ãƒ‡ãƒ«å/ID",
    "modelNameIdPlaceholder": "ä¾‹ï¼šgpt-4, text-davinci-003",
    "availableModelsDialogTitle": "APIã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«",
    "table": {
      "modelId": "ãƒ¢ãƒ‡ãƒ«ID",
      "ownedBy": "æ‰€æœ‰è€…",
      "action": "æ“ä½œ"
    },
    "folders": {
      "createSuccess": "ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ",
      "renameSuccess": "ãƒ•ã‚©ãƒ«ãƒ€åã‚’å¤‰æ›´ã—ã¾ã—ãŸ",
      "deleteSuccess": "ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ",
      "deleteConfirmTitle": "å‰Šé™¤ã®ç¢ºèª",
      "deleteConfirmMessage": "ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿä¸­ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¯ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã•ã‚Œã¾ã™ã€‚",
      "floder_label": "ãƒ•ã‚©ãƒ«ãƒ€",
      "root": "ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª",
      "empty": "(ç©º)",
      "newFolderTitle": "æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€",
      "renameFolderTitle": "ãƒ•ã‚©ãƒ«ãƒ€åã®å¤‰æ›´",
      "folderNameLabel": "ãƒ•ã‚©ãƒ«ãƒ€å",
      "folderNamePlaceholder": "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
    },
    "noModelsFoundError": "ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€APIã‚¨ãƒ©ãƒ¼ã§ã™ã€‚",
    "noModelsMatchSearch": "ä¸€è‡´ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚",
    "addModelTooltip": "ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ",
    "removeModelTooltip": "ãƒ¢ãƒ‡ãƒ«ã‚’å‰Šé™¤",
    "alerts": {
      "providerUrlNotSet": "ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
      "fetchModelsError": "ã‚¨ãƒ©ãƒ¼ {status}: {message}",
      "fetchModelsFailedDefault": "ãƒ¢ãƒ‡ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      "configSaveFailed": "è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      "saveFailed": "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"
    }
  },
  "setting": {
    "language": {
      "label": "è¨€èª",
      "english": "English",
      "chinese": "ä¸­æ–‡",
      "japanese": "æ—¥æœ¬èª",
      "russian": "Ğ ÑƒÑÑĞºĞ¸Ğ¹",
      "selectPlaceholder": "è¨€èªã‚’é¸æŠ"
    },
    "voice": {
      "title": "éŸ³å£°è¨­å®š  (éŸ³å£°å - ã‚«ã‚¹ã‚¿ãƒ èª¬æ˜)",
      "description": "éŸ³å£°åˆæˆã«åˆ©ç”¨ã§ãã‚‹éŸ³å£°ã®ãƒªã‚¹ãƒˆã‚’ç®¡ç†ã—ã¾ã™ã€‚",
      "add": "éŸ³å£°ã‚’è¿½åŠ ",
      "addPromptTitle": "æ–°ã—ã„éŸ³å£°ã‚’è¿½åŠ ",
      "addPromptMessage": "éŸ³å£°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šalloyï¼‰ã€‚",
      "addSuccess": "éŸ³å£°ãŒæ­£å¸¸ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚",
      "addFailExists": "éŸ³å£°ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚",
      "addFailEmpty": "éŸ³å£°åã‚’ç©ºã«ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚",
      "editPromptTitle": "éŸ³å£°åã®ç·¨é›†",
      "editPromptMessage": "æ–°ã—ã„éŸ³å£°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      "editSuccess": "éŸ³å£°ãŒæ­£å¸¸ã«ä¿®æ­£ã•ã‚Œã¾ã—ãŸ"
    },
    "title": "ä¸€èˆ¬è¨­å®š",
    "isAlwaysOnTop_global": {
      "label": "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’å¸¸ã«æœ€å‰é¢ã«è¡¨ç¤º (ã‚°ãƒ­ãƒ¼ãƒãƒ«)",
      "description": "ã™ã¹ã¦ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’å¸¸ã«æœ€å‰é¢ã«è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹ã‚’ã¾ã¨ã‚ã¦åˆ¶å¾¡ã—ã¾ã™"
    },
    "autoCloseOnBlur_global": {
      "label": "ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸã‚‰é–‰ã˜ã‚‹ (ã‚°ãƒ­ãƒ¼ãƒãƒ«)",
      "description": "ã™ã¹ã¦ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤±ã£ãŸã¨ãã«è‡ªå‹•çš„ã«é–‰ã˜ã‚‹ã‹ã©ã†ã‹ã‚’ã¾ã¨ã‚ã¦åˆ¶å¾¡ã—ã¾ã™"
    },
    "autoSaveChat_global": {
      "label": "ãƒãƒ£ãƒƒãƒˆè‡ªå‹•ä¿å­˜ (ã‚°ãƒ­ãƒ¼ãƒãƒ«)",
      "description": "ã™ã¹ã¦ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãŒãƒãƒ£ãƒƒãƒˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«è‡ªå‹•ä¿å­˜ã™ã‚‹ã‹ã©ã†ã‹ã‚’ã¾ã¨ã‚ã¦åˆ¶å¾¡ã—ã¾ã™"
    },
    "skipLineBreak": {
      "label": "é€ä¿¡æ™‚ã«æ”¹è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—",
      "description": "ãƒ†ã‚­ã‚¹ãƒˆé¸æŠæ™‚ã«æ”¹è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚"
    },
    "ctrlEnter": {
      "label": "Ctrl+Enterã§é€ä¿¡",
      "description": "Ctrl+Enterã‚’æŠ¼ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚"
    },
    "notification": {
      "label": "æˆåŠŸé€šçŸ¥ã‚’è¡¨ç¤º",
      "description": "å¿œç­”ãŒæˆåŠŸã—ãŸã¨ãã«é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚"
    },
    "darkMode": {
      "label": "ãƒ†ãƒ¼ãƒ",
      "description": "ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰",
      "dark": "ãƒ€ãƒ¼ã‚¯",
      "light": "ãƒ©ã‚¤ãƒˆ",
      "system": "ã‚·ã‚¹ãƒ†ãƒ ã«å¾“ã†"
    },
    "fixPosition": {
      "label": "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½ç½®ã‚’å›ºå®š",
      "description": "ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¡¨ç¤ºã•ã‚Œã‚‹ä½ç½®ã‚’å›ºå®šã—ã¾ã™ã€‚"
    },
    "dataManagement": {
      "title": "ãƒ‡ãƒ¼ã‚¿ç®¡ç†",
      "exportLabel": "è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
      "exportDesc": "ç¾åœ¨ã®ã™ã¹ã¦ã®è¨­å®šã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚æ³¨æ„ï¼šè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€å…±æœ‰ã—ãªã„ã§ãã ã•ã„ã€‚",
      "exportButton": "ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
      "importLabel": "è¨­å®šã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
      "importDesc": "JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç¾åœ¨ã®è¨­å®šãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚",
      "importButton": "ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"
    },
    "dimensions": {
      "widthLabel": "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å¹…ï¼ˆpxï¼‰",
      "heightLabel": "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®é«˜ã•ï¼ˆpxï¼‰"
    },
    "webdav": {
      "url": "WebDAVã‚¢ãƒ‰ãƒ¬ã‚¹",
      "urlPlaceholder": "http://localhost:8080",
      "username": "WebDAVãƒ¦ãƒ¼ã‚¶ãƒ¼å",
      "usernamePlaceholder": "WebDAVãƒ¦ãƒ¼ã‚¶ãƒ¼å",
      "password": "WebDAVãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",
      "passwordPlaceholder": "WebDAVãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",
      "path": "WebDAVè¨­å®šãƒ‘ã‚¹",
      "pathPlaceholder": "/anywhere",
      "dataPath": "WebDAVãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹",
      "dataPathPlaceholder": "/anywhere_data",
      "backupRestoreTitle": "è¨­å®šã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒ",
      "backupButton": "WebDAVã¸ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—",
      "restoreButton": "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†",
      "localChatPath": "ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒãƒ£ãƒƒãƒˆãƒ‘ã‚¹",
      "localChatPathPlaceholder": "ä¼šè©±å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„",
      "selectFolder": "ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ",
      "webdavDescription": "ã¾ãšã€ã€Œè¨­å®šã€ãƒšãƒ¼ã‚¸ã§WebDAVã®URLã¨ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„",
      "backup": {
        "confirmTitle": "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«åã®ç¢ºèª",
        "confirmMessage": "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿æŒã™ã‚‹ãŸã‚ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã®ä½¿ç”¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚",
        "invalidFilename": "ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«åã§ã™ã€‚æœ«å°¾ã¯.jsonã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚",
        "cancelled": "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚",
        "emptyFilenameError": "ãƒ•ã‚¡ã‚¤ãƒ«åã¯ç©ºã«ã§ãã¾ã›ã‚“ã€‚",
        "inputFilename": "ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
      },
      "manager": {
        "title": "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ç®¡ç†",
        "pathNotFound": "æŒ‡å®šã•ã‚ŒãŸWebDAVãƒ‘ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚",
        "fetchFailed": "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
        "filename": "ãƒ•ã‚¡ã‚¤ãƒ«å",
        "modifiedTime": "æ›´æ–°æ—¥æ™‚",
        "size": "ã‚µã‚¤ã‚º",
        "actions": "æ“ä½œ",
        "restore": "å¾©å…ƒ",
        "delete": "å‰Šé™¤",
        "confirmRestore": "æœ¬å½“ã«ã“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«'{filename}'ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯ç¾åœ¨ã®è¨­å®šã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚",
        "confirmDelete": "æœ¬å½“ã«ãƒ•ã‚¡ã‚¤ãƒ«'{filename}'ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
        "noFileSelected": "ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
        "confirmDeleteMultiple": "é¸æŠã—ãŸ{count}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ¬å½“ã«å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
        "deleteSuccess": "å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸã€‚",
        "deleteFailed": "å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
        "deleteSuccessMultiple": "é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚",
        "deleteFailedMultiple": "é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
      },
      "alerts": {
        "urlRequired": "WebDAVã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ç©ºã«ã§ãã¾ã›ã‚“ã€‚",
        "backupInProgress": "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­...",
        "backupSuccess": "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«æˆåŠŸã—ã¾ã—ãŸã€‚",
        "backupFailed": "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
        "fileNotFound": "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚",
        "restoreInProgress": "å¾©å…ƒä¸­...",
        "restoreSuccess": "å¾©å…ƒã«æˆåŠŸã—ã¾ã—ãŸã€‚",
        "restoreFailed": "å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
      }
    },
    "alerts": {
      "importSuccess": "è¨­å®šã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«æˆåŠŸã—ã¾ã—ãŸã€‚",
      "importFailed": "è¨­å®šã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      "saveSuccess": "ä¿å­˜ã—ã¾ã—ãŸï¼",
      "saveFailedPrefix": "è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: "
    }
  },
  "common": {
    "cancel": "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
    "confirm": "ç¢ºèª",
    "add": "è¿½åŠ ",
    "delete": "å‰Šé™¤",
    "edit": "ç·¨é›†",
    "save": "ä¿å­˜",
    "close": "é–‰ã˜ã‚‹",
    "assignSelected": "é¸æŠã‚’å‰²ã‚Šå½“ã¦",
    "addTag": "ã‚¿ã‚°ã‚’è¿½åŠ ",
    "removeIcon": "å‰Šé™¤",
    "downloadIcon": "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
    "warningTitle": "è­¦å‘Š",
    "refresh": "æ›´æ–°",
    "deleteSelected": "å‰Šé™¤",
    "noFileSelected": "ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
    "confirmDeleteMultiple": "é¸æŠã—ãŸ{count}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ¬å½“ã«å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
    "deleteSuccess": "å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸã€‚",
    "deleteFailed": "å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
    "deleteSuccessMultiple": "é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚",
    "deleteFailedMultiple": "é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
  }
}
```
```json
./Anywhere_main/src/locales/ru.json
{
  "app": {
    "header": {
      "chats": "Ğ§Ğ°Ñ‚Ñ‹ ğŸ’¬",
      "prompts": "Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ñ‹ ğŸš€",
      "mcp": "MCP Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹ ğŸ”§",
      "providers": "ĞŸÑ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ñ‹ â˜ï¸",
      "settings": "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ âš™ï¸"
    },
    "tabs": {
      "chats": "Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°",
      "prompts": "Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ñ‹",
      "mcp": "MCP Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹",
      "providers": "ĞŸÑ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ñ‹",
      "settings": "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸"
    }
  },
  "chats": {
    "view": {
      "local": "Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‡Ğ°Ñ‚Ñ‹",
      "cloud": "ĞĞ±Ğ»Ğ°Ñ‡Ğ½Ñ‹Ğµ Ñ‡Ğ°Ñ‚Ñ‹"
    },
    "info": {
      "title": "Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ",
      "localDesc": "Â· Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‡Ğ°Ñ‚Ñ‹: Ğ˜Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±ĞµÑĞµĞ´Ñ‹ (ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğµ, Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸Ğ· JSON Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¸Ğ· Ğ¾Ğ±Ğ»Ğ°ĞºĞ°) Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 ÑĞµĞºÑƒĞ½Ğ´. Ğ’ÑĞµ Ğ±ĞµÑĞµĞ´Ñ‹ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ JSON Ğ¿Ğ¾ Ğ¿ÑƒÑ‚Ğ¸ {path}. ĞĞ° Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°Ñ… Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ¿ÑƒÑ‚Ğ¸.",
      "pathNotSet": "Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾",
      "cloudDesc": "Â· ĞĞ±Ğ»Ğ°Ñ‡Ğ½Ñ‹Ğµ Ñ‡Ğ°Ñ‚Ñ‹: Ğ‘ĞµÑĞµĞ´Ñ‹, Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğµ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ² Ğ»ÑĞ±Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾."
    },
    "configRequired": {
      "title": "ĞĞ±Ğ»Ğ°Ñ‡Ğ½Ñ‹Ğµ Ñ‡Ğ°Ñ‚Ñ‹",
      "webdavDescription": "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ URL WebDAV Ğ¸ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ (data_path) Ğ² 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ…', Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ñƒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ.",
      "localPathDescription": "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿ÑƒÑ‚ÑŒ Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ¾Ğ² Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸'"
    },
    "table": {
      "filename": "Ğ˜Ğ¼Ñ Ñ‡Ğ°Ñ‚Ğ°",
      "modifiedTime": "Ğ’Ñ€ĞµĞ¼Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ",
      "size": "Ğ Ğ°Ğ·Ğ¼ĞµÑ€",
      "actions": "Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ"
    },
    "actions": {
      "chat": "Ğ§Ğ°Ñ‚",
      "rename": "ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒ",
      "delete": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ",
      "forceSync": "Ğ¡Ğ¸Ğ½Ñ…Ñ€."
    },
    "rename": {
      "promptTitle": "ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‡Ğ°Ñ‚",
      "promptMessage": "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±ĞµÑĞµĞ´Ñ‹.",
      "invalidFilename": "ĞĞµĞ´Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ¾Ğµ Ğ¸Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°, Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ·Ğ°ĞºĞ°Ğ½Ñ‡Ğ¸Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ½Ğ° .json.",
      "syncTitle": "ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° Ğ¾ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸",
      "syncCloudConfirm": "Ğ’ Ğ¾Ğ±Ğ»Ğ°ĞºĞµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ñ„Ğ°Ğ¹Ğ» Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ Ğ¶Ğµ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼. ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾?",
      "syncLocalConfirm": "Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ñ„Ğ°Ğ¹Ğ» Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ Ğ¶Ğµ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼. ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾?"
    },
    "tooltips": {
      "syncToCloud": "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾",
      "syncFromCloud": "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ· Ğ¾Ğ±Ğ»Ğ°ĞºĞ°",
      "uploadChanges": "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ {count} Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²",
      "downloadChanges": "Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ {count} Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²",
      "forceUpload": "ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾ (Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ)",
      "forceDownload": "ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· Ğ¾Ğ±Ğ»Ğ°ĞºĞ° (Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ)"
    },
    "confirmDelete": "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ° ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‡Ğ°Ñ‚ '{filename}'?",
    "clean": {
      "button": "ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ",
      "title": "ĞĞ²Ñ‚Ğ¾Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ñ‡Ğ°Ñ‚Ğ¾Ğ²",
      "timeRangeLabel": "ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ",
      "customDaysLabel": "Ğ¡Ğ²Ğ¾Ğ¸ Ğ´Ğ½Ğ¸",
      "previewTitle": "Ğ‘ÑƒĞ´ĞµÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ {count} Ñ‡Ğ°Ñ‚Ğ¾Ğ² ÑÑ‚Ğ°Ñ€ÑˆĞµ {days} Ğ´Ğ½ĞµĞ¹ ({size})",
      "noFilesFound": "Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ Ñ‡Ğ°Ñ‚Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹",
      "confirmBtn": "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ",
      "success": "Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ {count} Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²",
      "ranges": {
        "3": "Ğ¡Ñ‚Ğ°Ñ€ÑˆĞµ 3 Ğ´Ğ½ĞµĞ¹",
        "7": "Ğ¡Ñ‚Ğ°Ñ€ÑˆĞµ 7 Ğ´Ğ½ĞµĞ¹",
        "30": "Ğ¡Ñ‚Ğ°Ñ€ÑˆĞµ 30 Ğ´Ğ½ĞµĞ¹",
        "custom": "Ğ¡Ğ²Ğ¾Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚"
      },
      "scopeTip": "ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ: Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ Ğ²Ğ¸Ğ´Ğµ ({view}) Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ Ğ¸Ñ… ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾ Ğ½Ğ° Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğµ."
    },
    "alerts": {
      "configError": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ.",
      "pathNotFound": "Ğ£ĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ WebDAV Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.",
      "pathCreated": "ĞŸÑƒÑ‚ÑŒ Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸.",
      "fetchFailed": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‡Ğ°Ñ‚Ğ¾Ğ².",
      "loadingChat": "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‡Ğ°Ñ‚Ğ°...",
      "restoreInitiated": "Ğ§Ğ°Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½.",
      "restoreFailed": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ‡Ğ°Ñ‚.",
      "renameSuccess": "ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾.",
      "renameFailed": "ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ.",
      "syncInProgress": "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ...",
      "syncPreparingUpload": "ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğº Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ...",
      "syncPreparingDownload": "ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğº ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ...",
      "syncProcessing": "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°... {completed}/{total}",
      "syncCancelled": "ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°",
      "syncSuccessUpload": "{count} Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾.",
      "syncSuccessDownload": "{count} Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¸Ğ· Ğ¾Ğ±Ğ»Ğ°ĞºĞ°.",
      "syncFailedPartially": "{failedCount} Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ.",
      "syncFailed": "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ°ÑÑŒ: {message}",
      "syncConfirmUpload": "Ğ­Ñ‚Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ Ğ²ÑĞµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ±ĞµÑĞµĞ´Ñ‹ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾, Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ² Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ°Ğ¼Ğ¸. ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ?",
      "syncConfirmUploadTitle": "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾",
      "syncConfirmDownload": "Ğ­Ñ‚Ğ¾ ÑĞºĞ°Ñ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ñ‹Ğµ Ğ±ĞµÑĞµĞ´Ñ‹ Ğ½Ğ° Ğ²Ğ°Ñˆ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€, Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ² Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ°Ğ¼Ğ¸. ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ?",
      "syncConfirmDownloadTitle": "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ· Ğ¾Ğ±Ğ»Ğ°ĞºĞ°",
      "syncNoUpload": "Ğ’ÑĞµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹ Ğ¸Ğ»Ğ¸ Ğ½Ğ¾Ğ²ĞµĞµ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞµ. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ.",
      "syncNoDownload": "Ğ’ÑĞµ Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¸Ğ»Ğ¸ Ğ½Ğ¾Ğ²ĞµĞµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾. Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ.",
      "confirmSyncDeleteTitle": "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ",
      "confirmSyncDeleteMessage": "{count} Ğ¸Ğ· Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ‚Ğ°ĞºĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚ Ğ² {location}. Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ñ… Ğ¸ Ğ¾Ñ‚Ñ‚ÑƒĞ´Ğ°?",
      "webdavRequired": "Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ WebDAV",
      "localPathRequired": "Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğº Ñ‡Ğ°Ñ‚Ğ°Ğ¼",
      "continueConfirm": "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ?",
      "restoreChat": "Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ‡Ğ°Ñ‚"
    }
  },
  "prompts": {
    "allPrompts": "Ğ’ÑĞµ",
    "searchPlaceholder": "Ğ˜ÑĞºĞ°Ñ‚ÑŒ Ğ¸Ğ¼Ñ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ...",
    "noPrompts": "Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ñ‹.",
    "noPromptsInTag": "ĞĞµÑ‚ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ‚ĞµĞ³Ğµ.",
    "addExistingPrompt": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ°",
    "addNewPrompt": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ°",
    "editPrompt": "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ°",
    "addNewTag": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚ĞµĞ³",
    "assignPromptsToTag": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ¾Ğ² Ğº Ñ‚ĞµĞ³Ñƒ '{tagName}'",
    "promptKeyLabel": "Ğ˜Ğ¼Ñ",
    "promptKeyPlaceholder": "Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, CodeGeneration",
    "typeLabel": "Ğ¢Ğ¸Ğ¿",
    "iconLabel": "Ğ˜ĞºĞ¾Ğ½ĞºĞ°",
    "iconUploadTip": "ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹ {formats}, Ğ¼Ğ°ĞºÑ. Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ {maxSize}.",
    "dragIconHere": "ĞŸĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸Ñ‚Ğµ ",
    "orClickToUpload": "Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ",
    "disableAll": "ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ",
    "enableAll": "Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ",
    "openWindow": "ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¾ĞºĞ½Ğ¾ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°",
    "deletePrompt": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ°",
    "inputPlaceholder": "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ¸...",
    "selectNewModel": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ",
    "icon": {
      "uploadText": "ĞŸĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸Ñ‚Ğµ/Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ\nĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸",
      "downloadTooltip": "Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸ĞºĞ¾Ğ½ĞºÑƒ",
      "removeTooltip": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸ĞºĞ¾Ğ½ĞºÑƒ"
    },
    "iconEditor": {
      "hint": "ĞŸĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ñ / Ğ¡ĞºÑ€Ğ¾Ğ»Ğ» Ğ´Ğ»Ñ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ°",
      "scale": "ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±",
      "radius": "Ğ Ğ°Ğ´Ğ¸ÑƒÑ",
      "cancel": "ĞÑ‚Ğ¼ĞµĞ½Ğ°",
      "confirm": "ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ"
    },
    "background": {
      "imageLabel": "Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¾ĞºĞ½Ğ° (URL)",
      "imagePlaceholder": "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ (http/https/data:image)",
      "opacityLabel": "ĞĞµĞ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ Ñ„Ğ¾Ğ½Ğ°",
      "blurLabel": "Ğ Ğ°Ğ·Ğ¼Ñ‹Ñ‚Ğ¸Ğµ Ñ„Ğ¾Ğ½Ğ°"
    },
    "regex": {
      "label": "ĞŸĞ¾Ğ»ÑŒĞ·. Ñ€ĞµĞ³. Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ",
      "tooltip": "Ğ•ÑĞ»Ğ¸ Ñ‚Ğ¸Ğ¿ Ğ²Ğ²Ğ¾Ğ´Ğ° 'Ğ¢ĞµĞºÑÑ‚', Ğ·Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ ÑĞ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ñ‹Ğ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ñ‹Ğ¼.1. Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ /.../flags, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, /^https?:\\/\\// Ğ´Ğ»Ñ URL-Ğ°Ğ´Ñ€ĞµÑĞ¾Ğ².2. Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ñ‹Ğµ ÑĞ»ÑÑˆĞ¸ \\ Ğ² Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¸ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ ÑĞºÑ€Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ ĞºĞ°Ğº \\\\.3. flags â€” Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ»Ğ°Ğ³Ğ¸, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, i Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¾Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, /hello/i).4. ĞÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼ Ğ´Ğ»Ñ ÑĞ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ Ğ»ÑĞ±Ñ‹Ğ¼ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼.ĞšÑ€Ğ°Ñ‚ĞºĞ¸Ğ¹ ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸Ğº:â€¢ . - Ğ›ÑĞ±Ğ¾Ğ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ», ĞºÑ€Ğ¾Ğ¼Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸â€¢ \\d - Ğ›ÑĞ±Ğ°Ñ Ñ†Ğ¸Ñ„Ñ€Ğ°â€¢ \\s - Ğ›ÑĞ±Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» (Ğ¿Ñ€Ğ¾Ğ±ĞµĞ», Ñ‚Ğ°Ğ±, Ğ½Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°)â€¢ \\S - Ğ›ÑĞ±Ğ¾Ğ¹ Ğ½ĞµĞ¿Ñ€Ğ¾Ğ±ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»â€¢ \\w - Ğ‘ÑƒĞºĞ²Ñ‹, Ñ†Ğ¸Ñ„Ñ€Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ´Ñ‡ĞµÑ€ĞºĞ¸Ğ²Ğ°Ğ½Ğ¸Ğµâ€¢ [...] - Ğ›ÑĞ±Ğ¾Ğ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» Ğ¸Ğ· Ğ½Ğ°Ğ±Ğ¾Ñ€Ğ°, Ğ½Ğ°Ğ¿Ñ€., [abc]â€¢ * - 0 Ğ¸Ğ»Ğ¸ Ğ±Ğ¾Ğ»ĞµĞµ Ñ€Ğ°Ğ·â€¢ + - 1 Ğ¸Ğ»Ğ¸ Ğ±Ğ¾Ğ»ĞµĞµ Ñ€Ğ°Ğ·â€¢ ? - 0 Ğ¸Ğ»Ğ¸ 1 Ñ€Ğ°Ğ·â€¢ ^ - ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ ÑÑ‚Ñ€Ğ¾ĞºĞ¸â€¢ $ - ĞšĞ¾Ğ½ĞµÑ† ÑÑ‚Ñ€Ğ¾ĞºĞ¸",
      "placeholder": "/.../flags (Ğ¿ÑƒÑÑ‚Ğ¾ Ğ´Ğ»Ñ Ğ»ÑĞ±Ğ¾Ğ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ°)"
    },
    "typeOptions": {
      "general": "ĞĞ±Ñ‰Ğ¸Ğ¹",
      "text": "Ğ¢ĞµĞºÑÑ‚",
      "image": "Ğ¡ĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚",
      "files": "Ğ¤Ğ°Ğ¹Ğ»Ñ‹"
    },
    "showModeLabel": "Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ",
    "showModeOptions": {
      "fastinput": "Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ²Ğ²Ğ¾Ğ´",
      "window": "ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾"
    },
    "promptKeyLabelShort": "Ğ˜Ğ¼Ñ",
    "modelLabel": "ĞœĞ¾Ğ´ĞµĞ»ÑŒ",
    "llmParametersLabel": "ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸",
    "llmParametersRemark": "Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Â«Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ°Â»; Ğ¿ĞµÑ€ĞµÑÑ‚Ğ°ĞµÑ‚ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ½Ğ° Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸",
    "AssistantParametersLabel": "ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ°",
    "sendDirectLabel": "ĞŸÑ€ÑĞ¼Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ°/ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğ°",
    "sendFileLabel": "ĞŸÑ€ÑĞ¼Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ°",
    "ifTextNecessary": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ",
    "streamLabel": "ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¾Ğ²Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹",
    "enableTemperatureLabel": "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ°Ñ Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°",
    "temperatureLabel": "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ñ‹",
    "promptContentLabel": "Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ°",
    "enabledLabel": "Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾",
    "addToTagLabel": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğº Ñ‚ĞµĞ³Ñƒ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)",
    "addToTagPlaceholder": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚ĞµĞ³ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)",
    "tagNameLabel": "Ğ˜Ğ¼Ñ Ñ‚ĞµĞ³Ğ°",
    "selectPromptsToAddLabel": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ",
    "selectPromptsPlaceholder": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ¾Ğ²",
    "isAlwaysOnTopLabel": "Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…",
    "autoCloseOnBlurLabel": "Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğµ Ñ„Ğ¾ĞºÑƒÑĞ°",
    "autoSaveChatLabel": "ĞĞ²Ñ‚Ğ¾ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ğ°",
    "replaceModels": "Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸",
    "replaceModelsDialog": {
      "title": "ĞœĞ°ÑÑĞ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ¼ĞµĞ½Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹",
      "sourceModel": "Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ",
      "targetModel": "Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ"
    },
    "alerts": {
      "tagNameEmpty": "Ğ˜Ğ¼Ñ Ñ‚ĞµĞ³Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.",
      "tagExists": "Ğ¢ĞµĞ³ Â«{tagName}Â» ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.",
      "promptKeyEmpty": "Ğ˜Ğ¼Ñ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.",
      "promptKeyExists": "Ğ˜Ğ¼Ñ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ° Â«{newKey}Â» ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.",
      "targetTagNotFound": "Ğ¦ĞµĞ»ĞµĞ²Ğ¾Ğ¹ Ñ‚ĞµĞ³ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.",
      "noPromptsToAssign": "ĞĞµÑ‚ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ¾Ğ¼Ñƒ Ñ‚ĞµĞ³Ñƒ.",
      "invalidImageFormat": "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ {formats}.",
      "imageSizeTooLarge": "Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ {maxSize}.",
      "modelsReplacedSuccess": "Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¼ĞµĞ½ĞµĞ½Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ {count} Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ¾Ğ².",
      "refreshSuccess": "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°!",
      "noIconToDownload": "ĞĞµÑ‚ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ.",
      "selectModels": "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½ÑƒÑ Ğ¸ Ñ†ĞµĞ»ĞµĞ²ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸.",
      "sameModels": "Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ°Ñ Ğ¸ Ñ†ĞµĞ»ĞµĞ²Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°Ñ‚ÑŒ.",
      "configFetchFailed": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ°, Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ğ¼Ğ¸.",
      "promptNotFound": "ĞÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ¾Ğ½ Ğ±Ñ‹Ğ» ÑƒĞ´Ğ°Ğ»ĞµĞ½.",
      "saveFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.",
      "saveSettingFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ"
    },
    "tooltips": {
      "moveLeft": "ĞŸĞµÑ€ĞµĞ¼ĞµÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ğ»ĞµĞ²Ğ¾",
      "moveRight": "ĞŸĞµÑ€ĞµĞ¼ĞµÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ğ¿Ñ€Ğ°Ğ²Ğ¾",
      "removeFromTag": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ° Ğ¸Ğ· ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚ĞµĞ³Ğ°",
      "sendDirect": "ĞŸÑ€Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸, Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ»Ğ¸ ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ² AI.",
      "sendFile": "ĞŸÑ€Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸, Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ² AI Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸.",
      "ifTextNecessary": "ĞŸĞ¾ÑĞ»Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿ÑƒÑÑ‚Ğ¾Ğµ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ¼ĞµÑ‚ĞºĞ°. Ğ­Ñ‚Ğ¾ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚, Ñ‡Ñ‚Ğ¾ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ñ‚ĞµĞºÑÑ‚, ÑƒĞ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€ÑÑ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸ÑĞ¼ Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ñ‰Ğ¸ĞºĞ¾Ğ² ÑƒÑĞ»ÑƒĞ³ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Vertex).",
      "reasoningEffort": "Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ±ÑĞ´Ğ¶ĞµÑ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° Ñ€Ğ°ÑÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸. Ğ‘Ğ¾Ğ»ĞµĞµ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ´Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ğ»ĞµĞµ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹, Ğ½Ğ¾ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ°Ñ‚ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºÑƒ Ğ¸ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ.",
      "isAlwaysOnTopTooltip": "Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾ĞºĞ½Ğ¾ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¾ÑÑ‚Ğ°Ğ²Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¾ĞºĞ¾Ğ½.",
      "autoCloseOnBlurTooltip": "Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğµ Ğ¸Ğ¼ Ñ„Ğ¾ĞºÑƒÑĞ°.",
      "autoSaveChatTooltip": "ĞŸÑ€Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ±ĞµÑĞµĞ´Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒÑÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 ÑĞµĞºÑƒĞ½Ğ´ (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¿ÑƒÑ‚Ğ¸ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ…).",
      "defaultMcpServers": "Ğ•ÑĞ»Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾, Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ»ÑƒĞ¶Ğ±Ñ‹ MCP Ğ±ÑƒĞ´ÑƒÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ° Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼ Ğ¾ĞºĞ½Ğµ."
    },
    "voiceLabel": "Ğ“Ğ¾Ğ»Ğ¾Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ",
    "voicePlaceholder": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ğ»Ğ¾Ñ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ",
    "voiceTooltip": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ğ»Ğ¾Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ñ€ĞµÑ‡ĞµĞ²Ğ¾Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ. ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµÑ‡ĞµĞ²Ğ¾Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ 'ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ', Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ.",
    "voiceOptions": {
      "off": "ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ"
    },
    "reasoningEffortLabel": "Ğ£ÑĞ¸Ğ»Ğ¸Ğµ Ğ½Ğ° Ñ€Ğ°ÑÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ",
    "reasoningEffort": {
      "default": "ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ",
      "low": "ĞĞ¸Ğ·ĞºĞ¾Ğµ",
      "medium": "Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ",
      "high": "Ğ’Ñ‹ÑĞ¾ĞºĞ¾Ğµ"
    },
    "defaultMcpServersLabel": "MCP",
    "defaultMcpServersPlaceholder": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ»ÑƒĞ¶Ğ±Ñ‹ MCP Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ°"
  },
  "mcp": {
    "title": "MCP Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹",
    "addServer": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ MCP Ğ¡ĞµÑ€Ğ²ĞµÑ€",
    "editJson": "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ JSON",
    "noServers": "MCP ÑĞµÑ€Ğ²ĞµÑ€Ñ‹ Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹.",
    "searchPlaceholder": "ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸, Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ, Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ñƒ Ğ¸Ğ»Ğ¸ Ñ‚ĞµĞ³Ğ°Ğ¼...",
    "noMatch": "Ğ¡Ğ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾",
    "addServerTitle": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ MCP Ğ¡ĞµÑ€Ğ²ĞµÑ€",
    "editServerTitle": "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ MCP Ğ¡ĞµÑ€Ğ²ĞµÑ€",
    "nameLabel": "Ğ˜Ğ¼Ñ",
    "descriptionLabel": "ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ",
    "typeLabel": "Ğ¢Ğ¸Ğ¿",
    "activeLabel": "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½",
    "persistentOn": "ĞŸĞ¾ÑÑ‚. ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ’ĞšĞ›",
    "persistentOff": "ĞŸĞ¾ÑÑ‚. ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ’Ğ«ĞšĞ›",
    "testConnectionTooltip": "Ğ¢ĞµÑÑ‚ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ / ĞšÑÑˆ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²",
    "refreshTooltip": "ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ",
    "connecting": "ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²...",
    "connectionSuccess": "Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾! ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ {count} Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²",
    "connectionFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ",
    "toolList": "Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²:",
    "cached": "ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾",
    "noDescription": "ĞĞµÑ‚ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ",
    "noToolsProvided": "Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²",
    "refreshConfig": "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ MCP",
    "typeOptions": {
      "stdio": "Stdio",
      "http": "ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¾Ğ²Ñ‹Ğ¹ HTTP",
      "sse": "SSE",
      "builtin": "Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹"
    },
    "stdio": {
      "command": "ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°",
      "args": "ĞÑ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹",
      "env": "ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ"
    },
    "http": {
      "url": "Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ URL",
      "headers": "Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°"
    },
    "advanced": "Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğµ/ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸",
    "registryUrl": "URL Ğ ĞµĞµÑÑ‚Ñ€Ğ°",
    "providerName": "Ğ˜Ğ¼Ñ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°",
    "providerUrl": "URL Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°",
    "logoUrl": "URL Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ğ°",
    "tags": "Ğ¢ĞµĞ³Ğ¸",
    "argsPlaceholder": "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñƒ Ğ² ÑÑ‚Ñ€Ğ¾ĞºĞµ",
    "envPlaceholder": "KEY1: VALUE1\nKEY2: VALUE2",
    "headersPlaceholder": "Header-Name: Header-Value\nAuthorization: Bearer token",
    "tagsPlaceholder": "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚ĞµĞ³Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ",
    "alerts": {
      "deleteConfirmTitle": "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ",
      "deleteConfirmText": "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ MCP ÑĞµÑ€Ğ²ĞµÑ€ Â«{name}Â»?",
      "saveSuccess": "MCP ÑĞµÑ€Ğ²ĞµÑ€ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½.",
      "saveFailed": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ MCP ÑĞµÑ€Ğ²ĞµÑ€.",
      "deleteSuccess": "MCP ÑĞµÑ€Ğ²ĞµÑ€ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½.",
      "deleteFailed": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ MCP ÑĞµÑ€Ğ²ĞµÑ€.",
      "invalidJson": "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ JSON. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ²Ğ²Ğ¾Ğ´.",
      "jsonError": "JSON Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ¼, ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‰Ğ¸Ğ¼ ĞºĞ»ÑÑ‡ \"mcpServers\".",
      "configCopied": "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ° ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ² Ğ±ÑƒÑ„ĞµÑ€ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ°",
      "refreshSuccess": "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ MCP Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°!",
      "configInvalid": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸.",
      "refreshFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.",
      "testSuccess": "Ğ¢ĞµÑÑ‚ Ğ¿Ñ€Ğ¾ÑˆĞµĞ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾.",
      "testFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‚ĞµÑÑ‚Ğ°. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ÑĞ²Ğ¾Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ."
    },
    "jsonDialog": {
      "title": "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ JSON MCP Ğ¡ĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²",
      "description": "Ğ’Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ: ĞŸÑ€ÑĞ¼Ğ¾Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ JSON Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹, ĞµÑĞ»Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ±ÑƒĞ´ĞµÑ‚ Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¼. Ğ”ĞµĞ¹ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ Ñ Ğ¾ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒÑ."
    },
    "persistent": {
      "label": "ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾Ğµ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ",
      "tooltip": "ĞŸĞ¾ÑĞ»Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾Ğµ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ·Ğ°Ğ¹Ğ¼ĞµÑ‚ Ğ¾Ğ´Ğ¸Ğ½ Ğ¸Ğ· Ğ¾Ğ±Ñ‰Ğ¸Ñ… ÑĞ»Ğ¾Ñ‚Ğ¾Ğ² ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹ (Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 5). ĞŸĞ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ´Ğ»Ñ Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Stdio-ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ñ€Ğ°Ğ·Ğ¾Ñ€Ğ²Ğ°Ñ‚ÑŒ."
    },
    "tabs": {
      "tools": "Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹",
      "test": "Ğ¢ĞµÑÑ‚ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°"
    },
    "hints": {
      "selectTools": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ"
    },
    "test": {
      "selectTool": "Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚:",
      "selectToolPlaceholder": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚",
      "run": "Ğ—Ğ°Ğ¿ÑƒÑĞº",
      "cancel": "ĞÑ‚Ğ¼ĞµĞ½Ğ°",
      "noParams": "ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ÑÑ",
      "paramErrorJson": "ĞÑˆĞ¸Ğ±ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° {key}: Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ JSON",
      "paramErrorNumber": "ĞÑˆĞ¸Ğ±ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° {key}: Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼",
      "successNoContent": "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾, Ğ½ĞµÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°.",
      "executionError": "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ: ",
      "systemError": "Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: ",
      "opCancelled": "ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°",
      "saveToolStateFailed": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ",
      "inputJsonPlaceholder": "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ {type} Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ JSON",
      "inputPlaceholder": "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ",
      "default": "ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡.",
      "leaveEmpty": "ĞÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼ Ğ´Ğ»Ñ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ",
      "response": "Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:"
    }
  },
  "providers": {
    "addProviderBtn": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°",
    "noProviders": "ĞŸÑ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ñ‹ Ğ¿Ğ¾ĞºĞ° Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚.",
    "statusOff": "ĞÑ‚ĞºĞ».",
    "unnamedProvider": "Ğ‘ĞµĞ·Ñ‹Ğ¼ÑĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€",
    "editNameTooltip": "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ¼Ñ",
    "moveUpTooltip": "ĞŸĞµÑ€ĞµĞ¼ĞµÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ğ²ĞµÑ€Ñ…",
    "moveDownTooltip": "ĞŸĞµÑ€ĞµĞ¼ĞµÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ğ½Ğ¸Ğ·",
    "deleteProviderTooltip": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°",
    "apiKeyLabel": "ĞšĞ»ÑÑ‡ API",
    "apiKeyPlaceholder": "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ»ÑÑ‡ API (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾, Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ)",
    "apiKeyDescription": "Ğ’Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ²Ğ²ĞµÑÑ‚Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ĞºĞ»ÑÑ‡ĞµĞ¹ API, Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿ÑÑ‚Ñ‹Ğ¼Ğ¸.",
    "apiUrlLabel": "API URL",
    "apiUrlPlaceholder": "Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, https://api.openai.com/v1",
    "modelsLabel": "ĞœĞ¾Ğ´ĞµĞ»Ğ¸",
    "searchModelsPlaceholder": "ĞŸĞ¾Ğ¸ÑĞº Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹",
    "noModelsAdded": "ĞœĞ¾Ğ´ĞµĞ»Ğ¸ Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹.",
    "getModelsFromApiBtn": "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸Ğ· API",
    "addManuallyBtn": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ",
    "selectProviderOrAdd": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ° Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾",
    "addProviderDialogTitle": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°",
    "providerNameLabel": "Ğ˜Ğ¼Ñ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°",
    "providerNamePlaceholder": "Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, OpenAI Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹",
    "changeProviderNameDialogTitle": "Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ¼Ñ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°",
    "addModelDialogTitle": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ",
    "modelNameIdLabel": "Ğ˜Ğ¼Ñ/ID Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸",
    "modelNameIdPlaceholder": "Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, gpt-4, text-davinci-003",
    "availableModelsDialogTitle": "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸Ğ· API",
    "table": {
      "modelId": "ID Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸",
      "ownedBy": "Ğ’Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ†",
      "action": "Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ"
    },
    "folders": {
      "createSuccess": "ĞŸĞ°Ğ¿ĞºĞ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°",
      "renameSuccess": "ĞŸĞ°Ğ¿ĞºĞ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ°",
      "deleteSuccess": "ĞŸĞ°Ğ¿ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°",
      "deleteConfirmTitle": "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ",
      "deleteConfirmMessage": "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ñƒ Ğ¿Ğ°Ğ¿ĞºÑƒ? ĞĞ°Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸ĞµÑÑ Ğ² Ğ½ĞµĞ¹ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ñ‰Ğ¸ĞºĞ¸ ÑƒÑĞ»ÑƒĞ³ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ñ‹ Ğ² ĞºĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³.",
      "floder_label": "ĞŸĞ°Ğ¿ĞºĞ°",
      "root": "ĞšĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³",
      "empty": "(Ğ¿ÑƒÑÑ‚Ğ¾)",
      "newFolderTitle": "ĞĞ¾Ğ²Ğ°Ñ Ğ¿Ğ°Ğ¿ĞºĞ°",
      "renameFolderTitle": "ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ğ¿ĞºÑƒ",
      "folderNameLabel": "Ğ˜Ğ¼Ñ Ğ¿Ğ°Ğ¿ĞºĞ¸",
      "folderNamePlaceholder": "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ"
    },
    "noModelsFoundError": "ĞœĞ¾Ğ´ĞµĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ¸Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° API.",
    "noModelsMatchSearch": "Ğ¡Ğ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.",
    "addModelTooltip": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ",
    "removeModelTooltip": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ",
    "alerts": {
      "providerUrlNotSet": "URL Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ° Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½.",
      "fetchModelsError": "ĞÑˆĞ¸Ğ±ĞºĞ° {status}: {message}",
      "fetchModelsFailedDefault": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸.",
      "configSaveFailed": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ.",
      "saveFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ"
    }
  },
  "setting": {
    "language": {
      "label": "Ğ¯Ğ·Ñ‹Ğº",
      "english": "English",
      "chinese": "ä¸­æ–‡",
      "japanese": "æ—¥æœ¬èª",
      "russian": "Ğ ÑƒÑÑĞºĞ¸Ğ¹",
      "selectPlaceholder": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº"
    },
    "voice": {
      "title": "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ³Ğ¾Ğ»Ğ¾ÑĞ°  (ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ğ»Ğ¾ÑĞ° - ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ)",
      "description": "Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ², Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ ÑĞ¸Ğ½Ñ‚ĞµĞ·Ğ° Ñ€ĞµÑ‡Ğ¸.",
      "add": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ³Ğ¾Ğ»Ğ¾Ñ",
      "addPromptTitle": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ»Ğ¾Ñ",
      "addPromptMessage": "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ğ»Ğ¾ÑĞ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, alloy).",
      "addSuccess": "Ğ“Ğ¾Ğ»Ğ¾Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½.",
      "addFailExists": "Ğ“Ğ¾Ğ»Ğ¾Ñ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.",
      "addFailEmpty": "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ğ»Ğ¾ÑĞ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.",
      "editPromptTitle": "Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ğ»Ğ¾ÑĞ°",
      "editPromptMessage": "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ğ»Ğ¾ÑĞ°",
      "editSuccess": "Ğ“Ğ¾Ğ»Ğ¾Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½"
    },
    "title": "ĞĞ±Ñ‰Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸",
    "isAlwaysOnTop_global": {
      "label": "Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… Ğ¾ĞºĞ¾Ğ½",
      "description": "Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞ¼, Ğ±ÑƒĞ´ÑƒÑ‚ Ğ»Ğ¸ Ğ²ÑĞµ Ğ¾ĞºĞ½Ğ° Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ¾Ğ² Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… Ğ´Ñ€ÑƒĞ³Ğ¸Ñ…"
    },
    "autoCloseOnBlur_global": {
      "label": "Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğµ Ñ„Ğ¾ĞºÑƒÑĞ°",
      "description": "Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞ¼, Ğ±ÑƒĞ´ÑƒÑ‚ Ğ»Ğ¸ Ğ²ÑĞµ Ğ¾ĞºĞ½Ğ° Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ¾Ğ² Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğµ Ñ„Ğ¾ĞºÑƒÑĞ°"
    },
    "autoSaveChat_global": {
      "label": "Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ°Ğ²Ñ‚Ğ¾ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ğ°",
      "description": "Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞ¼, Ğ±ÑƒĞ´ÑƒÑ‚ Ğ»Ğ¸ Ğ²ÑĞµ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ Ñ‡Ğ°Ñ‚Ñ‹ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾"
    },
    "skipLineBreak": {
      "label": "ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑÑ‹ ÑÑ‚Ñ€Ğ¾Ğº Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ",
      "description": "Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑÑ‹ ÑÑ‚Ñ€Ğ¾Ğº Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ°."
    },
    "ctrlEnter": {
      "label": "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ğ¾ Ctrl+Enter",
      "description": "Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸ĞµĞ¼ Ctrl+Enter."
    },
    "notification": {
      "label": "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑ…Ğµ",
      "description": "Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ."
    },
    "darkMode": {
      "label": "Ğ¢ĞµĞ¼Ğ°",
      "description": "Ğ¡Ğ²ĞµÑ‚Ğ»Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¸Ğ»Ğ¸ Ñ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼",
      "dark": "Ğ¢ĞµĞ¼Ğ½Ñ‹Ğ¹",
      "light": "Ğ¡Ğ²ĞµÑ‚Ğ»Ñ‹Ğ¹",
      "system": "Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ"
    },
    "fixPosition": {
      "label": "Ğ¤Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¾ĞºĞ½Ğ°",
      "description": "Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ¿Ğ¾ÑĞ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾ĞºĞ½Ğ°."
    },
    "dataManagement": {
      "title": "Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸",
      "exportLabel": "Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸",
      "exportDesc": "Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ² Ñ„Ğ°Ğ¹Ğ» JSON. Ğ’Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ: Ñ„Ğ°Ğ¹Ğ» ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, Ğ½Ğµ Ğ´ĞµĞ»Ğ¸Ñ‚ĞµÑÑŒ Ğ¸Ğ¼.",
      "exportButton": "Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚",
      "importLabel": "Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸",
      "importDesc": "Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ° JSON. Ğ­Ñ‚Ğ¾ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑˆĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸.",
      "importButton": "Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚"
    },
    "dimensions": {
      "widthLabel": "Ğ¨Ğ¸Ñ€Ğ¸Ğ½Ğ° Ğ¾ĞºĞ½Ğ° (px)",
      "heightLabel": "Ğ’Ñ‹ÑĞ¾Ñ‚Ğ° Ğ¾ĞºĞ½Ğ° (px)"
    },
    "webdav": {
      "url": "WebDAV URL",
      "urlPlaceholder": "http://localhost:8080",
      "username": "Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ WebDAV",
      "usernamePlaceholder": "Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ WebDAV",
      "password": "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ WebDAV",
      "passwordPlaceholder": "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ WebDAV",
      "path": "ĞŸÑƒÑ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ WebDAV",
      "pathPlaceholder": "/anywhere",
      "dataPath": "ĞŸÑƒÑ‚ÑŒ Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ WebDAV",
      "dataPathPlaceholder": "/anywhere_data",
      "backupRestoreTitle": "Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ",
      "backupButton": "ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² WebDAV",
      "restoreButton": "Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¿Ğ¸ÑĞ¼Ğ¸",
      "localChatPath": "Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°Ğ¼",
      "localChatPathPlaceholder": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²",
      "selectFolder": "Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ğ¿ĞºÑƒ",
      "webdavDescription": "Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ URL-Ğ°Ğ´Ñ€ĞµÑ WebDAV Ğ¸ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Â«ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸Â»",
      "backup": {
        "confirmTitle": "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¿Ğ¸Ğ¸",
        "confirmMessage": "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¿Ğ¸Ğ¸. Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ¼Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚ĞºĞ¸.",
        "invalidFilename": "ĞĞµĞ²ĞµÑ€Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°, Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ·Ğ°ĞºĞ°Ğ½Ñ‡Ğ¸Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ½Ğ° .json.",
        "cancelled": "Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾.",
        "emptyFilenameError": "Ğ˜Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.",
        "inputFilename": "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°"
      },
      "manager": {
        "title": "Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğ¼Ğ¸ ĞºĞ¾Ğ¿Ğ¸ÑĞ¼Ğ¸",
        "pathNotFound": "Ğ£ĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ WebDAV Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.",
        "fetchFailed": "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ñ… ĞºĞ¾Ğ¿Ğ¸Ğ¹.",
        "filename": "Ğ˜Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°",
        "modifiedTime": "Ğ’Ñ€ĞµĞ¼Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ",
        "size": "Ğ Ğ°Ğ·Ğ¼ĞµÑ€",
        "actions": "Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ",
        "restore": "Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ",
        "delete": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ",
        "confirmRestore": "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» '{filename}'? Ğ­Ñ‚Ğ¾ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑˆĞµÑ‚ Ğ²Ğ°ÑˆÑƒ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ.",
        "confirmDelete": "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ° ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» '{filename}'?",
        "noFileSelected": "Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ñ‹.",
        "confirmDeleteMultiple": "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ° ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ {count} Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²?",
        "deleteSuccess": "Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾.",
        "deleteFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ.",
        "deleteSuccessMultiple": "Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹.",
        "deleteFailedMultiple": "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²."
      },
      "alerts": {
        "urlRequired": "URL-Ğ°Ğ´Ñ€ĞµÑ WebDAV Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.",
        "backupInProgress": "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ...",
        "backupSuccess": "Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾.",
        "backupFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.",
        "fileNotFound": "Ğ¤Ğ°Ğ¹Ğ» Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¿Ğ¸Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.",
        "restoreInProgress": "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ...",
        "restoreSuccess": "Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾.",
        "restoreFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ."
      }
    },
    "alerts": {
      "importSuccess": "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾.",
      "importFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸.",
      "saveSuccess": "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!",
      "saveFailedPrefix": "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸: "
    }
  },
  "common": {
    "cancel": "ĞÑ‚Ğ¼ĞµĞ½Ğ°",
    "confirm": "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ",
    "add": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ",
    "delete": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ",
    "edit": "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ",
    "save": "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ",
    "close": "Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ",
    "assignSelected": "ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ",
    "addTag": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞ³",
    "removeIcon": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ",
    "downloadIcon": "Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ",
    "warningTitle": "ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ",
    "refresh": "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ",
    "deleteSelected": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ",
    "noFileSelected": "Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ñ‹.",
    "confirmDeleteMultiple": "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ° ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ {count} Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²?",
    "deleteSuccess": "Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾.",
    "deleteFailed": "ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ.",
    "deleteSuccessMultiple": "Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹.",
    "deleteFailedMultiple": "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²."
  }
}
```
```json
./Anywhere_main/src/locales/zh.json
{
  "app": {
    "header": {
      "chats": "å¯¹è¯ ğŸ’¬",
      "prompts": "å¿«æ·åŠ©æ‰‹ ğŸš€",
      "mcp": "MCP æœåŠ¡ ğŸ”§",
      "providers": "æœåŠ¡å•† â˜ï¸",
      "settings": "è®¾ç½® âš™ï¸"
    },
    "tabs": {
      "chats": "å†å²å¯¹è¯",
      "prompts": "å¿«æ·åŠ©æ‰‹",
      "mcp": "MCP æœåŠ¡",
      "providers": "æœåŠ¡å•†",
      "settings": "è®¾ç½®"
    }
  },
  "chats": {
    "view": {
      "local": "æœ¬åœ°å¯¹è¯",
      "cloud": "äº‘ç«¯å¯¹è¯"
    },
    "info": {
      "title": "è¯´æ˜",
      "localDesc": "Â· æœ¬åœ°å¯¹è¯ï¼šæ¯éš”15ç§’è‡ªåŠ¨ä¿å­˜å·²å‘½åçš„å¯¹è¯åˆ°æœ¬åœ°ï¼ˆå·²ä¿å­˜çš„å¯¹è¯ã€jsonæ–‡ä»¶åŠ è½½çš„å¯¹è¯ã€æ‰“å¼€çš„äº‘ç«¯å¯¹è¯ï¼‰ï¼Œæ‰€æœ‰å¯¹è¯ä»¥jsonæ ¼å¼å­˜å‚¨åœ¨ {path}ï¼Œæ”¯æŒä¸åŒè®¾å¤‡ä¸åŒè·¯å¾„ã€‚",
      "pathNotSet": "å°šæœªé…ç½®",
      "cloudDesc": "Â· äº‘ç«¯å¯¹è¯ï¼šä¸Šä¼ åˆ°äº‘ç«¯çš„å¯¹è¯ï¼Œå¯ä»¥éšæ—¶æ‹‰å–åˆ°æœ¬åœ°ã€‚"
    },
    "configRequired": {
      "title": "äº‘ç«¯å¯¹è¯",
      "webdavDescription": "è¯·å…ˆåœ¨â€œè®¾ç½®â€ä¸­é…ç½® WebDAV URL å’Œæ•°æ®è·¯å¾„ (data_path) ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½",
      "localPathDescription": "è¯·å…ˆåœ¨â€œè®¾ç½®â€é¡µé¢é…ç½®æ‚¨çš„æœ¬åœ°å¯¹è¯å­˜å‚¨è·¯å¾„"
    },
    "table": {
      "filename": "å¯¹è¯åç§°",
      "modifiedTime": "ä¿®æ”¹æ—¶é—´",
      "size": "å¤§å°",
      "actions": "æ“ä½œ"
    },
    "actions": {
      "chat": "èŠå¤©",
      "rename": "é‡å‘½å",
      "delete": "åˆ é™¤",
      "forceSync": "åŒæ­¥"
    },
    "rename": {
      "promptTitle": "é‡å‘½åå¯¹è¯",
      "promptMessage": "è¯·è¾“å…¥æ–°çš„ä¼šè¯åç§°",
      "invalidFilename": "æ–‡ä»¶åæ— æ•ˆï¼Œå¿…é¡»ä»¥ .json ç»“å°¾",
      "syncTitle": "åŒæ­¥æ“ä½œæç¤º",
      "syncCloudConfirm": "äº‘ç«¯ä¹Ÿå­˜åœ¨åŒåæ–‡ä»¶ï¼Œæ˜¯å¦åŒæ­¥é‡å‘½åï¼Ÿ",
      "syncLocalConfirm": "æœ¬åœ°ä¹Ÿå­˜åœ¨åŒåæ–‡ä»¶ï¼Œæ˜¯å¦åŒæ­¥é‡å‘½åï¼Ÿ"
    },
    "tooltips": {
      "syncToCloud": "ä¸Šä¼ è‡³äº‘ç«¯",
      "syncFromCloud": "ä»äº‘ç«¯åŒæ­¥",
      "uploadChanges": "ä¸Šä¼ æœ¬åœ°æ–°å¢å’Œè¾ƒæ–°çš„æ–‡ä»¶ ({count}ä¸ª)",
      "downloadChanges": "ä¸‹è½½äº‘ç«¯æ–°å¢å’Œè¾ƒæ–°çš„æ–‡ä»¶ ({count}ä¸ª)",
      "forceUpload": "å¼ºåˆ¶ä¸Šä¼ æ­¤æ–‡ä»¶åˆ°äº‘ç«¯ (è¦†ç›–)",
      "forceDownload": "å¼ºåˆ¶ä»äº‘ç«¯ä¸‹è½½æ­¤æ–‡ä»¶ (è¦†ç›–)"
    },
    "confirmDelete": "æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤å¯¹è¯ '{filename}' å—ï¼Ÿ",
    "clean": {
      "button": "æ¸…ç†æ—§å¯¹è¯",
      "title": "è‡ªåŠ¨æ¸…ç†å¯¹è¯",
      "timeRangeLabel": "é€‰æ‹©ä¿ç•™æ—¶é—´",
      "customDaysLabel": "è‡ªå®šä¹‰å¤©æ•°",
      "previewTitle": "å°†åˆ é™¤ä»¥ä¸‹ {count} ä¸ª {days} å¤©å‰çš„å¯¹è¯ ({size})",
      "noFilesFound": "æœªå‘ç°ç¬¦åˆæ¡ä»¶çš„æ—§å¯¹è¯",
      "confirmBtn": "ç¡®è®¤æ¸…ç†",
      "success": "æˆåŠŸæ¸…ç† {count} ä¸ªæ–‡ä»¶",
      "ranges": {
        "3": "3å¤©å‰",
        "7": "7å¤©å‰",
        "30": "30å¤©å‰",
        "custom": "è‡ªå®šä¹‰"
      },
      "scopeTip": "æ³¨æ„ï¼šæ­¤æ“ä½œä»…åˆ é™¤å½“å‰è§†å›¾ï¼ˆ{view}ï¼‰ä¸‹çš„æ–‡ä»¶ï¼Œä¸ä¼šåŒæ­¥åˆ é™¤å¦ä¸€ç«¯çš„æ–‡ä»¶ã€‚"
    },
    "alerts": {
      "configError": "è·å–é…ç½®å¤±è´¥",
      "pathNotFound": "æœªæ‰¾åˆ°æŒ‡å®šçš„WebDAVæ•°æ®è·¯å¾„",
      "pathCreated": "æ•°æ®è·¯å¾„ä¸å­˜åœ¨ï¼Œå·²è‡ªåŠ¨åˆ›å»º",
      "fetchFailed": "è·å–å¯¹è¯åˆ—è¡¨å¤±è´¥",
      "loadingChat": "æ­£åœ¨åŠ è½½å¯¹è¯...",
      "restoreInitiated": "å¯¹è¯å·²å¼€å§‹",
      "restoreFailed": "æ¢å¤å¯¹è¯å¤±è´¥",
      "renameSuccess": "é‡å‘½åæˆåŠŸ",
      "renameFailed": "é‡å‘½åå¤±è´¥",
      "syncInProgress": "åŒæ­¥ä¸­...",
      "syncPreparingUpload": "å‡†å¤‡ä¸Šä¼ ...",
      "syncPreparingDownload": "å‡†å¤‡ä¸‹è½½...",
      "syncProcessing": "å¤„ç†ä¸­... {completed}/{total}",
      "syncCancelled": "åŒæ­¥æ“ä½œå·²å–æ¶ˆ",
      "syncSuccessUpload": "{count}ä¸ªæ–‡ä»¶æˆåŠŸåŒæ­¥åˆ°äº‘ç«¯ã€‚",
      "syncSuccessDownload": "{count}ä¸ªæ–‡ä»¶æˆåŠŸåŒæ­¥åˆ°æœ¬åœ°ã€‚",
      "syncFailedPartially": "{failedCount}ä¸ªæ–‡ä»¶å¤±è´¥ã€‚",
      "syncFailed": "åŒæ­¥å¤±è´¥: {message}",
      "syncConfirmUpload": "è¿™å°†æŠŠæ‰€æœ‰æœ¬åœ°å¯¹è¯ä¸Šä¼ åˆ°äº‘ç«¯ï¼ŒåŒåæ–‡ä»¶å°†è¢«è¦†ç›–ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ",
      "syncConfirmUploadTitle": "ä¸Šä¼ åˆ°äº‘ç«¯",
      "syncConfirmDownload": "è¿™å°†æŠŠæ‰€æœ‰äº‘ç«¯å¯¹è¯ä¸‹è½½åˆ°æœ¬åœ°ï¼ŒåŒåæ–‡ä»¶å°†è¢«è¦†ç›–ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ",
      "syncConfirmDownloadTitle": "ä»äº‘ç«¯åŒæ­¥",
      "syncNoUpload": "æ‰€æœ‰æœ¬åœ°æ–‡ä»¶å‡å·²æ˜¯æœ€æ–°æˆ–äº‘ç«¯ç‰ˆæœ¬è¾ƒæ–°ï¼Œæ— éœ€ä¸Šä¼ ã€‚",
      "syncNoDownload": "æ‰€æœ‰äº‘ç«¯æ–‡ä»¶å‡å·²åŒæ­¥æˆ–æœ¬åœ°ç‰ˆæœ¬è¾ƒæ–°ï¼Œæ— éœ€ä¸‹è½½ã€‚",
      "confirmSyncDeleteTitle": "åŒæ­¥åˆ é™¤ç¡®è®¤",
      "confirmSyncDeleteMessage": "æ‚¨é€‰æ‹©çš„æ–‡ä»¶ä¸­ï¼Œæœ‰ {count} ä¸ªåœ¨ {location} ä¹Ÿå­˜åœ¨ã€‚æ˜¯å¦è¦ä¸€å¹¶åˆ é™¤ï¼Ÿ",
      "webdavRequired": "è¯·å…ˆé…ç½®WebDAV",
      "localPathRequired": "è¯·å…ˆé…ç½®æœ¬åœ°å¯¹è¯è·¯å¾„",
      "continueConfirm": "æ˜¯å¦ç»§ç»­ï¼Ÿ",
      "restoreChat": "æ¢å¤èŠå¤©"
    }
  },
  "prompts": {
    "allPrompts": "å…¨éƒ¨",
    "searchPlaceholder": "æœç´¢åç§°æˆ–å†…å®¹...",
    "noPrompts": "å°šæœªå®šä¹‰ä»»ä½•å¿«æ·åŠ©æ‰‹",
    "noPromptsInTag": "æ­¤æ ‡ç­¾ä¸‹æ²¡æœ‰å¿«æ·åŠ©æ‰‹",
    "addExistingPrompt": "æ·»åŠ å·²æœ‰å¿«æ·åŠ©æ‰‹",
    "addNewPrompt": "æ–°å¢å¿«æ·åŠ©æ‰‹",
    "editPrompt": "ç¼–è¾‘å¿«æ·åŠ©æ‰‹",
    "addNewTag": "æ–°å¢æ ‡ç­¾",
    "assignPromptsToTag": "æ·»åŠ å¿«æ·åŠ©æ‰‹åˆ° '{tagName}'",
    "promptKeyLabel": "åç§°",
    "promptKeyPlaceholder": "ä¾‹å¦‚, CodeGeneration",
    "typeLabel": "ç±»å‹",
    "iconLabel": "å›¾æ ‡",
    "iconUploadTip": "æ”¯æŒ {formats} æ ¼å¼ï¼Œæœ€å¤§ {maxSize}",
    "dragIconHere": "æ‹–æ‹½",
    "orClickToUpload": "æˆ–ç‚¹å‡»",
    "disableAll": "å…¨éƒ¨ç¦ç”¨",
    "enableAll": "å…¨éƒ¨å¯ç”¨",
    "openWindow": "ç›´æ¥æ‰“å¼€å¯¹è¯çª—å£",
    "deletePrompt": "åˆ é™¤æ­¤å¿«æ·åŠ©æ‰‹",
    "inputPlaceholder": "è¯·è¾“å…¥æç¤ºè¯å†…å®¹...",
    "selectNewModel": "è¯·é€‰æ‹©æ–°çš„æ¨¡å‹",
    "icon": {
      "uploadText": "æ‹–æ‹½/ç²˜è´´\nç‚¹å‡»ä¸Šä¼ ",
      "downloadTooltip": "ä¸‹è½½å›¾æ ‡",
      "removeTooltip": "ç§»é™¤å›¾æ ‡"
    },
    "iconEditor": {
      "hint": "æ‹–æ‹½ç§»åŠ¨ / æ»šè½®ç¼©æ”¾",
      "scale": "ç¼©æ”¾",
      "radius": "åœ†è§’",
      "cancel": "å–æ¶ˆ",
      "confirm": "ç¡®å®šä½¿ç”¨"
    },
    "background": {
      "imageLabel": "çª—å£èƒŒæ™¯å›¾ç‰‡ (URL)",
      "imagePlaceholder": "è¾“å…¥å›¾ç‰‡é“¾æ¥ (http/https/data:image)",
      "opacityLabel": "èƒŒæ™¯ä¸é€æ˜åº¦",
      "blurLabel": "èƒŒæ™¯æ¨¡ç³Šåº¦"
    },
    "regex": {
      "label": "è‡ªå®šä¹‰æ­£åˆ™åŒ¹é…",
      "tooltip": "å½“è¾“å…¥ç±»å‹ä¸º'æ–‡æœ¬'æ—¶ï¼Œå¯é€šè¿‡æ­¤é¡¹è®¾ç½®æ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…ç‰¹å®šå†…å®¹ã€‚1. æ ¼å¼å¿…é¡»ä¸º /.../flagsï¼Œä¾‹å¦‚ /^https?:\\/\\// ç”¨äºåŒ¹é…ç½‘å€ã€‚2. é‡è¦ï¼šè¡¨è¾¾å¼ä¸­çš„åæ–œæ  \\ å¿…é¡»è½¬ä¹‰å†™æˆ \\\\ã€‚3. flags æ˜¯å¯é€‰æ ‡å¿—ï¼Œå¦‚ i è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™ (ä¾‹å¦‚ /hello/i)ã€‚4. å¦‚æœç•™ç©ºï¼Œåˆ™ä¼šåŒ¹é…ä»»æ„æ–‡æœ¬ã€‚å¸¸ç”¨ç¬¦å·é€ŸæŸ¥:â€¢ . - åŒ¹é…é™¤æ¢è¡Œå¤–çš„ä»»æ„å­—ç¬¦â€¢ \\d - åŒ¹é…ä»»æ„æ•°å­—â€¢ \\s - åŒ¹é…ä»»æ„ç©ºç™½ç¬¦ (ç©ºæ ¼, tab, æ¢è¡Œ)â€¢ \\S - åŒ¹é…ä»»æ„éç©ºç™½ç¬¦â€¢ \\w - åŒ¹é…å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿â€¢ [...] - åŒ¹é…æ‹¬å·å†…ä»»ä¸€å­—ç¬¦, å¦‚ [abc]â€¢ * - åŒ¹é…0æ¬¡æˆ–å¤šæ¬¡â€¢ + - åŒ¹é…1æ¬¡æˆ–å¤šæ¬¡â€¢ ? - åŒ¹é…0æ¬¡æˆ–1æ¬¡â€¢ ^ - åŒ¹é…å¼€å¤´â€¢ $ - åŒ¹é…ç»“å°¾",
      "placeholder": "/.../flags (ç•™ç©ºåˆ™åŒ¹é…ä»»æ„æ–‡æœ¬)"
    },
    "typeOptions": {
      "general": "é€šç”¨",
      "text": "æ–‡æœ¬",
      "image": "æˆªå›¾",
      "files": "æ–‡ä»¶"
    },
    "showModeLabel": "æ˜¾ç¤ºæ¨¡å¼",
    "showModeOptions": {
      "fastinput": "å¿«æ·è¾“å…¥",
      "window": "ç‹¬ç«‹çª—å£"
    },
    "promptKeyLabelShort": "åç§°",
    "modelLabel": "æ¨¡å‹",
    "llmParametersLabel": "æ¨¡å‹å‚æ•°",
    "llmParametersRemark": "ä»…å½“å‰ å¿«æ·åŠ©æ‰‹ æ¨¡å‹ç”Ÿæ•ˆï¼Œæ›´æ¢å…¶ä»–æ¨¡å‹åä¸å†ç”Ÿæ•ˆ",
    "AssistantParametersLabel": "å¿«æ·åŠ©æ‰‹å‚æ•°",
    "sendDirectLabel": "æ–‡æœ¬/æˆªå›¾ç›´æ¥å‘é€",
    "sendFileLabel": "æ–‡ä»¶ç›´æ¥å‘é€",
    "ifTextNecessary": "è¡¥å……æ–‡æœ¬ä¿¡æ¯",
    "streamLabel": "æµå¼å“åº”",
    "enableTemperatureLabel": "è‡ªå®šä¹‰æ¸©åº¦",
    "temperatureLabel": "æ¸©åº¦è®¾ç½®",
    "promptContentLabel": "å¿«æ·åŠ©æ‰‹å†…å®¹",
    "enabledLabel": "å¯ç”¨",
    "addToTagLabel": "æ·»åŠ åˆ°æ ‡ç­¾ (å¯é€‰)",
    "addToTagPlaceholder": "é€‰æ‹©æ ‡ç­¾ (å¯é€‰)",
    "tagNameLabel": "æ ‡ç­¾å",
    "selectPromptsToAddLabel": "é€‰æ‹©è¦æ·»åŠ çš„å¿«æ·åŠ©æ‰‹",
    "selectPromptsPlaceholder": "é€‰æ‹©å¿«æ·åŠ©æ‰‹",
    "isAlwaysOnTopLabel": "çª—å£ç½®é¡¶",
    "autoCloseOnBlurLabel": "å¤±ç„¦å…³é—­",
    "autoSaveChatLabel": "è‡ªåŠ¨ä¿å­˜èŠå¤©",
    "replaceModels": "æ›¿æ¢æ¨¡å‹",
    "replaceModelsDialog": {
      "title": "æ‰¹é‡æ›¿æ¢æ¨¡å‹",
      "sourceModel": "æºæ¨¡å‹",
      "targetModel": "ç›®æ ‡æ¨¡å‹"
    },
    "alerts": {
      "tagNameEmpty": "æ ‡ç­¾åä¸èƒ½ä¸ºç©º",
      "tagExists": "æ ‡ç­¾ \"{tagName}\" å·²å­˜åœ¨",
      "promptKeyEmpty": "å¿«æ·åŠ©æ‰‹åç§°ä¸èƒ½ä¸ºç©º",
      "promptKeyExists": "å¿«æ·åŠ©æ‰‹åç§° \"{newKey}\" å·²å­˜åœ¨",
      "targetTagNotFound": "ç›®æ ‡æ ‡ç­¾æœªæ‰¾åˆ°",
      "noPromptsToAssign": "æ²¡æœ‰å…¶ä»–å¯åˆ†é…åˆ°æ­¤æ ‡ç­¾çš„å¿«æ·åŠ©æ‰‹",
      "invalidImageFormat": "å›¾ç‰‡æ ¼å¼æ— æ•ˆè¯·ä½¿ç”¨ {formats}",
      "imageSizeTooLarge": "å›¾ç‰‡å¤§å°è¶…è¿‡ {maxSize}",
      "modelsReplacedSuccess": "æˆåŠŸæ›¿æ¢äº† {count} ä¸ªå¿«æ·åŠ©æ‰‹çš„æ¨¡å‹ã€‚",
      "refreshSuccess": "å¿«æ·åŠ©æ‰‹é…ç½®å·²åˆ·æ–°ï¼",
      "noIconToDownload": "æ²¡æœ‰å¯ä¾›ä¸‹è½½çš„å›¾æ ‡ã€‚",
      "selectModels": "è¯·é€‰æ‹©æºæ¨¡å‹å’Œç›®æ ‡æ¨¡å‹ã€‚",
      "sameModels": "æºæ¨¡å‹å’Œç›®æ ‡æ¨¡å‹ä¸èƒ½ç›¸åŒã€‚",
      "configFetchFailed": "æ— æ³•è·å–æœ€æ–°çš„å¿«æ·åŠ©æ‰‹è®¾ç½®ï¼Œå¯èƒ½æ˜¾ç¤ºæ—§æ•°æ®ã€‚",
      "promptNotFound": "å¿«æ·åŠ©æ‰‹ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«å…¶ä»–æ“ä½œåˆ é™¤ã€‚",
      "saveFailed": "é…ç½®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•",
      "saveSettingFailed": "ä¿å­˜å¤±è´¥"
    },
    "tooltips": {
      "moveLeft": "å·¦ç§»",
      "moveRight": "å³ç§»",
      "removeFromTag": "ä»æ­¤æ ‡ç­¾ç§»é™¤å¿«æ·åŠ©æ‰‹",
      "sendDirect": "å¼€å¯åï¼Œé€‰ä¸­æ–‡å­—æˆ–æˆªå›¾åå°†ç›´æ¥å‘é€ç»™AI",
      "sendFile": "å¼€å¯åï¼Œé€‰ä¸­æ–‡ä»¶åå°†ç›´æ¥å‘é€ç»™AIå¹¶å¤„ç†ç»“æœ",
      "ifTextNecessary": "å¼€å¯åï¼Œç”¨æˆ·å¦‚æœå‘é€ç©ºæ–‡æœ¬æ¶ˆæ¯åˆ™æ·»åŠ æ—¶é—´æˆ³ï¼Œä»¥ç¡®ä¿æ¯æ¬¡è¯·æ±‚éƒ½åŒ…å«æ–‡æœ¬ï¼Œæ»¡è¶³éƒ¨åˆ†æœåŠ¡å•†è¦æ±‚ï¼ˆvertexï¼‰",
      "reasoningEffort": "è®¾ç½®æ¨¡å‹æ€è€ƒè¿‡ç¨‹çš„è®¡ç®—é¢„ç®—ã€‚æ›´é«˜çš„å€¼å¯èƒ½ä¼šäº§ç”Ÿæ›´è¯¦å°½çš„å›ç­”ï¼Œä½†ä¼šå¢åŠ å»¶è¿Ÿå’Œæˆæœ¬ã€‚",
      "isAlwaysOnTopTooltip": "å¯ç”¨ä»¥ä½¿çª—å£å§‹ç»ˆä¿æŒåœ¨æœ€ä¸Šå±‚ã€‚",
      "autoCloseOnBlurTooltip": "å¯ç”¨ä»¥åœ¨ç‹¬ç«‹çª—å£å¤±å»ç„¦ç‚¹æ—¶å°†å…¶å…³é—­ã€‚",
      "autoSaveChatTooltip": "å¼€å¯åï¼Œå¯¹è¯å°†æ¯éš”15ç§’è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼ˆéœ€å…ˆåœ¨è®¾ç½®ä¸­é…ç½®æœ¬åœ°å¯¹è¯è·¯å¾„ï¼‰ã€‚",
      "defaultMcpServers": "è®¾ç½®åï¼Œåœ¨ç‹¬ç«‹çª—å£æ‰“å¼€æ­¤åŠ©æ‰‹æ—¶å°†è‡ªåŠ¨å¯ç”¨æ‰€é€‰çš„MCPæœåŠ¡ã€‚"
    },
    "voiceLabel": "é»˜è®¤å£°éŸ³",
    "voicePlaceholder": "é€‰æ‹©ä¸€ä¸ªå£°éŸ³æˆ–å…³é—­",
    "voiceTooltip": "é€‰æ‹©å£°éŸ³åé»˜è®¤å¼€å¯è¯­éŸ³è¾“å‡ºï¼Œæ¨¡å‹é¡»æ”¯æŒè¯­éŸ³è¾“å‡ºï¼Œé€‰æ‹©â€œå…³é—­â€åˆ™ä¸ä½¿ç”¨",
    "voiceOptions": {
      "off": "å…³é—­"
    },
    "reasoningEffortLabel": "æ€è€ƒé¢„ç®—",
    "reasoningEffort": {
      "default": "é»˜è®¤",
      "low": "ä½",
      "medium": "ä¸­",
      "high": "é«˜"
    },
    "defaultMcpServersLabel": "MCP",
    "defaultMcpServersPlaceholder": "é€‰æ‹©æ­¤åŠ©æ‰‹é»˜è®¤å¯ç”¨çš„MCPæœåŠ¡"
  },
  "mcp": {
    "title": "MCP æœåŠ¡",
    "addServer": "æ·»åŠ  MCP æœåŠ¡",
    "editJson": "ç¼–è¾‘ JSON",
    "noServers": "å°šæœªé…ç½® MCP æœåŠ¡ã€‚",
    "searchPlaceholder": "æœç´¢åç§°ã€æè¿°ã€æä¾›è€…æˆ–æ ‡ç­¾...",
    "noMatch": "æœªæ‰¾åˆ°åŒ¹é…çš„æœåŠ¡",
    "addServerTitle": "æ·»åŠ æ–° MCP æœåŠ¡",
    "editServerTitle": "ç¼–è¾‘ MCP æœåŠ¡",
    "nameLabel": "åç§°",
    "descriptionLabel": "æè¿°",
    "typeLabel": "ç±»å‹",
    "activeLabel": "å¯ç”¨",
    "persistentOn": "æŒä¹…è¿æ¥å·²å¼€å¯",
    "persistentOff": "æŒä¹…è¿æ¥å·²å…³é—­",
    "testConnectionTooltip": "æµ‹è¯•è¿æ¥ / æŸ¥çœ‹ç¼“å­˜å·¥å…·",
    "refreshTooltip": "å¼ºåˆ¶åˆ·æ–°ï¼ˆé‡æ–°è¿æ¥è·å–ï¼‰",
    "connecting": "æ­£åœ¨è¿æ¥å¹¶è·å–å·¥å…·åˆ—è¡¨...",
    "connectionSuccess": "è¿æ¥æˆåŠŸï¼è·å–åˆ° {count} ä¸ªå·¥å…·",
    "connectionFailed": "è¿æ¥å¤±è´¥",
    "toolList": "å·¥å…·åˆ—è¡¨:",
    "cached": "å·²ç¼“å­˜",
    "noDescription": "æ— æè¿°",
    "noToolsProvided": "è¯¥æœåŠ¡æœªæä¾›ä»»ä½•å·¥å…·",
    "refreshConfig": "åˆ·æ–° MCP æœåŠ¡é…ç½®",
    "typeOptions": {
      "stdio": "Stdio",
      "http": "å¯æµå¼ HTTP",
      "sse": "SSE",
      "builtin": "å†…ç½®"
    },
    "stdio": {
      "command": "å‘½ä»¤",
      "args": "å‚æ•°",
      "env": "ç¯å¢ƒå˜é‡"
    },
    "http": {
      "url": "åŸºç¡€ URL",
      "headers": "è¯·æ±‚å¤´"
    },
    "advanced": "é«˜çº§/å¯é€‰è®¾ç½®",
    "registryUrl": "æ³¨å†Œè¡¨ URL",
    "providerName": "æœåŠ¡å•†åç§°",
    "providerUrl": "æœåŠ¡å•†é“¾æ¥",
    "logoUrl": "å›¾æ ‡é“¾æ¥",
    "tags": "æ ‡ç­¾",
    "argsPlaceholder": "æ¯è¡Œè¾“å…¥ä¸€ä¸ªå‚æ•°",
    "envPlaceholder": "KEY1: VALUE1\nKEY2: VALUE2",
    "headersPlaceholder": "Header-Name: Header-Value\nAuthorization: Bearer token",
    "tagsPlaceholder": "è¾“å…¥æ ‡ç­¾ï¼Œä»¥é€—å·åˆ†éš”",
    "alerts": {
      "deleteConfirmTitle": "ç¡®è®¤åˆ é™¤",
      "deleteConfirmText": "æ‚¨ç¡®å®šè¦åˆ é™¤ MCP æœåŠ¡ â€œ{name}â€ å—ï¼Ÿ",
      "saveSuccess": "MCP æœåŠ¡ä¿å­˜æˆåŠŸã€‚",
      "saveFailed": "MCP æœåŠ¡ä¿å­˜å¤±è´¥ã€‚",
      "deleteSuccess": "MCP æœåŠ¡åˆ é™¤æˆåŠŸã€‚",
      "deleteFailed": "MCP æœåŠ¡åˆ é™¤å¤±è´¥ã€‚",
      "invalidJson": "JSON æ ¼å¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥æ‚¨çš„è¾“å…¥ã€‚",
      "jsonError": "JSONå¿…é¡»æ˜¯ä¸€ä¸ªåŒ…å« \"mcpServers\" é”®çš„å¯¹è±¡ã€‚",
      "configCopied": "æœåŠ¡å™¨é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿",
      "refreshSuccess": "MCP æœåŠ¡é…ç½®å·²åˆ·æ–°ï¼",
      "configInvalid": "æœªèƒ½è·å–åˆ°æœ‰æ•ˆçš„é…ç½®æ•°æ®ã€‚",
      "refreshFailed": "åˆ·æ–°é…ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚",
      "testSuccess": "æµ‹è¯•æˆåŠŸã€‚",
      "testFailed": "æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„é…ç½®ã€‚"
    },
    "jsonDialog": {
      "title": "ç¼–è¾‘ MCP æœåŠ¡ JSON",
      "description": "è­¦å‘Šï¼šç›´æ¥ç¼–è¾‘ JSON å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼Œå¦‚æœæ ¼å¼ä¸æ­£ç¡®ã€‚è¯·è°¨æ…æ“ä½œã€‚"
    },
    "persistent": {
      "label": "æŒä¹…è¿æ¥",
      "tooltip": "å¼€å¯åå°†ä¿æŒé•¿è¿æ¥ï¼Œä¼šå ç”¨æ€»è¿æ¥æ•°ï¼ˆæœ€å¤š5ä¸ªï¼‰ï¼Œé€‚åˆéƒ¨åˆ†æ— æ³•æ–­å¼€çš„StdioæœåŠ¡ã€‚"
    },
    "tabs": {
      "tools": "å¯ç”¨å·¥å…·",
      "test": "è°ƒç”¨æµ‹è¯•"
    },
    "hints": {
      "selectTools": "è¯·å‹¾é€‰éœ€è¦å¯ç”¨çš„å·¥å…·"
    },
    "test": {
      "selectTool": "é€‰æ‹©å·¥å…·:",
      "selectToolPlaceholder": "è¯·é€‰æ‹©è¦æµ‹è¯•çš„å·¥å…·",
      "run": "è¿è¡Œ",
      "cancel": "å–æ¶ˆ",
      "noParams": "æ­¤å·¥å…·æ— éœ€å‚æ•°",
      "paramErrorJson": "å‚æ•° {key} æ ¼å¼é”™è¯¯: å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON",
      "paramErrorNumber": "å‚æ•° {key} æ ¼å¼é”™è¯¯: å¿…é¡»æ˜¯æ•°å­—",
      "successNoContent": "æ‰§è¡ŒæˆåŠŸï¼Œæ— è¿”å›å†…å®¹ã€‚",
      "executionError": "æ‰§è¡Œé”™è¯¯: ",
      "systemError": "ç³»ç»Ÿé”™è¯¯: ",
      "opCancelled": "æ“ä½œå·²å–æ¶ˆ",
      "saveToolStateFailed": "ä¿å­˜å·¥å…·çŠ¶æ€å¤±è´¥",
      "inputJsonPlaceholder": "è¯·è¾“å…¥ JSON æ ¼å¼çš„ {type}",
      "inputPlaceholder": "è¯·è¾“å…¥å‚æ•°å€¼",
      "default": "é»˜è®¤",
      "leaveEmpty": "ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼",
      "response": "å“åº”ç»“æœ:"
    }
  },
  "providers": {
    "addProviderBtn": "æ·»åŠ æœåŠ¡å•†",
    "noProviders": "æš‚æ— æœåŠ¡å•†",
    "statusOff": "å…³é—­",
    "unnamedProvider": "æœªå‘½åæœåŠ¡å•†",
    "editNameTooltip": "ç¼–è¾‘åç§°",
    "moveUpTooltip": "ä¸Šç§»",
    "moveDownTooltip": "ä¸‹ç§»",
    "deleteProviderTooltip": "åˆ é™¤æœåŠ¡å•†",
    "apiKeyLabel": "API å¯†é’¥",
    "apiKeyPlaceholder": "è¾“å…¥ API å¯†é’¥ (å¯è¾“å…¥å¤šä¸ªï¼Œç”¨é€—å·åˆ†éš”)",
    "apiKeyDescription": "å¯ä»¥è¾“å…¥å¤šä¸ª API å¯†é’¥ï¼Œç”¨é€—å·åˆ†éš”",
    "apiUrlLabel": "API URL",
    "apiUrlPlaceholder": "ä¾‹å¦‚, https://api.openai.com/v1",
    "modelsLabel": "æ¨¡å‹",
    "searchModelsPlaceholder": "æœç´¢æ¨¡å‹",
    "noModelsAdded": "å°šæœªæ·»åŠ æ¨¡å‹",
    "getModelsFromApiBtn": "ä» API è·å–æ¨¡å‹",
    "addManuallyBtn": "æ‰‹åŠ¨æ·»åŠ ",
    "selectProviderOrAdd": "é€‰æ‹©ä¸€ä¸ªæœåŠ¡å•†æˆ–æ·»åŠ æ–°çš„",
    "addProviderDialogTitle": "æ·»åŠ æ–°æœåŠ¡å•†",
    "providerNameLabel": "æœåŠ¡å•†åç§°",
    "providerNamePlaceholder": "ä¾‹å¦‚, OpenAI ä¸»è´¦æˆ·",
    "changeProviderNameDialogTitle": "æ›´æ”¹æœåŠ¡å•†åç§°",
    "addModelDialogTitle": "æ‰‹åŠ¨æ·»åŠ æ¨¡å‹",
    "modelNameIdLabel": "æ¨¡å‹åç§°/ID",
    "modelNameIdPlaceholder": "ä¾‹å¦‚, gpt-4, text-davinci-003",
    "availableModelsDialogTitle": "API å¯ç”¨æ¨¡å‹",
    "table": {
      "modelId": "æ¨¡å‹ ID",
      "ownedBy": "æ‰€æœ‰è€…",
      "action": "æ“ä½œ"
    },
    "folders": {
      "createSuccess": "ç›®å½•åˆ›å»ºæˆåŠŸ",
      "renameSuccess": "ç›®å½•é‡å‘½åæˆåŠŸ",
      "deleteSuccess": "ç›®å½•å·²åˆ é™¤",
      "deleteConfirmTitle": "åˆ é™¤ç¡®è®¤",
      "deleteConfirmMessage": "ç¡®å®šè¦åˆ é™¤æ­¤ç›®å½•å—ï¼Ÿå†…éƒ¨çš„æœåŠ¡å•†å°†ç§»åŠ¨åˆ°æ ¹ç›®å½•ã€‚",
      "floder_label": "ç›®å½•",
      "root": "æ ¹ç›®å½•",
      "empty": "(ç©º)",
      "newFolderTitle": "æ–°å»ºç›®å½•",
      "renameFolderTitle": "é‡å‘½åç›®å½•",
      "folderNameLabel": "ç›®å½•åç§°",
      "folderNamePlaceholder": "è¯·è¾“å…¥åç§°"
    },
    "noModelsFoundError": "æœªæ‰¾åˆ°æ¨¡å‹æˆ– API é”™è¯¯",
    "noModelsMatchSearch": "æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡å‹",
    "addModelTooltip": "æ·»åŠ æ¨¡å‹",
    "removeModelTooltip": "ç§»é™¤æ¨¡å‹",
    "alerts": {
      "providerUrlNotSet": "æœåŠ¡å•† URL æœªè®¾ç½®",
      "fetchModelsError": "é”™è¯¯ {status}: {message}",
      "fetchModelsFailedDefault": "è·å–æ¨¡å‹å¤±è´¥",
      "configSaveFailed": "ä¿å­˜é…ç½®å¤±è´¥",
      "saveFailed": "ä¿å­˜å¤±è´¥"
    }
  },
  "setting": {
    "language": {
      "label": "è¯­è¨€",
      "english": "English",
      "chinese": "ä¸­æ–‡",
      "japanese": "æ—¥æœ¬èª",
      "russian": "Ğ ÑƒÑÑĞºĞ¸Ğ¹",
      "selectPlaceholder": "é€‰æ‹©è¯­è¨€"
    },
    "voice": {
      "title": "è¯­éŸ³è®¾ç½®  (å£°éŸ³åç§°-è‡ªå®šä¹‰æè¿°)",
      "description": "ç®¡ç†å¯ç”¨äºè¯­éŸ³åˆæˆçš„å£°éŸ³åˆ—è¡¨",
      "add": "æ·»åŠ å£°éŸ³",
      "addPromptTitle": "æ·»åŠ æ–°å£°éŸ³",
      "addPromptMessage": "è¯·è¾“å…¥å£°éŸ³åç§°ï¼ˆä¾‹å¦‚, alloyï¼‰",
      "addSuccess": "å£°éŸ³æ·»åŠ æˆåŠŸ",
      "addFailExists": "å£°éŸ³å·²å­˜åœ¨",
      "addFailEmpty": "å£°éŸ³åç§°ä¸èƒ½ä¸ºç©º",
      "editPromptTitle": "ä¿®æ”¹å£°éŸ³åç§°",
      "editPromptMessage": "è¯·è¾“å…¥æ–°çš„å£°éŸ³åç§°",
      "editSuccess": "å£°éŸ³ä¿®æ”¹æˆåŠŸ"
    },
    "title": "é€šç”¨è®¾ç½®",
    "isAlwaysOnTop_global": {
      "label": "å…¨å±€çª—å£ç½®é¡¶",
      "description": "ç»Ÿä¸€æ§åˆ¶æ‰€æœ‰å¿«æ·åŠ©æ‰‹çš„çª—å£æ˜¯å¦ç½®é¡¶"
    },
    "autoCloseOnBlur_global": {
      "label": "å…¨å±€å¤±ç„¦å…³é—­",
      "description": "ç»Ÿä¸€æ§åˆ¶æ‰€æœ‰å¿«æ·åŠ©æ‰‹çš„çª—å£æ˜¯å¦åœ¨å¤±ç„¦åè‡ªåŠ¨å…³é—­"
    },
    "autoSaveChat_global": {
      "label": "å…¨å±€è‡ªåŠ¨ä¿å­˜å¯¹è¯",
      "description": "ç»Ÿä¸€æ§åˆ¶æ‰€æœ‰å¿«æ·åŠ©æ‰‹æ˜¯å¦è‡ªåŠ¨ä¿å­˜å¯¹è¯åˆ°æœ¬åœ°"
    },
    "skipLineBreak": {
      "label": "å‘é€æ—¶è·³è¿‡æ¢è¡Œç¬¦",
      "description": "å¯ç”¨ä»¥åœ¨åˆ’è¯æ—¶è·³è¿‡æ¢è¡Œç¬¦"
    },
    "ctrlEnter": {
      "label": "Ctrl+Enter å‘é€",
      "description": "å¯ç”¨ä»¥é€šè¿‡æŒ‰ Ctrl+Enter å‘é€æ¶ˆæ¯"
    },
    "notification": {
      "label": "æ˜¾ç¤ºæˆåŠŸé€šçŸ¥",
      "description": "å¯ç”¨ä»¥åœ¨å“åº”æˆåŠŸæ—¶æ˜¾ç¤ºé€šçŸ¥"
    },
    "darkMode": {
      "label": "ä¸»é¢˜",
      "description": "æµ…è‰²æ¨¡å¼æˆ–æ·±è‰²æ¨¡å¼",
      "dark": "æ·±è‰²",
      "light": "æµ…è‰²",
      "system": "è·Ÿéšç³»ç»Ÿ"
    },
    "fixPosition": {
      "label": "å›ºå®šçª—å£ä½ç½®",
      "description": "å¯ç”¨ä»¥å›ºå®šå¯¹è¯çª—å£å‡ºç°çš„ä½ç½®"
    },
    "dataManagement": {
      "title": "æ•°æ®ç®¡ç†",
      "exportLabel": "å¯¼å‡ºé…ç½®",
      "exportDesc": "å°†å½“å‰æ‰€æœ‰è®¾ç½®å¯¼å‡ºä¸º JSON æ–‡ä»¶ï¼Œ æ³¨æ„é…ç½®æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œåˆ‡å‹¿åˆ†äº«",
      "exportButton": "å¯¼å‡º",
      "importLabel": "å¯¼å…¥é…ç½®",
      "importDesc": "ä» JSON æ–‡ä»¶å¯¼å…¥è®¾ç½®ï¼Œè¿™å°†è¦†ç›–å½“å‰è®¾ç½®",
      "importButton": "å¯¼å…¥"
    },
    "dimensions": {
      "widthLabel": "çª—å£å®½åº¦ (px)",
      "heightLabel": "çª—å£é«˜åº¦ (px)"
    },
    "webdav": {
      "url": "WebDAV åœ°å€",
      "urlPlaceholder": "http://localhost:8080",
      "username": "WebDAV ç”¨æˆ·å",
      "usernamePlaceholder": "WebDAV ç”¨æˆ·å",
      "password": "WebDAV å¯†ç ",
      "passwordPlaceholder": "WebDAV å¯†ç ",
      "path": "WebDAV é…ç½®è·¯å¾„",
      "pathPlaceholder": "/anywhere",
      "dataPath": "WebDAV æ•°æ®è·¯å¾„",
      "dataPathPlaceholder": "/anywhere_data",
      "backupRestoreTitle": "é…ç½®å¤‡ä»½ä¸æ¢å¤",
      "backupButton": "å¤‡ä»½åˆ° WebDAV",
      "restoreButton": "ç®¡ç†å¤‡ä»½",
      "localChatPath": "æœ¬åœ°å¯¹è¯è·¯å¾„",
      "localChatPathPlaceholder": "è¯·é€‰æ‹©ç”¨äºå­˜æ”¾å¯¹è¯è®°å½•çš„æœ¬åœ°æ–‡ä»¶å¤¹",
      "selectFolder": "é€‰æ‹©æ–‡ä»¶å¤¹",
      "webdavDescription": "è¯·å…ˆåœ¨â€œè®¾ç½®â€é¡µé¢é…ç½® WebDAV URL å’Œæ•°æ®è·¯å¾„",
      "backup": {
        "confirmTitle": "ç¡®è®¤å¤‡ä»½æ–‡ä»¶å",
        "confirmMessage": "è¯·è¾“å…¥å¤‡ä»½æ–‡ä»¶åå»ºè®®ä½¿ç”¨é»˜è®¤æ–‡ä»¶åä»¥ä¿ç•™æ—¶é—´æˆ³",
        "invalidFilename": "æ–‡ä»¶åæ— æ•ˆï¼Œå¿…é¡»ä»¥ .json ç»“å°¾",
        "cancelled": "å¤‡ä»½å·²å–æ¶ˆ",
        "emptyFilenameError": "æ–‡ä»¶åä¸èƒ½ä¸ºç©º",
        "inputFilename": "è¯·è¾“å…¥æ–‡ä»¶å"
      },
      "manager": {
        "title": "å¤‡ä»½æ•°æ®ç®¡ç†",
        "pathNotFound": "æŒ‡å®šçš„ WebDAV è·¯å¾„ä¸å­˜åœ¨",
        "fetchFailed": "è·å–å¤‡ä»½åˆ—è¡¨å¤±è´¥",
        "filename": "æ–‡ä»¶å",
        "modifiedTime": "ä¿®æ”¹æ—¶é—´",
        "size": "å¤§å°",
        "actions": "æ“ä½œ",
        "restore": "æ¢å¤",
        "delete": "åˆ é™¤",
        "confirmRestore": "æ‚¨ç¡®å®šè¦æ¢å¤æ­¤å¤‡ä»½æ–‡ä»¶ '{filename}' å—ï¼Ÿæ­¤æ“ä½œå°†è¦†ç›–æ‚¨å½“å‰çš„é…ç½®",
        "confirmDelete": "æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ–‡ä»¶ '{filename}' å—ï¼Ÿ",
        "noFileSelected": "æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶",
        "confirmDeleteMultiple": "æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ {count} ä¸ªæ–‡ä»¶å—ï¼Ÿ",
        "deleteSuccess": "åˆ é™¤æˆåŠŸ",
        "deleteFailed": "åˆ é™¤å¤±è´¥",
        "deleteSuccessMultiple": "é€‰ä¸­çš„æ–‡ä»¶å·²æˆåŠŸåˆ é™¤",
        "deleteFailedMultiple": "åˆ é™¤é€‰ä¸­çš„æ–‡ä»¶æ—¶å‡ºé”™"
      },
      "alerts": {
        "urlRequired": "WebDAV åœ°å€ä¸èƒ½ä¸ºç©º",
        "backupInProgress": "æ­£åœ¨å¤‡ä»½...",
        "backupSuccess": "å¤‡ä»½æˆåŠŸ",
        "backupFailed": "å¤‡ä»½å¤±è´¥",
        "fileNotFound": "æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶",
        "restoreInProgress": "æ­£åœ¨æ¢å¤...",
        "restoreSuccess": "æ¢å¤æˆåŠŸ",
        "restoreFailed": "æ¢å¤å¤±è´¥"
      }
    },
    "alerts": {
      "importSuccess": "é…ç½®å¯¼å…¥æˆåŠŸ",
      "importFailed": "é…ç½®å¯¼å…¥å¤±è´¥",
      "saveSuccess": "ä¿å­˜æˆåŠŸï¼",
      "saveFailedPrefix": "ä¿å­˜è®¾ç½®å¤±è´¥: "
    }
  },
  "common": {
    "cancel": "å–æ¶ˆ",
    "confirm": "ç¡®è®¤",
    "add": "æ·»åŠ ",
    "delete": "åˆ é™¤",
    "edit": "ç¼–è¾‘",
    "save": "ä¿å­˜",
    "close": "å…³é—­",
    "assignSelected": "åˆ†é…é€‰ä¸­",
    "addTag": "æ·»åŠ æ ‡ç­¾",
    "removeIcon": "ç§»é™¤",
    "downloadIcon": "ä¸‹è½½",
    "warningTitle": "è­¦å‘Š",
    "refresh": "åˆ·æ–°",
    "deleteSelected": "åˆ é™¤",
    "noFileSelected": "æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶",
    "confirmDeleteMultiple": "æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ {count} ä¸ªæ–‡ä»¶å—ï¼Ÿ",
    "deleteSuccess": "åˆ é™¤æˆåŠŸ",
    "deleteFailed": "åˆ é™¤å¤±è´¥",
    "deleteSuccessMultiple": "é€‰ä¸­çš„æ–‡ä»¶å·²æˆåŠŸåˆ é™¤",
    "deleteFailedMultiple": "åˆ é™¤é€‰ä¸­çš„æ–‡ä»¶æ—¶å‡ºé”™"
  }
}
```

ä»¥ä¸‹æ˜¯ç‹¬ç«‹çª—å£çš„å‰ç«¯ä»£ç ï¼Œåœ¨./Anywhere_window/ç›®å½•ä¸‹ï¼Œæ˜¯ç‹¬ç«‹çª—å£æ–‡ä»¶ï¼Œå…¶é¢„åŠ è½½æ–‡ä»¶ä¸ºwindow_preload.js
```json
./Anywhere_window/package.json
{
  "name": "anywhere-window",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@element-plus/icons-vue": "^2.3.1",
    "dompurify": "^3.2.5",
    "element-plus": "^2.9.7",
    "highlight.js": "^11.11.1",
    "katex": "^0.16.22",
    "marked": "^17.0.0",
    "mermaid": "^11.12.2",
    "openai": "^6.3.0",
    "recorder-core": "^1.3.25011100",
    "vue": "^3.5.13",
    "vue-element-plus-x": "^1.3.7",
    "webdav": "^5.8.0"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^5.2.1",
    "less": "^4.3.0",
    "sass": "^1.86.3",
    "typescript": "^5.8.3",
    "unplugin-auto-import": "^19.1.2",
    "unplugin-vue-components": "^28.4.1",
    "vite": "^7.3.1",
    "vite-plugin-vue-devtools": "^7.7.2",
    "vue-tsc": "^2.2.10"
  }
}

```
```js
./Anywhere_window/vite.config.js
import { fileURLToPath, URL } from 'node:url'

import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import vueDevTools from 'vite-plugin-vue-devtools'

export default defineConfig({
  plugins: [
    vue(),
    vueDevTools(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url)),
      'highlight.js': 'highlight.js/lib/common' 
    },
  },
  base: './',
  build: {
    target: 'esnext',
    outDir: 'dist',
    assetsDir: 'assets',
    cssCodeSplit: true,
    chunkSizeWarningLimit: 2000,
    minify: 'esbuild',
    esbuild: {
      drop: ['console', 'debugger'],
    },
    rollupOptions: {
      output: {
        chunkFileNames: 'assets/js/[name]-[hash].js',
        entryFileNames: 'assets/js/[name]-[hash].js',
        assetFileNames: 'assets/[ext]/[name]-[hash].[ext]',
        manualChunks: {
          'element-plus': ['element-plus', '@element-plus/icons-vue'],
          'mermaid': ['mermaid'],
          'highlight': ['highlight.js'],
          'katex': ['katex'],
          'vendor-utils': ['webdav', 'dompurify', 'marked', 'recorder-core']
        }
      }
    }
  }
})
```
```vue
./Anywhere_window/src/App.vue
<script setup>
import { ref, onMounted, onBeforeUnmount, nextTick, watch, h, computed, defineAsyncComponent } from 'vue';
import { ElContainer, ElMain, ElDialog, ElImageViewer, ElMessage, ElMessageBox, ElInput, ElButton, ElCheckbox, ElButtonGroup, ElTag, ElTooltip, ElIcon, ElAvatar, ElSwitch } from 'element-plus';
import { createClient } from "webdav/web";
import { DocumentCopy, QuestionFilled, Download, Search, Tools, CaretRight } from '@element-plus/icons-vue';

import TitleBar from './components/TitleBar.vue';
import ChatHeader from './components/ChatHeader.vue';
const ChatMessage = defineAsyncComponent(() => import('./components/ChatMessage.vue'));
import ChatInput from './components/ChatInput.vue';
import ModelSelectionDialog from './components/ModelSelectionDialog.vue';

import DOMPurify from 'dompurify';
import { marked } from 'marked';

import TextSearchUI from './utils/TextSearchUI.js';
import { formatTimestamp, sanitizeToolArgs } from './utils/formatters.js';

const showDismissibleMessage = (options) => {
  const opts = typeof options === 'string' ? { message: options } : options;
  const duration = opts.duration !== undefined ? opts.duration : 1000;

  let messageInstance = null;
  const finalOpts = {
    ...opts,
    duration: duration,
    showClose: false,
    grouping: true,
    offset: 40,
    onClick: () => {
      if (messageInstance) {
        messageInstance.close();
      }
    }
  };
  messageInstance = ElMessage(finalOpts);
};

showDismissibleMessage.success = (message) => showDismissibleMessage({ message, type: 'success' });
showDismissibleMessage.error = (message) => showDismissibleMessage({ message, type: 'error' });
showDismissibleMessage.info = (message) => showDismissibleMessage({ message, type: 'info' });
showDismissibleMessage.warning = (message) => showDismissibleMessage({ message, type: 'warning' });

const handleMinimize = () => window.api.windowControl('minimize-window');
const handleMaximize = () => window.api.windowControl('maximize-window');
const handleCloseWindow = () => closePage();

const chatInputRef = ref(null);
const lastSelectionStart = ref(null);
const lastSelectionEnd = ref(null);
const chatContainerRef = ref(null);
const isAtBottom = ref(true);
const showScrollToBottomButton = ref(false);
const isForcingScroll = ref(false);
const messageRefs = new Map();
const focusedMessageIndex = ref(null);

// æ ¸å¿ƒçŠ¶æ€ï¼šæ˜¯å¦ç²˜æ»åœ¨åº•éƒ¨
const isSticky = ref(true);
let chatObserver = null;    // DOM è§‚å¯Ÿå™¨å®ä¾‹

let autoSaveInterval = null;

let textSearchInstance = null;

const setMessageRef = (el, id) => {
  if (el) messageRefs.set(id, el);
  else messageRefs.delete(id);
};

const getMessageComponentByIndex = (index) => {
  const msg = chat_show.value[index];
  if (!msg) return undefined;
  return messageRefs.get(msg.id);
};

const urlParams = new URLSearchParams(window.location.search);
const isDarkInit = urlParams.get('dark') === '1';
if (isDarkInit) {
  document.documentElement.classList.add('dark');
}

const defaultConfig = window.api.defaultConfig;
const UserAvart = ref("user.png");
const AIAvart = ref("ai.svg");
const favicon = ref("favicon.png");
const CODE = ref("");

const isInit = ref(false);
const isFilePickerOpen = ref(false); // æ ‡è®°æ–‡ä»¶é€‰æ‹©å™¨æ˜¯å¦æ‰“å¼€
const basic_msg = ref({ os: "macos", code: "AI", type: "over", payload: "è¯·ç®€æ´åœ°ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±" });
const initialConfigData = JSON.parse(JSON.stringify(defaultConfig.config));
if (isDarkInit) {
  initialConfigData.isDarkMode = true;
}
const currentConfig = ref(initialConfigData);
const autoCloseOnBlur = ref(false);
const modelList = ref([]);
const modelMap = ref({});
const model = ref("");
const isAlwaysOnTop = ref(true);
const currentOS = ref('win');

const currentProviderID = ref(defaultConfig.config.providerOrder[0]);
const base_url = ref("");
const api_key = ref("");
const history = ref([]);
const chat_show = ref([]);
const loading = ref(false);
const prompt = ref("");
const signalController = ref(null);
const fileList = ref([]);
const zoomLevel = ref(1);
const collapsedMessages = ref(new Set());
const defaultConversationName = ref("");
const selectedVoice = ref(null);
const tempReasoningEffort = ref('default');
const messageIdCounter = ref(0);
const sourcePromptConfig = ref(null);
const cachedBackgroundBlobUrl = ref("");

const windowBackgroundImage = computed(() => {
  if (cachedBackgroundBlobUrl.value) {
    return cachedBackgroundBlobUrl.value;
  }
  if (!CODE.value || !currentConfig.value?.prompts) return "";
  const promptConfig = currentConfig.value.prompts[CODE.value];
  return promptConfig?.backgroundImage || "";
});

const windowBackgroundOpacity = computed(() => {
  if (!CODE.value || !currentConfig.value?.prompts) return 0.5;
  const promptConfig = currentConfig.value.prompts[CODE.value];
  return promptConfig?.backgroundOpacity ?? 0.5;
});

const windowBackgroundBlur = computed(() => {
  if (!CODE.value || !currentConfig.value?.prompts) return 0;
  const promptConfig = currentConfig.value.prompts[CODE.value];
  return promptConfig?.backgroundBlur ?? 0;
});

const loadBackground = async (newUrl) => {
  if (!newUrl) {
    if (cachedBackgroundBlobUrl.value) {
      if (cachedBackgroundBlobUrl.value.startsWith('blob:')) {
        URL.revokeObjectURL(cachedBackgroundBlobUrl.value);
      }
      cachedBackgroundBlobUrl.value = "";
    }
    return;
  }
  if (newUrl.startsWith('data:') || newUrl.startsWith('file:')) return;

  try {
    const buffer = await window.api.getCachedBackgroundImage(newUrl);
    if (buffer) {
      const blob = new Blob([buffer]);
      const newBlobUrl = URL.createObjectURL(blob);
      if (cachedBackgroundBlobUrl.value && cachedBackgroundBlobUrl.value.startsWith('blob:')) {
        URL.revokeObjectURL(cachedBackgroundBlobUrl.value);
      }
      cachedBackgroundBlobUrl.value = newBlobUrl;
    } else {
      console.log(`[Background] Cache miss, downloading in background: ${newUrl}`);
      window.api.cacheBackgroundImage(newUrl);
    }
  } catch (e) {
    console.error("Failed to load cached background:", e);
  }
};

watch(() => {
  if (!CODE.value || !currentConfig.value?.prompts) return null;
  return currentConfig.value.prompts[CODE.value]?.backgroundImage;
}, async (newUrl) => {
  await loadBackground(newUrl);
}, { immediate: false });

const inputLayout = computed(() => currentConfig.value.inputLayout || 'horizontal');
const currentSystemPrompt = ref("");

const changeModel_page = ref(false);
const systemPromptDialogVisible = ref(false);
const systemPromptContent = ref('');
const imageViewerVisible = ref(false);
const imageViewerSrcList = ref([]);
const imageViewerInitialIndex = ref(0);

const toolCallControllers = ref(new Map());
const tempSessionMcpServerIds = ref([]);

const isAutoApproveTools = ref(true);
const pendingToolApprovals = ref(new Map());

const handleToolApproval = (toolCallId, isApproved) => {
  const resolver = pendingToolApprovals.value.get(toolCallId);
  if (resolver) {
    resolver(isApproved);
    pendingToolApprovals.value.delete(toolCallId);
  }
};
const handleToggleAutoApprove = (val) => {
  isAutoApproveTools.value = val;

  if (val) {
    pendingToolApprovals.value.forEach((resolve, id) => {
      resolve(true);
    });
    pendingToolApprovals.value.clear();

    chat_show.value.forEach(msg => {
      if (msg.tool_calls) {
        msg.tool_calls.forEach(tc => {
          if (tc.approvalStatus === 'waiting') {
            tc.approvalStatus = 'approved';
          }
        });
      }
    });
  }
};

const isMcpDialogVisible = ref(false);
const sessionMcpServerIds = ref([]);
const openaiFormattedTools = ref([]);
const mcpSearchQuery = ref('');
const isMcpLoading = ref(false);
const mcpFilter = ref('all');
const mcpToolCache = ref({});
const expandedMcpServers = ref(new Set());

const toggleMcpServerExpansion = (serverId) => {
  if (expandedMcpServers.value.has(serverId)) {
    expandedMcpServers.value.delete(serverId);
  } else {
    expandedMcpServers.value.add(serverId);
  }
};

// åˆ‡æ¢å…·ä½“å·¥å…·çš„å¯ç”¨çŠ¶æ€
const handleMcpToolStatusChange = async (serverId, toolName, enabled) => {
  if (!mcpToolCache.value[serverId]) return;

  // æ›´æ–°æœ¬åœ°è§†å›¾çŠ¶æ€
  const tools = mcpToolCache.value[serverId];
  const toolIndex = tools.findIndex(t => t.name === toolName);
  if (toolIndex !== -1) {
    tools[toolIndex].enabled = enabled;

    // æ·±æ‹·è´ä»¥å»é™¤ Vue å“åº”å¼ä»£ç†ï¼Œå‡†å¤‡ä¿å­˜
    const toolsToSave = JSON.parse(JSON.stringify(tools));
    try {
      // è°ƒç”¨ preload API ä¿å­˜åˆ°æ•°æ®åº“
      await window.api.saveMcpToolCache(serverId, toolsToSave);
      // é™é»˜ä¿å­˜æˆåŠŸ
    } catch (e) {
      console.error("Failed to save tool status:", e);
      showDismissibleMessage.error("ä¿å­˜å·¥å…·çŠ¶æ€å¤±è´¥");
      // å›æ»šçŠ¶æ€
      tools[toolIndex].enabled = !enabled;
    }
  }
};

const getToolCounts = (serverId) => {
  const tools = mcpToolCache.value[serverId];
  if (!tools || !Array.isArray(tools)) return null;

  const total = tools.length;
  // é»˜è®¤ enabled ä¸º undefined æ—¶ä¹Ÿè§†ä¸ºå¯ç”¨
  const enabled = tools.filter(t => t.enabled !== false).length;

  return { enabled, total };
};

const isMcpActive = computed(() => sessionMcpServerIds.value.length > 0);

const mcpConnectionCount = computed(() => {
  if (!currentConfig.value || !currentConfig.value.mcpServers) return 0;
  const persistentCount = tempSessionMcpServerIds.value.filter(id => {
    const server = currentConfig.value.mcpServers[id];
    return server && server.isPersistent && server.type?.toLowerCase() !== 'builtin';
  }).length;

  // 2. è®¡ç®—æ˜¯å¦å ç”¨äº†å…±äº«çš„ä¸´æ—¶è¿æ¥ Worker (æ’é™¤ builtin)
  const hasOnDemand = tempSessionMcpServerIds.value.some(id => {
    const server = currentConfig.value.mcpServers[id];
    return server && !server.isPersistent && server.type?.toLowerCase() !== 'builtin';
  });
  return persistentCount + (hasOnDemand ? 1 : 0);
});

const availableMcpServers = computed(() => {
  if (!currentConfig.value || !currentConfig.value.mcpServers) return [];
  return Object.entries(currentConfig.value.mcpServers)
    .filter(([, server]) => server.isActive)
    .map(([id, server]) => ({ id, ...server }))
    .sort((a, b) => a.name.localeCompare(b.name));
});

const filteredMcpServers = computed(() => {
  let servers = availableMcpServers.value;
  if (mcpFilter.value === 'selected') {
    servers = servers.filter(server => tempSessionMcpServerIds.value.includes(server.id));
  } else if (mcpFilter.value === 'unselected') {
    servers = servers.filter(server => !tempSessionMcpServerIds.value.includes(server.id));
  }
  if (mcpSearchQuery.value) {
    const query = mcpSearchQuery.value.toLowerCase();
    servers = servers.filter(server =>
      (server.name && server.name.toLowerCase().includes(query)) ||
      (server.description && server.description.toLowerCase().includes(query)) ||
      (server.tags && Array.isArray(server.tags) && server.tags.some(tag => tag.toLowerCase().includes(query))) ||
      // æ–°å¢ï¼šæ”¯æŒæŒ‰åŸå§‹ç±»å‹(å¦‚ 'builtin')å’Œæ˜¾ç¤ºåç§°(å¦‚ 'å†…ç½®')æœç´¢
      (server.type && server.type.toLowerCase().includes(query)) ||
      (server.type && getDisplayTypeName(server.type).toLowerCase().includes(query))
    );
  }
  return servers;
});

const isViewingLastMessage = computed(() => {
  if (focusedMessageIndex.value === null) return false;
  return focusedMessageIndex.value === chat_show.value.length - 1;
});

const nextButtonTooltip = computed(() => {
  return isViewingLastMessage.value ? 'æ»šåŠ¨åˆ°åº•éƒ¨' : 'æŸ¥çœ‹ä¸‹ä¸€æ¡æ¶ˆæ¯';
});

// æ»šåŠ¨åˆ°åº•éƒ¨å‡½æ•°
const scrollToBottom = async (behavior = 'auto') => {
  await nextTick();
  const el = chatContainerRef.value?.$el;
  if (el) {
    // é‡æ–°æ¿€æ´»ç²˜æ»çŠ¶æ€
    isSticky.value = true;
    el.scrollTo({
      top: el.scrollHeight,
      behavior: behavior
    });
  }
};

const scrollToTop = () => {
  const el = chatContainerRef.value?.$el;
  if (el) {
    el.scrollTo({ top: 0, behavior: 'smooth' });
  }
};

// å¼ºåˆ¶æ»šåŠ¨ï¼ˆç‚¹å‡»æŒ‰é’®æ—¶ï¼‰
const forceScrollToBottom = () => {
  isForcingScroll.value = true;
  isSticky.value = true; // å¼ºåˆ¶æ¿€æ´»ç²˜æ»
  isAtBottom.value = true;
  showScrollToBottomButton.value = false;
  focusedMessageIndex.value = null;

  // ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œä¸ºäº†è§†è§‰åé¦ˆï¼Œå¯ä»¥ä½¿ç”¨å¹³æ»‘æ»šåŠ¨
  scrollToBottom('smooth');

  setTimeout(() => { isForcingScroll.value = false; }, 500);
};

const findFocusedMessageIndex = () => {
  const container = chatContainerRef.value?.$el;
  if (!container) return;
  const scrollTop = container.scrollTop;
  let closestIndex = -1;
  let smallestDistance = Infinity;
  for (let i = chat_show.value.length - 1; i >= 0; i--) {
    const msgComponent = getMessageComponentByIndex(i);
    if (msgComponent) {
      const el = msgComponent.$el;
      const elTop = el.offsetTop;
      const elBottom = elTop + el.clientHeight;
      if (elTop < scrollTop + container.clientHeight && elBottom > scrollTop) {
        const distance = Math.abs(elTop - scrollTop);
        if (distance < smallestDistance) {
          smallestDistance = distance;
          closestIndex = i;
        }
      }
    }
  }
  if (closestIndex !== -1) focusedMessageIndex.value = closestIndex;
};

// æ»šåŠ¨ç›‘å¬ï¼šä»…è´Ÿè´£æ›´æ–° isSticky çŠ¶æ€å’Œ UI æŒ‰é’®æ˜¾ç¤º
const handleScroll = (event) => {
  if (isForcingScroll.value) return;

  const el = event.target;
  if (!el) return;

  // è®¡ç®—è·ç¦»åº•éƒ¨çš„è·ç¦»
  const distanceToBottom = el.scrollHeight - el.scrollTop - el.clientHeight;
  const tolerance = 20; // å®¹å·®å€¼

  // æ ¸å¿ƒé€»è¾‘ï¼šç”¨æˆ·åªè¦å‘ä¸Šæ»šåŠ¨ç¦»å¼€åº•éƒ¨ï¼Œå°±å–æ¶ˆç²˜æ»ï¼›ä¸€æ—¦è§¦åº•ï¼Œé‡æ–°æ¿€æ´»ç²˜æ»
  const atBottom = distanceToBottom <= tolerance;

  if (atBottom) {
    if (!isSticky.value) isSticky.value = true;
    if (!isAtBottom.value) isAtBottom.value = true;
    showScrollToBottomButton.value = false;
    focusedMessageIndex.value = null;
  } else {
    if (isSticky.value) isSticky.value = false; // ç”¨æˆ·ä¸»åŠ¨ç¦»å¼€äº†åº•éƒ¨
    if (isAtBottom.value) isAtBottom.value = false;
    showScrollToBottomButton.value = true;
    findFocusedMessageIndex();
  }
};

const navigateToPreviousMessage = () => {
  findFocusedMessageIndex();
  const currentIndex = focusedMessageIndex.value;
  if (currentIndex === null) return;
  const targetComponent = getMessageComponentByIndex(currentIndex);
  const container = chatContainerRef.value?.$el;
  if (!targetComponent || !container) return;
  const element = targetComponent.$el;
  const scrollDifference = container.scrollTop - element.offsetTop;
  if (scrollDifference > 5) element.scrollIntoView({ behavior: 'smooth', block: 'start' });
  else if (currentIndex > 0) {
    const newIndex = currentIndex - 1;
    focusedMessageIndex.value = newIndex;
    const previousComponent = getMessageComponentByIndex(newIndex);
    if (previousComponent) previousComponent.$el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
};

const navigateToNextMessage = () => {
  findFocusedMessageIndex();
  if (focusedMessageIndex.value !== null && focusedMessageIndex.value < chat_show.value.length - 1) {
    focusedMessageIndex.value++;
    const targetComponent = getMessageComponentByIndex(focusedMessageIndex.value);
    if (targetComponent) targetComponent.$el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    forceScrollToBottom();
  }
};

const isCollapsed = (index) => collapsedMessages.value.has(index);

const addCopyButtonsToCodeBlocks = async () => {
  await nextTick();
  document.querySelectorAll('.markdown-body pre.hljs').forEach(pre => {
    if (pre.querySelector('.code-block-copy-button')) return;
    const codeElement = pre.querySelector('code'); if (!codeElement) return;
    const wrapper = document.createElement('div'); wrapper.className = 'code-block-wrapper'; pre.parentNode.insertBefore(wrapper, pre); wrapper.appendChild(pre);
    const codeText = codeElement.textContent || ''; const lines = codeText.trimEnd().split('\n'); const lineCount = lines.length;
    const copyButtonSVG = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>`;
    const createButton = (positionClass) => {
      const button = document.createElement('button'); button.className = `code-block-copy-button ${positionClass}`; button.innerHTML = copyButtonSVG; button.title = 'Copy code';
      button.addEventListener('click', async (event) => {
        event.stopPropagation();
        try {
          await navigator.clipboard.writeText(codeText.trimEnd());
          showDismissibleMessage.success('Code copied to clipboard!');
        }
        catch (err) { console.error('Failed to copy code:', err); showDismissibleMessage.error('Failed to copy code.'); }
      });
      wrapper.appendChild(button);
    };
    createButton('code-block-copy-button-bottom');
    if (lineCount > 3) createButton('code-block-copy-button-top');
  });
};

const handleMarkdownImageClick = (event) => {
  if (event.target.tagName !== 'IMG' || !event.target.closest('.markdown-wrapper')) return;
  const imgElement = event.target;
  if (imgElement && imgElement.src) {
    imageViewerSrcList.value = [imgElement.src];
    imageViewerInitialIndex.value = 0;
    imageViewerVisible.value = true;
  }
};

const handleWheel = (event) => {
  if (event.ctrlKey) {
    event.preventDefault();
    const zoomStep = 0.05;
    let newZoom = (event.deltaY < 0) ? zoomLevel.value + zoomStep : zoomLevel.value - zoomStep;
    zoomLevel.value = Math.max(0.5, Math.min(2.0, newZoom));
    if (currentConfig.value) currentConfig.value.zoom = zoomLevel.value;
  }
};

const handleSaveWindowSize = () => saveWindowSize();
const handleOpenModelDialog = async () => {
  try {
    const result = await window.api.getConfig();
    if (result && result.config) {
      currentConfig.value.providers = result.config.providers;
      currentConfig.value.providerOrder = result.config.providerOrder;

      const newModelList = [];
      const newModelMap = {};
      currentConfig.value.providerOrder.forEach(id => {
        const provider = currentConfig.value.providers[id];
        if (provider?.enable) {
          provider.modelList.forEach(m => {
            const key = `${id}|${m}`;
            newModelList.push({ key, value: key, label: `${provider.name}|${m}` });
            newModelMap[key] = `${provider.name}|${m}`;
          });
        }
      });
      modelList.value = newModelList;
      modelMap.value = newModelMap;

      if (currentProviderID.value && currentConfig.value.providers[currentProviderID.value]) {
        const activeProvider = currentConfig.value.providers[currentProviderID.value];
        base_url.value = activeProvider.url;
        api_key.value = activeProvider.api_key;
      }
    }
  } catch (e) {
    console.warn("è‡ªåŠ¨åˆ·æ–°æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼Œå°†ä½¿ç”¨ç¼“å­˜æ•°æ®", e);
  }
  changeModel_page.value = true;
};
const handleChangeModel = (chosenModel) => {
  model.value = chosenModel;
  currentProviderID.value = chosenModel.split("|")[0];
  const provider = currentConfig.value.providers[currentProviderID.value];
  base_url.value = provider.url;
  api_key.value = provider.api_key;
  chatInputRef.value?.focus({ cursor: 'end' });
};
const handleTogglePin = () => {
  autoCloseOnBlur.value = !autoCloseOnBlur.value;
  if (autoCloseOnBlur.value) window.addEventListener('blur', closePage);
  else window.removeEventListener('blur', closePage);
};
const handleToggleAlwaysOnTop = () => {
  window.api.toggleAlwaysOnTop();
};
const handleSaveSession = () => handleSaveAction();
const handleDeleteMessage = (index) => deleteMessage(index);
const handleCopyText = (content, index) => copyText(content, index);
const handleReAsk = () => reaskAI();
const handleShowSystemPrompt = () => {
  systemPromptContent.value = currentSystemPrompt.value;
  systemPromptDialogVisible.value = true;
};
const handleToggleCollapse = async (index, event) => {
  const chatContainer = chatContainerRef.value?.$el;
  const buttonElement = event.currentTarget;
  const messageElement = buttonElement.closest('.chat-message');
  if (!chatContainer || !buttonElement || !messageElement) return;
  const originalScrollTop = chatContainer.scrollTop;
  const isExpanding = isCollapsed(index);
  if (isExpanding) {
    const originalElementTop = messageElement.offsetTop;
    const originalVisualPosition = originalElementTop - originalScrollTop;
    collapsedMessages.value.delete(index);
    await nextTick();
    const newElementTop = messageElement.offsetTop;
    chatContainer.style.scrollBehavior = 'auto';
    chatContainer.scrollTop = newElementTop - originalVisualPosition;
    chatContainer.style.scrollBehavior = 'smooth';
  } else {
    const originalButtonTop = buttonElement.getBoundingClientRect().top;
    collapsedMessages.value.add(index);
    await nextTick();
    const newButtonTop = buttonElement.getBoundingClientRect().top;
    chatContainer.style.scrollBehavior = 'auto';
    chatContainer.scrollTop = originalScrollTop + (newButtonTop - originalButtonTop);
    chatContainer.style.scrollBehavior = 'smooth';
  }
};
const onAvatarClick = async (role, event) => {
  const chatContainer = chatContainerRef.value?.$el;
  const messageElement = event.currentTarget.closest('.chat-message');
  if (!chatContainer || !messageElement) return;
  const originalScrollTop = chatContainer.scrollTop;
  const originalElementTop = messageElement.offsetTop;
  const originalVisualPosition = originalElementTop - originalScrollTop;
  const roleMessageIndices = chat_show.value.map((msg, index) => (msg.role === role ? index : -1)).filter(index => index !== -1);
  if (roleMessageIndices.length === 0) return;
  const anyExpanded = roleMessageIndices.some(index => !collapsedMessages.value.has(index));
  if (anyExpanded) roleMessageIndices.forEach(index => collapsedMessages.value.add(index));
  else roleMessageIndices.forEach(index => collapsedMessages.value.delete(index));
  await nextTick();
  const newElementTop = messageElement.offsetTop;
  chatContainer.style.scrollBehavior = 'auto';
  chatContainer.scrollTop = newElementTop - originalVisualPosition;
  chatContainer.style.scrollBehavior = 'smooth';
};

const handleSubmit = () => askAI(false);
const handleCancel = () => cancelAskAI();
const handleClearHistory = () => clearHistory();
const handleRemoveFile = (index) => fileList.value.splice(index, 1);
const handleUpload = async ({ fileList: newFiles }) => {
  for (const file of newFiles) await file2fileList(file, fileList.value.length + 1);
  chatInputRef.value?.focus({ cursor: 'end' });
};
const handleOpenMcpDialog = () => toggleMcpDialog();

const handleSendAudio = async (audioFile) => {
  fileList.value = [];
  await file2fileList(audioFile, 0);
  await askAI(false);
};

const handleWindowBlur = () => {
  const textarea = chatInputRef.value?.senderRef?.$refs.textarea;
  if (textarea) {
    lastSelectionStart.value = textarea.selectionStart;
    lastSelectionEnd.value = textarea.selectionEnd;
  }
};

const handleWindowFocus = () => {
  if (isFilePickerOpen.value) {
    isFilePickerOpen.value = false;
  }
  setTimeout(() => {
    if (systemPromptDialogVisible.value) {
      return;
    }
    if (document.activeElement && document.activeElement.tagName.toLowerCase() === 'textarea' && document.activeElement.closest('.editing-wrapper')) {
      return;
    }
    if (document.activeElement && document.activeElement.closest('.text-search-container')) {
      return;
    }
    const textarea = chatInputRef.value?.senderRef?.$refs.textarea;
    if (!textarea) return;
    if (document.activeElement !== textarea) {
      if (lastSelectionStart.value !== null && lastSelectionEnd.value !== null) chatInputRef.value?.focus({ position: { start: lastSelectionStart.value, end: lastSelectionEnd.value } });
      else chatInputRef.value?.focus({ cursor: 'end' });
    }
  }, 50);
};

const handleCopyImageFromViewer = (url) => {
  if (!url) return;
  (async () => {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.statusText}`);
      const blob = await response.blob();

      try {
        if (['image/png', 'image/jpeg'].includes(blob.type)) {
          const item = new ClipboardItem({ [blob.type]: blob });
          await navigator.clipboard.write([item]);
          showDismissibleMessage.success('å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (WebAPI)');
          return;
        }
      } catch (webErr) {
        console.warn('Web Clipboard API å†™å…¥å¤±è´¥ï¼Œå°è¯•å›é€€æ–¹æ¡ˆ:', webErr);
      }

      const base64Data = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });

      await new Promise(resolve => setTimeout(resolve, 50));

      await window.api.copyImage(base64Data);
      showDismissibleMessage.success('å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');

    } catch (error) {
      console.error('å¤åˆ¶å›¾ç‰‡å¤±è´¥:', error);
      showDismissibleMessage.error(`å¤åˆ¶å¤±è´¥: ${error.message}`);
    }
  })();
};

const handleDownloadImageFromViewer = async (url) => {
  if (!url) return;
  try {
    const response = await fetch(url);
    const blob = await response.blob();
    const arrayBuffer = await blob.arrayBuffer();
    const defaultFilename = `image_${Date.now()}.${blob.type.split('/')[1] || 'png'}`;
    await window.api.saveFile({ title: 'ä¿å­˜å›¾ç‰‡', defaultPath: defaultFilename, buttonLabel: 'ä¿å­˜', fileContent: new Uint8Array(arrayBuffer) });
    showDismissibleMessage.success('å›¾ç‰‡ä¿å­˜æˆåŠŸï¼');
  } catch (error) {
    if (!error.message.includes('User cancelled') && !error.message.includes('ç”¨æˆ·å–æ¶ˆ')) {
      console.error('ä¸‹è½½å›¾ç‰‡å¤±è´¥:', error);
      showDismissibleMessage.error(`ä¸‹è½½å¤±è´¥: ${error.message}`);
    }
  }
};

const handleEditMessage = (index, newContent) => {
  if (index < 0 || index >= chat_show.value.length) return;

  let history_idx = -1;
  let show_counter = -1;
  for (let i = 0; i < history.value.length; i++) {
    if (history.value[i].role !== 'tool') {
      show_counter++;
    }
    if (show_counter === index) {
      history_idx = i;
      break;
    }
  }

  const updateContent = (message) => {
    if (!message) return;
    if (typeof message.content === 'string' || message.content === null) {
      message.content = newContent;
    } else if (Array.isArray(message.content)) {
      const textPart = message.content.find(p => p.type === 'text' && !(p.text && p.text.toLowerCase().startsWith('file name:')));
      if (textPart) {
        textPart.text = newContent;
      } else {
        message.content.push({ type: 'text', text: newContent });
      }
    }
  };

  if (chat_show.value[index]) {
    updateContent(chat_show.value[index]);
  }

  if (history_idx !== -1 && history.value[history_idx]) {
    updateContent(history.value[history_idx]);
  } else {
    console.error("é”™è¯¯ï¼šæ— æ³•å°† chat_show ç´¢å¼•æ˜ å°„åˆ° history ç´¢å¼•ã€‚ä¸‹æ¬¡APIè¯·æ±‚å¯èƒ½ä¼šä½¿ç”¨æ—§æ•°æ®ã€‚");
  }
};

const handleEditStart = async (index) => {
  const scrollContainer = chatContainerRef.value?.$el;
  const childComponent = getMessageComponentByIndex(index);
  const element = childComponent?.$el;

  if (!scrollContainer || !element || !childComponent) return;

  childComponent.switchToEditMode();

  await nextTick();

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      element.scrollIntoView({ behavior: 'auto', block: 'nearest' });
    });
  });
};

const handleEditEnd = async ({ id, action, content }) => {
  if (action !== 'save') return;

  const currentIndex = chat_show.value.findIndex(m => m.id === id);

  if (currentIndex === -1) return;

  handleEditMessage(currentIndex, content);
  showDismissibleMessage.success('æ¶ˆæ¯å·²æ›´æ–°');

  if (currentIndex === chat_show.value.length - 1 && chat_show.value[currentIndex].role === 'user') {
    await nextTick();
    await reaskAI();
  }
};

const handleSystemPromptKeydown = (e) => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    saveSystemPrompt();
  }
};

const saveSystemPrompt = async () => {
  const newPromptContent = systemPromptContent.value;
  currentSystemPrompt.value = newPromptContent;

  const systemMessageIndex = history.value.findIndex(m => m.role === 'system');
  if (systemMessageIndex !== -1) {
    history.value[systemMessageIndex].content = newPromptContent;
    if (chat_show.value[systemMessageIndex]) {
      chat_show.value[systemMessageIndex].content = newPromptContent;
    }
  } else {
    const newMsg = { role: "system", content: newPromptContent };
    history.value.unshift(newMsg);
    chat_show.value.unshift({ ...newMsg, id: messageIdCounter.value++ });
  }

  try {
    const promptExists = !!currentConfig.value.prompts[CODE.value];
    if (promptExists) {
      await window.api.saveSetting(`prompts.${CODE.value}.prompt`, newPromptContent);
      currentConfig.value.prompts[CODE.value].prompt = newPromptContent;
      showDismissibleMessage.success('å¿«æ·åŠ©æ‰‹æç¤ºè¯å·²æ›´æ–°');
    } else {
      const latestConfigData = await window.api.getConfig();
      const baseConfig = sourcePromptConfig.value || defaultConfig.config.prompts.AI;
      const newPrompt = {
        ...baseConfig,
        icon: AIAvart.value,
        prompt: newPromptContent,
        enable: true,
        model: model.value || baseConfig.model,
        enable: true,
        stream: true,
        isTemperature: false,
        temperature: 0.7,
        ifTextNecessary: false,
        isDirectSend_file: true,
        isDirectSend_normal: true,
        voice: "",
        isAlwaysOnTop: latestConfigData.config.isAlwaysOnTop_global,
        autoCloseOnBlur: latestConfigData.config.autoCloseOnBlur_global,
        window_width: 540,
        window_height: 700,
        position_x: 0,
        position_y: 0,
        reasoning_effort: "default",
        zoom: 1
      };
      latestConfigData.config.prompts[CODE.value] = newPrompt;
      await window.api.updateConfig(latestConfigData);
      currentConfig.value = latestConfigData.config;
      sourcePromptConfig.value = newPrompt;
      showDismissibleMessage.success(`å·²ä¸ºæ‚¨åˆ›å»ºå¹¶ä¿å­˜æ–°çš„å¿«æ·åŠ©æ‰‹: "${CODE.value}"`);
    }
  } catch (error) {
    console.error("ä¿å­˜ç³»ç»Ÿæç¤ºè¯å¤±è´¥:", error);
    showDismissibleMessage.error(`ä¿å­˜å¤±è´¥: ${error.message}`);
  }

  systemPromptDialogVisible.value = false;
};

const closePage = async () => {
  // 1. å¦‚æœæ˜¯ä¸ºäº†æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨è€Œå¤±å»ç„¦ç‚¹ï¼Œæ‹¦æˆªå…³é—­
  if (isFilePickerOpen.value) return;

  // æ¡ä»¶ï¼šé…ç½®äº†æœ¬åœ°å­˜å‚¨è·¯å¾„ ä¸” å½“å‰å¯¹è¯å·²æœ‰åç§°
  if (currentConfig.value?.webdav?.localChatPath && defaultConversationName.value) {
    try {
      await autoSaveSession();
    } catch (e) {
      console.error("å…³é—­æ—¶è‡ªåŠ¨ä¿å­˜å¤±è´¥:", e);
    }
  }

  // 3. å…³é—­çª—å£
  // window.close();
  window.api.windowControl('close-window');
};

const handlePickFileStart = () => {
  isFilePickerOpen.value = true;
};

watch(zoomLevel, (newZoom) => {
  if (window.api && typeof window.api.setZoomFactor === 'function') window.api.setZoomFactor(newZoom);
});
watch(chat_show, async () => {
  await addCopyButtonsToCodeBlocks();
}, { deep: true, flush: 'post' });
watch(() => currentConfig.value?.isDarkMode, (isDark) => {
  if (isDark) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }

  if (textSearchInstance) {
    textSearchInstance.setTheme(isDark ? 'dark' : 'light');
  }
}, { immediate: true });

onMounted(async () => {
  if (isInit.value) return;
  isInit.value = true;

  if (window.api && window.api.onAlwaysOnTopChanged) {
    window.api.onAlwaysOnTopChanged((newState) => {
      isAlwaysOnTop.value = newState;
    });
  }

  textSearchInstance = new TextSearchUI({
    scope: '.chat-main',
    theme: currentConfig.value?.isDarkMode ? 'dark' : 'light'
  });

  window.addEventListener('wheel', handleWheel, { passive: false });
  window.addEventListener('focus', handleWindowFocus);
  window.addEventListener('blur', handleWindowBlur);
  const chatMainElement = chatContainerRef.value?.$el;
  if (chatMainElement) {
    chatMainElement.addEventListener('click', handleMarkdownImageClick);

    chatObserver = new MutationObserver(() => {
      // åªè¦å¤„äºç²˜æ»çŠ¶æ€ï¼Œä»»ä½• DOM å˜åŒ–ï¼ˆæ–‡å­—ç”Ÿæˆã€å…ƒç´ é«˜åº¦å˜åŒ–ï¼‰
      // éƒ½ç«‹å³å°† scrollTop è®¾ä¸ºæœ€å¤§å€¼ã€‚è¿™åœ¨æµè§ˆå™¨é‡ç»˜å‰å‘ç”Ÿï¼Œå› æ­¤è§†è§‰ä¸Šæ˜¯â€œå†…å®¹ä¸Šæ¨â€ã€‚
      if (isSticky.value) {
        chatMainElement.scrollTop = chatMainElement.scrollHeight;
      }
    });

    // ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–ï¼ˆæ–°æ¶ˆæ¯ï¼‰å’Œå­æ ‘å­—ç¬¦æ•°æ®å˜åŒ–ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
    chatObserver.observe(chatMainElement, {
      childList: true,
      subtree: true,
      characterData: true
    });
  }

  const initializeWindow = async (data = null) => {
    try {
      const configData = await window.api.getConfig();
      currentConfig.value = configData.config;
    } catch (err) {
      currentConfig.value = defaultConfig.config;
      showDismissibleMessage.error('åŠ è½½ç”¨æˆ·é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ã€‚');
    }

    try {
      const userInfo = await window.api.getUser();
      UserAvart.value = userInfo.avatar;
    } catch (err) {
      UserAvart.value = "user.png";
    }

    if (data?.os) {
      currentOS.value = data.os;
    }

    modelList.value = []; modelMap.value = {};
    currentConfig.value.providerOrder.forEach(id => {
      const provider = currentConfig.value.providers[id];
      if (provider?.enable) {
        provider.modelList.forEach(m => {
          const key = `${id}|${m}`;
          modelList.value.push({ key, value: key, label: `${provider.name}|${m}` });
          modelMap.value[key] = `${provider.name}|${m}`;
        });
      }
    });

    const code = data?.code || "AI";
    const currentPromptConfig = currentConfig.value.prompts[code] || defaultConfig.config.prompts.AI;
    if (currentPromptConfig.backgroundImage) {
      loadBackground(currentPromptConfig.backgroundImage);
    }
    isAlwaysOnTop.value = data?.isAlwaysOnTop ?? currentPromptConfig.isAlwaysOnTop ?? true;
    zoomLevel.value = currentPromptConfig.zoom || currentConfig.value.zoom || 1;
    if (window.api && typeof window.api.setZoomFactor === 'function') {
      window.api.setZoomFactor(zoomLevel.value);
    }
    if (currentConfig.value.isDarkMode) {
      document.documentElement.classList.add('dark');
    }

    CODE.value = code;
    document.title = code;
    sourcePromptConfig.value = currentPromptConfig;

    if (currentPromptConfig.icon) {
      AIAvart.value = currentPromptConfig.icon;
      favicon.value = currentPromptConfig.icon;
    } else {
      AIAvart.value = "ai.svg";
      favicon.value = currentConfig.value.isDarkMode ? "favicon-b.png" : "favicon.png";
    }

    autoCloseOnBlur.value = currentPromptConfig.autoCloseOnBlur ?? false;
    tempReasoningEffort.value = currentPromptConfig.reasoning_effort || 'default';
    model.value = currentPromptConfig.model || modelList.value[0]?.value || '';
    selectedVoice.value = currentPromptConfig.voice || null;

    if (model.value) {
      currentProviderID.value = model.value.split("|")[0];
      base_url.value = currentConfig.value.providers[currentProviderID.value]?.url;
      api_key.value = currentConfig.value.providers[currentProviderID.value]?.api_key;
    }

    if (currentPromptConfig.prompt) {
      currentSystemPrompt.value = currentPromptConfig.prompt;
      history.value = [{ role: "system", content: currentPromptConfig.prompt }];
      chat_show.value = [{
        role: "system",
        content: currentPromptConfig.prompt,
        id: messageIdCounter.value++
      }];
    } else {
      currentSystemPrompt.value = "";
      history.value = [];
      chat_show.value = [];
    }

    let shouldDirectSend = false;
    let isFileDirectSend = false;
    if (data) {
      basic_msg.value = { code: data.code, type: data.type, payload: data.payload };
      if (data.filename) defaultConversationName.value = data.filename.replace(/\.json$/i, '');

      if (data.type === "over" && data.payload) {
        let sessionLoaded = false;
        try {
          let old_session = JSON.parse(data.payload);
          if (old_session && old_session.anywhere_history === true) { sessionLoaded = true; await loadSession(old_session); autoCloseOnBlur.value = false; }
        } catch (error) { }
        if (!sessionLoaded) {
          if (CODE.value.trim().toLowerCase().includes(data.payload.trim().toLowerCase())) { /* do nothing */ }
          else {
            if (currentPromptConfig.isDirectSend_normal) {
              history.value.push({ role: "user", content: data.payload });
              chat_show.value.push({ id: messageIdCounter.value++, role: "user", content: [{ type: "text", text: data.payload }] });
              shouldDirectSend = true;
            } else { prompt.value = data.payload; }
          }
        }
      } else if (data.type === "img" && data.payload) {
        if (currentPromptConfig.isDirectSend_normal) {
          history.value.push({ role: "user", content: [{ type: "image_url", image_url: { url: String(data.payload) } }] });
          chat_show.value.push({ id: messageIdCounter.value++, role: "user", content: [{ type: "image_url", image_url: { url: String(data.payload) } }] });
          shouldDirectSend = true;
        } else {
          fileList.value.push({ uid: 1, name: "æˆªå›¾.png", size: 0, type: "image/png", url: String(data.payload) });
        }
      } else if (data.type === "files" && data.payload) {
        try {
          let sessionLoaded = false;
          if (data.payload.length === 1 && data.payload[0].path.toLowerCase().endsWith('.json')) {
            const fileObject = await window.api.handleFilePath(data.payload[0].path);
            if (fileObject) { sessionLoaded = await checkAndLoadSessionFromFile(fileObject); }
          }
          if (!sessionLoaded) {
            const fileProcessingPromises = data.payload.map((fileInfo) => processFilePath(fileInfo.path));
            await Promise.all(fileProcessingPromises);
            if (currentPromptConfig.isDirectSend_file) {
              shouldDirectSend = true;
              isFileDirectSend = true;
            }
          }
        } catch (error) { console.error("Error during initial file processing:", error); showDismissibleMessage.error("æ–‡ä»¶å¤„ç†å¤±è´¥: " + error.message); }
      }
    }
    if (autoCloseOnBlur.value) {
      window.addEventListener('blur', closePage);
    }

    const defaultMcpServers = currentPromptConfig.defaultMcpServers;
    if (Array.isArray(defaultMcpServers) && defaultMcpServers.length > 0) {
      sessionMcpServerIds.value = [...defaultMcpServers];
      tempSessionMcpServerIds.value = [...defaultMcpServers];
      await applyMcpTools(false);
    }

    if (shouldDirectSend) {
      scrollToBottom();
      if (isFileDirectSend) await askAI(false);
      else await askAI(true);
    }

    await addCopyButtonsToCodeBlocks();
    setTimeout(() => {
      chatInputRef.value?.focus({ cursor: 'end' });
    }, 100);
  };

  if (window.preload && typeof window.preload.receiveMsg === 'function') {
    window.preload.receiveMsg(async (data) => {
      await initializeWindow(data);
    });
  } else {
    const data = {
      os: "win",
      code: "Moss",
      config: await window.api.getConfig().config,
    };
    await initializeWindow(data);
  }
  if (autoSaveInterval) clearInterval(autoSaveInterval);
  autoSaveInterval = setInterval(autoSaveSession, 15000);
  window.addEventListener('error', handleGlobalImageError, true);
  window.addEventListener('keydown', handleGlobalKeyDown);

  if (window.api && window.api.onConfigUpdated) {
    window.api.onConfigUpdated((newConfig) => {
      if (newConfig) {
        currentConfig.value = newConfig;
        if (newConfig.zoom !== undefined) {
          zoomLevel.value = newConfig.zoom;
        }
      }
    });
  }
});

const autoSaveSession = async () => {
  if (loading.value || !currentConfig.value?.webdav?.localChatPath) {
    return;
  }

  // 2. è·å–å½“å‰å¿«æ·åŠ©æ‰‹çš„é…ç½®
  const promptConfig = currentConfig.value?.prompts?.[CODE.value];
  const isAutoSaveConfigEnabled = promptConfig?.autoSaveChat ?? true;

  if (!defaultConversationName.value && !isAutoSaveConfigEnabled) {
    return;
  }

  // è‡ªåŠ¨å‘½åé€»è¾‘ï¼š
  if (!defaultConversationName.value && chat_show.value.length > 0) {
    const firstUserMsg = chat_show.value.find(msg => msg.role === 'user');
    if (firstUserMsg) {
      let namePrefix = '';
      const content = firstUserMsg.content;

      // æå–å¹¶æ¸…æ´—ç”¨æˆ·è¾“å…¥å†…å®¹ï¼Œä½œä¸ºæ–‡ä»¶åå‰ç¼€
      if (Array.isArray(content)) {
        const hasImage = content.some(p => p.type === 'image_url');
        const hasFile = content.some(p => p.type === 'file');
        const textPart = content.find(p => p.type === 'text');

        if (hasImage) {
          namePrefix = 'å›¾ç‰‡';
        } else if (hasFile) {
          namePrefix = 'æ–‡ä»¶';
        } else if (textPart?.text) {
          namePrefix = textPart.text.slice(0, 20).replace(/[\\/:*?"<>|\n\r]/g, '').trim();
        }
      } else if (typeof content === 'string') {
        namePrefix = content.slice(0, 20).replace(/[\\/:*?"<>|\n\r]/g, '').trim();
      }

      if (namePrefix) {
        // æ¸…æ´—æ™ºèƒ½åŠ©æ‰‹åç§°ä¸­çš„éæ³•å­—ç¬¦ (å¦‚ /, \, :, *, ?, ", <, >, |)
        const safeCodeName = CODE.value.replace(/[\\/:*?"<>|]/g, '_');

        // æ·»åŠ æ—¶é—´æˆ³é¿å…æ–‡ä»¶åé‡å¤è¦†ç›–
        const now = new Date();
        const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;

        // ç»„åˆæ–‡ä»¶å
        defaultConversationName.value = `${namePrefix}-${safeCodeName}-${timestamp}`;
      }
    }
  }

  // 5. å¦‚æœç»è¿‡å°è¯•åä»ç„¶æ²¡æœ‰å¯¹è¯åç§°ï¼ˆä¾‹å¦‚ç©ºå¯¹è¯ï¼‰ï¼Œåˆ™ä¸ä¿å­˜
  if (!defaultConversationName.value) {
    return;
  }

  // 6. æ‰§è¡Œå†™å…¥æ“ä½œ
  try {
    const sessionData = getSessionDataAsObject();
    const jsonString = JSON.stringify(sessionData, null, 2);
    const filePath = `${currentConfig.value.webdav.localChatPath}/${defaultConversationName.value}.json`;
    await window.api.writeLocalFile(filePath, jsonString);
  } catch (error) {
    console.error('Auto-save failed:', error);
  }
};

onBeforeUnmount(async () => {
  window.removeEventListener('wheel', handleWheel);
  window.removeEventListener('focus', handleWindowFocus);
  window.removeEventListener('blur', handleWindowBlur);
  if (textSearchInstance) textSearchInstance.destroy();
  if (!autoCloseOnBlur.value) window.removeEventListener('blur', closePage);
  const chatMainElement = chatContainerRef.value?.$el;
  if (chatMainElement) chatMainElement.removeEventListener('click', handleMarkdownImageClick);
  await window.api.closeMcpClient();
  window.removeEventListener('error', handleGlobalImageError, true);
  window.removeEventListener('keydown', handleGlobalKeyDown);

  if (chatObserver) {
    chatObserver.disconnect();
    chatObserver = null;
  }
});

const saveWindowSize = async () => {
  if (!CODE.value || !currentConfig.value.prompts[CODE.value]) {
    showDismissibleMessage.warning('æ— æ³•ä¿å­˜çª—å£è®¾ç½®ï¼Œå› ä¸ºå½“å‰ä¸æ˜¯ä¸€ä¸ªå·²å®šä¹‰çš„å¿«æ·åŠ©æ‰‹ã€‚');
    return;
  }

  if (window.fullScreen) {
    showDismissibleMessage.warning('æ— æ³•åœ¨å…¨å±æ¨¡å¼ä¸‹ä¿å­˜çª—å£ä½ç½®å’Œå¤§å°ã€‚');
    return;
  }

  const settingsToSave = {
    window_height: window.outerHeight,
    window_width: window.outerWidth,
    zoom: zoomLevel.value,
    position_x: window.screenX,
    position_y: window.screenY,
  };

  try {
    const result = await window.api.savePromptWindowSettings(CODE.value, settingsToSave);
    if (result.success) {
      showDismissibleMessage.success('å½“å‰å¿«æ·åŠ©æ‰‹çš„çª—å£å¤§å°ã€ä½ç½®ä¸ç¼©æ”¾å·²ä¿å­˜');
      if (currentConfig.value.prompts[CODE.value]) {
        Object.assign(currentConfig.value.prompts[CODE.value], settingsToSave);
      }
    } else {
      showDismissibleMessage.error(`ä¿å­˜å¤±è´¥: ${result.message}`);
    }
  } catch (error) {
    console.error("Error saving window settings:", error);
    showDismissibleMessage.error('ä¿å­˜çª—å£è®¾ç½®æ—¶å‡ºé”™');
  }
}

const getSessionDataAsObject = () => {
  const currentPromptConfig = currentConfig.value.prompts[CODE.value] || {};
  return {
    anywhere_history: true, CODE: CODE.value, basic_msg: basic_msg.value, isInit: isInit.value,
    autoCloseOnBlur: autoCloseOnBlur.value, model: model.value,
    currentPromptConfig: currentPromptConfig, history: history.value, chat_show: chat_show.value, selectedVoice: selectedVoice.value,
    activeMcpServerIds: sessionMcpServerIds.value || [], isAutoApproveTools: isAutoApproveTools.value
  };
}
const saveSessionToCloud = async () => {
  const now = new Date();
  const year = String(now.getFullYear()).slice(-2);
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).toString().padStart(2, '0');
  const hours = String(now.getHours()).toString().padStart(2, '0');
  const minutes = String(now.getMinutes()).toString().padStart(2, '0');
  const defaultBasename = defaultConversationName.value || `${CODE.value || 'AI'}-${year}${month}${day}-${hours}${minutes}`;
  const inputValue = ref(defaultBasename);
  try {
    await ElMessageBox({
      title: 'ä¿å­˜åˆ°äº‘ç«¯',
      message: () => h('div', null, [
        h('p', { style: 'margin-bottom: 15px; font-size: 14px; color: var(--el-text-color-regular);' }, 'è¯·è¾“å…¥è¦ä¿å­˜åˆ°äº‘ç«¯çš„ä¼šè¯åç§°ã€‚'),
        h(ElInput, {
          modelValue: inputValue.value,
          'onUpdate:modelValue': (val) => { inputValue.value = val; },
          placeholder: 'æ–‡ä»¶å',
          ref: (elInputInstance) => {
            if (elInputInstance) {
              setTimeout(() => elInputInstance.focus(), 100);
            }
          },
          onKeydown: (event) => {
            if (event.key === 'Enter') {
              event.preventDefault();
              document.querySelector('.filename-prompt-dialog .el-message-box__btns .el-button--primary')?.click();
            }
          }
        },
          { append: () => h('div', { class: 'input-suffix-display' }, '.json') })]),
      showCancelButton: true, confirmButtonText: 'ç¡®è®¤', cancelButtonText: 'å–æ¶ˆ', customClass: 'filename-prompt-dialog',
      beforeClose: async (action, instance, done) => {
        if (action === 'confirm') {
          let finalBasename = inputValue.value.trim();
          if (!finalBasename) { showDismissibleMessage.error('æ–‡ä»¶åä¸èƒ½ä¸ºç©º'); return; }
          if (finalBasename.toLowerCase().endsWith('.json')) finalBasename = finalBasename.slice(0, -5);
          const filename = finalBasename + '.json';
          instance.confirmButtonLoading = true;
          showDismissibleMessage.info('æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...');
          try {
            const sessionData = getSessionDataAsObject();
            const jsonString = JSON.stringify(sessionData, null, 2);
            const { url, username, password, data_path } = currentConfig.value.webdav;
            const client = createClient(url, { username, password });
            const remoteDir = data_path.endsWith('/') ? data_path.slice(0, -1) : data_path;
            const remoteFilePath = `${remoteDir}/${filename}`;
            if (!(await client.exists(remoteDir))) await client.createDirectory(remoteDir, { recursive: true });
            await client.putFileContents(remoteFilePath, jsonString, { overwrite: true });
            defaultConversationName.value = finalBasename;
            showDismissibleMessage.success('ä¼šè¯å·²æˆåŠŸä¿å­˜åˆ°äº‘ç«¯ï¼');
            done();
          } catch (error) {
            console.error("WebDAV save failed:", error);
            showDismissibleMessage.error(`ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥: ${error.message}`);
          } finally { instance.confirmButtonLoading = false; }
        } else { done(); }
      }
    });
  } catch (error) { if (error !== 'cancel' && error !== 'close') console.error("MessageBox error:", error); }
};

const saveSessionAsMarkdown = async () => {
  let markdownContent = '';
  const now = new Date();
  const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  const fileTimestamp = `${String(now.getFullYear()).slice(-2)}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
  const defaultBasename = defaultConversationName.value || `${CODE.value || 'AI'}-${fileTimestamp}`;

  const formatContent = (content) => !Array.isArray(content) ? String(content).trim() : content.map(p => p.type === 'text' ? p.text.trim() : '').join(' ');
  const formatFiles = (content) => Array.isArray(content) ? content.filter(p => p.type !== 'text').map(p => p.type === 'file' ? p.file.filename : 'Image') : [];

  const addBlockquote = (text) => {
    if (!text) return '';
    return text.split('\n').map(line => `> ${line}`).join('\n');
  };

  const truncate = (str, len = 50) => {
    if (!str) return '';
    const s = String(str);
    return s.length > len ? s.substring(0, len) + '...' : s;
  };

  markdownContent += `# èŠå¤©è®°å½•: ${CODE.value} (${timestamp})\n\n### å½“å‰æ¨¡å‹: ${modelMap.value[model.value] || 'N/A'}\n\n`;

  if (currentSystemPrompt.value && currentSystemPrompt.value.trim()) {
    markdownContent += `### ç³»ç»Ÿæç¤ºè¯\n\n${addBlockquote(currentSystemPrompt.value.trim())}\n\n`;
  }
  markdownContent += '---\n\n';

  for (const message of chat_show.value) {
    if (message.role === 'system') continue;

    if (message.role === 'user') {
      let userHeader = '### ğŸ‘¤ ç”¨æˆ·';
      if (message.timestamp) userHeader += ` - *${formatTimestamp(message.timestamp)}*`;
      markdownContent += `${userHeader}\n\n`;

      const mainContent = formatContent(message.content);
      const files = formatFiles(message.content);

      if (mainContent) markdownContent += `${addBlockquote(mainContent)}\n\n`;

      if (files.length > 0) {
        markdownContent += `> **é™„ä»¶åˆ—è¡¨:**\n`;
        files.forEach(f => { markdownContent += `> - \`${f}\`\n`; });
        markdownContent += `\n`;
      }
    } else if (message.role === 'assistant') {
      let assistantHeader = `### ğŸ¤– ${message.aiName || 'AI'}`;
      if (message.voiceName) assistantHeader += ` (${message.voiceName})`;
      if (message.completedTimestamp) assistantHeader += ` - *${formatTimestamp(message.completedTimestamp)}*`;
      markdownContent += `${assistantHeader}\n\n`;

      if (message.reasoning_content) {
        markdownContent += `> *æ€è€ƒè¿‡ç¨‹:*\n${addBlockquote(message.reasoning_content)}\n\n`;
      }

      if (message.tool_calls && message.tool_calls.length > 0) {
        markdownContent += `> **å·¥å…·è°ƒç”¨:**\n`;
        message.tool_calls.forEach(tool => {
          markdownContent += `> - ğŸ› ï¸ \`${tool.name}\`: ${truncate(tool.result)}\n`;
        });
        markdownContent += `\n`;
      }

      const mainContent = formatContent(message.content);
      if (mainContent) markdownContent += `${addBlockquote(mainContent)}\n\n`;
      else if (message.status) markdownContent += `> *(AIæ­£åœ¨æ€è€ƒ...)*\n\n`;
    }
    markdownContent += '---\n\n';
  }

  const inputValue = ref(defaultBasename);
  try {
    await ElMessageBox({
      title: 'ä¿å­˜ä¸º Markdown',
      message: () => h('div', null, [
        h('p', { style: 'margin-bottom: 15px; font-size: 14px; color: var(--el-text-color-regular);' }, 'è¯·è¾“å…¥ä¼šè¯åç§°ã€‚'),
        h(ElInput, {
          modelValue: inputValue.value,
          'onUpdate:modelValue': (val) => { inputValue.value = val; },
          placeholder: 'æ–‡ä»¶å',
          ref: (elInputInstance) => {
            if (elInputInstance) {
              setTimeout(() => elInputInstance.focus(), 100);
            }
          },
          onKeydown: (event) => {
            if (event.key === 'Enter') {
              event.preventDefault();
              document.querySelector('.filename-prompt-dialog .el-message-box__btns .el-button--primary')?.click();
            }
          }
        },
          { append: () => h('div', { class: 'input-suffix-display' }, '.md') })]),
      showCancelButton: true, confirmButtonText: 'ä¿å­˜', cancelButtonText: 'å–æ¶ˆ', customClass: 'filename-prompt-dialog',
      beforeClose: async (action, instance, done) => {
        if (action === 'confirm') {
          let finalBasename = inputValue.value.trim();
          if (!finalBasename) { showDismissibleMessage.error('æ–‡ä»¶åä¸èƒ½ä¸ºç©º'); return; }
          if (finalBasename.toLowerCase().endsWith('.md')) finalBasename = finalBasename.slice(0, -3);
          const finalFilename = finalBasename + '.md';
          instance.confirmButtonLoading = true;
          try {
            await window.api.saveFile({ title: 'ä¿å­˜ä¸º Markdown', defaultPath: finalFilename, buttonLabel: 'ä¿å­˜', filters: [{ name: 'Markdown æ–‡ä»¶', extensions: ['md'] }, { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }], fileContent: markdownContent });
            defaultConversationName.value = finalBasename;
            showDismissibleMessage.success('ä¼šè¯å·²æˆåŠŸä¿å­˜ä¸º Markdownï¼');
            done();
          } catch (error) {
            if (!error.message.includes('canceled by the user')) { console.error('ä¿å­˜ Markdown å¤±è´¥:', error); showDismissibleMessage.error(`ä¿å­˜å¤±è´¥: ${error.message}`); }
            done();
          } finally { instance.confirmButtonLoading = false; }
        } else { done(); }
      }
    });
  } catch (error) { if (error !== 'cancel' && error !== 'close') console.error('MessageBox error:', error); }
};

const saveSessionAsHtml = async () => {
  const now = new Date();
  const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  const fileTimestamp = `${String(now.getFullYear()).slice(-2)}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
  const defaultBasename = defaultConversationName.value || `${CODE.value || 'AI'}-${fileTimestamp}`;
  const inputValue = ref(defaultBasename);

  const defaultAiSvg = `<svg width="200" height="200" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#FDA5A5" /><g stroke="white" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" fill="none"><rect x="25" y="32" width="50" height="42" rx="8" /><line x1="40" y1="63" x2="60" y2="63" /><line x1="35" y1="32" x2="32" y2="22" /><line x1="65" y1="32" x2="68" y2="22" /></g><g fill="white" stroke="none"><circle cx="40" cy="48" r="3.5" /><circle cx="60" cy="48" r="3.5" /><circle cx="32" cy="20" r="3" /><circle cx="68" cy="20" r="3" /></g></svg>`;

  const generateHtmlContent = () => {
    let bodyContent = '';
    let tocContent = '';

    const truncate = (str, len = 50) => {
      if (!str) return '';
      const s = String(str);
      return s.length > len ? s.substring(0, len) + '...' : s;
    };

    const formatMessageText = (content) => {
      if (!content) return "";
      if (typeof content === 'string') return content;
      if (!Array.isArray(content)) return String(content);

      let textString = "";
      content.forEach(part => {
        if (part.type === 'text' && part.text && !(part.text.toLowerCase().startsWith('file name:') && part.text.toLowerCase().endsWith('file end'))) {
          textString += part.text;
        }
      });
      return textString.trim();
    };

    const processContentToHtml = (content) => {
      if (!content) return "";
      let markdownString = "";
      if (typeof content === 'string') {
        markdownString = content;
      } else if (Array.isArray(content)) {
        markdownString = content.map(part => {
          if (part.type === 'text') {
            return part.text || '';
          } else if (part.type === 'image_url' && part.image_url?.url) {
            return `![Image](${part.image_url.url})`;
          } else if (part.type === 'input_audio' && part.input_audio?.data) {
            return `<audio controls src="data:audio/${part.input_audio.format};base64,${part.input_audio.data}"></audio>`;
          } else if (part.type === 'file' && part.file?.filename) {
            return `*ğŸ“ é™„ä»¶: ${part.file.filename}*`;
          }
          return '';
        }).join(' ');
      } else {
        markdownString = String(content);
      }
      return marked.parse(markdownString);
    };

    if (currentSystemPrompt.value && currentSystemPrompt.value.trim()) {
      const sysTocText = 'ç³»ç»Ÿæç¤ºè¯';
      const sysDotClass = 'system-dot';
      const sysMsgId = 'msg-system';
      tocContent += `
        <li class="timeline-item">
            <a href="#${sysMsgId}" class="timeline-dot ${sysDotClass}" aria-label="${sysTocText}">
                <span class="timeline-tooltip">${sysTocText}</span>
            </a>
        </li>`;

      bodyContent += `
            <div id="${sysMsgId}" class="message-wrapper align-left">
              <div class="header system-header"><strong>ç³»ç»Ÿæç¤ºè¯</strong></div>
              <div class="message-body system-body">${DOMPurify.sanitize(marked.parse(currentSystemPrompt.value))}</div>
            </div>
          `;
    }

    chat_show.value.forEach((message, index) => {
      if (message.role === 'system') return;

      const isUser = message.role === 'user';
      const msgId = `msg-${index}`;

      let tocText = '';
      if (isUser) tocText = truncate(formatMessageText(message.content), 30) || 'ç”¨æˆ·å‘é€å›¾ç‰‡/æ–‡ä»¶';
      else tocText = truncate(formatMessageText(message.content), 30) || 'AI å›å¤';

      let dotClass = isUser ? 'user-dot' : 'ai-dot';

      tocContent += `
        <li class="timeline-item">
            <a href="#${msgId}" class="timeline-dot ${dotClass}" aria-label="${tocText}">
                <span class="timeline-tooltip">${tocText}</span>
            </a>
        </li>`;

      let avatar = isUser ? UserAvart.value : AIAvart.value;
      if (!isUser) {
        if (avatar === 'ai.svg' || (!avatar.startsWith('http') && !avatar.startsWith('data:'))) {
          avatar = `data:image/svg+xml;base64,${btoa(defaultAiSvg)}`;
        }
      }

      let author = isUser ? 'ç”¨æˆ·' : (message.aiName || 'AI');
      let time = message.timestamp || message.completedTimestamp;
      let alignClass = isUser ? 'align-right' : 'align-left';

      const processedHtml = processContentToHtml(message.content);
      let contentHtml = '';
      if (processedHtml && processedHtml.trim() !== '') {
        contentHtml = DOMPurify.sanitize(processedHtml, {
          ADD_TAGS: ['video', 'audio', 'source', 'blockquote'],
          USE_PROFILES: { html: true, svg: true },
          ADD_ATTR: ['style']
        });
      }

      let toolsHtml = '';
      if (message.tool_calls && message.tool_calls.length > 0) {
        toolsHtml = '<div class="tool-calls-wrapper">';
        message.tool_calls.forEach(tool => {
          const truncatedResult = truncate(tool.result, 100);
          const safeResult = truncatedResult.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
          toolsHtml += `
                <div class="tool-call-box">
                    <span class="tool-icon">ğŸ› ï¸</span>
                    <span class="tool-name">${tool.name}</span>
                    <span class="tool-result">${safeResult}</span>
                </div>`;
        });
        toolsHtml += '</div>';
      }

      if (contentHtml || toolsHtml) {
        let headerHtml = '';
        if (isUser) {
          headerHtml = `
               <div class="header user-header">
                 <span class="timestamp">${time ? formatTimestamp(time) : ''}</span>
                 <img src="${avatar}" class="avatar" alt="avatar">
               </div>`;
        } else {
          headerHtml = `
               <div class="header ai-header">
                 <img src="${avatar}" class="avatar" alt="avatar">
                 <div class="ai-meta">
                    <div class="ai-name-row">
                        <strong>${author}</strong>
                        ${message.voiceName ? `<span class="voice-tag">(${message.voiceName})</span>` : ''}
                    </div>
                    <span class="timestamp">${time ? formatTimestamp(time) : ''}</span>
                 </div>
               </div>`;
        }

        const bodyHtml = contentHtml ? `<div class="message-body ${isUser ? 'user-body' : 'ai-body'}">${contentHtml}</div>` : '';

        bodyContent += `
            <div id="${msgId}" class="message-wrapper ${alignClass}">
              ${headerHtml}
              ${toolsHtml}
              ${bodyHtml}
            </div>
          `;
      }
    });

    const cssStyles = `
      <style>
        :root { 
            --bg-color: #f7f7f7; 
            --text-color: #333; 
            --card-bg: #fff; 
            --user-bg: #e1f5fe; 
            --ai-bg: #fff; 
            --border-color: #eee; 
            --accent-color: #1F2937; 
            --timeline-line: #e0e0e0;
            --timeline-dot-default: #bdbdbd;
            --timeline-dot-active: #1F2937;
        }
        @media (prefers-color-scheme: dark) {
          :root { 
              --bg-color: #1a1a1a; 
              --text-color: #e0e0e0; 
              --card-bg: #2a2a2a; 
              --user-bg: #0d47a1; 
              --ai-bg: #3a3a3a; 
              --border-color: #444; 
              --accent-color: #64b5f6; 
              --timeline-line: #444;
              --timeline-dot-default: #666;
              --timeline-dot-active: #64b5f6;
          }
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; }
        .main-container { max-width: 900px; margin: 0 auto; background-color: var(--card-bg); border-radius: 12px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: relative; }
        .page-header { margin-bottom: 40px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .page-header h1 { margin: 0 0 10px 0; font-size: 24px; }
        .page-header p { margin: 0; color: #888; font-size: 13px; }
        .timeline-toc {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 100;
            max-height: 80vh;
            overflow-y: auto;
            scrollbar-width: none; 
            padding: 10px;
        }
        .timeline-toc::-webkit-scrollbar { display: none; }
        .timeline-list {
            list-style: none;
            padding: 0;
            margin: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px; 
        }
        .timeline-list::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background-color: var(--timeline-line);
            transform: translateX(-50%);
            z-index: -1;
            border-radius: 2px;
        }
        .timeline-item { position: relative; }
        .timeline-dot {
            display: block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--card-bg);
            border: 2px solid var(--timeline-dot-default);
            transition: all 0.2s ease;
            position: relative;
        }
        .timeline-dot.user-dot {
            background-color: var(--timeline-dot-active);
            border-color: var(--timeline-dot-active);
            width: 12px; 
            height: 12px;
        }
        .timeline-dot.ai-dot {
            border-color: var(--timeline-dot-default);
        }
        .timeline-dot.system-dot {
            border-color: #795548;
            background-color: #795548;
        }
        .timeline-dot:hover {
            transform: scale(1.4);
            border-color: var(--accent-color);
            background-color: var(--accent-color);
        }
        .timeline-tooltip {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--accent-color);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .timeline-dot:hover .timeline-tooltip {
            opacity: 1;
            transform: translateY(-50%) translateX(-5px);
        }
        .message-wrapper { display: flex; flex-direction: column; margin-bottom: 30px; scroll-margin-top: 60px; max-width: 100%; }
        .align-right { align-items: flex-end; }
        .align-left { align-items: flex-start; }
        .header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; font-size: 12px; color: #888; }
        .user-header { flex-direction: row; }
        .ai-header { flex-direction: row; align-items: flex-start; }
        .avatar { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; background-color: #eee; flex-shrink: 0; }
        .ai-meta { display: flex; flex-direction: column; line-height: 1.3; }
        .ai-name-row { display: flex; align-items: center; gap: 5px; }
        .voice-tag { opacity: 0.8; font-size: 11px; }
        .message-body { padding: 12px 16px; border-radius: 12px; word-break: break-word; overflow-wrap: break-word; max-width: 100%; }
        .user-body { background-color: var(--user-bg); border-bottom-right-radius: 2px; color: var(--text-color); max-width: 90%; }
        .ai-body { background-color: var(--ai-bg); border: 1px solid var(--border-color); border-top-left-radius: 2px; width: 100%; box-sizing: border-box; }
        .system-body { background-color: #fff3e0; color: #5d4037; border: 1px dashed #d7ccc8; width: 100%; text-align: center; }
        .tool-calls-wrapper { width: 100%; margin-bottom: 8px; display: flex; flex-direction: column; gap: 4px; }
        .tool-call-box { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 10px; font-size: 12px; color: #666; display: flex; align-items: center; gap: 8px; }
        .tool-name { font-weight: bold; }
        .tool-result { opacity: 0.7; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        img { max-width: 100%; border-radius: 8px; margin: 5px 0; }
        pre { background-color: #2d2d2d; color: #f8f8f2; padding: 1em; border-radius: 8px; overflow-x: auto; font-family: monospace; }
        blockquote { border-left: 4px solid #ccc; padding-left: 1em; margin: 1em 0; color: #666; background: rgba(0,0,0,0.03); }
        @media (max-width: 768px) {
          .timeline-toc { display: none; }
          .main-container { padding: 20px; width: 100%; box-sizing: border-box; border-radius: 0; box-shadow: none; background-color: transparent; }
          .message-body { max-width: 100%; }
          .user-body { max-width: 95%; }
          body { padding: 0; }
        }
      </style>
    `;

    return `
      <!DOCTYPE html>
      <html lang="zh-CN">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>èŠå¤©è®°å½•: ${CODE.value} (${timestamp})</title>
        ${cssStyles}
      </head>
      <body>
        <nav class="timeline-toc">
            <ul class="timeline-list">
                ${tocContent}
            </ul>
        </nav>
        <div class="main-container">
            <header class="page-header">
                <h1>${CODE.value}</h1>
                <p>æ¨¡å‹: ${modelMap.value[model.value] || 'N/A'} &bull; å¯¼å‡ºæ—¶é—´: ${timestamp}</p>
            </header>
            <div class="chat-container">
                ${bodyContent}
            </div>
        </div>
      </body>
      </html>
    `;
  };

  try {
    await ElMessageBox({
      title: 'ä¿å­˜ä¸º HTML',
      message: () => h('div', null, [
        h('p', { style: 'margin-bottom: 15px; font-size: 14px; color: var(--el-text-color-regular);' }, 'è¯·è¾“å…¥ä¼šè¯åç§°ã€‚'),
        h(ElInput, {
          modelValue: inputValue.value,
          'onUpdate:modelValue': (val) => { inputValue.value = val; },
          placeholder: 'æ–‡ä»¶å',
          ref: (elInputInstance) => {
            if (elInputInstance) {
              setTimeout(() => elInputInstance.focus(), 100);
            }
          },
          onKeydown: (event) => { if (event.key === 'Enter') { event.preventDefault(); document.querySelector('.filename-prompt-dialog .el-message-box__btns .el-button--primary')?.click(); } }
        },
          { append: () => h('div', { class: 'input-suffix-display' }, '.html') })]),
      showCancelButton: true, confirmButtonText: 'ä¿å­˜', cancelButtonText: 'å–æ¶ˆ', customClass: 'filename-prompt-dialog',
      beforeClose: async (action, instance, done) => {
        if (action === 'confirm') {
          let finalBasename = inputValue.value.trim();
          if (!finalBasename) { showDismissibleMessage.error('æ–‡ä»¶åä¸èƒ½ä¸ºç©º'); return; }
          if (finalBasename.toLowerCase().endsWith('.html')) finalBasename = finalBasename.slice(0, -5);
          const finalFilename = finalBasename + '.html';
          instance.confirmButtonLoading = true;
          try {
            const htmlContent = generateHtmlContent();
            await window.api.saveFile({ title: 'ä¿å­˜ä¸º HTML', defaultPath: finalFilename, buttonLabel: 'ä¿å­˜', filters: [{ name: 'HTML æ–‡ä»¶', extensions: ['html'] }, { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }], fileContent: htmlContent });
            defaultConversationName.value = finalBasename;
            showDismissibleMessage.success('ä¼šè¯å·²æˆåŠŸä¿å­˜ä¸º HTMLï¼');
            done();
          } catch (error) {
            if (!error.message.includes('User cancelled') && !error.message.includes('ç”¨æˆ·å–æ¶ˆ')) { console.error('ä¿å­˜ HTML å¤±è´¥:', error); showDismissibleMessage.error(`ä¿å­˜å¤±è´¥: ${error.message}`); }
            done();
          } finally { instance.confirmButtonLoading = false; }
        } else { done(); }
      }
    });
  } catch (error) { if (error !== 'cancel' && error !== 'close') console.error('MessageBox error:', error); }
};

const saveSessionAsJson = async () => {
  const sessionData = getSessionDataAsObject();
  const jsonString = JSON.stringify(sessionData, null, 2);
  const now = new Date();
  const fileTimestamp = `${String(now.getFullYear()).slice(-2)}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
  const defaultBasename = defaultConversationName.value || `${CODE.value || 'AI'}-${fileTimestamp}`;
  const inputValue = ref(defaultBasename);
  try {
    await ElMessageBox({
      title: 'ä¿å­˜ä¸º JSON',
      message: () => h('div', null, [
        h('p', { style: 'margin-bottom: 15px; font-size: 14px; color: var(--el-text-color-regular);' }, 'è¯·è¾“å…¥ä¼šè¯åç§°ã€‚'),
        h(ElInput, {
          modelValue: inputValue.value,
          'onUpdate:modelValue': (val) => { inputValue.value = val; },
          placeholder: 'æ–‡ä»¶å',
          ref: (elInputInstance) => {
            if (elInputInstance) {
              setTimeout(() => elInputInstance.focus(), 100);
            }
          },
          onKeydown: (event) => {
            if (event.key === 'Enter') {
              event.preventDefault();
              document.querySelector('.filename-prompt-dialog .el-message-box__btns .el-button--primary')?.click();
            }
          }
        },
          { append: () => h('div', { class: 'input-suffix-display' }, '.json') })]),
      showCancelButton: true, confirmButtonText: 'ä¿å­˜', cancelButtonText: 'å–æ¶ˆ', customClass: 'filename-prompt-dialog',
      beforeClose: async (action, instance, done) => {
        if (action === 'confirm') {
          let finalBasename = inputValue.value.trim();
          if (!finalBasename) { showDismissibleMessage.error('æ–‡ä»¶åä¸èƒ½ä¸ºç©º'); return; }
          if (finalBasename.toLowerCase().endsWith('.json')) finalBasename = finalBasename.slice(0, -5);
          const finalFilename = finalBasename + '.json';
          instance.confirmButtonLoading = true;
          try {
            let fullDefaultPath = finalFilename;
            const localChatPath = currentConfig.value.webdav?.localChatPath;
            if (localChatPath) {
              const separator = basic_msg.value.os === 'win' ? '\\' : '/';
              fullDefaultPath = `${localChatPath}${separator}${finalFilename}`;
            }

            await window.api.saveFile({
              title: 'ä¿å­˜èŠå¤©ä¼šè¯',
              defaultPath: fullDefaultPath,
              buttonLabel: 'ä¿å­˜',
              filters: [{ name: 'JSON æ–‡ä»¶', extensions: ['json'] }, { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }],
              fileContent: jsonString
            });

            defaultConversationName.value = finalBasename;
            showDismissibleMessage.success('ä¼šè¯å·²æˆåŠŸä¿å­˜ï¼');
            done();
          } catch (error) {
            if (!error.message.includes('canceled by the user') && !error.message.includes('ç”¨æˆ·å–æ¶ˆ')) {
              console.error('ä¿å­˜ä¼šè¯å¤±è´¥:', error);
              showDismissibleMessage.error(`ä¿å­˜å¤±è´¥: ${error.message}`);
            }
            done();
          } finally { instance.confirmButtonLoading = false; }
        } else { done(); }
      }
    });
  } catch (error) { if (error !== 'cancel' && error !== 'close') console.error('MessageBox error:', error); }
};

// é‡å‘½åå½“å‰ä¼šè¯é€»è¾‘
const handleRenameSession = async () => {
  if (autoCloseOnBlur.value) handleTogglePin(); // æš‚åœå¤±ç„¦å…³é—­ï¼Œé˜²æ­¢å¼¹çª—æ—¶çª—å£æ¶ˆå¤±

  const localPath = currentConfig.value.webdav?.localChatPath;
  if (!localPath) {
    showDismissibleMessage.error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®æœ¬åœ°å¯¹è¯è·¯å¾„');
    return;
  }
  if (!defaultConversationName.value) {
    showDismissibleMessage.warning('å½“å‰å¯¹è¯å°šæœªä¿å­˜ï¼Œæ— æ³•é‡å‘½å');
    return;
  }

  const oldBaseName = defaultConversationName.value;
  const oldFilename = `${oldBaseName}.json`;
  // ç®€å•æ‹¼æ¥è·¯å¾„ï¼Œelectron/node ç¯å¢ƒä¸‹é€šå¸¸èƒ½æ­£ç¡®å¤„ç†
  const oldFilePath = `${localPath}/${oldFilename}`;

  try {
    const { value: userInput } = await ElMessageBox.prompt(
      'è¯·è¾“å…¥æ–°çš„ä¼šè¯åç§°',
      'é‡å‘½åå¯¹è¯',
      {
        inputValue: oldBaseName,
        confirmButtonText: 'ç¡®è®¤',
        cancelButtonText: 'å–æ¶ˆ',
        inputValidator: (val) => {
          if (!val || !val.trim()) return 'åç§°ä¸èƒ½ä¸ºç©º';
          if (/[\\/:*?"<>|]/.test(val)) return 'æ–‡ä»¶ååŒ…å«éæ³•å­—ç¬¦';
          return true;
        },
        customClass: 'filename-prompt-dialog', // å¤ç”¨å·²æœ‰çš„å¼¹çª—æ ·å¼
      }
    );

    let newBaseName = (userInput || "").trim();
    if (newBaseName.toLowerCase().endsWith('.json')) newBaseName = newBaseName.slice(0, -5);

    if (newBaseName === oldBaseName) return;

    const newFilename = `${newBaseName}.json`;
    const newFilePath = `${localPath}/${newFilename}`;

    // æ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜åœ¨åŒåæ–‡ä»¶
    const files = await window.api.listJsonFiles(localPath);
    if (files.some(f => f.basename === newFilename)) {
      showDismissibleMessage.error(`æ–‡ä»¶å "${newFilename}" å·²å­˜åœ¨ï¼Œæ“ä½œå–æ¶ˆ`);
      return;
    }

    // æ‰§è¡Œæœ¬åœ°é‡å‘½å
    await window.api.renameLocalFile(oldFilePath, newFilePath);
    defaultConversationName.value = newBaseName;
    showDismissibleMessage.success('æœ¬åœ°é‡å‘½åæˆåŠŸ');

    // å°è¯•åŒæ­¥é‡å‘½åäº‘ç«¯æ–‡ä»¶
    const { url, username, password, data_path } = currentConfig.value.webdav || {};
    if (url && data_path) {
      try {
        const client = createClient(url, { username, password });
        const remoteDir = data_path.endsWith('/') ? data_path.slice(0, -1) : data_path;
        const oldRemotePath = `${remoteDir}/${oldFilename}`;
        const newRemotePath = `${remoteDir}/${newFilename}`;

        // æ£€æŸ¥äº‘ç«¯æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶
        if (await client.exists(oldRemotePath)) {
          await ElMessageBox.confirm(
            'äº‘ç«¯ä¹Ÿå­˜åœ¨åŒåæ–‡ä»¶ï¼Œæ˜¯å¦åŒæ­¥é‡å‘½åï¼Ÿ',
            'åŒæ­¥æ“ä½œæç¤º',
            { confirmButtonText: 'æ˜¯', cancelButtonText: 'å¦', type: 'info' }
          );
          await client.moveFile(oldRemotePath, newRemotePath);
          showDismissibleMessage.success('äº‘ç«¯åŒæ­¥é‡å‘½åæˆåŠŸ');
        }
      } catch (e) {
        if (e !== 'cancel' && e !== 'close') {
          console.warn('Cloud rename skipped:', e);
        }
      }
    }

  } catch (error) {
    if (error !== 'cancel' && error !== 'close') {
      showDismissibleMessage.error(`æ“ä½œå¤±è´¥: ${error.message}`);
    }
  }
};

const handleSaveAction = async () => {
  if (autoCloseOnBlur.value) handleTogglePin();
  const isCloudEnabled = currentConfig.value.webdav?.url && currentConfig.value.webdav?.data_path;
  const saveOptions = [];

  // åªæœ‰å½“å·²å­˜åœ¨æœ¬åœ°æ–‡ä»¶åï¼ˆå³å·²ä¿å­˜è¿‡ï¼‰ä¸”é…ç½®äº†æœ¬åœ°è·¯å¾„æ—¶ï¼Œæ‰æ˜¾ç¤ºé‡å‘½åé€‰é¡¹
  if (currentConfig.value.webdav?.localChatPath && defaultConversationName.value) {
    saveOptions.push({
      title: 'é‡å‘½åå¯¹è¯',
      description: 'ä¿®æ”¹å½“å‰å¯¹è¯åç§°ï¼Œå¹¶åŒæ­¥ä¿®æ”¹æœ¬åœ°æ–‡ä»¶ï¼ˆä»¥åŠäº‘ç«¯æ–‡ä»¶ï¼‰ã€‚',
      buttonType: 'warning',
      action: handleRenameSession
    });
  }

  if (isCloudEnabled) {
    saveOptions.push({ title: 'ä¿å­˜åˆ°äº‘ç«¯', description: 'åŒæ­¥åˆ° WebDAV æœåŠ¡å™¨ï¼Œæ”¯æŒè·¨è®¾å¤‡è®¿é—®ã€‚', buttonType: 'success', action: saveSessionToCloud });
  }

  saveOptions.push({ title: 'ä¿å­˜ä¸º JSON', description: 'ä¿å­˜ä¸ºå¯æ¢å¤çš„ä¼šè©±æ–‡ä»¶ï¼Œä¾¿äºä¸‹æ¬¡ç»§ç»­ã€‚', buttonType: 'primary', action: saveSessionAsJson, isDefault: true });
  saveOptions.push({ title: 'ä¿å­˜ä¸º Markdown', description: 'å¯¼å‡ºä¸ºå¯è¯»æ€§æ›´å¼ºçš„ .md æ–‡ä»¶ï¼Œé€‚åˆåˆ†äº«ã€‚', buttonType: '', action: saveSessionAsMarkdown });
  saveOptions.push({ title: 'ä¿å­˜ä¸º HTML', description: 'å¯¼å‡ºä¸ºå¸¦æ ·å¼çš„ç½‘é¡µæ–‡ä»¶ï¼Œä¿ç•™æ ¼å¼å’Œå›¾ç‰‡ã€‚', buttonType: '', action: saveSessionAsHtml });

  const messageVNode = h('div', { class: 'save-options-list' }, saveOptions.map(opt => {
    const trigger = () => { ElMessageBox.close(); opt.action(); };

    return h('div', { class: 'save-option-item', onClick: trigger }, [
      h('div', { class: 'save-option-text' }, [
        h('h4', null, opt.title), h('p', null, opt.description)
      ]),
      h(ElButton, {
        type: opt.buttonType,
        plain: true,
        class: opt.isDefault ? 'default-save-target' : '',
        onClick: (e) => { e.stopPropagation(); trigger(); }
      }, { default: () => 'é€‰æ‹©' })
    ]);
  }));

  ElMessageBox({
    title: '',
    message: messageVNode,
    showConfirmButton: false,
    showCancelButton: false,
    customClass: 'save-options-dialog no-header-msgbox',
    width: '450px',
    showClose: false
  }).catch(() => { });

  setTimeout(() => {
    const targetBtn = document.querySelector('.default-save-target');
    if (targetBtn) {
      targetBtn.focus();
    }
  }, 100);
};

const loadSession = async (jsonData) => {
  loading.value = true;
  collapsedMessages.value.clear();
  messageRefs.clear();
  focusedMessageIndex.value = null;

  try {
    CODE.value = jsonData.CODE;
    document.title = CODE.value;
    basic_msg.value = jsonData.basic_msg;
    isInit.value = jsonData.isInit;
    autoCloseOnBlur.value = jsonData.autoCloseOnBlur;

    history.value = jsonData.history;
    chat_show.value = jsonData.chat_show;
    selectedVoice.value = jsonData.selectedVoice || '';
    tempReasoningEffort.value = jsonData.currentPromptConfig?.reasoning_effort || 'default';
    isAutoApproveTools.value = jsonData.isAutoApproveTools || true;

    const configData = await window.api.getConfig();
    currentConfig.value = configData.config;

    zoomLevel.value = currentConfig.value.zoom || 1;
    if (window.api && typeof window.api.setZoomFactor === 'function') window.api.setZoomFactor(zoomLevel.value);

    if (currentConfig.value.isDarkMode) { document.documentElement.classList.add('dark'); }
    else { document.documentElement.classList.remove('dark'); }

    const currentPromptConfigFromLoad = jsonData.currentPromptConfig || currentConfig.value.prompts[CODE.value];
    if (currentPromptConfigFromLoad && currentPromptConfigFromLoad.icon) {
      AIAvart.value = currentPromptConfigFromLoad.icon;
      favicon.value = currentPromptConfigFromLoad.icon;
    } else {
      AIAvart.value = "ai.svg";
      favicon.value = currentConfig.value.isDarkMode ? "favicon-b.png" : "favicon.png";
    }

    modelList.value = [];
    modelMap.value = {};
    currentConfig.value.providerOrder.forEach(id => {
      const provider = currentConfig.value.providers[id];
      if (provider?.enable) {
        provider.modelList.forEach(m => {
          const key = `${id}|${m}`;
          modelList.value.push({ key, value: key, label: `${provider.name}|${m}` });
          modelMap.value[key] = `${provider.name}|${m}`;
        });
      }
    });

    let restoredModel = '';
    if (jsonData.model && modelMap.value[jsonData.model]) restoredModel = jsonData.model;
    else if (jsonData.currentPromptConfig?.model && modelMap.value[jsonData.currentPromptConfig.model]) restoredModel = jsonData.currentPromptConfig.model;
    else {
      const currentPromptConfig = currentConfig.value.prompts[CODE.value];
      restoredModel = (currentPromptConfig?.model && modelMap.value[currentPromptConfig.model]) ? currentPromptConfig.model : (modelList.value[0]?.value || '');
    }
    model.value = restoredModel;

    if (chat_show.value && chat_show.value.length > 0) {
      chat_show.value.forEach(msg => { if (msg.id === undefined) msg.id = messageIdCounter.value++; });
      const maxId = Math.max(...chat_show.value.map(m => m.id || 0));
      messageIdCounter.value = maxId + 1;
    }

    const systemMessageIndex = history.value.findIndex(m => m.role === 'system');
    if (systemMessageIndex !== -1) {
      currentSystemPrompt.value = history.value[systemMessageIndex].content;

      if (!chat_show.value[systemMessageIndex] || chat_show.value[systemMessageIndex].role !== 'system') {
        chat_show.value.unshift({
          role: "system",
          content: currentSystemPrompt.value,
          id: messageIdCounter.value++
        });
      }

    } else if (currentConfig.value.prompts[CODE.value]?.prompt) {
      currentSystemPrompt.value = currentConfig.value.prompts[CODE.value].prompt;
      history.value.unshift({ role: "system", content: currentSystemPrompt.value });
      chat_show.value.unshift({
        role: "system",
        content: currentSystemPrompt.value,
        id: messageIdCounter.value++
      });
    } else {
      currentSystemPrompt.value = "";
    }

    if (model.value) {
      currentProviderID.value = model.value.split("|")[0];
      const provider = currentConfig.value.providers[currentProviderID.value];
      base_url.value = provider?.url;
      api_key.value = provider?.api_key;
    } else {
      showDismissibleMessage.error("æ²¡æœ‰å¯ç”¨çš„æ¨¡å‹ã€‚è¯·æ£€æŸ¥æ‚¨çš„æœåŠ¡å•†é…ç½®ã€‚");
      loading.value = false;
      return;
    }

    loading.value = false;
    await nextTick();
    scrollToBottom();

    let mcpServersToLoad = [];
    if (jsonData.activeMcpServerIds && Array.isArray(jsonData.activeMcpServerIds)) {
      mcpServersToLoad = jsonData.activeMcpServerIds;
    } else {
      mcpServersToLoad = jsonData.currentPromptConfig?.defaultMcpServers || [];
    }

    const validMcpServerIds = mcpServersToLoad.filter(id =>
      currentConfig.value.mcpServers && currentConfig.value.mcpServers[id]
    );

    if (validMcpServerIds.length > 0) {
      sessionMcpServerIds.value = [...validMcpServerIds];
      tempSessionMcpServerIds.value = [...validMcpServerIds];
      applyMcpTools(false);
    } else {
      sessionMcpServerIds.value = [];
      tempSessionMcpServerIds.value = [];
      applyMcpTools(false);
    }

  } catch (error) {
    console.error("åŠ è½½ä¼šè¯å¤±è´¥:", error);
    showDismissibleMessage.error(`åŠ è½½ä¼šè¯å¤±è´¥: ${error.message}`);
    loading.value = false;
  }
};


const checkAndLoadSessionFromFile = async (file) => {
  if (file && file.name.toLowerCase().endsWith('.json')) {
    try {
      const fileContent = await file.text();
      const jsonData = JSON.parse(fileContent);
      if (jsonData && jsonData.anywhere_history === true) {
        defaultConversationName.value = file.name.replace(/\.json$/i, '');
        await loadSession(jsonData);
        return true;
      }
    } catch (e) { console.warn("ä¸€ä¸ªJSONæ–‡ä»¶è¢«æ£€æµ‹åˆ°ï¼Œä½†å®ƒä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ä¼šè¯æ–‡ä»¶:", e.message); }
  }
  return false;
};

const file2fileList = async (file, idx) => {
  const isSessionFile = await checkAndLoadSessionFromFile(file);
  if (isSessionFile) { chatInputRef.value?.focus({ cursor: 'end' }); return; }

  return new Promise((resolve, reject) => {
    if (!window.api.isFileTypeSupported(file.name)) {
      const errorMsg = `ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.name}`;
      showDismissibleMessage.warning(errorMsg);
      reject(new Error(errorMsg));
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      fileList.value.push({
        uid: idx,
        name: file.name,
        size: file.size,
        type: file.type,
        url: e.target.result
      });
      resolve();
    };
    reader.onerror = () => {
      const errorMsg = `è¯»å–æ–‡ä»¶ ${file.name} å¤±è´¥`;
      showDismissibleMessage.error(errorMsg);
      reject(new Error(errorMsg));
    }
    reader.readAsDataURL(file);
  });
};

const processFilePath = async (filePath) => {
  if (!filePath || typeof filePath !== 'string') { showDismissibleMessage.error('æ— æ•ˆçš„æ–‡ä»¶è·¯å¾„'); return; }
  try {
    const fileObject = await window.api.handleFilePath(filePath);
    if (fileObject) await file2fileList(fileObject, fileList.value.length + 1);
    else showDismissibleMessage.error('æ— æ³•è¯»å–æˆ–è®¿é—®è¯¥æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„å’Œæƒé™');
  } catch (error) { console.error('è°ƒç”¨ handleFilePath æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯:', error); showDismissibleMessage.error('å¤„ç†æ–‡ä»¶è·¯å¾„æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯'); }
};

const sendFile = async () => {
  let contentList = [];
  if (fileList.value.length === 0) return contentList;

  for (const currentFile of fileList.value) {
    try {
      const processedContent = await window.api.parseFileObject({
        name: currentFile.name,
        url: currentFile.url
      });

      if (processedContent) {
        contentList.push(processedContent);
      }
    } catch (error) {
      if (error.message.includes('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹')) {
        showDismissibleMessage.warning(error.message);
      } else {
        showDismissibleMessage.error(`å¤„ç†æ–‡ä»¶ ${currentFile.name} å¤±è´¥: ${error.message}`);
      }
    }
  }

  fileList.value = [];
  return contentList;
};

async function applyMcpTools(show_none = true) {
  isMcpDialogVisible.value = false;
  isMcpLoading.value = true;
  await nextTick();

  const activeServerConfigs = {};
  const serverIdsToLoad = [...sessionMcpServerIds.value];
  for (const id of serverIdsToLoad) {
    if (currentConfig.value.mcpServers[id]) {
      const serverConf = currentConfig.value.mcpServers[id];
      activeServerConfigs[id] = {
        transport: serverConf.type,
        command: serverConf.command,
        args: serverConf.args,
        url: serverConf.baseUrl,
        env: serverConf.env,
        headers: serverConf.headers,
        isPersistent: serverConf.isPersistent,
      };
    }
  }

  try {
    const {
      openaiFormattedTools: newFormattedTools,
      successfulServerIds,
      failedServerIds
    } = await window.api.initializeMcpClient(activeServerConfigs);

    openaiFormattedTools.value = newFormattedTools;
    sessionMcpServerIds.value = successfulServerIds;

    if (failedServerIds && failedServerIds.length > 0) {
      const failedNames = failedServerIds.map(id => currentConfig.value.mcpServers[id]?.name || id).join('ã€');
      showDismissibleMessage.error({
        message: `ä»¥ä¸‹ MCP æœåŠ¡åŠ è½½å¤±è´¥ï¼Œå·²è‡ªåŠ¨å–æ¶ˆå‹¾é€‰: ${failedNames}`,
        duration: 5000
      });
    }

    if (newFormattedTools.length > 0) {
      showDismissibleMessage.success(`å·²æˆåŠŸå¯ç”¨ ${newFormattedTools.length} ä¸ª MCP å·¥å…·`);
    } else if (serverIdsToLoad.length > 0 && failedServerIds.length === serverIdsToLoad.length) {
      showDismissibleMessage.info('æ‰€æœ‰é€‰ä¸­çš„ MCP å·¥å…·å‡åŠ è½½å¤±è´¥');
    } else if (serverIdsToLoad.length === 0 && show_none) {
      showDismissibleMessage.info('å·²æ¸…é™¤æ‰€æœ‰ MCP å·¥å…·');
    }

  } catch (error) {
    console.error("Failed to initialize MCP tools:", error);
    showDismissibleMessage.error(`åŠ è½½MCPå·¥å…·å¤±è´¥: ${error.message}`);
    openaiFormattedTools.value = [];
    sessionMcpServerIds.value = [];
  } finally {
    isMcpLoading.value = false;
  }
}

function clearMcpTools() {
  tempSessionMcpServerIds.value = [];
}

function selectAllMcpServers() {
  const allVisibleIds = filteredMcpServers.value.map(server => server.id);
  const selectedIdsSet = new Set(tempSessionMcpServerIds.value);
  allVisibleIds.forEach(id => selectedIdsSet.add(id));
  tempSessionMcpServerIds.value = Array.from(selectedIdsSet);
}


async function toggleMcpDialog() {
  if (!isMcpDialogVisible.value) {
    try {
      const result = await window.api.getConfig();

      if (result && result.config && result.config.mcpServers) {
        const newMcpServers = result.config.mcpServers;
        const currentLocalMcpServers = currentConfig.value.mcpServers || {};

        sessionMcpServerIds.value.forEach(activeId => {
          if (!newMcpServers[activeId] && currentLocalMcpServers[activeId]) {
            newMcpServers[activeId] = currentLocalMcpServers[activeId];
          }
        });

        currentConfig.value.mcpServers = newMcpServers;
      }
      mcpToolCache.value = await window.api.getMcpToolCache() || {};

    } catch (error) {
      console.error("Auto refresh MCP config failed:", error);
    }

    tempSessionMcpServerIds.value = [...sessionMcpServerIds.value];
  }
  isMcpDialogVisible.value = !isMcpDialogVisible.value;
}

async function toggleMcpPersistence(serverId, isPersistent) {
  if (!currentConfig.value.mcpServers[serverId]) return;

  const keyPath = `mcpServers.${serverId}.isPersistent`;
  try {
    const result = await window.api.saveSetting(keyPath, isPersistent);
    if (result && result.success) {
      currentConfig.value.mcpServers[serverId].isPersistent = isPersistent;
      showDismissibleMessage.success(`'${currentConfig.value.mcpServers[serverId].name}' çš„æŒä¹…åŒ–è®¾ç½®å·²æ›´æ–°`);
    } else {
      throw new Error(result?.message || 'ä¿å­˜è®¾ç½®åˆ°æ•°æ®åº“å¤±è´¥');
    }
  } catch (error) {
    console.error("Failed to save MCP persistence setting:", error);
    showDismissibleMessage.error("ä¿å­˜æŒä¹…åŒ–è®¾ç½®å¤±è´¥");
  }
}

const getSystemTime = () => {
  const now = new Date();
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const weekDay = days[now.getDay()];

  return `${year}-${month}-${day} (${weekDay})`;
}

const generateMcpSystemPrompt = () => {
  return `
## SYSTEM CONTEXT
Current Time: **${getSystemTime()}**
Platformï¼š**${currentOS.value}**

Always use this timestamp as your reference for "today", "now", "current", or relative dates (e.g., "yesterday", "next week").

## Tool Use Rules
Here are the rules you should always follow to solve your task:
1. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.
2. Call a tool only when needed. If no tool call is needed, just answer the question directly.
3. Never re-do a tool call that you previously did with the exact same parameters.
4. **Synthesis**: Must always synthesize the tool output into valuable, easily understandable information from the user's perspective.
5.  **Strict Multimedia Formatting Norms**: In all circumstances, the display format for multimedia content (images, videos, audio) must comply with the following specifications, and **must not** be contained within code blocks (\`\`\`):
    *   **Image (Markdown)**: \`![Content Description](Image Link)\`
    *   **Video (HTML)**:
        \`\`\`html
        <video controls="" style="max-width: 80%; max-height: 400px; height: auto; width: auto; display: block;"><source src="Video Link URL" type="video/mp4">Your browser does not support video playback.</video>
        \`\`\`
    *   **Audio (HTML)**:
        \`\`\`html
        <audio class="chat-audio-player" controls="" preload="none">
          <source id="Audio Format" src="Audio Link URL">
        </audio>
        \`\`\`
6. **Language**: All Respond must be in the user's language
7. **Security & Safety**: Tools must be executed securely, and the invocation of any commands that could lead to system damage, data loss, or sensitive privacy disclosure is strictly prohibited.
    1.  **Comprehensive Risk Assessment**: Identify whether the operation involves sensitive data or irreversible data modification.
    2.  **Mandatory Warning Prompts**: For any risky operation, clear and detailed warnings must be issued to the user before execution, explaining potential consequences (e.g., exposure of sensitive information, data loss).
    3.  **Seek Explicit Confirmation**: Before executing irreversible or high-risk operations (e.g., deleting files, reading sensitive files), explicit secondary confirmation from the user must be required.
`;
};

const askAI = async (forceSend = false) => {
  if (loading.value) return;
  if (isMcpLoading.value) {
    showDismissibleMessage.info('æ­£åœ¨åŠ è½½å·¥å…·ï¼Œè¯·ç¨åå†è¯•...');
    return;
  }

  // --- 1. å¤„ç†ç”¨æˆ·è¾“å…¥ ---
  if (!forceSend) {
    let file_content = await sendFile();
    const promptText = prompt.value.trim();
    if ((file_content && file_content.length > 0) || promptText) {
      const userContentList = [];
      if (promptText) userContentList.push({ type: "text", text: promptText });
      if (file_content && file_content.length > 0) userContentList.push(...file_content);
      const userTimestamp = new Date().toLocaleString('sv-SE');
      if (userContentList.length > 0) {
        const contentForHistory = userContentList.length === 1 && userContentList[0].type === 'text'
          ? userContentList[0].text
          : userContentList;
        history.value.push({ role: "user", content: contentForHistory });
        chat_show.value.push({ id: messageIdCounter.value++, role: "user", content: userContentList, timestamp: userTimestamp });

        autoSaveSession();

      } else return;
    } else return;
    prompt.value = "";
  }

  // --- 2. åˆå§‹åŒ– AI å›åˆ ---
  loading.value = true;
  signalController.value = new AbortController();
  await nextTick();

  // å¼€å§‹å›ç­”æ—¶ï¼Œå¼ºåˆ¶é”å®šåˆ°åº•éƒ¨
  isSticky.value = true;
  scrollToBottom('auto'); // ç¬é—´ç½®åº•

  const currentPromptConfig = currentConfig.value.prompts[CODE.value];
  const isVoiceReply = !!selectedVoice.value;
  let useStream = currentPromptConfig?.stream && !isVoiceReply;
  let tool_calls_count = 0;

  let currentAssistantChatShowIndex = -1;

  try {
    const { OpenAI } = await import('openai');

    const openai = new OpenAI({
      apiKey: () => window.api.getRandomItem(api_key.value),
      baseURL: base_url.value,
      dangerouslyAllowBrowser: true,
      maxRetries: 3,
    });

    // --- 3. å¼€å§‹å·¥å…·è°ƒç”¨å¾ªç¯ ---
    while (!signalController.value.signal.aborted) {
      chatInputRef.value?.focus({ cursor: 'end' });

      // --- ä¸ºæœ¬æ¬¡è¯·æ±‚åˆ›å»ºä¸´æ—¶æ¶ˆæ¯åˆ—è¡¨ ---
      let messagesForThisRequest = JSON.parse(JSON.stringify(history.value));

      messagesForThisRequest = messagesForThisRequest.filter(msg => {
        if (msg.role === 'system' && (!msg.content || msg.content.trim() === '')) {
          return false; // è¿‡æ»¤æ‰ç©ºç³»ç»Ÿæç¤ºè¯
        }
        return true;
      });

      messagesForThisRequest.forEach(msg => {
        // 1. è¿‡æ»¤æ‰æ ‡è®°ä¸º isTranscript çš„å†…å®¹ (é˜²æ­¢è½¬å½•æ–‡æœ¬è¢«å‘å›ç»™AI)
        if (Array.isArray(msg.content)) {
          msg.content = msg.content.filter(part => !part.isTranscript);
          // å¦‚æœè¿‡æ»¤åæ•°ç»„ä¸ºç©ºï¼Œé‡ç½®ä¸º null (ä¹Ÿå°±æ˜¯è¯¥æ¶ˆæ¯æ²¡æœ‰å®è´¨å†…å®¹)
          if (msg.content.length === 0) msg.content = null;
        }

        // 2. æ¸…ç† null å­—æ®µ (é˜²æ­¢ API æŠ¥é”™)
        ['content', 'reasoning_content', 'extra_content'].forEach(key => {
          if (msg[key] === null) {
            delete msg[key];
          }
        });
      });

      if (currentPromptConfig && currentPromptConfig.ifTextNecessary) {
        const now = new Date();
        const timestamp = `current time: ${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

        messagesForThisRequest.forEach(msg => {
          if (msg.role === 'user') {
            if (msg.content === undefined || msg.content === null) {
              msg.content = timestamp;
            }
            else if (typeof msg.content === 'string') {
              if (msg.content.trim() === '') {
                msg.content = timestamp;
              }
            }
            else if (Array.isArray(msg.content)) {
              if (msg.content.length === 0) {
                msg.content = timestamp;
              } else {
                const hasText = msg.content.some(part => part.type === 'text' && part.text && part.text.trim() !== '');
                if (!hasText) {
                  msg.content.push({
                    type: "text",
                    text: timestamp
                  });
                }
              }
            }
          }
        });
      }

      // å‡†å¤‡ System Prompt å’Œ MCP è§„åˆ™
      let mcpSystemPromptStr = "";
      if (openaiFormattedTools.value.length > 0) {
        mcpSystemPromptStr = generateMcpSystemPrompt();
        const systemMessageIndex = messagesForThisRequest.findIndex(m => m.role === 'system');
        if (systemMessageIndex !== -1) {
          if (!messagesForThisRequest[systemMessageIndex].content.includes("## Tool Use Rules")) {
            messagesForThisRequest[systemMessageIndex].content += mcpSystemPromptStr;
          }
        } else {
          messagesForThisRequest.unshift({ role: "system", content: mcpSystemPromptStr });
        }
      }

      const payload = {
        model: model.value.split("|")[1],
        messages: messagesForThisRequest,
        stream: useStream,
      };

      if (currentPromptConfig?.isTemperature) payload.temperature = currentPromptConfig.temperature;
      if (tempReasoningEffort.value && tempReasoningEffort.value !== 'default') payload.reasoning_effort = tempReasoningEffort.value;

      if (openaiFormattedTools.value.length > 0) {
        payload.tools = openaiFormattedTools.value;
        payload.tool_choice = "auto";
      }
      if (isVoiceReply) {
        payload.stream = false;
        useStream = false;
        payload.modalities = ["text", "audio"];
        payload.audio = { voice: selectedVoice.value.split('-')[0].trim(), format: "wav" };
      }

      const assistantMessageId = messageIdCounter.value++;
      chat_show.value.push({
        id: assistantMessageId,
        role: "assistant", content: [], reasoning_content: "", status: "",
        aiName: modelMap.value[model.value] || model.value.split('|')[1],
        voiceName: selectedVoice.value, tool_calls: []
      });
      currentAssistantChatShowIndex = chat_show.value.length - 1;

      // åˆ›å»ºæ–°æ°”æ³¡æ—¶ï¼Œå¦‚æœ Sticky ä¸º trueï¼ŒMutationObserver ä¼šè‡ªåŠ¨å¤„ç†æ»šåŠ¨
      // è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ scrollToBottomï¼Œé™¤éæ˜¯åˆå§‹çŠ¶æ€å¼ºåˆ¶å¯¹é½
      if (isAtBottom.value) scrollToBottom('auto');

      let responseMessage;

      if (useStream) {
        const stream = await openai.chat.completions.create(payload, { signal: signalController.value.signal });

        let aggregatedReasoningContent = "";
        let aggregatedContent = "";
        let aggregatedToolCalls = [];
        let aggregatedExtraContent = null;
        let lastUpdateTime = Date.now();

        for await (const part of stream) {
          const delta = part.choices?.[0]?.delta;

          if (!delta) continue;

          if (delta.extra_content) {
            aggregatedExtraContent = { ...aggregatedExtraContent, ...delta.extra_content };
          }
          if (delta.thought_signature) {
            aggregatedExtraContent = aggregatedExtraContent || {};
            aggregatedExtraContent.google = aggregatedExtraContent.google || {};
            aggregatedExtraContent.google.thought_signature = delta.thought_signature;
          }

          if (delta.reasoning_content) {
            aggregatedReasoningContent += delta.reasoning_content;
            if (chat_show.value[currentAssistantChatShowIndex].status !== 'thinking') {
              chat_show.value[currentAssistantChatShowIndex].status = 'thinking';
            }

            if (Date.now() - lastUpdateTime > 100) {
              chat_show.value[currentAssistantChatShowIndex].reasoning_content = aggregatedReasoningContent;
              // ç§»é™¤äº† scrollToBottom è°ƒç”¨ (MutationObserver æ¥ç®¡)
              lastUpdateTime = Date.now();
            }
          }
          if (delta.content) {
            aggregatedContent += delta.content;
            if (chat_show.value[currentAssistantChatShowIndex].status == 'thinking') {
              chat_show.value[currentAssistantChatShowIndex].status = 'end';
            }

            if (Date.now() - lastUpdateTime > 100) {
              chat_show.value[currentAssistantChatShowIndex].content = [{ type: 'text', text: aggregatedContent }];
              // ç§»é™¤äº† scrollToBottom è°ƒç”¨ (MutationObserver æ¥ç®¡)
              lastUpdateTime = Date.now();
            }
          }

          if (delta.tool_calls) {
            for (const toolCallChunk of delta.tool_calls) {
              const index = toolCallChunk.index ?? aggregatedToolCalls.length;
              if (!aggregatedToolCalls[index]) {
                aggregatedToolCalls[index] = { id: "", type: "function", function: { name: "", arguments: "" } };
              }
              const currentTool = aggregatedToolCalls[index];
              if (toolCallChunk.id) currentTool.id = toolCallChunk.id;
              if (toolCallChunk.function?.name) currentTool.function.name = toolCallChunk.function.name;
              if (toolCallChunk.function?.arguments) currentTool.function.arguments += toolCallChunk.function.arguments;

              if (toolCallChunk.extra_content) {
                currentTool.extra_content = { ...currentTool.extra_content, ...toolCallChunk.extra_content };
              }
            }
          }
        }

        responseMessage = {
          role: 'assistant',
          content: aggregatedContent || null,
          reasoning_content: aggregatedReasoningContent || null,
          extra_content: aggregatedExtraContent
        };

        if (aggregatedToolCalls.length > 0) {
          responseMessage.tool_calls = aggregatedToolCalls.filter(tc => tc.id && tc.function.name);
        }
      } else {
        const response = await openai.chat.completions.create(payload, { signal: signalController.value.signal });
        responseMessage = response.choices[0].message;
      }

      if (responseMessage.tool_calls && responseMessage.tool_calls.length > 0) {
        responseMessage.tool_calls.forEach(tc => {
          if (tc.function && tc.function.arguments) {
            tc.function.arguments = sanitizeToolArgs(tc.function.arguments);
          }
        });
      }

      history.value.push(responseMessage);

      const currentBubble = chat_show.value[currentAssistantChatShowIndex];
      if (responseMessage.content) {
        currentBubble.content = [{ type: 'text', text: responseMessage.content }];
      }
      if (responseMessage.reasoning_content) {
        currentBubble.reasoning_content = responseMessage.reasoning_content;
        currentBubble.status = 'end';
      }

      if (responseMessage.tool_calls && responseMessage.tool_calls.length > 0) {
        tool_calls_count++;
        currentBubble.tool_calls = responseMessage.tool_calls.map(tc => ({
          id: tc.id,
          name: tc.function.name,
          args: tc.function.arguments,
          result: 'ç­‰å¾…æ‰¹å‡†...',
          approvalStatus: isAutoApproveTools.value ? 'approved' : 'waiting'
        }));

        await nextTick();
        // ç§»é™¤äº† scrollToBottom

        const toolMessages = await Promise.all(
          responseMessage.tool_calls.map(async (toolCall) => {
            const uiToolCall = currentBubble.tool_calls.find(t => t.id === toolCall.id);
            let toolContent;

            if (!isAutoApproveTools.value) {
              try {
                const isApproved = await new Promise((resolve) => {
                  pendingToolApprovals.value.set(toolCall.id, resolve);
                });

                if (!isApproved) {
                  if (uiToolCall) {
                    uiToolCall.approvalStatus = 'rejected';
                    uiToolCall.result = 'ç”¨æˆ·å·²å–æ¶ˆæ‰§è¡Œ';
                  }
                  return {
                    tool_call_id: toolCall.id,
                    role: "tool",
                    name: toolCall.function.name,
                    content: "User denied this tool execution."
                  };
                }
              } catch (e) {
              }
            }

            if (uiToolCall) {
              uiToolCall.approvalStatus = 'executing';
              uiToolCall.result = 'æ‰§è¡Œä¸­...';
            }
            const controller = new AbortController();
            toolCallControllers.value.set(toolCall.id, controller);

            try {
              const toolArgs = JSON.parse(toolCall.function.arguments);
              let executionContext = null;

              if (toolCall.function.name === 'sub_agent') {
                const currentApiKey = api_key.value;
                const currentBaseUrl = base_url.value;
                const currentModelName = model.value.split('|')[1] || model.value;

                // 1. è·å–å…¨é‡å·¥å…·åˆ—è¡¨ (æ’é™¤ sub_agent è‡ªèº«)
                const toolsContext = openaiFormattedTools.value
                  .filter(t => t.function.name !== 'sub_agent');

                // 2. å®šä¹‰å®æ—¶æ›´æ–°å›è°ƒ (ç”¨äºå‰ç«¯å±•ç¤º Sub-Agent çš„æ€è€ƒè¿‡ç¨‹)
                const onUpdateCallback = (logContent) => {
                  if (uiToolCall) {
                    // åœ¨æ—¥å¿—æœ«å°¾æ·»åŠ åŠ¨æ€æ ‡è¯†
                    uiToolCall.result = logContent + "\n\n[Sub-Agent æ‰§è¡Œä¸­...]";
                  }
                };

                // 3. ç»„è£…ä¸Šä¸‹æ–‡
                executionContext = {
                  apiKey: currentApiKey,
                  baseUrl: currentBaseUrl,
                  model: currentModelName,
                  tools: toolsContext,
                  mcpSystemPrompt: mcpSystemPromptStr, // åŒæ­¥ä¸»å¯¹è¯çš„ MCP æç¤ºè¯
                  onUpdate: onUpdateCallback           // ä¼ å…¥æ›´æ–°å›è°ƒ
                };
              }

              // æ‰§è¡Œ MCP å·¥å…·
              const result = await window.api.invokeMcpTool(
                toolCall.function.name,
                toolArgs,
                toolCallControllers.value.get(toolCall.id)?.signal || signalController.value.signal,
                executionContext
              );

              toolContent = Array.isArray(result) ? result.filter(item => item?.type === 'text' && typeof item.text === 'string').map(item => item.text).join('\n\n') : String(result);

              if (uiToolCall) {
                // å¦‚æœæ˜¯ Sub-Agentï¼Œåˆå¹¶æ—¥å¿—å’Œæœ€ç»ˆç»“æœ
                if (toolCall.function.name === 'sub_agent') {
                  const currentLog = uiToolCall.result ? uiToolCall.result.replace("\n\n[Sub-Agent æ‰§è¡Œä¸­...]", "") : "";

                  // å¦‚æœç»“æœä¸­ä¸åŒ…å«æ—¥å¿—ä¿¡æ¯ï¼ˆå³å®ƒåªæ˜¯çº¯ç­”æ¡ˆï¼‰ï¼Œåˆ™æ ¼å¼åŒ–è¿½åŠ 
                  if (!currentLog.includes(toolContent)) {
                    uiToolCall.result = `${currentLog}\n\n=== æœ€ç»ˆç»“æœ ===\n${toolContent}`;
                  } else {
                    // å¦‚æœ result å·²ç»åŒ…å«äº†æ—¥å¿— (å–å†³äºåç«¯å®ç°)ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
                    uiToolCall.result = currentLog;
                  }
                } else {
                  uiToolCall.result = toolContent;
                }

                uiToolCall.approvalStatus = 'finished';
              }
            } catch (e) {
              if (e.name === 'AbortError') {
                toolContent = "Error: Tool call was canceled by the user.";
                if (uiToolCall) uiToolCall.approvalStatus = 'rejected';
              } else {
                toolContent = `{'result':'å·¥å…·æ‰§è¡Œæˆ–å‚æ•°è§£æé”™è¯¯: ${e.message}'}`;
                if (uiToolCall) uiToolCall.approvalStatus = 'finished';
              }
              if (uiToolCall) uiToolCall.result = toolContent;
            } finally {
              toolCallControllers.value.delete(toolCall.id);
            }
            return { tool_call_id: toolCall.id, role: "tool", name: toolCall.function.name, content: toolContent };
          })
        );

        history.value.push(...toolMessages);
      } else {
        if (isVoiceReply && responseMessage.audio) {
          currentBubble.content = currentBubble.content || [];

          if (responseMessage.audio.transcript) {
            const rawTranscript = responseMessage.audio.transcript;
            currentBubble.content.push({
              type: "text",
              text: `\n\n${rawTranscript}`,
              isTranscript: true
            });
          }

          currentBubble.content.push({
            type: "input_audio",
            input_audio: {
              data: responseMessage.audio.data,
              format: 'wav'
            }
          });
        }
        break;
      }
    }
  } catch (error) {
    let errorDisplay = `å‘ç”Ÿé”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
    if (error.name === 'AbortError') errorDisplay = "è¯·æ±‚å·²å–æ¶ˆ";

    const errorBubbleIndex = currentAssistantChatShowIndex > -1 ? currentAssistantChatShowIndex : chat_show.value.length;
    if (currentAssistantChatShowIndex === -1) {
      chat_show.value.push({
        id: messageIdCounter.value++, role: "assistant", content: [],
        aiName: modelMap.value[model.value] || model.value.split('|')[1], voiceName: selectedVoice.value
      });
    }
    const currentBubble = chat_show.value[errorBubbleIndex];
    if (chat_show.value[errorBubbleIndex].reasoning_content && currentBubble.status === 'thinking') {
      chat_show.value[errorBubbleIndex].status = "error";
    }

    let existingText = "";
    if (currentBubble.content && Array.isArray(currentBubble.content)) {
      existingText = currentBubble.content
        .filter(part => part.type === 'text')
        .map(part => part.text)
        .join('');
    } else if (typeof currentBubble.content === 'string') {
      existingText = currentBubble.content;
    }

    if (existingText && existingText.trim().length > 0) {
      const combinedText = `${existingText}\n\n> **Error**: ${errorDisplay}`;
      currentBubble.content = [{ type: "text", text: combinedText }];
      history.value.push({
        role: 'assistant',
        content: combinedText,
        reasoning_content: currentBubble.reasoning_content || null
      });
    } else {
      currentBubble.content = [{ type: "text", text: `${errorDisplay}` }];
      history.value.push({
        role: 'assistant',
        content: `${errorDisplay}`,
        reasoning_content: currentBubble.reasoning_content || null
      });
    }

  } finally {
    loading.value = false;
    signalController.value = null;
    if (currentAssistantChatShowIndex > -1) {
      chat_show.value[currentAssistantChatShowIndex].completedTimestamp = new Date().toLocaleString('sv-SE');
    }
    await nextTick();
    chatInputRef.value?.focus({ cursor: 'end' });
    autoSaveSession();
  }
};

const cancelAskAI = () => { if (loading.value && signalController.value) { signalController.value.abort(); chatInputRef.value?.focus(); } };
const copyText = async (content, index) => { if (loading.value && index === chat_show.value.length - 1) return; await window.api.copyText(content); };
const reaskAI = async () => {
  if (loading.value) return;

  const lastVisibleMessageIndexInHistory = history.value.findLastIndex(msg => msg.role !== 'tool');

  if (lastVisibleMessageIndexInHistory === -1) {
    showDismissibleMessage.warning('æ²¡æœ‰å¯ä»¥é‡æ–°æé—®çš„ç”¨æˆ·æ¶ˆæ¯');
    return;
  }

  const lastVisibleMessage = history.value[lastVisibleMessageIndexInHistory];

  if (lastVisibleMessage.role === 'assistant') {
    const historyItemsToRemove = history.value.length - lastVisibleMessageIndexInHistory;
    const showItemsToRemove = history.value.slice(lastVisibleMessageIndexInHistory)
      .filter(m => m.role !== 'tool').length;

    history.value.splice(lastVisibleMessageIndexInHistory, historyItemsToRemove);
    if (showItemsToRemove > 0) {
      chat_show.value.splice(chat_show.value.length - showItemsToRemove);
    }

  } else if (lastVisibleMessage.role === 'user') {
  } else {
    showDismissibleMessage.warning('æ— æ³•ä»æ­¤æ¶ˆæ¯ç±»å‹é‡æ–°æé—®ã€‚');
    return;
  }

  collapsedMessages.value.clear();
  await nextTick();
  await askAI(true);
};

const deleteMessage = (index) => {
  if (loading.value) {
    showDismissibleMessage.warning('è¯·ç­‰å¾…å½“å‰å›å¤å®Œæˆåå†æ“ä½œ');
    return;
  }
  if (index < 0 || index >= chat_show.value.length) return;

  const msgToDeleteInShow = chat_show.value[index];
  if (msgToDeleteInShow?.role === 'system') {
    showDismissibleMessage.info('ç³»ç»Ÿæç¤ºè¯ä¸èƒ½è¢«åˆ é™¤');
    return;
  }

  let history_idx = -1;
  let show_counter = -1;
  for (let i = 0; i < history.value.length; i++) {
    if (history.value[i].role !== 'tool') {
      show_counter++;
    }
    if (show_counter === index) {
      history_idx = i;
      break;
    }
  }

  if (history_idx === -1) {
    console.error("å…³é”®é”™è¯¯: æ— æ³•å°† chat_show ç´¢å¼•æ˜ å°„åˆ° history ç´¢å¼•ã€‚ä¸­æ­¢åˆ é™¤ã€‚");
    showDismissibleMessage.error("åˆ é™¤å¤±è´¥ï¼šæ¶ˆæ¯çŠ¶æ€ä¸ä¸€è‡´ã€‚");
    return;
  }

  const messageToDeleteInHistory = history.value[history_idx];
  let history_start_idx = history_idx;
  let history_end_idx = history_idx;

  if (
    messageToDeleteInHistory.role === 'assistant' &&
    messageToDeleteInHistory.tool_calls &&
    messageToDeleteInHistory.tool_calls.length > 0
  ) {
    while (history.value[history_end_idx + 1]?.role === 'tool') {
      history_end_idx++;
    }
  }

  const history_delete_count = history_end_idx - history_start_idx + 1;
  const show_delete_count = 1;
  const show_start_idx = index;

  if (history_delete_count > 0) {
    history.value.splice(history_start_idx, history_delete_count);
  }

  if (show_delete_count > 0) {
    chat_show.value.splice(show_start_idx, show_delete_count);
  }

  const deletedIndexInShow = index;
  const newCollapsedMessages = new Set();
  for (const collapsedIdx of collapsedMessages.value) {
    if (collapsedIdx < deletedIndexInShow) {
      newCollapsedMessages.add(collapsedIdx);
    } else if (collapsedIdx > deletedIndexInShow) {
      newCollapsedMessages.add(collapsedIdx - 1);
    }
  }
  collapsedMessages.value = newCollapsedMessages;

  focusedMessageIndex.value = null;
};

const clearHistory = () => {
  if (loading.value) {
    return;
  }

  const systemPromptFromConfig = currentConfig.value.prompts[CODE.value]?.prompt;
  const firstMessageInHistory = history.value.length > 0 ? history.value[0] : null;
  const systemPromptFromHistory = (firstMessageInHistory && firstMessageInHistory.role === 'system') ? firstMessageInHistory : null;
  const systemPromptToKeep = systemPromptFromConfig ? { role: "system", content: systemPromptFromConfig } : systemPromptFromHistory;

  if (systemPromptToKeep) {
    history.value = [systemPromptToKeep];
    chat_show.value = [{ ...systemPromptToKeep, id: messageIdCounter.value++ }];
  } else {
    history.value = [];
    chat_show.value = [];
  }

  collapsedMessages.value.clear();
  messageRefs.clear();
  focusedMessageIndex.value = null;
  defaultConversationName.value = "";
  chatInputRef.value?.focus({ cursor: 'end' });
  showDismissibleMessage.success('å†å²è®°å½•å·²æ¸…é™¤');
};

function toggleMcpServerSelection(serverId) {
  const index = tempSessionMcpServerIds.value.indexOf(serverId);
  if (index === -1) {
    tempSessionMcpServerIds.value.push(serverId);
  } else {
    tempSessionMcpServerIds.value.splice(index, 1);
  }
}

async function handleQuickMcpToggle(serverId) {
  const index = sessionMcpServerIds.value.indexOf(serverId);
  if (index === -1) {
    sessionMcpServerIds.value.push(serverId);
  } else {
    sessionMcpServerIds.value.splice(index, 1);
  }
  
  tempSessionMcpServerIds.value = [...sessionMcpServerIds.value];
  
  await applyMcpTools(false);
}

const focusOnInput = () => {
  setTimeout(() => {
    chatInputRef.value?.focus({ cursor: 'end' });
  }, 100);
};

const handleCancelToolCall = (toolCallId) => {
  const controller = toolCallControllers.value.get(toolCallId);
  if (controller) {
    controller.abort();
    showDismissibleMessage.info('æ­£åœ¨å–æ¶ˆå·¥å…·è°ƒç”¨...');
  }
};

function getDisplayTypeName(type) {
  if (!type) return '';
  const streamableHttpRegex = /^streamable[\s_-]?http$/i;
  const lowerType = type.toLowerCase();

  if (lowerType === 'builtin') {
    return "å†…ç½®";
  }

  if (streamableHttpRegex.test(lowerType) || lowerType === 'http') {
    return "å¯æµå¼ HTTP";
  }

  else return type
}

const handleSaveModel = async (modelToSave) => {
  if (!CODE.value || !currentConfig.value.prompts[CODE.value]) {
    showDismissibleMessage.warning('æ— æ³•ä¿å­˜æ¨¡å‹ï¼Œå› ä¸ºå½“å‰ä¸æ˜¯ä¸€ä¸ªå·²å®šä¹‰çš„å¿«æ·åŠ©æ‰‹ã€‚');
    return;
  }

  try {
    const result = await window.api.saveSetting(`prompts.${CODE.value}.model`, modelToSave);
    changeModel_page.value = false;
    if (result && result.success) {
      currentConfig.value.prompts[CODE.value].model = modelToSave;
      showDismissibleMessage.success(`æ¨¡å‹å·²ä¸ºå¿«æ·åŠ©æ‰‹ "${CODE.value}" ä¿å­˜æˆåŠŸï¼`);
    } else {
      throw new Error(result?.message || 'ä¿å­˜å¤±è´¥');
    }
  } catch (error) {
    console.error("ä¿å­˜æ¨¡å‹å¤±è´¥:", error);
    showDismissibleMessage.error(`ä¿å­˜æ¨¡å‹å¤±è´¥: ${error.message}`);
  }

  changeModel_page.value = false;
};

const handleGlobalImageError = (event) => {
  const img = event.target;

  if (!(img instanceof HTMLImageElement) || !img.closest('.markdown-wrapper')) {
    return;
  }

  event.preventDefault();

  const originalSrc = img.src;

  if (img.parentNode && img.parentNode.classList.contains('image-error-container')) {
    return;
  }

  const container = document.createElement('div');
  container.className = 'image-error-container';
  container.title = 'å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';

  const svgIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svgIcon.setAttribute('viewBox', '0 0 24 24');
  svgIcon.innerHTML = `<path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="currentColor"></path>`;

  const textLabel = document.createElement('span');
  textLabel.textContent = 'Image';

  container.appendChild(svgIcon);
  container.appendChild(textLabel);

  if (img.parentNode) {
    img.parentNode.replaceChild(container, img);
  }

  container.onclick = (e) => {
    e.stopPropagation();
    const newImg = document.createElement('img');
    newImg.src = `${originalSrc}?t=${new Date().getTime()}`;
    if (container.parentNode) {
      container.parentNode.replaceChild(newImg, container);
    }
  };
};

const handleGlobalKeyDown = (event) => {
  const isCtrl = event.ctrlKey || event.metaKey;

  // 1. ä¿å­˜åŠŸèƒ½ (Ctrl + S) - ä¿æŒåŸæœ‰é€»è¾‘
  if (isCtrl && event.key.toLowerCase() === 's') {
    event.preventDefault();

    if (loading.value) {
      showDismissibleMessage.warning('è¯·ç­‰å¾… AI å›å¤å®Œæˆåå†ä¿å­˜');
      return;
    }

    if (document.querySelector('.el-dialog, .el-message-box')) {
      return;
    }
    handleSaveAction();
    return;
  }

  // 2. ç¼©æ”¾å¿«æ·é”®æ§åˆ¶
  if (isCtrl) {
    // é‡ç½®ç¼©æ”¾ (Ctrl + 0)
    if (event.key === '0') {
      event.preventDefault();
      zoomLevel.value = 1;
      showDismissibleMessage.info('ç¼©æ”¾å·²é‡ç½® (100%)');
      return;
    }

    // æ”¾å¤§ (Ctrl + = æˆ– Ctrl + +)
    // æ³¨æ„ï¼šåœ¨å¤§å¤šæ•°é”®ç›˜ä¸Šï¼Œ+ å·ä½äº = é”®ä¸Šï¼Œä¸æŒ‰ Shift æ—¶ key ä¸º '='
    if (event.key === '=' || event.key === '+') {
      event.preventDefault();
      const newZoom = zoomLevel.value + 0.1;
      // é™åˆ¶æœ€å¤§ç¼©æ”¾ä¸º 2.0ï¼Œä¸é¼ æ ‡æ»šè½®é€»è¾‘ä¿æŒä¸€è‡´
      zoomLevel.value = Math.min(2.0, newZoom);
      showDismissibleMessage.info(`ç¼©æ”¾: ${Math.round(zoomLevel.value * 100)}%`);
      return;
    }

    // ç¼©å° (Ctrl + -)
    if (event.key === '-') {
      event.preventDefault();
      const newZoom = zoomLevel.value - 0.1;
      // é™åˆ¶æœ€å°ç¼©æ”¾ä¸º 0.5ï¼Œä¸é¼ æ ‡æ»šè½®é€»è¾‘ä¿æŒä¸€è‡´
      zoomLevel.value = Math.max(0.5, newZoom);
      showDismissibleMessage.info(`ç¼©æ”¾: ${Math.round(zoomLevel.value * 100)}%`);
      return;
    }
  }
};

const handleOpenSearch = () => {
  if (textSearchInstance) {
    textSearchInstance.show();
  }
};
</script>

<template>
  <main>
    <div v-if="windowBackgroundImage" class="window-bg-base"></div>
    <div class="window-bg-layer" :class="{ 'is-visible': !!windowBackgroundImage }" :style="{
      backgroundImage: windowBackgroundImage ? `url('${windowBackgroundImage}')` : 'none',
      opacity: windowBackgroundImage ? windowBackgroundOpacity : 0,
      filter: `blur(${windowBackgroundBlur}px)`
    }">
    </div>
    <el-container class="app-container" :class="{ 'has-bg': !!windowBackgroundImage }">
      <TitleBar :favicon="favicon" :promptName="CODE" :conversationName="defaultConversationName"
        :isAlwaysOnTop="isAlwaysOnTop" :autoCloseOnBlur="autoCloseOnBlur" :isDarkMode="currentConfig.isDarkMode"
        :os="currentOS" @save-window-size="handleSaveWindowSize" @save-session="handleSaveSession"
        @toggle-pin="handleTogglePin" @toggle-always-on-top="handleToggleAlwaysOnTop" @minimize="handleMinimize"
        @maximize="handleMaximize" @close="handleCloseWindow" />
      <ChatHeader :modelMap="modelMap" :model="model" :is-mcp-loading="isMcpLoading" :systemPrompt="currentSystemPrompt"
        @open-model-dialog="handleOpenModelDialog" @show-system-prompt="handleShowSystemPrompt"
        @open-search="handleOpenSearch" />

      <div class="main-area-wrapper">
        <el-main ref="chatContainerRef" class="chat-main custom-scrollbar" @click="handleMarkdownImageClick"
          @scroll="handleScroll">
          <ChatMessage v-for="(message, index) in chat_show" :key="message.id" :is-auto-approve="isAutoApproveTools"
            @update-auto-approve="handleToggleAutoApprove" @confirm-tool="handleToolApproval"
            @reject-tool="handleToolApproval" :ref="el => setMessageRef(el, message.id)" :message="message"
            :index="index" :is-last-message="index === chat_show.length - 1" :is-loading="loading"
            :user-avatar="UserAvart" :ai-avatar="AIAvart" :is-collapsed="isCollapsed(index)"
            :is-dark-mode="currentConfig.isDarkMode" @delete-message="handleDeleteMessage" @copy-text="handleCopyText"
            @re-ask="handleReAsk" @toggle-collapse="handleToggleCollapse" @show-system-prompt="handleShowSystemPrompt"
            @avatar-click="onAvatarClick" @edit-message-requested="handleEditStart" @edit-finished="handleEditEnd"
            @edit-message="handleEditMessage" @cancel-tool-call="handleCancelToolCall" />
        </el-main>

        <div v-if="showScrollToBottomButton" class="scroll-to-bottom-wrapper">
          <!-- 1. å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
          <el-tooltip content="å›åˆ°é¡¶éƒ¨" placement="left" :show-after="500">
            <el-button class="scroll-nav-btn" @click="scrollToTop">
              <el-icon :size="14">
                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                  <path
                    d="M492.367 74.709h46.406L960 503.076l-46.406 46.406-403.379-403.378-399.809 403.378L64 503.076 492.367 74.709z m0 399.809h46.406L960 902.884l-46.406 46.406-403.379-399.808-399.809 399.809L64 902.884l428.367-428.366z">
                  </path>
                </svg>
              </el-icon>
            </el-button>
          </el-tooltip>

          <!-- 2. ä¸Šä¸€æ¡æ¶ˆæ¯ -->
          <el-tooltip content="ä¸Šä¸€æ¡æ¶ˆæ¯" placement="left" :show-after="500">
            <el-button class="scroll-nav-btn" @click="navigateToPreviousMessage">
              <el-icon :size="14">
                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                  <path d="M902.5 749.2l57.5-57.5-421.6-416.9h-52.7L64 691.7l57.5 57.5 388.1-392.9 392.9 392.9z"></path>
                </svg>
              </el-icon>
            </el-button>
          </el-tooltip>

          <!-- 3. ä¸‹ä¸€æ¡æ¶ˆæ¯ -->
          <el-tooltip :content="nextButtonTooltip" placement="left" :show-after="500">
            <el-button class="scroll-nav-btn" @click="navigateToNextMessage">
              <el-icon :size="14">
                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                  <path d="M121.5 274.8L64 332.3l421.6 416.9h52.7l421.6-416.9-57.5-57.5-388.1 392.9-392.8-392.9z">
                  </path>
                </svg>
              </el-icon>
            </el-button>
          </el-tooltip>

          <!-- 4. è·³åˆ°åº•éƒ¨æŒ‰é’® -->
          <el-tooltip content="è·³åˆ°åº•éƒ¨" placement="left" :show-after="500">
            <el-button class="scroll-nav-btn" @click="forceScrollToBottom">
              <el-icon :size="14">
                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                  <path
                    d="M535.203 545.912h-46.406L64 121.116l46.406-46.406 403.378 399.809 399.81-399.81L960 121.116 535.203 545.912z m0 403.379h-46.406L64 524.494l46.406-49.976 403.378 403.379 399.809-403.379L960 524.494 535.203 949.291z">
                  </path>
                </svg>
              </el-icon>
            </el-button>
          </el-tooltip>
        </div>

        <ChatInput ref="chatInputRef" v-model:prompt="prompt" v-model:fileList="fileList"
          v-model:selectedVoice="selectedVoice" v-model:tempReasoningEffort="tempReasoningEffort" :loading="loading"
          :ctrlEnterToSend="currentConfig.CtrlEnterToSend" :layout="inputLayout" :voiceList="currentConfig.voiceList"
          :is-mcp-active="isMcpActive" 
          :all-mcp-servers="availableMcpServers" 
          :active-mcp-ids="sessionMcpServerIds"
          @submit="handleSubmit" @cancel="handleCancel" @clear-history="handleClearHistory"
          @remove-file="handleRemoveFile" @upload="handleUpload" @send-audio="handleSendAudio"
          @open-mcp-dialog="handleOpenMcpDialog" @pick-file-start="handlePickFileStart" 
          @toggle-mcp="handleQuickMcpToggle"
          />
      </div>
    </el-container>
  </main>

  <ModelSelectionDialog v-model="changeModel_page" :modelList="modelList" :currentModel="model"
    @select="handleChangeModel" @save-model="handleSaveModel" />

  <el-dialog v-model="systemPromptDialogVisible" title="" custom-class="system-prompt-dialog" width="60%"
    :show-close="false" :lock-scroll="false" :append-to-body="true" center :close-on-click-modal="true"
    :close-on-press-escape="true">
    <template #header="{ close, titleId, titleClass }">
      <div style="display: none;"></div>
    </template>
    <el-input v-model="systemPromptContent" type="textarea" :autosize="{ minRows: 4, maxRows: 15 }"
      class="system-prompt-full-content" resize="none" @keydown="handleSystemPromptKeydown" />
    <template #footer>
      <el-button @click="systemPromptDialogVisible = false">å–æ¶ˆ</el-button>
      <el-button type="primary" @click="saveSystemPrompt">ä¿å­˜</el-button>
    </template>
  </el-dialog>

  <el-image-viewer v-if="imageViewerVisible" :url-list="imageViewerSrcList" :initial-index="imageViewerInitialIndex"
    @close="imageViewerVisible = false" :hide-on-click-modal="true" teleported />
  <div v-if="imageViewerVisible" class="custom-viewer-actions">
    <el-button type="primary" :icon="DocumentCopy" circle @click="handleCopyImageFromViewer(imageViewerSrcList[0])"
      title="å¤åˆ¶å›¾ç‰‡" />
    <el-button type="primary" :icon="Download" circle @click="handleDownloadImageFromViewer(imageViewerSrcList[0])"
      title="ä¸‹è½½å›¾ç‰‡" />
  </div>

  <el-dialog v-model="isMcpDialogVisible" width="80%" custom-class="mcp-dialog no-header-dialog" @close="focusOnInput"
    :show-close="false">
    <template #header>
      <div style="display: none;"></div>
    </template>
    <div class="mcp-dialog-content">
      <div class="mcp-dialog-toolbar">
        <el-button-group>
          <el-button :type="mcpFilter === 'all' ? 'primary' : ''" @click="mcpFilter = 'all'">å…¨éƒ¨</el-button>
          <el-button :type="mcpFilter === 'selected' ? 'primary' : ''" @click="mcpFilter = 'selected'">å·²é€‰
          </el-button>
          <el-button :type="mcpFilter === 'unselected' ? 'primary' : ''" @click="mcpFilter = 'unselected'">æœªé€‰
          </el-button>
        </el-button-group>
        <el-button-group>
          <el-button @click="selectAllMcpServers">å…¨é€‰</el-button>
          <el-button @click="clearMcpTools">æ¸…ç©º</el-button>
        </el-button-group>
      </div>
      <div class="mcp-server-list custom-scrollbar">
        <div v-for="server in filteredMcpServers" :key="server.id" class="mcp-server-item-wrapper">
          <!-- ä¸»å¡ç‰‡åŒºåŸŸ -->
          <div class="mcp-server-item" :class="{ 'is-checked': tempSessionMcpServerIds.includes(server.id) }"
            @click="toggleMcpServerSelection(server.id)">

            <div class="mcp-server-content">
              <!-- ç¬¬ä¸€è¡Œï¼šå‹¾é€‰æ¡† | Logo | åç§° | é—´éš” | æŒä¹…åŒ– | æ ‡ç­¾ -->
              <div class="mcp-server-header-row">
                <el-checkbox :model-value="tempSessionMcpServerIds.includes(server.id)" size="large"
                  @change="() => toggleMcpServerSelection(server.id)" @click.stop class="header-checkbox" />

                <el-avatar :src="server.logoUrl" shape="square" :size="20" class="mcp-server-icon">
                  <el-icon :size="12">
                    <Tools />
                  </el-icon>
                </el-avatar>
                <span class="mcp-server-name">
                  {{ server.name }}
                  <span v-if="getToolCounts(server.id)" class="mcp-tool-count">
                    ({{ getToolCounts(server.id).enabled }}/{{ getToolCounts(server.id).total }})
                  </span>
                </span>
                
                <!-- å³ä¾§åˆ†ç»„ï¼šåŒ…å«æŒä¹…è¿æ¥æŒ‰é’®å’Œæ ‡ç­¾ï¼Œç»Ÿä¸€é å³ -->
                <div class="mcp-header-right-group">
                  <el-tooltip :content="server.isPersistent ? 'æŒä¹…è¿æ¥å·²å¼€å¯' : 'æŒä¹…è¿æ¥å·²å…³é—­'" placement="top">
                    <el-button text circle :class="{ 'is-persistent-active': server.isPersistent }"
                      @click.stop="toggleMcpPersistence(server.id, !server.isPersistent)" class="persistent-btn">
                      <el-icon :size="16">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                        </svg>
                      </el-icon>
                    </el-button>
                  </el-tooltip>
                  
                  <div class="mcp-server-tags">
                    <el-tag v-if="server.type" type="info" size="small" effect="plain" round>{{
                      getDisplayTypeName(server.type) }}</el-tag>
                    <el-tag v-for="tag in (server.tags || []).slice(0, 2)" :key="tag" size="small" effect="plain" round>{{
                      tag
                    }}</el-tag>
                  </div>
                </div>
              </div>

              <!-- ç¬¬äºŒè¡Œï¼šæŠ˜å æŒ‰é’® | æè¿° -->
              <div class="mcp-server-body-row">
                <div class="mcp-tools-toggle" @click.stop="toggleMcpServerExpansion(server.id)">
                  <el-icon :class="{ 'is-expanded': expandedMcpServers.has(server.id) }">
                    <CaretRight />
                  </el-icon>
                  <span>{{ expandedMcpServers.has(server.id) ? 'æ”¶èµ·' : 'å·¥å…·' }}</span>
                </div>

                <span v-if="server.description" class="mcp-server-description" @click.stop="toggleMcpServerExpansion(server.id)">{{ server.description }}</span>
              </div>
            </div>
          </div>

          <!-- æŠ˜å çš„å·¥å…·åˆ—è¡¨åŒºåŸŸ (ä¿æŒä¸å˜) -->
          <div v-if="expandedMcpServers.has(server.id)" class="mcp-tools-panel" @click.stop>
            <template v-if="mcpToolCache[server.id] && mcpToolCache[server.id].length > 0">
              <div v-for="tool in mcpToolCache[server.id]" :key="tool.name" class="mcp-tool-row">
                <el-switch :model-value="tool.enabled !== false" size="small"
                  @change="(val) => handleMcpToolStatusChange(server.id, tool.name, val)" />
                <div class="mcp-tool-info">
                  <span class="mcp-tool-name">{{ tool.name }}</span>
                  <span class="mcp-tool-desc" :title="tool.description">{{ tool.description || 'æš‚æ— æè¿°' }}</span>
                </div>
              </div>
            </template>
            <div v-else class="mcp-tools-empty">
              å·¥å…·æœªç¼“å­˜ï¼Œä½¿ç”¨/æµ‹è¯•åå³å¯æŸ¥çœ‹å…·ä½“å·¥å…·
            </div>
          </div>
        </div>
      </div>
      <div class="mcp-dialog-footer-search">
        <el-input v-model="mcpSearchQuery" placeholder="æœç´¢å·¥å…·åç§°æˆ–æè¿°..." :prefix-icon="Search" clearable />
      </div>
    </div>
    <template #footer>
      <div class="mcp-dialog-footer">
        <div class="footer-left-controls"> <!-- ä½¿ç”¨æ–°å®¹å™¨åŒ…è£¹å·¦ä¾§å†…å®¹ -->
          <span class="mcp-limit-hint" :class="{ 'warning': mcpConnectionCount > 5 }">
            è¿æ¥æ•°ï¼š{{ 5 - mcpConnectionCount }}/5
            <el-tooltip placement="top">
              <template #content>
                æŒä¹…è¿æ¥å„å 1ä¸ªåé¢<br>
                æ‰€æœ‰ä¸´æ—¶è¿æ¥å…±å 1ä¸ªåé¢
              </template>
              <el-icon style="vertical-align: middle; margin-left: 4px; cursor: help;">
                <QuestionFilled />
              </el-icon>
            </el-tooltip>
          </span>
          <el-checkbox v-model="isAutoApproveTools" label="è‡ªåŠ¨æ‰¹å‡†å·¥å…·è°ƒç”¨" style="margin-left: 40px; margin-right: 0;" />
        </div>
        <div>
          <el-button type="primary"
            @click="sessionMcpServerIds = [...tempSessionMcpServerIds]; applyMcpTools();">åº”ç”¨</el-button>
        </div>
      </div>
    </template>
  </el-dialog>
</template>

<style>
html,
body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-color: transparent;
}

:root {
  /* æµ…è‰²æ¨¡å¼å˜é‡ */
  --el-bg-color: #FFFFFD !important;
  --el-bg-color-userbubble: #F5F4ED;
  --el-fill-color: #F0F2F5 !important;
  --el-fill-color-light: #F6F6F6 !important;
  --el-bg-color-input: #F6F6F6 !important;
  /* æ˜ç¡®æŒ‡å®šæµ…è‰²è¾“å…¥æ¡†èƒŒæ™¯ */
  --el-fill-color-blank: var(--el-fill-color-light) !important;

  --text-primary: #000000;
  --el-text-color-primary: var(--text-primary);
}

html.dark {
  /* æ·±è‰²æ¨¡å¼å˜é‡å¼ºåˆ¶è¦†ç›– */
  --el-bg-color: #212121 !important;
  --el-bg-color-userbubble: #2F2F2F;
  --el-fill-color: #424242 !important;
  --el-fill-color-light: #2c2e33 !important;
  --el-bg-color-input: #303030 !important;
  --el-fill-color-blank: #212121 !important;

  --text-primary: #ECECF1 !important;
  --el-text-color-primary: #ECECF1 !important;
}

.el-dialog {
  border-radius: 8px !important;
  overflow: hidden;
  background-color: var(--el-bg-color) !important;
}

html.dark .el-dialog {
  background-color: var(--el-bg-color) !important;
}

.el-message-box {
  border-radius: 8px !important;
  overflow: hidden;
}

.el-dialog__header {
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
  padding-bottom: 0 !important;
}

.el-dialog__footer {
  padding-top: 4px !important;
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
}

.mcp-dialog {
  border-radius: 8px !important;
}

.model-dialog {
  border-radius: 8px !important;
}

.el-dialog__body {
  padding-top: 10px !important;
  padding-bottom: 10px !important;
}

/* Save Options Dialog */
.save-options-dialog.el-dialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  margin: 0 !important;
}

.save-options-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
  padding: 10px 0 0 20px;
  margin: 0;
}

.save-option-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px 20px;
  border: 1px solid var(--el-border-color-lighter);
  border-radius: var(--el-border-radius-base);
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.save-option-item:hover {
  transform: scale(1.02);
  border-color: var(--el-color-primary);
  box-shadow: var(--el-box-shadow-light);
}

.save-option-text {
  flex-grow: 1;
  margin-right: 20px;
}

.save-option-text h4 {
  margin: 0;
  font-size: 15px;
  font-weight: 600;
  color: var(--el-text-color-primary);
}

.save-option-text p {
  margin: 4px 0 0 0;
  font-size: 12px;
  color: var(--el-text-color-secondary);
}

html.dark .save-option-item {
  border-color: var(--el-border-color-dark);
}

html.dark .save-option-item:hover {
  border-color: var(--el-color-primary);
  background-color: var(--el-fill-color-dark);
}

html.dark .save-option-text p {
  color: var(--el-text-color-regular);
}

/* System Prompt Dialog */
.system-prompt-dialog .el-dialog__header {
  padding: 15px 20px;
  margin-right: 0;
  border-bottom: 1px solid var(--el-border-color-lighter);
}

html.dark .system-prompt-dialog .el-dialog__header {
  border-bottom-color: var(--el-border-color-dark);
}

.system-prompt-dialog .el-dialog__title {
  color: var(--el-text-color-primary);
}

.system-prompt-dialog .el-dialog__body {
  padding: 20px;
}

.system-prompt-dialog {
  background-color: var(--el-bg-color-overlay) !important;
  border-radius: 12px !important;
  box-shadow: var(--el-box-shadow-light);
}

.system-prompt-dialog .el-dialog__headerbtn .el-icon {
  color: var(--el-text-color-regular);
}

.system-prompt-dialog .el-dialog__headerbtn .el-icon:hover {
  color: var(--el-color-primary);
}

html.dark .system-prompt-dialog {
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.system-prompt-full-content {
  font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
  white-space: pre-wrap;
  word-wrap: break-word;
  font-size: 14px;
  line-height: 1.6;
  color: var(--el-text-color-primary);
  width: 100%;
}

.system-prompt-full-content .el-textarea__inner {
  box-shadow: none !important;
  background-color: var(--el-fill-color-light) !important;
  max-height: 60vh;
}

html.dark .system-prompt-full-content .el-textarea__inner {
  background-color: var(--el-fill-color-dark) !important;
}

/* Filename Prompt Dialog */
.filename-prompt-dialog.el-dialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  margin: 0 !important;
  max-width: 600px;
  width: 90%;
}

.filename-prompt-dialog .el-message-box__content {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-bottom: 20px;
}

.filename-prompt-dialog .el-input {
  width: 100%;
  max-width: 520px;
}

.filename-prompt-dialog .el-input__wrapper {
  height: 44px;
  font-size: 16px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

.filename-prompt-dialog .el-input-group__append {
  height: 44px;
  display: flex;
  align-items: center;
  font-size: 16px;
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  color: var(--el-text-color-placeholder);
  background-color: var(--el-fill-color-light);
}

html.dark .filename-prompt-dialog .el-input-group__append {
  background-color: var(--el-bg-color);
  color: var(--el-text-color-placeholder);
  border-color: var(--el-border-color);
}

/* Custom Viewer Actions */
.custom-viewer-actions {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2100;
  padding: 6px 12px;
  background-color: rgba(0, 0, 0, 0.45);
  border-radius: 22px;
  display: flex;
  gap: 16px;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.custom-viewer-actions .el-button {
  background-color: transparent;
  border: none;
  color: white;
  font-size: 16px;
}

.custom-viewer-actions .el-button:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

.elx-run-code-drawer .elx-run-code-content-view-iframe {
  height: 100% !important;
}

.system-prompt-full-content .el-textarea__inner::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.system-prompt-full-content .el-textarea__inner::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 4px;
}

.system-prompt-full-content .el-textarea__inner::-webkit-scrollbar-thumb {
  background: var(--el-text-color-disabled, #c0c4cc);
  border-radius: 4px;
  border: 2px solid transparent;
  background-clip: content-box;
}

.system-prompt-full-content .el-textarea__inner::-webkit-scrollbar-thumb:hover {
  background: var(--el-text-color-secondary, #909399);
  background-clip: content-box;
}

html.dark .system-prompt-full-content .el-textarea__inner::-webkit-scrollbar-thumb {
  background: #6b6b6b;
  background-clip: content-box;
}

html.dark .system-prompt-full-content .el-textarea__inner::-webkit-scrollbar-thumb:hover {
  background: #999;
}

/* MCP Dialog Styles */
.mcp-dialog .mcp-dialog-content p {
  margin-top: 0;
  margin-bottom: 15px;
  color: var(--el-text-color-secondary);
  padding: 0 5px;
  flex-shrink: 0;
}

.mcp-server-header-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 0px;
}

.mcp-header-right-group {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 4px;
  flex-shrink: 0;
}

.mcp-server-icon {
  flex-shrink: 0;
  background-color: var(--el-fill-color-light);
  /* é€‚é…æ·±/æµ…è‰²æ¨¡å¼çš„èƒŒæ™¯ */
  color: var(--el-text-color-secondary);
}

html.dark .mcp-server-icon {
  background-color: var(--el-fill-color);
}

.mcp-server-name {
  font-weight: 600;
  color: var(--el-text-color-primary);
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: inline-flex; 
  align-items: center;
}

.mcp-tool-count {
  font-size: 12px;
  color: var(--el-text-color-secondary);
  margin-left: 6px;
  font-weight: normal;
  opacity: 0.8;
}

.mcp-server-tags {
  display: flex;
  flex-wrap: nowrap;
  gap: 4px;
  flex-shrink: 0;
  margin-left: auto;
}

.mcp-server-tags .el-tag {
  padding-top:0px;
  padding-bottom:2px;
  padding-left: 8px;
  padding-right: 8px;

}

.mcp-server-description {
  font-size: 12px;
  color: var(--el-text-color-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: block;
}

.mcp-dialog-footer-search {
  flex-shrink: 0;
  padding: 10px 4px 0 4px;
  margin-top: 10px;
  border-top: 1px solid var(--el-border-color-lighter);
}

html.dark .mcp-dialog-footer-search {
  border-top-color: var(--el-border-color-darker);
}

.mcp-dialog .mcp-dialog-content {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  overflow: hidden;
  padding: 0 10px;
}

.mcp-dialog-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  flex-shrink: 0;
  padding: 0 5px;
}

.mcp-server-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 35vh;
  overflow-y: auto;
  padding: 5px;
}

.mcp-server-item-wrapper {
  display: flex;
  flex-direction: column;
  border: 1px solid var(--el-border-color-lighter);
  border-radius: 8px;
  overflow: hidden;
  transition: border-color 0.2s;
  flex-shrink: 0;
  min-height: min-content;
  background-color: var(--el-bg-color);
}

.mcp-server-item-wrapper:hover {
  border-color: var(--el-color-primary);
  background-color: var(--el-fill-color-light);
}

/* ä¸»å¡ç‰‡åŒºåŸŸ */
.mcp-server-item {
  display: flex;
  flex-direction: column;
  padding: 0px 8px 4px 8px;
  border: none;
  border-radius: 0;
  cursor: pointer;
  transition: background-color 0.2s;
  border-bottom: 1px solid transparent;
  width: 100%;
  box-sizing: border-box;
}

.mcp-server-item-wrapper:hover .mcp-server-item {
  background-color: transparent;
}

.mcp-server-item.is-checked {
  background-color: var(--el-color-primary-light-9);
}

.mcp-server-content {
  display: flex;
  flex-direction: column;
  gap: 6px;
  width: 100%;
}

/* ç¬¬ä¸€è¡Œï¼šHeader */
.mcp-server-header-row {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.header-checkbox {
  margin-right: 4px;
}

.mcp-server-name {
  font-weight: 600;
  color: var(--el-text-color-primary);
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ç¬¬äºŒè¡Œï¼šBody (Toggle + Description) */
.mcp-server-body-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding-left: 2px;
  /* å¾®è°ƒä»¥å¯¹é½ä¸Šæ–¹è§†è§‰ */
}

/* æŠ˜å æŒ‰é’® */
.mcp-tools-toggle {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: var(--el-text-color-secondary);
  cursor: pointer;
  user-select: none;
  flex-shrink: 0;
  padding: 2px 6px;
  background-color: var(--el-fill-color-lighter);
  border-radius: 4px;
  transition: all 0.2s;
}

.mcp-tools-toggle:hover {
  color: var(--el-color-primary);
  background-color: var(--el-fill-color);
}

.mcp-tools-toggle .el-icon {
  transition: transform 0.2s;
  font-size: 10px;
}

.mcp-tools-toggle .el-icon.is-expanded {
  transform: rotate(90deg);
}

/* æè¿°æ–‡æœ¬ */
.mcp-server-description {
  font-size: 12px;
  color: var(--el-text-color-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  opacity: 0.8;
  flex: 1;
  min-width: 0;
  line-height: 1.5;
}

/* å·¥å…·åˆ—è¡¨é¢æ¿ */
.mcp-tools-panel {
  background-color: var(--el-fill-color-lighter);
  padding: 0px 8px 4px 8px;
  display: flex;
  flex-direction: column;
  gap: 0px;
  font-size: 12px;
  animation: expand-tools 0.2s ease-out;
  border-top: 1px solid var(--el-border-color-lighter);
}

.mcp-server-item-wrapper:has(.mcp-tools-panel) .mcp-server-item {
  border-bottom-color: var(--el-border-color-lighter);
}

@keyframes expand-tools {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.mcp-tool-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 4px;
  border-bottom: 1px dashed var(--el-border-color-lighter);
}

.mcp-tool-row:last-child {
  border-bottom: none;
}

.mcp-tool-info {
  display: flex;
  flex-direction: column;
  min-width: 0;
  flex: 1;
  line-height: 1.4;
}

.mcp-tool-name {
  font-weight: 500;
  color: var(--el-text-color-primary);
  font-size: 13px;
}

.mcp-tool-desc {
  color: var(--el-text-color-secondary);
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  opacity: 0.8;
}

.mcp-tools-empty {
  color: var(--el-text-color-placeholder);
  text-align: center;
  padding: 15px 0;
  font-style: italic;
  font-size: 12px;
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
html.dark .mcp-server-item-wrapper {
  border-color: var(--el-border-color-lighter);
  background-color: var(--el-bg-color);
}

html.dark .mcp-server-item-wrapper:hover {
  background-color: var(--el-fill-color-darker);
  border-color: var(--el-border-color);
}

html.dark .mcp-server-item.is-checked {
  background-color: var(--el-fill-color-dark);
}

html.dark .mcp-tools-toggle {
  background-color: var(--el-fill-color-dark);
}

html.dark .mcp-tools-toggle:hover {
  background-color: var(--el-fill-color);
}

html.dark .mcp-server-item-wrapper:has(.mcp-tools-panel) .mcp-server-item {
  border-bottom-color: var(--el-border-color-lighter);
}

html.dark .mcp-tools-panel {
  background-color: var(--el-fill-color-dark);
  border-top-color: var(--el-border-color-lighter);
}

html.dark .mcp-tool-row {
  border-bottom-color: var(--el-border-color-lighter);
}

html.dark .mcp-tool-row .el-switch {
  --el-switch-off-color: #181818;
  --el-switch-border-color: #4C4D4F;
}

html.dark .mcp-tool-row .el-switch .el-switch__core .el-switch__action {
  background-color: #E5EAF3; 
}

html.dark .mcp-tool-row .el-switch.is-checked .el-switch__core {
  background-color: #E5EAF3;
  border-color: #E5EAF3;
}

html.dark .mcp-tool-row .el-switch.is-checked .el-switch__core .el-switch__action {
  background-color: #141414; 
}

html.dark .mcp-server-list .el-checkbox__input.is-checked .el-checkbox__inner,
html.dark .mcp-dialog-footer .el-checkbox__input.is-checked .el-checkbox__inner {
  background-color: #fff !important;
  border-color: #fff !important;
}

html.dark .mcp-server-list .el-checkbox__input.is-checked .el-checkbox__inner::after,
html.dark .mcp-dialog-footer .el-checkbox__input.is-checked .el-checkbox__inner::after {
  border-color: #1d1d1d !important;
}

.no-header-dialog .el-dialog__header {
  display: none !important;
  padding: 0 !important;
}

.no-header-dialog .el-dialog__body {
  padding-top: 10px !important;
}

.no-header-msgbox .el-message-box__header {
  display: none !important;
}

.no-header-msgbox .el-message-box__content {
  padding-top: 10px !important;
}
</style>

<style scoped lang="less">
.app-container {
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  background-color: var(--el-bg-color);
  color: var(--el-text-color-primary);
  font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  box-sizing: border-box;
  border-radius: 8px;
  position: relative;
  z-index: 1;
}

html.dark .app-container {
  background-color: var(--el-bg-color);
}

.main-area-wrapper {
  position: relative;
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chat-main {
  flex-grow: 1;
  padding: 0 10px;
  margin: 0;
  overflow-y: auto;
  scroll-behavior: auto !important;
  background-color: transparent !important;
  scrollbar-gutter: stable;
  will-change: scroll-position;
  transform: translateZ(0);
}

.scroll-to-bottom-wrapper {
  position: absolute;
  bottom: 110px;
  right: 0.5%;
  z-index: 20;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0px;
}

.scroll-nav-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background-color: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  box-shadow: var(--shadow-md);
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  margin: 0px !important;

  &:hover {
    background-color: var(--bg-tertiary);
    color: var(--text-accent);
    transform: scale(1.1);
  }
}

html.dark .scroll-nav-btn {
  background-color: var(--bg-tertiary);
  border-color: var(--border-primary);
  color: var(--text-primary);

  &:hover {
    background-color: var(--bg-secondary);
  }
}

.custom-scrollbar::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: var(--el-text-color-disabled, #c0c4cc);
  border-radius: 4px;
  border: 2px solid transparent;
  background-clip: content-box;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: var(--el-text-color-secondary, #909399);
}

html.dark .custom-scrollbar::-webkit-scrollbar-thumb {
  background: #6b6b6b;
  background-clip: content-box;
}

html.dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: #999;
  background-clip: content-box;
}

.mcp-dialog-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.mcp-limit-hint {
  font-size: 12px;
  color: var(--el-color-warning);
}

.mcp-limit-hint.warning {
  color: var(--el-color-danger);
  font-weight: bold;
}

.footer-left-controls {
  display: flex;
  align-items: center;
}

:deep(.image-error-container) {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 15px;
  border: 1px dashed var(--el-border-color);
  border-radius: 8px;
  background-color: var(--el-fill-color-light);
  color: var(--el-text-color-secondary);
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
}

:deep(.image-error-container:hover) {
  border-color: var(--el-color-primary);
  color: var(--el-color-primary);
  background-color: var(--el-color-primary-light-9);
}

:deep(.image-error-container svg) {
  width: 24px;
  height: 24px;
  flex-shrink: 0;
}

.persistent-btn {
  color: var(--el-text-color-secondary);
  width: 28px;
  height: 28px;
}

.persistent-btn:hover {
  color: var(--el-color-primary);
  background-color: var(--el-color-primary-light-9);
}

html.dark .persistent-btn:hover {
  background-color: var(--el-fill-color-darker);
}

.persistent-btn.is-persistent-active {
  color: #67C23A;
}

.persistent-btn.is-persistent-active:hover {
  background-color: rgba(103, 194, 58, 0.1);
}

.window-bg-base {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 0;
  background-color: var(--el-bg-color);
  transition: background-color 0.3s ease;
  pointer-events: none;
  will-change: background-color;
}

.window-bg-layer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 0;
  background-position: center;
  background-size: cover;
  background-repeat: no-repeat;
  pointer-events: none;
  will-change: transform, opacity;
  transform: translateZ(0);

  /* æ ¸å¿ƒä¼˜åŒ–ï¼šé»˜è®¤é€æ˜ï¼Œä¸”å…·æœ‰è¿‡æ¸¡æ•ˆæœ */
  opacity: 0;
  transition: opacity 0.4s ease-in-out, filter 0.3s ease;
}

.app-container.has-bg,
html.dark .app-container.has-bg,
body .app-container.has-bg {
  background-color: transparent !important;
  background: none !important;
}

.app-container.has-bg :deep(.title-bar),
.app-container.has-bg :deep(.model-header),
.app-container.has-bg :deep(.input-footer) {
  background-color: transparent !important;
}

.app-container.has-bg :deep(.chat-input-area-vertical) {
  background-color: rgba(255, 255, 255, 0.45) !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  // border: 1px solid rgba(255, 255, 255, 0.5);
  // box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.app-container.has-bg :deep(.chat-input-area-vertical .el-textarea__inner) {
  background-color: transparent !important;
}

html.dark .app-container.has-bg :deep(.chat-input-area-vertical) {
  background-color: rgba(30, 30, 30, 0.45) !important;
  // border: 1px solid rgba(255, 255, 255, 0.1);
  // box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
}

html.dark .app-container.has-bg :deep(.title-bar) {

  /* å¼ºåˆ¶åŠŸèƒ½æŒ‰é’®ï¼ˆPin, Topï¼‰å’Œ Macçº¢ç»¿ç¯å›¾æ ‡å˜äº® */
  .func-btn,
  .traffic-icon {
    color: rgba(255, 255, 255, 0.9) !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
    /* å¢åŠ æ–‡å­—é˜´å½±æé«˜å¯¹æ¯”åº¦ */
  }

  .func-btn:hover {
    background-color: rgba(255, 255, 255, 0.15);
  }

  /* å¼ºåˆ¶ Windows/Linux çª—å£æ§åˆ¶æŒ‰é’®å˜äº® */
  .win-btn,
  .linux-btn {
    color: rgba(255, 255, 255, 0.9) !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
  }

  .win-btn:hover,
  .linux-btn:hover {
    background-color: rgba(255, 255, 255, 0.15);
  }

  /* Windows å…³é—­æŒ‰é’®æ‚¬æµ®ä»ä¿æŒçº¢è‰² */
  .win-btn.close:hover {
    background-color: #E81123 !important;
    color: white !important;
  }

  /* Linux å…³é—­æŒ‰é’®æ‚¬æµ®ä»ä¿æŒçº¢è‰² */
  .linux-btn.close:hover {
    background-color: #E95420 !important;
    color: white !important;
  }

  /* æ ‡é¢˜å’Œæ–‡å­—é¢œè‰²å¢å¼º */
  .app-title,
  .conversation-title,
  .download-icon {
    color: rgba(255, 255, 255, 0.95);
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
  }

  .app-info-inner:hover,
  .conversation-inner:hover {
    background-color: rgba(255, 255, 255, 0.15);
  }

  .divider-vertical {
    background-color: rgba(255, 255, 255, 0.3);
  }
}

.app-container.has-bg :deep(.el-dialog),
.app-container.has-bg :deep(.el-message-box) {
  background-color: rgba(255, 255, 255, 0.9) !important;
  backdrop-filter: none !important;
  border: 1px solid rgba(255, 255, 255, 0.5);
  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
}

.app-container.has-bg :deep(.el-dialog__header),
.app-container.has-bg :deep(.el-dialog__body),
.app-container.has-bg :deep(.el-dialog__footer),
.app-container.has-bg :deep(.el-message-box__header),
.app-container.has-bg :deep(.el-message-box__content),
.app-container.has-bg :deep(.el-message-box__btns) {
  background-color: transparent !important;
}

html.dark .app-container.has-bg :deep(.el-dialog),
html.dark .app-container.has-bg :deep(.el-message-box) {
  background-color: rgba(40, 40, 40, 0.9) !important;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

/* å¼¹çª—å†…è¾“å…¥æ¡† */
.app-container.has-bg :deep(.el-dialog .el-textarea__inner),
.app-container.has-bg :deep(.el-dialog .el-input__wrapper) {
  background-color: rgba(240, 240, 240, 0.45) !important;
  backdrop-filter: none !important;
}

html.dark .app-container.has-bg :deep(.el-dialog .el-textarea__inner),
html.dark .app-container.has-bg :deep(.el-dialog .el-input__wrapper) {
  background-color: rgba(20, 20, 20, 0.45) !important;
}

.app-container.has-bg :deep(.option-selector-wrapper),
.app-container.has-bg :deep(.waveform-display-area) {
  background-color: rgba(255, 255, 255, 0.45) !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  border: 1px solid rgba(255, 255, 255, 0.5);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

html.dark .app-container.has-bg :deep(.option-selector-wrapper),
html.dark .app-container.has-bg :deep(.waveform-display-area) {
  background-color: rgba(30, 30, 30, 0.45) !important;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
}

.app-container.has-bg :deep(.option-selector-wrapper .el-scrollbar__view) {
  /* ç¡®ä¿æ»šåŠ¨å†…å®¹åŒºåŸŸèƒŒæ™¯é€æ˜ï¼Œç»§æ‰¿çˆ¶çº§ */
  background-color: transparent !important; 
}

.app-container.has-bg :deep(.recording-status-text) {
  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
}
html.dark .app-container.has-bg :deep(.recording-status-text) {
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

/* æ¨¡å‹é€‰æ‹©è¯ä¸¸ */
.app-container.has-bg :deep(.model-pill) {
  background-color: rgba(255, 255, 255, 0.6);
  backdrop-filter: none !important;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.app-container.has-bg :deep(.model-pill:hover) {
  background-color: #fff;
}

html.dark .app-container.has-bg :deep(.model-pill) {
  background-color: rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

html.dark .app-container.has-bg :deep(.model-pill:hover) {
  background-color: rgba(0, 0, 0, 0.7);
}

.app-container.has-bg :deep(.user-bubble .el-bubble-content) {
  background-color: rgba(245, 244, 237, 0.7) !important;
  /* ç”¨æˆ·æŒ‡å®š */
  backdrop-filter: none !important;
  border: 1px solid rgba(255, 255, 255, 0.45);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

/* AI æ°”æ³¡ */
.app-container.has-bg :deep(.ai-bubble .el-bubble-content) {
  background-color: rgba(255, 255, 255, 0.45) !important;
  /* ç”¨æˆ·æŒ‡å®š */
  backdrop-filter: none !important;
  border: 1px solid rgba(255, 255, 255, 0.45);
  /* ç”¨æˆ·æŒ‡å®š Padding */
  padding: 10px !important;
}

/* æ·±è‰²æ¨¡å¼æ°”æ³¡ */
html.dark .app-container.has-bg :deep(.user-bubble .el-bubble-content) {
  background-color: rgba(47, 47, 47, 0.7) !important;
  border-color: rgba(255, 255, 255, 0.1);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

html.dark .app-container.has-bg :deep(.ai-bubble .el-bubble-content) {
  background-color: rgba(33, 33, 33, 0.45) !important;
  border-color: rgba(255, 255, 255, 0.1);
}

/* åŠŸèƒ½æŒ‰é’® */
.app-container.has-bg :deep(.footer-actions .el-button.is-circle) {
  background-color: rgba(255, 255, 255, 0.6);
  backdrop-filter: none !important;
}

.app-container.has-bg :deep(.footer-actions .el-button.is-circle:hover) {
  background-color: #fff;
}

html.dark .app-container.has-bg :deep(.footer-actions .el-button.is-circle) {
  background-color: rgba(0, 0, 0, 0.5);
  color: #e0e0e0;
}

html.dark .app-container.has-bg :deep(.footer-actions .el-button.is-circle:hover) {
  background-color: rgba(60, 60, 60, 1);
}

/* æ€è€ƒæ¨¡å¼ */
.app-container.has-bg :deep(.el-thinking .trigger) {
  background-color: rgba(255, 255, 255, 0.7) !important;
  backdrop-filter: none !important;
}

.app-container.has-bg :deep(.el-thinking .content pre) {
  background-color: rgba(255, 255, 255, 0.3) !important;
}

html.dark .app-container.has-bg :deep(.el-thinking .trigger) {
  background-color: rgba(44, 46, 51, 0.7) !important;
}

html.dark .app-container.has-bg :deep(.el-thinking .content pre) {
  background-color: rgba(0, 0, 0, 0.3) !important;
}

.app-container.has-bg :deep(.tool-collapse .el-collapse-item__header) {
  background-color: rgba(255, 255, 255, 0.45) !important;
  backdrop-filter: none !important;
  border-color: rgba(255, 255, 255, 0.2);
}

.app-container.has-bg :deep(.tool-collapse .el-collapse-item__wrap) {
  background-color: transparent !important;
  border-color: rgba(255, 255, 255, 0.2);
}

.app-container.has-bg :deep(.tool-call-details .tool-detail-section pre) {
  background-color: rgba(255, 255, 255, 0.7) !important;
}

html.dark .app-container.has-bg :deep(.tool-collapse .el-collapse-item__header) {
  background-color: rgba(0, 0, 0, 0.7) !important;
  border-color: rgba(255, 255, 255, 0.1);
}

html.dark .app-container.has-bg :deep(.tool-collapse .el-collapse-item__wrap) {
  border-color: rgba(255, 255, 255, 0.1);
}

html.dark .app-container.has-bg :deep(.tool-call-details .tool-detail-section pre) {
  background-color: rgba(0, 0, 0, 0.5) !important;
  border-color: rgba(255, 255, 255, 0.05);
}
</style>
```
```vue
./Anywhere_window/src/components/ChatHeader.vue
<script setup>
import { computed } from 'vue';
import { ElHeader, ElIcon, ElTooltip } from 'element-plus';
import { Loading, Edit, Search } from '@element-plus/icons-vue'; // å¼•å…¥ Search

const props = defineProps({
  modelMap: Object,
  model: String,
  isMcpLoading: Boolean,
  systemPrompt: String,
});

const emit = defineEmits([
  'open-model-dialog',
  'show-system-prompt',
  'open-search' // æ–°å¢äº‹ä»¶
]);

// 1. å­—ç¬¦ä¸²è½¬é¢œè‰²å‡½æ•° (HSL æ¨¡å¼)
const stringToColor = (str) => {
  if (!str) return '#3b82f6';
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  const h = Math.abs(hash) % 360;
  const s = 60 + (Math.abs(hash) % 20); 
  const l = 50 + (Math.abs(hash) % 10);
  return `hsl(${h}, ${s}%, ${l}%)`;
};

// 2. è®¡ç®—å½“å‰ Logo é¢œè‰²
const logoColor = computed(() => {
  const seed = props.model ? (props.model.split("|")[1] || 'default') : 'default';
  return stringToColor(seed);
});
</script>

<template>
  <el-header class="model-header">
    <div class="model-header-wrapper">
      
      <div class="header-content-group">
        
        <!-- 1. æ¨¡å‹é€‰æ‹©å™¨ -->
        <div 
          class="model-pill expandable-pill" 
          :class="{ 'is-disabled': isMcpLoading, 'is-loading': isMcpLoading }" 
          @click="!isMcpLoading && emit('open-model-dialog')"
        >
          <!-- Logo -->
          <div class="model-logo-container" :style="{ color: isMcpLoading ? '#F59E0B' : logoColor }">
            <svg class="model-logo" width="18" height="18" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g clip-path="url(#clip0_11482_204655)">
                <path d="M24.9439 24.7319C25.824 27.2847 25.4279 29.2944 23.7589 30.7231C22.2911 31.9822 19.8552 32.4878 18.3842 31.2946C16.8252 30.0291 15.9012 30.1076 14.3202 31.2914C12.7769 32.4438 10.8062 32.1141 9.19691 30.8926C7.59392 29.6743 7.04073 28.0069 7.33304 26.0413C7.39276 25.6425 7.7165 25.2908 7.5562 24.7633C6.48126 25.0396 5.45346 25.564 4.29051 25.3599C2.38579 25.0239 1.01225 24.0128 0.333338 22.1948C-0.370719 20.3076 0.0724596 18.6088 1.38942 17.1142C1.75717 16.6966 2.3795 16.4642 1.64087 15.6698C-0.226136 13.6602 -0.465012 11.5218 0.732513 9.54359C1.93004 7.56224 4.08621 6.84317 6.77043 7.53084C6.91815 7.62504 7.06588 7.71924 7.21046 7.8103C7.34562 7.55596 7.30161 7.34244 7.05645 7.17915C5.67662 3.03432 8.04024 -0.356908 12.0414 0.0324552C13.2515 0.148636 14.2196 0.732681 15.0462 1.57107C15.4266 1.95729 15.7126 2.19907 16.1683 1.65585C17.9442 -0.454249 20.9679 -0.259567 22.4577 0.713841C24.4316 2.00125 25.0162 3.81305 24.353 6.92167C24.3467 6.95307 24.4158 7.00017 24.5039 7.11007C25.3902 6.85259 26.286 6.41299 27.2824 6.49463C29.2782 6.65477 30.7649 7.58422 31.5664 9.43683C32.3899 11.3491 32.0159 13.0981 30.6958 14.6932C30.3815 15.0732 29.426 15.3401 30.3092 16.1157C32.4622 17.9965 32.2642 20.7849 31.2427 22.3769C29.9949 24.3206 28.1404 24.9674 25.3179 24.3928C25.1105 24.2107 24.8873 24.1541 24.639 24.3017C24.7427 24.4462 24.8465 24.5906 24.9502 24.7319H24.9439ZM2.46122 12.2315C2.45179 12.9694 2.87297 13.5974 3.44816 14.1657C4.96942 15.6666 6.46555 17.1896 7.98995 18.6873C8.91717 19.5948 9.87582 21.1554 10.8219 21.1585C11.7491 21.1585 12.6763 19.554 13.6067 18.6559C13.6821 18.5837 13.7513 18.5052 13.833 18.4393C14.295 18.0813 14.1504 17.783 13.7921 17.4282C11.3845 15.0481 9.01146 12.6334 6.58498 10.2721C5.80864 9.51533 4.8217 9.38031 3.83476 9.86702C2.91383 10.316 2.44236 11.0853 2.46122 12.2346V12.2315ZM12.1609 29.5267C12.9781 29.4671 13.5784 29.0997 14.1127 28.5596C15.6529 27.0053 17.2118 25.4667 18.7645 23.9249C20.6986 22.0011 20.6755 20.1213 18.6954 18.2854C18.62 18.2163 18.5477 18.1378 18.4817 18.0593C18.1925 17.7139 17.9316 17.7014 17.5984 18.0405C15.1468 20.5243 12.6606 22.9766 10.2341 25.4855C9.51436 26.2297 9.53322 27.2094 9.94811 28.1231C10.3787 29.0683 11.2022 29.4671 12.164 29.5299L12.1609 29.5267ZM21.0999 10.2156C20.1224 11.2926 19.2454 12.3257 18.2962 13.2865C17.8185 13.7701 17.8216 14.0715 18.3056 14.5457C20.6504 16.8442 22.9354 19.2023 25.2959 21.482C26.4589 22.6061 27.9204 22.5496 28.9168 21.4883C29.8377 20.5054 29.8283 19.0453 28.7879 17.9777C26.3174 15.4406 23.8092 12.9411 21.0999 10.2124V10.2156ZM22.3445 4.88066C22.3445 3.83189 21.8165 3.06258 20.927 2.62612C19.8866 2.11743 18.8934 2.35293 18.0668 3.1662C16.4355 4.77703 14.8105 6.39101 13.1949 8.01754C10.2907 10.9378 10.3127 10.9252 13.3741 13.6853C13.8927 14.1532 14.1284 14.1155 14.5905 13.6445C16.8504 11.3397 19.1511 9.07259 21.4393 6.79607C21.9737 6.26541 22.3382 5.65938 22.3445 4.88066ZM8.91717 4.83983C8.99575 5.81952 9.4075 6.66733 10.2058 7.07239C10.9979 7.47432 11.2399 6.46323 11.7083 6.08328C12.3494 5.56204 12.8932 4.92148 13.4904 4.34371C13.723 4.11763 13.9744 3.91667 13.6601 3.58382C12.8806 2.76114 12.0383 2.11429 10.7936 2.4754C9.58351 2.82708 9.05547 3.70001 8.91717 4.83983ZM27.1535 8.87791C26.0691 8.91873 25.2645 9.41799 24.859 10.1873C24.5039 10.8624 25.4374 11.1387 25.802 11.5752C26.33 12.2095 26.9523 12.7684 27.5558 13.3367C27.779 13.5471 27.9456 14.0181 28.4076 13.5754C29.2374 12.7778 29.8629 11.8986 29.4763 10.696C29.1054 9.54987 28.2693 8.92187 27.1535 8.88105V8.87791ZM4.46338 22.9766C5.9155 22.9986 6.72642 22.4962 7.13188 21.7332C7.53735 20.9701 6.51269 20.7127 6.13238 20.2354C5.62005 19.5885 4.97257 19.0516 4.40052 18.455C4.11136 18.1535 3.87248 18.0531 3.50788 18.3828C2.61209 19.1866 2.20034 20.1569 2.58066 21.3061C2.93898 22.3926 3.7719 22.9546 4.46338 22.9766ZM23.036 27.0649C23.0989 26.0036 22.5331 25.1778 21.7128 24.7633C21.1062 24.4556 20.7856 25.3725 20.3487 25.743C19.7169 26.2768 19.1731 26.9079 18.5822 27.492C18.3151 27.7557 18.0322 27.9881 18.4188 28.3869C19.1763 29.1656 20.0124 29.7528 21.1627 29.4325C22.3445 29.1028 22.9669 28.2895 23.0392 27.0681L23.036 27.0649Z" fill="currentColor"></path>
              </g>
              <defs>
                <clipPath id="clip0_11482_204655">
                  <rect width="32" height="32" fill="white"></rect>
                </clipPath>
              </defs>
            </svg>
          </div>
          
          <!-- éšè—å†…å®¹ï¼Œhover æ—¶æ˜¾ç¤º -->
          <div class="expandable-content">
            <span class="model-text">
              {{ isMcpLoading ? 'MCPå·¥å…·åŠ è½½ä¸­...' : (modelMap[model] || model || 'é€‰æ‹©æ¨¡å‹') }}
            </span>
            
            <el-icon class="arrow-icon" :size="12">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 10L12 5L17 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M7 14L12 19L17 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </el-icon>
          </div>
        </div>

        <!-- åˆ†éš”çº¿ -->
        <div class="header-divider"></div>

        <!-- 2. ç³»ç»Ÿæç¤ºè¯å±•ç¤º/ç¼–è¾‘ -->
        <div class="model-pill prompt-pill" @click="emit('show-system-prompt')">
          <el-icon :size="14" class="prompt-icon"><Edit /></el-icon>
          <span v-if="systemPrompt" class="model-text prompt-text">{{ systemPrompt }}</span>
          <span v-else class="model-text prompt-text placeholder">ç³»ç»Ÿæç¤ºè¯</span>
        </div>

        <!-- 3. [æ–°å¢] æœç´¢æŒ‰é’® -->
        <el-tooltip content="æœç´¢å†…å®¹ (Ctrl/Cmd+F)" placement="bottom" :show-after="500">
          <div class="model-pill icon-pill" @click="emit('open-search')">
            <el-icon :size="14" class="header-icon"><Search /></el-icon>
          </div>
        </el-tooltip>

      </div>
    </div>
  </el-header>
</template>

<style scoped>
.model-header {
  height: 40px; 
  width: 100%;
  padding: 0 16px;
  flex-shrink: 0;
  z-index: 9;
  background-color: transparent;
}

.model-header-wrapper {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
}

.header-content-group {
  display: flex;
  align-items: center;
  gap: 0px; /* ç”±åˆ†éš”çº¿æ§åˆ¶é—´è· */
  flex: 1; 
  min-width: 0; 
}

/* å‚ç›´åˆ†éš”çº¿æ ·å¼ */
.header-divider {
  width: 1px;
  height: 14px;
  background-color: var(--el-border-color);
  margin: 0 8px; /* å·¦å³é—´è· */
  flex-shrink: 0;
}

/* ç»Ÿä¸€çš„ Pill æ ·å¼åŸºç±» */
.model-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  background-color: transparent; /* é»˜è®¤é€æ˜ */
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
  user-select: none;
  height: 20px; 
  box-sizing: content-box; 
  flex-shrink: 0; 
}

.model-pill:hover {
  background-color: var(--el-fill-color); /* Hover æ˜¾ç¤ºèƒŒæ™¯ */
}

.model-pill:active {
  transform: scale(0.98);
}

.model-pill.is-disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

/* === å¯å±•å¼€çš„æ¨¡å‹é€‰æ‹©å™¨é€»è¾‘ === */
.expandable-pill .expandable-content {
  display: flex;
  align-items: center;
  gap: 6px;
  max-width: 0;
  overflow: hidden;
  opacity: 0;
  transition: max-width 0.3s cubic-bezier(0.25, 0.8, 0.5, 1), opacity 0.2s ease;
}

/* æ‚¬æµ®æ—¶å±•å¼€ OR åŠ è½½æ—¶å±•å¼€ */
.expandable-pill:hover .expandable-content,
.expandable-pill.is-loading .expandable-content {
  max-width: 250px; 
  opacity: 1;
}

.expandable-pill:hover,
.expandable-pill.is-loading {
  padding-right: 12px; 
  background-color: var(--el-fill-color); /* åŠ è½½æ—¶ä¿æŒèƒŒæ™¯è‰² */
}

/* æ—‹è½¬åŠ¨ç”» */
@keyframes rotate-logo {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.model-logo-container {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.model-logo {
  transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), color 0.3s;
}

.expandable-pill:hover .model-logo {
  transform: rotate(360deg);
}

/* åŠ è½½çŠ¶æ€ä¸‹çš„ Logo åŠ¨ç”» */
.expandable-pill.is-loading .model-logo {
  animation: rotate-logo 0.6s linear infinite;
}

/* === ç³»ç»Ÿæç¤ºè¯æ ·å¼ === */
.prompt-pill {
  color: var(--el-text-color-regular); 
  background-color: transparent; 
  
  flex: 1; 
  min-width: 0; 
}

.prompt-pill:hover {
  background-color: var(--el-fill-color); 
}

.prompt-icon {
  color: var(--el-text-color-secondary);
  flex-shrink: 0;
}

.prompt-text {
  font-size: 12px;
  color: var(--el-text-color-regular); 
  padding-right: 4px; /* é˜²æ­¢æ–œä½“æˆ–éƒ¨åˆ†å­—ä½“è¢«æˆªæ–­ */
}

/* æ·±è‰²æ¨¡å¼ä¸‹çš„æ–‡å­—é¢œè‰²ä¿®æ­£ */
html.dark .prompt-text {
  color: var(--el-text-color-primary);
}

.prompt-text.placeholder {
  color: var(--el-text-color-placeholder);
  font-style: italic;
}

/* é€šç”¨æ–‡æœ¬æ ·å¼ */
.model-text {
  font-size: 13px;
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ç®­å¤´å’ŒåŠ è½½å›¾æ ‡ */
.loading-icon, .arrow-icon {
  font-size: 12px;
  color: var(--el-text-color-secondary);
  flex-shrink: 0;
}

/* æ–°å¢ï¼šå›¾æ ‡æŒ‰é’®æ ·å¼ */
.icon-pill {
  color: var(--el-text-color-secondary);
  flex: 0 0 auto; 
  width: 28px;
  justify-content: center;
  margin-left: 2px;
}

.icon-pill:hover {
  background-color: var(--el-fill-color);
  color: var(--el-text-color-primary);
}

.header-icon {
  flex-shrink: 0;
}
</style>
```
```vue
./Anywhere_window/src/components/ChatInput.vue
<script setup>
import { ref, h, onMounted, onBeforeUnmount, nextTick, watch, computed, defineAsyncComponent } from 'vue';
import { ElFooter, ElRow, ElCol, ElText, ElDivider, ElButton, ElInput, ElMessage, ElTooltip, ElScrollbar, ElIcon, ElTag } from 'element-plus';
import { Close, Check, Document, Delete, Tools } from '@element-plus/icons-vue'; // å¼•å…¥ Tools

// --- Props and Emits ---
const prompt = defineModel('prompt');
const fileList = defineModel('fileList');
const selectedVoice = defineModel('selectedVoice');
const tempReasoningEffort = defineModel('tempReasoningEffort');

const props = defineProps({
    loading: Boolean,
    ctrlEnterToSend: Boolean,
    voiceList: { type: Array, default: () => [] },
    layout: { type: String, default: 'horizontal' },
    isMcpActive: Boolean,
    // æ¥æ”¶ MCP æ•°æ®
    allMcpServers: { type: Array, default: () => [] },
    activeMcpIds: { type: Array, default: () => [] }
});
// å¢åŠ  toggle-mcp äº‹ä»¶
const emit = defineEmits(['submit', 'cancel', 'clear-history', 'remove-file', 'upload', 'send-audio', 'open-mcp-dialog', 'pick-file-start', 'toggle-mcp']);

// --- Refs and State ---
const senderRef = ref(null);
const fileInputRef = ref(null);
const waveformCanvasContainer = ref(null);
const isDragging = ref(false);
const dragCounter = ref(0);
const isRecording = ref(false);

// --- MCP Quick Select State ---
const showMcpQuickSelect = ref(false);
const mcpFilterKeyword = ref('');
const mcpHighlightIndex = ref(0);

// --- Refs for closing popups ---
const reasoningSelectorRef = ref(null);
const voiceSelectorRef = ref(null);
const audioSourceSelectorRef = ref(null);
const reasoningButtonRef = ref(null);
const voiceButtonRef = ref(null);
const audioButtonRef = ref(null);

let recorder = null;
let wave = null;
let mediaRecorder = null;
let audioChunks = [];
let audioStream = null;
const currentRecordingSource = ref(null);
const isCancelledByButton = ref(false);

const isAudioSourceSelectorVisible = ref(false);
const isReasoningSelectorVisible = ref(false);
const isVoiceSelectorVisible = ref(false);
const internalVoiceList = ref(props.voiceList || []);
watch(() => props.voiceList, (newVal) => {
    internalVoiceList.value = newVal || [];
}, { immediate: true });

// --- Computed Properties ---
const reasoningTooltipContent = computed(() => {
    const map = { default: 'é»˜è®¤', low: 'ä½', medium: 'ä¸­', high: 'é«˜' };
    return `æ€è€ƒé¢„ç®—: ${map[tempReasoningEffort.value] || 'é»˜è®¤'}`;
});

// è¿‡æ»¤åçš„ MCP åˆ—è¡¨é€»è¾‘
const filteredMcpList = computed(() => {
    if (!showMcpQuickSelect.value) return [];
    const keyword = mcpFilterKeyword.value.toLowerCase();
    
    let list = props.allMcpServers.filter(server => {
        // 1. åŒ¹é…åç§° (åŒ…å«åŒ¹é…)
        const nameMatch = server.name && server.name.toLowerCase().includes(keyword);
        
        // 2. åŒ¹é…æ ‡ç­¾
        const tagMatch = server.tags && server.tags.some(tag => tag.toLowerCase().includes(keyword));

        // 3. åŒ¹é…ç±»å‹ (åŸå§‹ç±»å‹ + ä¸­æ–‡æ˜¾ç¤ºå)
        const typeRaw = (server.type || '').toLowerCase();
        let typeDisplay = '';
        
        // ç®€å•çš„ç±»å‹æ˜ å°„é€»è¾‘
        if (typeRaw === 'builtin') typeDisplay = 'å†…ç½®';
        else if (typeRaw === 'stdio') typeDisplay = 'stdio';
        else if (typeRaw === 'sse') typeDisplay = 'sse';
        else if (typeRaw.includes('http')) typeDisplay = 'å¯æµå¼ http';

        const typeMatch = typeRaw.includes(keyword) || typeDisplay.includes(keyword);

        return nameMatch || tagMatch || typeMatch;
    });

    // é™åˆ¶æ˜¾ç¤º 10 ä¸ª
    return list.slice(0, 10);
});

// ç›‘å¬ prompt å˜åŒ–ä»¥è§¦å‘å¿«æ·é€‰æ‹©
watch(prompt, (newVal) => {
    if (newVal.startsWith('@')) {
        const match = newVal.match(/^@([^ \n\r]*)$/);
        if (match) {
            mcpFilterKeyword.value = match[1];
            showMcpQuickSelect.value = true;
            mcpHighlightIndex.value = 0; // é‡ç½®é«˜äº®
        } else {
            showMcpQuickSelect.value = false;
        }
    } else {
        showMcpQuickSelect.value = false;
    }
});

// --- Helper function ---
const insertNewline = () => {
    const textarea = senderRef.value?.$refs.textarea;
    if (!textarea) return;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const value = prompt.value;
    prompt.value = value.substring(0, start) + '\n' + value.substring(end);
    nextTick(() => {
        textarea.selectionStart = textarea.selectionEnd = start + 1;
        textarea.focus();
    });
};

// --- Event Handlers ---
const handleKeyDown = (event) => {
    if (event.isComposing) return;

    // [MCP å¿«æ·é€‰æ‹©é”®ç›˜é€»è¾‘]
    if (showMcpQuickSelect.value && filteredMcpList.value.length > 0) {
        if (event.key === 'Escape') {
            event.preventDefault();
            event.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢å…³é—­æ•´ä¸ªçª—å£
            showMcpQuickSelect.value = false;
            return;
        }
        if (event.key === 'ArrowUp') {
            event.preventDefault();
            mcpHighlightIndex.value = (mcpHighlightIndex.value - 1 + filteredMcpList.value.length) % filteredMcpList.value.length;
            // ç¡®ä¿è§†å›¾æ»šåŠ¨è·Ÿéš
            nextTick(() => {
                const activeItem = document.querySelector('.mcp-quick-item.highlighted');
                if (activeItem) activeItem.scrollIntoView({ block: 'nearest' });
            });
            return;
        }
        if (event.key === 'ArrowDown') {
            event.preventDefault();
            mcpHighlightIndex.value = (mcpHighlightIndex.value + 1) % filteredMcpList.value.length;
            nextTick(() => {
                const activeItem = document.querySelector('.mcp-quick-item.highlighted');
                if (activeItem) activeItem.scrollIntoView({ block: 'nearest' });
            });
            return;
        }
        if (event.key === 'Enter') {
            // å¦‚æœåˆ—è¡¨æ˜¾ç¤ºä¸­ï¼Œå›è½¦ä¸ºé€‰æ‹©ï¼Œä¸æ˜¯å‘é€
            event.preventDefault();
            const server = filteredMcpList.value[mcpHighlightIndex.value];
            if (server) {
                handleToggleMcp(server.id);
            }
            return;
        }
        // æ•°å­—é”® 0-9 é€‰æ‹©
        if (/^[0-9]$/.test(event.key)) {
            event.preventDefault();
            const idx = parseInt(event.key);
            if (idx < filteredMcpList.value.length) {
                handleToggleMcp(filteredMcpList.value[idx].id);
            }
            return;
        }
    }

    // åŸæœ‰çš„å½•éŸ³å¿«æ·é”®é€»è¾‘
    if (isRecording.value) {
        if (!((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'c')) {
            event.preventDefault();
        }
        return;
    }

    // åŸæœ‰çš„å›è½¦å‘é€é€»è¾‘
    if (event.key !== 'Enter') return;
    
    const isCtrlOrMetaPressed = event.ctrlKey || event.metaKey;
    if (!props.ctrlEnterToSend) {
        if (isCtrlOrMetaPressed) {
            event.preventDefault();
            insertNewline();
        } else if (!event.shiftKey) {
            event.preventDefault();
            if (!props.loading) emit('submit');
        }
    } else {
        if (isCtrlOrMetaPressed) {
            event.preventDefault();
            if (!props.loading) emit('submit');
        }
    }
};

const handleToggleMcp = (serverId) => {
    emit('toggle-mcp', serverId);
    showMcpQuickSelect.value = false; prompt.value = '';
};

const handleMcpClick = (server) => {
    handleToggleMcp(server.id);
};

const onSubmit = () => { if (props.loading) return; emit('submit'); };
const onCancel = () => emit('cancel');
const onClearHistory = () => emit('clear-history');
const onRemoveFile = (index) => emit('remove-file', index);

const toggleReasoningSelector = () => {
    if (isRecording.value) return;
    isReasoningSelectorVisible.value = !isReasoningSelectorVisible.value;
    if (isReasoningSelectorVisible.value) {
        isVoiceSelectorVisible.value = false;
        isAudioSourceSelectorVisible.value = false;
    }
};

const handleReasoningSelection = (effort) => {
    tempReasoningEffort.value = effort;
    isReasoningSelectorVisible.value = false;
};

const toggleVoiceSelector = async () => {
    if (isRecording.value) return;
    if (!isVoiceSelectorVisible.value) {
        try {
            const res = await window.api.getConfig();
            if (res?.config?.voiceList) {
                internalVoiceList.value = res.config.voiceList;
            }
        } catch (e) {
            console.error("åˆ·æ–°è¯­éŸ³åˆ—è¡¨å¤±è´¥", e);
        }
        isReasoningSelectorVisible.value = false;
        isAudioSourceSelectorVisible.value = false;
    }
    isVoiceSelectorVisible.value = !isVoiceSelectorVisible.value;
};

const handleVoiceSelection = (value) => {
    selectedVoice.value = value;
    isVoiceSelectorVisible.value = false;
};

// --- File Handling ---
const triggerFileUpload = () => {
    emit('pick-file-start');
    nextTick(() => {
        fileInputRef.value?.click();
    });
};
const handleFileChange = (event) => { const files = event.target.files; if (files.length) emit('upload', { file: files[0], fileList: Array.from(files) }); if (fileInputRef.value) fileInputRef.value.value = ''; };
const preventDefaults = (e) => e.preventDefault();
const handleDragEnter = (event) => { preventDefaults(event); dragCounter.value++; isDragging.value = true; };
const handleDragLeave = (event) => { preventDefaults(event); dragCounter.value--; if (dragCounter.value <= 0) { isDragging.value = false; dragCounter.value = 0; } };
const handleDrop = (event) => { preventDefaults(event); isDragging.value = false; dragCounter.value = 0; const files = event.dataTransfer.files; if (files && files.length > 0) { emit('upload', { file: files[0], fileList: Array.from(files) }); focus(); } };
const handlePasteEvent = (event) => { const clipboardData = event.clipboardData || window.clipboardData; if (!clipboardData) return; const items = Array.from(clipboardData.items).filter(item => item.kind === 'file'); if (items.length > 0) { preventDefaults(event); const files = items.map(item => item.getAsFile()); emit('upload', { file: files[0], fileList: files }); focus(); } };

const toggleAudioSourceSelector = () => {
    if (isRecording.value) return;
    isAudioSourceSelectorVisible.value = !isAudioSourceSelectorVisible.value;
    if (isAudioSourceSelectorVisible.value) {
        isVoiceSelectorVisible.value = false;
        isReasoningSelectorVisible.value = false;
    }
}

const startRecordingFromSource = async (sourceType) => {
    isAudioSourceSelectorVisible.value = false;
    if (isRecording.value) return;

    isRecording.value = true;
    currentRecordingSource.value = sourceType;
    isCancelledByButton.value = false;

    try {
        if (sourceType === 'microphone') {
            const RecorderLib = await import('recorder-core');
            const Recorder = RecorderLib.default;
            await import('recorder-core/src/extensions/waveview.js');
            await import('recorder-core/src/engine/wav');

            await new Promise((resolve, reject) => {
                Recorder.TrafficFree = true;
                recorder = Recorder({
                    type: 'wav', sampleRate: 16000, bitRate: 16,
                    onProcess: (buffers, powerLevel, bufferDuration, bufferSampleRate) => {
                        if (wave) {
                            wave.input(buffers[buffers.length - 1], powerLevel, bufferSampleRate);
                        }
                    }
                });
                recorder.open(() => {
                    nextTick(() => {
                        if (waveformCanvasContainer.value) {
                            wave = Recorder.WaveView({ elem: waveformCanvasContainer.value, lineWidth: 3 });
                        }
                        recorder.start();
                        resolve();
                    });
                }, (msg, isUserNotAllow) => {
                    const errorMsg = (isUserNotAllow ? 'ç”¨æˆ·æ‹’ç»äº†æƒé™, ' : '') + 'æ— æ³•å½•éŸ³: ' + msg;
                    ElMessage.error(errorMsg);
                    recorder = null;
                    reject(new Error(errorMsg));
                });
            });
        } else if (sourceType === 'system') {
            const sources = await window.api.desktopCaptureSources({ types: ['screen', 'window'] });
            if (!sources || sources.length === 0) throw new Error('æœªæ‰¾åˆ°å¯ç”¨çš„ç³»ç»ŸéŸ³é¢‘æº');

            audioStream = await navigator.mediaDevices.getUserMedia({
                audio: { mandatory: { chromeMediaSource: 'desktop', chromeMediaSourceId: sources[0].id } },
                video: { mandatory: { chromeMediaSource: 'desktop', chromeMediaSourceId: sources[0].id } },
            });

            audioChunks = [];
            mediaRecorder = new MediaRecorder(audioStream);

            mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
            mediaRecorder.onstop = () => {
                if (isCancelledByButton.value) {
                    stopRecordingAndCleanup();
                    return;
                }
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const now = new Date();
                const timestamp = `${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
                const audioFile = new File([audioBlob], `audio-${timestamp}.wav`, { type: 'audio/wav' });
                emit('send-audio', audioFile);
                stopRecordingAndCleanup();
            };

            mediaRecorder.start();
        }
    } catch (err) {
        console.error("å½•éŸ³å¯åŠ¨å¤±è´¥:", err);
        ElMessage.error(err.message || 'æ— æ³•å¼€å§‹å½•éŸ³');
        stopRecordingAndCleanup();
    }
};

const stopRecordingAndCleanup = () => {
    if (recorder) {
        recorder.close();
        recorder = null;
    }
    if (wave) {
        if (waveformCanvasContainer.value) waveformCanvasContainer.value.innerHTML = "";
        wave = null;
    }
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
    if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
    }
    mediaRecorder = null;
    audioStream = null;
    audioChunks = [];
    isRecording.value = false;
    currentRecordingSource.value = null;
};

const handleCancelRecording = () => {
    isCancelledByButton.value = true;
    ElMessage.info('å½•éŸ³å·²å–æ¶ˆ');
    if (currentRecordingSource.value === 'microphone' && recorder) {
        recorder.stop(() => stopRecordingAndCleanup(), () => stopRecordingAndCleanup());
    } else if (currentRecordingSource.value === 'system' && mediaRecorder) {
        mediaRecorder.stop();
    }
};

const handleConfirmAndSendRecording = () => {
    isCancelledByButton.value = false;
    if (currentRecordingSource.value === 'microphone' && recorder) {
        recorder.stop((blob) => {
            if (isCancelledByButton.value) {
                stopRecordingAndCleanup();
                return;
            }
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
            const audioFile = new File([blob], `audio-${timestamp}.wav`, { type: 'audio/wav' });
            emit('send-audio', audioFile);
            stopRecordingAndCleanup();
        }, (msg) => {
            ElMessage.error('å½•éŸ³å¤±è´¥: ' + msg);
            stopRecordingAndCleanup();
        });
    } else if (currentRecordingSource.value === 'system' && mediaRecorder) {
        mediaRecorder.stop();
    }
};

const handleClickOutside = (event) => {
    const target = event.target;
    if (!target) return;
    if (isReasoningSelectorVisible.value && reasoningSelectorRef.value && !reasoningSelectorRef.value.contains(target) && reasoningButtonRef.value && !reasoningButtonRef.value.$el.contains(target)) {
        isReasoningSelectorVisible.value = false;
    }
    if (isVoiceSelectorVisible.value && voiceSelectorRef.value && !voiceSelectorRef.value.$el.contains(target) && voiceButtonRef.value && !voiceButtonRef.value.$el.contains(target)) {
        isVoiceSelectorVisible.value = false;
    }
    if (isAudioSourceSelectorVisible.value && audioSourceSelectorRef.value && !audioSourceSelectorRef.value.contains(target) && audioButtonRef.value && !audioButtonRef.value.$el.contains(target)) {
        isAudioSourceSelectorVisible.value = false;
    }
};

onMounted(() => {
    window.addEventListener('dragenter', handleDragEnter);
    window.addEventListener('dragleave', handleDragLeave);
    window.addEventListener('dragover', preventDefaults);
    window.addEventListener('drop', handleDrop);
    window.addEventListener('paste', handlePasteEvent);
    document.addEventListener('click', handleClickOutside);
});

onBeforeUnmount(() => {
    window.removeEventListener('dragenter', handleDragEnter);
    window.removeEventListener('dragleave', handleDragLeave);
    window.removeEventListener('dragover', preventDefaults);
    window.removeEventListener('drop', handleDrop);
    window.removeEventListener('paste', handlePasteEvent);
    document.removeEventListener('click', handleClickOutside);
    stopRecordingAndCleanup();
});

const focus = (options = {}) => {
    const textarea = senderRef.value?.$refs.textarea;
    if (!textarea) return;
    textarea.focus();
    nextTick(() => {
        if (options.position && typeof options.position.start === 'number') {
            const textLength = prompt.value?.length || 0;
            const start = Math.min(options.position.start, textLength);
            const end = Math.min(options.position.end, textLength);
            textarea.setSelectionRange(start, end);
        } else if (options.cursor === 'end') {
            const textLength = prompt.value?.length || 0;
            textarea.setSelectionRange(textLength, textLength);
        }
    });
};

const getDisplayTypeName = (type) => {
    if (!type) return '';
    const streamableHttpRegex = /^streamable[\s_-]?http$/i;
    const lowerType = type.toLowerCase();
    
    if (lowerType === 'builtin') return 'å†…ç½®';
    if (streamableHttpRegex.test(lowerType) || lowerType === 'http') return 'HTTP'; // ç®€åŒ–æ˜¾ç¤º
    if (lowerType === 'sse') return 'SSE';
    if (lowerType === 'stdio') return 'Stdio';
    
    return type;
};

defineExpose({ focus, senderRef });

</script>

<template>
    <div v-if="isDragging" class="drag-overlay">
        <div class="drag-overlay-content">
            æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä»¥ä¸Šä¼ 
        </div>
    </div>

    <el-footer class="input-footer">
        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <el-row v-if="fileList.length > 0 && !isRecording">
            <el-col :span="0" />
            <el-col :span="24">
                <div class="file-card-container">
                    <div v-for="(file, index) in fileList" :key="index" class="custom-file-card">
                        <div class="file-icon">
                            <el-icon :size="20"><Document /></el-icon>
                        </div>
                        <div class="file-info">
                            <div class="file-name" :title="file.name">{{ file.name }}</div>
                            <div class="file-size">{{ (file.size / 1024).toFixed(1) }} KB</div>
                        </div>
                        <div class="file-actions">
                            <el-button 
                                type="danger" 
                                link 
                                :icon="Delete" 
                                size="small" 
                                @click="onRemoveFile(index)" 
                            />
                        </div>
                    </div>
                </div>
            </el-col>
            <el-col :span="0" />
        </el-row>

        <!-- å½•éŸ³æ³¢å½¢ -->
        <el-row v-show="isRecording" class="waveform-row">
            <el-col :span="0" />
            <el-col :span="24">
                <div class="waveform-display-area">
                    <div v-if="currentRecordingSource === 'microphone'" ref="waveformCanvasContainer"
                        class="waveform-canvas"></div>
                    <span v-else class="recording-status-text">æ­£åœ¨å½•åˆ¶ç³»ç»ŸéŸ³é¢‘...</span>
                </div>
            </el-col>
            <el-col :span="0" />
        </el-row>

        <!-- é€‰é¡¹å¼¹å‡ºå±‚ -->
        <el-row v-if="isAudioSourceSelectorVisible" class="option-selector-row">
            <el-col :span="0" />
            <el-col :span="24">
                <div class="option-selector-wrapper" ref="audioSourceSelectorRef">
                    <div class="option-selector-content">
                        <el-text tag="b" class="selector-label">é€‰æ‹©éŸ³æº</el-text>
                        <el-divider direction="vertical" />
                        <el-button @click="startRecordingFromSource('microphone')" round>ğŸ™ï¸ éº¦å…‹é£</el-button>
                        <el-button @click="startRecordingFromSource('system')" round>ğŸ’» ç³»ç»ŸéŸ³é¢‘</el-button>
                    </div>
                </div>
            </el-col>
            <el-col :span="0" />
        </el-row>

        <el-row v-if="isReasoningSelectorVisible" class="option-selector-row">
            <el-col :span="0" />
            <el-col :span="24">
                <div class="option-selector-wrapper" ref="reasoningSelectorRef">
                    <div class="option-selector-content">
                        <el-text tag="b" class="selector-label">æ€è€ƒé¢„ç®—</el-text>
                        <el-divider direction="vertical" />
                        <el-button @click="handleReasoningSelection('default')"
                            :type="tempReasoningEffort === 'default' ? 'primary' : 'default'" round>é»˜è®¤</el-button>
                        <el-button @click="handleReasoningSelection('low')"
                            :type="tempReasoningEffort === 'low' ? 'primary' : 'default'" round>å¿«é€Ÿ</el-button>
                        <el-button @click="handleReasoningSelection('medium')"
                            :type="tempReasoningEffort === 'medium' ? 'primary' : 'default'" round>å‡è¡¡</el-button>
                        <el-button @click="handleReasoningSelection('high')"
                            :type="tempReasoningEffort === 'high' ? 'primary' : 'default'" round>æ·±å…¥</el-button>
                    </div>
                </div>
            </el-col>
            <el-col :span="0" />
        </el-row>

        <el-row v-if="isVoiceSelectorVisible" class="option-selector-row">
            <el-col :span="0" />
            <el-col :span="24">
                <el-scrollbar class="option-selector-wrapper" ref="voiceSelectorRef">
                    <div class="option-selector-content">
                        <el-text tag="b" class="selector-label">é€‰æ‹©éŸ³è‰²</el-text>
                        <el-divider direction="vertical" />
                        <el-button @click="handleVoiceSelection(null)" :type="!selectedVoice ? 'primary' : 'default'"
                            round>
                            å…³é—­è¯­éŸ³
                        </el-button>
                        <el-button v-for="voice in internalVoiceList" :key="voice" @click="handleVoiceSelection(voice)"
                            :type="selectedVoice === voice ? 'primary' : 'default'" round>
                            {{ voice }}
                        </el-button>
                    </div>
                </el-scrollbar>
            </el-col>
            <el-col :span="0" />
        </el-row>

        <el-row>
            <el-col :span="0" />
            <el-col :span="24">
                <div class="chat-input-area-vertical">
                    <div v-if="showMcpQuickSelect && filteredMcpList.length > 0" class="mcp-quick-select">
                        <!-- é¡¶éƒ¨æç¤ºæ  -->
                        <div class="mcp-quick-header">
                            <span class="header-title">MCPå¿«æ·é€‰æ‹©</span>
                            <span class="header-hint">Esc å–æ¶ˆ <span class="divider">|</span> â‡… é€‰æ‹© <span class="divider">|</span> Enter/æ•°å­—é”® ç¡®è®¤</span>
                        </div>
                        
                        <!-- æ»šåŠ¨åˆ—è¡¨åŒºåŸŸ -->
                        <div class="mcp-quick-list-scroll">
                            <div v-for="(server, idx) in filteredMcpList" :key="server.id" 
                                class="mcp-quick-item" 
                                :class="{ 'highlighted': idx === mcpHighlightIndex, 'active': activeMcpIds.includes(server.id) }"
                                @mousedown.prevent="handleMcpClick(server)">
                                <div class="mcp-item-left">
                                    <span class="mcp-index-badge">{{ idx }}</span>
                                    <span class="mcp-name">{{ server.name }}</span>
                                    <div class="mcp-tags">
                                        <!-- æ˜¾å¼æ˜¾ç¤ºç±»å‹æ ‡ç­¾ -->
                                        <span v-if="server.type" class="mcp-tag type-tag">{{ getDisplayTypeName(server.type) }}</span>
                                        <!-- åŸæœ‰çš„ç”¨æˆ·æ ‡ç­¾ -->
                                        <span v-for="tag in (server.tags || []).slice(0,2)" :key="tag" class="mcp-tag">{{ tag }}</span>
                                    </div>
                                </div>
                                <div class="mcp-item-right">
                                    <el-icon v-if="activeMcpIds.includes(server.id)" class="active-icon"><Check /></el-icon>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="input-wrapper">
                        <el-input ref="senderRef" class="chat-textarea-vertical" v-model="prompt" type="textarea"
                            :placeholder="isRecording ? 'å½•éŸ³ä¸­... ç»“æŸåå°†è¿åŒæ–‡æœ¬ä¸€èµ·å‘é€' : 'è¾“å…¥ã€ç²˜è´´ã€æ‹–æ‹½ä»¥å‘é€å†…å®¹ï¼Œâ€œ@â€é€‰æ‹©MCP'"
                            :autosize="{ minRows: 1, maxRows: 15 }" resize="none" @keydown="handleKeyDown"
                            :disabled="isRecording" />
                    </div>
                    <div class="input-actions-bar">
                        <div class="action-buttons-left">
                            <el-tooltip content="æ¸…é™¤èŠå¤©è®°å½•">
                                <el-button size="default" @click="onClearHistory" circle :disabled="isRecording">
                                    <el-icon :size="18">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="lucide lucide-paintbrush-vertical" aria-hidden="true">
                                            <path d="M10 2v2"></path>
                                            <path d="M14 2v4"></path>
                                            <path d="M17 2a1 1 0 0 1 1 1v9H6V3a1 1 0 0 1 1-1z"></path>
                                            <path
                                                d="M6 12a1 1 0 0 0-1 1v1a2 2 0 0 0 2 2h2a1 1 0 0 1 1 1v2.9a2 2 0 1 0 4 0V17a1 1 0 0 1 1-1h2a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1">
                                            </path>
                                        </svg>
                                    </el-icon>
                                </el-button>
                            </el-tooltip>
                            <el-tooltip content="æ·»åŠ é™„ä»¶">
                                <el-button size="default" @click="triggerFileUpload" circle :disabled="isRecording">
                                    <el-icon :size="17">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="lucide lucide-paperclip" aria-hidden="true">
                                            <path
                                                d="m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551">
                                            </path>
                                        </svg>
                                    </el-icon>
                                </el-button>
                            </el-tooltip>

                            <el-tooltip :content="reasoningTooltipContent">
                                <el-button ref="reasoningButtonRef"
                                    :class="{ 'is-active-special': tempReasoningEffort && tempReasoningEffort !== 'default' }"
                                    size="default" circle :disabled="isRecording" @click="toggleReasoningSelector">
                                    <el-icon :size="18">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                            viewBox="0 0 24 24" class="icon" style="margin-top: -2px;">
                                            <path fill="currentColor"
                                                d="M1 11h3v2H1zm9 11c0 .6.4 1 1 1h2c.6 0 1-.4 1-1v-1h-4zm3-21h-2v3h2zM4.9 3.5L3.5 4.9L5.6 7L7 5.6zM20 11v2h3v-2zm-.9-7.5L17 5.6L18.4 7l2.1-2.1zM18 12c0 2.2-1.2 4.2-3 5.2V19c0 .6-.4 1-1 1h-4c-.6 0-1-.4-1-1v-1.8c-1.8-1-3-3-3-5.2c0-3.3 2.7-6 6-6s6 2.7 6 6M8 12c0 .35.05.68.14 1h7.72c.09-.32.14-.65.14-1c0-2.21-1.79-4-4-4s-4 1.79-4 4">
                                            </path>
                                        </svg>
                                    </el-icon>
                                </el-button>
                            </el-tooltip>

                            <el-tooltip content="è¯­éŸ³å›å¤è®¾ç½®">
                                <el-button ref="voiceButtonRef" size="default" circle :disabled="isRecording"
                                    :class="{ 'is-active-special': selectedVoice }" @click="toggleVoiceSelector">
                                    <el-icon :size="18">
                                        <svg t="1765028999430" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="60819" width="200" height="200">
                                            <path
                                                d="M85.333333 512C85.333333 276.352 276.352 85.333333 512 85.333333s426.666667 191.018667 426.666667 426.666667-191.018667 426.666667-426.666667 426.666667H85.333333l124.970667-124.970667A425.344 425.344 0 0 1 85.333333 512z m205.994667 341.333333H512a341.333333 341.333333 0 1 0-341.333333-341.333333c0 91.818667 36.309333 177.706667 99.968 241.365333l60.330666 60.330667-39.637333 39.637333zM469.333333 256h85.333334v512h-85.333334V256zM298.666667 384h85.333333v256H298.666667V384z m341.333333 0h85.333333v256h-85.333333V384z"
                                                p-id="60820"></path>
                                        </svg>
                                    </el-icon>
                                </el-button>
                            </el-tooltip>
                            <el-tooltip content="MCPå·¥å…·">
                                <el-button size="default" circle :disabled="isRecording"
                                    :class="{ 'is-active-special': isMcpActive }" @click="$emit('open-mcp-dialog')">
                                    <el-icon :size="18">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-hammer"
                                            aria-hidden="true">
                                            <path d="m15 12-8.373 8.373a1 1 0 1 1-3-3L12 9"></path>
                                            <path d="m18 15 4-4"></path>
                                            <path
                                                d="m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172V7l-2.26-2.26a6 6 0 0 0-4.202-1.756L9 2.96l.92.82A6.18 6.18 0 0 1 12 8.4V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5">
                                            </path>
                                        </svg>
                                    </el-icon>
                                </el-button>
                            </el-tooltip>
                        </div>
                        <div class="action-buttons-right">
                            <template v-if="isRecording">
                                <el-tooltip content="å–æ¶ˆå½•éŸ³"><el-button :icon="Close" size="default"
                                        @click="handleCancelRecording" circle /></el-tooltip>
                                <el-tooltip content="ç»“æŸå¹¶å‘é€"><el-button :icon="Check" size="default"
                                        @click="handleConfirmAndSendRecording" circle /></el-tooltip>
                            </template>
                            <template v-else>
                                <el-tooltip content="å‘é€è¯­éŸ³">
                                    <el-button ref="audioButtonRef" size="default" @click="toggleAudioSourceSelector"
                                        circle>
                                        <el-icon :size="17">
                                            <svg t="1765029327206" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="68987" width="200" height="200"><path d="M516.368 732.288c126.944 0 230.096-99.696 230.096-222.272V230.272c0-122.56-103.28-222.272-230.096-222.272S286.16 107.696 286.16 230.272v279.744c0 122.56 103.28 222.272 230.208 222.272zM377.664 230.272c0-73.808 62.256-133.984 138.704-133.984 76.448 0 138.688 60.048 138.688 133.984v279.744c0 73.808-62.256 134-138.688 134-76.448 0-138.704-60.048-138.704-134V230.272z" p-id="68988"></path><path d="M465.088 899.296C267.52 876.656 113.776 712.928 113.776 514.928c0-24.832 20.64-44.896 46.16-44.896 25.536 0 46.16 20.064 46.16 44.896 0 163.952 137.184 297.376 305.856 297.376 168.656 0 305.968-133.424 305.968-297.376 0-24.832 20.656-44.896 46.192-44.896 25.504 0 46.128 20.064 46.128 44.896 0 196.976-152.096 359.872-348.16 384.016v68.592A48.416 48.416 0 0 1 513.6 1016a48.448 48.448 0 0 1-48.496-48.464v-68.24z" p-id="68989"></path></svg>
                                        </el-icon>
                                    </el-button>
                                </el-tooltip>
                                <el-button v-if="!loading" @click="onSubmit" circle :disabled="loading">
                                    <el-icon :size="18">
                                        <svg t="1765029205363" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                            xmlns="http://www.w3.org/2000/svg" p-id="63447" width="200" height="200">
                                            <path
                                                d="M866.133333 298.666667l-277.333333 396.8 174.933333 64L866.133333 298.666667zM469.333333 691.2l362.666667-482.133333-652.8 332.8 230.4 72.533333c21.333333 8.533333 29.866667 29.866667 21.333333 51.2v4.266667c-12.8 21.333333-42.666667 34.133333-68.266666 21.333333L76.8 597.333333c-21.333333-8.533333-34.133333-29.866667-25.6-55.466666 4.266667-8.533333 12.8-17.066667 21.333333-25.6L913.066667 72.533333c21.333333-12.8 46.933333-4.266667 59.733333 17.066667 4.266667 8.533333 4.266667 17.066667 4.266667 29.866667l-140.8 699.733333c-4.266667 21.333333-25.6 38.4-51.2 34.133333h-4.266667l-238.933333-89.6v162.133334c0 21.333333-17.066667 38.4-38.4 42.666666-21.333333 0-38.4-17.066667-38.4-42.666666"
                                                p-id="63448"></path>
                                        </svg>
                                    </el-icon>
                                </el-button>
                                <el-button v-else @click="onCancel" circle class="cancel-button-animated">
                                    <el-icon class="static-icon">
                                        <Close />
                                    </el-icon>
                                    <div class="cancel-spinner"></div>
                                </el-button>
                            </template>
                        </div>
                    </div>
                </div>

                <input ref="fileInputRef" type="file" multiple @change="handleFileChange" style="display: none;" />
            </el-col>
            <el-col :span="0" />
        </el-row>
    </el-footer>
</template>

<style scoped>
/* Base Styles */
.drag-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(90, 90, 90, 0.3);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none;
}

html.dark .drag-overlay {
    background-color: rgba(20, 20, 20, 0.4);
}

.drag-overlay-content {
    color: white;
    font-size: 20px;
    font-weight: bold;
    padding: 20px 40px;
    border: 2px dashed white;
    border-radius: 12px;
    background-color: rgba(0, 0, 0, 0.2);
}

.input-footer {
    padding: 10px 5% 25px 5%;
    height: auto;
    width: 100%;
    flex-shrink: 0;
    z-index: 10;
    background-color: transparent;
}

/* --- MCP Quick Select Styles --- */
.mcp-quick-select {
    position: absolute;
    bottom: 100%;
    left: 0;
    width: 100%;
    /* å®¹å™¨æœ¬èº«ä¸æ»šåŠ¨ï¼Œæ”¹ä¸º flex å¸ƒå±€ä»¥å›ºå®š Header */
    display: flex;
    flex-direction: column;
    background-color: var(--el-bg-color-overlay);
    border: 1px solid var(--el-border-color-light);
    border-radius: 8px;
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    z-index: 100;
    margin-bottom: 8px;
    padding: 0; /* padding ç§»åˆ°å†…éƒ¨å…ƒç´  */
    overflow: hidden; /* é˜²æ­¢åœ†è§’æº¢å‡º */
}

/* é¡¶éƒ¨æç¤ºæ æ ·å¼ */
.mcp-quick-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background-color: var(--el-fill-color-light);
    border-bottom: 1px solid var(--el-border-color-lighter);
    flex-shrink: 0;
}

.header-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--el-text-color-primary);
}

.header-hint {
    font-size: 11px;
    color: var(--el-text-color-secondary);
    font-family: monospace; /* ç­‰å®½å­—ä½“è®©å¿«æ·é”®æ›´å¥½çœ‹ */
}

.header-hint .divider {
    color: var(--el-border-color);
    margin: 0 4px;
}

/* æ»šåŠ¨åˆ—è¡¨åŒºåŸŸ */
.mcp-quick-list-scroll {
    max-height: 260px; /* åˆ—è¡¨å†…å®¹çš„æœ€å¤§é«˜åº¦ */
    overflow-y: auto;
    padding: 6px;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

/* æ»šåŠ¨æ¡ */
.mcp-quick-list-scroll::-webkit-scrollbar {
    width: 6px;
}
.mcp-quick-list-scroll::-webkit-scrollbar-thumb {
    background-color: var(--el-border-color);
    border-radius: 3px;
}

.app-container.has-bg .mcp-quick-select {
    background-color: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-color: rgba(255, 255, 255, 0.5);
    box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.08);
}

.app-container.has-bg .mcp-quick-header {
    background-color: rgba(0, 0, 0, 0.03);
    border-bottom-color: rgba(0, 0, 0, 0.05);
}

html.dark .app-container.has-bg .mcp-quick-select {
    background-color: rgba(30, 30, 30, 0.85);
    border-color: rgba(255, 255, 255, 0.1);
}

html.dark .app-container.has-bg .mcp-quick-header {
    background-color: rgba(255, 255, 255, 0.05);
    border-bottom-color: rgba(255, 255, 255, 0.05);
}

.mcp-quick-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px 8px 4px 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s ease; /* å¢åŠ å¹³æ»‘è¿‡æ¸¡ */
    border: 1px solid transparent; /* é¢„ç•™è¾¹æ¡†ä½ç½®é˜²æ­¢è·³åŠ¨ */
}

/* 1. é»˜è®¤çŠ¶æ€ï¼šæ‚¬æµ® (Hover) & é”®ç›˜é«˜äº® (Highlighted) */
.mcp-quick-item:hover, 
.mcp-quick-item.highlighted {
    background-color: var(--el-fill-color);
}

/* 2. æ¿€æ´»çŠ¶æ€ (Active - å·²å‹¾é€‰) */
.mcp-quick-item.active {
    background-color: var(--el-color-primary-light-9);
    border-color: var(--el-color-primary-light-8);
}

.mcp-quick-item.active .mcp-name {
    color: var(--el-color-primary); /* æ¿€æ´»æ—¶åç§°å˜ä¸ºä¸»è‰² */
    font-weight: 600;
}

/* 3. æ¿€æ´» + æ‚¬æµ®/é«˜äº® (å åŠ çŠ¶æ€) */
.mcp-quick-item.active:hover, 
.mcp-quick-item.active.highlighted {
    background-color: var(--el-color-primary-light-8);
}

/* --- æ·±è‰²æ¨¡å¼é€‚é… (Dark Mode) --- */
html.dark .mcp-quick-item.active {
    background-color: rgba(64, 158, 255, 0.15); /* ä½¿ç”¨é€æ˜ä¸»è‰²ï¼Œé¿å… light-9 åœ¨æš—è‰²ä¸‹å¤ªäº® */
    border-color: rgba(64, 158, 255, 0.2);
}

html.dark .mcp-quick-item.active:hover, 
html.dark .mcp-quick-item.active.highlighted {
    background-color: rgba(64, 158, 255, 0.25);
}

/* 1. æ‚¬æµ®/é«˜äº® */
.app-container.has-bg .mcp-quick-item:hover, 
.app-container.has-bg .mcp-quick-item.highlighted {
    background-color: rgba(0, 0, 0, 0.05);
}

html.dark .app-container.has-bg .mcp-quick-item:hover, 
html.dark .app-container.has-bg .mcp-quick-item.highlighted {
    background-color: rgba(255, 255, 255, 0.1);
}

/* 2. æ¿€æ´»çŠ¶æ€ */
.app-container.has-bg .mcp-quick-item.active {
    /* æµ…è‰²èƒŒæ™¯ä¸‹ï¼šæ·¡æ·¡çš„è“è‰²ç»ç’ƒæ„Ÿ */
    background-color: rgba(64, 158, 255, 0.15);
    border-color: rgba(64, 158, 255, 0.2);
}

html.dark .app-container.has-bg .mcp-quick-item.active {
    /* æ·±è‰²èƒŒæ™¯ä¸‹ï¼šç¨äº®çš„è“è‰²ç»ç’ƒæ„Ÿ */
    background-color: rgba(64, 158, 255, 0.25);
    border-color: rgba(64, 158, 255, 0.3);
}

/* 3. æ¿€æ´» + æ‚¬æµ®/é«˜äº® */
.app-container.has-bg .mcp-quick-item.active:hover, 
.app-container.has-bg .mcp-quick-item.active.highlighted {
    background-color: rgba(64, 158, 255, 0.25);
}

html.dark .app-container.has-bg .mcp-quick-item.active:hover, 
html.dark .app-container.has-bg .mcp-quick-item.active.highlighted {
    background-color: rgba(64, 158, 255, 0.35);
}

.mcp-item-left {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 0;
}

.mcp-index-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 18px;
    height: 18px;
    border-radius: 4px;
    background-color: var(--el-fill-color-dark); /* æµ…è‰²æ¨¡å¼é»˜è®¤ */
    color: var(--el-text-color-secondary);
    font-size: 11px;
    font-weight: bold;
    padding: 2px 4px 0px 4px;
    transition: all 0.15s;
}

.mcp-quick-item.active .mcp-index-badge {
    background-color: var(--el-color-primary);
    color: #ffffff;
}

html.dark .mcp-index-badge {
    background-color: rgba(255, 255, 255, 0.15);
    color: rgba(255, 255, 255, 0.9);
}

html.dark .mcp-quick-item:hover .mcp-index-badge,
html.dark .mcp-quick-item.highlighted .mcp-index-badge {
    background-color: rgba(255, 255, 255, 0.25);
    color: #ffffff;
}
html.dark .mcp-quick-item.active .mcp-index-badge {
    background-color: var(--el-color-primary);
    color: #1a1a1a; 
}

.mcp-name {
    font-weight: 500;
    color: var(--el-text-color-primary);
    white-space: nowrap;
}

.mcp-tags {
    display: flex;
    gap: 4px;
    align-items: center;
}

.mcp-tag {
    font-size: 10px;
    padding: 1px 5px;
    border-radius: 4px;
    background-color: var(--el-color-info-light-9);
    color: var(--el-color-info);
    height: 18px;
    line-height: 16px;
    box-sizing: border-box;
}

/* ç±»å‹æ ‡ç­¾ç‰¹æ®Šæ ·å¼ */
.mcp-tag.type-tag {
    background-color: var(--el-color-primary-light-9);
    color: var(--el-color-primary);
    font-weight: 600;
    padding-bottom: 0px;
    padding-top:2px;
}

html.dark .mcp-tag.type-tag {
    background-color: var(--el-color-primary-light-8); 
    color: var(--el-color-primary-dark-2);
}

.mcp-item-right {
    margin-left: 8px;
    width: 20px;
    display: flex;
    justify-content: center;
}

.active-icon {
    color: var(--el-color-primary);
    font-weight: bold;
}

/* --- æ–‡ä»¶å¡ç‰‡å®¹å™¨æ ·å¼ (åŸæœ‰) --- */
.file-card-container {
    margin-bottom: 8px;
    display: flex;
    flex-wrap: nowrap;
    gap: 8px;
    overflow-x: auto;
    overflow-y: hidden;
    padding-bottom: 4px;
    padding-top: 8px;
    max-height: 70px;
}

/* è‡ªå®šä¹‰æ–‡ä»¶å¡ç‰‡æ ·å¼ */
.custom-file-card {
    display: flex;
    align-items: center;
    background-color: var(--el-fill-color-light);
    border: 1px solid var(--el-border-color-light);
    border-radius: 6px;
    padding: 6px 10px;
    margin-right: 0; /* gapå·²å¤„ç†é—´è· */
    min-width: 140px;
    max-width: 220px;
    height: 48px;
    box-sizing: border-box;
    transition: all 0.2s;
    flex-shrink: 0;
}

.custom-file-card:hover {
    border-color: var(--el-color-primary-light-5);
    background-color: var(--el-fill-color);
}

.file-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    color: var(--el-text-color-secondary);
}

.file-info {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
    line-height: 1.2;
    min-width: 0; /* ä¿®å¤ flex å­é¡¹æˆªæ–­é—®é¢˜ */
}

.file-name {
    font-size: 12px;
    color: var(--el-text-color-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500;
}

.file-size {
    font-size: 10px;
    color: var(--el-text-color-secondary);
    margin-top: 2px;
}

.file-actions {
    margin-left: 8px;
    display: flex;
    align-items: center;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.custom-file-card:hover .file-actions {
    opacity: 1;
}

/* æ·±è‰²æ¨¡å¼ä¸‹çš„æ–‡ä»¶å¡ç‰‡é€‚é… */
html.dark .custom-file-card {
    background-color: #2c2c2c;
    border-color: #4c4c4c;
}

html.dark .custom-file-card:hover {
    background-color: #363636;
    border-color: #5c5c5c;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
.file-card-container::-webkit-scrollbar {
    height: 6px;
}

.file-card-container::-webkit-scrollbar-track {
    background: transparent;
}

.file-card-container::-webkit-scrollbar-thumb {
    background-color: var(--el-border-color);
    border-radius: 3px;
}

.file-card-container::-webkit-scrollbar-thumb:hover {
    background-color: var(--el-text-color-secondary);
}

html.dark .file-card-container::-webkit-scrollbar-thumb {
    background-color: #4c4c4c;
}

html.dark .file-card-container::-webkit-scrollbar-thumb:hover {
    background-color: #6b6b6b;
}

/* --- Waveform Display Area Styles --- */
.waveform-row {
    margin-bottom: 8px;
    transition: all 0.3s ease;
}

.waveform-display-area {
    width: 100%;
    height: 40px;
    background-color: var(--el-bg-color-input);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    box-sizing: border-box;
    overflow: hidden;
}

.waveform-canvas {
    width: 100%;
    height: 100%;
}

.recording-status-text {
    color: var(--el-text-color-secondary);
    font-size: 14px;
    animation: pulse-text 1.5s infinite ease-in-out;
}

@keyframes pulse-text {
    0% { opacity: 0.7; }
    50% { opacity: 1; }
    100% { opacity: 0.7; }
}

html.dark .waveform-display-area {
    background-color: var(--el-bg-color-input);
}

/* --- Universal Option Selector Styles --- */
.option-selector-row {
    margin-bottom: 8px;
}

.option-selector-wrapper {
    background-color: var(--el-bg-color-input);
    border-radius: 12px;
    padding: 8px;
    max-height: 132px;
}

html.dark .option-selector-wrapper {
    background-color: var(--el-bg-color-input);
}

.option-selector-content {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

.option-selector-content .el-button {
    flex-shrink: 0;
}

.option-selector-wrapper :deep(.el-scrollbar__view) {
    padding-right: 8px;
}

.selector-label {
    font-size: 14px;
    color: var(--el-text-color);
    margin: 0 4px 0 8px;
    white-space: nowrap;
}

.el-divider--vertical {
    height: 1.2em;
    border-left: 1px solid var(--el-border-color-lighter);
    margin: 0 4px;
}

html.dark .el-divider--vertical {
    border-left-color: var(--el-border-color);
}

.input-wrapper {
    position: relative;
    flex-grow: 1;
    display: flex;
}

/* --- Vertical Layout (Chat Input Area) --- */
.chat-input-area-vertical {
    display: flex;
    flex-direction: column;
    background-color: var(--el-bg-color-input);
    border-radius: 12px;
    padding: 10px 12px;
    border: 1px solid #E4E7ED;
    position: relative; /* ç¡®ä¿ç»å¯¹å®šä½çš„ mcp åˆ—è¡¨ç›¸å¯¹æ­¤å®šä½ */
}

html.dark .chat-input-area-vertical {
    background-color: var(--el-bg-color-input);
    border: 1px solid #414243;
}

.chat-textarea-vertical {
    width: 100%;
    flex-grow: 1;
}

.chat-textarea-vertical:deep(.el-textarea__inner) {
    background-color: transparent !important;
    box-shadow: none !important;
    border: none !important;
    padding: 0;
    color: var(--el-text-color-primary);
    font-size: 14px;
    line-height: 1.5;
    resize: none;
}

.input-actions-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    flex-shrink: 0;
}

.chat-input-area-vertical .action-buttons-left,
.chat-input-area-vertical .action-buttons-right {
    display: flex;
    align-items: center;
    gap: 4px;
}

.chat-input-area-vertical .action-buttons-left .el-button,
.chat-input-area-vertical .action-buttons-right .el-button {
    margin-left: 0 !important;
    margin-right: 0 !important;
}

.chat-input-area-vertical .action-buttons-left {
    margin-left: 0px;
}

.chat-input-area-vertical .action-buttons-right {
    margin-right: 0px;
}

.chat-input-area-vertical .el-button {
    width: 32px;
    height: 32px;
    background: none;
    border: none;
}

.chat-input-area-vertical .el-button:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.chat-input-area-vertical .action-buttons-left .el-button.is-active-special {
    color: var(--el-color-warning);
}

.chat-input-area-vertical .action-buttons-left .el-button:hover {
    color: var(--text-on-accent);
    background-color: var(--el-color-primary-light-8);
}

.chat-input-area-vertical .action-buttons-right .el-button:hover {
    color: var(--text-on-accent);
}

/* --- Common Styles --- */
:deep(.el-textarea.is-disabled .el-textarea__inner) {
    cursor: default !important;
    background-color: transparent !important;
}

:deep(.el-textarea__inner::-webkit-scrollbar) {
    width: 8px;
    height: 8px;
}

:deep(.el-textarea__inner::-webkit-scrollbar-track) {
    background: transparent;
    border-radius: 4px;
}

:deep(.el-textarea__inner::-webkit-scrollbar-thumb) {
    background: var(--el-text-color-disabled, #c0c4cc);
    border-radius: 4px;
    border: 2px solid transparent;
    background-clip: content-box;
}

:deep(.el-textarea__inner::-webkit-scrollbar-thumb:hover) {
    background: var(--el-text-color-secondary, #909399);
    background-clip: content-box;
}

html.dark :deep(.el-textarea__inner::-webkit-scrollbar-thumb) {
    background: #6b6b6b;
    background-clip: content-box;
}

html.dark :deep(.el-textarea__inner::-webkit-scrollbar-thumb:hover) {
    background: #999;
    background-clip: content-box;
}

.el-button.is-circle {
    color: var(--el-text-color-regular);
}

.el-button.is-circle:hover,
.el-button.is-circle:focus {
    color: var(--el-color-primary);
    background-color: var(--el-color-primary-light-8);
}

.el-button.is-circle[type="primary"] {
    background-color: var(--el-color-primary);
    color: #ffffff;
}

.el-button.is-circle[type="primary"]:hover,
.el-button.is-circle[type="primary"]:focus {
    background-color: var(--el-color-primary-light-3);
}

html.dark .el-button--danger.is-plain {
    color: #ffffff;
    background-color: var(--el-color-danger);
    border-color: var(--el-color-danger);
}

html.dark .el-button--danger.is-plain:hover,
html.dark .el-button--danger.is-plain:focus {
    background-color: var(--el-color-danger-light-3);
    border-color: var(--el-color-danger-light-3);
    color: #ffffff;
}

html.dark .el-button--success.is-plain {
    color: #ffffff;
    background-color: var(--el-color-success);
    border-color: var(--el-color-success);
}

html.dark .el-button--success.is-plain:hover,
html.dark .el-button--success.is-plain:focus {
    background-color: var(--el-color-success-light-3);
    border-color: var(--el-color-success-light-3);
    color: #ffffff;
}

/* Cancel Button Animation */
.cancel-button-animated {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.static-icon {
    font-size: 16px;
    z-index: 1;
    color: var(--el-text-color-regular);
}

.cancel-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin-left: -10px;
    margin-top: -10px;

    border: 2px solid transparent;
    border-top-color: var(--el-text-color-secondary);
    border-right-color: var(--el-text-color-secondary);
    border-radius: 50%;

    animation: spin 1s linear infinite;
    pointer-events: none;
    box-sizing: border-box;
}

html.dark .static-icon {
    color: var(--el-text-color-primary);
}

html.dark .cancel-spinner {
    border-top-color: var(--el-text-color-primary);
    border-right-color: var(--el-text-color-primary);
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
```
```vue
./Anywhere_window/src/components/ChatMessage.vue
<script setup>
import { computed, ref, nextTick } from 'vue';
import { Bubble, Thinking, XMarkdown } from 'vue-element-plus-x';
import { ElTooltip, ElButton, ElInput, ElCollapse, ElCollapseItem, ElIcon, ElCheckbox, ElTag } from 'element-plus';
import { DocumentCopy, Refresh, Delete, Document, CaretTop, CaretBottom, Edit, Check, Close, CloseBold } from '@element-plus/icons-vue';
import 'katex/dist/katex.min.css';
import DOMPurify from 'dompurify';

import { formatTimestamp, formatMessageText, sanitizeToolArgs } from '../utils/formatters.js';

const props = defineProps({
  message: Object,
  index: Number,
  isLastMessage: Boolean,
  isLoading: Boolean,
  userAvatar: String,
  aiAvatar: String,
  isCollapsed: Boolean,
  isDarkMode: Boolean,
  isAutoApprove: Boolean,
});

const emit = defineEmits(['copy-text', 're-ask', 'delete-message', 'toggle-collapse', 'avatar-click', 'edit-message', 'edit-message-requested', 'edit-finished', 'cancel-tool-call', 'confirm-tool', 'reject-tool', 'update-auto-approve']);
const editInputRef = ref(null);
const isEditing = ref(false);
const editedContent = ref('');

// æ ¼å¼åŒ–å·¥å…·å‚æ•°ä¸ºæ˜“è¯»çš„ JSON å­—ç¬¦ä¸²
const formatToolArgs = (argsString) => {
  try {
    const sanitized = sanitizeToolArgs(argsString);
    const obj = JSON.parse(sanitized);
    // 2 è¡¨ç¤ºç¼©è¿›ç©ºæ ¼æ•°
    return JSON.stringify(obj, null, 2);
  } catch (e) {
    return argsString;
  }
};

const preprocessKatex = (text) => {
  if (!text) return '';
  let processedText = text;

  // 1. æ›¿æ¢éæ ‡å‡†è¿å­—ç¬¦
  processedText = processedText.replace(/\u2013/g, '-').replace(/\u2014/g, '-');

  // 2. å°† \[ ... \] è½¬æ¢ä¸º $$ ... $$ (å—çº§å…¬å¼)
  processedText = processedText.replace(/\\\[([\s\S]*?)\\\]/g, '$$$$$1$$$$');

  // 3. å°† \( ... \) è½¬æ¢ä¸º $ ... $ (è¡Œå†…å…¬å¼)
  processedText = processedText.replace(/\\\(([\s\S]*?)\\\)/g, '$$$1$');

  // 4. å°† {align} å’Œ {equation} æ›¿æ¢ä¸º {aligned}
  // KaTeX åœ¨ $$...$$ å†…éƒ¨é€šå¸¸ä¸æ”¯æŒ align ç¯å¢ƒï¼ˆå®ƒæ˜¯é¡¶çº§ç¯å¢ƒï¼‰ã€‚
  // ä½¿ç”¨ aligned ç¯å¢ƒå¯ä»¥å®Œç¾è§£å†³æ¸²æŸ“é—®é¢˜ï¼ŒåŒæ—¶é…åˆä¸‹æ–¹çš„ \tag æ¨¡æ‹Ÿæ˜¾ç¤ºã€‚
  processedText = processedText.replace(/\\begin\{align\*?\}/g, '\\begin{aligned}');
  processedText = processedText.replace(/\\end\{align\*?\}/g, '\\end{aligned}');
  processedText = processedText.replace(/\\begin\{equation\*?\}/g, '\\begin{aligned}');
  processedText = processedText.replace(/\\end\{equation\*?\}/g, '\\end{aligned}');

  // 5. æ¨¡æ‹Ÿ LaTeX \tag{} æ˜¾ç¤º
  // ç”±äº aligned ç¯å¢ƒä¸æ”¯æŒåŸç”Ÿ \tagï¼Œæˆ–è€… Markdown æ¸²æŸ“å™¨ä¼šåæ‰åæ–œæ ï¼Œ
  // å°†å…¶æ›¿æ¢ä¸ºå³ä¾§é—´è· + æ–‡æœ¬çš„å½¢å¼ï¼š \qquad \text{(...)}
  processedText = processedText.replace(/(?<!\\)\\tag\s*\{([^{}]+)\}/g, '\\qquad \\text{($1)}');

  return processedText;
};

const mermaidConfig = computed(() => ({
  theme: props.isDarkMode ? 'dark' : 'neutral',
}));

const formatMessageContent = (content, role) => {
  if (!content) return "";
  if (!Array.isArray(content)) {
    if (String(content).toLowerCase().startsWith('file name:') && String(content).toLowerCase().endsWith('file end')) {
      return "";
    } else {
      return String(content);
    }
  }

  let markdownString = "";
  let i = 0;
  while (i < content.length) {
    const part = content[i];

    if (part.type === 'text' && part.text && part.text.toLowerCase().startsWith('file name:') && part.text.toLowerCase().endsWith('file end')) {
      i++;
      continue;
    } else if (part.type === 'image_url' && part.image_url?.url) {
      let imageGroupMarkdown = "";
      while (i < content.length && content[i].type === 'image_url' && content[i].image_url?.url) {
        imageGroupMarkdown += `![Image](${content[i].image_url.url}) `;
        i++;
      }
      markdownString += `\n\n${imageGroupMarkdown.trim()}\n\n`;
    } else if (part.type === 'input_audio' && part.input_audio?.data) {
      if (role === 'user') {
        markdownString += `\n\n<audio class="chat-audio-player" controls preload="none">\n<source id="${part.input_audio.format}" src="data:audio/${part.input_audio.format};base64,${part.input_audio.data}">\n</audio>\n`;
      } else {
        markdownString += `\n\n<audio class="chat-audio-player" controls autoplay preload="none">\n<source id="${part.input_audio.format}" src="data:audio/${part.input_audio.format};base64,${part.input_audio.data}">\n</audio>\n`;
      }
      i++;
    } else if (part.type === 'text' && part.text) {
      markdownString += part.text;
      i++;
    } else {
      i++;
    }
  }

  return markdownString;
};

const formatMessageFile = (content) => {
  let files = [];
  if (!Array.isArray(content)) {
    if (String(content).toLowerCase().startsWith('file name:') && String(content).toLowerCase().endsWith('file end')) files.push(String(content).split('\n')[0].replace('file name:', '').trim());
    else return [];
  } else {
    content.forEach(part => {
      if (part.type === 'text' && part.text && part.text.toLowerCase().startsWith('file name:') && part.text.toLowerCase().endsWith('file end')) files.push(part.text.split('\n')[0].replace('file name:', '').trim());
      else if (part.type === "input_file" && part.filename) files.push(part.filename);
      else if (part.type === "file" && part.file.filename) files.push(part.file.filename);
    });
  }
  return files;
};

const isEditable = computed(() => {
  if (props.message.role === 'user') return true;
  const content = props.message.content;
  if (typeof content === 'string') return true;
  if (Array.isArray(content)) {
    return content.some(part => part.type === 'text' && part.text && !(part.text.toLowerCase().startsWith('file name:')));
  }
  return false;
});

const switchToEditMode = () => {
  editedContent.value = formatMessageText(props.message.content);
  isEditing.value = true;
  nextTick(() => {
    editInputRef.value?.focus();
  });
};

const switchToShowMode = () => {
  isEditing.value = false;
};

defineExpose({ switchToEditMode, switchToShowMode });

const finishEdit = (action) => {
  isEditing.value = false;
  emit('edit-finished', {
    id: props.message.id,
    action: action,
    content: editedContent.value
  });
};

const handleEditKeyDown = (event) => {
  if (event.key === 'Escape') {
    event.preventDefault();
    finishEdit('cancel');
  } else if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
    event.preventDefault();
    finishEdit('save');
  }
};

const renderedMarkdownContent = computed(() => {
  const content = props.message.role ? props.message.content : props.message;
  const role = props.message.role ? props.message.role : 'user';
  let formattedContent = formatMessageContent(content, role);
  formattedContent = preprocessKatex(formattedContent);

  const protectedMap = new Map();
  let placeholderIndex = 0;
  const addPlaceholder = (text) => {
    const placeholder = `__PROTECTED_CONTENT_${placeholderIndex++}__`;
    protectedMap.set(placeholder, text);
    return placeholder;
  };

  // 1. ä¿æŠ¤ä»£ç å—å’Œæ•°å­¦å…¬å¼ä¸è¢« DOMPurify å¤„ç†
  let processedContent = formattedContent.replace(/(^|[^\\])(`+)([\s\S]*?)\2/g, (match, prefix, delimiter, inner) => {
    return prefix + addPlaceholder(delimiter + inner + delimiter);
  });
  processedContent = processedContent.replace(/(\$\$)([\s\S]*?)(\$\$)/g, (match) => addPlaceholder(match));
  processedContent = processedContent.replace(/(\$)(?!\s)([^$\n]+?)(?<!\s)(\$)/g, (match) => addPlaceholder(match));
  processedContent = processedContent.replace(/(^|[^\\])\*\*([^\n]+?)\*\*/g, '$1<strong>$2</strong>');

  // 2. è¿›è¡Œ HTML æ¸…æ´—
  let sanitizedPart = DOMPurify.sanitize(processedContent, {
    ADD_TAGS: ['video', 'audio', 'source'],
    USE_PROFILES: { html: true, svg: true, svgFilters: true },
    ADD_ATTR: ['style']
  });

  // å…¨å±€å°† &gt; æ¢å¤ä¸º >
  // DOMPurify ä¼šå°† Markdown çš„å¼•ç”¨ç¬¦å· ">" è½¬ä¹‰ä¸º "&gt;"ï¼Œå¯¼è‡´æ— æ³•æ¸²æŸ“ä¸ºå¼•ç”¨å—ã€‚
  // è¿™é‡Œå°†å…¶è¿˜åŸã€‚ç”±äºæˆ‘ä»¬ä¸è¿˜åŸ &lt; (<)ï¼Œæ‰€ä»¥ä¸ä¼šå¼•å…¥ XSS é£é™©ï¼ˆæ— æ³•æ„é€  <script> æ ‡ç­¾ï¼‰ã€‚
  sanitizedPart = sanitizedPart.replace(/&gt;/g, '>');

  // 3. æ¢å¤å—ä¿æŠ¤çš„å†…å®¹ï¼ˆä»£ç å—ç­‰ï¼‰
  const finalContent = sanitizedPart.replace(/__PROTECTED_CONTENT_\d+__/g, (placeholder) => {
    return protectedMap.get(placeholder) || placeholder;
  });

  if (!finalContent && props.message.role === 'assistant') return ' ';
  return finalContent || ' ';
});

const shouldShowCollapseButton = computed(() => {
  if (!props.isLastMessage) return true;
  if (props.isLastMessage) return !props.isLoading;
  return false;
});

const onCopy = () => {
  if (props.isLoading && props.isLastMessage) return;
  emit('copy-text', formatMessageText(props.message.content), props.index);
};
const onReAsk = () => emit('re-ask');
const onDelete = () => emit('delete-message', props.index);
const onToggleCollapse = (event) => emit('toggle-collapse', props.index, event);
const onAvatarClick = (role, event) => emit('avatar-click', role, event);
const truncateFilename = (filename, maxLength = 30) => {
  if (typeof filename !== 'string' || filename.length <= maxLength) return filename;
  const ellipsis = '...';
  const lastDotIndex = filename.lastIndexOf('.');
  if (lastDotIndex === -1 || lastDotIndex < 10) return filename.substring(0, maxLength - ellipsis.length) + ellipsis;
  const nameWithoutExt = filename.substring(0, lastDotIndex);
  const extension = filename.substring(lastDotIndex);
  const charsToKeep = maxLength - extension.length - ellipsis.length;
  if (charsToKeep < 1) return ellipsis + extension;
  return nameWithoutExt.substring(0, charsToKeep) + ellipsis + extension;
};
</script>

<template>
  <div class="chat-message" v-if="message.role !== 'system'">

    <!-- ç”¨æˆ·æ¶ˆæ¯ -->
    <div v-if="message.role === 'user'" class="message-wrapper user-wrapper">
      <div class="message-meta-header user-meta-header">
        <span class="timestamp" v-if="message.timestamp">{{ formatTimestamp(message.timestamp) }}</span>
        <img :src="userAvatar" alt="User Avatar" @click="onAvatarClick('user', $event)"
          class="chat-avatar-top user-avatar">
      </div>

      <Bubble class="user-bubble" placement="end" shape="corner" maxWidth="100%">
        <template #content>
          <div v-if="!isEditing" class="markdown-wrapper" :class="{ 'collapsed': isCollapsed }">
            <XMarkdown :markdown="renderedMarkdownContent" :is-dark="isDarkMode" :enable-latex="true"
              :mermaid-config="mermaidConfig" :default-theme-mode="isDarkMode ? 'dark' : 'light'"
              :themes="{ light: 'github-light', dark: 'github-dark-default' }" :allow-html="true" />
          </div>
          <div v-else class="editing-wrapper">
            <el-input ref="editInputRef" v-model="editedContent" type="textarea" :autosize="{ minRows: 1, maxRows: 15 }"
              resize="none" @keydown="handleEditKeyDown" />
            <div class="editing-actions">
              <span class="edit-shortcut-hint">Ctrl+Enter ç¡®è®¤ / Esc å–æ¶ˆ</span>
              <el-button :icon="Check" @click="finishEdit('save')" size="small" circle type="primary" />
              <el-button :icon="Close" @click="finishEdit('cancel')" size="small" circle />
            </div>
          </div>
        </template>
        <template #footer>
          <div class="message-footer">
            <div class="footer-wrapper">
              <div class="footer-actions">
                <el-button :icon="DocumentCopy" @click="onCopy" size="small" circle />
                <el-button v-if="isEditable" :icon="Edit" @click="emit('edit-message-requested', index)" size="small"
                  circle />
                <el-button v-if="shouldShowCollapseButton" :icon="isCollapsed ? CaretBottom : CaretTop"
                  @click="onToggleCollapse($event)" size="small" circle />
                <el-button v-if="isLastMessage" :icon="Refresh" @click="onReAsk" size="small" circle />
                <el-button :icon="Delete" size="small" @click="onDelete" circle />
              </div>
              <div class="message-files-vertical-list" v-if="formatMessageFile(message.content).length > 0">
                <el-tooltip v-for="(file_name, idx) in formatMessageFile(message.content)" :key="idx"
                  :content="file_name" placement="top" :disabled="file_name.length < 30"
                  :popper-style="{ maxWidth: '30vw', wordBreak: 'break-all' }">
                  <el-button class="file-button" type="info" plain size="small" :icon="Document">{{
                    truncateFilename(file_name, 20) }}</el-button>
                </el-tooltip>
              </div>
            </div>
          </div>
        </template>
      </Bubble>
    </div>

    <!-- AI æ¶ˆæ¯ -->
    <div v-if="message.role === 'assistant'" class="message-wrapper ai-wrapper">
      <div class="message-meta-header ai-meta-header">
        <img :src="aiAvatar" alt="AI Avatar" @click="onAvatarClick('assistant', $event)"
          class="chat-avatar-top ai-avatar">
        <div class="meta-info-column">
          <div class="meta-name-row">
            <span class="ai-name">{{ message.aiName }}</span>
            <span v-if="message.voiceName" class="voice-name">({{ message.voiceName }})</span>
          </div>
          <span class="timestamp-row" v-if="message.completedTimestamp">{{ formatTimestamp(message.completedTimestamp)
          }}</span>
        </div>
      </div>

      <Bubble class="ai-bubble" placement="start" shape="corner" maxWidth="100%"
        :loading="isLastMessage && isLoading && renderedMarkdownContent === ' ' && (!message.tool_calls || message.tool_calls.length === 0)">
        <template #header>
          <Thinking v-if="message.reasoning_content && message.reasoning_content.trim().length > 0" maxWidth="90%"
            :content="(message.reasoning_content || '').trim()" :modelValue="false" :status="message.status">
          </Thinking>
        </template>
        <template #content>
          <div v-if="!isEditing" class="markdown-wrapper" :class="{ 'collapsed': isCollapsed }">
            <XMarkdown :markdown="renderedMarkdownContent" :is-dark="isDarkMode" :enable-latex="true"
              :mermaid-config="mermaidConfig" :default-theme-mode="isDarkMode ? 'dark' : 'light'"
              :themes="{ light: 'one-light', dark: 'vesper' }" :allow-html="true" />
          </div>
          <div v-else class="editing-wrapper">
            <el-input ref="editInputRef" v-model="editedContent" type="textarea" :autosize="{ minRows: 1, maxRows: 15 }"
              resize="none" @keydown="handleEditKeyDown" />
            <div class="editing-actions">
              <span class="edit-shortcut-hint">Ctrl+Enter ç¡®è®¤ / Esc å–æ¶ˆ</span>
              <el-button :icon="Check" @click="finishEdit('save')" size="small" circle type="primary" />
              <el-button :icon="Close" @click="finishEdit('cancel')" size="small" circle />
            </div>
          </div>
          <div v-if="message.tool_calls && message.tool_calls.length > 0" class="tool-calls-container">
            <div v-for="toolCall in message.tool_calls" :key="toolCall.id" class="single-tool-wrapper">
              <el-collapse class="tool-collapse"
                :model-value="(!isAutoApprove && (toolCall.approvalStatus === 'waiting' || toolCall.approvalStatus === 'executing')) ? [toolCall.id] : []">
                <el-collapse-item :name="toolCall.id">
                  <template #title>
                    <div class="tool-call-title">
                      <el-icon class="tool-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="m15 12-8.373 8.373a1 1 0 0 1-3-3L12 9"></path>
                          <path d="m18 15 4-4"></path>
                          <path
                            d="m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172V7l-2.26-2.26a6 6 0 0 0-4.202-1.756L9 2.96l.92.82A6.18 6.18 0 0 1 12 8.4V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5">
                          </path>
                        </svg>
                      </el-icon>
                      <span class="tool-name">{{ toolCall.name }}</span>
                      <div class="tool-header-right">
                        <el-tag v-if="toolCall.approvalStatus === 'waiting'" type="warning" size="small" effect="light"
                          round>ç­‰å¾…æ‰¹å‡†</el-tag>
                        <el-tag v-else-if="toolCall.approvalStatus === 'executing'" type="primary" size="small"
                          effect="light" round>æ‰§è¡Œä¸­</el-tag>
                        <el-tag v-else-if="toolCall.approvalStatus === 'rejected'" type="danger" size="small"
                          effect="plain" round>å·²æ‹’ç»</el-tag>
                        <el-tag v-else-if="toolCall.approvalStatus === 'finished'" type="success" size="small"
                          effect="plain" round>å®Œæˆ</el-tag>
                        <el-tooltip content="åœæ­¢æ‰§è¡Œ" placement="top" v-if="toolCall.approvalStatus === 'executing'">
                          <div class="stop-btn-wrapper" @click.stop="$emit('cancel-tool-call', toolCall.id)">
                            <el-icon>
                              <CloseBold />
                            </el-icon>
                          </div>
                        </el-tooltip>
                      </div>
                    </div>
                  </template>
                  <div class="tool-call-details">
                    <div class="tool-detail-section">
                      <strong>å‚æ•°:</strong>
                      <pre><code>{{ formatToolArgs(toolCall.args) }}</code></pre>
                    </div>
                    <div class="tool-detail-section"
                      v-if="toolCall.result && toolCall.result !== 'ç­‰å¾…æ‰¹å‡†...' && toolCall.result !== 'æ‰§è¡Œä¸­...'">
                      <strong>ç»“æœ:</strong>
                      <div class="tool-result-wrapper">
                        <pre><code>{{ toolCall.result }}</code></pre>
                      </div>
                    </div>
                  </div>
                </el-collapse-item>
              </el-collapse>
              <div v-if="toolCall.approvalStatus === 'waiting'" class="tool-approval-actions">
                <div class="actions-left">
                  <el-button type="primary" size="small" :icon="Check"
                    @click="$emit('confirm-tool', toolCall.id, true)">ç¡®è®¤</el-button>
                  <el-button size="small" :icon="Close" @click="$emit('reject-tool', toolCall.id, false)">å–æ¶ˆ</el-button>
                </div>
                <div class="actions-right">
                  <el-checkbox :model-value="isAutoApprove" @change="(val) => $emit('update-auto-approve', val)"
                    label="è‡ªåŠ¨æ‰¹å‡†åç»­è°ƒç”¨" size="small" />
                </div>
              </div>
            </div>
          </div>
        </template>
        <template #footer>
          <div class="message-footer">
            <div class="footer-actions">
              <el-button :icon="DocumentCopy" @click="onCopy" size="small" circle />
              <el-button v-if="isEditable" :icon="Edit" @click="emit('edit-message-requested', index)" size="small"
                circle />
              <el-button v-if="shouldShowCollapseButton" :icon="isCollapsed ? CaretBottom : CaretTop"
                @click="onToggleCollapse($event)" size="small" circle />
              <el-button v-if="isLastMessage" :icon="Refresh" @click="onReAsk" size="small" circle />
              <el-button :icon="Delete" size="small" @click="onDelete" circle />
            </div>
          </div>
        </template>
      </Bubble>
    </div>
  </div>
</template>

<style scoped lang="less">
/* ä½¿ç”¨ä¸åŸæ–‡ä»¶ç›¸åŒçš„æ ·å¼ */
.chat-message {
  margin: 15px 0 0 0;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
  padding: 0px;
}

.message-wrapper {
  display: flex;
  flex-direction: column;
}

.user-wrapper {
  align-self: flex-end;
  align-items: flex-end;
  max-width: 90%;
  margin-right: 4%;
  margin-left: 5%;
}

.ai-wrapper {
  align-self: flex-start;
  align-items: flex-start;
  margin-left: 5%;
  margin-right: 5%;
  max-width: 100%;
}

.message-meta-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 4px;
  font-size: 12px;
  color: var(--el-text-color-secondary);
}

.user-meta-header {
  flex-direction: row;
  margin-bottom: 8px;
}

.ai-meta-header {
  flex-direction: row;
  align-items: flex-start;
}

.meta-info-column {
  display: flex;
  flex-direction: column;
  justify-content: center;
  line-height: 1.3;
}

.meta-name-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.timestamp-row {
  font-size: 11px;
  color: var(--el-text-color-placeholder);
  margin-top: 1px;
}

.chat-avatar-top {
  width: 32px;
  height: 32px;
  cursor: pointer;
  object-fit: cover;
  transition: transform 0.2s;

  &:hover {
    transform: scale(1.1);
  }
}

.user-avatar {
  border-radius: 50%;
}

.ai-avatar {
  border-radius: 6px;
}

.ai-name {
  font-weight: 700;
  font-size: 13px;
  color: var(--el-text-color-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.chat-message .user-bubble {
  :deep(.el-bubble-content-wrapper .el-bubble-content) {
    border-radius: 18px;
    background-color: var(--el-bg-color-userbubble);
    padding-top: 10px;
    padding-bottom: 10px;
    margin-bottom: 0px;
    padding-right: 14px;
  }

  :deep(.el-bubble-content-wrapper .el-bubble-footer) {
    margin-top: 0;
  }
}

html.dark .chat-message .user-bubble {
  :deep(.el-bubble-content-wrapper .el-bubble-content) {
    background: #393939;
    border: #383838 0px solid;
  }
}

.chat-message .ai-bubble {
  :deep(.el-bubble-content-wrapper .el-bubble-content) {
    background-color: transparent;
    padding-left: 4px;
    padding-right: 0px;
    padding-bottom: 2px;
    padding-top: 4px;
  }

  :deep(.el-bubble-content-wrapper .el-bubble-footer) {
    margin-top: 0;
  }
}

html.dark .chat-message .ai-bubble {
  :deep(.el-bubble-content-wrapper .el-bubble-content) {
    background: var(--el-bg-color);
  }
}

.markdown-wrapper {
  width: 100%;
  min-width: 0;
  display: grid;
  grid-template-columns: minmax(0, 1fr);

  :deep(.elx-xmarkdown-container) {
    background: transparent !important;
    padding: 0;
    color: var(--text-primary);
    font-size: 14px;
    line-height: 1.5;
    tab-size: 4;
    font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    word-break: break-word;
  }

  :deep(pre) {
    max-width: 100%;
    overflow-x: auto;
    white-space: pre;
    box-sizing: border-box;
    border-radius: 6px;
  }

  :deep(.katex) {
    font-size: 1.2em !important;
  }

  :deep(.katex-display > .katex > .katex-html) {
    padding-bottom: 8px !important;
    scrollbar-width: thin;
    scrollbar-color: var(--el-text-color-disabled) transparent;

    &::-webkit-scrollbar {
      height: 6px;
    }

    &::-webkit-scrollbar-track {
      background: transparent;
    }

    &::-webkit-scrollbar-thumb {
      background-color: var(--el-text-color-disabled);
      border-radius: 3px;
    }

    &::-webkit-scrollbar-thumb:hover {
      background-color: var(--el-text-color-secondary);
    }
  }

  :deep(img) {
    max-width: min(50vw, 400px);
    max-height: min(50vh, 300px);
    width: auto;
    height: auto;
    display: inline-block;
    vertical-align: middle;
    margin: 4px;
    border-radius: 8px;
    object-fit: cover;
  }

  :deep(.chat-audio-player) {
    width: 100%;
    min-width: 40vw;
    height: 48px;
    accent-color: var(--text-primary);

    &::-webkit-media-controls-enclosure {
      background: none;
      border-radius: 24px;
    }

    &::-webkit-media-controls-panel {
      background-color: var(--bg-tertiary, #F0F0F0);
      border-radius: 24px;
      padding: 0 10px 0 10px;
      justify-content: center;
    }

    &::-webkit-media-controls-play-button {
      color: var(--text-primary);
      border-radius: 50%;

      &:hover {
        background-color: rgba(0, 0, 0, 0.05);
      }
    }

    &::-webkit-media-controls-current-time-display,
    &::-webkit-media-controls-time-remaining-display {
      color: var(--text-secondary);
      font-size: 13px;
      text-shadow: none;
    }

    &::-webkit-media-controls-timeline {
      border-radius: 3px;
      height: 6px;
      margin: 0 10px;
    }

    &::-webkit-media-controls-mute-button,
    &::-webkit-media-controls-overflow-button {
      color: var(--text-secondary);
      border-radius: 50%;

      &:hover {
        background-color: rgba(0, 0, 0, 0.05);
      }
    }
  }

  html.dark & :deep(.chat-audio-player) {
    accent-color: var(--text-primary);

    &::-webkit-media-controls-panel {
      background-color: var(--bg-tertiary, #2c2e33);
    }

    &::-webkit-media-controls-play-button,
    &::-webkit-media-controls-mute-button,
    &::-webkit-media-controls-overflow-button,
    &::-webkit-media-controls-current-time-display,
    &::-webkit-media-controls-time-remaining-display {
      filter: invert(1);
    }

    &::-webkit-media-controls-play-button:hover,
    &::-webkit-media-controls-mute-button:hover,
    &::-webkit-media-controls-overflow-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    &::-webkit-media-controls-timeline {
      background-color: transparent;
    }
  }

  :deep(p:last-of-type) {
    margin-bottom: 0;
  }

  :deep(p) {
    margin-bottom: 1em;
  }

  :deep(ul),
  :deep(ol) {
    margin-bottom: 1em;
  }

  :deep(strong),
  :deep(b) {
    font-weight: 600 !important;
  }

  :deep(h1),
  :deep(h2),
  :deep(h3),
  :deep(h4),
  :deep(h5),
  :deep(h6) {
    font-weight: 600;
    line-height: 1.25;
    margin-top: 0.5em;
    margin-bottom: 0.8em;
    padding-bottom: 0.3em;
    border-bottom: 1px solid #d0d7de;
  }

  :deep(h1) {
    font-size: 1.8em;
  }

  :deep(h2) {
    font-size: 1.5em;
  }

  :deep(h3) {
    font-size: 1.3em;
  }

  :deep(h4) {
    font-size: 1.15em;
  }

  :deep(h5) {
    font-size: 1em;
  }

  :deep(h6) {
    font-size: 0.9em;
    color: #656d76;
  }

  :deep(blockquote) {
    margin: 1em 0;
    padding: 0.5em 1em;
    border-left: 4px solid #b3b3b3;
    background-color: rgba(0, 0, 0, 0.035) !important;
    color: var(--el-text-color-secondary);
    border-radius: 0 8px 8px 0;

    html.dark & {
      border-left-color: #656565;
      background-color: rgba(255, 255, 255, 0.05) !important;
    }
  }

  :deep(blockquote p) {
    margin-bottom: 0.5em;
  }

  :deep(blockquote p:last-child) {
    margin-bottom: 0;
  }

  :deep(pre code),
  :deep(.inline-code-tag) {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    font-size: 1em;
  }

  :deep(.inline-code-tag) {
    padding: 0.2em 0.4em;
    margin: 0;
    border-radius: 4px;
    background-color: rgba(175, 184, 193, 0.2);
  }

  html:not(.dark) & :deep(pre.shiki) {
    background-color: #f6f8fa !important;
  }

  html.dark & {

    :deep(h1),
    :deep(h2),
    :deep(h3),
    :deep(h4),
    :deep(h5) {
      border-bottom-color: #373A40;
    }

    :deep(h6) {
      color: #8b949e;
    }

    :deep(hr) {
      background-color: #373A40 !important;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    :deep(table) {
      display: block;
      overflow-x: auto;
      width: 100%;
      max-width: 100%;
      border-spacing: 0;
      border-collapse: collapse;
      margin-bottom: 1em;

      /* ä¼˜åŒ–è¡¨æ ¼æ»šåŠ¨æ¡æ ·å¼ */
      &::-webkit-scrollbar {
        height: 6px;
      }

      &::-webkit-scrollbar-track {
        background: transparent;
      }

      &::-webkit-scrollbar-thumb {
        background-color: var(--el-text-color-disabled);
        border-radius: 3px;
      }

      &::-webkit-scrollbar-thumb:hover {
        background-color: var(--el-text-color-secondary);
      }
    }

    :deep(th) {
      background-color: #2c2e33;
      min-width: 60px;
    }

    :deep(tr) {
      background-color: #212327;
      border-top: 1px solid #373A40;
    }

    :deep(tr:nth-child(2n)) {
      background-color: #25272b;
    }

    :deep(td) {
      border-color: #373A40;
      min-width: 60px;
    }

    :deep(.pre-md) {
      border: 0px solid #373A40;
    }

    :deep(.inline-code-tag) {
      background-color: rgba(110, 118, 129, 0.4);
      color: #c9d1d9;
    }
  }

  :deep(.markdown-mermaid) {
    background-color: transparent;
    max-width: 100%;
    overflow-x: auto;
    padding: 5px;
    border-radius: 8px;
    box-sizing: border-box;

    .mermaid-content {
      background-color: rgba(245, 245, 245, 0.5);
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    html.dark & {
      color: var(--el-text-color-primary) !important;
    }

    .toolbar-container {
      border-radius: 18px;
    }

    .mermaid-toolbar {
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;

      html.dark & {
        background-color: rgba(39, 39, 39, 1);

        .el-tabs__nav {
          background-color: #2c2e33;
        }
        .el-tabs__item.is-active {
          color: #202123 !important;
        }
        .el-tabs__item:hover {
          color: #202123 !important;
        }
      }
    }

    .mermaid-source-code {
      border: hidden;
      border-top-left-radius: 0px;
      border-top-right-radius: 0px;
      background-color: rgba(248, 249, 250, 0.5);
      padding-bottom: 0px;

      &::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      &::-webkit-scrollbar-track {
        background: transparent;
      }

      &::-webkit-scrollbar-thumb {
        background-color: var(--el-border-color-darker, #4C4D4F);
        border-radius: 4px;
      }

      &::-webkit-scrollbar-thumb:hover {
        background-color: var(--el-text-color-secondary);
      }

      &::-webkit-scrollbar-corner {
        background: transparent;
      }

      html.dark & {
        background-color: rgba(23, 23, 23, 0.5);
        color: var(--el-text-color-primary);
      }
    }
  }

  &.collapsed :deep(.elx-xmarkdown-container) {
    max-height: 3.4em;
    position: relative;
    overflow: hidden;
    -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
    mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
  }
}

.editing-wrapper {
  width: 100%;
  min-width: 70vw;

  .el-textarea {
    margin-bottom: 8px;

    :deep(.el-textarea__inner) {
      background-color: #ECECEC;
      box-shadow: none !important;
      border: 1px solid var(--el-border-color-light);
      color: var(--el-text-color-primary);
    }

    :deep(.el-textarea__inner::-webkit-scrollbar) {
      width: 8px;
      height: 8px;
    }

    :deep(.el-textarea__inner::-webkit-scrollbar-track) {
      background: transparent;
      border-radius: 4px;
    }

    :deep(.el-textarea__inner::-webkit-scrollbar-thumb) {
      background: var(--el-text-color-disabled, #c0c4cc);
      border-radius: 4px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

    :deep(.el-textarea__inner::-webkit-scrollbar-thumb:hover) {
      background: var(--el-text-color-secondary, #909399);
      background-clip: content-box;
    }

    html.dark & :deep(.el-textarea__inner::-webkit-scrollbar-thumb) {
      background: #6b6b6b;
    }

    html.dark & :deep(.el-textarea__inner::-webkit-scrollbar-thumb:hover) {
      background: #999;
    }
  }

  .editing-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;

    .el-button--primary {
      --el-button-bg-color: var(--bg-accent);
      --el-button-border-color: var(--bg-accent);
      --el-button-text-color: var(--text-on-accent);
    }

    .el-button--primary:hover {
      --el-button-hover-bg-color: var(--bg-accent-light);
      --el-button-hover-border-color: var(--bg-accent-light);
    }
  }

  .edit-shortcut-hint {
    font-size: 12px;
    color: var(--el-text-color-placeholder);
    margin-right: auto;
    align-self: center;
  }
}

html.dark .editing-wrapper {
  .el-textarea :deep(.el-textarea__inner) {
    background-color: #424242;
    border-color: var(--border-primary);
    color: var(--text-primary);
  }

  .editing-actions .el-button--primary {
    --el-button-hover-bg-color: #e0e0e0;
    --el-button-hover-border-color: #e0e0e0;
  }
}

.message-files-vertical-list {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
  padding-right: 5px;
  max-height: 150px;
  overflow-y: auto;

  &::-webkit-scrollbar {
    width: 8px !important;
    height: 8px !important;
  }

  &::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 4px;
  }

  &::-webkit-scrollbar-thumb {
    background: var(--el-text-color-disabled, #c0c4cc);
    border-radius: 4px;
    border: 2px solid transparent;
    background-clip: content-box;
  }

  &::-webkit-scrollbar-thumb:hover {
    background: var(--el-text-color-secondary, #909399);
    background-clip: content-box;
  }

  .file-button {
    width: auto;
    justify-content: flex-start;
    border: none;
    background-color: var(--el-fill-color-light);
    color: var(--el-color-info);
  }

  .file-button:hover {
    border: none;
    background-color: var(--el-fill-color-lighter);
    color: var(--el-color-info);
  }
}

html.dark .message-files-vertical-list {
  &::-webkit-scrollbar {
    width: 8px !important;
    height: 8px !important;
  }

  &::-webkit-scrollbar-thumb {
    background: #6b6b6b;
    border-radius: 4px;
    border: 2px solid transparent;
    background-clip: content-box;
  }

  &::-webkit-scrollbar-thumb:hover {
    background: #999;
  }

  .file-button {
    background-color: var(--el-fill-color-dark);
    color: var(--el-text-color-regular);
  }

  .file-button:hover {
    background-color: var(--el-fill-color-darker);
    color: var(--el-text-color-regular);
  }
}

.ai-name {
  font-weight: 600;
  color: var(--el-text-color-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

html.dark .ai-name {
  color: var(--el-text-color-regular);
}

.voice-name {
  opacity: 0.8;
  white-space: nowrap;
  flex-shrink: 0;
  margin-right: 8px;
}

.message-footer {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  width: 100%;
  margin-top: 8px;
}

.footer-actions {
  display: flex;
  align-items: center;
  gap: 0px;
}

.footer-wrapper {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
}

.user-bubble .footer-actions {
  margin-left: auto;
}

.ai-bubble .footer-actions {
  margin-right: auto;
}

.timestamp {
  margin-top: 12px;
  font-size: 0.75rem;
  opacity: 0.8;
  white-space: nowrap;
  flex-shrink: 0;
}

html.dark .ai-bubble :deep(.el-thinking .trigger) {
  background-color: var(--el-fill-color-darker, #2c2e33);
  color: var(--el-text-color-primary, #F9FAFB);
  border-color: var(--el-border-color-dark, #373A40);
}

html.dark .ai-bubble :deep(.el-thinking .el-icon) {
  color: var(--el-text-color-secondary, #A0A5B1);
}

html.dark .ai-bubble :deep(.el-thinking-popper) {
  max-width: 85vw;
  background-color: var(--bg-tertiary, #2c2e33) !important;
  border-color: var(--border-primary, #373A40) !important;
}

html.dark .ai-bubble :deep(.el-thinking-popper .el-popper__arrow::before) {
  background: var(--bg-tertiary, #2c2e33) !important;
  border-color: var(--border-primary, #373A40) !important;
}

.ai-bubble :deep(.el-thinking .content pre) {
  max-width: 100%;
  margin-bottom: 10px;
  white-space: pre-wrap;
  word-break: break-word;
  box-sizing: border-box;
}

html.dark .ai-bubble :deep(.el-thinking .content pre) {
  background-color: var(--el-fill-color-darker);
  color: var(--el-text-color-regular, #E5E7EB);
  border: 1px solid var(--border-primary, #373A40);
}

.tool-calls-container {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.single-tool-wrapper {
  width: 100%;
  max-width: 85vw;
  min-width: 250px;
  display: flex;
  flex-direction: column;
}

.tool-collapse {
  width: 100%;
  border: none;
  --el-collapse-header-height: 38px;

  :deep(.el-collapse-item__header) {
    background-color: var(--el-fill-color-light);
    border: 1px solid var(--el-border-color-lighter);
    border-radius: 8px;
    padding: 0 12px;
    font-size: 13px;
    transition: border-radius 0.2s;

    &:active {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom-color: transparent;
    }
  }

  :deep(.el-collapse-item__wrap) {
    background-color: transparent;
    border: 1px solid var(--el-border-color-lighter);
    border-top: none;
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
  }

  :deep(.el-collapse-item__content) {
    padding: 12px;
  }
}

.tool-call-title {
  display: flex;
  align-items: center;
  width: 100%;
  gap: 8px;
}

.tool-name {
  font-weight: 500;
  color: var(--el-text-color-primary);
}

.tool-icon {
  color: var(--el-text-color-secondary);
}

.tool-header-right {
  margin-left: auto;
  margin-right: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.stop-btn-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s ease;
  background-color: var(--el-text-color-primary);
  color: var(--el-bg-color);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);

  &:hover {
    opacity: 0.85;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  &:active {
    transform: scale(0.95);
  }
}

html.dark .stop-btn-wrapper {
  background-color: #E5EAF3;
  color: #141414;

  &:hover {
    background-color: #ffffff;
  }
}

.tool-approval-actions {
  margin-top: -2px;
  margin-left: 1px;
  margin-right: 1px;
  padding: 8px 12px;
  background-color: var(--el-fill-color-lighter);
  border: 1px solid var(--el-border-color-lighter);
  border-top: 1px dashed var(--el-border-color-lighter);
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  animation: slide-in 0.2s ease-out;
}

@keyframes slide-in {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.actions-left {
  display: flex;
  gap: 10px;
}

.actions-right {
  margin-left: auto;

  :deep(.el-checkbox__label) {
    font-size: 12px;
    color: var(--el-text-color-secondary);
  }
}

.tool-call-details {
  .tool-detail-section {
    margin-bottom: 10px;

    &:last-child {
      margin-bottom: 0;
    }

    strong {
      display: block;
      margin-bottom: 5px;
      font-size: 13px;
      color: var(--el-text-color-secondary);
    }

    pre {
      margin: 0;
      padding: 8px;
      border-radius: 6px;
      background-color: var(--el-fill-color-light);
      max-height: 150px;
      overflow: auto;
      font-size: 12px;
      white-space: pre-wrap; 
      word-break: break-all;

      code {
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        color: var(--el-text-color-primary);
      }
    }
  }
}

.tool-call-details .tool-detail-section pre::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.tool-call-details .tool-detail-section pre::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 4px;
}

.tool-call-details .tool-detail-section pre::-webkit-scrollbar-thumb {
  background: var(--el-text-color-disabled, #c0c4cc);
  border-radius: 4px;
  border: 2px solid var(--el-fill-color-light);
  background-clip: content-box;
}

.tool-call-details .tool-detail-section pre::-webkit-scrollbar-thumb:hover {
  background: var(--el-text-color-secondary, #909399);
  background-clip: content-box;
}

.tool-result-wrapper {
  display: flex;
  align-items: flex-start;
}

.tool-result-wrapper pre {
  flex-grow: 1;
}

html.dark .tool-collapse {
  :deep(.el-collapse-item__header) {
    background-color: var(--el-fill-color-darker);
    border-color: var(--el-border-color-dark);
  }

  :deep(.el-collapse-item__wrap) {
    border-color: var(--el-border-color-dark);
  }
}

html.dark .stop-btn-wrapper:hover {
  background-color: rgba(245, 108, 108, 0.2);
  color: #F56C6C;
}

html.dark .tool-approval-actions {
  background-color: var(--el-fill-color-dark);
  border-color: var(--el-border-color-dark);
  border-top-color: var(--el-border-color-dark);
}

html.dark .tool-call-details {
  .tool-detail-section pre {
    background-color: var(--el-fill-color-darker);
  }
}

html.dark .tool-call-details .tool-detail-section pre::-webkit-scrollbar-thumb {
  background: #6b6b6b;
  border-color: var(--el-fill-color-darker);
}

html.dark .tool-call-details .tool-detail-section pre::-webkit-scrollbar-thumb:hover {
  background: #999;
}
</style>
```
```vue
./Anywhere_window/src/components/ModelSelectionDialog.vue
<script setup>
import { ref, computed } from 'vue';
import { ElDialog, ElTable, ElTableColumn, ElButton, ElInput, ElTooltip } from 'element-plus';
import { Search } from '@element-plus/icons-vue';

const props = defineProps({
    modelValue: Boolean, // for v-model
    modelList: Array,
    currentModel: String,
});

const emit = defineEmits(['update:modelValue', 'select', 'save-model']);

const searchQuery = ref('');
const searchInputRef = ref(null);

const handleOpened = () => {
    if (searchInputRef.value) {
        searchInputRef.value.focus();
    }
};

const filteredModelList = computed(() => {
    if (!searchQuery.value) {
        return props.modelList;
    }
    const lowerCaseQuery = searchQuery.value.toLowerCase();
    return props.modelList.filter(model =>
        model.label.toLowerCase().includes(lowerCaseQuery)
    );
});

const tableSpanMethod = ({ row, column, rowIndex, columnIndex }) => {
    if (columnIndex === 0) {
        if (rowIndex > 0 && filteredModelList.value[rowIndex - 1].label.split("|")[0] === row.label.split("|")[0]) {
            return { rowspan: 0, colspan: 0 };
        }
        let rowspan = 1;
        for (let i = rowIndex + 1; i < filteredModelList.value.length; i++) {
            if (filteredModelList.value[i].label.split("|")[0] === row.label.split("|")[0]) {
                rowspan++;
            } else {
                break;
            }
        }
        return { rowspan: rowspan, colspan: 1 };
    }
};

const onModelClick = (model) => {
    if (model.value === props.currentModel) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ¨¡å‹ï¼Œè§¦å‘ä¿å­˜äº‹ä»¶
        emit('save-model', model.value);
    } else {
        // å¦åˆ™ï¼Œè§¦å‘é€‰æ‹©äº‹ä»¶
        emit('select', model.value);
    }
};

const handleClose = () => {
    searchQuery.value = ''; // å…³é—­æ—¶æ¸…ç©ºæœç´¢è¯
    emit('update:modelValue', false);
};
</script>

<template>
    <el-dialog 
        :model-value="modelValue" 
        @update:model-value="handleClose" 
        width="80%"
        custom-class="model-dialog no-header-dialog" 
        @opened="handleOpened"
        :show-close="false"
    >
        <!-- ç§»é™¤é»˜è®¤æ ‡é¢˜æ  -->
        <template #header>
            <div style="display: none;"></div>
        </template>

        <div class="model-search-container">
            <el-input ref="searchInputRef" v-model="searchQuery" placeholder="æœç´¢æœåŠ¡å•†æˆ–æ¨¡å‹åç§°..." clearable :prefix-icon="Search" />
        </div>
        
        <el-table 
            :data="filteredModelList" 
            stripe 
            style="width: 100%;" 
            max-height="50vh" 
            :border="true"
            :span-method="tableSpanMethod" 
            width="100%"
        >
            <el-table-column label="æœåŠ¡å•†" align="center" prop="provider" width="120">
                <template #default="scope">
                    <strong>{{ scope.row.label.split("|")[0] }}</strong>
                </template>
            </el-table-column>
            <el-table-column label="æ¨¡å‹" align="center" prop="modelName">
                <template #default="scope">
                    <el-tooltip :content="scope.row.value === currentModel ? 'å½“å‰æ¨¡å‹ï¼Œå†æ¬¡ç‚¹å‡»å¯ä¿å­˜ä¸ºé»˜è®¤' : 'é€‰æ‹©æ­¤æ¨¡å‹'"
                        placement="top" :enterable="false">
                        <el-button link size="large" @click="onModelClick(scope.row)"
                            :class="{ 'is-current-model': scope.row.value === currentModel }">
                            {{ scope.row.label.split("|")[1] }}
                        </el-button>
                    </el-tooltip>
                </template>
            </el-table-column>
        </el-table>
        <template #footer>
            <el-button @click="handleClose">å…³é—­</el-button>
        </template>
    </el-dialog>
</template>

<style scoped>
.model-search-container {
    padding: 0 0 15px 0;
}
.el-button.is-link.is-current-model {
  color: #E6A23C; /* Element Plus çš„é‡‘è‰²/é»„è‰² */
  font-weight: bold;
}

.el-button.is-link.is-current-model:hover {
  color: #ebb563;
}

:deep(.el-dialog__header) {
    padding-bottom:0 !important;
}
</style>
```
```vue
./Anywhere_window/src/components/TitleBar.vue
<script setup>
import { computed, ref, onMounted, onBeforeUnmount } from 'vue';
import { ElTooltip, ElIcon, ElDropdown, ElDropdownMenu, ElDropdownItem } from 'element-plus';
import { Download, FullScreen, Close, CloseBold, Minus, Menu as MenuIcon, Check } from '@element-plus/icons-vue';

const props = defineProps({
  favicon: String,
  promptName: String, 
  conversationName: String,
  isAlwaysOnTop: Boolean,
  autoCloseOnBlur: Boolean,
  isDarkMode: Boolean,
  os: { type: String, default: 'win' }
});

const emit = defineEmits([
  'save-window-size',
  'save-session',
  'toggle-pin',
  'toggle-always-on-top',
  'minimize',
  'maximize',
  'close'
]);

const displayConversationName = computed(() => {
  return props.conversationName || 'ä¸´æ—¶å¯¹è¯';
});

const isMac = computed(() => props.os === 'macos' || props.os === 'darwin');
const isWin = computed(() => props.os === 'win');
const isLinux = computed(() => !isMac.value && !isWin.value);

// --- å“åº”å¼å¸ƒå±€é€»è¾‘ ---
const windowWidth = ref(window.innerWidth);
const isNarrow = computed(() => windowWidth.value < 400); // é˜ˆå€¼ï¼šå°äº520pxæ—¶æŠ˜å 

const handleResize = () => {
  windowWidth.value = window.innerWidth;
};

onMounted(() => {
  window.addEventListener('resize', handleResize);
});

onBeforeUnmount(() => {
  window.removeEventListener('resize', handleResize);
});
</script>

<template>
  <div class="title-bar" :class="[`os-${os}`, { 'dark-mode': isDarkMode }]">
    
    <!-- 1. å·¦ä¾§åŒºåŸŸ -->
    <div class="left-container">
      <!-- macOS çº¢ç»¿ç¯ -->
      <div v-if="isMac" class="window-controls mac-traffic-lights no-drag">
        <div class="traffic-btn close" @click="emit('close')">
          <el-icon class="traffic-icon"><CloseBold /></el-icon>
        </div>
        <div class="traffic-btn minimize" @click="emit('minimize')">
          <el-icon class="traffic-icon icon-minus"><Minus /></el-icon>
        </div>
        <div class="traffic-btn maximize" @click="emit('maximize')">
          <el-icon class="traffic-icon icon-fullscreen"><FullScreen /></el-icon>
        </div>
      </div>

      <!-- App ä¿¡æ¯ (å§‹ç»ˆæ˜¾ç¤º) -->
      <div class="app-info no-drag" @click="emit('save-window-size')" @dblclick.stop="emit('maximize')">
        <el-tooltip content="ç‚¹å‡»ä¿å­˜å½“å‰çª—å£å¤§å°ä¸ä½ç½® / åŒå‡»å…¨å±" placement="bottom" :show-after="500">
          <div class="app-info-inner">
            <img :src="favicon" class="app-logo" alt="Logo">
            <span class="app-title">{{ promptName || 'Anywhere' }}</span>
          </div>
        </el-tooltip>
      </div>

      <!-- åˆ†éš”çº¿ (ä»…åœ¨å®½æ¨¡å¼æ˜¾ç¤º) -->
      <div class="divider-vertical" v-if="!isNarrow"></div>

      <!-- å¯¹è¯åç§° (ä»…åœ¨å®½æ¨¡å¼æ˜¾ç¤º) -->
      <div v-if="!isNarrow" class="conversation-info no-drag" @click="emit('save-session')" @dblclick.stop="emit('maximize')">
        <el-tooltip content="ç‚¹å‡»ä¿å­˜ä¼šè¯" placement="bottom" :show-after="500">
          <div class="conversation-inner">
            <span class="conversation-title">{{ displayConversationName }}</span>
            <el-icon class="download-icon"><Download /></el-icon>
          </div>
        </el-tooltip>
      </div>
    </div>

    <!-- 2. å³ä¾§åŒºåŸŸ -->
    <div class="right-container">
      
      <!-- A. å®½å±æ¨¡å¼ï¼šæ˜¾ç¤ºåŠŸèƒ½æŒ‰é’®ç»„ -->
      <div v-if="!isNarrow" class="function-group no-drag">
        <el-tooltip :content="autoCloseOnBlur ? 'å¤±ç„¦è‡ªåŠ¨å…³é—­: å¼€' : 'å¤±ç„¦è‡ªåŠ¨å…³é—­: å…³'" placement="bottom" :show-after="500">
          <div class="func-btn" @click="emit('toggle-pin')" :class="{ 'active': !autoCloseOnBlur }">
             <svg v-if="!autoCloseOnBlur" viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V7c0-2.76-2.24-5-5-5S7 4.24 7 7v1H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM8.9 7c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v1H8.9V7z"/></svg>
             <svg v-else viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
          </div>
        </el-tooltip>

        <el-tooltip :content="isAlwaysOnTop ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶çª—å£'" placement="bottom" :show-after="500">
          <div class="func-btn" @click="emit('toggle-always-on-top')" :class="{ 'active': isAlwaysOnTop }">
            <svg v-if="isAlwaysOnTop" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.6358 3.90949C15.2888 3.47412 15.6153 3.25643 15.9711 3.29166C16.3269 3.32689 16.6044 3.60439 17.1594 4.15938L19.8406 6.84062C20.3956 7.39561 20.6731 7.67311 20.7083 8.02888C20.7436 8.38465 20.5259 8.71118 20.0905 9.36424L18.4419 11.8372C17.88 12.68 17.5991 13.1013 17.3749 13.5511C17.2086 13.8845 17.0659 14.2292 16.9476 14.5825C16.7882 15.0591 16.6889 15.5557 16.4902 16.5489L16.2992 17.5038C16.2986 17.5072 16.2982 17.5089 16.298 17.5101C16.1556 18.213 15.3414 18.5419 14.7508 18.1351C14.7497 18.1344 14.7483 18.1334 14.7455 18.1315V18.1315C14.7322 18.1223 14.7255 18.1177 14.7189 18.1131C11.2692 15.7225 8.27754 12.7308 5.88691 9.28108C5.88233 9.27448 5.87772 9.26782 5.86851 9.25451V9.25451C5.86655 9.25169 5.86558 9.25028 5.86486 9.24924C5.45815 8.65858 5.78704 7.84444 6.4899 7.70202C6.49113 7.70177 6.49282 7.70144 6.49618 7.70076L7.45114 7.50977C8.44433 7.31113 8.94092 7.21182 9.4175 7.05236C9.77083 6.93415 10.1155 6.79139 10.4489 6.62514C10.8987 6.40089 11.32 6.11998 12.1628 5.55815L14.6358 3.90949Z"/><path d="M5 19L9.5 14.5" stroke-linecap="round"/></svg>
            <svg v-else viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M20,8 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,8 L20,8 Z M20,9 L4,9 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,9 Z M3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,5.5 Z" /></svg>
          </div>
        </el-tooltip>
      </div>

      <!-- B. çª„å±æ¨¡å¼ï¼šæ˜¾ç¤ºä¸‹æ‹‰èœå• -->
      <div v-else class="function-group no-drag">
        <el-dropdown trigger="click" placement="bottom-end" popper-class="title-bar-dropdown">
          <div class="func-btn" title="æ›´å¤šé€‰é¡¹">
            <el-icon><MenuIcon /></el-icon>
          </div>
          <template #dropdown>
            <el-dropdown-menu>
              <!-- 1. ä¿å­˜/é‡å‘½åä¼šè¯ -->
              <el-dropdown-item @click="emit('save-session')">
                <el-icon><Download /></el-icon>
                <div class="dropdown-text-col">
                  <span>ä¿å­˜/é‡å‘½å</span>
                  <span class="dropdown-subtext">{{ displayConversationName }}</span>
                </div>
              </el-dropdown-item>
              
              <!-- 2. å¤±ç„¦å…³é—­å¼€å…³ -->
              <el-dropdown-item @click="emit('toggle-pin')">
                <div class="dropdown-check-row">
                  <div class="dropdown-text-col">
                    <span>å¤±ç„¦è‡ªåŠ¨å…³é—­</span>
                  </div>
                  <el-icon v-if="autoCloseOnBlur" class="check-icon"><Check /></el-icon>
                </div>
              </el-dropdown-item>

              <!-- 3. ç½®é¡¶å¼€å…³ -->
              <el-dropdown-item @click="emit('toggle-always-on-top')">
                <div class="dropdown-check-row">
                  <div class="dropdown-text-col">
                    <span>çª—å£ç½®é¡¶</span>
                  </div>
                  <el-icon v-if="isAlwaysOnTop" class="check-icon"><Check /></el-icon>
                </div>
              </el-dropdown-item>
            </el-dropdown-menu>
          </template>
        </el-dropdown>
      </div>

      <div class="divider-vertical" v-if="isWin"></div>

      <!-- Windows çª—å£æ§åˆ¶ -->
      <div v-if="isWin" class="window-controls win-controls no-drag">
        <div class="win-btn minimize" @click="emit('minimize')" title="æœ€å°åŒ–">
          <el-icon><Minus /></el-icon>
        </div>
        <div class="win-btn maximize" @click="emit('maximize')" title="æœ€å¤§åŒ–">
          <el-icon><FullScreen /></el-icon>
        </div>
        <div class="win-btn close" @click="emit('close')" title="å…³é—­">
          <el-icon><Close /></el-icon>
        </div>
      </div>

      <!-- Linux çª—å£æ§åˆ¶ -->
      <div v-if="isLinux" class="window-controls linux-controls no-drag">
        <div class="linux-btn minimize" @click="emit('minimize')">
          <el-icon><Minus /></el-icon>
        </div>
        <div class="linux-btn maximize" @click="emit('maximize')">
          <el-icon><FullScreen /></el-icon>
        </div>
        <div class="linux-btn close" @click="emit('close')">
          <el-icon><Close /></el-icon>
        </div>
      </div>
    </div>
  </div>
</template>

<style>
/* å…¨å±€è¦†ç›– Element Plus Dropdown æ ·å¼ä»¥é€‚é…ä¸»é¢˜ */
.title-bar-dropdown {
  --el-bg-color-overlay: var(--el-bg-color);
  --el-border-color-light: var(--el-border-color);
  --el-text-color-regular: var(--el-text-color-primary);
}

html.dark .title-bar-dropdown {
  background-color: #2c2c2c !important;
  border-color: #444 !important;
}

.title-bar-dropdown .el-dropdown-menu__item:hover {
  background-color: var(--el-fill-color);
  color: var(--el-color-primary);
}

html.dark .title-bar-dropdown .el-dropdown-menu__item:hover {
  background-color: #444;
}
</style>

<style scoped>
.title-bar {
  height: 40px; 
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: var(--el-bg-color);
  user-select: none;
  -webkit-app-region: drag;
  box-sizing: border-box;
  padding: 0 0 0 16px;
  font-size: 13px;
  color: var(--el-text-color-primary);
  flex-shrink: 0;
  z-index: 100;
  background-color: transparent;
}

.os-macos {
  padding-left: 14px;
}

.no-drag {
  -webkit-app-region: no-drag;
}

.left-container {
  display: flex;
  align-items: center;
  /* flex: 1; */ 
  flex-shrink: 1; /* å…è®¸æ”¶ç¼© */
  min-width: 0;
  gap: 8px; /* å‡å°é—´è· */
  margin-right: 10px; /* ä¿è¯ä¸å³ä¾§è‡³å°‘æœ‰é—´è· */
}

.right-container {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  flex-shrink: 0;
  height: 100%;
  margin-left: auto; /* å°†å³ä¾§å®¹å™¨æ¨åˆ°æœ€å³è¾¹ï¼Œä¸­é—´ç•™å‡ºæ‹–æ‹½ç©ºéš™ */
}

/* App Info & Conversation Title */
.app-info-inner, .conversation-inner {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  padding: 4px 6px;
  border-radius: 6px;
  transition: background-color 0.2s;
  height: 24px;
}

.app-info-inner:hover, .conversation-inner:hover {
  background-color: var(--el-fill-color);
}

.app-logo {
  width: 16px;
  height: 16px;
  display: block;
}

.app-title {
  font-weight: 600;
  font-size: 13px;
  white-space: nowrap;
  line-height: 1;
  padding-top: 2px; 
  max-width: 80px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.conversation-inner {
  max-width: 100%;
}

.conversation-title {
  font-weight: 500;
  font-size: 13px;
  color: var(--el-text-color-regular);
  max-width: 90px; 
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1;
  padding-top: 2px; 
}

.download-icon {
  font-size: 13px;
  color: var(--el-text-color-secondary);
  flex-shrink: 0;
}

.divider-vertical {
  width: 1px;
  height: 14px;
  background-color: var(--el-border-color);
  flex-shrink: 0;
}

/* ============ åŠŸèƒ½æŒ‰é’® (Pin, Top) ============ */
.function-group {
  display: flex;
  gap: 0px;
  margin-right:4px;
  align-items: center;
  height: 100%;
}

.func-btn {
  width: 40px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  cursor: default;
  color: var(--el-text-color-secondary);
  transition: background-color 0.1s;
  background-color: transparent;
}

.func-btn:hover {
  background-color: rgba(0, 0, 0, 0.05);
  color: var(--el-text-color-primary);
}

.dark-mode .func-btn:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.func-btn.active {
  color: var(--el-text-color-primary);
  font-weight: bold;
}

/* ä¸‹æ‹‰èœå•å†…éƒ¨æ ·å¼ */
.dropdown-text-col {
  display: flex;
  flex-direction: column;
  line-height: 1.2;
}

.dropdown-subtext {
  font-size: 10px;
  color: var(--el-text-color-secondary);
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.dropdown-check-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  min-width: 120px;
}

.check-icon {
  color: var(--el-color-primary);
  font-weight: bold;
}

/* ============ Windows æ ·å¼ ============ */
.win-controls {
  display: flex;
  gap: 0px; /* Windows åŸç”Ÿé£æ ¼æŒ‰é’®é€šå¸¸æ˜¯ç´§æŒ¨ç€çš„ */
  margin-right: 0px; /* Windows æŒ‰é’®é€šå¸¸é è¾¹ */
  align-items: center;
  height: 100%;
  margin-left:4px;
}

.win-btn {
  width: 40px; /* Windows æ ‡å‡†å®½åº¦è¾ƒå¤§ */
  height: 32px;
  /* border-radius: 6px; */ /* Windows æŒ‰é’®é€šå¸¸æ²¡æœ‰åœ†è§’ */
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--el-text-color-secondary);
  transition: all 0.1s;
  font-size: 12px; 
}

.win-btn:hover {
  background-color: var(--el-fill-color);
  color: var(--el-text-color-primary);
}

.win-btn.close:hover {
  background-color: #E81123;
  color: white;
}

/* ============ macOS æ ·å¼ ============ */
.mac-traffic-lights {
  display: flex;
  gap: 8px; 
  margin-right: 12px;
  align-items: center;
  height: 100%;
  padding-left: 2px;
}

.traffic-btn {
  width: 13px; /* å¾®è°ƒå°ºå¯¸ */
  height: 13px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  position: relative;
  box-shadow: inset 0 0 0 0.5px rgba(0, 0, 0, 0.12);
  
  transform-origin: center center;
  transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  will-change: transform;
}

.traffic-btn.close { background-color: #FF5F57; border: 0.5px solid #E0443E; }
.traffic-btn.minimize { background-color: #FFBD2E; border: 0.5px solid #D69E2E; }
.traffic-btn.maximize { background-color: #28C840; border: 0.5px solid #1C9A29; }

.mac-traffic-lights:hover .traffic-btn {
  transform: scale(1.1); 
}

.mac-traffic-lights:hover .traffic-icon {
  opacity: 1;
  color: rgba(0, 0, 0, 0.6);
}

.traffic-btn:active {
  transform: scale(0.95) !important;
  filter: brightness(0.9);
}

.traffic-icon {
  font-size: 7px; 
  color: rgba(0, 0, 0, 0.6);
  opacity: 0; 
  transition: opacity 0.2s ease, color 0.1s ease;
}

.traffic-icon :deep(svg) {
  stroke: currentColor;
  stroke-width: 60px; 
}

.icon-minus :deep(svg) { stroke-width: 80px; }
.icon-fullscreen :deep(svg) { stroke-width: 40px; }

.dark-mode .traffic-btn {
  border: none;
  box-shadow: inset 0 0 0 0.5px rgba(255, 255, 255, 0.1);
}
.dark-mode .traffic-icon {
  color: rgba(0, 0, 0, 0.7);
}

/* ============ Linux æ ·å¼ ============ */
.linux-controls {
  display: flex;
  gap: 6px;
  margin-right: 12px;
  align-items: center;
}

.linux-btn {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--el-text-color-regular);
  background-color: transparent;
  transition: all 0.2s;
  font-size: 12px; 
}

.linux-btn:hover {
  background-color: var(--el-fill-color-dark);
  color: var(--el-text-color-primary);
  transform: scale(1.1);
}

.linux-btn.close:hover {
  background-color: #E95420;
  color: white;
}
</style>
```
```js
./Anywhere_window/src/utils/formatters.js
/**
 * æ ¼å¼åŒ–æ—¶é—´æˆ³
 * @param {string} dateString 
 * @returns {string}
 */
export const formatTimestamp = (dateString) => {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        const datePart = date.toLocaleDateString('sv-SE');
        const timePart = date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
        return `${datePart} ${timePart}`;
    } catch (e) {
        return '';
    }
};

/**
 * æ ¼å¼åŒ–æ¶ˆæ¯æ–‡æœ¬å†…å®¹ï¼ˆæå–çº¯æ–‡æœ¬ï¼‰
 * @param {string|Array} content 
 * @returns {string}
 */
export const formatMessageText = (content) => {
    if (!content) return "";
    if (!Array.isArray(content)) return String(content);

    let textString = "";
    content.forEach(part => {
        if (part.type === 'text' && part.text && !(part.text.toLowerCase().startsWith('file name:') && part.text.toLowerCase().endsWith('file end'))) {
            textString += part.text;
        }
    });
    return textString.trim();
};

/**
 * å®‰å…¨ä¿®å¤å¹¶æ ¼å¼åŒ–å·¥å…·å‚æ•° JSON
 * @param {string} jsonString 
 * @returns {string}
 */
export const sanitizeToolArgs = (jsonString) => {
    if (!jsonString) return "{}";
    try {
        JSON.parse(jsonString);
        return jsonString; // å¦‚æœæ˜¯åˆæ³•JSONï¼Œç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²ï¼ˆä¹Ÿå¯ä»¥é€‰æ‹©æ ¼å¼åŒ–ï¼‰
    } catch (e) {
        let startIndex = jsonString.indexOf('{');
        if (startIndex === -1) return "{}";

        let braceCount = 0;
        for (let i = startIndex; i < jsonString.length; i++) {
            if (jsonString[i] === '{') braceCount++;
            else if (jsonString[i] === '}') braceCount--;

            if (braceCount === 0) {
                const potential = jsonString.substring(startIndex, i + 1);
                try {
                    JSON.parse(potential);
                    return potential;
                } catch (innerE) {
                    return "{}";
                }
            }
        }
        return "{}";
    }
};
```
```js
./Anywhere_window/src/utils/TextSearchUI.js
// ./Anywhere_window/src/utils/TextSearchUI.js

export default class TextSearchUI {
  constructor(options = {}) {
    this.options = Object.assign({
      theme: 'auto',
      scope: 'body',
      beforeShow: null
    }, options);

    this.container = null;
    this.input = null;
    this.matches = [];
    this.currentIndex = -1;
    this.isOpen = false;
    this.searchScope = null;
    
    // ä¿å­˜ç»‘å®šåçš„å‡½æ•°å¼•ç”¨ï¼Œä»¥ä¾¿é”€æ¯æ—¶ç§»é™¤ç›‘å¬
    this._handleResize = this._constrainToWindow.bind(this);

    this._init();
  }

  _init() {
    this._injectStyles();
    this._createUI();
    this._bindEvents();
    this.setTheme(this.options.theme);
    this.setScope(this.options.scope);
  }

  _injectStyles() {
    const styleId = 'text-search-ui-style';
    if (document.getElementById(styleId)) return;

    const css = `
      :root {
        --ts-bg: #ffffff;
        --ts-text: #333333;
        --ts-border: #e5e7eb;
        --ts-hover: #f3f4f6;
        --ts-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --ts-highlight: #ffeb3b;
        --ts-highlight-current: #ff9800;
        --ts-highlight-text: #000000;
      }
      
      [data-search-theme="dark"] {
        --ts-bg: #2a2a2a;
        --ts-text: #e5e7eb;
        --ts-border: #4b5563;
        --ts-hover: #374151;
        --ts-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        --ts-highlight: #b45309;
        --ts-highlight-current: #f59e0b;
        --ts-highlight-text: #ffffff;
      }

      .text-search-container {
        position: fixed;
        top: 20px;
        right: 40px;
        z-index: 10000;
        background: var(--ts-bg);
        color: var(--ts-text);
        padding: 8px;
        border-radius: 6px;
        box-shadow: var(--ts-shadow);
        border: 1px solid var(--ts-border);
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 14px;
        transition: opacity 0.2s;
        min-width: 300px;
      }

      .text-search-container.hidden {
        opacity: 0;
        pointer-events: none;
        /* éšè—æ—¶ä¸æ”¹å˜ä½ç½®ï¼Œé¿å…åŠ¨ç”»ä¹±è·³ï¼Œåªæ”¹é€æ˜åº¦å’Œç‚¹å‡»ç©¿é€ */
        visibility: hidden; 
      }

      .text-search-drag-handle {
        cursor: move;
        color: var(--ts-text);
        opacity: 0.5;
        padding: 0 4px;
        user-select: none;
      }

      .text-search-input {
        background: transparent;
        border: none;
        color: var(--ts-text);
        outline: none;
        flex-grow: 1;
        width: 120px;
        font-size: 14px;
      }

      .text-search-count {
        font-size: 12px;
        color: var(--ts-text);
        opacity: 0.7;
        white-space: nowrap;
        min-width: 40px;
        text-align: center;
        user-select: none;
      }

      .text-search-divider {
        width: 1px;
        height: 16px;
        background: var(--ts-border);
        margin: 0 4px;
      }

      .text-search-btn {
        background: transparent;
        border: none;
        color: var(--ts-text);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.1s;
      }

      .text-search-btn:hover {
        background: var(--ts-hover);
      }

      .text-search-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      mark.search-highlight {
        background-color: var(--ts-highlight);
        color: var(--ts-highlight-text);
        border-radius: 2px;
        padding: 0 1px;
      }

      mark.search-highlight.current {
        background-color: var(--ts-highlight-current);
        color: var(--ts-highlight-text);
        outline: 2px solid rgba(255, 255, 255, 0.3);
      }
    `;

    const style = document.createElement('style');
    style.id = styleId;
    style.textContent = css;
    document.head.appendChild(style);
  }

  _createUI() {
    this.container = document.createElement('div');
    this.container.className = 'text-search-container hidden';
    
    this.container.innerHTML = `
      <div class="text-search-drag-handle">â‹®â‹®</div>
      <input type="text" class="text-search-input" placeholder="æŸ¥æ‰¾æ¶ˆæ¯..." />
      <span class="text-search-count">0/0</span>
      <div class="text-search-divider"></div>
      <button class="text-search-btn btn-prev" title="ä¸Šä¸€ä¸ª (Shift+Enter)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
      </button>
      <button class="text-search-btn btn-next" title="ä¸‹ä¸€ä¸ª (Enter)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
      </button>
      <button class="text-search-btn btn-close" title="å…³é—­ (Esc)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    `;

    document.body.appendChild(this.container);

    this.input = this.container.querySelector('.text-search-input');
    this.countSpan = this.container.querySelector('.text-search-count');
    this.btnPrev = this.container.querySelector('.btn-prev');
    this.btnNext = this.container.querySelector('.btn-next');
    this.btnClose = this.container.querySelector('.btn-close');
  }

  _bindEvents() {
    // è¾“å…¥äº‹ä»¶
    this.input.addEventListener('input', (e) => {
      this.search(e.target.value);
    });

    this.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (e.shiftKey) this.findPrevious();
        else this.findNext();
      }
    });

    // æŒ‰é’®äº‹ä»¶
    this.btnPrev.addEventListener('click', () => this.findPrevious());
    this.btnNext.addEventListener('click', () => this.findNext());
    this.btnClose.addEventListener('click', () => this.hide());

    // å…¨å±€å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        this.show();
      }
      if (e.key === 'Escape' && this.isOpen) {
        e.preventDefault();
        this.hide();
      }
    });

    // çª—å£å¤§å°æ”¹å˜æ—¶ï¼Œç¡®ä¿æœç´¢æ¡†ä¸è·‘å‡ºå»
    window.addEventListener('resize', this._handleResize);

    // æ‹–æ‹½é€»è¾‘
    const handle = this.container.querySelector('.text-search-drag-handle');
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;

    handle.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      const rect = this.container.getBoundingClientRect();
      initialLeft = rect.left;
      initialTop = rect.top;
      
      // åˆ‡æ¢åˆ°ç»å¯¹å®šä½å¹¶å›ºå®šå®½åº¦ï¼Œé˜²æ­¢å˜å½¢
      this.container.style.right = 'auto'; 
      this.container.style.width = rect.width + 'px'; 
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      e.preventDefault();
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      
      let newLeft = initialLeft + dx;
      let newTop = initialTop + dy;

      // [å…³é”®ä¿®æ”¹] è¾¹ç•Œé™åˆ¶è®¡ç®—
      const winWidth = window.innerWidth;
      const winHeight = window.innerHeight;
      const boxRect = this.container.getBoundingClientRect();
      
      // é™åˆ¶ X è½´ï¼š0 <= Left <= çª—å£å®½åº¦ - ç›’å­å®½åº¦
      if (newLeft < 0) newLeft = 0;
      else if (newLeft + boxRect.width > winWidth) newLeft = winWidth - boxRect.width;

      // é™åˆ¶ Y è½´ï¼š0 <= Top <= çª—å£é«˜åº¦ - ç›’å­é«˜åº¦
      if (newTop < 0) newTop = 0;
      else if (newTop + boxRect.height > winHeight) newTop = winHeight - boxRect.height;

      this.container.style.left = `${newLeft}px`;
      this.container.style.top = `${newTop}px`;
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
    });
  }

  // [æ–°å¢] ç¡®ä¿æœç´¢æ¡†åœ¨çª—å£å¯è§åŒºåŸŸå†…
  _constrainToWindow() {
    if (!this.container) return;
    
    const rect = this.container.getBoundingClientRect();
    const winWidth = window.innerWidth;
    const winHeight = window.innerHeight;
    
    let newLeft = rect.left;
    let newTop = rect.top;
    let needsUpdate = false;

    // æ£€æŸ¥å³è¾¹ç•Œ (å¦‚æœè¶…å‡ºå±å¹•å³ä¾§ï¼Œå‘å·¦ç§»)
    if (rect.right > winWidth) {
        newLeft = winWidth - rect.width;
        if (newLeft < 0) newLeft = 0; // é˜²æ­¢çª—å£æ¯”ç›’å­è¿˜çª„
        needsUpdate = true;
    }
    
    // æ£€æŸ¥ä¸‹è¾¹ç•Œ (å¦‚æœè¶…å‡ºå±å¹•åº•éƒ¨ï¼Œå‘ä¸Šç§»)
    if (rect.bottom > winHeight) {
        newTop = winHeight - rect.height;
        if (newTop < 0) newTop = 0;
        needsUpdate = true;
    }

    if (needsUpdate) {
        this.container.style.left = `${newLeft}px`;
        this.container.style.top = `${newTop}px`;
        this.container.style.right = 'auto'; // ç¡®ä¿æ¸…é™¤ right å±æ€§
    }
  }

  setScope(scope) {
    if (typeof scope === 'string') {
      this.searchScope = document.querySelector(scope);
    } else if (scope instanceof HTMLElement) {
      this.searchScope = scope;
    } else {
      this.searchScope = document.body;
    }
  }

  setTheme(theme) {
    if (theme === 'auto') {
      const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.body.setAttribute('data-search-theme', isDark ? 'dark' : 'light');
    } else {
      document.body.setAttribute('data-search-theme', theme);
    }
  }

  show() {
    if (this.options.beforeShow) this.options.beforeShow();
    this.container.classList.remove('hidden');
    this.isOpen = true;
    
    // æ¯æ¬¡æ‰“å¼€æ—¶éƒ½æ£€æŸ¥ä¸€ä¸‹ä½ç½®ï¼Œé˜²æ­¢ä¸Šæ¬¡å…³é—­åçª—å£å˜å°äº†
    this._constrainToWindow();
    
    setTimeout(() => this.input.focus(), 50);
    if (this.input.value) {
        this.search(this.input.value);
    }
  }

  hide() {
    this.container.classList.add('hidden');
    this.isOpen = false;
    this.clear();
    document.activeElement.blur();
  }

  clear() {
    const marks = this.searchScope.querySelectorAll('mark.search-highlight');
    marks.forEach(mark => {
      const parent = mark.parentNode;
      parent.replaceChild(document.createTextNode(mark.textContent), mark);
      parent.normalize();
    });
    this.matches = [];
    this.currentIndex = -1;
    this.updateCount();
  }

  search(text) {
    this.clear();
    if (!text) return;

    const regex = new RegExp(text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    const walker = document.createTreeWalker(
      this.searchScope,
      NodeFilter.SHOW_TEXT,
      {
        acceptNode: (node) => {
          // æ’é™¤æœç´¢æ¡†è‡ªå·±å’Œè„šæœ¬æ ·å¼
          if (node.parentElement.closest('.text-search-container, script, style, .no-search')) {
            return NodeFilter.FILTER_REJECT;
          }
          return NodeFilter.FILTER_ACCEPT;
        }
      }
    );

    const textNodes = [];
    let node;
    while (node = walker.nextNode()) {
      textNodes.push(node);
    }

    for (const textNode of textNodes) {
      const content = textNode.nodeValue;
      let match;
      let lastIndex = 0;
      const fragments = [];
      let hasMatch = false;

      regex.lastIndex = 0;

      while ((match = regex.exec(content)) !== null) {
        hasMatch = true;
        if (match.index > lastIndex) {
          fragments.push(document.createTextNode(content.substring(lastIndex, match.index)));
        }
        
        const mark = document.createElement('mark');
        mark.className = 'search-highlight';
        mark.textContent = match[0];
        fragments.push(mark);
        this.matches.push(mark);

        lastIndex = regex.lastIndex;
      }

      if (hasMatch) {
        if (lastIndex < content.length) {
          fragments.push(document.createTextNode(content.substring(lastIndex)));
        }

        const parent = textNode.parentNode;
        fragments.forEach(frag => parent.insertBefore(frag, textNode));
        parent.removeChild(textNode);
      }
    }

    if (this.matches.length > 0) {
      this.jumpTo(0);
    }
    this.updateCount();
  }

  jumpTo(index) {
    if (this.matches.length === 0) return;

    if (this.currentIndex >= 0 && this.matches[this.currentIndex]) {
      this.matches[this.currentIndex].classList.remove('current');
    }

    this.currentIndex = (index + this.matches.length) % this.matches.length;

    const currentMark = this.matches[this.currentIndex];
    currentMark.classList.add('current');
    
    currentMark.scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });

    this.updateCount();
  }

  findNext() {
    this.jumpTo(this.currentIndex + 1);
  }

  findPrevious() {
    this.jumpTo(this.currentIndex - 1);
  }

  updateCount() {
    const total = this.matches.length;
    const current = total === 0 ? 0 : this.currentIndex + 1;
    this.countSpan.textContent = `${current}/${total}`;
    
    this.btnPrev.disabled = total === 0;
    this.btnNext.disabled = total === 0;
  }
  
  destroy() {
      window.removeEventListener('resize', this._handleResize);
      if(this.container) {
          this.container.remove();
      }
  }
}
```
```css
./Anywhere_window/src/assets/base.css
/* color palette from <https://github.com/vuejs/theme> */
:root {
  --vt-c-white: #ffffff;
  --vt-c-white-soft: #f8f8f8;
  --vt-c-white-mute: #f2f2f2;

  --vt-c-black: #212121;
  --vt-c-black-soft: #222222;
  --vt-c-black-mute: #282828;

  --vt-c-indigo: #2c3e50;

  --vt-c-divider-light-1: rgba(60, 60, 60, 0.29);
  --vt-c-divider-light-2: rgba(60, 60, 60, 0.12);
  --vt-c-divider-dark-1: rgba(84, 84, 84, 0.65);
  --vt-c-divider-dark-2: rgba(84, 84, 84, 0.48);

  --vt-c-text-light-1: var(--vt-c-indigo);
  --vt-c-text-light-2: rgba(60, 60, 60, 0.66);
  --vt-c-text-dark-1: var(--vt-c-white);
  --vt-c-text-dark-2: rgba(235, 235, 235, 0.64);
}

/* semantic color variables for this project */
:root {
  --color-background: var(--vt-c-white);
  --color-background-soft: var(--vt-c-white-soft);
  --color-background-mute: var(--vt-c-white-mute);

  --color-border: var(--vt-c-divider-light-2);
  --color-border-hover: var(--vt-c-divider-light-1);

  --color-heading: var(--vt-c-text-light-1);
  --color-text: var(--vt-c-text-light-1);

  --section-gap: 160px;
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-background: var(--vt-c-black);
    --color-background-soft: var(--vt-c-black-soft);
    --color-background-mute: var(--vt-c-black-mute);

    --color-border: var(--vt-c-divider-dark-2);
    --color-border-hover: var(--vt-c-divider-dark-1);

    --color-heading: var(--vt-c-text-dark-1);
    --color-text: var(--vt-c-text-dark-2);
  }
}

*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  font-weight: normal;
}

body {
  min-height: 100vh;
  color: var(--color-text);
  background: var(--color-background);
  transition:
    color 0.5s,
    background-color 0.5s;
  line-height: 1.6;
  font-family:
    Inter,
    -apple-system,
    BlinkMacSystemFont,
    'Segoe UI',
    Roboto,
    Oxygen,
    Ubuntu,
    Cantarell,
    'Fira Sans',
    'Droid Sans',
    'Helvetica Neue',
    sans-serif;
  font-size: 15px;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

```
```css
./Anywhere_window/src/assets/dark.css
html.dark {
    color-scheme: dark;

    /* --- èƒŒæ™¯è‰² --- */
    --el-bg-color-page: #202123;  /* ChatGPT æœ€æ·±èƒŒæ™¯ */
    --el-bg-color: #212121 !important;      /* ChatGPT ç»„ä»¶/å…ƒç´ èƒŒæ™¯ */
    --el-bg-color-overlay: #414158; /* ChatGPT å¼¹çª—ç­‰èƒŒæ™¯ */
    --el-bg-color-input: #303030 !important; /* ChatGPT å¼¹çª—ç­‰èƒŒæ™¯ */
    --el-bg-color-userbubble: #2F2F2F !important;

    /* --- æ–‡å­—é¢œè‰² --- */
    --el-text-color-primary: #ECECF1; /* ChatGPT ä¸»è¦æ–‡å­— (è¿‘ç™½) */
    --el-text-color-regular: #D1D5DB; /* ChatGPT å¸¸è§„æ–‡å­— (ç¨æš—) */
    --el-text-color-secondary: #8E8EA0; /* ChatGPT æ¬¡è¦æ–‡å­— (æ›´æš—) */
    --el-text-color-placeholder: #61626D;/* ChatGPT å ä½ç¬¦ */
    --el-text-color-disabled: #4D4E57;  /* ChatGPT ç¦ç”¨æ–‡å­— */

    /* --- è¾¹æ¡†é¢œè‰² (ChatGPT è¾¹æ¡†å¾ˆå¼±) --- */
    --el-border-color-darker: #494949; /* æ¯” bg æš—ä¸€ç‚¹ */
    --el-border-color-dark: #40414F;   /* æ¯” bg äº®ä¸€ç‚¹ */
    --el-border-color: #444654;
    --el-border-color-light: #53545f;
    --el-border-color-lighter: #61626d;
    --el-border-color-extra-light: #6d6e78; /* æœ€äº®çš„è¾¹æ¡†è‰² */

    /* --- å¡«å……é¢œè‰² --- */
    --el-fill-color-darker: #424242;   /* ç”¨äºéå¸¸æš—çš„åŒºåŸŸ */
    --el-fill-color-dark: #494949;    /* æš—å¡«å…… */
    --el-fill-color: #424242 !important;        /* åŸºç¡€å¡«å…… */
    --el-fill-color-light: #4A4B57 !important;    /* äº®å¡«å…… */
    --el-fill-color-lighter: #5a5c69;   /* æ›´äº®å¡«å…… */
    --el-fill-color-extra-light: #666875;/* æœ€äº®å¡«å…… */
    --el-fill-color-blank: #212121 !important;

    /* --- ä¸»é¢˜è‰² (ChatGPT ä¸æ˜æ˜¾ä½¿ç”¨å•ä¸€ä¸»è‰²) --- */
    /* å¯èƒ½éœ€è¦æ ¹æ®ä½ çš„æŒ‰é’®ç­‰äº¤äº’å…ƒç´ å†³å®šï¼Œè¿™é‡Œç”¨ç™½è‰²ç¤ºä¾‹ */
    --el-color-primary: #F9F9F9;
    --el-color-primary-light-3: #f0f0f0;
    --el-color-primary-light-5: #e0e0e0;
    --el-color-primary-light-7: #d0d0d0;
    --el-color-primary-light-8: #c0c0c0;
    --el-color-primary-light-9: #b0b0b0; /* éå¸¸æµ…çš„ç°è‰² */
    --el-color-primary-dark-2: #F9F9F9; /* å³ä½¿æ˜¯ 'dark' å˜ä½“ï¼ŒåŸºè‰²æ˜¯ç™½åˆ™è¿˜æ˜¯ç™½ */

    /* --- å…¶ä»–è¯­ä¹‰è‰² (å¯ä»¥ä¿æŒä¸å˜æˆ–å¾®è°ƒ) --- */
    --el-color-success: #10a37f; /* å°è¯•ç”¨ ChatGPT ç±»ä¼¼çš„ç»¿è‰² */
    --el-color-success-light-9: rgb(21, 52, 45);
    --el-color-success-dark-2: #13c89c;

    --el-color-warning: #f7b500;
    --el-color-warning-light-9: rgb(51, 39, 18);
    --el-color-warning-dark-2: #f8c840;

    --el-color-danger: #ef4146;
    --el-color-danger-light-9: rgb(57, 29, 30);
    --el-color-danger-dark-2: #f1666b;

    --el-color-error: #ef4146;
    --el-color-error-light-9: rgb(57, 29, 30);
    --el-color-error-dark-2: #f1666b;

    --el-color-info: var(--el-text-color-secondary); /* Info é¢œè‰²ç”¨æ¬¡è¦æ–‡å­—é¢œè‰² */
    --el-color-info-light-9: #3a3b43;
    --el-color-info-dark-2: #aab0bb;


    /* --- é˜´å½± (ChatGPT é˜´å½±å¾ˆå¼±) --- */
    --el-box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
    --el-box-shadow-light: 0px 0px 6px rgba(0, 0, 0, 0.08);
    --el-box-shadow-lighter: 0px 0px 4px rgba(0, 0, 0, 0.05);
    --el-box-shadow-dark: 0px 6px 16px rgba(0, 0, 0, 0.12);

    /* --- å…¶ä»– --- */
    --el-mask-color: rgba(0, 0, 0, 0.6);
    --el-mask-color-extra-light: rgba(0, 0, 0, 0.2);
}

/* é’ˆå¯¹ç‰¹å®šç»„ä»¶çš„å¾®è°ƒå¯èƒ½ä»éœ€ä¿ç•™åœ¨åŸå¤„æˆ–è¿™é‡Œ */
/* ä¾‹å¦‚ï¼Œç¡®ä¿æŒ‰é’®åœ¨æš—æ¨¡å¼ä¸‹æ ·å¼æ­£ç¡® */
html.dark .el-button {
    /* --el-button-text-color */
    /* --el-button-bg-color */
    /* --el-button-border-color */
    /* --el-button-hover-text-color */
    /* --el-button-hover-bg-color */
    /* --el-button-hover-border-color */
    /* ... */
    --el-button-disabled-text-color: var(--el-text-color-disabled);
    --el-button-disabled-bg-color: var(--el-fill-color-darker);
    --el-button-disabled-border-color: var(--el-border-color-darker);
}
html.dark .el-button--primary {
    /* å¦‚æœä¸»æŒ‰é’®éœ€è¦ç‰¹æ®Šé¢œè‰² */
    --el-button-text-color: #202123; /* æ·±è‰²æ–‡å­—é…äº®èƒŒæ™¯ */
    --el-button-bg-color: var(--el-color-primary); /* ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„äº®è‰²ä¸»è‰² */
    --el-button-border-color: var(--el-color-primary);
    /* å®šä¹‰ hover å’Œ active çŠ¶æ€ */
    --el-button-hover-text-color: #202123;
    --el-button-hover-bg-color: var(--el-color-primary-light-3);
    --el-button-hover-border-color: var(--el-color-primary-light-3);
    --el-button-active-text-color: #202123;
    --el-button-active-bg-color: var(--el-color-primary-light-5);
    --el-button-active-border-color: var(--el-color-primary-light-5);
}

html.dark .el-card {
    --el-card-bg-color: var(--el-bg-color); /* å¡ç‰‡èƒŒæ™¯ç”¨å…ƒç´ èƒŒæ™¯è‰² */
}

html.dark .el-empty {
    /* Empty çŠ¶æ€çš„æ’ç”»é¢œè‰²ï¼Œå¯ä»¥ä¿æŒé»˜è®¤æˆ–ä»ChatGPTæˆªå›¾è°ƒæ•´ */
    --el-empty-fill-color-0: var(--el-color-black);
    --el-empty-fill-color-1: #4b4b52;
    --el-empty-fill-color-2: #36383d;
}
```
```css
./Anywhere_window/src/assets/main.css
@import './base.css';

#app {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  font-weight: normal;
}

a,
.green {
  text-decoration: none;
  color: hsla(160, 100%, 37%, 1);
  transition: 0.4s;
  padding: 3px;
}

@media (hover: hover) {
  a:hover {
    background-color: hsla(160, 100%, 37%, 0.2);
  }
}

@media (min-width: 1024px) {
  body {
    display: flex;
    place-items: center;
  }

  #app {
    display: grid;
    grid-template-columns: 1fr 1fr;
    padding: 0 2rem;
  }
}

```

ä»¥ä¸‹æ˜¯å…¶ä»–çª—å£çš„å‰ç«¯ä»£ç ï¼Œåœ¨./Fast_window/ç›®å½•ä¸‹ï¼Œæ˜¯ç‹¬ç«‹çª—å£æ–‡ä»¶ï¼Œå…¶é¢„åŠ è½½æ–‡ä»¶ä¸ºfast_window_preload.js
```html
./Fast_window/fast_input.html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anywhere Clip</title>
    <style>
        :root {
            /* æµ…è‰²æ¨¡å¼ï¼šæ˜Ÿæ˜Ÿé£æ ¼ */
            --bg-color: rgba(255, 255, 255, 0.98);
            --text-color: #1F2937;
            --border-color: rgba(0, 0, 0, 0.08);
            --hover-bg: rgba(0, 0, 0, 0.05);
            --accent-color: #3B82F6;
            --success-color: #10B981;
            --error-color: #EF4444;
            --input-color: #8B5CF6;
            /* æ‹–æ‹½æŒ‰é’®ç´«è‰² */
            --shadow: 0 8px 30px rgba(0, 0, 0, 0);

            /* æ˜Ÿæ˜Ÿç²’å­é¢œè‰² */
            --p-color-1: #FFD700;
            /* é‡‘é»„ */
            --p-color-2: #FFFFFF;
            /* çº¯ç™½ */
            --p-color-3: #FDE68A;
            /* æµ…é»„ */
        }

        html.dark {
            /* æ·±è‰²æ¨¡å¼ï¼šç°å°˜ç²¾çµé£æ ¼ */
            --bg-color: rgba(30, 30, 30, 0.98);
            --text-color: #F3F4F6;
            --border-color: rgba(255, 255, 255, 0.12);
            --hover-bg: rgba(255, 255, 255, 0.15);
            --shadow: 0 8px 30px rgba(0, 0, 0, 0);
            --input-color: #A78BFA;

            /* ç°å°˜ç²’å­é¢œè‰² */
            --p-color-1: #000000;
            --p-color-2: #2d2d2d;
            --p-color-3: #1a1a1a;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: transparent;
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        #particle-stage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        /* ä¸»çª—å£å®¹å™¨ */
        #container {
            width: 300px;
            height: 50px;
            background-color: var(--bg-color);
            border-radius: 50px !important;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);

            display: flex;
            align-items: center;
            padding: 0 6px;
            box-sizing: border-box;

            position: relative;
            z-index: 10;

            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s, transform 0.3s;
        }

        /* [ä¿®æ”¹] ç¬é—´æ¶ˆå¤±ï¼Œäº§ç”Ÿç ´ç¢é”™è§‰ */
        #container.vanish {
            opacity: 0;
            transition: opacity 0s;
            pointer-events: none;
        }

        /* é€šç”¨æŒ‰é’®æ ·å¼ */
        .control-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
            color: var(--text-color);
            position: relative;
        }

        .control-btn:hover {
            background-color: var(--hover-bg);
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        /* å·¦ä¾§åŒºåŸŸï¼šå…³é—­ -> å¤åˆ¶ */
        .left-zone {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* çŠ¶æ€A: å…³é—­ */
        .control-btn.close:hover {
            color: var(--error-color);
            background-color: rgba(239, 68, 68, 0.1);
        }

        /* çŠ¶æ€B: å¤åˆ¶ */
        .control-btn.copy:hover {
            color: var(--success-color);
            background-color: rgba(16, 185, 129, 0.1);
        }

        /* å›¾æ ‡åˆ‡æ¢åŠ¨ç”» */
        .icon-layer {
            position: absolute;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .icon-hidden {
            opacity: 0;
            transform: scale(0.5);
            pointer-events: none;
        }

        .icon-visible {
            opacity: 1;
            transform: scale(1);
        }

        /* ä¸­é—´å†…å®¹åŒº */
        .content-zone {
            flex-grow: 1;
            height: 100%;
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
            padding: 0 2px;
            -webkit-app-region: drag;
        }

        #text-display {
            font-size: 14px;
            color: var(--text-color);
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.2s;
            display: block;
            text-align: left;
        }

        #text-display.visible {
            opacity: 1;
        }

        /* ä¸­å¤®åŠ è½½åŠ¨ç”» */
        #center-loader {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 5px;
            pointer-events: none;
        }

        .dot {
            width: 6px;
            height: 6px;
            background-color: var(--text-color);
            opacity: 0.6;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* å³ä¾§åŒºåŸŸï¼šåŠ è½½åœˆ -> è¾“å…¥æŒ‰é’® */
        .right-zone {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stream-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(128, 128, 128, 0.2);
            border-left-color: var(--text-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* è¾“å…¥æŒ‰é’® */
        .control-btn.input {
            display: none;
            /* é»˜è®¤éšè— */
        }

        .control-btn.input:hover {
            color: var(--input-color);
            background-color: rgba(139, 92, 246, 0.1);
        }

        .control-btn.input.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        /* å®ŒæˆçŠ¶æ€ä¸‹çš„æ ·å¼å˜æ›´ */
        #container.finished {
            animation: golden-flash 0.6s ease-out;
        }

        #container.finished .stream-spinner {
            display: none !important;
        }

        #container.finished .control-btn.input {
            display: flex !important;
        }

        /* ================= ç²’å­åŠ¨ç”»æ ¸å¿ƒæ ·å¼ ================= */
        .particle {
            position: absolute;
            pointer-events: none;
            will-change: transform;
            border-radius: 50%;
            opacity: 1 !important;
            /* å¼ºåˆ¶å…¨ç¨‹ä¸é€æ˜ */
            filter: none !important;
            /* å¼ºåˆ¶æ— æ¨¡ç³Š */
            z-index: 20;
        }

        /* ç»Ÿä¸€ä½¿ç”¨å†…çˆ†åŠ¨ç”»ï¼šåŸåœ°ç¼©å°æ¶ˆå¤±ï¼Œä¸æ”¹å˜é€æ˜åº¦ */
        @keyframes particle-implode {
            0% {
                transform: translate(0, 0) scale(1);
            }

            100% {
                /* æœ€ç»ˆçŠ¶æ€ï¼šä½ç§»æå°ï¼Œä½“ç§¯ä¸º0ï¼Œå®ç°â€œæ¶ˆå¤±â€ */
                transform: translate(var(--tx), var(--ty)) scale(0);
            }
        }

        /* [ä¿®æ”¹] é‡‘è¾¹é—ªçƒï¼šç§»é™¤å¤–éƒ¨å…‰æ™•ï¼Œæ”¹ç”¨å†…è¾¹æ¡† */
        @keyframes golden-flash {
            0% {
                border-color: var(--border-color);
                box-shadow: none;
            }

            30% {
                border-color: #F59E0B;
                /* é‡‘é»„è‰² */
                box-shadow: inset 0 0 0 1px #F59E0B;
                /* å†…å‘å…‰æ¨¡æ‹Ÿè¾¹æ¡†åŠ ç²— */
            }

            100% {
                border-color: var(--border-color);
                box-shadow: none;
            }
        }
    </style>
</head>

<body>
    <div id="particle-stage"></div>

    <div id="container">
        <!-- å·¦ä¾§ï¼šå…³é—­/å¤åˆ¶ (åˆå¹¶) -->
        <div class="left-zone">
            <div id="btn-left" class="control-btn close" title="å…³é—­ (Esc)">
                <!-- å…³é—­å›¾æ ‡ -->
                <svg id="icon-close" class="icon-layer icon-visible" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <!-- å¤åˆ¶å›¾æ ‡ -->
                <svg id="icon-copy" class="icon-layer icon-hidden" width="16" height="16" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <!-- æˆåŠŸå‹¾é€‰ -->
                <svg id="icon-check" class="icon-layer icon-hidden" width="18" height="18" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                    style="color: var(--success-color);">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šå†…å®¹ -->
        <div class="content-zone">
            <div id="center-loader">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            <div id="text-display"></div>
        </div>

        <!-- å³ä¾§ï¼šæµå¼åŠ è½½ / è¾“å…¥ -->
        <div class="right-zone">
            <div id="stream-loader" class="stream-spinner"></div>

            <div id="btn-input" class="control-btn input" draggable="true" title="æ‹–æ‹½åˆ°ç›®æ ‡çª—å£è¾“å…¥ / ç‚¹å‡»æ¨¡æ‹Ÿæ‰“å­—">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="4 7 4 4 20 4 20 7"></polyline>
                    <line x1="9" y1="20" x2="15" y2="20"></line>
                    <line x1="12" y1="4" x2="12" y2="20"></line>
                </svg>
            </div>
        </div>
    </div>

    <script>
        const container = document.getElementById('container');
        const particleStage = document.getElementById('particle-stage');
        const centerLoader = document.getElementById('center-loader');
        const textDisplay = document.getElementById('text-display');
        const btnLeft = document.getElementById('btn-left');
        const btnInput = document.getElementById('btn-input');
        const streamLoader = document.getElementById('stream-loader');

        // Icons
        const iconClose = document.getElementById('icon-close');
        const iconCopy = document.getElementById('icon-copy');
        const iconCheck = document.getElementById('icon-check');

        // æ•°æ®çŠ¶æ€
        let fullTextData = ""; // åç«¯æ¥æ”¶åˆ°çš„å®Œæ•´æ•°æ®
        let visualText = "";   // å±å¹•ä¸Šå½“å‰æ˜¾ç¤ºçš„åŠ¨ç”»æ•°æ®

        let isTaskFinished = false;
        let isClosing = false;
        let isTyping = false;
        let isRendering = false; // æ˜¯å¦æ­£åœ¨æ‰§è¡ŒåŠ¨ç”»å¾ªç¯

        let shutdownTimer = null;
        let animationTimer = null;
        let isDarkMode = false;

        // --- æ ¸å¿ƒï¼šæ‰“å­—æœºåŠ¨ç”»å¾ªç¯ ---
        function renderLoop() {
            // å¦‚æœæ˜¾ç¤ºçš„æ–‡å­—å°‘äºæ¥æ”¶åˆ°çš„æ–‡å­—ï¼Œç»§ç»­æ¸²æŸ“
            if (visualText.length < fullTextData.length) {
                isRendering = true;

                // ç¡®ä¿UIå·²åˆ‡æ¢åˆ°æ˜¾ç¤ºçŠ¶æ€
                if (centerLoader.style.display !== 'none') {
                    centerLoader.style.display = 'none';
                    textDisplay.classList.add('visible');
                    streamLoader.style.display = 'block';
                }

                // åŠ¨æ€æ­¥é•¿ç®—æ³•ï¼šç§¯å‹è¶Šå¤šï¼Œè·‘å¾—è¶Šå¿«ï¼Œä¿è¯æµç•…ä¸”ä¸å¡é¡¿
                const lag = fullTextData.length - visualText.length;
                const step = Math.max(1, Math.ceil(lag / 5));

                // è¿½åŠ æ–‡æœ¬
                visualText += fullTextData.substr(visualText.length, step);

                // æ›´æ–° DOM
                textDisplay.textContent = visualText.replace(/[\r\n]+/g, ' ');
                textDisplay.scrollLeft = textDisplay.scrollWidth; // è‡ªåŠ¨è·Ÿéšæ»šåŠ¨

                requestAnimationFrame(renderLoop);
            } else {
                isRendering = false;
                // å¦‚æœä»»åŠ¡å·²å®Œæˆä¸”åŠ¨ç”»å·²æ’­æ”¾å®Œæ¯•ï¼Œç¡®ä¿åŠ è½½åœˆéšè—
                if (isTaskFinished) {
                    streamLoader.style.display = 'none';
                }
            }
        }

        if (window.preload && window.preload.receiveMsg) {
            // 1. åˆå§‹åŒ–é…ç½®
            window.preload.receiveMsg((data) => {
                const { config } = data;
                isDarkMode = config.isDarkMode;
                if (isDarkMode) document.documentElement.classList.add('dark');

                // åˆå§‹çŠ¶æ€ï¼šæ˜¾ç¤ºä¸­é—´åŠ è½½ç‚¹
                if (centerLoader.style.display !== 'none') {
                    centerLoader.style.display = 'none';
                    textDisplay.classList.add('visible');
                    streamLoader.style.display = 'block';
                }
            });

            // 2. ç›‘å¬æµå¼æ•°æ®
            if (window.preload.onStreamUpdate) {
                window.preload.onStreamUpdate((data) => {
                    const { type, payload } = data;

                    if (type === 'chunk') {
                        // ä»…ç´¯åŠ æ•°æ®ï¼Œä¸ç›´æ¥æ“ä½œDOMï¼Œäº¤ç»™ renderLoop
                        fullTextData += payload;
                        if (!isRendering) renderLoop();
                    }
                    else if (type === 'done') {
                        handleTaskFinish(); // æ ‡è®°å®Œæˆ
                    }
                    else if (type === 'error') {
                        // é”™è¯¯æƒ…å†µç›´æ¥æ˜¾ç¤ºï¼Œä¸èµ°åŠ¨ç”»
                        fullTextData = payload;
                        visualText = fullTextData;
                        handleTaskFinish(true);
                    }
                });
            }
        }

        function handleTaskFinish(isError = false) {
            isTaskFinished = true;

            if (isError) {
                textDisplay.textContent = fullTextData;
                textDisplay.style.color = 'var(--error-color)';
                centerLoader.style.display = 'none';
                streamLoader.style.display = 'none';
            } else {
                // å¦‚æœåŠ¨ç”»å·²ç»è¿½å¹³ï¼Œç«‹å³éšè—åŠ è½½åœˆï¼›å¦åˆ™ renderLoop ä¼šåœ¨è¿½å¹³åéšè—å®ƒ
                if (!isRendering) {
                    streamLoader.style.display = 'none';
                }
            }

            // åˆ‡æ¢ UI çŠ¶æ€ -> å®Œæˆ (é‡‘è¾¹å†…é—ªçƒ)
            container.classList.add('finished');

            // å·¦ä¾§æŒ‰é’®ï¼šä» Close å˜ä¸º Copy
            btnLeft.classList.remove('close');
            btnLeft.classList.add('copy');
            btnLeft.title = "å¤åˆ¶å¹¶å…³é—­";

            iconClose.classList.remove('icon-visible');
            iconClose.classList.add('icon-hidden');
            iconCopy.classList.remove('icon-hidden');
            iconCopy.classList.add('icon-visible');

            // è‡ªåŠ¨å¤åˆ¶å®Œæ•´æ–‡æœ¬
            window.api.copyText(fullTextData);
            checkShutdownLogic();
        }

        function checkShutdownLogic() {
            if (!isTaskFinished || isClosing || isTyping) return;
            if (!document.hasFocus()) {
                startCountdown();
            }
        }

        function startCountdown() {
            if (shutdownTimer) clearTimeout(shutdownTimer);
            if (isTyping) return;

            console.log("Start 3s countdown...");
            shutdownTimer = setTimeout(() => {
                playCloseAnimation();
            }, 3000);
        }

        function playCloseAnimation() {
            if (isClosing) return;
            isClosing = true;

            spawnParticles();
            container.classList.add('vanish'); // è§¦å‘CSSç¬é—´æ¶ˆå¤±

            animationTimer = setTimeout(() => {
                window.api.closeWindow({ x: window.screenX, y: window.screenY });
            }, 1000);
        }

        function restoreWindow() {
            console.log("Interrupted! Restoring...");
            if (shutdownTimer) clearTimeout(shutdownTimer);
            if (animationTimer) clearTimeout(animationTimer);
            shutdownTimer = null;
            animationTimer = null;
            isClosing = false;

            container.classList.remove('vanish');
            particleStage.innerHTML = '';
        }

        window.addEventListener('blur', () => {
            if (isTaskFinished && !isClosing && !isTyping) {
                startCountdown();
            }
        });

        window.addEventListener('focus', restoreWindow);
        document.addEventListener('mousedown', restoreWindow);

        // å·¦ä¾§æŒ‰é’®é€»è¾‘
        btnLeft.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!isTaskFinished) {
                // æœªå®Œæˆ -> å…³é—­
                playCloseAnimation();
            } else {
                // å·²å®Œæˆ -> å¤åˆ¶å¹¶å…³é—­
                window.api.copyText(fullTextData);

                // å‹¾é€‰åŠ¨ç”»
                iconCopy.classList.remove('icon-visible');
                iconCopy.classList.add('icon-hidden');
                iconCheck.classList.remove('icon-hidden');
                iconCheck.classList.add('icon-visible');

                playCloseAnimation();
            }
        });

        // --- å³ä¾§è¾“å…¥æŒ‰é’®é€»è¾‘ ---

        // 1. æ‹–æ‹½å¼€å§‹
        btnInput.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData("text/plain", fullTextData);
            btnInput.classList.add('dragging');
            restoreWindow();
            isTyping = true; // é”å®šçŠ¶æ€ï¼Œé˜²æ­¢å¤±ç„¦å…³é—­
        });

        // 2. æ‹–æ‹½ç»“æŸ -> ç«‹å³è¾“å…¥ -> å»¶æ—¶å…³é—­
        btnInput.addEventListener('dragend', (e) => {
            btnInput.classList.remove('dragging');

            // if (window.api.typeText) {
            //     window.api.typeText(fullTextData);
            // }
            setTimeout(() => {
                isTyping = false;
                playCloseAnimation();
            }, 1000);
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') playCloseAnimation();
        });

        // ================= ç²’å­ç‰¹æ•ˆ (æœ€ç»ˆä¿®æ­£ç‰ˆ) =================

        function spawnParticles() {
            const rect = container.getBoundingClientRect();
            // å‡å°‘ç²’å­æ•°é‡ï¼Œé¿å…è¿‡äºæ‹¥æŒ¤å¯¼è‡´è§†è§‰æº¢å‡ºæ„Ÿ
            const particleCount = 150;

            // ã€å…³é”®ã€‘å®‰å…¨å†…è¾¹è·ï¼šç¡®ä¿ç²’å­ç”Ÿæˆåœ¨åœ†è§’çŸ©å½¢å†…éƒ¨
            const paddingX = 15;
            const paddingY = 5;

            const spawnW = rect.width - paddingX * 2;
            const spawnH = rect.height - paddingY * 2;

            for (let i = 0; i < particleCount; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');

                // éšæœºç”Ÿæˆåæ ‡ï¼ˆåœ¨å®‰å…¨åŒºåŸŸå†…ï¼‰
                const offsetX = Math.random() * spawnW + paddingX;
                const offsetY = Math.random() * spawnH + paddingY;

                const startX = rect.left + offsetX;
                const startY = rect.top + offsetY;

                p.style.left = startX + 'px';
                p.style.top = startY + 'px';

                // ã€å…³é”®ã€‘æå°çš„ä½ç§»ï¼ˆæŠ–åŠ¨ï¼‰ï¼Œæœ€å¤§ä»… 2px
                // ç¡®ä¿ç²’å­ä¸ä¼šé£å‡ºç‹­çª„çš„çª—å£å¯è§†åŒºåŸŸ
                const jitter = 2;
                const tx = (Math.random() - 0.5) * jitter * 2;
                const ty = (Math.random() - 0.5) * jitter * 2;

                p.style.setProperty('--tx', tx + 'px');
                p.style.setProperty('--ty', ty + 'px');

                // ç»Ÿä¸€åŠ¨ç”»æ—¶é•¿ï¼Œå¿«é€Ÿæ¶ˆå¤±
                const duration = 0.3 + Math.random() * 0.2;
                // æ·±è‰²æµ…è‰²ç»Ÿä¸€ä½¿ç”¨ç¼©å°æ¶ˆå¤±åŠ¨ç”»
                p.style.animation = `particle-implode ${duration}s ease-out forwards`;

                if (isDarkMode) {
                    // --- æ·±è‰²æ¨¡å¼ï¼šç…¤ç° ---
                    const size = 4 + Math.random() * 4;
                    p.style.width = size + 'px';
                    p.style.height = size + 'px';
                    p.style.borderRadius = '50%';

                    const randC = Math.random();
                    if (randC > 0.6) p.style.backgroundColor = 'var(--p-color-1)';
                    else if (randC > 0.3) p.style.backgroundColor = 'var(--p-color-2)';
                    else p.style.backgroundColor = 'var(--p-color-3)';

                } else {
                    // --- æµ…è‰²æ¨¡å¼ï¼šç¢ç‰‡ ---
                    const size = 5 + Math.random() * 6;
                    p.style.width = size + 'px';
                    p.style.height = size + 'px';

                    if (Math.random() > 0.5) {
                        p.style.borderRadius = '2px'; // æ–¹å½¢ç¢ç‰‡
                    } else {
                        p.style.borderRadius = '50%';
                    }

                    const randC = Math.random();
                    if (randC > 0.6) p.style.backgroundColor = 'var(--p-color-1)';
                    else if (randC > 0.2) p.style.backgroundColor = 'var(--p-color-2)';
                    else p.style.backgroundColor = 'var(--p-color-3)';
                }

                particleStage.appendChild(p);
            }
        }
    </script>
</body>

</html>
```

ä¸è®ºä½ è¿›è¡Œå¦‚ä½•ä¿®æ”¹ï¼Œä¸€å®šä¿è¯ä¸ä¼šç ´åå·²æœ‰çš„åŠŸèƒ½ï¼Œå‰ç«¯ä¿®æ”¹ä¸€å®šè¦ä¿æŒç›¸åŒçš„ä¸»é¢˜é£æ ¼ï¼Œå¹¶ä¿è¯èŠ‚çœå¼€å‘è€…å·¥ä½œé‡çš„åŸåˆ™ï¼Œè¯·ç»™å‡ºå®Œæ•´çš„å‡½æ•°ä»£ç å¹¶å‘Šè¯‰æˆ‘åœ¨å“ªé‡Œè¿›è¡Œè¦†ç›–ï¼Œç›´æ¥å‘Šè¯‰æˆ‘åœ¨å“ªé‡Œè¿›è¡Œæ€æ ·çš„ä¿®æ”¹å°±å¥½äº†ï¼Œä¸ç”¨ç»™å‡ºå…¨éƒ¨æ–‡ä»¶ä»£ç 

ç°åœ¨å¸Œæœ›å®ç°skillæŠ€èƒ½ï¼Œskillçš„ç›¸å…³æ–‡æ¡£å¦‚ä¸‹ï¼š

> ## Documentation Index
> Fetch the complete documentation index at: https://code.claude.com/docs/llms.txt
> Use this file to discover all available pages before exploring further.

# Extend Claude with skills

> Create, manage, and share skills to extend Claude's capabilities in Claude Code. Includes custom slash commands.

Skills extend what Claude can do. Create a `SKILL.md` file with instructions, and Claude adds it to its toolkit. Claude uses skills when relevant, or you can invoke one directly with `/skill-name`.

<Note>
  For built-in commands like `/help` and `/compact`, see [interactive mode](/en/interactive-mode#built-in-commands).

  **Custom slash commands have been merged into skills.** A file at `.claude/commands/review.md` and a skill at `.claude/skills/review/SKILL.md` both create `/review` and work the same way. Your existing `.claude/commands/` files keep working. Skills add optional features: a directory for supporting files, frontmatter to [control whether you or Claude invokes them](#control-who-invokes-a-skill), and the ability for Claude to load them automatically when relevant.
</Note>

Claude Code skills follow the [Agent Skills](https://agentskills.io) open standard, which works across multiple AI tools. Claude Code extends the standard with additional features like [invocation control](#control-who-invokes-a-skill), [subagent execution](#run-skills-in-a-subagent), and [dynamic context injection](#inject-dynamic-context).

## Getting started

### Create your first skill

This example creates a skill that teaches Claude to explain code using visual diagrams and analogies. Since it uses default frontmatter, Claude can load it automatically when you ask how something works, or you can invoke it directly with `/explain-code`.

<Steps>
  <Step title="Create the skill directory">
    Create a directory for the skill in your personal skills folder. Personal skills are available across all your projects.

    ```bash  theme={null}
    mkdir -p ~/.claude/skills/explain-code
    ```
  </Step>

  <Step title="Write SKILL.md">
    Every skill needs a `SKILL.md` file with two parts: YAML frontmatter (between `---` markers) that tells Claude when to use the skill, and markdown content with instructions Claude follows when the skill is invoked. The `name` field becomes the `/slash-command`, and the `description` helps Claude decide when to load it automatically.

    Create `~/.claude/skills/explain-code/SKILL.md`:

    ```yaml  theme={null}
    ---
    name: explain-code
    description: Explains code with visual diagrams and analogies. Use when explaining how code works, teaching about a codebase, or when the user asks "how does this work?"
    ---

    When explaining code, always include:

    1. **Start with an analogy**: Compare the code to something from everyday life
    2. **Draw a diagram**: Use ASCII art to show the flow, structure, or relationships
    3. **Walk through the code**: Explain step-by-step what happens
    4. **Highlight a gotcha**: What's a common mistake or misconception?

    Keep explanations conversational. For complex concepts, use multiple analogies.
    ```
  </Step>

  <Step title="Test the skill">
    You can test it two ways:

    **Let Claude invoke it automatically** by asking something that matches the description:

    ```
    How does this code work?
    ```

    **Or invoke it directly** with the skill name:

    ```
    /explain-code src/auth/login.ts
    ```

    Either way, Claude should include an analogy and ASCII diagram in its explanation.
  </Step>
</Steps>

### Where skills live

Where you store a skill determines who can use it:

| Location   | Path                                             | Applies to                     |
| :--------- | :----------------------------------------------- | :----------------------------- |
| Enterprise | See [managed settings](/en/iam#managed-settings) | All users in your organization |
| Personal   | `~/.claude/skills/<skill-name>/SKILL.md`         | All your projects              |
| Project    | `.claude/skills/<skill-name>/SKILL.md`           | This project only              |
| Plugin     | `<plugin>/skills/<skill-name>/SKILL.md`          | Where plugin is enabled        |

When skills share the same name across levels, higher-priority locations win: enterprise > personal > project. Plugin skills use a `plugin-name:skill-name` namespace, so they cannot conflict with other levels. If you have files in `.claude/commands/`, those work the same way, but if a skill and a command share the same name, the skill takes precedence.

#### Automatic discovery from nested directories

When you work with files in subdirectories, Claude Code automatically discovers skills from nested `.claude/skills/` directories. For example, if you're editing a file in `packages/frontend/`, Claude Code also looks for skills in `packages/frontend/.claude/skills/`. This supports monorepo setups where packages have their own skills.

Each skill is a directory with `SKILL.md` as the entrypoint:

```
my-skill/
â”œâ”€â”€ SKILL.md           # Main instructions (required)
â”œâ”€â”€ template.md        # Template for Claude to fill in
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ sample.md      # Example output showing expected format
â””â”€â”€ scripts/
    â””â”€â”€ validate.sh    # Script Claude can execute
```

The `SKILL.md` contains the main instructions and is required. Other files are optional and let you build more powerful skills: templates for Claude to fill in, example outputs showing the expected format, scripts Claude can execute, or detailed reference documentation. Reference these files from your `SKILL.md` so Claude knows what they contain and when to load them. See [Add supporting files](#add-supporting-files) for more details.

<Note>
  Files in `.claude/commands/` still work and support the same [frontmatter](#frontmatter-reference). Skills are recommended since they support additional features like supporting files.
</Note>

## Configure skills

Skills are configured through YAML frontmatter at the top of `SKILL.md` and the markdown content that follows.

### Types of skill content

Skill files can contain any instructions, but thinking about how you want to invoke them helps guide what to include:

**Reference content** adds knowledge Claude applies to your current work. Conventions, patterns, style guides, domain knowledge. This content runs inline so Claude can use it alongside your conversation context.

```yaml  theme={null}
---
name: api-conventions
description: API design patterns for this codebase
---

When writing API endpoints:
- Use RESTful naming conventions
- Return consistent error formats
- Include request validation
```

**Task content** gives Claude step-by-step instructions for a specific action, like deployments, commits, or code generation. These are often actions you want to invoke directly with `/skill-name` rather than letting Claude decide when to run them. Add `disable-model-invocation: true` to prevent Claude from triggering it automatically.

```yaml  theme={null}
---
name: deploy
description: Deploy the application to production
context: fork
disable-model-invocation: true
---

Deploy the application:
1. Run the test suite
2. Build the application
3. Push to the deployment target
```

Your `SKILL.md` can contain anything, but thinking through how you want the skill invoked (by you, by Claude, or both) and where you want it to run (inline or in a subagent) helps guide what to include. For complex skills, you can also [add supporting files](#add-supporting-files) to keep the main skill focused.

### Frontmatter reference

Beyond the markdown content, you can configure skill behavior using YAML frontmatter fields between `---` markers at the top of your `SKILL.md` file:

```yaml  theme={null}
---
name: my-skill
description: What this skill does
disable-model-invocation: true
allowed-tools: Read, Grep
---

Your skill instructions here...
```

All fields are optional. Only `description` is recommended so Claude knows when to use the skill.

| Field                      | Required    | Description                                                                                                                                           |
| :------------------------- | :---------- | :---------------------------------------------------------------------------------------------------------------------------------------------------- |
| `name`                     | No          | Display name for the skill. If omitted, uses the directory name. Lowercase letters, numbers, and hyphens only (max 64 characters).                    |
| `description`              | Recommended | What the skill does and when to use it. Claude uses this to decide when to apply the skill. If omitted, uses the first paragraph of markdown content. |
| `argument-hint`            | No          | Hint shown during autocomplete to indicate expected arguments. Example: `[issue-number]` or `[filename] [format]`.                                    |
| `disable-model-invocation` | No          | Set to `true` to prevent Claude from automatically loading this skill. Use for workflows you want to trigger manually with `/name`. Default: `false`. |
| `user-invocable`           | No          | Set to `false` to hide from the `/` menu. Use for background knowledge users shouldn't invoke directly. Default: `true`.                              |
| `allowed-tools`            | No          | Tools Claude can use without asking permission when this skill is active.                                                                             |
| `model`                    | No          | Model to use when this skill is active.                                                                                                               |
| `context`                  | No          | Set to `fork` to run in a forked subagent context.                                                                                                    |
| `agent`                    | No          | Which subagent type to use when `context: fork` is set.                                                                                               |
| `hooks`                    | No          | Hooks scoped to this skill's lifecycle. See [Hooks](/en/hooks) for configuration format.                                                              |

#### Available string substitutions

Skills support string substitution for dynamic values in the skill content:

| Variable               | Description                                                                                                                                  |
| :--------------------- | :------------------------------------------------------------------------------------------------------------------------------------------- |
| `$ARGUMENTS`           | All arguments passed when invoking the skill. If `$ARGUMENTS` is not present in the content, arguments are appended as `ARGUMENTS: <value>`. |
| `${CLAUDE_SESSION_ID}` | The current session ID. Useful for logging, creating session-specific files, or correlating skill output with sessions.                      |

**Example using substitutions:**

```yaml  theme={null}
---
name: session-logger
description: Log activity for this session
---

Log the following to logs/${CLAUDE_SESSION_ID}.log:

$ARGUMENTS
```

### Add supporting files

Skills can include multiple files in their directory. This keeps `SKILL.md` focused on the essentials while letting Claude access detailed reference material only when needed. Large reference docs, API specifications, or example collections don't need to load into context every time the skill runs.

```
my-skill/
â”œâ”€â”€ SKILL.md (required - overview and navigation)
â”œâ”€â”€ reference.md (detailed API docs - loaded when needed)
â”œâ”€â”€ examples.md (usage examples - loaded when needed)
â””â”€â”€ scripts/
    â””â”€â”€ helper.py (utility script - executed, not loaded)
```

Reference supporting files from `SKILL.md` so Claude knows what each file contains and when to load it:

```markdown  theme={null}
## Additional resources

- For complete API details, see [reference.md](reference.md)
- For usage examples, see [examples.md](examples.md)
```

<Tip>Keep `SKILL.md` under 500 lines. Move detailed reference material to separate files.</Tip>

### Control who invokes a skill

By default, both you and Claude can invoke any skill. You can type `/skill-name` to invoke it directly, and Claude can load it automatically when relevant to your conversation. Two frontmatter fields let you restrict this:

* **`disable-model-invocation: true`**: Only you can invoke the skill. Use this for workflows with side effects or that you want to control timing, like `/commit`, `/deploy`, or `/send-slack-message`. You don't want Claude deciding to deploy because your code looks ready.

* **`user-invocable: false`**: Only Claude can invoke the skill. Use this for background knowledge that isn't actionable as a command. A `legacy-system-context` skill explains how an old system works. Claude should know this when relevant, but `/legacy-system-context` isn't a meaningful action for users to take.

This example creates a deploy skill that only you can trigger. The `disable-model-invocation: true` field prevents Claude from running it automatically:

```yaml  theme={null}
---
name: deploy
description: Deploy the application to production
disable-model-invocation: true
---

Deploy $ARGUMENTS to production:

1. Run the test suite
2. Build the application
3. Push to the deployment target
4. Verify the deployment succeeded
```

Here's how the two fields affect invocation and context loading:

| Frontmatter                      | You can invoke | Claude can invoke | When loaded into context                                     |
| :------------------------------- | :------------- | :---------------- | :----------------------------------------------------------- |
| (default)                        | Yes            | Yes               | Description always in context, full skill loads when invoked |
| `disable-model-invocation: true` | Yes            | No                | Description not in context, full skill loads when you invoke |
| `user-invocable: false`          | No             | Yes               | Description always in context, full skill loads when invoked |

<Note>
  In a regular session, skill descriptions are loaded into context so Claude knows what's available, but full skill content only loads when invoked. [Subagents with preloaded skills](/en/sub-agents#preload-skills-into-subagents) work differently: the full skill content is injected at startup.
</Note>

### Restrict tool access

Use the `allowed-tools` field to limit which tools Claude can use when a skill is active. This skill creates a read-only mode where Claude can explore files but not modify them:

```yaml  theme={null}
---
name: safe-reader
description: Read files without making changes
allowed-tools: Read, Grep, Glob
---
```

### Pass arguments to skills

Both you and Claude can pass arguments when invoking a skill. Arguments are available via the `$ARGUMENTS` placeholder.

This skill fixes a GitHub issue by number. The `$ARGUMENTS` placeholder gets replaced with whatever follows the skill name:

```yaml  theme={null}
---
name: fix-issue
description: Fix a GitHub issue
disable-model-invocation: true
---

Fix GitHub issue $ARGUMENTS following our coding standards.

1. Read the issue description
2. Understand the requirements
3. Implement the fix
4. Write tests
5. Create a commit
```

When you run `/fix-issue 123`, Claude receives "Fix GitHub issue 123 following our coding standards..."

If you invoke a skill with arguments but the skill doesn't include `$ARGUMENTS`, Claude Code appends `ARGUMENTS: <your input>` to the end of the skill content so Claude still sees what you typed.

## Advanced patterns

### Inject dynamic context

The `!`command\`\` syntax runs shell commands before the skill content is sent to Claude. The command output replaces the placeholder, so Claude receives actual data, not the command itself.

This skill summarizes a pull request by fetching live PR data with the GitHub CLI. The `!`gh pr diff\`\` and other commands run first, and their output gets inserted into the prompt:

```yaml  theme={null}
---
name: pr-summary
description: Summarize changes in a pull request
context: fork
agent: Explore
allowed-tools: Bash(gh:*)
---

## Pull request context
- PR diff: !`gh pr diff`
- PR comments: !`gh pr view --comments`
- Changed files: !`gh pr diff --name-only`

## Your task
Summarize this pull request...
```

When this skill runs:

1. Each `!`command\`\` executes immediately (before Claude sees anything)
2. The output replaces the placeholder in the skill content
3. Claude receives the fully-rendered prompt with actual PR data

This is preprocessing, not something Claude executes. Claude only sees the final result.

<Tip>
  To enable [extended thinking](/en/common-workflows#use-extended-thinking-thinking-mode) in a skill, include the word "ultrathink" anywhere in your skill content.
</Tip>

### Run skills in a subagent

Add `context: fork` to your frontmatter when you want a skill to run in isolation. The skill content becomes the prompt that drives the subagent. It won't have access to your conversation history.

<Warning>
  `context: fork` only makes sense for skills with explicit instructions. If your skill contains guidelines like "use these API conventions" without a task, the subagent receives the guidelines but no actionable prompt, and returns without meaningful output.
</Warning>

Skills and [subagents](/en/sub-agents) work together in two directions:

| Approach                     | System prompt                             | Task                        | Also loads                   |
| :--------------------------- | :---------------------------------------- | :-------------------------- | :--------------------------- |
| Skill with `context: fork`   | From agent type (`Explore`, `Plan`, etc.) | SKILL.md content            | CLAUDE.md                    |
| Subagent with `skills` field | Subagent's markdown body                  | Claude's delegation message | Preloaded skills + CLAUDE.md |

With `context: fork`, you write the task in your skill and pick an agent type to execute it. For the inverse (defining a custom subagent that uses skills as reference material), see [Subagents](/en/sub-agents#preload-skills-into-subagents).

#### Example: Research skill using Explore agent

This skill runs research in a forked Explore agent. The skill content becomes the task, and the agent provides read-only tools optimized for codebase exploration:

```yaml  theme={null}
---
name: deep-research
description: Research a topic thoroughly
context: fork
agent: Explore
---

Research $ARGUMENTS thoroughly:

1. Find relevant files using Glob and Grep
2. Read and analyze the code
3. Summarize findings with specific file references
```

When this skill runs:

1. A new isolated context is created
2. The subagent receives the skill content as its prompt ("Research \$ARGUMENTS thoroughly...")
3. The `agent` field determines the execution environment (model, tools, and permissions)
4. Results are summarized and returned to your main conversation

The `agent` field specifies which subagent configuration to use. Options include built-in agents (`Explore`, `Plan`, `general-purpose`) or any custom subagent from `.claude/agents/`. If omitted, uses `general-purpose`.

### Restrict Claude's skill access

By default, Claude can invoke any skill that doesn't have `disable-model-invocation: true` set. Built-in commands like `/compact` and `/init` are not available through the Skill tool.

Three ways to control which skills Claude can invoke:

**Disable all skills** by denying the Skill tool in `/permissions`:

```
# Add to deny rules:
Skill
```

**Allow or deny specific skills** using [permission rules](/en/iam):

```
# Allow only specific skills
Skill(commit)
Skill(review-pr:*)

# Deny specific skills
Skill(deploy:*)
```

Permission syntax: `Skill(name)` for exact match, `Skill(name:*)` for prefix match with any arguments.

**Hide individual skills** by adding `disable-model-invocation: true` to their frontmatter. This removes the skill from Claude's context entirely.

<Note>
  The `user-invocable` field only controls menu visibility, not Skill tool access. Use `disable-model-invocation: true` to block programmatic invocation.
</Note>

## Share skills

Skills can be distributed at different scopes depending on your audience:

* **Project skills**: Commit `.claude/skills/` to version control
* **Plugins**: Create a `skills/` directory in your [plugin](/en/plugins)
* **Managed**: Deploy organization-wide through [managed settings](/en/iam#managed-settings)

### Generate visual output

Skills can bundle and run scripts in any language, giving Claude capabilities beyond what's possible in a single prompt. One powerful pattern is generating visual output: interactive HTML files that open in your browser for exploring data, debugging, or creating reports.

This example creates a codebase explorer: an interactive tree view where you can expand and collapse directories, see file sizes at a glance, and identify file types by color.

Create the Skill directory:

```bash  theme={null}
mkdir -p ~/.claude/skills/codebase-visualizer/scripts
```

Create `~/.claude/skills/codebase-visualizer/SKILL.md`. The description tells Claude when to activate this Skill, and the instructions tell Claude to run the bundled script:

````yaml  theme={null}
---
name: codebase-visualizer
description: Generate an interactive collapsible tree visualization of your codebase. Use when exploring a new repo, understanding project structure, or identifying large files.
allowed-tools: Bash(python:*)
---

# Codebase Visualizer

Generate an interactive HTML tree view that shows your project's file structure with collapsible directories.

## Usage

Run the visualization script from your project root:

```bash
python ~/.claude/skills/codebase-visualizer/scripts/visualize.py .
```

This creates `codebase-map.html` in the current directory and opens it in your default browser.

## What the visualization shows

- **Collapsible directories**: Click folders to expand/collapse
- **File sizes**: Displayed next to each file
- **Colors**: Different colors for different file types
- **Directory totals**: Shows aggregate size of each folder
````

Create `~/.claude/skills/codebase-visualizer/scripts/visualize.py`. This script scans a directory tree and generates a self-contained HTML file with:

* A **summary sidebar** showing file count, directory count, total size, and number of file types
* A **bar chart** breaking down the codebase by file type (top 8 by size)
* A **collapsible tree** where you can expand and collapse directories, with color-coded file type indicators

The script requires Python but uses only built-in libraries, so there are no packages to install:

```python expandable theme={null}
#!/usr/bin/env python3
"""Generate an interactive collapsible tree visualization of a codebase."""

import json
import sys
import webbrowser
from pathlib import Path
from collections import Counter

IGNORE = {'.git', 'node_modules', '__pycache__', '.venv', 'venv', 'dist', 'build'}

def scan(path: Path, stats: dict) -> dict:
    result = {"name": path.name, "children": [], "size": 0}
    try:
        for item in sorted(path.iterdir()):
            if item.name in IGNORE or item.name.startswith('.'):
                continue
            if item.is_file():
                size = item.stat().st_size
                ext = item.suffix.lower() or '(no ext)'
                result["children"].append({"name": item.name, "size": size, "ext": ext})
                result["size"] += size
                stats["files"] += 1
                stats["extensions"][ext] += 1
                stats["ext_sizes"][ext] += size
            elif item.is_dir():
                stats["dirs"] += 1
                child = scan(item, stats)
                if child["children"]:
                    result["children"].append(child)
                    result["size"] += child["size"]
    except PermissionError:
        pass
    return result

def generate_html(data: dict, stats: dict, output: Path) -> None:
    ext_sizes = stats["ext_sizes"]
    total_size = sum(ext_sizes.values()) or 1
    sorted_exts = sorted(ext_sizes.items(), key=lambda x: -x[1])[:8]
    colors = {
        '.js': '#f7df1e', '.ts': '#3178c6', '.py': '#3776ab', '.go': '#00add8',
        '.rs': '#dea584', '.rb': '#cc342d', '.css': '#264de4', '.html': '#e34c26',
        '.json': '#6b7280', '.md': '#083fa1', '.yaml': '#cb171e', '.yml': '#cb171e',
        '.mdx': '#083fa1', '.tsx': '#3178c6', '.jsx': '#61dafb', '.sh': '#4eaa25',
    }
    lang_bars = "".join(
        f'<div class="bar-row"><span class="bar-label">{ext}</span>'
        f'<div class="bar" style="width:{(size/total_size)*100}%;background:{colors.get(ext,"#6b7280")}"></div>'
        f'<span class="bar-pct">{(size/total_size)*100:.1f}%</span></div>'
        for ext, size in sorted_exts
    )
    def fmt(b):
        if b < 1024: return f"{b} B"
        if b < 1048576: return f"{b/1024:.1f} KB"
        return f"{b/1048576:.1f} MB"

    html = f'''<!DOCTYPE html>
<html><head>
  <meta charset="utf-8"><title>Codebase Explorer</title>
  <style>
    body {{ font: 14px/1.5 system-ui, sans-serif; margin: 0; background: #1a1a2e; color: #eee; }}
    .container {{ display: flex; height: 100vh; }}
    .sidebar {{ width: 280px; background: #252542; padding: 20px; border-right: 1px solid #3d3d5c; overflow-y: auto; flex-shrink: 0; }}
    .main {{ flex: 1; padding: 20px; overflow-y: auto; }}
    h1 {{ margin: 0 0 10px 0; font-size: 18px; }}
    h2 {{ margin: 20px 0 10px 0; font-size: 14px; color: #888; text-transform: uppercase; }}
    .stat {{ display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #3d3d5c; }}
    .stat-value {{ font-weight: bold; }}
    .bar-row {{ display: flex; align-items: center; margin: 6px 0; }}
    .bar-label {{ width: 55px; font-size: 12px; color: #aaa; }}
    .bar {{ height: 18px; border-radius: 3px; }}
    .bar-pct {{ margin-left: 8px; font-size: 12px; color: #666; }}
    .tree {{ list-style: none; padding-left: 20px; }}
    details {{ cursor: pointer; }}
    summary {{ padding: 4px 8px; border-radius: 4px; }}
    summary:hover {{ background: #2d2d44; }}
    .folder {{ color: #ffd700; }}
    .file {{ display: flex; align-items: center; padding: 4px 8px; border-radius: 4px; }}
    .file:hover {{ background: #2d2d44; }}
    .size {{ color: #888; margin-left: auto; font-size: 12px; }}
    .dot {{ width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }}
  </style>
</head><body>
  <div class="container">
    <div class="sidebar">
      <h1>ğŸ“Š Summary</h1>
      <div class="stat"><span>Files</span><span class="stat-value">{stats["files"]:,}</span></div>
      <div class="stat"><span>Directories</span><span class="stat-value">{stats["dirs"]:,}</span></div>
      <div class="stat"><span>Total size</span><span class="stat-value">{fmt(data["size"])}</span></div>
      <div class="stat"><span>File types</span><span class="stat-value">{len(stats["extensions"])}</span></div>
      <h2>By file type</h2>
      {lang_bars}
    </div>
    <div class="main">
      <h1>ğŸ“ {data["name"]}</h1>
      <ul class="tree" id="root"></ul>
    </div>
  </div>
  <script>
    const data = {json.dumps(data)};
    const colors = {json.dumps(colors)};
    function fmt(b) {{ if (b < 1024) return b + ' B'; if (b < 1048576) return (b/1024).toFixed(1) + ' KB'; return (b/1048576).toFixed(1) + ' MB'; }}
    function render(node, parent) {{
      if (node.children) {{
        const det = document.createElement('details');
        det.open = parent === document.getElementById('root');
        det.innerHTML = `<summary><span class="folder">ğŸ“ ${{node.name}}</span><span class="size">${{fmt(node.size)}}</span></summary>`;
        const ul = document.createElement('ul'); ul.className = 'tree';
        node.children.sort((a,b) => (b.children?1:0)-(a.children?1:0) || a.name.localeCompare(b.name));
        node.children.forEach(c => render(c, ul));
        det.appendChild(ul);
        const li = document.createElement('li'); li.appendChild(det); parent.appendChild(li);
      }} else {{
        const li = document.createElement('li'); li.className = 'file';
        li.innerHTML = `<span class="dot" style="background:${{colors[node.ext]||'#6b7280'}}"></span>${{node.name}}<span class="size">${{fmt(node.size)}}</span>`;
        parent.appendChild(li);
      }}
    }}
    data.children.forEach(c => render(c, document.getElementById('root')));
  </script>
</body></html>'''
    output.write_text(html)

if __name__ == '__main__':
    target = Path(sys.argv[1] if len(sys.argv) > 1 else '.').resolve()
    stats = {"files": 0, "dirs": 0, "extensions": Counter(), "ext_sizes": Counter()}
    data = scan(target, stats)
    out = Path('codebase-map.html')
    generate_html(data, stats, out)
    print(f'Generated {out.absolute()}')
    webbrowser.open(f'file://{out.absolute()}')
```

To test, open Claude Code in any project and ask "Visualize this codebase." Claude runs the script, generates `codebase-map.html`, and opens it in your browser.

This pattern works for any visual output: dependency graphs, test coverage reports, API documentation, or database schema visualizations. The bundled script does the heavy lifting while Claude handles orchestration.

## Troubleshooting

### Skill not triggering

If Claude doesn't use your skill when expected:

1. Check the description includes keywords users would naturally say
2. Verify the skill appears in `What skills are available?`
3. Try rephrasing your request to match the description more closely
4. Invoke it directly with `/skill-name` if the skill is user-invocable

### Skill triggers too often

If Claude uses your skill when you don't want it:

1. Make the description more specific
2. Add `disable-model-invocation: true` if you only want manual invocation

### Claude doesn't see all my skills

Skill descriptions are loaded into context so Claude knows what's available. If you have many skills, they may exceed the character budget (default 15,000 characters). Run `/context` to check for a warning about excluded skills.

To increase the limit, set the `SLASH_COMMAND_TOOL_CHAR_BUDGET` environment variable.

## Related resources

* **[Subagents](/en/sub-agents)**: delegate tasks to specialized agents
* **[Plugins](/en/plugins)**: package and distribute skills with other extensions
* **[Hooks](/en/hooks)**: automate workflows around tool events
* **[Memory](/en/memory)**: manage CLAUDE.md files for persistent context
* **[Interactive mode](/en/interactive-mode#built-in-commands)**: built-in commands and shortcuts
* **[Permissions](/en/iam)**: control tool and skill access

---

æˆ‘ä»¬éœ€è¦é€æ­¥å®ç°ï¼š

## ä¿®æ”¹backend

1. å¢åŠ ä¸€ä¸ªskill.jsï¼Œç”¨äºå¤„ç†SKILLçš„ç›¸å…³è°ƒç”¨
2. åº”è¯¥å¯ä»¥è·å–æŒ‡å®šè·¯å¾„çš„skillä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ï¼Œæè¿°ï¼Œæ˜¯å¦å¯ç”¨ï¼Œæ˜¯å¦forkæ¨¡å¼ï¼Œassetsã€scriptã€examplesçš„åŸºæœ¬ä¿¡æ¯ï¼ˆç›®å½•ä¸‹æ–‡ä»¶ï¼‰
3. åº”è¯¥å¯ä»¥ä¿®æ”¹skillçš„å„ç§ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ã€ç®€è¦æè¿°ã€è¯¦ç»†æè¿°ã€æ˜¯å¦å¯ç”¨ã€æ˜¯å¦forkæ¨¡å¼ï¼Œæœ¬æ˜¯ä¸Šæ˜¯ä¿®æ”¹SKILL.mdæ–‡ä»¶å†…å®¹ï¼Œæ–‡ä»¶åç§°ã€å’Œè¯¥æŠ€èƒ½æœ€å¤–å±‚ç›®å½•åç§°
4. å¯ä»¥ä¿®æ”¹assetsã€scriptã€examplesç­‰(æœ¬è´¨ä¸Šæ˜¯ä¸Šä¼ æ–‡ä»¶ã€åˆ é™¤æ–‡ä»¶ã€ä¸Šä¼ ç›®å½•ã€åˆ é™¤ç›®å½•)
5. å¿«æ·åŠ©æ‰‹è°ƒç”¨skillæ—¶ï¼Œé»˜è®¤å¯ç”¨æ‰€æœ‰é»˜è®¤MCPï¼Œå¹¶ä¸”å¢åŠ ä¸€ä¸ªskillå·¥å…·ï¼Œç”¨äºè°ƒç”¨SKILLï¼Œclaude codeä¸­å¯¹skillå·¥å…·çš„å®šä¹‰å¦‚ä¸‹ï¼Œå…¶ä¸­çš„ç¤ºä¾‹åº”è¯¥æ˜¯å·²ç»å¯ç”¨çš„MCPï¼Œï¼š
```
{
  "type": "function",
  "function": {
    "name": "Skill",
    "description": "Execute a skill within the main conversation\n\nWhen users ask you to perform tasks, check if any of the available skills below can help complete the task more effectively. Skills provide specialized capabilities and domain knowledge.\n\nWhen users ask you to run a \"slash command\" or reference \"/<something>\" (e.g., \"/commit\", \"/review-pr\"), they are referring to a skill. Use this tool to invoke the corresponding skill.\n\nExample:\n  User: \"run /commit\"\n  Assistant: [Calls Skill tool with skill: \"commit\"]\n\nHow to invoke:\n- Use this tool with the skill name and optional arguments\n- Examples:\n  - `skill: \"pdf\"` - invoke the pdf skill\n  - `skill: \"commit\", args: \"-m 'Fix bug'\"` - invoke with arguments\n  - `skill: \"review-pr\", args: \"123\"` - invoke with arguments\n  - `skill: \"ms-office-suite:pdf\"` - invoke using fully qualified name\n\nImportant:\n- When a skill is relevant, you must invoke this tool IMMEDIATELY as your first action\n- NEVER just announce or mention a skill in your text response without actually calling this tool\n- This is a BLOCKING REQUIREMENT: invoke the relevant Skill tool BEFORE generating any other response about the task\n- Only use skills listed in \"Available skills\" below\n- Do not invoke a skill that is already running\n- Do not use this tool for built-in CLI commands (like /help, /clear, etc.)\n- If you see a <command-name> tag in the current conversation turn (e.g., <command-name>/commit</command-name>), the skill has ALREADY been loaded and its instructions follow in the next message. Do NOT call this tool - just follow the skill instructions directly.\n\nAvailable skills:\n- docx: Comprehensive document creation, editing, and analysis with support for tracked changes, comments, formatting preservation, and text extraction. When Claude needs to work with professional documents (.docx files) for: (1) Creating new documents, (2) Modifying or editing content, (3) Working with tracked changes, (4) Adding comments, or any other document tasks\n- pdf: Comprehensive PDF manipulation toolkit for extracting text and tables, creating new PDFs, merging/splitting documents, and handling forms. When Claude needs to fill in a PDF form or programmatically process, generate, or analyze PDF documents at scale.\n- pptx: Presentation creation, editing, and analysis. When Claude needs to work with presentations (.pptx files) for: (1) Creating new presentations, (2) Modifying or editing content, (3) Working with layouts, (4) Adding comments or speaker notes, or any other presentation tasks\n- sayhello: Say hello to the user\n- skill-creator: Guide for creating effective skills. This skill should be used when users want to create a new skill (or update an existing skill) that extends Claude's capabilities with specialized knowledge, workflows, or tool integrations.\n- xlsx: Comprehensive spreadsheet creation, editing, and analysis with support for formulas, formatting, data analysis, and visualization. When Claude needs to work with spreadsheets (.xlsx, .xlsm, .csv, .tsv, etc) for: (1) Creating new spreadsheets with formulas and formatting, (2) Reading or analyzing data, (3) Modify existing spreadsheets while preserving formulas, (4) Data analysis and visualization in spreadsheets, or (5) Recalculating formulas\n",
    "parameters": {
      "$schema": "https://json-schema.org/draft/2020-12/schema",
      "type": "object",
      "properties": {
        "skill": {
          "description": "The skill name. E.g., \"commit\", \"review-pr\", or \"pdf\"",
          "type": "string"
        },
        "args": {
          "description": "Optional arguments for the skill",
          "type": "string"
        }
      },
      "required": [
        "skill"
      ],
      "additionalProperties": false
    }
  }
}
```

skillç›®å½•ç»“æ„ç¤ºä¾‹å¦‚ä¸‹ï¼š
```
E:\TMP\skill-test\.claude\skills>tree /f
å· æ–°åŠ å· çš„æ–‡ä»¶å¤¹ PATH åˆ—è¡¨
å·åºåˆ—å·ä¸º 3647-DFD7
E:.
â”œâ”€docx
â”‚  â”‚  docx-js.md
â”‚  â”‚  LICENSE.txt
â”‚  â”‚  ooxml.md
â”‚  â”‚  SKILL.md
â”‚  â”‚
â”‚  â”œâ”€ooxml
â”‚  â”‚  â”œâ”€schemas
â”‚  â”‚  â”‚  â”œâ”€ecma
â”‚  â”‚  â”‚  â”‚  â””â”€fouth-edition
â”‚  â”‚  â”‚  â”‚          opc-contentTypes.xsd
â”‚  â”‚  â”‚  â”‚          opc-coreProperties.xsd
â”‚  â”‚  â”‚  â”‚          opc-digSig.xsd
â”‚  â”‚  â”‚  â”‚          opc-relationships.xsd
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ISO-IEC29500-4_2016
â”‚  â”‚  â”‚  â”‚      dml-chart.xsd
â”‚  â”‚  â”‚  â”‚      dml-chartDrawing.xsd
â”‚  â”‚  â”‚  â”‚      dml-diagram.xsd
â”‚  â”‚  â”‚  â”‚      dml-lockedCanvas.xsd
â”‚  â”‚  â”‚  â”‚      dml-main.xsd
â”‚  â”‚  â”‚  â”‚      dml-picture.xsd
â”‚  â”‚  â”‚  â”‚      dml-spreadsheetDrawing.xsd
â”‚  â”‚  â”‚  â”‚      dml-wordprocessingDrawing.xsd
â”‚  â”‚  â”‚  â”‚      pml.xsd
â”‚  â”‚  â”‚  â”‚      shared-additionalCharacteristics.xsd
â”‚  â”‚  â”‚  â”‚      shared-bibliography.xsd
â”‚  â”‚  â”‚  â”‚      shared-commonSimpleTypes.xsd
â”‚  â”‚  â”‚  â”‚      shared-customXmlDataProperties.xsd
â”‚  â”‚  â”‚  â”‚      shared-customXmlSchemaProperties.xsd
â”‚  â”‚  â”‚  â”‚      shared-documentPropertiesCustom.xsd
â”‚  â”‚  â”‚  â”‚      shared-documentPropertiesExtended.xsd
â”‚  â”‚  â”‚  â”‚      shared-documentPropertiesVariantTypes.xsd
â”‚  â”‚  â”‚  â”‚      shared-math.xsd
â”‚  â”‚  â”‚  â”‚      shared-relationshipReference.xsd
â”‚  â”‚  â”‚  â”‚      sml.xsd
â”‚  â”‚  â”‚  â”‚      vml-main.xsd
â”‚  â”‚  â”‚  â”‚      vml-officeDrawing.xsd
â”‚  â”‚  â”‚  â”‚      vml-presentationDrawing.xsd
â”‚  â”‚  â”‚  â”‚      vml-spreadsheetDrawing.xsd
â”‚  â”‚  â”‚  â”‚      vml-wordprocessingDrawing.xsd
â”‚  â”‚  â”‚  â”‚      wml.xsd
â”‚  â”‚  â”‚  â”‚      xml.xsd
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€mce
â”‚  â”‚  â”‚  â”‚      mc.xsd
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€microsoft
â”‚  â”‚  â”‚          wml-2010.xsd
â”‚  â”‚  â”‚          wml-2012.xsd
â”‚  â”‚  â”‚          wml-2018.xsd
â”‚  â”‚  â”‚          wml-cex-2018.xsd
â”‚  â”‚  â”‚          wml-cid-2016.xsd
â”‚  â”‚  â”‚          wml-sdtdatahash-2020.xsd
â”‚  â”‚  â”‚          wml-symex-2015.xsd
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€scripts
â”‚  â”‚      â”‚  pack.py
â”‚  â”‚      â”‚  unpack.py
â”‚  â”‚      â”‚  validate.py
â”‚  â”‚      â”‚
â”‚  â”‚      â””â”€validation
â”‚  â”‚              base.py
â”‚  â”‚              docx.py
â”‚  â”‚              pptx.py
â”‚  â”‚              redlining.py
â”‚  â”‚              __init__.py
â”‚  â”‚
â”‚  â””â”€scripts
â”‚      â”‚  document.py
â”‚      â”‚  utilities.py
â”‚      â”‚  __init__.py
â”‚      â”‚
â”‚      â””â”€templates
â”‚              comments.xml
â”‚              commentsExtended.xml
â”‚              commentsExtensible.xml
â”‚              commentsIds.xml
â”‚              people.xml
â”‚
â”œâ”€pdf
â”‚  â”‚  forms.md
â”‚  â”‚  LICENSE.txt
â”‚  â”‚  reference.md
â”‚  â”‚  SKILL.md
â”‚  â”‚
â”‚  â””â”€scripts
â”‚          check_bounding_boxes.py
â”‚          check_bounding_boxes_test.py
â”‚          check_fillable_fields.py
â”‚          convert_pdf_to_images.py
â”‚          create_validation_image.py
â”‚          extract_form_field_info.py
â”‚          fill_fillable_fields.py
â”‚          fill_pdf_form_with_annotations.py
â”‚
â”œâ”€pptx
â”‚  â”‚  html2pptx.md
â”‚  â”‚  LICENSE.txt
â”‚  â”‚  ooxml.md
â”‚  â”‚  SKILL.md
â”‚  â”‚
â”‚  â”œâ”€ooxml
â”‚  â”‚  â”œâ”€schemas
â”‚  â”‚  â”‚  â”œâ”€ecma
â”‚  â”‚  â”‚  â”‚  â””â”€fouth-edition
â”‚  â”‚  â”‚  â”‚          opc-contentTypes.xsd
â”‚  â”‚  â”‚  â”‚          opc-coreProperties.xsd
â”‚  â”‚  â”‚  â”‚          opc-digSig.xsd
â”‚  â”‚  â”‚  â”‚          opc-relationships.xsd
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ISO-IEC29500-4_2016
â”‚  â”‚  â”‚  â”‚      dml-chart.xsd
â”‚  â”‚  â”‚  â”‚      dml-chartDrawing.xsd
â”‚  â”‚  â”‚  â”‚      dml-diagram.xsd
â”‚  â”‚  â”‚  â”‚      dml-lockedCanvas.xsd
â”‚  â”‚  â”‚  â”‚      dml-main.xsd
â”‚  â”‚  â”‚  â”‚      dml-picture.xsd
â”‚  â”‚  â”‚  â”‚      dml-spreadsheetDrawing.xsd
â”‚  â”‚  â”‚  â”‚      dml-wordprocessingDrawing.xsd
â”‚  â”‚  â”‚  â”‚      pml.xsd
â”‚  â”‚  â”‚  â”‚      shared-additionalCharacteristics.xsd
â”‚  â”‚  â”‚  â”‚      shared-bibliography.xsd
â”‚  â”‚  â”‚  â”‚      shared-commonSimpleTypes.xsd
â”‚  â”‚  â”‚  â”‚      shared-customXmlDataProperties.xsd
â”‚  â”‚  â”‚  â”‚      shared-customXmlSchemaProperties.xsd
â”‚  â”‚  â”‚  â”‚      shared-documentPropertiesCustom.xsd
â”‚  â”‚  â”‚  â”‚      shared-documentPropertiesExtended.xsd
â”‚  â”‚  â”‚  â”‚      shared-documentPropertiesVariantTypes.xsd
â”‚  â”‚  â”‚  â”‚      shared-math.xsd
â”‚  â”‚  â”‚  â”‚      shared-relationshipReference.xsd
â”‚  â”‚  â”‚  â”‚      sml.xsd
â”‚  â”‚  â”‚  â”‚      vml-main.xsd
â”‚  â”‚  â”‚  â”‚      vml-officeDrawing.xsd
â”‚  â”‚  â”‚  â”‚      vml-presentationDrawing.xsd
â”‚  â”‚  â”‚  â”‚      vml-spreadsheetDrawing.xsd
â”‚  â”‚  â”‚  â”‚      vml-wordprocessingDrawing.xsd
â”‚  â”‚  â”‚  â”‚      wml.xsd
â”‚  â”‚  â”‚  â”‚      xml.xsd
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€mce
â”‚  â”‚  â”‚  â”‚      mc.xsd
â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€microsoft
â”‚  â”‚  â”‚          wml-2010.xsd
â”‚  â”‚  â”‚          wml-2012.xsd
â”‚  â”‚  â”‚          wml-2018.xsd
â”‚  â”‚  â”‚          wml-cex-2018.xsd
â”‚  â”‚  â”‚          wml-cid-2016.xsd
â”‚  â”‚  â”‚          wml-sdtdatahash-2020.xsd
â”‚  â”‚  â”‚          wml-symex-2015.xsd
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€scripts
â”‚  â”‚      â”‚  pack.py
â”‚  â”‚      â”‚  unpack.py
â”‚  â”‚      â”‚  validate.py
â”‚  â”‚      â”‚
â”‚  â”‚      â””â”€validation
â”‚  â”‚              base.py
â”‚  â”‚              docx.py
â”‚  â”‚              pptx.py
â”‚  â”‚              redlining.py
â”‚  â”‚              __init__.py
â”‚  â”‚
â”‚  â””â”€scripts
â”‚          html2pptx.js
â”‚          inventory.py
â”‚          rearrange.py
â”‚          replace.py
â”‚          thumbnail.py
â”‚
â”œâ”€sayhello
â”‚  â”‚  SKILL.md
â”‚  â”‚
â”‚  â””â”€scripts
â”‚          hello.bat
â”‚
â”œâ”€skill-creator
â”‚  â”‚  LICENSE.txt
â”‚  â”‚  SKILL.md
â”‚  â”‚
â”‚  â”œâ”€references
â”‚  â”‚      output-patterns.md
â”‚  â”‚      workflows.md
â”‚  â”‚
â”‚  â””â”€scripts
â”‚          init_skill.py
â”‚          package_skill.py
â”‚          quick_validate.py
â”‚
â””â”€xlsx
        LICENSE.txt
        recalc.py
        SKILL.md
```

## ä¿®æ”¹anywhere_main

1. åœ¨MCPå³ä¾§å¢åŠ ä¸€ä¸ªSKILLç•Œé¢ï¼Œç‚¹å‡»SKILLæŒ‰é’®ï¼Œè¿›å…¥SKILLç•Œé¢
2. ç”¨æˆ·éœ€è¦è®¾ç½®SKILLè·¯å¾„æ‰èƒ½å±•ç¤ºSKILLç•Œé¢ï¼Œè®¾ç½®è·¯å¾„åï¼ŒSKILLç•Œé¢å±•ç¤ºSKILLåˆ—è¡¨
3. æ¯ä¸€ä¸ªSKILLåˆ—è¡¨å±•ç¤ºäº†SKILLçš„åç§°ï¼Œæè¿°ï¼Œç”¨æˆ·å¯ä»¥è®¾ç½®å®ƒæ˜¯å¦å¯ç”¨ï¼Œæ˜¯å¦forkæ¨¡å¼ï¼ˆforkæ¨¡å¼è¡¨ç¤ºè°ƒç”¨å­Agentè°ƒç”¨è¯¥Agentï¼‰
4. ç”¨æˆ·ç‚¹å‡»SKILLåˆ—è¡¨ä¸­çš„SKILLï¼Œè¿›å…¥SKILLç•Œé¢ï¼Œå±•ç¤ºSKILLçš„è¯¦ç»†æè¿°ï¼Œä»¥åŠSKILLçš„è°ƒç”¨æ–¹å¼ï¼Œå¯ä»¥ä¿®æ”¹SKILLçš„åç§°ï¼Œç®€è¦æè¿°ï¼Œè¯¦ç»†æè¿°ï¼Œæ˜¯å¦å¯ç”¨ï¼Œæ˜¯å¦forkæ¨¡å¼ï¼Œå¯ä»¥ä¿®æ”¹SKILLçš„assetsã€scriptå’Œexamples
5. å¿«æ·åŠ©æ‰‹åº”è¯¥å¯ä»¥è®¾ç½®é»˜è®¤å¯ç”¨å“ªäº›skill


## ä¿®æ”¹anywhere_window

1. åœ¨MCPé€‰é¡¹å³è¾¹å¢åŠ ä¸€ä¸ªSKILLé€‰é¡¹ï¼Œç‚¹å‡»SKILLé€‰é¡¹ï¼Œè¿›å…¥SKILLç•Œé¢ï¼Œå±•ç¤ºskillåˆ—è¡¨ï¼Œå¯ä»¥é€‰æ‹©æœ¬æ¬¡å¯¹è¯ä¸­æ˜¯å¦å¯ç”¨
2. å¦‚æœæ˜¯forkæ¨¡å¼ï¼Œåº”è¯¥æ˜¾ç¤ºæé†’AIè°ƒç”¨å­Agentæ¥æ‰§è¡Œskill

## æ³¨æ„ï¼š

1. å¯¹äº`context: fork`ï¼Œæˆ‘ä»¬ä½¿ç”¨subagentå®ç°
2. å¯¹äº`user-invocable: false`ã€`argument-hint`ã€`model`ã€`agent`ã€`hooks`ï¼Œè¿™äº›å‚æ•°æˆ‘ä»¬æš‚æ—¶å¿½ç•¥ï¼Œå› ä¸ºå®ƒä»…ä»…é€‚ç”¨äºclaude code
3. å¯¹äº`disable-model-invocation: true`ï¼Œç”¨äºåœ¨anywhere_mainçš„skillä¸­æ˜¯å¦å¯ç”¨çš„å‚æ•°
4. skilçš„æœ¬è´¨æ˜¯æ¸è¿›å¼æŠ«éœ²ä¸Šä¸‹æ–‡ï¼Œå³åœ¨ä¸€ä¸ªå¯¹è¯ä¸­å¯ç”¨äº†ä¸€äº›skillæ—¶ï¼Œåªåœ¨skillå·¥å…·ä¸­æåŠç›¸å…³skillçš„åç§°åŠå…¶descriptionï¼Œè°ƒç”¨æ—¶ä¼šå°†skillè¯¦ç»†ä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡
5. claude codeåµŒå…¥skillè¯¦ç»†ä¿¡æ¯çš„æ–¹æ³•æ˜¯user promptï¼Œæˆ‘ä»¬ä¸æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨AIè°ƒç”¨skillçš„functionæ—¶ï¼Œç»™å‡ºè¯¦ç»†å†…å®¹ï¼ˆåŒ…æ‹¬skill instructionså’Œç›¸å…³ç›®å½•ç»“æ„ï¼Œå¦‚æœ`fork`åˆ™åº”è¯¥æ˜ç¤ºä½¿ç”¨subagentå·¥å…·è°ƒç”¨ï¼Œå¦‚æœæœ‰`allowed-tools: Read, Grep`åˆ™æ˜ç¤ºå…è®¸ä½¿ç”¨`Read, Grep`ç±»å‹çš„å·¥å…·ï¼‰ï¼Œç„¶åè®©AIéµå®ˆinstructionå®Œæˆä»»åŠ¡

---

å°±æœ¬è´¨ä¸Šï¼Œskillå°±æ˜¯ç”¨æˆ·å¯ä»¥æŒ‰ç…§æŒ‡å®šæ ¼å¼åœ¨æŒ‡å®šç›®å½•åˆ›å»ºæŒ‡ä»¤ã€è„šæœ¬ã€æ•°æ®ï¼Œå¯ç”¨è¯¥skillä¹‹åï¼ŒAIé»˜è®¤åªèƒ½çœ‹åˆ°ç®€å•çš„æè¿°ï¼Œè°ƒç”¨è¯¥skillæ—¶æ‰èƒ½çœ‹åˆ°è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶ä¸”ä¸“æ³¨æ‰§è¡Œè¯¥skill

è¯·ä½ é€æ­¥æ›´æ–°ä»£ç ï¼Œä»¥å®ç°skillåŠŸèƒ½ï¼é¦–å…ˆæ‰§è¡Œç¬¬ä¸€æ­¥ï¼Œæ›´æ–°backendï¼Œæ³¨æ„skillå·¥å…·ä¸åº”è¯¥å‡ºç°åœ¨mcpç®¡ç†ç•Œé¢ä¸­