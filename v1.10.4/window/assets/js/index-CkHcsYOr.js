const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./recorder-core-DIFCyGrP.js","./element-plus-B_ceYB1O.js","./vendor-utils-Biw9DGem.js","./ChatMessage-Bl9pd1C6.js","./mermaid-PPVm8Dsz.js","../css/ChatMessage-2l-Vy0KL.css"])))=>i.map(i=>d[i]);
import{c as ue,a as q,o as P,b as c,d as ge,e as l,w as r,u as n,f as $n,E as Y,m as Rt,h as Ot,i as Et,t as ke,j as ae,k as bo,n as Ee,l as At,p as Te,q as xo,r as Mn,s as Ut,v as Ln,x as po,y as _t,z as h,A as wt,B as Co,C as So,D as _n,F as ct,G as re,H as je,I as bt,J as Tn,K as H,L as En,M as An,N as Ft,O as Z,P as Nt,Q as Bn,R as et,S as In,T as zn,U as de,V as yt,W as fo,X as Pn,Y as Ht,Z as ne,_ as Qe,$ as Dn,a0 as Vn,a1 as Rn,a2 as On,a3 as Fn,a4 as vo,a5 as mo,a6 as Nn,a7 as Hn,a8 as go,a9 as Un,aa as Wn}from"./element-plus-B_ceYB1O.js";import{_ as xt}from"./mermaid-PPVm8Dsz.js";import{a as ho,p as wo,d as yo}from"./vendor-utils-Biw9DGem.js";(function(){const E=document.createElement("link").relList;if(E&&E.supports&&E.supports("modulepreload"))return;for(const I of document.querySelectorAll('link[rel="modulepreload"]'))_(I);new MutationObserver(I=>{for(const V of I)if(V.type==="childList")for(const A of V.addedNodes)A.tagName==="LINK"&&A.rel==="modulepreload"&&_(A)}).observe(document,{childList:!0,subtree:!0});function s(I){const V={};return I.integrity&&(V.integrity=I.integrity),I.referrerPolicy&&(V.referrerPolicy=I.referrerPolicy),I.crossOrigin==="use-credentials"?V.credentials="include":I.crossOrigin==="anonymous"?V.credentials="omit":V.credentials="same-origin",V}function _(I){if(I.ep)return;I.ep=!0;const V=s(I);fetch(I.href,V)}})();const Ct=(L,E)=>{const s=L.__vccOpts||L;for(const[_,I]of E)s[_]=I;return s},qn={class:"left-container"},jn={key:0,class:"window-controls mac-traffic-lights no-drag"},Kn={class:"app-info-inner"},Yn=["src"],Zn={class:"app-title"},Jn={class:"conversation-inner"},Xn={class:"conversation-title"},Gn={class:"right-container"},Qn={class:"function-group no-drag"},ea={key:0,viewBox:"0 0 24 24",width:"16",height:"16"},ta={key:1,viewBox:"0 0 24 24",width:"16",height:"16"},oa={key:0,viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor","stroke-width":"2"},na={key:1,viewBox:"0 0 24 24",width:"16",height:"16"},aa={key:0,class:"divider-vertical"},la={key:1,class:"window-controls win-controls no-drag"},sa={key:2,class:"window-controls linux-controls no-drag"},ia={__name:"TitleBar",props:{favicon:String,promptName:String,conversationName:String,isAlwaysOnTop:Boolean,autoCloseOnBlur:Boolean,isDarkMode:Boolean,os:{type:String,default:"win"}},emits:["save-window-size","save-session","toggle-pin","toggle-always-on-top","minimize","maximize","close"],setup(L,{emit:E}){const s=L,_=E,I=ue(()=>s.conversationName||"‰∏¥Êó∂ÂØπËØù"),V=ue(()=>s.os==="macos"||s.os==="darwin"),A=ue(()=>s.os==="win"),$=ue(()=>!V.value&&!A.value);return(U,C)=>(P(),q("div",{class:Ee(["title-bar",[`os-${L.os}`,{"dark-mode":L.isDarkMode}]])},[c("div",qn,[V.value?(P(),q("div",jn,[c("div",{class:"traffic-btn close",onClick:C[0]||(C[0]=D=>_("close"))},[l(n(Y),{class:"traffic-icon"},{default:r(()=>[l(n($n))]),_:1})]),c("div",{class:"traffic-btn minimize",onClick:C[1]||(C[1]=D=>_("minimize"))},[l(n(Y),{class:"traffic-icon icon-minus"},{default:r(()=>[l(n(Rt))]),_:1})]),c("div",{class:"traffic-btn maximize",onClick:C[2]||(C[2]=D=>_("maximize"))},[l(n(Y),{class:"traffic-icon icon-fullscreen"},{default:r(()=>[l(n(Ot))]),_:1})])])):ge("",!0),c("div",{class:"app-info no-drag",onClick:C[3]||(C[3]=D=>_("save-window-size")),onDblclick:C[4]||(C[4]=Et(D=>_("maximize"),["stop"]))},[l(n(ae),{content:"ÁÇπÂáª‰øùÂ≠òÂΩìÂâçÁ™óÂè£Â§ßÂ∞è‰∏é‰ΩçÁΩÆ / ÂèåÂáªÂÖ®Â±è",placement:"bottom","show-after":500},{default:r(()=>[c("div",Kn,[c("img",{src:L.favicon,class:"app-logo",alt:"Logo"},null,8,Yn),c("span",Zn,ke(L.promptName||"Anywhere"),1)])]),_:1})],32),C[15]||(C[15]=c("div",{class:"divider-vertical"},null,-1)),c("div",{class:"conversation-info no-drag",onClick:C[5]||(C[5]=D=>_("save-session")),onDblclick:C[6]||(C[6]=Et(D=>_("maximize"),["stop"]))},[l(n(ae),{content:"ÁÇπÂáª‰øùÂ≠ò‰ºöËØù",placement:"bottom","show-after":500},{default:r(()=>[c("div",Jn,[c("span",Xn,ke(I.value),1),l(n(Y),{class:"download-icon"},{default:r(()=>[l(n(bo))]),_:1})])]),_:1})],32)]),c("div",Gn,[c("div",Qn,[l(n(ae),{content:L.autoCloseOnBlur?"Â§±ÁÑ¶Ëá™Âä®ÂÖ≥Èó≠: ÂºÄ":"Â§±ÁÑ¶Ëá™Âä®ÂÖ≥Èó≠: ÂÖ≥",placement:"bottom","show-after":500},{default:r(()=>[c("div",{class:Ee(["func-btn",{active:!L.autoCloseOnBlur}]),onClick:C[7]||(C[7]=D=>_("toggle-pin"))},[L.autoCloseOnBlur?(P(),q("svg",ta,C[17]||(C[17]=[c("path",{fill:"currentColor",d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"},null,-1)]))):(P(),q("svg",ea,C[16]||(C[16]=[c("path",{fill:"currentColor",d:"M12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9h-1V7c0-2.76-2.24-5-5-5S7 4.24 7 7v1H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM8.9 7c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v1H8.9V7z"},null,-1)])))],2)]),_:1},8,["content"]),l(n(ae),{content:L.isAlwaysOnTop?"ÂèñÊ∂àÁΩÆÈ°∂":"ÁΩÆÈ°∂Á™óÂè£",placement:"bottom","show-after":500},{default:r(()=>[c("div",{class:Ee(["func-btn",{active:L.isAlwaysOnTop}]),onClick:C[8]||(C[8]=D=>_("toggle-always-on-top"))},[L.isAlwaysOnTop?(P(),q("svg",oa,C[18]||(C[18]=[c("path",{d:"M14.6358 3.90949C15.2888 3.47412 15.6153 3.25643 15.9711 3.29166C16.3269 3.32689 16.6044 3.60439 17.1594 4.15938L19.8406 6.84062C20.3956 7.39561 20.6731 7.67311 20.7083 8.02888C20.7436 8.38465 20.5259 8.71118 20.0905 9.36424L18.4419 11.8372C17.88 12.68 17.5991 13.1013 17.3749 13.5511C17.2086 13.8845 17.0659 14.2292 16.9476 14.5825C16.7882 15.0591 16.6889 15.5557 16.4902 16.5489L16.2992 17.5038C16.2986 17.5072 16.2982 17.5089 16.298 17.5101C16.1556 18.213 15.3414 18.5419 14.7508 18.1351C14.7497 18.1344 14.7483 18.1334 14.7455 18.1315V18.1315C14.7322 18.1223 14.7255 18.1177 14.7189 18.1131C11.2692 15.7225 8.27754 12.7308 5.88691 9.28108C5.88233 9.27448 5.87772 9.26782 5.86851 9.25451V9.25451C5.86655 9.25169 5.86558 9.25028 5.86486 9.24924C5.45815 8.65858 5.78704 7.84444 6.4899 7.70202C6.49113 7.70177 6.49282 7.70144 6.49618 7.70076L7.45114 7.50977C8.44433 7.31113 8.94092 7.21182 9.4175 7.05236C9.77083 6.93415 10.1155 6.79139 10.4489 6.62514C10.8987 6.40089 11.32 6.11998 12.1628 5.55815L14.6358 3.90949Z"},null,-1),c("path",{d:"M5 19L9.5 14.5","stroke-linecap":"round"},null,-1)]))):(P(),q("svg",na,C[19]||(C[19]=[c("path",{fill:"currentColor",d:"M20,8 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,8 L20,8 Z M20,9 L4,9 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,9 Z M3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,5.5 Z"},null,-1)])))],2)]),_:1},8,["content"])]),A.value?(P(),q("div",aa)):ge("",!0),A.value?(P(),q("div",la,[c("div",{class:"win-btn minimize",onClick:C[9]||(C[9]=D=>_("minimize")),title:"ÊúÄÂ∞èÂåñ"},[l(n(Y),null,{default:r(()=>[l(n(Rt))]),_:1})]),c("div",{class:"win-btn maximize",onClick:C[10]||(C[10]=D=>_("maximize")),title:"ÊúÄÂ§ßÂåñ"},[l(n(Y),null,{default:r(()=>[l(n(Ot))]),_:1})]),c("div",{class:"win-btn close",onClick:C[11]||(C[11]=D=>_("close")),title:"ÂÖ≥Èó≠"},[l(n(Y),null,{default:r(()=>[l(n(At))]),_:1})])])):ge("",!0),$.value?(P(),q("div",sa,[c("div",{class:"linux-btn minimize",onClick:C[12]||(C[12]=D=>_("minimize"))},[l(n(Y),null,{default:r(()=>[l(n(Rt))]),_:1})]),c("div",{class:"linux-btn maximize",onClick:C[13]||(C[13]=D=>_("maximize"))},[l(n(Y),null,{default:r(()=>[l(n(Ot))]),_:1})]),c("div",{class:"linux-btn close",onClick:C[14]||(C[14]=D=>_("close"))},[l(n(Y),null,{default:r(()=>[l(n(At))]),_:1})])])):ge("",!0)])],2))}},ra=Ct(ia,[["__scopeId","data-v-aedf69dd"]]),ca={class:"model-header-wrapper"},ua={class:"header-content-group"},da={class:"expandable-content"},pa={class:"model-text"},fa={key:0,class:"model-text prompt-text"},va={key:1,class:"model-text prompt-text placeholder"},ma={__name:"ChatHeader",props:{modelMap:Object,model:String,isMcpLoading:Boolean,systemPrompt:String},emits:["open-model-dialog","show-system-prompt","open-search"],setup(L,{emit:E}){const s=L,_=E,I=A=>{let $=0;for(let W=0;W<A.length;W++)$=A.charCodeAt(W)+(($<<5)-$);const U=Math.abs($)%360,C=60+Math.abs($)%20,D=50+Math.abs($)%10;return`hsl(${U}, ${C}%, ${D}%)`},V=ue(()=>{const A=s.model&&s.model.split("|")[1]||"default";return I(A)});return(A,$)=>(P(),Te(n(Ln),{class:"model-header"},{default:r(()=>[c("div",ca,[c("div",ua,[c("div",{class:Ee(["model-pill expandable-pill",{"is-disabled":L.isMcpLoading,"is-loading":L.isMcpLoading}]),onClick:$[0]||($[0]=U=>!L.isMcpLoading&&_("open-model-dialog"))},[c("div",{class:"model-logo-container",style:xo({color:L.isMcpLoading?"#F59E0B":V.value})},$[3]||($[3]=[c("svg",{class:"model-logo",width:"18",height:"18",viewBox:"0 0 32 32",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[c("g",{"clip-path":"url(#clip0_11482_204655)"},[c("path",{d:"M24.9439 24.7319C25.824 27.2847 25.4279 29.2944 23.7589 30.7231C22.2911 31.9822 19.8552 32.4878 18.3842 31.2946C16.8252 30.0291 15.9012 30.1076 14.3202 31.2914C12.7769 32.4438 10.8062 32.1141 9.19691 30.8926C7.59392 29.6743 7.04073 28.0069 7.33304 26.0413C7.39276 25.6425 7.7165 25.2908 7.5562 24.7633C6.48126 25.0396 5.45346 25.564 4.29051 25.3599C2.38579 25.0239 1.01225 24.0128 0.333338 22.1948C-0.370719 20.3076 0.0724596 18.6088 1.38942 17.1142C1.75717 16.6966 2.3795 16.4642 1.64087 15.6698C-0.226136 13.6602 -0.465012 11.5218 0.732513 9.54359C1.93004 7.56224 4.08621 6.84317 6.77043 7.53084C6.91815 7.62504 7.06588 7.71924 7.21046 7.8103C7.34562 7.55596 7.30161 7.34244 7.05645 7.17915C5.67662 3.03432 8.04024 -0.356908 12.0414 0.0324552C13.2515 0.148636 14.2196 0.732681 15.0462 1.57107C15.4266 1.95729 15.7126 2.19907 16.1683 1.65585C17.9442 -0.454249 20.9679 -0.259567 22.4577 0.713841C24.4316 2.00125 25.0162 3.81305 24.353 6.92167C24.3467 6.95307 24.4158 7.00017 24.5039 7.11007C25.3902 6.85259 26.286 6.41299 27.2824 6.49463C29.2782 6.65477 30.7649 7.58422 31.5664 9.43683C32.3899 11.3491 32.0159 13.0981 30.6958 14.6932C30.3815 15.0732 29.426 15.3401 30.3092 16.1157C32.4622 17.9965 32.2642 20.7849 31.2427 22.3769C29.9949 24.3206 28.1404 24.9674 25.3179 24.3928C25.1105 24.2107 24.8873 24.1541 24.639 24.3017C24.7427 24.4462 24.8465 24.5906 24.9502 24.7319H24.9439ZM2.46122 12.2315C2.45179 12.9694 2.87297 13.5974 3.44816 14.1657C4.96942 15.6666 6.46555 17.1896 7.98995 18.6873C8.91717 19.5948 9.87582 21.1554 10.8219 21.1585C11.7491 21.1585 12.6763 19.554 13.6067 18.6559C13.6821 18.5837 13.7513 18.5052 13.833 18.4393C14.295 18.0813 14.1504 17.783 13.7921 17.4282C11.3845 15.0481 9.01146 12.6334 6.58498 10.2721C5.80864 9.51533 4.8217 9.38031 3.83476 9.86702C2.91383 10.316 2.44236 11.0853 2.46122 12.2346V12.2315ZM12.1609 29.5267C12.9781 29.4671 13.5784 29.0997 14.1127 28.5596C15.6529 27.0053 17.2118 25.4667 18.7645 23.9249C20.6986 22.0011 20.6755 20.1213 18.6954 18.2854C18.62 18.2163 18.5477 18.1378 18.4817 18.0593C18.1925 17.7139 17.9316 17.7014 17.5984 18.0405C15.1468 20.5243 12.6606 22.9766 10.2341 25.4855C9.51436 26.2297 9.53322 27.2094 9.94811 28.1231C10.3787 29.0683 11.2022 29.4671 12.164 29.5299L12.1609 29.5267ZM21.0999 10.2156C20.1224 11.2926 19.2454 12.3257 18.2962 13.2865C17.8185 13.7701 17.8216 14.0715 18.3056 14.5457C20.6504 16.8442 22.9354 19.2023 25.2959 21.482C26.4589 22.6061 27.9204 22.5496 28.9168 21.4883C29.8377 20.5054 29.8283 19.0453 28.7879 17.9777C26.3174 15.4406 23.8092 12.9411 21.0999 10.2124V10.2156ZM22.3445 4.88066C22.3445 3.83189 21.8165 3.06258 20.927 2.62612C19.8866 2.11743 18.8934 2.35293 18.0668 3.1662C16.4355 4.77703 14.8105 6.39101 13.1949 8.01754C10.2907 10.9378 10.3127 10.9252 13.3741 13.6853C13.8927 14.1532 14.1284 14.1155 14.5905 13.6445C16.8504 11.3397 19.1511 9.07259 21.4393 6.79607C21.9737 6.26541 22.3382 5.65938 22.3445 4.88066ZM8.91717 4.83983C8.99575 5.81952 9.4075 6.66733 10.2058 7.07239C10.9979 7.47432 11.2399 6.46323 11.7083 6.08328C12.3494 5.56204 12.8932 4.92148 13.4904 4.34371C13.723 4.11763 13.9744 3.91667 13.6601 3.58382C12.8806 2.76114 12.0383 2.11429 10.7936 2.4754C9.58351 2.82708 9.05547 3.70001 8.91717 4.83983ZM27.1535 8.87791C26.0691 8.91873 25.2645 9.41799 24.859 10.1873C24.5039 10.8624 25.4374 11.1387 25.802 11.5752C26.33 12.2095 26.9523 12.7684 27.5558 13.3367C27.779 13.5471 27.9456 14.0181 28.4076 13.5754C29.2374 12.7778 29.8629 11.8986 29.4763 10.696C29.1054 9.54987 28.2693 8.92187 27.1535 8.88105V8.87791ZM4.46338 22.9766C5.9155 22.9986 6.72642 22.4962 7.13188 21.7332C7.53735 20.9701 6.51269 20.7127 6.13238 20.2354C5.62005 19.5885 4.97257 19.0516 4.40052 18.455C4.11136 18.1535 3.87248 18.0531 3.50788 18.3828C2.61209 19.1866 2.20034 20.1569 2.58066 21.3061C2.93898 22.3926 3.7719 22.9546 4.46338 22.9766ZM23.036 27.0649C23.0989 26.0036 22.5331 25.1778 21.7128 24.7633C21.1062 24.4556 20.7856 25.3725 20.3487 25.743C19.7169 26.2768 19.1731 26.9079 18.5822 27.492C18.3151 27.7557 18.0322 27.9881 18.4188 28.3869C19.1763 29.1656 20.0124 29.7528 21.1627 29.4325C22.3445 29.1028 22.9669 28.2895 23.0392 27.0681L23.036 27.0649Z",fill:"currentColor"})]),c("defs",null,[c("clipPath",{id:"clip0_11482_204655"},[c("rect",{width:"32",height:"32",fill:"white"})])])],-1)]),4),c("div",da,[c("span",pa,ke(L.isMcpLoading?"MCPÂ∑•ÂÖ∑Âä†ËΩΩ‰∏≠...":L.modelMap[L.model]||L.model||"ÈÄâÊã©Ê®°Âûã"),1),l(n(Y),{class:"arrow-icon",size:12},{default:r(()=>$[4]||($[4]=[c("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[c("path",{d:"M7 10L12 5L17 10",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),c("path",{d:"M7 14L12 19L17 14",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])),_:1})])],2),$[5]||($[5]=c("div",{class:"header-divider"},null,-1)),c("div",{class:"model-pill prompt-pill",onClick:$[1]||($[1]=U=>_("show-system-prompt"))},[l(n(Y),{size:14,class:"prompt-icon"},{default:r(()=>[l(n(Mn))]),_:1}),L.systemPrompt?(P(),q("span",fa,ke(L.systemPrompt),1)):(P(),q("span",va,"Á≥ªÁªüÊèêÁ§∫ËØç"))]),l(n(ae),{content:"ÊêúÁ¥¢ÂÜÖÂÆπ (Ctrl/Cmd+F)",placement:"bottom","show-after":500},{default:r(()=>[c("div",{class:"model-pill icon-pill",onClick:$[2]||($[2]=U=>_("open-search"))},[l(n(Y),{size:14,class:"header-icon"},{default:r(()=>[l(n(Ut))]),_:1})])]),_:1})])])]),_:1}))}},ga=Ct(ma,[["__scopeId","data-v-42168140"]]),ha={key:0,class:"drag-overlay"},wa={class:"file-card-container"},ya={class:"file-icon"},ba={class:"file-info"},xa=["title"],Ca={class:"file-size"},Sa={class:"file-actions"},ka={class:"waveform-display-area"},$a={key:1,class:"recording-status-text"},Ma={class:"option-selector-content"},La={class:"option-selector-content"},_a={class:"option-selector-content"},Ta={class:"chat-input-area-vertical"},Ea={class:"input-wrapper"},Aa={class:"input-actions-bar"},Ba={class:"action-buttons-left"},Ia={xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",class:"icon",style:{"margin-top":"-2px"}},za={class:"action-buttons-right"},Pa={__name:"ChatInput",props:po({loading:Boolean,ctrlEnterToSend:Boolean,voiceList:{type:Array,default:()=>[]},layout:{type:String,default:"horizontal"},isMcpActive:Boolean},{prompt:{},promptModifiers:{},fileList:{},fileListModifiers:{},selectedVoice:{},selectedVoiceModifiers:{},tempReasoningEffort:{},tempReasoningEffortModifiers:{}}),emits:po(["submit","cancel","clear-history","remove-file","upload","send-audio","open-mcp-dialog"],["update:prompt","update:fileList","update:selectedVoice","update:tempReasoningEffort"]),setup(L,{expose:E,emit:s}){const _=_t(L,"prompt"),I=_t(L,"fileList"),V=_t(L,"selectedVoice"),A=_t(L,"tempReasoningEffort"),$=L,U=s,C=h(null),D=h(null),W=h(null),j=h(!1),K=h(0),F=h(!1),pe=h(null),$e=h(null),tt=h(null),De=h(null),ut=h(null),He=h(null);let Ae=null,Ke=null,se=null,Ue=[],Me=null;const Le=h(null),B=h(!1),he=h(!1),we=h(!1),Be=h(!1),m=h($.voiceList||[]);wt(()=>$.voiceList,x=>{m.value=x||[]},{immediate:!0});const ye=ue(()=>`ÊÄùËÄÉÈ¢ÑÁÆó: ${{default:"ÈªòËÆ§",low:"‰Ωé",medium:"‰∏≠",high:"È´ò"}[A.value]||"ÈªòËÆ§"}`),Fe=()=>{const x=C.value?.$refs.textarea;if(!x)return;const d=x.selectionStart,R=x.selectionEnd,O=_.value;_.value=O.substring(0,d)+`
`+O.substring(R),de(()=>{x.selectionStart=x.selectionEnd=d+1,x.focus()})},fe=x=>{if(x.isComposing)return;if(F.value){(x.ctrlKey||x.metaKey)&&x.key.toLowerCase()==="c"||x.preventDefault();return}if(x.key!=="Enter")return;const d=x.ctrlKey||x.metaKey;$.ctrlEnterToSend?d&&(x.preventDefault(),$.loading||U("submit")):d?(x.preventDefault(),Fe()):x.shiftKey||(x.preventDefault(),$.loading||U("submit"))},Q=()=>{$.loading||U("submit")},dt=()=>U("cancel"),pt=()=>U("clear-history"),Ie=x=>U("remove-file",x),Ye=()=>{F.value||(we.value=!we.value,we.value&&(Be.value=!1,he.value=!1))},Ve=x=>{A.value=x,we.value=!1},N=async()=>{if(!F.value){if(!Be.value){try{const x=await window.api.getConfig();x?.config?.voiceList&&(m.value=x.config.voiceList)}catch(x){console.error("Âà∑Êñ∞ËØ≠Èü≥ÂàóË°®Â§±Ë¥•",x)}we.value=!1,he.value=!1}Be.value=!Be.value}},k=x=>{V.value=x,Be.value=!1},ie=()=>D.value?.click(),ot=x=>{const d=x.target.files;d.length&&U("upload",{file:d[0],fileList:Array.from(d)}),D.value&&(D.value.value="")},ve=x=>x.preventDefault(),be=x=>{ve(x),K.value++,j.value=!0},xe=x=>{ve(x),K.value--,K.value<=0&&(j.value=!1,K.value=0)},Ce=x=>{ve(x),j.value=!1,K.value=0;const d=x.dataTransfer.files;d&&d.length>0&&(U("upload",{file:d[0],fileList:Array.from(d)}),vt())},X=x=>{const d=x.clipboardData||window.clipboardData;if(!d)return;const R=Array.from(d.items).filter(O=>O.kind==="file");if(R.length>0){ve(x);const O=R.map(Se=>Se.getAsFile());U("upload",{file:O[0],fileList:O}),vt()}},Re=()=>{F.value||(he.value=!he.value,he.value&&(Be.value=!1,we.value=!1))},Ne=async x=>{if(he.value=!1,!F.value){F.value=!0,Le.value=x,B.value=!1;try{if(x==="microphone"){const R=(await xt(()=>import("./recorder-core-DIFCyGrP.js").then(O=>O.r),__vite__mapDeps([0,1,2]),import.meta.url)).default;await xt(()=>import("./waveview-BCcBXsEP.js"),[],import.meta.url),await xt(()=>import("./wav-Cwu-lTX3.js"),[],import.meta.url),await new Promise((O,Se)=>{R.TrafficFree=!0,Ae=R({type:"wav",sampleRate:16e3,bitRate:16,onProcess:(_e,Ze,Je,lt)=>{Ke&&Ke.input(_e[_e.length-1],Ze,lt)}}),Ae.open(()=>{de(()=>{W.value&&(Ke=R.WaveView({elem:W.value,lineWidth:3})),Ae.start(),O()})},(_e,Ze)=>{const Je=(Ze?"Áî®Êà∑ÊãíÁªù‰∫ÜÊùÉÈôê, ":"")+"Êó†Ê≥ïÂΩïÈü≥: "+_e;yt.error(Je),Ae=null,Se(new Error(Je))})})}else if(x==="system"){const d=await window.api.desktopCaptureSources({types:["screen","window"]});if(!d||d.length===0)throw new Error("Êú™ÊâæÂà∞ÂèØÁî®ÁöÑÁ≥ªÁªüÈü≥È¢ëÊ∫ê");Me=await navigator.mediaDevices.getUserMedia({audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:d[0].id}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:d[0].id}}}),Ue=[],se=new MediaRecorder(Me),se.ondataavailable=R=>Ue.push(R.data),se.onstop=()=>{if(B.value){ee();return}const R=new Blob(Ue,{type:"audio/wav"}),O=new Date,Se=`${O.getHours().toString().padStart(2,"0")}${O.getMinutes().toString().padStart(2,"0")}${O.getSeconds().toString().padStart(2,"0")}`,_e=new File([R],`audio-${Se}.wav`,{type:"audio/wav"});U("send-audio",_e),ee()},se.start()}}catch(d){console.error("ÂΩïÈü≥ÂêØÂä®Â§±Ë¥•:",d),yt.error(d.message||"Êó†Ê≥ïÂºÄÂßãÂΩïÈü≥"),ee()}}},ee=()=>{Ae&&(Ae.close(),Ae=null),Ke&&(W.value&&(W.value.innerHTML=""),Ke=null),se&&se.state==="recording"&&se.stop(),Me&&Me.getTracks().forEach(x=>x.stop()),se=null,Me=null,Ue=[],F.value=!1,Le.value=null},ft=()=>{B.value=!0,yt.info("ÂΩïÈü≥Â∑≤ÂèñÊ∂à"),Le.value==="microphone"&&Ae?Ae.stop(()=>ee(),()=>ee()):Le.value==="system"&&se&&se.stop()},ze=()=>{B.value=!1,Le.value==="microphone"&&Ae?Ae.stop(x=>{if(B.value){ee();return}const d=new Date,R=`${d.getHours().toString().padStart(2,"0")}${d.getMinutes().toString().padStart(2,"0")}${d.getSeconds().toString().padStart(2,"0")}`,O=new File([x],`audio-${R}.wav`,{type:"audio/wav"});U("send-audio",O),ee()},x=>{yt.error("ÂΩïÈü≥Â§±Ë¥•: "+x),ee()}):Le.value==="system"&&se&&se.stop()},We=x=>{const d=x.target;d&&(we.value&&pe.value&&!pe.value.contains(d)&&De.value&&!De.value.$el.contains(d)&&(we.value=!1),Be.value&&$e.value&&!$e.value.$el.contains(d)&&ut.value&&!ut.value.$el.contains(d)&&(Be.value=!1),he.value&&tt.value&&!tt.value.contains(d)&&He.value&&!He.value.$el.contains(d)&&(he.value=!1))};Co(()=>{window.addEventListener("dragenter",be),window.addEventListener("dragleave",xe),window.addEventListener("dragover",ve),window.addEventListener("drop",Ce),window.addEventListener("paste",X),document.addEventListener("click",We)}),So(()=>{window.removeEventListener("dragenter",be),window.removeEventListener("dragleave",xe),window.removeEventListener("dragover",ve),window.removeEventListener("drop",Ce),window.removeEventListener("paste",X),document.removeEventListener("click",We),ee()});const vt=(x={})=>{const d=C.value?.$refs.textarea;d&&(d.focus(),de(()=>{if(x.position&&typeof x.position.start=="number"){const R=_.value?.length||0,O=Math.min(x.position.start,R),Se=Math.min(x.position.end,R);d.setSelectionRange(O,Se)}else if(x.cursor==="end"){const R=_.value?.length||0;d.setSelectionRange(R,R)}}))};return E({focus:vt,senderRef:C}),(x,d)=>(P(),q(je,null,[j.value?(P(),q("div",ha,d[9]||(d[9]=[c("div",{class:"drag-overlay-content"}," ÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ‰ª•‰∏ä‰º† ",-1)]))):ge("",!0),l(n(zn),{class:"input-footer"},{default:r(()=>[I.value.length>0&&!F.value?(P(),Te(n(ct),{key:0},{default:r(()=>[l(n(re),{span:0}),l(n(re),{span:24},{default:r(()=>[c("div",wa,[(P(!0),q(je,null,bt(I.value,(R,O)=>(P(),q("div",{key:O,class:"custom-file-card"},[c("div",ya,[l(n(Y),{size:20},{default:r(()=>[l(n(Tn))]),_:1})]),c("div",ba,[c("div",{class:"file-name",title:R.name},ke(R.name),9,xa),c("div",Ca,ke((R.size/1024).toFixed(1))+" KB",1)]),c("div",Sa,[l(n(H),{type:"danger",link:"",icon:n(En),size:"small",onClick:Se=>Ie(O)},null,8,["icon","onClick"])])]))),128))])]),_:1}),l(n(re),{span:0})]),_:1})):ge("",!0),_n(l(n(ct),{class:"waveform-row"},{default:r(()=>[l(n(re),{span:0}),l(n(re),{span:24},{default:r(()=>[c("div",ka,[Le.value==="microphone"?(P(),q("div",{key:0,ref_key:"waveformCanvasContainer",ref:W,class:"waveform-canvas"},null,512)):(P(),q("span",$a,"Ê≠£Âú®ÂΩïÂà∂Á≥ªÁªüÈü≥È¢ë..."))])]),_:1}),l(n(re),{span:0})]),_:1},512),[[An,F.value]]),he.value?(P(),Te(n(ct),{key:1,class:"option-selector-row"},{default:r(()=>[l(n(re),{span:0}),l(n(re),{span:24},{default:r(()=>[c("div",{class:"option-selector-wrapper",ref_key:"audioSourceSelectorRef",ref:tt},[c("div",Ma,[l(n(Ft),{tag:"b",class:"selector-label"},{default:r(()=>d[10]||(d[10]=[Z("ÈÄâÊã©Èü≥Ê∫ê")])),_:1}),l(n(Nt),{direction:"vertical"}),l(n(H),{onClick:d[0]||(d[0]=R=>Ne("microphone")),round:""},{default:r(()=>d[11]||(d[11]=[Z("üéôÔ∏è È∫¶ÂÖãÈ£é")])),_:1}),l(n(H),{onClick:d[1]||(d[1]=R=>Ne("system")),round:""},{default:r(()=>d[12]||(d[12]=[Z("üíª Á≥ªÁªüÈü≥È¢ë")])),_:1})])],512)]),_:1}),l(n(re),{span:0})]),_:1})):ge("",!0),we.value?(P(),Te(n(ct),{key:2,class:"option-selector-row"},{default:r(()=>[l(n(re),{span:0}),l(n(re),{span:24},{default:r(()=>[c("div",{class:"option-selector-wrapper",ref_key:"reasoningSelectorRef",ref:pe},[c("div",La,[l(n(Ft),{tag:"b",class:"selector-label"},{default:r(()=>d[13]||(d[13]=[Z("ÊÄùËÄÉÈ¢ÑÁÆó")])),_:1}),l(n(Nt),{direction:"vertical"}),l(n(H),{onClick:d[2]||(d[2]=R=>Ve("default")),type:A.value==="default"?"primary":"default",round:""},{default:r(()=>d[14]||(d[14]=[Z("ÈªòËÆ§")])),_:1},8,["type"]),l(n(H),{onClick:d[3]||(d[3]=R=>Ve("low")),type:A.value==="low"?"primary":"default",round:""},{default:r(()=>d[15]||(d[15]=[Z("Âø´ÈÄü")])),_:1},8,["type"]),l(n(H),{onClick:d[4]||(d[4]=R=>Ve("medium")),type:A.value==="medium"?"primary":"default",round:""},{default:r(()=>d[16]||(d[16]=[Z("ÂùáË°°")])),_:1},8,["type"]),l(n(H),{onClick:d[5]||(d[5]=R=>Ve("high")),type:A.value==="high"?"primary":"default",round:""},{default:r(()=>d[17]||(d[17]=[Z("Ê∑±ÂÖ•")])),_:1},8,["type"])])],512)]),_:1}),l(n(re),{span:0})]),_:1})):ge("",!0),Be.value?(P(),Te(n(ct),{key:3,class:"option-selector-row"},{default:r(()=>[l(n(re),{span:0}),l(n(re),{span:24},{default:r(()=>[l(n(Bn),{class:"option-selector-wrapper",ref_key:"voiceSelectorRef",ref:$e},{default:r(()=>[c("div",_a,[l(n(Ft),{tag:"b",class:"selector-label"},{default:r(()=>d[18]||(d[18]=[Z("ÈÄâÊã©Èü≥Ëâ≤")])),_:1}),l(n(Nt),{direction:"vertical"}),l(n(H),{onClick:d[6]||(d[6]=R=>k(null)),type:V.value?"default":"primary",round:""},{default:r(()=>d[19]||(d[19]=[Z(" ÂÖ≥Èó≠ËØ≠Èü≥ ")])),_:1},8,["type"]),(P(!0),q(je,null,bt(m.value,R=>(P(),Te(n(H),{key:R,onClick:O=>k(R),type:V.value===R?"primary":"default",round:""},{default:r(()=>[Z(ke(R),1)]),_:2},1032,["onClick","type"]))),128))])]),_:1},512)]),_:1}),l(n(re),{span:0})]),_:1})):ge("",!0),l(n(ct),null,{default:r(()=>[l(n(re),{span:0}),l(n(re),{span:24},{default:r(()=>[c("div",Ta,[c("div",Ea,[l(n(et),{ref_key:"senderRef",ref:C,class:"chat-textarea-vertical",modelValue:_.value,"onUpdate:modelValue":d[7]||(d[7]=R=>_.value=R),type:"textarea",placeholder:F.value?"ÂΩïÈü≥‰∏≠... ÁªìÊùüÂêéÂ∞ÜËøûÂêåÊñáÊú¨‰∏ÄËµ∑ÂèëÈÄÅ":"ËæìÂÖ•„ÄÅÁ≤òË¥¥„ÄÅÊãñÊãΩ‰ª•ÂèëÈÄÅÂÜÖÂÆπ",autosize:{minRows:1,maxRows:15},resize:"none",onKeydown:fe,disabled:F.value},null,8,["modelValue","placeholder","disabled"])]),c("div",Aa,[c("div",Ba,[l(n(ae),{content:"Ê∏ÖÈô§ËÅäÂ§©ËÆ∞ÂΩï"},{default:r(()=>[l(n(H),{size:"default",onClick:pt,circle:"",disabled:F.value},{default:r(()=>[l(n(Y),{size:18},{default:r(()=>d[20]||(d[20]=[c("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"lucide lucide-paintbrush-vertical","aria-hidden":"true"},[c("path",{d:"M10 2v2"}),c("path",{d:"M14 2v4"}),c("path",{d:"M17 2a1 1 0 0 1 1 1v9H6V3a1 1 0 0 1 1-1z"}),c("path",{d:"M6 12a1 1 0 0 0-1 1v1a2 2 0 0 0 2 2h2a1 1 0 0 1 1 1v2.9a2 2 0 1 0 4 0V17a1 1 0 0 1 1-1h2a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1"})],-1)])),_:1})]),_:1},8,["disabled"])]),_:1}),l(n(ae),{content:"Ê∑ªÂä†ÈôÑ‰ª∂"},{default:r(()=>[l(n(H),{size:"default",onClick:ie,circle:"",disabled:F.value},{default:r(()=>[l(n(Y),{size:17},{default:r(()=>d[21]||(d[21]=[c("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"lucide lucide-paperclip","aria-hidden":"true"},[c("path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551"})],-1)])),_:1})]),_:1},8,["disabled"])]),_:1}),l(n(ae),{content:ye.value},{default:r(()=>[l(n(H),{ref_key:"reasoningButtonRef",ref:De,class:Ee({"is-active-special":A.value&&A.value!=="default"}),size:"default",circle:"",disabled:F.value,onClick:Ye},{default:r(()=>[l(n(Y),{size:18},{default:r(()=>[(P(),q("svg",Ia,d[22]||(d[22]=[c("path",{fill:"currentColor",d:"M1 11h3v2H1zm9 11c0 .6.4 1 1 1h2c.6 0 1-.4 1-1v-1h-4zm3-21h-2v3h2zM4.9 3.5L3.5 4.9L5.6 7L7 5.6zM20 11v2h3v-2zm-.9-7.5L17 5.6L18.4 7l2.1-2.1zM18 12c0 2.2-1.2 4.2-3 5.2V19c0 .6-.4 1-1 1h-4c-.6 0-1-.4-1-1v-1.8c-1.8-1-3-3-3-5.2c0-3.3 2.7-6 6-6s6 2.7 6 6M8 12c0 .35.05.68.14 1h7.72c.09-.32.14-.65.14-1c0-2.21-1.79-4-4-4s-4 1.79-4 4"},null,-1)])))]),_:1})]),_:1},8,["class","disabled"])]),_:1},8,["content"]),l(n(ae),{content:"ËØ≠Èü≥ÂõûÂ§çËÆæÁΩÆ"},{default:r(()=>[l(n(H),{ref_key:"voiceButtonRef",ref:ut,size:"default",circle:"",disabled:F.value,class:Ee({"is-active-special":V.value}),onClick:N},{default:r(()=>[l(n(Y),{size:18},{default:r(()=>d[23]||(d[23]=[c("svg",{t:"1765028999430",class:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"60819",width:"200",height:"200"},[c("path",{d:"M85.333333 512C85.333333 276.352 276.352 85.333333 512 85.333333s426.666667 191.018667 426.666667 426.666667-191.018667 426.666667-426.666667 426.666667H85.333333l124.970667-124.970667A425.344 425.344 0 0 1 85.333333 512z m205.994667 341.333333H512a341.333333 341.333333 0 1 0-341.333333-341.333333c0 91.818667 36.309333 177.706667 99.968 241.365333l60.330666 60.330667-39.637333 39.637333zM469.333333 256h85.333334v512h-85.333334V256zM298.666667 384h85.333333v256H298.666667V384z m341.333333 0h85.333333v256h-85.333333V384z","p-id":"60820"})],-1)])),_:1})]),_:1},8,["disabled","class"])]),_:1}),l(n(ae),{content:"MCPÂ∑•ÂÖ∑"},{default:r(()=>[l(n(H),{size:"default",circle:"",disabled:F.value,class:Ee({"is-active-special":L.isMcpActive}),onClick:d[8]||(d[8]=R=>x.$emit("open-mcp-dialog"))},{default:r(()=>[l(n(Y),{size:18},{default:r(()=>d[24]||(d[24]=[c("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"lucide lucide-hammer","aria-hidden":"true"},[c("path",{d:"m15 12-8.373 8.373a1 1 0 1 1-3-3L12 9"}),c("path",{d:"m18 15 4-4"}),c("path",{d:"m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172V7l-2.26-2.26a6 6 0 0 0-4.202-1.756L9 2.96l.92.82A6.18 6.18 0 0 1 12 8.4V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5"})],-1)])),_:1})]),_:1},8,["disabled","class"])]),_:1})]),c("div",za,[F.value?(P(),q(je,{key:0},[l(n(ae),{content:"ÂèñÊ∂àÂΩïÈü≥"},{default:r(()=>[l(n(H),{icon:n(At),size:"default",onClick:ft,circle:""},null,8,["icon"])]),_:1}),l(n(ae),{content:"ÁªìÊùüÂπ∂ÂèëÈÄÅ"},{default:r(()=>[l(n(H),{icon:n(In),size:"default",onClick:ze,circle:""},null,8,["icon"])]),_:1})],64)):(P(),q(je,{key:1},[l(n(ae),{content:"ÂèëÈÄÅËØ≠Èü≥"},{default:r(()=>[l(n(H),{ref_key:"audioButtonRef",ref:He,size:"default",onClick:Re,circle:""},{default:r(()=>[l(n(Y),{size:17},{default:r(()=>d[25]||(d[25]=[c("svg",{t:"1765029327206",class:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"68987",width:"200",height:"200"},[c("path",{d:"M516.368 732.288c126.944 0 230.096-99.696 230.096-222.272V230.272c0-122.56-103.28-222.272-230.096-222.272S286.16 107.696 286.16 230.272v279.744c0 122.56 103.28 222.272 230.208 222.272zM377.664 230.272c0-73.808 62.256-133.984 138.704-133.984 76.448 0 138.688 60.048 138.688 133.984v279.744c0 73.808-62.256 134-138.688 134-76.448 0-138.704-60.048-138.704-134V230.272z","p-id":"68988"}),c("path",{d:"M465.088 899.296C267.52 876.656 113.776 712.928 113.776 514.928c0-24.832 20.64-44.896 46.16-44.896 25.536 0 46.16 20.064 46.16 44.896 0 163.952 137.184 297.376 305.856 297.376 168.656 0 305.968-133.424 305.968-297.376 0-24.832 20.656-44.896 46.192-44.896 25.504 0 46.128 20.064 46.128 44.896 0 196.976-152.096 359.872-348.16 384.016v68.592A48.416 48.416 0 0 1 513.6 1016a48.448 48.448 0 0 1-48.496-48.464v-68.24z","p-id":"68989"})],-1)])),_:1})]),_:1},512)]),_:1}),L.loading?(P(),Te(n(H),{key:1,onClick:dt,circle:"",class:"cancel-button-animated"},{default:r(()=>[l(n(Y),{class:"static-icon"},{default:r(()=>[l(n(At))]),_:1}),d[27]||(d[27]=c("div",{class:"cancel-spinner"},null,-1))]),_:1})):(P(),Te(n(H),{key:0,onClick:Q,circle:"",disabled:L.loading},{default:r(()=>[l(n(Y),{size:18},{default:r(()=>d[26]||(d[26]=[c("svg",{t:"1765029205363",class:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"63447",width:"200",height:"200"},[c("path",{d:"M866.133333 298.666667l-277.333333 396.8 174.933333 64L866.133333 298.666667zM469.333333 691.2l362.666667-482.133333-652.8 332.8 230.4 72.533333c21.333333 8.533333 29.866667 29.866667 21.333333 51.2v4.266667c-12.8 21.333333-42.666667 34.133333-68.266666 21.333333L76.8 597.333333c-21.333333-8.533333-34.133333-29.866667-25.6-55.466666 4.266667-8.533333 12.8-17.066667 21.333333-25.6L913.066667 72.533333c21.333333-12.8 46.933333-4.266667 59.733333 17.066667 4.266667 8.533333 4.266667 17.066667 4.266667 29.866667l-140.8 699.733333c-4.266667 21.333333-25.6 38.4-51.2 34.133333h-4.266667l-238.933333-89.6v162.133334c0 21.333333-17.066667 38.4-38.4 42.666666-21.333333 0-38.4-17.066667-38.4-42.666666","p-id":"63448"})],-1)])),_:1})]),_:1},8,["disabled"]))],64))])])]),c("input",{ref_key:"fileInputRef",ref:D,type:"file",multiple:"",onChange:ot,style:{display:"none"}},null,544)]),_:1}),l(n(re),{span:0})]),_:1})]),_:1})],64))}},Da=Ct(Pa,[["__scopeId","data-v-ac34c146"]]),Va={class:"model-search-container"},Ra={__name:"ModelSelectionDialog",props:{modelValue:Boolean,modelList:Array,currentModel:String},emits:["update:modelValue","select","save-model"],setup(L,{emit:E}){const s=L,_=E,I=h(""),V=h(null),A=()=>{V.value&&V.value.focus()},$=ue(()=>{if(!I.value)return s.modelList;const W=I.value.toLowerCase();return s.modelList.filter(j=>j.label.toLowerCase().includes(W))}),U=({row:W,column:j,rowIndex:K,columnIndex:F})=>{if(F===0){if(K>0&&$.value[K-1].label.split("|")[0]===W.label.split("|")[0])return{rowspan:0,colspan:0};let pe=1;for(let $e=K+1;$e<$.value.length&&$.value[$e].label.split("|")[0]===W.label.split("|")[0];$e++)pe++;return{rowspan:pe,colspan:1}}},C=W=>{W.value===s.currentModel?_("save-model",W.value):_("select",W.value)},D=()=>{I.value="",_("update:modelValue",!1)};return(W,j)=>(P(),Te(n(Ht),{"model-value":L.modelValue,"onUpdate:modelValue":D,width:"80%","custom-class":"model-dialog no-header-dialog",onOpened:A,"show-close":!1},{header:r(()=>j[1]||(j[1]=[c("div",{style:{display:"none"}},null,-1)])),footer:r(()=>[l(n(H),{onClick:D},{default:r(()=>j[2]||(j[2]=[Z("ÂÖ≥Èó≠")])),_:1})]),default:r(()=>[c("div",Va,[l(n(et),{ref_key:"searchInputRef",ref:V,modelValue:I.value,"onUpdate:modelValue":j[0]||(j[0]=K=>I.value=K),placeholder:"ÊêúÁ¥¢ÊúçÂä°ÂïÜÊàñÊ®°ÂûãÂêçÁß∞...",clearable:"","prefix-icon":n(Ut)},null,8,["modelValue","prefix-icon"])]),l(n(Pn),{data:$.value,stripe:"",style:{width:"100%"},"max-height":"50vh",border:!0,"span-method":U,width:"100%"},{default:r(()=>[l(n(fo),{label:"ÊúçÂä°ÂïÜ",align:"center",prop:"provider",width:"120"},{default:r(K=>[c("strong",null,ke(K.row.label.split("|")[0]),1)]),_:1}),l(n(fo),{label:"Ê®°Âûã",align:"center",prop:"modelName"},{default:r(K=>[l(n(ae),{content:K.row.value===L.currentModel?"ÂΩìÂâçÊ®°ÂûãÔºåÂÜçÊ¨°ÁÇπÂáªÂèØ‰øùÂ≠ò‰∏∫ÈªòËÆ§":"ÈÄâÊã©Ê≠§Ê®°Âûã",placement:"top",enterable:!1},{default:r(()=>[l(n(H),{link:"",size:"large",onClick:F=>C(K.row),class:Ee({"is-current-model":K.row.value===L.currentModel})},{default:r(()=>[Z(ke(K.row.label.split("|")[1]),1)]),_:2},1032,["onClick","class"])]),_:2},1032,["content"])]),_:1})]),_:1},8,["data"])]),_:1},8,["model-value"]))}},Oa=Ct(Ra,[["__scopeId","data-v-f79263e1"]]);class Fa{constructor(E={}){this.options=Object.assign({theme:"auto",scope:"body",beforeShow:null},E),this.container=null,this.input=null,this.matches=[],this.currentIndex=-1,this.isOpen=!1,this.searchScope=null,this._handleResize=this._constrainToWindow.bind(this),this._init()}_init(){this._injectStyles(),this._createUI(),this._bindEvents(),this.setTheme(this.options.theme),this.setScope(this.options.scope)}_injectStyles(){const E="text-search-ui-style";if(document.getElementById(E))return;const s=`
      :root {
        --ts-bg: #ffffff;
        --ts-text: #333333;
        --ts-border: #e5e7eb;
        --ts-hover: #f3f4f6;
        --ts-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --ts-highlight: #ffeb3b;
        --ts-highlight-current: #ff9800;
        --ts-highlight-text: #000000;
      }
      
      [data-search-theme="dark"] {
        --ts-bg: #2a2a2a;
        --ts-text: #e5e7eb;
        --ts-border: #4b5563;
        --ts-hover: #374151;
        --ts-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        --ts-highlight: #b45309;
        --ts-highlight-current: #f59e0b;
        --ts-highlight-text: #ffffff;
      }

      .text-search-container {
        position: fixed;
        top: 20px;
        right: 40px;
        z-index: 10000;
        background: var(--ts-bg);
        color: var(--ts-text);
        padding: 8px;
        border-radius: 6px;
        box-shadow: var(--ts-shadow);
        border: 1px solid var(--ts-border);
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 14px;
        transition: opacity 0.2s;
        min-width: 300px;
      }

      .text-search-container.hidden {
        opacity: 0;
        pointer-events: none;
        /* ÈöêËóèÊó∂‰∏çÊîπÂèò‰ΩçÁΩÆÔºåÈÅøÂÖçÂä®Áîª‰π±Ë∑≥ÔºåÂè™ÊîπÈÄèÊòéÂ∫¶ÂíåÁÇπÂáªÁ©øÈÄè */
        visibility: hidden; 
      }

      .text-search-drag-handle {
        cursor: move;
        color: var(--ts-text);
        opacity: 0.5;
        padding: 0 4px;
        user-select: none;
      }

      .text-search-input {
        background: transparent;
        border: none;
        color: var(--ts-text);
        outline: none;
        flex-grow: 1;
        width: 120px;
        font-size: 14px;
      }

      .text-search-count {
        font-size: 12px;
        color: var(--ts-text);
        opacity: 0.7;
        white-space: nowrap;
        min-width: 40px;
        text-align: center;
        user-select: none;
      }

      .text-search-divider {
        width: 1px;
        height: 16px;
        background: var(--ts-border);
        margin: 0 4px;
      }

      .text-search-btn {
        background: transparent;
        border: none;
        color: var(--ts-text);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.1s;
      }

      .text-search-btn:hover {
        background: var(--ts-hover);
      }

      .text-search-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      mark.search-highlight {
        background-color: var(--ts-highlight);
        color: var(--ts-highlight-text);
        border-radius: 2px;
        padding: 0 1px;
      }

      mark.search-highlight.current {
        background-color: var(--ts-highlight-current);
        color: var(--ts-highlight-text);
        outline: 2px solid rgba(255, 255, 255, 0.3);
      }
    `,_=document.createElement("style");_.id=E,_.textContent=s,document.head.appendChild(_)}_createUI(){this.container=document.createElement("div"),this.container.className="text-search-container hidden",this.container.innerHTML=`
      <div class="text-search-drag-handle">‚ãÆ‚ãÆ</div>
      <input type="text" class="text-search-input" placeholder="Êü•ÊâæÊ∂àÊÅØ..." />
      <span class="text-search-count">0/0</span>
      <div class="text-search-divider"></div>
      <button class="text-search-btn btn-prev" title="‰∏ä‰∏Ä‰∏™ (Shift+Enter)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
      </button>
      <button class="text-search-btn btn-next" title="‰∏ã‰∏Ä‰∏™ (Enter)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
      </button>
      <button class="text-search-btn btn-close" title="ÂÖ≥Èó≠ (Esc)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    `,document.body.appendChild(this.container),this.input=this.container.querySelector(".text-search-input"),this.countSpan=this.container.querySelector(".text-search-count"),this.btnPrev=this.container.querySelector(".btn-prev"),this.btnNext=this.container.querySelector(".btn-next"),this.btnClose=this.container.querySelector(".btn-close")}_bindEvents(){this.input.addEventListener("input",$=>{this.search($.target.value)}),this.input.addEventListener("keydown",$=>{$.key==="Enter"&&($.preventDefault(),$.shiftKey?this.findPrevious():this.findNext())}),this.btnPrev.addEventListener("click",()=>this.findPrevious()),this.btnNext.addEventListener("click",()=>this.findNext()),this.btnClose.addEventListener("click",()=>this.hide()),document.addEventListener("keydown",$=>{($.ctrlKey||$.metaKey)&&$.key==="f"&&($.preventDefault(),this.show()),$.key==="Escape"&&this.isOpen&&($.preventDefault(),this.hide())}),window.addEventListener("resize",this._handleResize);const E=this.container.querySelector(".text-search-drag-handle");let s=!1,_,I,V,A;E.addEventListener("mousedown",$=>{s=!0,_=$.clientX,I=$.clientY;const U=this.container.getBoundingClientRect();V=U.left,A=U.top,this.container.style.right="auto",this.container.style.width=U.width+"px"}),document.addEventListener("mousemove",$=>{if(!s)return;$.preventDefault();const U=$.clientX-_,C=$.clientY-I;let D=V+U,W=A+C;const j=window.innerWidth,K=window.innerHeight,F=this.container.getBoundingClientRect();D<0?D=0:D+F.width>j&&(D=j-F.width),W<0?W=0:W+F.height>K&&(W=K-F.height),this.container.style.left=`${D}px`,this.container.style.top=`${W}px`}),document.addEventListener("mouseup",()=>{s=!1})}_constrainToWindow(){if(!this.container)return;const E=this.container.getBoundingClientRect(),s=window.innerWidth,_=window.innerHeight;let I=E.left,V=E.top,A=!1;E.right>s&&(I=s-E.width,I<0&&(I=0),A=!0),E.bottom>_&&(V=_-E.height,V<0&&(V=0),A=!0),A&&(this.container.style.left=`${I}px`,this.container.style.top=`${V}px`,this.container.style.right="auto")}setScope(E){typeof E=="string"?this.searchScope=document.querySelector(E):E instanceof HTMLElement?this.searchScope=E:this.searchScope=document.body}setTheme(E){if(E==="auto"){const s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;document.body.setAttribute("data-search-theme",s?"dark":"light")}else document.body.setAttribute("data-search-theme",E)}show(){this.options.beforeShow&&this.options.beforeShow(),this.container.classList.remove("hidden"),this.isOpen=!0,this._constrainToWindow(),setTimeout(()=>this.input.focus(),50),this.input.value&&this.search(this.input.value)}hide(){this.container.classList.add("hidden"),this.isOpen=!1,this.clear(),document.activeElement.blur()}clear(){this.searchScope.querySelectorAll("mark.search-highlight").forEach(s=>{const _=s.parentNode;_.replaceChild(document.createTextNode(s.textContent),s),_.normalize()}),this.matches=[],this.currentIndex=-1,this.updateCount()}search(E){if(this.clear(),!E)return;const s=new RegExp(E.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"),_=document.createTreeWalker(this.searchScope,NodeFilter.SHOW_TEXT,{acceptNode:A=>A.parentElement.closest(".text-search-container, script, style, .no-search")?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}),I=[];let V;for(;V=_.nextNode();)I.push(V);for(const A of I){const $=A.nodeValue;let U,C=0;const D=[];let W=!1;for(s.lastIndex=0;(U=s.exec($))!==null;){W=!0,U.index>C&&D.push(document.createTextNode($.substring(C,U.index)));const j=document.createElement("mark");j.className="search-highlight",j.textContent=U[0],D.push(j),this.matches.push(j),C=s.lastIndex}if(W){C<$.length&&D.push(document.createTextNode($.substring(C)));const j=A.parentNode;D.forEach(K=>j.insertBefore(K,A)),j.removeChild(A)}}this.matches.length>0&&this.jumpTo(0),this.updateCount()}jumpTo(E){if(this.matches.length===0)return;this.currentIndex>=0&&this.matches[this.currentIndex]&&this.matches[this.currentIndex].classList.remove("current"),this.currentIndex=(E+this.matches.length)%this.matches.length;const s=this.matches[this.currentIndex];s.classList.add("current"),s.scrollIntoView({behavior:"smooth",block:"center"}),this.updateCount()}findNext(){this.jumpTo(this.currentIndex+1)}findPrevious(){this.jumpTo(this.currentIndex-1)}updateCount(){const E=this.matches.length,s=E===0?0:this.currentIndex+1;this.countSpan.textContent=`${s}/${E}`,this.btnPrev.disabled=E===0,this.btnNext.disabled=E===0}destroy(){window.removeEventListener("resize",this._handleResize),this.container&&this.container.remove()}}const Tt=L=>{if(!L)return"";try{const E=new Date(L),s=E.toLocaleDateString("sv-SE"),_=E.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});return`${s} ${_}`}catch{return""}},ul=L=>{if(!L)return"";if(!Array.isArray(L))return String(L);let E="";return L.forEach(s=>{s.type==="text"&&s.text&&!(s.text.toLowerCase().startsWith("file name:")&&s.text.toLowerCase().endsWith("file end"))&&(E+=s.text)}),E.trim()},Na=L=>{if(!L)return"{}";try{return JSON.parse(L),L}catch{let s=L.indexOf("{");if(s===-1)return"{}";let _=0;for(let I=s;I<L.length;I++)if(L[I]==="{"?_++:L[I]==="}"&&_--,_===0){const V=L.substring(s,I+1);try{return JSON.parse(V),V}catch{return"{}"}}return"{}"}},Ha={key:0,class:"window-bg-base"},Ua={class:"main-area-wrapper"},Wa={key:0,class:"scroll-to-bottom-wrapper"},qa={key:1,class:"custom-viewer-actions"},ja={class:"mcp-dialog-content"},Ka={class:"mcp-dialog-toolbar"},Ya={class:"mcp-server-list custom-scrollbar"},Za=["onClick"],Ja={class:"mcp-server-content"},Xa={class:"mcp-server-header-row"},Ga={class:"mcp-server-name"},Qa={class:"mcp-server-tags"},el={key:0,class:"mcp-server-description"},tl={class:"mcp-dialog-footer-search"},ol={class:"mcp-dialog-footer"},nl={class:"footer-left-controls"},al={__name:"App",setup(L){const E=Vn(()=>xt(()=>import("./ChatMessage-Bl9pd1C6.js").then(e=>e.a7),__vite__mapDeps([3,1,4,2,5]),import.meta.url)),s=e=>{const t=typeof e=="string"?{message:e}:e,o=t.duration!==void 0?t.duration:1e3;let a=null;const i={...t,duration:o,showClose:!1,grouping:!0,offset:40,onClick:()=>{a&&a.close()}};a=yt(i)};s.success=e=>s({message:e,type:"success"}),s.error=e=>s({message:e,type:"error"}),s.info=e=>s({message:e,type:"info"}),s.warning=e=>s({message:e,type:"warning"});const _=()=>window.api.windowControl("minimize-window"),I=()=>window.api.windowControl("maximize-window"),V=()=>window.api.windowControl("close-window"),A=h(null),$=h(null),U=h(null),C=h(null),D=h(!0),W=h(!1),j=h(!1),K=new Map,F=h(null),pe=h(!0);let $e=null,tt=null,De=null;const ut=(e,t)=>{e?K.set(t,e):K.delete(t)},He=e=>{const t=k.value[e];if(t)return K.get(t.id)},Ke=new URLSearchParams(window.location.search).get("dark")==="1";Ke&&document.documentElement.classList.add("dark");const se=window.api.defaultConfig,Ue=h("user.png"),Me=h("ai.svg"),Le=h("favicon.png"),B=h(""),he=h(!1),we=h({os:"macos",code:"AI",type:"over",payload:"ËØ∑ÁÆÄÊ¥ÅÂú∞‰ªãÁªç‰∏Ä‰∏ã‰Ω†Ëá™Â∑±"}),Be=JSON.parse(JSON.stringify(se.config));Ke&&(Be.isDarkMode=!0);const m=h(Be),ye=h(!1),Fe=h([]),fe=h({}),Q=h(""),dt=h(!0),pt=h("win"),Ie=h(se.config.providerOrder[0]),Ye=h(""),Ve=h(""),N=h([]),k=h([]),ie=h(!1),ot=h(""),ve=h(null),be=h([]),xe=h(1),Ce=h(new Set),X=h(""),Re=h(null),Ne=h("default"),ee=h(0),ft=h(null),ze=h(""),We=ue(()=>ze.value?ze.value:!B.value||!m.value?.prompts?"":m.value.prompts[B.value]?.backgroundImage||""),vt=ue(()=>!B.value||!m.value?.prompts?.5:m.value.prompts[B.value]?.backgroundOpacity??.5),x=ue(()=>!B.value||!m.value?.prompts?0:m.value.prompts[B.value]?.backgroundBlur??0),d=async e=>{if(!e){ze.value&&(ze.value.startsWith("blob:")&&URL.revokeObjectURL(ze.value),ze.value="");return}if(!(e.startsWith("data:")||e.startsWith("file:")))try{const t=await window.api.getCachedBackgroundImage(e);if(t){const o=new Blob([t]),a=URL.createObjectURL(o);ze.value&&ze.value.startsWith("blob:")&&URL.revokeObjectURL(ze.value),ze.value=a}else console.log(`[Background] Cache miss, downloading in background: ${e}`),window.api.cacheBackgroundImage(e)}catch(t){console.error("Failed to load cached background:",t)}};wt(()=>!B.value||!m.value?.prompts?null:m.value.prompts[B.value]?.backgroundImage,async e=>{await d(e)},{immediate:!1});const R=ue(()=>m.value.inputLayout||"horizontal"),O=h(""),Se=h(!1),_e=h(!1),Ze=h(""),Je=h(!1),lt=h([]),Wt=h(0),St=h(new Map),ce=h([]),Xe=h(!0),mt=h(new Map),qt=(e,t)=>{const o=mt.value.get(e);o&&(o(t),mt.value.delete(e))},ko=e=>{Xe.value=e,e&&(mt.value.forEach((t,o)=>{t(!0)}),mt.value.clear(),k.value.forEach(t=>{t.tool_calls&&t.tool_calls.forEach(o=>{o.approvalStatus==="waiting"&&(o.approvalStatus="approved")})}))},st=h(!1),Oe=h([]),it=h([]),kt=h(""),$t=h(!1),Ge=h("all"),$o=ue(()=>Oe.value.length>0),jt=ue(()=>{if(!m.value||!m.value.mcpServers)return 0;const e=ce.value.filter(o=>{const a=m.value.mcpServers[o];return a&&a.isPersistent&&a.type?.toLowerCase()!=="builtin"}).length,t=ce.value.some(o=>{const a=m.value.mcpServers[o];return a&&!a.isPersistent&&a.type?.toLowerCase()!=="builtin"});return e+(t?1:0)}),Mo=ue(()=>!m.value||!m.value.mcpServers?[]:Object.entries(m.value.mcpServers).filter(([,e])=>e.isActive).map(([e,t])=>({id:e,...t})).sort((e,t)=>e.name.localeCompare(t.name))),Kt=ue(()=>{let e=Mo.value;if(Ge.value==="selected"?e=e.filter(t=>ce.value.includes(t.id)):Ge.value==="unselected"&&(e=e.filter(t=>!ce.value.includes(t.id))),kt.value){const t=kt.value.toLowerCase();e=e.filter(o=>o.name&&o.name.toLowerCase().includes(t)||o.description&&o.description.toLowerCase().includes(t)||o.tags&&Array.isArray(o.tags)&&o.tags.some(a=>a.toLowerCase().includes(t))||o.type&&o.type.toLowerCase().includes(t)||o.type&&ro(o.type).toLowerCase().includes(t))}return e}),Lo=ue(()=>F.value===null?!1:F.value===k.value.length-1),_o=ue(()=>Lo.value?"ÊªöÂä®Âà∞Â∫ïÈÉ®":"Êü•Áúã‰∏ã‰∏ÄÊù°Ê∂àÊÅØ"),gt=async(e="auto")=>{await de();const t=C.value?.$el;t&&(pe.value=!0,t.scrollTo({top:t.scrollHeight,behavior:e}))},To=()=>{const e=C.value?.$el;e&&e.scrollTo({top:0,behavior:"smooth"})},Yt=()=>{j.value=!0,pe.value=!0,D.value=!0,W.value=!1,F.value=null,gt("smooth"),setTimeout(()=>{j.value=!1},500)},Bt=()=>{const e=C.value?.$el;if(!e)return;const t=e.scrollTop;let o=-1,a=1/0;for(let i=k.value.length-1;i>=0;i--){const f=He(i);if(f){const g=f.$el,p=g.offsetTop,v=p+g.clientHeight;if(p<t+e.clientHeight&&v>t){const y=Math.abs(p-t);y<a&&(a=y,o=i)}}}o!==-1&&(F.value=o)},Eo=e=>{if(j.value)return;const t=e.target;if(!t)return;t.scrollHeight-t.scrollTop-t.clientHeight<=20?(pe.value||(pe.value=!0),D.value||(D.value=!0),W.value=!1,F.value=null):(pe.value&&(pe.value=!1),D.value&&(D.value=!1),W.value=!0,Bt())},Ao=()=>{Bt();const e=F.value;if(e===null)return;const t=He(e),o=C.value?.$el;if(!t||!o)return;const a=t.$el;if(o.scrollTop-a.offsetTop>5)a.scrollIntoView({behavior:"smooth",block:"start"});else if(e>0){const f=e-1;F.value=f;const g=He(f);g&&g.$el.scrollIntoView({behavior:"smooth",block:"start"})}},Bo=()=>{if(Bt(),F.value!==null&&F.value<k.value.length-1){F.value++;const e=He(F.value);e&&e.$el.scrollIntoView({behavior:"smooth",block:"start"})}else Yt()},Zt=e=>Ce.value.has(e),Jt=async()=>{await de(),document.querySelectorAll(".markdown-body pre.hljs").forEach(e=>{if(e.querySelector(".code-block-copy-button"))return;const t=e.querySelector("code");if(!t)return;const o=document.createElement("div");o.className="code-block-wrapper",e.parentNode.insertBefore(o,e),o.appendChild(e);const a=t.textContent||"",f=a.trimEnd().split(`
`).length,g='<svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>',p=v=>{const y=document.createElement("button");y.className=`code-block-copy-button ${v}`,y.innerHTML=g,y.title="Copy code",y.addEventListener("click",async u=>{u.stopPropagation();try{await navigator.clipboard.writeText(a.trimEnd()),s.success("Code copied to clipboard!")}catch(S){console.error("Failed to copy code:",S),s.error("Failed to copy code.")}}),o.appendChild(y)};p("code-block-copy-button-bottom"),f>3&&p("code-block-copy-button-top")})},It=e=>{if(e.target.tagName!=="IMG"||!e.target.closest(".markdown-wrapper"))return;const t=e.target;t&&t.src&&(lt.value=[t.src],Wt.value=0,Je.value=!0)},Xt=e=>{if(e.ctrlKey){e.preventDefault();const t=.05;let o=e.deltaY<0?xe.value+t:xe.value-t;xe.value=Math.max(.5,Math.min(2,o)),m.value&&(m.value.zoom=xe.value)}},Io=()=>tn(),zo=async()=>{try{const e=await window.api.getConfig();if(e&&e.config){m.value.providers=e.config.providers,m.value.providerOrder=e.config.providerOrder;const t=[],o={};if(m.value.providerOrder.forEach(a=>{const i=m.value.providers[a];i?.enable&&i.modelList.forEach(f=>{const g=`${a}|${f}`;t.push({key:g,value:g,label:`${i.name}|${f}`}),o[g]=`${i.name}|${f}`})}),Fe.value=t,fe.value=o,Ie.value&&m.value.providers[Ie.value]){const a=m.value.providers[Ie.value];Ye.value=a.url,Ve.value=a.api_key}}}catch(e){console.warn("Ëá™Âä®Âà∑Êñ∞Ê®°ÂûãÂàóË°®Â§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ",e)}Se.value=!0},Po=e=>{Q.value=e,Ie.value=e.split("|")[0];const t=m.value.providers[Ie.value];Ye.value=t.url,Ve.value=t.api_key,A.value?.focus({cursor:"end"})},zt=()=>{ye.value=!ye.value,ye.value?window.addEventListener("blur",Mt):window.removeEventListener("blur",Mt)},Do=()=>{window.api.toggleAlwaysOnTop()},Vo=()=>no(),Ro=e=>wn(e),Oo=(e,t)=>hn(e,t),Fo=()=>so(),Gt=()=>{Ze.value=O.value,_e.value=!0},No=async(e,t)=>{const o=C.value?.$el,a=t.currentTarget,i=a.closest(".chat-message");if(!o||!a||!i)return;const f=o.scrollTop;if(Zt(e)){const v=i.offsetTop-f;Ce.value.delete(e),await de();const y=i.offsetTop;o.style.scrollBehavior="auto",o.scrollTop=y-v,o.style.scrollBehavior="smooth"}else{const p=a.getBoundingClientRect().top;Ce.value.add(e),await de();const v=a.getBoundingClientRect().top;o.style.scrollBehavior="auto",o.scrollTop=f+(v-p),o.style.scrollBehavior="smooth"}},Ho=async(e,t)=>{const o=C.value?.$el,a=t.currentTarget.closest(".chat-message");if(!o||!a)return;const i=o.scrollTop,g=a.offsetTop-i,p=k.value.map((u,S)=>u.role===e?S:-1).filter(u=>u!==-1);if(p.length===0)return;p.some(u=>!Ce.value.has(u))?p.forEach(u=>Ce.value.add(u)):p.forEach(u=>Ce.value.delete(u)),await de();const y=a.offsetTop;o.style.scrollBehavior="auto",o.scrollTop=y-g,o.style.scrollBehavior="smooth"},Uo=()=>ht(!1),Wo=()=>gn(),qo=()=>yn(),jo=e=>be.value.splice(e,1),Ko=async({fileList:e})=>{for(const t of e)await Vt(t,be.value.length+1);A.value?.focus({cursor:"end"})},Yo=()=>pn(),Zo=async e=>{be.value=[],await Vt(e,0),await ht(!1)},Qt=()=>{const e=A.value?.senderRef?.$refs.textarea;e&&($.value=e.selectionStart,U.value=e.selectionEnd)},eo=()=>{setTimeout(()=>{if(_e.value||document.activeElement&&document.activeElement.tagName.toLowerCase()==="textarea"&&document.activeElement.closest(".editing-wrapper")||document.activeElement&&document.activeElement.closest(".text-search-container"))return;const e=A.value?.senderRef?.$refs.textarea;e&&document.activeElement!==e&&($.value!==null&&U.value!==null?A.value?.focus({position:{start:$.value,end:U.value}}):A.value?.focus({cursor:"end"}))},50)},Jo=e=>{e&&(async()=>{try{const t=await fetch(e);if(!t.ok)throw new Error(`ÁΩëÁªúÈîôËØØ: ${t.statusText}`);const o=await t.blob();try{if(["image/png","image/jpeg"].includes(o.type)){const i=new ClipboardItem({[o.type]:o});await navigator.clipboard.write([i]),s.success("ÂõæÁâáÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø (WebAPI)");return}}catch(i){console.warn("Web Clipboard API ÂÜôÂÖ•Â§±Ë¥•ÔºåÂ∞ùËØïÂõûÈÄÄÊñπÊ°à:",i)}const a=await new Promise((i,f)=>{const g=new FileReader;g.onloadend=()=>i(g.result),g.onerror=f,g.readAsDataURL(o)});await new Promise(i=>setTimeout(i,50)),await window.api.copyImage(a),s.success("ÂõæÁâáÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø")}catch(t){console.error("Â§çÂà∂ÂõæÁâáÂ§±Ë¥•:",t),s.error(`Â§çÂà∂Â§±Ë¥•: ${t.message}`)}})()},Xo=async e=>{if(e)try{const o=await(await fetch(e)).blob(),a=await o.arrayBuffer(),i=`image_${Date.now()}.${o.type.split("/")[1]||"png"}`;await window.api.saveFile({title:"‰øùÂ≠òÂõæÁâá",defaultPath:i,buttonLabel:"‰øùÂ≠ò",fileContent:new Uint8Array(a)}),s.success("ÂõæÁâá‰øùÂ≠òÊàêÂäüÔºÅ")}catch(t){!t.message.includes("User cancelled")&&!t.message.includes("Áî®Êà∑ÂèñÊ∂à")&&(console.error("‰∏ãËΩΩÂõæÁâáÂ§±Ë¥•:",t),s.error(`‰∏ãËΩΩÂ§±Ë¥•: ${t.message}`))}},to=(e,t)=>{if(e<0||e>=k.value.length)return;let o=-1,a=-1;for(let f=0;f<N.value.length;f++)if(N.value[f].role!=="tool"&&a++,a===e){o=f;break}const i=f=>{if(f){if(typeof f.content=="string"||f.content===null)f.content=t;else if(Array.isArray(f.content)){const g=f.content.find(p=>p.type==="text"&&!(p.text&&p.text.toLowerCase().startsWith("file name:")));g?g.text=t:f.content.push({type:"text",text:t})}}};k.value[e]&&i(k.value[e]),o!==-1&&N.value[o]?i(N.value[o]):console.error("ÈîôËØØÔºöÊó†Ê≥ïÂ∞Ü chat_show Á¥¢ÂºïÊò†Â∞ÑÂà∞ history Á¥¢Âºï„ÄÇ‰∏ãÊ¨°APIËØ∑Ê±ÇÂèØËÉΩ‰ºö‰ΩøÁî®ÊóßÊï∞ÊçÆ„ÄÇ")},Go=async e=>{const t=C.value?.$el,o=He(e),a=o?.$el;!t||!a||!o||(o.switchToEditMode(),await de(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{a.scrollIntoView({behavior:"auto",block:"nearest"})})}))},Qo=async({id:e,action:t,content:o})=>{if(t!=="save")return;const a=k.value.findIndex(i=>i.id===e);a!==-1&&(to(a,o),s.success("Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞"),a===k.value.length-1&&k.value[a].role==="user"&&(await de(),await so()))},en=e=>{e.key==="Enter"&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),oo())},oo=async()=>{const e=Ze.value;O.value=e;const t=N.value.findIndex(o=>o.role==="system");if(t!==-1)N.value[t].content=e,k.value[t]&&(k.value[t].content=e);else{const o={role:"system",content:e};N.value.unshift(o),k.value.unshift({...o,id:ee.value++})}try{if(!!m.value.prompts[B.value])await window.api.saveSetting(`prompts.${B.value}.prompt`,e),m.value.prompts[B.value].prompt=e,s.success("Âø´Êç∑Âä©ÊâãÊèêÁ§∫ËØçÂ∑≤Êõ¥Êñ∞");else{const a=await window.api.getConfig(),i=ft.value||se.config.prompts.AI,f={...i,icon:Me.value,prompt:e,enable:!0,model:Q.value||i.model,enable:!0,stream:!0,isTemperature:!1,temperature:.7,ifTextNecessary:!1,isDirectSend_file:!0,isDirectSend_normal:!0,voice:"",isAlwaysOnTop:a.config.isAlwaysOnTop_global,autoCloseOnBlur:a.config.autoCloseOnBlur_global,window_width:540,window_height:700,position_x:0,position_y:0,reasoning_effort:"default",zoom:1};a.config.prompts[B.value]=f,await window.api.updateConfig(a),m.value=a.config,ft.value=f,s.success(`Â∑≤‰∏∫ÊÇ®ÂàõÂª∫Âπ∂‰øùÂ≠òÊñ∞ÁöÑÂø´Êç∑Âä©Êâã: "${B.value}"`)}}catch(o){console.error("‰øùÂ≠òÁ≥ªÁªüÊèêÁ§∫ËØçÂ§±Ë¥•:",o),s.error(`‰øùÂ≠òÂ§±Ë¥•: ${o.message}`)}_e.value=!1},Mt=()=>{window.close()};wt(xe,e=>{window.api&&typeof window.api.setZoomFactor=="function"&&window.api.setZoomFactor(e)}),wt(k,async()=>{await Jt()},{deep:!0,flush:"post"}),wt(()=>m.value?.isDarkMode,e=>{e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),De&&De.setTheme(e?"dark":"light")},{immediate:!0}),Co(async()=>{if(he.value)return;he.value=!0,window.api&&window.api.onAlwaysOnTopChanged&&window.api.onAlwaysOnTopChanged(o=>{dt.value=o}),De=new Fa({scope:".chat-main",theme:m.value?.isDarkMode?"dark":"light"}),window.addEventListener("wheel",Xt,{passive:!1}),window.addEventListener("focus",eo),window.addEventListener("blur",Qt);const e=C.value?.$el;e&&(e.addEventListener("click",It),$e=new MutationObserver(()=>{pe.value&&(e.scrollTop=e.scrollHeight)}),$e.observe(e,{childList:!0,subtree:!0,characterData:!0}));const t=async(o=null)=>{try{const v=await window.api.getConfig();m.value=v.config}catch{m.value=se.config,s.error("Âä†ËΩΩÁî®Êà∑ÈÖçÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ„ÄÇ")}try{const v=await window.api.getUser();Ue.value=v.avatar}catch{Ue.value="user.png"}o?.os&&(pt.value=o.os),Fe.value=[],fe.value={},m.value.providerOrder.forEach(v=>{const y=m.value.providers[v];y?.enable&&y.modelList.forEach(u=>{const S=`${v}|${u}`;Fe.value.push({key:S,value:S,label:`${y.name}|${u}`}),fe.value[S]=`${y.name}|${u}`})});const a=o?.code||"AI",i=m.value.prompts[a]||se.config.prompts.AI;i.backgroundImage&&d(i.backgroundImage),dt.value=o?.isAlwaysOnTop??i.isAlwaysOnTop??!0,xe.value=i.zoom||m.value.zoom||1,window.api&&typeof window.api.setZoomFactor=="function"&&window.api.setZoomFactor(xe.value),m.value.isDarkMode&&document.documentElement.classList.add("dark"),B.value=a,document.title=a,ft.value=i,i.icon?(Me.value=i.icon,Le.value=i.icon):(Me.value="ai.svg",Le.value=m.value.isDarkMode?"favicon-b.png":"favicon.png"),ye.value=i.autoCloseOnBlur??!1,Ne.value=i.reasoning_effort||"default",Q.value=i.model||Fe.value[0]?.value||"",Re.value=i.voice||null,Q.value&&(Ie.value=Q.value.split("|")[0],Ye.value=m.value.providers[Ie.value]?.url,Ve.value=m.value.providers[Ie.value]?.api_key),i.prompt?(O.value=i.prompt,N.value=[{role:"system",content:i.prompt}],k.value=[{role:"system",content:i.prompt,id:ee.value++}]):(O.value="",N.value=[],k.value=[]);let f=!1,g=!1;if(o){if(we.value={code:o.code,type:o.type,payload:o.payload},o.filename&&(X.value=o.filename.replace(/\.json$/i,"")),o.type==="over"&&o.payload){let v=!1;try{let y=JSON.parse(o.payload);y&&y.anywhere_history===!0&&(v=!0,await ao(y),ye.value=!1)}catch{}v||B.value.trim().toLowerCase().includes(o.payload.trim().toLowerCase())||(i.isDirectSend_normal?(N.value.push({role:"user",content:o.payload}),k.value.push({id:ee.value++,role:"user",content:[{type:"text",text:o.payload}]}),f=!0):ot.value=o.payload)}else if(o.type==="img"&&o.payload)i.isDirectSend_normal?(N.value.push({role:"user",content:[{type:"image_url",image_url:{url:String(o.payload)}}]}),k.value.push({id:ee.value++,role:"user",content:[{type:"image_url",image_url:{url:String(o.payload)}}]}),f=!0):be.value.push({uid:1,name:"Êà™Âõæ.png",size:0,type:"image/png",url:String(o.payload)});else if(o.type==="files"&&o.payload)try{let v=!1;if(o.payload.length===1&&o.payload[0].path.toLowerCase().endsWith(".json")){const y=await window.api.handleFilePath(o.payload[0].path);y&&(v=await lo(y))}if(!v){const y=o.payload.map(u=>rn(u.path));await Promise.all(y),i.isDirectSend_file&&(f=!0,g=!0)}}catch(v){console.error("Error during initial file processing:",v),s.error("Êñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•: "+v.message)}}ye.value&&window.addEventListener("blur",Mt);const p=i.defaultMcpServers;Array.isArray(p)&&p.length>0&&(Oe.value=[...p],ce.value=[...p],await Lt(!1)),f&&(gt(),g?await ht(!1):await ht(!0)),await Jt(),setTimeout(()=>{A.value?.focus({cursor:"end"})},100)};if(window.preload&&typeof window.preload.receiveMsg=="function")window.preload.receiveMsg(async o=>{await t(o)});else{const o={os:"win",code:"Moss",config:await window.api.getConfig().config};await t(o)}tt&&clearInterval(tt),tt=setInterval(Pt,15e3),window.addEventListener("error",co,!0),window.addEventListener("keydown",uo),window.api&&window.api.onConfigUpdated&&window.api.onConfigUpdated(o=>{o&&(m.value=o,o.zoom!==void 0&&(xe.value=o.zoom))})});const Pt=async()=>{if(!(ie.value||!m.value?.webdav?.localChatPath||!(m.value?.prompts?.[B.value]?.autoSaveChat??!0))){if(!X.value&&k.value.length>0){const t=k.value.find(o=>o.role==="user");if(t){let o="";const a=t.content;if(Array.isArray(a)){const i=a.some(p=>p.type==="image_url"),f=a.some(p=>p.type==="file"),g=a.find(p=>p.type==="text");i?o="ÂõæÁâá":f?o="Êñá‰ª∂":g?.text&&(o=g.text.slice(0,20).replace(/[\\/:*?"<>|\n\r]/g,"").trim())}else typeof a=="string"&&(o=a.slice(0,20).replace(/[\\/:*?"<>|\n\r]/g,"").trim());if(o){const i=new Date,f=`${i.getFullYear()}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}-${String(i.getHours()).padStart(2,"0")}${String(i.getMinutes()).padStart(2,"0")}${String(i.getSeconds()).padStart(2,"0")}`;X.value=`${o}-${B.value}-${f}`}}}if(X.value)try{const t=Dt(),o=JSON.stringify(t,null,2),a=`${m.value.webdav.localChatPath}/${X.value}.json`;await window.api.writeLocalFile(a,o)}catch(t){console.error("Auto-save failed:",t)}}};So(async()=>{window.removeEventListener("wheel",Xt),window.removeEventListener("focus",eo),window.removeEventListener("blur",Qt),De&&De.destroy(),ye.value||window.removeEventListener("blur",Mt);const e=C.value?.$el;e&&e.removeEventListener("click",It),await window.api.closeMcpClient(),window.removeEventListener("error",co,!0),window.removeEventListener("keydown",uo),$e&&($e.disconnect(),$e=null)});const tn=async()=>{if(!B.value||!m.value.prompts[B.value]){s.warning("Êó†Ê≥ï‰øùÂ≠òÁ™óÂè£ËÆæÁΩÆÔºåÂõ†‰∏∫ÂΩìÂâç‰∏çÊòØ‰∏Ä‰∏™Â∑≤ÂÆö‰πâÁöÑÂø´Êç∑Âä©Êâã„ÄÇ");return}if(window.fullScreen){s.warning("Êó†Ê≥ïÂú®ÂÖ®Â±èÊ®°Âºè‰∏ã‰øùÂ≠òÁ™óÂè£‰ΩçÁΩÆÂíåÂ§ßÂ∞è„ÄÇ");return}const e={window_height:window.outerHeight,window_width:window.outerWidth,zoom:xe.value,position_x:window.screenX,position_y:window.screenY};try{const t=await window.api.savePromptWindowSettings(B.value,e);t.success?(s.success("ÂΩìÂâçÂø´Êç∑Âä©ÊâãÁöÑÁ™óÂè£Â§ßÂ∞è„ÄÅ‰ΩçÁΩÆ‰∏éÁº©ÊîæÂ∑≤‰øùÂ≠ò"),m.value.prompts[B.value]&&Object.assign(m.value.prompts[B.value],e)):s.error(`‰øùÂ≠òÂ§±Ë¥•: ${t.message}`)}catch(t){console.error("Error saving window settings:",t),s.error("‰øùÂ≠òÁ™óÂè£ËÆæÁΩÆÊó∂Âá∫Èîô")}},Dt=()=>{const e=m.value.prompts[B.value]||{};return{anywhere_history:!0,CODE:B.value,basic_msg:we.value,isInit:he.value,autoCloseOnBlur:ye.value,model:Q.value,currentPromptConfig:e,history:N.value,chat_show:k.value,selectedVoice:Re.value,activeMcpServerIds:Oe.value||[],isAutoApproveTools:Xe.value}},on=async()=>{const e=new Date,t=String(e.getFullYear()).slice(-2),o=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).toString().padStart(2,"0"),i=String(e.getHours()).toString().padStart(2,"0"),f=String(e.getMinutes()).toString().padStart(2,"0"),g=X.value||`${B.value||"AI"}-${t}${o}${a}-${i}${f}`,p=h(g);try{await Qe({title:"‰øùÂ≠òÂà∞‰∫ëÁ´Ø",message:()=>ne("div",null,[ne("p",{style:"margin-bottom: 15px; font-size: 14px; color: var(--el-text-color-regular);"},"ËØ∑ËæìÂÖ•Ë¶Å‰øùÂ≠òÂà∞‰∫ëÁ´ØÁöÑ‰ºöËØùÂêçÁß∞„ÄÇ"),ne(et,{modelValue:p.value,"onUpdate:modelValue":v=>{p.value=v},placeholder:"Êñá‰ª∂Âêç",ref:v=>{v&&setTimeout(()=>v.focus(),100)},onKeydown:v=>{v.key==="Enter"&&(v.preventDefault(),document.querySelector(".filename-prompt-dialog .el-message-box__btns .el-button--primary")?.click())}},{append:()=>ne("div",{class:"input-suffix-display"},".json")})]),showCancelButton:!0,confirmButtonText:"Á°ÆËÆ§",cancelButtonText:"ÂèñÊ∂à",customClass:"filename-prompt-dialog",beforeClose:async(v,y,u)=>{if(v==="confirm"){let S=p.value.trim();if(!S){s.error("Êñá‰ª∂Âêç‰∏çËÉΩ‰∏∫Á©∫");return}S.toLowerCase().endsWith(".json")&&(S=S.slice(0,-5));const M=S+".json";y.confirmButtonLoading=!0,s.info("Ê≠£Âú®‰øùÂ≠òÂà∞‰∫ëÁ´Ø...");try{const b=Dt(),T=JSON.stringify(b,null,2),{url:w,username:z,password:G,data_path:le}=m.value.webdav,J=ho(w,{username:z,password:G}),me=le.endsWith("/")?le.slice(0,-1):le,te=`${me}/${M}`;await J.exists(me)||await J.createDirectory(me,{recursive:!0}),await J.putFileContents(te,T,{overwrite:!0}),X.value=S,s.success("‰ºöËØùÂ∑≤ÊàêÂäü‰øùÂ≠òÂà∞‰∫ëÁ´ØÔºÅ"),u()}catch(b){console.error("WebDAV save failed:",b),s.error(`‰øùÂ≠òÂà∞‰∫ëÁ´ØÂ§±Ë¥•: ${b.message}`)}finally{y.confirmButtonLoading=!1}}else u()}})}catch(v){v!=="cancel"&&v!=="close"&&console.error("MessageBox error:",v)}},nn=async()=>{let e="";const t=new Date,o=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`,a=`${String(t.getFullYear()).slice(-2)}${String(t.getMonth()+1).padStart(2,"0")}${String(t.getDate()).padStart(2,"0")}-${String(t.getHours()).padStart(2,"0")}${String(t.getMinutes()).padStart(2,"0")}`,i=X.value||`${B.value||"AI"}-${a}`,f=u=>Array.isArray(u)?u.map(S=>S.type==="text"?S.text.trim():"").join(" "):String(u).trim(),g=u=>Array.isArray(u)?u.filter(S=>S.type!=="text").map(S=>S.type==="file"?S.file.filename:"Image"):[],p=u=>u?u.split(`
`).map(S=>`> ${S}`).join(`
`):"",v=(u,S=50)=>{if(!u)return"";const M=String(u);return M.length>S?M.substring(0,S)+"...":M};e+=`# ËÅäÂ§©ËÆ∞ÂΩï: ${B.value} (${o})

### ÂΩìÂâçÊ®°Âûã: ${fe.value[Q.value]||"N/A"}

`,O.value&&O.value.trim()&&(e+=`### Á≥ªÁªüÊèêÁ§∫ËØç

${p(O.value.trim())}

`),e+=`---

`;for(const u of k.value)if(u.role!=="system"){if(u.role==="user"){let S="### üë§ Áî®Êà∑";u.timestamp&&(S+=` - *${Tt(u.timestamp)}*`),e+=`${S}

`;const M=f(u.content),b=g(u.content);M&&(e+=`${p(M)}

`),b.length>0&&(e+=`> **ÈôÑ‰ª∂ÂàóË°®:**
`,b.forEach(T=>{e+=`> - \`${T}\`
`}),e+=`
`)}else if(u.role==="assistant"){let S=`### ü§ñ ${u.aiName||"AI"}`;u.voiceName&&(S+=` (${u.voiceName})`),u.completedTimestamp&&(S+=` - *${Tt(u.completedTimestamp)}*`),e+=`${S}

`,u.reasoning_content&&(e+=`> *ÊÄùËÄÉËøáÁ®ã:*
${p(u.reasoning_content)}

`),u.tool_calls&&u.tool_calls.length>0&&(e+=`> **Â∑•ÂÖ∑Ë∞ÉÁî®:**
`,u.tool_calls.forEach(b=>{e+=`> - üõ†Ô∏è \`${b.name}\`: ${v(b.result)}
`}),e+=`
`);const M=f(u.content);M?e+=`${p(M)}

`:u.status&&(e+=`> *(AIÊ≠£Âú®ÊÄùËÄÉ...)*

`)}e+=`---

`}const y=h(i);try{await Qe({title:"‰øùÂ≠ò‰∏∫ Markdown",message:()=>ne("div",null,[ne("p",{style:"margin-bottom: 15px; font-size: 14px; color: var(--el-text-color-regular);"},"ËØ∑ËæìÂÖ•‰ºöËØùÂêçÁß∞„ÄÇ"),ne(et,{modelValue:y.value,"onUpdate:modelValue":u=>{y.value=u},placeholder:"Êñá‰ª∂Âêç",ref:u=>{u&&setTimeout(()=>u.focus(),100)},onKeydown:u=>{u.key==="Enter"&&(u.preventDefault(),document.querySelector(".filename-prompt-dialog .el-message-box__btns .el-button--primary")?.click())}},{append:()=>ne("div",{class:"input-suffix-display"},".md")})]),showCancelButton:!0,confirmButtonText:"‰øùÂ≠ò",cancelButtonText:"ÂèñÊ∂à",customClass:"filename-prompt-dialog",beforeClose:async(u,S,M)=>{if(u==="confirm"){let b=y.value.trim();if(!b){s.error("Êñá‰ª∂Âêç‰∏çËÉΩ‰∏∫Á©∫");return}b.toLowerCase().endsWith(".md")&&(b=b.slice(0,-3));const T=b+".md";S.confirmButtonLoading=!0;try{await window.api.saveFile({title:"‰øùÂ≠ò‰∏∫ Markdown",defaultPath:T,buttonLabel:"‰øùÂ≠ò",filters:[{name:"Markdown Êñá‰ª∂",extensions:["md"]},{name:"ÊâÄÊúâÊñá‰ª∂",extensions:["*"]}],fileContent:e}),X.value=b,s.success("‰ºöËØùÂ∑≤ÊàêÂäü‰øùÂ≠ò‰∏∫ MarkdownÔºÅ"),M()}catch(w){w.message.includes("canceled by the user")||(console.error("‰øùÂ≠ò Markdown Â§±Ë¥•:",w),s.error(`‰øùÂ≠òÂ§±Ë¥•: ${w.message}`)),M()}finally{S.confirmButtonLoading=!1}}else M()}})}catch(u){u!=="cancel"&&u!=="close"&&console.error("MessageBox error:",u)}},an=async()=>{const e=new Date,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`,o=`${String(e.getFullYear()).slice(-2)}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}-${String(e.getHours()).padStart(2,"0")}${String(e.getMinutes()).padStart(2,"0")}`,a=X.value||`${B.value||"AI"}-${o}`,i=h(a),f='<svg width="200" height="200" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#FDA5A5" /><g stroke="white" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" fill="none"><rect x="25" y="32" width="50" height="42" rx="8" /><line x1="40" y1="63" x2="60" y2="63" /><line x1="35" y1="32" x2="32" y2="22" /><line x1="65" y1="32" x2="68" y2="22" /></g><g fill="white" stroke="none"><circle cx="40" cy="48" r="3.5" /><circle cx="60" cy="48" r="3.5" /><circle cx="32" cy="20" r="3" /><circle cx="68" cy="20" r="3" /></g></svg>',g=()=>{let p="",v="";const y=(b,T=50)=>{if(!b)return"";const w=String(b);return w.length>T?w.substring(0,T)+"...":w},u=b=>{if(!b)return"";if(typeof b=="string")return b;if(!Array.isArray(b))return String(b);let T="";return b.forEach(w=>{w.type==="text"&&w.text&&!(w.text.toLowerCase().startsWith("file name:")&&w.text.toLowerCase().endsWith("file end"))&&(T+=w.text)}),T.trim()},S=b=>{if(!b)return"";let T="";return typeof b=="string"?T=b:Array.isArray(b)?T=b.map(w=>w.type==="text"?w.text||"":w.type==="image_url"&&w.image_url?.url?`![Image](${w.image_url.url})`:w.type==="input_audio"&&w.input_audio?.data?`<audio controls src="data:audio/${w.input_audio.format};base64,${w.input_audio.data}"></audio>`:w.type==="file"&&w.file?.filename?`*üìé ÈôÑ‰ª∂: ${w.file.filename}*`:"").join(" "):T=String(b),yo.parse(T)};if(O.value&&O.value.trim()){const b="Á≥ªÁªüÊèêÁ§∫ËØç",T="system-dot",w="msg-system";v+=`
        <li class="timeline-item">
            <a href="#${w}" class="timeline-dot ${T}" aria-label="${b}">
                <span class="timeline-tooltip">${b}</span>
            </a>
        </li>`,p+=`
            <div id="${w}" class="message-wrapper align-left">
              <div class="header system-header"><strong>Á≥ªÁªüÊèêÁ§∫ËØç</strong></div>
              <div class="message-body system-body">${wo.sanitize(yo.parse(O.value))}</div>
            </div>
          `}return k.value.forEach((b,T)=>{if(b.role==="system")return;const w=b.role==="user",z=`msg-${T}`;let G="";w?G=y(u(b.content),30)||"Áî®Êà∑ÂèëÈÄÅÂõæÁâá/Êñá‰ª∂":G=y(u(b.content),30)||"AI ÂõûÂ§ç",v+=`
        <li class="timeline-item">
            <a href="#${z}" class="timeline-dot ${w?"user-dot":"ai-dot"}" aria-label="${G}">
                <span class="timeline-tooltip">${G}</span>
            </a>
        </li>`;let J=w?Ue.value:Me.value;w||(J==="ai.svg"||!J.startsWith("http")&&!J.startsWith("data:"))&&(J=`data:image/svg+xml;base64,${btoa(f)}`);let me=w?"Áî®Êà∑":b.aiName||"AI",te=b.timestamp||b.completedTimestamp,oe=w?"align-right":"align-left";const qe=S(b.content);let Pe="";qe&&qe.trim()!==""&&(Pe=wo.sanitize(qe,{ADD_TAGS:["video","audio","source","blockquote"],USE_PROFILES:{html:!0,svg:!0},ADD_ATTR:["style"]}));let nt="";if(b.tool_calls&&b.tool_calls.length>0&&(nt='<div class="tool-calls-wrapper">',b.tool_calls.forEach(at=>{const kn=y(at.result,100).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");nt+=`
                <div class="tool-call-box">
                    <span class="tool-icon">üõ†Ô∏è</span>
                    <span class="tool-name">${at.name}</span>
                    <span class="tool-result">${kn}</span>
                </div>`}),nt+="</div>"),Pe||nt){let at="";w?at=`
               <div class="header user-header">
                 <span class="timestamp">${te?Tt(te):""}</span>
                 <img src="${J}" class="avatar" alt="avatar">
               </div>`:at=`
               <div class="header ai-header">
                 <img src="${J}" class="avatar" alt="avatar">
                 <div class="ai-meta">
                    <div class="ai-name-row">
                        <strong>${me}</strong>
                        ${b.voiceName?`<span class="voice-tag">(${b.voiceName})</span>`:""}
                    </div>
                    <span class="timestamp">${te?Tt(te):""}</span>
                 </div>
               </div>`;const rt=Pe?`<div class="message-body ${w?"user-body":"ai-body"}">${Pe}</div>`:"";p+=`
            <div id="${z}" class="message-wrapper ${oe}">
              ${at}
              ${nt}
              ${rt}
            </div>
          `}}),`
      <!DOCTYPE html>
      <html lang="zh-CN">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ËÅäÂ§©ËÆ∞ÂΩï: ${B.value} (${t})</title>
        
      <style>
        :root { 
            --bg-color: #f7f7f7; 
            --text-color: #333; 
            --card-bg: #fff; 
            --user-bg: #e1f5fe; 
            --ai-bg: #fff; 
            --border-color: #eee; 
            --accent-color: #1F2937; 
            --timeline-line: #e0e0e0;
            --timeline-dot-default: #bdbdbd;
            --timeline-dot-active: #1F2937;
        }
        @media (prefers-color-scheme: dark) {
          :root { 
              --bg-color: #1a1a1a; 
              --text-color: #e0e0e0; 
              --card-bg: #2a2a2a; 
              --user-bg: #0d47a1; 
              --ai-bg: #3a3a3a; 
              --border-color: #444; 
              --accent-color: #64b5f6; 
              --timeline-line: #444;
              --timeline-dot-default: #666;
              --timeline-dot-active: #64b5f6;
          }
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; }
        .main-container { max-width: 900px; margin: 0 auto; background-color: var(--card-bg); border-radius: 12px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: relative; }
        .page-header { margin-bottom: 40px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .page-header h1 { margin: 0 0 10px 0; font-size: 24px; }
        .page-header p { margin: 0; color: #888; font-size: 13px; }
        .timeline-toc {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 100;
            max-height: 80vh;
            overflow-y: auto;
            scrollbar-width: none; 
            padding: 10px;
        }
        .timeline-toc::-webkit-scrollbar { display: none; }
        .timeline-list {
            list-style: none;
            padding: 0;
            margin: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px; 
        }
        .timeline-list::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background-color: var(--timeline-line);
            transform: translateX(-50%);
            z-index: -1;
            border-radius: 2px;
        }
        .timeline-item { position: relative; }
        .timeline-dot {
            display: block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--card-bg);
            border: 2px solid var(--timeline-dot-default);
            transition: all 0.2s ease;
            position: relative;
        }
        .timeline-dot.user-dot {
            background-color: var(--timeline-dot-active);
            border-color: var(--timeline-dot-active);
            width: 12px; 
            height: 12px;
        }
        .timeline-dot.ai-dot {
            border-color: var(--timeline-dot-default);
        }
        .timeline-dot.system-dot {
            border-color: #795548;
            background-color: #795548;
        }
        .timeline-dot:hover {
            transform: scale(1.4);
            border-color: var(--accent-color);
            background-color: var(--accent-color);
        }
        .timeline-tooltip {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--accent-color);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .timeline-dot:hover .timeline-tooltip {
            opacity: 1;
            transform: translateY(-50%) translateX(-5px);
        }
        .message-wrapper { display: flex; flex-direction: column; margin-bottom: 30px; scroll-margin-top: 60px; max-width: 100%; }
        .align-right { align-items: flex-end; }
        .align-left { align-items: flex-start; }
        .header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; font-size: 12px; color: #888; }
        .user-header { flex-direction: row; }
        .ai-header { flex-direction: row; align-items: flex-start; }
        .avatar { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; background-color: #eee; flex-shrink: 0; }
        .ai-meta { display: flex; flex-direction: column; line-height: 1.3; }
        .ai-name-row { display: flex; align-items: center; gap: 5px; }
        .voice-tag { opacity: 0.8; font-size: 11px; }
        .message-body { padding: 12px 16px; border-radius: 12px; word-break: break-word; overflow-wrap: break-word; max-width: 100%; }
        .user-body { background-color: var(--user-bg); border-bottom-right-radius: 2px; color: var(--text-color); max-width: 90%; }
        .ai-body { background-color: var(--ai-bg); border: 1px solid var(--border-color); border-top-left-radius: 2px; width: 100%; box-sizing: border-box; }
        .system-body { background-color: #fff3e0; color: #5d4037; border: 1px dashed #d7ccc8; width: 100%; text-align: center; }
        .tool-calls-wrapper { width: 100%; margin-bottom: 8px; display: flex; flex-direction: column; gap: 4px; }
        .tool-call-box { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 10px; font-size: 12px; color: #666; display: flex; align-items: center; gap: 8px; }
        .tool-name { font-weight: bold; }
        .tool-result { opacity: 0.7; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        img { max-width: 100%; border-radius: 8px; margin: 5px 0; }
        pre { background-color: #2d2d2d; color: #f8f8f2; padding: 1em; border-radius: 8px; overflow-x: auto; font-family: monospace; }
        blockquote { border-left: 4px solid #ccc; padding-left: 1em; margin: 1em 0; color: #666; background: rgba(0,0,0,0.03); }
        @media (max-width: 768px) {
          .timeline-toc { display: none; }
          .main-container { padding: 20px; width: 100%; box-sizing: border-box; border-radius: 0; box-shadow: none; background-color: transparent; }
          .message-body { max-width: 100%; }
          .user-body { max-width: 95%; }
          body { padding: 0; }
        }
      </style>
    
      </head>
      <body>
        <nav class="timeline-toc">
            <ul class="timeline-list">
                ${v}
            </ul>
        </nav>
        <div class="main-container">
            <header class="page-header">
                <h1>${B.value}</h1>
                <p>Ê®°Âûã: ${fe.value[Q.value]||"N/A"} &bull; ÂØºÂá∫Êó∂Èó¥: ${t}</p>
            </header>
            <div class="chat-container">
                ${p}
            </div>
        </div>
      </body>
      </html>
    `};try{await Qe({title:"‰øùÂ≠ò‰∏∫ HTML",message:()=>ne("div",null,[ne("p",{style:"margin-bottom: 15px; font-size: 14px; color: var(--el-text-color-regular);"},"ËØ∑ËæìÂÖ•‰ºöËØùÂêçÁß∞„ÄÇ"),ne(et,{modelValue:i.value,"onUpdate:modelValue":p=>{i.value=p},placeholder:"Êñá‰ª∂Âêç",ref:p=>{p&&setTimeout(()=>p.focus(),100)},onKeydown:p=>{p.key==="Enter"&&(p.preventDefault(),document.querySelector(".filename-prompt-dialog .el-message-box__btns .el-button--primary")?.click())}},{append:()=>ne("div",{class:"input-suffix-display"},".html")})]),showCancelButton:!0,confirmButtonText:"‰øùÂ≠ò",cancelButtonText:"ÂèñÊ∂à",customClass:"filename-prompt-dialog",beforeClose:async(p,v,y)=>{if(p==="confirm"){let u=i.value.trim();if(!u){s.error("Êñá‰ª∂Âêç‰∏çËÉΩ‰∏∫Á©∫");return}u.toLowerCase().endsWith(".html")&&(u=u.slice(0,-5));const S=u+".html";v.confirmButtonLoading=!0;try{const M=g();await window.api.saveFile({title:"‰øùÂ≠ò‰∏∫ HTML",defaultPath:S,buttonLabel:"‰øùÂ≠ò",filters:[{name:"HTML Êñá‰ª∂",extensions:["html"]},{name:"ÊâÄÊúâÊñá‰ª∂",extensions:["*"]}],fileContent:M}),X.value=u,s.success("‰ºöËØùÂ∑≤ÊàêÂäü‰øùÂ≠ò‰∏∫ HTMLÔºÅ"),y()}catch(M){!M.message.includes("User cancelled")&&!M.message.includes("Áî®Êà∑ÂèñÊ∂à")&&(console.error("‰øùÂ≠ò HTML Â§±Ë¥•:",M),s.error(`‰øùÂ≠òÂ§±Ë¥•: ${M.message}`)),y()}finally{v.confirmButtonLoading=!1}}else y()}})}catch(p){p!=="cancel"&&p!=="close"&&console.error("MessageBox error:",p)}},ln=async()=>{const e=Dt(),t=JSON.stringify(e,null,2),o=new Date,a=`${String(o.getFullYear()).slice(-2)}${String(o.getMonth()+1).padStart(2,"0")}${String(o.getDate()).padStart(2,"0")}-${String(o.getHours()).padStart(2,"0")}${String(o.getMinutes()).padStart(2,"0")}${String(o.getSeconds()).padStart(2,"0")}`,i=X.value||`${B.value||"AI"}-${a}`,f=h(i);try{await Qe({title:"‰øùÂ≠ò‰∏∫ JSON",message:()=>ne("div",null,[ne("p",{style:"margin-bottom: 15px; font-size: 14px; color: var(--el-text-color-regular);"},"ËØ∑ËæìÂÖ•‰ºöËØùÂêçÁß∞„ÄÇ"),ne(et,{modelValue:f.value,"onUpdate:modelValue":g=>{f.value=g},placeholder:"Êñá‰ª∂Âêç",ref:g=>{g&&setTimeout(()=>g.focus(),100)},onKeydown:g=>{g.key==="Enter"&&(g.preventDefault(),document.querySelector(".filename-prompt-dialog .el-message-box__btns .el-button--primary")?.click())}},{append:()=>ne("div",{class:"input-suffix-display"},".json")})]),showCancelButton:!0,confirmButtonText:"‰øùÂ≠ò",cancelButtonText:"ÂèñÊ∂à",customClass:"filename-prompt-dialog",beforeClose:async(g,p,v)=>{if(g==="confirm"){let y=f.value.trim();if(!y){s.error("Êñá‰ª∂Âêç‰∏çËÉΩ‰∏∫Á©∫");return}y.toLowerCase().endsWith(".json")&&(y=y.slice(0,-5));const u=y+".json";p.confirmButtonLoading=!0;try{let S=u;const M=m.value.webdav?.localChatPath;if(M){const b=we.value.os==="win"?"\\":"/";S=`${M}${b}${u}`}await window.api.saveFile({title:"‰øùÂ≠òËÅäÂ§©‰ºöËØù",defaultPath:S,buttonLabel:"‰øùÂ≠ò",filters:[{name:"JSON Êñá‰ª∂",extensions:["json"]},{name:"ÊâÄÊúâÊñá‰ª∂",extensions:["*"]}],fileContent:t}),X.value=y,s.success("‰ºöËØùÂ∑≤ÊàêÂäü‰øùÂ≠òÔºÅ"),v()}catch(S){!S.message.includes("canceled by the user")&&!S.message.includes("Áî®Êà∑ÂèñÊ∂à")&&(console.error("‰øùÂ≠ò‰ºöËØùÂ§±Ë¥•:",S),s.error(`‰øùÂ≠òÂ§±Ë¥•: ${S.message}`)),v()}finally{p.confirmButtonLoading=!1}}else v()}})}catch(g){g!=="cancel"&&g!=="close"&&console.error("MessageBox error:",g)}},sn=async()=>{ye.value&&zt();const e=m.value.webdav?.localChatPath;if(!e){s.error("ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÊú¨Âú∞ÂØπËØùË∑ØÂæÑ");return}if(!X.value){s.warning("ÂΩìÂâçÂØπËØùÂ∞öÊú™‰øùÂ≠òÔºåÊó†Ê≥ïÈáçÂëΩÂêç");return}const t=X.value,o=`${t}.json`,a=`${e}/${o}`;try{const{value:i}=await Qe.prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑ‰ºöËØùÂêçÁß∞","ÈáçÂëΩÂêçÂØπËØù",{inputValue:t,confirmButtonText:"Á°ÆËÆ§",cancelButtonText:"ÂèñÊ∂à",inputValidator:b=>!b||!b.trim()?"ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫":/[\\/:*?"<>|]/.test(b)?"Êñá‰ª∂ÂêçÂåÖÂê´ÈùûÊ≥ïÂ≠óÁ¨¶":!0,customClass:"filename-prompt-dialog"});let f=(i||"").trim();if(f.toLowerCase().endsWith(".json")&&(f=f.slice(0,-5)),f===t)return;const g=`${f}.json`,p=`${e}/${g}`;if((await window.api.listJsonFiles(e)).some(b=>b.basename===g)){s.error(`Êñá‰ª∂Âêç "${g}" Â∑≤Â≠òÂú®ÔºåÊìç‰ΩúÂèñÊ∂à`);return}await window.api.renameLocalFile(a,p),X.value=f,s.success("Êú¨Âú∞ÈáçÂëΩÂêçÊàêÂäü");const{url:y,username:u,password:S,data_path:M}=m.value.webdav||{};if(y&&M)try{const b=ho(y,{username:u,password:S}),T=M.endsWith("/")?M.slice(0,-1):M,w=`${T}/${o}`,z=`${T}/${g}`;await b.exists(w)&&(await Qe.confirm("‰∫ëÁ´Ø‰πüÂ≠òÂú®ÂêåÂêçÊñá‰ª∂ÔºåÊòØÂê¶ÂêåÊ≠•ÈáçÂëΩÂêçÔºü","ÂêåÊ≠•Êìç‰ΩúÊèêÁ§∫",{confirmButtonText:"ÊòØ",cancelButtonText:"Âê¶",type:"info"}),await b.moveFile(w,z),s.success("‰∫ëÁ´ØÂêåÊ≠•ÈáçÂëΩÂêçÊàêÂäü"))}catch(b){b!=="cancel"&&b!=="close"&&console.warn("Cloud rename skipped:",b)}}catch(i){i!=="cancel"&&i!=="close"&&s.error(`Êìç‰ΩúÂ§±Ë¥•: ${i.message}`)}},no=async()=>{ye.value&&zt();const e=m.value.webdav?.url&&m.value.webdav?.data_path,t=[];m.value.webdav?.localChatPath&&X.value&&t.push({title:"ÈáçÂëΩÂêçÂØπËØù",description:"‰øÆÊîπÂΩìÂâçÂØπËØùÂêçÁß∞ÔºåÂπ∂ÂêåÊ≠•‰øÆÊîπÊú¨Âú∞Êñá‰ª∂Ôºà‰ª•Âèä‰∫ëÁ´ØÊñá‰ª∂Ôºâ„ÄÇ",buttonType:"warning",action:sn}),e&&t.push({title:"‰øùÂ≠òÂà∞‰∫ëÁ´Ø",description:"ÂêåÊ≠•Âà∞ WebDAV ÊúçÂä°Âô®ÔºåÊîØÊåÅË∑®ËÆæÂ§áËÆøÈóÆ„ÄÇ",buttonType:"success",action:on}),t.push({title:"‰øùÂ≠ò‰∏∫ JSON",description:"‰øùÂ≠ò‰∏∫ÂèØÊÅ¢Â§çÁöÑ‰ºöË©±Êñá‰ª∂Ôºå‰æø‰∫é‰∏ãÊ¨°ÁªßÁª≠„ÄÇ",buttonType:"primary",action:ln,isDefault:!0}),t.push({title:"‰øùÂ≠ò‰∏∫ Markdown",description:"ÂØºÂá∫‰∏∫ÂèØËØªÊÄßÊõ¥Âº∫ÁöÑ .md Êñá‰ª∂ÔºåÈÄÇÂêàÂàÜ‰∫´„ÄÇ",buttonType:"",action:nn}),t.push({title:"‰øùÂ≠ò‰∏∫ HTML",description:"ÂØºÂá∫‰∏∫Â∏¶Ê†∑ÂºèÁöÑÁΩëÈ°µÊñá‰ª∂Ôºå‰øùÁïôÊ†ºÂºèÂíåÂõæÁâá„ÄÇ",buttonType:"",action:an});const o=ne("div",{class:"save-options-list"},t.map(a=>{const i=()=>{Qe.close(),a.action()};return ne("div",{class:"save-option-item",onClick:i},[ne("div",{class:"save-option-text"},[ne("h4",null,a.title),ne("p",null,a.description)]),ne(H,{type:a.buttonType,plain:!0,class:a.isDefault?"default-save-target":"",onClick:f=>{f.stopPropagation(),i()}},{default:()=>"ÈÄâÊã©"})])}));Qe({title:"",message:o,showConfirmButton:!1,showCancelButton:!1,customClass:"save-options-dialog no-header-msgbox",width:"450px",showClose:!1}).catch(()=>{}),setTimeout(()=>{const a=document.querySelector(".default-save-target");a&&a.focus()},100)},ao=async e=>{ie.value=!0,Ce.value.clear(),K.clear(),F.value=null;try{B.value=e.CODE,document.title=B.value,we.value=e.basic_msg,he.value=e.isInit,ye.value=e.autoCloseOnBlur,N.value=e.history,k.value=e.chat_show,Re.value=e.selectedVoice||"",Ne.value=e.currentPromptConfig?.reasoning_effort||"default",Xe.value=e.isAutoApproveTools||!0;const t=await window.api.getConfig();m.value=t.config,xe.value=m.value.zoom||1,window.api&&typeof window.api.setZoomFactor=="function"&&window.api.setZoomFactor(xe.value),m.value.isDarkMode?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");const o=e.currentPromptConfig||m.value.prompts[B.value];o&&o.icon?(Me.value=o.icon,Le.value=o.icon):(Me.value="ai.svg",Le.value=m.value.isDarkMode?"favicon-b.png":"favicon.png"),Fe.value=[],fe.value={},m.value.providerOrder.forEach(p=>{const v=m.value.providers[p];v?.enable&&v.modelList.forEach(y=>{const u=`${p}|${y}`;Fe.value.push({key:u,value:u,label:`${v.name}|${y}`}),fe.value[u]=`${v.name}|${y}`})});let a="";if(e.model&&fe.value[e.model])a=e.model;else if(e.currentPromptConfig?.model&&fe.value[e.currentPromptConfig.model])a=e.currentPromptConfig.model;else{const p=m.value.prompts[B.value];a=p?.model&&fe.value[p.model]?p.model:Fe.value[0]?.value||""}if(Q.value=a,k.value&&k.value.length>0){k.value.forEach(v=>{v.id===void 0&&(v.id=ee.value++)});const p=Math.max(...k.value.map(v=>v.id||0));ee.value=p+1}const i=N.value.findIndex(p=>p.role==="system");if(i!==-1?(O.value=N.value[i].content,(!k.value[i]||k.value[i].role!=="system")&&k.value.unshift({role:"system",content:O.value,id:ee.value++})):m.value.prompts[B.value]?.prompt?(O.value=m.value.prompts[B.value].prompt,N.value.unshift({role:"system",content:O.value}),k.value.unshift({role:"system",content:O.value,id:ee.value++})):O.value="",Q.value){Ie.value=Q.value.split("|")[0];const p=m.value.providers[Ie.value];Ye.value=p?.url,Ve.value=p?.api_key}else{s.error("Ê≤°ÊúâÂèØÁî®ÁöÑÊ®°Âûã„ÄÇËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÊúçÂä°ÂïÜÈÖçÁΩÆ„ÄÇ"),ie.value=!1;return}ie.value=!1,await de(),gt();let f=[];e.activeMcpServerIds&&Array.isArray(e.activeMcpServerIds)?f=e.activeMcpServerIds:f=e.currentPromptConfig?.defaultMcpServers||[];const g=f.filter(p=>m.value.mcpServers&&m.value.mcpServers[p]);g.length>0?(Oe.value=[...g],ce.value=[...g],Lt(!1)):(Oe.value=[],ce.value=[],Lt(!1))}catch(t){console.error("Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•:",t),s.error(`Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•: ${t.message}`),ie.value=!1}},lo=async e=>{if(e&&e.name.toLowerCase().endsWith(".json"))try{const t=await e.text(),o=JSON.parse(t);if(o&&o.anywhere_history===!0)return X.value=e.name.replace(/\.json$/i,""),await ao(o),!0}catch(t){console.warn("‰∏Ä‰∏™JSONÊñá‰ª∂Ë¢´Ê£ÄÊµãÂà∞Ôºå‰ΩÜÂÆÉ‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑ‰ºöËØùÊñá‰ª∂:",t.message)}return!1},Vt=async(e,t)=>{if(await lo(e)){A.value?.focus({cursor:"end"});return}return new Promise((a,i)=>{if(!window.api.isFileTypeSupported(e.name)){const g=`‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã: ${e.name}`;s.warning(g),i(new Error(g));return}const f=new FileReader;f.onload=g=>{be.value.push({uid:t,name:e.name,size:e.size,type:e.type,url:g.target.result}),a()},f.onerror=()=>{const g=`ËØªÂèñÊñá‰ª∂ ${e.name} Â§±Ë¥•`;s.error(g),i(new Error(g))},f.readAsDataURL(e)})},rn=async e=>{if(!e||typeof e!="string"){s.error("Êó†ÊïàÁöÑÊñá‰ª∂Ë∑ØÂæÑ");return}try{const t=await window.api.handleFilePath(e);t?await Vt(t,be.value.length+1):s.error("Êó†Ê≥ïËØªÂèñÊàñËÆøÈóÆËØ•Êñá‰ª∂ÔºåËØ∑Ê£ÄÊü•Ë∑ØÂæÑÂíåÊùÉÈôê")}catch(t){console.error("Ë∞ÉÁî® handleFilePath Êó∂ÂèëÁîüÊÑèÂ§ñÈîôËØØ:",t),s.error("Â§ÑÁêÜÊñá‰ª∂Ë∑ØÂæÑÊó∂ÂèëÁîüÊú™Áü•ÈîôËØØ")}},cn=async()=>{let e=[];if(be.value.length===0)return e;for(const t of be.value)try{const o=await window.api.parseFileObject({name:t.name,url:t.url});o&&e.push(o)}catch(o){o.message.includes("‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã")?s.warning(o.message):s.error(`Â§ÑÁêÜÊñá‰ª∂ ${t.name} Â§±Ë¥•: ${o.message}`)}return be.value=[],e};async function Lt(e=!0){st.value=!1,$t.value=!0,await de();const t={},o=[...Oe.value];for(const a of o)if(m.value.mcpServers[a]){const i=m.value.mcpServers[a];t[a]={transport:i.type,command:i.command,args:i.args,url:i.baseUrl,env:i.env,headers:i.headers,isPersistent:i.isPersistent}}try{const{openaiFormattedTools:a,successfulServerIds:i,failedServerIds:f}=await window.api.initializeMcpClient(t);if(it.value=a,Oe.value=i,f&&f.length>0){const g=f.map(p=>m.value.mcpServers[p]?.name||p).join("„ÄÅ");s.error({message:`‰ª•‰∏ã MCP ÊúçÂä°Âä†ËΩΩÂ§±Ë¥•ÔºåÂ∑≤Ëá™Âä®ÂèñÊ∂àÂãæÈÄâ: ${g}`,duration:5e3})}a.length>0?s.success(`Â∑≤ÊàêÂäüÂêØÁî® ${a.length} ‰∏™ MCP Â∑•ÂÖ∑`):o.length>0&&f.length===o.length?s.info("ÊâÄÊúâÈÄâ‰∏≠ÁöÑ MCP Â∑•ÂÖ∑ÂùáÂä†ËΩΩÂ§±Ë¥•"):o.length===0&&e&&s.info("Â∑≤Ê∏ÖÈô§ÊâÄÊúâ MCP Â∑•ÂÖ∑")}catch(a){console.error("Failed to initialize MCP tools:",a),s.error(`Âä†ËΩΩMCPÂ∑•ÂÖ∑Â§±Ë¥•: ${a.message}`),it.value=[],Oe.value=[]}finally{$t.value=!1}}function un(){ce.value=[]}function dn(){const e=Kt.value.map(o=>o.id),t=new Set(ce.value);e.forEach(o=>t.add(o)),ce.value=Array.from(t)}async function pn(){if(!st.value){try{const e=await window.api.getConfig();if(e&&e.config&&e.config.mcpServers){const t=e.config.mcpServers,o=m.value.mcpServers||{};Oe.value.forEach(a=>{!t[a]&&o[a]&&(t[a]=o[a])}),m.value.mcpServers=t}}catch(e){console.error("Auto refresh MCP config failed:",e)}ce.value=[...Oe.value]}st.value=!st.value}async function fn(e,t){if(!m.value.mcpServers[e])return;const o=`mcpServers.${e}.isPersistent`;try{const a=await window.api.saveSetting(o,t);if(a&&a.success)m.value.mcpServers[e].isPersistent=t,s.success(`'${m.value.mcpServers[e].name}' ÁöÑÊåÅ‰πÖÂåñËÆæÁΩÆÂ∑≤Êõ¥Êñ∞`);else throw new Error(a?.message||"‰øùÂ≠òËÆæÁΩÆÂà∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•")}catch(a){console.error("Failed to save MCP persistence setting:",a),s.error("‰øùÂ≠òÊåÅ‰πÖÂåñËÆæÁΩÆÂ§±Ë¥•")}}const vn=()=>{const e=new Date,t=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],o=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");String(e.getHours()).padStart(2,"0"),String(e.getMinutes()).padStart(2,"0");const f=t[e.getDay()];return`${o}-${a}-${i} (${f})`},mn=()=>`
## SYSTEM CONTEXT
Current Time: **${vn()}**
PlatformÔºö**${pt.value}**

Always use this timestamp as your reference for "today", "now", "current", or relative dates (e.g., "yesterday", "next week").

## Tool Use Rules
Here are the rules you should always follow to solve your task:
1. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.
2. Call a tool only when needed. If no tool call is needed, just answer the question directly.
3. Never re-do a tool call that you previously did with the exact same parameters.
4. **Synthesis**: Must always synthesize the tool output into valuable, easily understandable information from the user's perspective.
5.  **Strict Multimedia Formatting Norms**: In all circumstances, the display format for multimedia content (images, videos, audio) must comply with the following specifications, and **must not** be contained within code blocks (\`\`\`):
    *   **Image (Markdown)**: \`![Content Description](Image Link)\`
    *   **Video (HTML)**:
        \`\`\`html
        <video controls="" style="max-width: 80%; max-height: 400px; height: auto; width: auto; display: block;"><source src="Video Link URL" type="video/mp4">Your browser does not support video playback.</video>
        \`\`\`
    *   **Audio (HTML)**:
        \`\`\`html
        <audio class="chat-audio-player" controls="" preload="none">
          <source id="Audio Format" src="Audio Link URL">
        </audio>
        \`\`\`
6. **Language**: All Respond must be in the user's language
7. **Security & Safety**: Tools must be executed securely, and the invocation of any commands that could lead to system damage, data loss, or sensitive privacy disclosure is strictly prohibited.
    1.  **Comprehensive Risk Assessment**: Identify whether the operation involves sensitive data or irreversible data modification.
    2.  **Mandatory Warning Prompts**: For any risky operation, clear and detailed warnings must be issued to the user before execution, explaining potential consequences (e.g., exposure of sensitive information, data loss).
    3.  **Seek Explicit Confirmation**: Before executing irreversible or high-risk operations (e.g., deleting files, reading sensitive files), explicit secondary confirmation from the user must be required.
`,ht=async(e=!1)=>{if(ie.value)return;if($t.value){s.info("Ê≠£Âú®Âä†ËΩΩÂ∑•ÂÖ∑ÔºåËØ∑Á®çÂêéÂÜçËØï...");return}if(!e){let g=await cn();const p=ot.value.trim();if(g&&g.length>0||p){const v=[];p&&v.push({type:"text",text:p}),g&&g.length>0&&v.push(...g);const y=new Date().toLocaleString("sv-SE");if(v.length>0){const u=v.length===1&&v[0].type==="text"?v[0].text:v;N.value.push({role:"user",content:u}),k.value.push({id:ee.value++,role:"user",content:v,timestamp:y}),Pt()}else return}else return;ot.value=""}ie.value=!0,ve.value=new AbortController,await de(),pe.value=!0,gt("auto");const t=m.value.prompts[B.value],o=!!Re.value;let a=t?.stream&&!o,i=0,f=-1;try{const{OpenAI:g}=await xt(async()=>{const{OpenAI:v}=await import("./index-CRSldtV4.js");return{OpenAI:v}},[],import.meta.url),p=new g({apiKey:()=>window.api.getRandomItem(Ve.value),baseURL:Ye.value,dangerouslyAllowBrowser:!0,maxRetries:3});for(;!ve.value.signal.aborted;){A.value?.focus({cursor:"end"});let v=JSON.parse(JSON.stringify(N.value));if(v=v.filter(T=>!(T.role==="system"&&(!T.content||T.content.trim()===""))),v.forEach(T=>{Array.isArray(T.content)&&(T.content=T.content.filter(w=>!w.isTranscript),T.content.length===0&&(T.content=null)),["content","reasoning_content","extra_content"].forEach(w=>{T[w]===null&&delete T[w]})}),t&&t.ifTextNecessary){const T=new Date,w=`current time: ${T.getFullYear()}-${String(T.getMonth()+1).padStart(2,"0")}-${String(T.getDate()).padStart(2,"0")} ${String(T.getHours()).padStart(2,"0")}:${String(T.getMinutes()).padStart(2,"0")}`;v.forEach(z=>{z.role==="user"&&(z.content===void 0||z.content===null?z.content=w:typeof z.content=="string"?z.content.trim()===""&&(z.content=w):Array.isArray(z.content)&&(z.content.length===0?z.content=w:z.content.some(le=>le.type==="text"&&le.text&&le.text.trim()!=="")||z.content.push({type:"text",text:w})))})}let y="";if(it.value.length>0){y=mn();const T=v.findIndex(w=>w.role==="system");T!==-1?v[T].content.includes("## Tool Use Rules")||(v[T].content+=y):v.unshift({role:"system",content:y})}const u={model:Q.value.split("|")[1],messages:v,stream:a};t?.isTemperature&&(u.temperature=t.temperature),Ne.value&&Ne.value!=="default"&&(u.reasoning_effort=Ne.value),it.value.length>0&&(u.tools=it.value,u.tool_choice="auto"),o&&(u.stream=!1,a=!1,u.modalities=["text","audio"],u.audio={voice:Re.value.split("-")[0].trim(),format:"wav"});const S=ee.value++;k.value.push({id:S,role:"assistant",content:[],reasoning_content:"",status:"",aiName:fe.value[Q.value]||Q.value.split("|")[1],voiceName:Re.value,tool_calls:[]}),f=k.value.length-1,D.value&&gt("auto");let M;if(a){const T=await p.chat.completions.create(u,{signal:ve.value.signal});let w="",z="",G=[],le=null,J=Date.now();for await(const me of T){const te=me.choices?.[0]?.delta;if(te&&(te.extra_content&&(le={...le,...te.extra_content}),te.thought_signature&&(le=le||{},le.google=le.google||{},le.google.thought_signature=te.thought_signature),te.reasoning_content&&(w+=te.reasoning_content,k.value[f].status!=="thinking"&&(k.value[f].status="thinking"),Date.now()-J>100&&(k.value[f].reasoning_content=w,J=Date.now())),te.content&&(z+=te.content,k.value[f].status=="thinking"&&(k.value[f].status="end"),Date.now()-J>100&&(k.value[f].content=[{type:"text",text:z}],J=Date.now())),te.tool_calls))for(const oe of te.tool_calls){const qe=oe.index??G.length;G[qe]||(G[qe]={id:"",type:"function",function:{name:"",arguments:""}});const Pe=G[qe];oe.id&&(Pe.id=oe.id),oe.function?.name&&(Pe.function.name=oe.function.name),oe.function?.arguments&&(Pe.function.arguments+=oe.function.arguments),oe.extra_content&&(Pe.extra_content={...Pe.extra_content,...oe.extra_content})}}M={role:"assistant",content:z||null,reasoning_content:w||null,extra_content:le},G.length>0&&(M.tool_calls=G.filter(me=>me.id&&me.function.name))}else M=(await p.chat.completions.create(u,{signal:ve.value.signal})).choices[0].message;M.tool_calls&&M.tool_calls.length>0&&M.tool_calls.forEach(T=>{T.function&&T.function.arguments&&(T.function.arguments=Na(T.function.arguments))}),N.value.push(M);const b=k.value[f];if(M.content&&(b.content=[{type:"text",text:M.content}]),M.reasoning_content&&(b.reasoning_content=M.reasoning_content,b.status="end"),M.tool_calls&&M.tool_calls.length>0){i++,b.tool_calls=M.tool_calls.map(w=>({id:w.id,name:w.function.name,args:w.function.arguments,result:"Á≠âÂæÖÊâπÂáÜ...",approvalStatus:Xe.value?"approved":"waiting"})),await de();const T=await Promise.all(M.tool_calls.map(async w=>{const z=b.tool_calls.find(J=>J.id===w.id);let G;if(!Xe.value)try{if(!await new Promise(me=>{mt.value.set(w.id,me)}))return z&&(z.approvalStatus="rejected",z.result="Áî®Êà∑Â∑≤ÂèñÊ∂àÊâßË°å"),{tool_call_id:w.id,role:"tool",name:w.function.name,content:"User denied this tool execution."}}catch{}z&&(z.approvalStatus="executing",z.result="ÊâßË°å‰∏≠...");const le=new AbortController;St.value.set(w.id,le);try{const J=JSON.parse(w.function.arguments);let me=null;if(w.function.name==="sub_agent"){const oe=Ve.value,qe=Ye.value,Pe=Q.value.split("|")[1]||Q.value,nt=it.value.filter(rt=>rt.function.name!=="sub_agent");me={apiKey:oe,baseUrl:qe,model:Pe,tools:nt,mcpSystemPrompt:y,onUpdate:rt=>{z&&(z.result=rt+`

[Sub-Agent ÊâßË°å‰∏≠...]`)}}}const te=await window.api.invokeMcpTool(w.function.name,J,St.value.get(w.id)?.signal||ve.value.signal,me);if(G=Array.isArray(te)?te.filter(oe=>oe?.type==="text"&&typeof oe.text=="string").map(oe=>oe.text).join(`

`):String(te),z){if(w.function.name==="sub_agent"){const oe=z.result?z.result.replace(`

[Sub-Agent ÊâßË°å‰∏≠...]`,""):"";oe.includes(G)?z.result=oe:z.result=`${oe}

=== ÊúÄÁªàÁªìÊûú ===
${G}`}else z.result=G;z.approvalStatus="finished"}}catch(J){J.name==="AbortError"?(G="Error: Tool call was canceled by the user.",z&&(z.approvalStatus="rejected")):(G=`{'result':'Â∑•ÂÖ∑ÊâßË°åÊàñÂèÇÊï∞Ëß£ÊûêÈîôËØØ: ${J.message}'}`,z&&(z.approvalStatus="finished")),z&&(z.result=G)}finally{St.value.delete(w.id)}return{tool_call_id:w.id,role:"tool",name:w.function.name,content:G}}));N.value.push(...T)}else{if(o&&M.audio){if(b.content=b.content||[],M.audio.transcript){const T=M.audio.transcript;b.content.push({type:"text",text:`

${T}`,isTranscript:!0})}b.content.push({type:"input_audio",input_audio:{data:M.audio.data,format:"wav"}})}break}}}catch(g){let p=`ÂèëÁîüÈîôËØØ: ${g.message||"Êú™Áü•ÈîôËØØ"}`;g.name==="AbortError"&&(p="ËØ∑Ê±ÇÂ∑≤ÂèñÊ∂à");const v=f>-1?f:k.value.length;f===-1&&k.value.push({id:ee.value++,role:"assistant",content:[],aiName:fe.value[Q.value]||Q.value.split("|")[1],voiceName:Re.value});const y=k.value[v];k.value[v].reasoning_content&&y.status==="thinking"&&(k.value[v].status="error");let u="";if(y.content&&Array.isArray(y.content)?u=y.content.filter(S=>S.type==="text").map(S=>S.text).join(""):typeof y.content=="string"&&(u=y.content),u&&u.trim().length>0){const S=`${u}

> **Error**: ${p}`;y.content=[{type:"text",text:S}],N.value.push({role:"assistant",content:S,reasoning_content:y.reasoning_content||null})}else y.content=[{type:"text",text:`${p}`}],N.value.push({role:"assistant",content:`${p}`,reasoning_content:y.reasoning_content||null})}finally{ie.value=!1,ve.value=null,f>-1&&(k.value[f].completedTimestamp=new Date().toLocaleString("sv-SE")),await de(),A.value?.focus({cursor:"end"}),Pt()}},gn=()=>{ie.value&&ve.value&&(ve.value.abort(),A.value?.focus())},hn=async(e,t)=>{ie.value&&t===k.value.length-1||await window.api.copyText(e)},so=async()=>{if(ie.value)return;const e=N.value.findLastIndex(o=>o.role!=="tool");if(e===-1){s.warning("Ê≤°ÊúâÂèØ‰ª•ÈáçÊñ∞ÊèêÈóÆÁöÑÁî®Êà∑Ê∂àÊÅØ");return}const t=N.value[e];if(t.role==="assistant"){const o=N.value.length-e,a=N.value.slice(e).filter(i=>i.role!=="tool").length;N.value.splice(e,o),a>0&&k.value.splice(k.value.length-a)}else if(t.role!=="user"){s.warning("Êó†Ê≥ï‰ªéÊ≠§Ê∂àÊÅØÁ±ªÂûãÈáçÊñ∞ÊèêÈóÆ„ÄÇ");return}Ce.value.clear(),await de(),await ht(!0)},wn=e=>{if(ie.value){s.warning("ËØ∑Á≠âÂæÖÂΩìÂâçÂõûÂ§çÂÆåÊàêÂêéÂÜçÊìç‰Ωú");return}if(e<0||e>=k.value.length)return;if(k.value[e]?.role==="system"){s.info("Á≥ªÁªüÊèêÁ§∫ËØç‰∏çËÉΩË¢´Âà†Èô§");return}let o=-1,a=-1;for(let M=0;M<N.value.length;M++)if(N.value[M].role!=="tool"&&a++,a===e){o=M;break}if(o===-1){console.error("ÂÖ≥ÈîÆÈîôËØØ: Êó†Ê≥ïÂ∞Ü chat_show Á¥¢ÂºïÊò†Â∞ÑÂà∞ history Á¥¢Âºï„ÄÇ‰∏≠Ê≠¢Âà†Èô§„ÄÇ"),s.error("Âà†Èô§Â§±Ë¥•ÔºöÊ∂àÊÅØÁä∂ÊÄÅ‰∏ç‰∏ÄËá¥„ÄÇ");return}const i=N.value[o];let f=o,g=o;if(i.role==="assistant"&&i.tool_calls&&i.tool_calls.length>0)for(;N.value[g+1]?.role==="tool";)g++;const p=g-f+1,v=1,y=e;p>0&&N.value.splice(f,p),k.value.splice(y,v);const u=e,S=new Set;for(const M of Ce.value)M<u?S.add(M):M>u&&S.add(M-1);Ce.value=S,F.value=null},yn=()=>{if(ie.value)return;const e=m.value.prompts[B.value]?.prompt,t=N.value.length>0?N.value[0]:null,o=t&&t.role==="system"?t:null,a=e?{role:"system",content:e}:o;a?(N.value=[a],k.value=[{...a,id:ee.value++}]):(N.value=[],k.value=[]),Ce.value.clear(),K.clear(),F.value=null,X.value="",A.value?.focus({cursor:"end"}),s.success("ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Ê∏ÖÈô§")};function io(e){const t=ce.value.indexOf(e);t===-1?ce.value.push(e):ce.value.splice(t,1)}const bn=()=>{setTimeout(()=>{A.value?.focus({cursor:"end"})},100)},xn=e=>{const t=St.value.get(e);t&&(t.abort(),s.info("Ê≠£Âú®ÂèñÊ∂àÂ∑•ÂÖ∑Ë∞ÉÁî®..."))};function ro(e){if(!e)return"";const t=/^streamable[\s_-]?http$/i,o=e.toLowerCase();return o==="builtin"?"ÂÜÖÁΩÆ":t.test(o)||o==="http"?"ÂèØÊµÅÂºè HTTP":e}const Cn=async e=>{if(!B.value||!m.value.prompts[B.value]){s.warning("Êó†Ê≥ï‰øùÂ≠òÊ®°ÂûãÔºåÂõ†‰∏∫ÂΩìÂâç‰∏çÊòØ‰∏Ä‰∏™Â∑≤ÂÆö‰πâÁöÑÂø´Êç∑Âä©Êâã„ÄÇ");return}try{const t=await window.api.saveSetting(`prompts.${B.value}.model`,e);if(Se.value=!1,t&&t.success)m.value.prompts[B.value].model=e,s.success(`Ê®°ÂûãÂ∑≤‰∏∫Âø´Êç∑Âä©Êâã "${B.value}" ‰øùÂ≠òÊàêÂäüÔºÅ`);else throw new Error(t?.message||"‰øùÂ≠òÂ§±Ë¥•")}catch(t){console.error("‰øùÂ≠òÊ®°ÂûãÂ§±Ë¥•:",t),s.error(`‰øùÂ≠òÊ®°ÂûãÂ§±Ë¥•: ${t.message}`)}Se.value=!1},co=e=>{const t=e.target;if(!(t instanceof HTMLImageElement)||!t.closest(".markdown-wrapper"))return;e.preventDefault();const o=t.src;if(t.parentNode&&t.parentNode.classList.contains("image-error-container"))return;const a=document.createElement("div");a.className="image-error-container",a.title="ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•ÔºåÁÇπÂáªÈáçËØï";const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("viewBox","0 0 24 24"),i.innerHTML='<path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="currentColor"></path>';const f=document.createElement("span");f.textContent="Image",a.appendChild(i),a.appendChild(f),t.parentNode&&t.parentNode.replaceChild(a,t),a.onclick=g=>{g.stopPropagation();const p=document.createElement("img");p.src=`${o}?t=${new Date().getTime()}`,a.parentNode&&a.parentNode.replaceChild(p,a)}},uo=e=>{if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="s"){if(e.preventDefault(),ie.value){s.warning("ËØ∑Á≠âÂæÖ AI ÂõûÂ§çÂÆåÊàêÂêéÂÜç‰øùÂ≠ò");return}if(document.querySelector(".el-dialog, .el-message-box"))return;no()}},Sn=()=>{De&&De.show()};return(e,t)=>(P(),q(je,null,[c("main",null,[We.value?(P(),q("div",Ha)):ge("",!0),c("div",{class:Ee(["window-bg-layer",{"is-visible":!!We.value}]),style:xo({backgroundImage:We.value?`url('${We.value}')`:"none",opacity:We.value?vt.value:0,filter:`blur(${x.value}px)`})},null,6),l(n(Rn),{class:Ee(["app-container",{"has-bg":!!We.value}])},{default:r(()=>[l(ra,{favicon:Le.value,promptName:B.value,conversationName:X.value,isAlwaysOnTop:dt.value,autoCloseOnBlur:ye.value,isDarkMode:m.value.isDarkMode,os:pt.value,onSaveWindowSize:Io,onSaveSession:Vo,onTogglePin:zt,onToggleAlwaysOnTop:Do,onMinimize:_,onMaximize:I,onClose:V},null,8,["favicon","promptName","conversationName","isAlwaysOnTop","autoCloseOnBlur","isDarkMode","os"]),l(ga,{modelMap:fe.value,model:Q.value,"is-mcp-loading":$t.value,systemPrompt:O.value,onOpenModelDialog:zo,onShowSystemPrompt:Gt,onOpenSearch:Sn},null,8,["modelMap","model","is-mcp-loading","systemPrompt"]),c("div",Ua,[l(n(Dn),{ref_key:"chatContainerRef",ref:C,class:"chat-main custom-scrollbar",onClick:It,onScroll:Eo},{default:r(()=>[(P(!0),q(je,null,bt(k.value,(o,a)=>(P(),Te(n(E),{key:o.id,"is-auto-approve":Xe.value,onUpdateAutoApprove:ko,onConfirmTool:qt,onRejectTool:qt,ref_for:!0,ref:i=>ut(i,o.id),message:o,index:a,"is-last-message":a===k.value.length-1,"is-loading":ie.value,"user-avatar":Ue.value,"ai-avatar":Me.value,"is-collapsed":Zt(a),"is-dark-mode":m.value.isDarkMode,onDeleteMessage:Ro,onCopyText:Oo,onReAsk:Fo,onToggleCollapse:No,onShowSystemPrompt:Gt,onAvatarClick:Ho,onEditMessageRequested:Go,onEditFinished:Qo,onEditMessage:to,onCancelToolCall:xn},null,8,["is-auto-approve","message","index","is-last-message","is-loading","user-avatar","ai-avatar","is-collapsed","is-dark-mode"]))),128))]),_:1},512),W.value?(P(),q("div",Wa,[l(n(ae),{content:"ÂõûÂà∞È°∂ÈÉ®",placement:"left","show-after":500},{default:r(()=>[l(n(H),{class:"scroll-nav-btn",onClick:To},{default:r(()=>[l(n(Y),{size:14},{default:r(()=>t[19]||(t[19]=[c("svg",{viewBox:"0 0 1024 1024",xmlns:"http://www.w3.org/2000/svg",fill:"currentColor"},[c("path",{d:"M492.367 74.709h46.406L960 503.076l-46.406 46.406-403.379-403.378-399.809 403.378L64 503.076 492.367 74.709z m0 399.809h46.406L960 902.884l-46.406 46.406-403.379-399.808-399.809 399.809L64 902.884l428.367-428.366z"})],-1)])),_:1})]),_:1})]),_:1}),l(n(ae),{content:"‰∏ä‰∏ÄÊù°Ê∂àÊÅØ",placement:"left","show-after":500},{default:r(()=>[l(n(H),{class:"scroll-nav-btn",onClick:Ao},{default:r(()=>[l(n(Y),{size:14},{default:r(()=>t[20]||(t[20]=[c("svg",{viewBox:"0 0 1024 1024",xmlns:"http://www.w3.org/2000/svg",fill:"currentColor"},[c("path",{d:"M902.5 749.2l57.5-57.5-421.6-416.9h-52.7L64 691.7l57.5 57.5 388.1-392.9 392.9 392.9z"})],-1)])),_:1})]),_:1})]),_:1}),l(n(ae),{content:_o.value,placement:"left","show-after":500},{default:r(()=>[l(n(H),{class:"scroll-nav-btn",onClick:Bo},{default:r(()=>[l(n(Y),{size:14},{default:r(()=>t[21]||(t[21]=[c("svg",{viewBox:"0 0 1024 1024",xmlns:"http://www.w3.org/2000/svg",fill:"currentColor"},[c("path",{d:"M121.5 274.8L64 332.3l421.6 416.9h52.7l421.6-416.9-57.5-57.5-388.1 392.9-392.8-392.9z"})],-1)])),_:1})]),_:1})]),_:1},8,["content"]),l(n(ae),{content:"Ë∑≥Âà∞Â∫ïÈÉ®",placement:"left","show-after":500},{default:r(()=>[l(n(H),{class:"scroll-nav-btn",onClick:Yt},{default:r(()=>[l(n(Y),{size:14},{default:r(()=>t[22]||(t[22]=[c("svg",{viewBox:"0 0 1024 1024",xmlns:"http://www.w3.org/2000/svg",fill:"currentColor"},[c("path",{d:"M535.203 545.912h-46.406L64 121.116l46.406-46.406 403.378 399.809 399.81-399.81L960 121.116 535.203 545.912z m0 403.379h-46.406L64 524.494l46.406-49.976 403.378 403.379 399.809-403.379L960 524.494 535.203 949.291z"})],-1)])),_:1})]),_:1})]),_:1})])):ge("",!0),l(Da,{ref_key:"chatInputRef",ref:A,prompt:ot.value,"onUpdate:prompt":t[0]||(t[0]=o=>ot.value=o),fileList:be.value,"onUpdate:fileList":t[1]||(t[1]=o=>be.value=o),selectedVoice:Re.value,"onUpdate:selectedVoice":t[2]||(t[2]=o=>Re.value=o),tempReasoningEffort:Ne.value,"onUpdate:tempReasoningEffort":t[3]||(t[3]=o=>Ne.value=o),loading:ie.value,ctrlEnterToSend:m.value.CtrlEnterToSend,layout:R.value,voiceList:m.value.voiceList,"is-mcp-active":$o.value,onSubmit:Uo,onCancel:Wo,onClearHistory:qo,onRemoveFile:jo,onUpload:Ko,onSendAudio:Zo,onOpenMcpDialog:Yo},null,8,["prompt","fileList","selectedVoice","tempReasoningEffort","loading","ctrlEnterToSend","layout","voiceList","is-mcp-active"])])]),_:1},8,["class"])]),l(Oa,{modelValue:Se.value,"onUpdate:modelValue":t[4]||(t[4]=o=>Se.value=o),modelList:Fe.value,currentModel:Q.value,onSelect:Po,onSaveModel:Cn},null,8,["modelValue","modelList","currentModel"]),l(n(Ht),{modelValue:_e.value,"onUpdate:modelValue":t[7]||(t[7]=o=>_e.value=o),title:"","custom-class":"system-prompt-dialog",width:"60%","show-close":!1,"lock-scroll":!1,"append-to-body":!0,center:"","close-on-click-modal":!0,"close-on-press-escape":!0},{header:r(({close:o,titleId:a,titleClass:i})=>t[23]||(t[23]=[c("div",{style:{display:"none"}},null,-1)])),footer:r(()=>[l(n(H),{onClick:t[6]||(t[6]=o=>_e.value=!1)},{default:r(()=>t[24]||(t[24]=[Z("ÂèñÊ∂à")])),_:1}),l(n(H),{type:"primary",onClick:oo},{default:r(()=>t[25]||(t[25]=[Z("‰øùÂ≠ò")])),_:1})]),default:r(()=>[l(n(et),{modelValue:Ze.value,"onUpdate:modelValue":t[5]||(t[5]=o=>Ze.value=o),type:"textarea",autosize:{minRows:4,maxRows:15},class:"system-prompt-full-content",resize:"none",onKeydown:en},null,8,["modelValue"])]),_:1},8,["modelValue"]),Je.value?(P(),Te(n(On),{key:0,"url-list":lt.value,"initial-index":Wt.value,onClose:t[8]||(t[8]=o=>Je.value=!1),"hide-on-click-modal":!0,teleported:""},null,8,["url-list","initial-index"])):ge("",!0),Je.value?(P(),q("div",qa,[l(n(H),{type:"primary",icon:n(Fn),circle:"",onClick:t[9]||(t[9]=o=>Jo(lt.value[0])),title:"Â§çÂà∂ÂõæÁâá"},null,8,["icon"]),l(n(H),{type:"primary",icon:n(bo),circle:"",onClick:t[10]||(t[10]=o=>Xo(lt.value[0])),title:"‰∏ãËΩΩÂõæÁâá"},null,8,["icon"])])):ge("",!0),l(n(Ht),{modelValue:st.value,"onUpdate:modelValue":t[18]||(t[18]=o=>st.value=o),width:"80%","custom-class":"mcp-dialog no-header-dialog",onClose:bn,"show-close":!1},{header:r(()=>t[26]||(t[26]=[c("div",{style:{display:"none"}},null,-1)])),footer:r(()=>[c("div",ol,[c("div",nl,[c("span",{class:Ee(["mcp-limit-hint",{warning:jt.value>5}])},[Z(" ËøûÊé•Êï∞Ôºö"+ke(5-jt.value)+"/5 ",1),l(n(ae),{placement:"top"},{content:r(()=>t[33]||(t[33]=[Z(" ÊåÅ‰πÖËøûÊé•ÂêÑÂç†1‰∏™ÂêçÈ¢ù"),c("br",null,null,-1),Z(" ÊâÄÊúâ‰∏¥Êó∂ËøûÊé•ÂÖ±Âç†1‰∏™ÂêçÈ¢ù ")])),default:r(()=>[l(n(Y),{style:{"vertical-align":"middle","margin-left":"4px",cursor:"help"}},{default:r(()=>[l(n(Un))]),_:1})]),_:1})],2),l(n(mo),{modelValue:Xe.value,"onUpdate:modelValue":t[16]||(t[16]=o=>Xe.value=o),label:"Ëá™Âä®ÊâπÂáÜÂ∑•ÂÖ∑Ë∞ÉÁî®",style:{"margin-left":"40px","margin-right":"0"}},null,8,["modelValue"])]),c("div",null,[l(n(H),{type:"primary",onClick:t[17]||(t[17]=o=>{Oe.value=[...ce.value],Lt()})},{default:r(()=>t[34]||(t[34]=[Z("Â∫îÁî®")])),_:1})])])]),default:r(()=>[c("div",ja,[c("div",Ka,[l(n(vo),null,{default:r(()=>[l(n(H),{type:Ge.value==="all"?"primary":"",onClick:t[11]||(t[11]=o=>Ge.value="all")},{default:r(()=>t[27]||(t[27]=[Z("ÂÖ®ÈÉ®")])),_:1},8,["type"]),l(n(H),{type:Ge.value==="selected"?"primary":"",onClick:t[12]||(t[12]=o=>Ge.value="selected")},{default:r(()=>t[28]||(t[28]=[Z("Â∑≤ÈÄâ ")])),_:1},8,["type"]),l(n(H),{type:Ge.value==="unselected"?"primary":"",onClick:t[13]||(t[13]=o=>Ge.value="unselected")},{default:r(()=>t[29]||(t[29]=[Z("Êú™ÈÄâ ")])),_:1},8,["type"])]),_:1}),l(n(vo),null,{default:r(()=>[l(n(H),{onClick:dn},{default:r(()=>t[30]||(t[30]=[Z("ÂÖ®ÈÄâ")])),_:1}),l(n(H),{onClick:un},{default:r(()=>t[31]||(t[31]=[Z("Ê∏ÖÁ©∫")])),_:1})]),_:1})]),c("div",Ya,[(P(!0),q(je,null,bt(Kt.value,o=>(P(),q("div",{key:o.id,class:Ee(["mcp-server-item",{"is-checked":ce.value.includes(o.id)}]),onClick:a=>io(o.id)},[l(n(mo),{"model-value":ce.value.includes(o.id),size:"large",onChange:()=>io(o.id),onClick:t[14]||(t[14]=Et(()=>{},["stop"]))},null,8,["model-value","onChange"]),c("div",Ja,[c("div",Xa,[l(n(Nn),{src:o.logoUrl,shape:"square",size:20,class:"mcp-server-icon"},{default:r(()=>[l(n(Y),{size:12},{default:r(()=>[l(n(Hn))]),_:1})]),_:2},1032,["src"]),c("span",Ga,ke(o.name),1),l(n(ae),{content:o.isPersistent?"ÊåÅ‰πÖËøûÊé•Â∑≤ÂºÄÂêØ":"ÊåÅ‰πÖËøûÊé•Â∑≤ÂÖ≥Èó≠",placement:"top"},{default:r(()=>[l(n(H),{text:"",circle:"",class:Ee([{"is-persistent-active":o.isPersistent},"persistent-btn"]),onClick:Et(a=>fn(o.id,!o.isPersistent),["stop"]),style:{"margin-left":"auto","margin-right":"8px"}},{default:r(()=>[l(n(Y),{size:16},{default:r(()=>t[32]||(t[32]=[c("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[c("polygon",{points:"13 2 3 14 12 14 11 22 21 10 12 10 13 2"})],-1)])),_:1})]),_:2},1032,["class","onClick"])]),_:2},1032,["content"]),c("div",Qa,[o.type?(P(),Te(n(go),{key:0,type:"info",size:"small",effect:"plain",round:""},{default:r(()=>[Z(ke(ro(o.type)),1)]),_:2},1024)):ge("",!0),(P(!0),q(je,null,bt((o.tags||[]).slice(0,2),a=>(P(),Te(n(go),{key:a,size:"small",effect:"plain",round:""},{default:r(()=>[Z(ke(a),1)]),_:2},1024))),128))])]),o.description?(P(),q("span",el,ke(o.description),1)):ge("",!0)])],10,Za))),128))]),c("div",tl,[l(n(et),{modelValue:kt.value,"onUpdate:modelValue":t[15]||(t[15]=o=>kt.value=o),placeholder:"ÊêúÁ¥¢Â∑•ÂÖ∑ÂêçÁß∞ÊàñÊèèËø∞...","prefix-icon":n(Ut),clearable:""},null,8,["modelValue","prefix-icon"])])])]),_:1},8,["modelValue"])],64))}},ll=Ct(al,[["__scopeId","data-v-3e6ef57e"]]),sl=Wn(ll);sl.mount("#app");export{Ct as _,ul as a,Tt as f,Na as s};
